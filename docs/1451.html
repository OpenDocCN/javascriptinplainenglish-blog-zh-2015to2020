<html>
<head>
<title>Parse Cookies in Requests in Express Apps with Cookie-Parser</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cookie解析器解析Express应用程序中请求的Cookie</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/parse-cookies-in-requests-in-express-apps-with-cookie-parser-4a94af5af620?source=collection_archive---------2-----------------------#2020-03-17">https://javascript.plainenglish.io/parse-cookies-in-requests-in-express-apps-with-cookie-parser-4a94af5af620?source=collection_archive---------2-----------------------#2020-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5b2457e44d3cd37d42ce64ac81297f92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QgKp5Gy5FKICWOC_"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@starvingartistfoodphotography?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Christina Branco</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5534" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，Express 4.x或更高版本没有提供任何中间件来解析cookies。</p><p id="e3de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们可以添加<code class="fe lb lc ld le b">cookie-parser</code>中间件。</p><p id="c7af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究如何使用它来解析随请求发送的cookies。</p><h1 id="dfd4" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">添加包</h1><p id="3d50" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以通过运行以下命令来安装该软件包:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="55fd" class="mq lg iq le b gy mr ms l mt mu">npm install cookie-parser</span></pre><p id="19fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以写:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="a1ba" class="mq lg iq le b gy mr ms l mt mu">const express = require('express')<br/>const cookieParser = require('cookie-parser')<br/><br/>const app = express()<br/>app.use(cookieParser())</span></pre><p id="a3f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将中间件添加到我们的应用程序中。</p><h1 id="24f9" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">方法</h1><h2 id="32bc" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">cookieParser(机密，选项)</h2><p id="96aa" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">cookie-parser</code>中间件的<code class="fe lb lc ld le b">cookieParser</code>函数将一个<code class="fe lb lc ld le b">secret</code>字符串或字符串数组作为第一个参数，将一个<code class="fe lb lc ld le b">options</code>对象作为第二个参数。</p><p id="de7b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">secret</code>是可选的。如果没有指定，它将不会解析签名的cookies。如果提供了一个字符串，它将被用作秘密。如果提供了一个字符串数组，那么每个秘密都将被尝试用于解码签名的cookie</p><p id="fec0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">options</code>是作为第二个选项传入<code class="fe lb lc ld le b">cookie.parse</code>的对象。</p><h2 id="1a50" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">cookieParser。JSONCookie(str)</h2><p id="ea62" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">JSONCookie</code>解析一个JSON cookie。如果它是一个JSON cookie，那么它将返回缩减的JSON值。否则它将返回传递的值。</p><h2 id="977a" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">cookieParser。JSON cookies(cookie)</h2><p id="c35b" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">该方法将遍历这些键，对每个值调用<code class="fe lb lc ld le b">JSONCookie </code>，并用解析后的值替换原始值。这将返回传入的同一个对象。</p><h2 id="4fe1" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">cookieParser.signedCookie(str，secret)</h2><p id="607f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">signedCookie</code>将cookie解析为签名cookie。如果它是一个签名的cookie并且签名有效，它将返回解析的无符号值。如果该值没有符号，则返回原始值。如果值是有符号的，但是cookie不能用<code class="fe lb lc ld le b">secret</code>验证，那么就返回<code class="fe lb lc ld le b">false</code>。</p><h2 id="cac6" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">cookieparser . signed cookies(cookie，secret)</h2><p id="b667" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">该方法将遍历这些键，并检查是否有任何值是签名的cookie。如果它已经签名并且签名有效，那么密钥将从对象中删除并添加到返回的新对象中。</p><p id="4088" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">secret</code>可以是数组或字符串。如果它是一个字符串，那么它将检查字符串的秘密。否则，将使用数组中的每个字符串检查每个cookie。</p><p id="8d0a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据客户端发送的cookie类型，将自动调用<code class="fe lb lc ld le b">JSONCookie</code>、<code class="fe lb lc ld le b">JSONCookies</code>、<code class="fe lb lc ld le b">signedCookie </code>和<code class="fe lb lc ld le b">signedCookies</code>方法。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/7f04455fa28e93fd5e933b6ef88e50bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9zzo5jHw55WKYu_E"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@oriol_portell?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Oriol Portell</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="1d5f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">解析未签名的Cookies</h1><p id="e3d5" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">一个简单的例子是解析未签名的cookies，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="fabc" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const cookieParser = require('cookie-parser');<br/>const app = express();</span><span id="29d9" class="mq lg iq le b gy nh ms l mt mu">app.use(bodyParser.json());<br/>app.use(cookieParser());</span><span id="bda5" class="mq lg iq le b gy nh ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  res.send(req.cookies);<br/>});</span><span id="fd63" class="mq lg iq le b gy nh ms l mt mu">app.listen(3000);</span></pre><p id="1ab9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们发送一个GET请求，将<code class="fe lb lc ld le b">Cookie</code>头的值设置为<code class="fe lb lc ld le b">foo=bar</code>时，我们得到:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="6e2d" class="mq lg iq le b gy mr ms l mt mu">{<br/>    "foo": "bar"<br/>}</span></pre><p id="09e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应，因为<code class="fe lb lc ld le b">req.cookies</code>已经解析了cookie。</p><h1 id="1e1b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">解析签名的Cookies</h1><p id="c971" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以发送一个签名的cookie并解析它，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="daab" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const cookieParser = require('cookie-parser');<br/>const app = express();<br/>const secret = 'secret';</span><span id="ee81" class="mq lg iq le b gy nh ms l mt mu">app.use(bodyParser.json());<br/>app.use(cookieParser(secret));</span><span id="f218" class="mq lg iq le b gy nh ms l mt mu">app.get('/cookie', (req, res) =&gt; {<br/>  res<br/>    .cookie('foo', 'bar', { signed: true })<br/>    .send();<br/>});</span><span id="9b96" class="mq lg iq le b gy nh ms l mt mu">app.get('/', (req, res) =&gt; {  <br/>  res.send(req.signedCookies);<br/>});</span><span id="0c10" class="mq lg iq le b gy nh ms l mt mu">app.listen(3000);</span></pre><p id="6f1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">代码有一个<code class="fe lb lc ld le b">/cookie</code>端点将签名的cookie发送给客户机。</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="a786" class="mq lg iq le b gy mr ms l mt mu">{ signed: true }</span></pre><p id="9f69" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">会让快递在饼干上签名。</p><p id="f387" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后从客户端，当我们向<code class="fe lb lc ld le b">/</code>发出请求时，我们通过<code class="fe lb lc ld le b">req.signedCookies</code>得到签名的cookie，因此我们得到:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="1485" class="mq lg iq le b gy mr ms l mt mu">{<br/>    "foo": "bar"<br/>}</span></pre><p id="b61d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为<code class="fe lb lc ld le b">/</code>的回应。</p><h1 id="5a5b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="0826" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以使用<code class="fe lb lc ld le b">cookie-parser</code>中间件来解析cookies。</p><p id="b39d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它可以解析已签名和未签名的cookies。为了解析一个签名的cookie，我们只需要用一个秘密来签名我们的cookie，然后如果我们把这个秘密传递给<code class="fe lb lc ld le b">cookieParser</code>中间件函数，<code class="fe lb lc ld le b">cookie-parser</code>就可以解码这个cookie。</p><p id="c584" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据客户端发送的cookie类型，将自动调用<code class="fe lb lc ld le b">JSONCookie</code>、<code class="fe lb lc ld le b">JSONCookies</code>、<code class="fe lb lc ld le b">signedCookie </code>和<code class="fe lb lc ld le b">signedCookies</code>方法。</p></div></div>    
</body>
</html>