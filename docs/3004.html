<html>
<head>
<title>Node.js Best Practices — Process Managers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践—流程管理器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-best-practices-process-managers-bbfe7ab0f44b?source=collection_archive---------6-----------------------#2020-08-17">https://javascript.plainenglish.io/node-js-best-practices-process-managers-bbfe7ab0f44b?source=collection_archive---------6-----------------------#2020-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1e3dfb9fe33a501e7775355264c915d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OtgK7jKZTdYIOn4a"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@valerieblanchett?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Valerie Blanchett</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0cc3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="88dc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用流程管理器</h1><p id="4372" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该使用进程管理器来保持我们的节点应用程序运行，即使它崩溃了。</p><p id="5c00" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">崩溃会导致节点应用程序停止运行。</p><p id="b06e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重启之前它会一直离线。</p><p id="abf0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以，不能只是用<code class="fe me mf mg mh b">node app.js</code>或者类似的东西来运行。</p><p id="1505" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">流程管理器帮助我们的应用保持高可用性。</p><p id="ec4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它让我们深入了解运行时性能和资源消耗。</p><p id="726f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以动态修改设置以提高性能。</p><p id="18b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以使用StrongLoop PM和PM2来控制集群。</p><p id="213b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">StrongLoop PM具有针对生产部署的功能。</p><p id="3894" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在本地构建和打包应用，并将其安全地部署到我们的生产系统中。</p><p id="f249" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，它会自动重启我们的应用程序，如果它崩溃。</p><p id="3b61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它还允许我们远程管理集群。</p><p id="fc45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CPU配置文件和堆快照让我们可以检查内存泄漏和CPU使用情况。</p><p id="b6fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过Nginx负载平衡器的集成控制扩展到多台主机。</p><h1 id="7a11" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用初始化系统</h1><p id="753d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">init系统提供了更高的可靠性，因为它确保应用程序在服务器重启时启动。</p><p id="3333" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们可能会因为许多原因而关闭，因此我们应该确保我们的应用程序在启动时再次启动。</p><p id="d07b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在进程管理器中运行我们的应用程序，并将进程管理器作为服务安装在init系统中。</p><p id="ff6d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当应用程序崩溃时，流程管理器会重启我们的应用程序。</p><p id="6c82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当操作系统崩溃时，init系统将重启进程管理器。</p><p id="411a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以直接在init系统中运行我们的应用程序。</p><p id="e374" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这更简单，但是我们没有使用进程管理器的额外特权。</p><p id="f864" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">两个主要的初始化系统是<a class="ae kc" href="https://wiki.debian.org/systemd" rel="noopener ugc nofollow" target="_blank"> systemd </a>和<a class="ae kc" href="http://upstart.ubuntu.com/" rel="noopener ugc nofollow" target="_blank"> Upstart </a>。</p><h1 id="12ea" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用节点的集群模块</h1><p id="c4ac" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Node的集群模块允许我们创建一个应用程序的多个实例。</p><p id="e533" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它使主进程能够产生工作进程，并在工作进程之间分配传入的连接。</p><p id="8989" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用StrongLoop PM创建一个集群，而无需修改应用程序代码。</p><p id="c073" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">StrongLoop PM自动在工作线程数量等于系统中CPU核心数量的集群中运行。</p><p id="6dea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用slc程序手动更改集群中工作进程的数量，而无需停止应用程序。</p><p id="8edf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以通过编写以下代码来运行具有给定集群大小的应用程序:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5dc9" class="mq lc iq mh b gy mr ms l mt mu">slc ctl -C http://prod.example.com:8888 set-size my-app 8</span></pre><p id="357c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将集群大小设置为8，末尾是数字8。</p><p id="f067" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PM2还允许我们在不修改应用程序代码的情况下创建集群。</p><p id="03cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须确保are app是无状态的。</p><p id="dffc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着不应该在会话、WebSocket连接等流程中存储本地数据。</p><p id="844b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过运行以下命令来启用集群模式:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="43b6" class="mq lc iq mh b gy mr ms l mt mu">$ pm2 start app.js -i 4<br/>$ pm2 start app.js -i max</span></pre><p id="b6f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们运行一个包含4个工作进程的集群，最后是4。</p><p id="e679" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者我们可以对所有的CPU使用<code class="fe me mf mg mh b">max</code>并启动那么多的工作进程。</p><p id="39c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要添加更多的工人，我们可以使用加号:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a77f" class="mq lc iq mh b gy mr ms l mt mu">$ pm2 scale app +3<br/>$ pm2 scale app 2</span></pre><p id="4042" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">scale</code>来改变工人的数量。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/6a9ade16fe393e28dc3142cd7321f5cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ocdheEAqM4IyFeH_"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@themeinn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Theme Inn</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="c702" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2632" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用进程管理器来创建集群、重启应用程序以及监控硬件使用情况。</p><h2 id="1655" class="mq lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated"><strong class="ak">用简单英语写的JavaScript</strong></h2><p id="7477" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>