<html>
<head>
<title>Set up a logger for your node app with Winston and Cloudwatch in 5 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Winston和Cloudwatch在5分钟内为你的node应用设置一个日志程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/set-up-a-logger-for-your-node-app-with-winston-and-cloudwatch-in-5-minutes-dec0c6c0d5b8?source=collection_archive---------0-----------------------#2019-08-10">https://javascript.plainenglish.io/set-up-a-logger-for-your-node-app-with-winston-and-cloudwatch-in-5-minutes-dec0c6c0d5b8?source=collection_archive---------0-----------------------#2019-08-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/40e4e4c85988604c96968f52e05f6ea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bOH75HZxDIbmocjGN9xjyw.png"/></div></div></figure><p id="4e16" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在一周内发生两起独立事件后，我开始确信是时候深入了解我们的应用程序了。监控和记录不再是一个选项，而是必须的。由于我们已经使用了AWS，我决定使用AWS CloudWatch。我仍然不得不选择一个日志记录器，我选择了Winston，因为它非常受欢迎(在NPM上每周有超过300万次下载，在GitHub上有超过13K次下载),并且一直保持着。</p><p id="05b4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想做同样的事情，并为您的节点应用程序设置日志记录，您可以使用本教程来做到这一点，这不会超过5分钟。我们走吧！</p><p id="4895" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">设置云观察</strong>:</p><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi kt"><img src="../Images/afc957c1c099c39c2f4fb8d384f54cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H6hC53ZJ1MKUXMo1fXNQlA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">what’s included in the free tier for AWS CloudWatch</figcaption></figure><p id="472c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，转到AWS Cloudwatch仪表板，然后从右边的菜单中选择“日志”</p><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/d03f76ec7d881bc8d196dd8b94b5f228.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*zyChBiqVEJP28ybkvP5uxg.png"/></div></figure><p id="f500" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从“操作”弹出式按钮中，选取“创建日志组”并给它命名</p><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/b4559fa2a32f62bbafe9d248997e687c.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/format:webp/1*msB_QRtN3AET2eg2XHThJA.png"/></div></figure><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div class="gh gi le"><img src="../Images/1e1b191dec12238fbde2c44da80c6bd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*NzmvqKFpj2Pn_BeNk9uiuw.png"/></div></figure><p id="e99a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您还没有，您应该创建一个IAM用户，并给它适当的权限，我使用了“CloudWatchFullAccess”，保存它的凭证(访问密钥ID &amp; secret key)供以后使用。</p><h1 id="088b" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">设置Winston记录器</strong></h1><h2 id="e6de" class="md lg in bd lh me mf dn ll mg mh dp lp kg mi mj lt kk mk ml lx ko mm mn mb mo bi translated"><strong class="ak">安装需要的包</strong></h2><p id="4247" class="pw-post-body-paragraph jv jw in jx b jy mp ka kb kc mq ke kf kg mr ki kj kk ms km kn ko mt kq kr ks ig bi translated">首先，我们需要安装将要使用的npm包。这些是“温斯顿”和“温斯顿-云观察”。为此，请使用以下命令:</p><pre class="ku kv kw kx gt mu mv mw mx aw my bi"><span id="f70c" class="md lg in mv b gy mz na l nb nc">npm i winston winston-cloudwatch --save</span></pre><h2 id="a915" class="md lg in bd lh me mf dn ll mg mh dp lp kg mi mj lt kk mk ml lx ko mm mn mb mo bi translated"><strong class="ak"> 2。添加和配置记录器</strong></h2><pre class="ku kv kw kx gt mu mv mw mx aw my bi"><span id="2635" class="md lg in mv b gy mz na l nb nc">const winston = require('winston'),<br/>      WinstonCloudWatch = require('winston-cloudwatch');</span><span id="3975" class="md lg in mv b gy nd na l nb nc">const logger = new winston.<em class="ne">createLogger</em>({<br/>    format: winston.format.json(),<br/>    transports: [<br/>        new (winston.transports.Console)({<br/>            timestamp: true,<br/>            colorize: true,<br/>        })<br/>   ]<br/>});</span><span id="d7b4" class="md lg in mv b gy nd na l nb nc">if (process.env.NODE_ENV === 'production') {<br/>const cloudwatchConfig = {<br/>    logGroupName: process.env.CLOUDWATCH_GROUP_NAME,<br/>    logStreamName: `${process.env.CLOUDWATCH_GROUP_NAME}-${process.env.NODE_ENV}`,<br/>    awsAccessKeyId: process.env.CLOUDWATCH_ACCESS_KEY,<br/>    awsSecretKey: process.env.CLOUDWATCH_SECRET_ACCESS_KEY,<br/>    awsRegion: process.env.CLOUDWATCH_REGION,<br/>    messageFormatter: ({ level, message, additionalInfo }) =&gt;    `[${level}] : ${message} \nAdditional Info: ${JSON.stringify(additionalInfo)}}`<br/>}</span><span id="b2dd" class="md lg in mv b gy nd na l nb nc">    logger.add(new WinstonCloudWatch(cloudwatchConfig))<br/>}</span><span id="623c" class="md lg in mv b gy nd na l nb nc">module.exports = logger;</span></pre><p id="af65" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ne">细目:</em> <br/> 1。我们首先导入我们想要使用的包，<br/> 2。然后通过调用带有选项对象的createLogger方法来启动logger对象，我已经添加了一个winston.transports.Console类型的传输，这样我就可以在开发<br/> 3时在默认输出上看到我的console.log。根据我们是否在生产环境中，我们然后配置并添加一个新的传输到logger，它将负责将日志传输到cloudwatch。有关可用配置选项的完整列表，请参见:<a class="ae nf" href="https://www.npmjs.com/package/winston-cloudwatch#options" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/winston-cloudwatch#options</a><br/>4。我们最后导出记录器，这样我们就可以在应用程序中的任何地方使用它</p><h2 id="c352" class="md lg in bd lh me mf dn ll mg mh dp lp kg mi mj lt kk mk ml lx ko mm mn mb mo bi translated">3.<strong class="ak">添加环境变量</strong></h2><p id="7753" class="pw-post-body-paragraph jv jw in jx b jy mp ka kb kc mq ke kf kg mr ki kj kk ms km kn ko mt kq kr ks ig bi translated">这可以根据部署环境和您的个人偏好以不同的方式完成；但是我们总是建议<em class="ne">永远不要</em>把密匙直接放在代码库中(即使你的git repo是私有的！！).就我个人而言，我在dotnev(<a class="ae nf" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/dotenv</a>)中使用一个. env文件，因为它有助于我轻松地为每个环境使用不同的变量。</p><h2 id="f757" class="md lg in bd lh me mf dn ll mg mh dp lp kg mi mj lt kk mk ml lx ko mm mn mb mo bi translated">4.<strong class="ak">最后，记录你需要记录的一切</strong></h2><p id="3488" class="pw-post-body-paragraph jv jw in jx b jy mp ka kb kc mq ke kf kg mr ki kj kk ms km kn ko mt kq kr ks ig bi translated">一个简单的例子是这样记录传入的请求</p><pre class="ku kv kw kx gt mu mv mw mx aw my bi"><span id="5a20" class="md lg in mv b gy mz na l nb nc">app.use((req, res, next) =&gt; {</span><span id="ecfc" class="md lg in mv b gy nd na l nb nc">        logger.log('info', `Requesting ${req.method} ${req.originalUrl}`, {tags: 'http', additionalInfo: {body: req.body, headers: req.headers }});</span><span id="d6b4" class="md lg in mv b gy nd na l nb nc">        next()      </span><span id="795f" class="md lg in mv b gy nd na l nb nc">})</span></pre><p id="1fff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这样，每次请求进来时，它将被直接记录到控制台<em class="ne">和</em>到CloudWatch。</p><p id="073a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">塔拉阿！一切就绪，部署和享受。现在，我们可以进入CloudWatch，查看我们的日志，如下图所示:</p><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/4b67bfe3c27bb2e8c1700e5ba2b98e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*WSEMRS340bhyYUCwwJjksQ.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Results from the simple log we tried</figcaption></figure><p id="b1b2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">后来，我在任何需要的地方添加了包含我想要的信息的日志。现在，如果我在生产中遇到问题，我可以更加自信，并且有一个跟踪来帮助我调试。</p></div></div>    
</body>
</html>