<html>
<head>
<title>Use Promise.race to Timeout Promises</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Promise.race超时承诺</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-promise-race-to-timeout-promises-6710cb0a3164?source=collection_archive---------4-----------------------#2020-04-13">https://javascript.plainenglish.io/use-promise-race-to-timeout-promises-6710cb0a3164?source=collection_archive---------4-----------------------#2020-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="62e5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">解决。拒绝。但是两者都不是呢？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d2568f80eb099c136eff5db7638abb2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qoqCFlvcRYpwmdbx_f11Yw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Race your promise against the clock. Photo by <a class="ae kv" href="https://unsplash.com/@jon_chng?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Jonathan Chng</a> on <a class="ae kv" href="https://unsplash.com/s/photos/race?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="bda6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">承诺是争论异步JavaScript的好方法。当他们解决或拒绝，你可以很容易地看到这两个结果是如何处理的承诺。</p><p id="d453" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，异步任务有3种场景:解决、拒绝、<strong class="ky ir">或者都没有</strong>。后一种情况，加上延迟的解析/拒绝，在我们的JavaScript代码中经常没有考虑到，也许是假设底层库足够成熟，最终可以拒绝耗时太长的操作。然而，情况可能并非如此——如果不是这样，所需的处理可能与任何其他错误都不完全相同。</p><p id="8f14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，考虑慢速网络请求、数据库操作或加载脚本。根据您的使用情况，您可能希望使用不同的主机重试请求，通知SLA跟踪器，或者通知第三方UI开发人员他们的web组件加载时间过长。</p><p id="ffed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，许多成熟的库将超时场景转换为拒绝场景，所以首先要注意遵循它们的文档。下面的代码演示了如何将它添加到您的库中，或者使用它来包装缺少这种处理的库。</p><h1 id="61d3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">示例代码</h1><p id="39f1" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这个例子试图在浏览器中加载一个脚本，但是如果脚本在一段时间内没有加载，就会触发<code class="fe mp mq mr ms b">catch</code>处理程序，从而将3个场景简化为更典型/更明确的2个场景<code class="fe mp mq mr ms b">resolve</code>和<code class="fe mp mq mr ms b">reject</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="77f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该代码块的关键要点是:</p><ul class=""><li id="0d6d" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated">承诺式的超时可能非常简洁。</li><li id="b9a4" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">您可以使用Promise.race编写带有超时的承诺，以便有效地对原始承诺设置时间限制。</li><li id="a410" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">您的超时特定逻辑可以在超时承诺上的一个<code class="fe mp mq mr ms b">.then</code>中。(上面的例子将超时场景转换为更常见的拒绝场景；然而，你的逻辑可能不同。)</li></ul><h1 id="2e79" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">警告:清理</h1><p id="9d9a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">超时不会导致另一个承诺被清除或取消。例如，如果一个数据库写承诺是针对超时的<code class="fe mp mq mr ms b">Promise.race</code>，并且如果超时首先完成，那么数据库写操作<strong class="ky ir">将仍然运行</strong>并且<strong class="ky ir">可能(最终)成功</strong>，但是应用程序的其余部分将认为它失败了。确保引入逻辑来取消操作，以防应用程序启动超时。</p><p id="b733" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">处理清理和取消逻辑是一个棘手的问题，因为这个特性没有内置到JavaScript中。我已经为这个主题专门写了一篇文章:</p><div class="nj nk gp gr nl nm"><a href="https://medium.com/javascript-in-plain-english/canceling-promises-in-javascript-31f4b8524dcd" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">在JavaScript中取消承诺</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">或者:如何取消那封尴尬的邮件</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">medium.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa kp nm"/></div></div></a></div><h1 id="3036" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><p id="e4b2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">电影《公牛达勒姆》中有一段很好的、灵活的引用:</p><blockquote class="ob oc od"><p id="a92e" class="kw kx oe ky b kz la jr lb lc ld ju le of lg lh li og lk ll lm oh lo lp lq lr ij bi translated">有时你会赢，有时你会输，有时会下雨。</p></blockquote><p id="f405" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你的代码考虑了承诺解决，你的代码可能考虑了拒绝，但是你考虑过“下雨”的可能性吗——既不是赢也不是输？也许你使用的库可以处理这些，但是如果你必须自己做，用Promise.race和你的承诺赛跑。如果可以的话，确保清理承诺。</p></div></div>    
</body>
</html>