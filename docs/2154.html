<html>
<head>
<title>Use Lambda@Edge + JWT to secure S3 bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用λ@ Edge+JWT来保护S3铲斗</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-lambda-edge-jwt-to-secure-s3-bucket-dcca6eec4d7e?source=collection_archive---------2-----------------------#2020-05-25">https://javascript.plainenglish.io/use-lambda-edge-jwt-to-secure-s3-bucket-dcca6eec4d7e?source=collection_archive---------2-----------------------#2020-05-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9788" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在CloudFront后面保护您的S3资产是一个常见的用例，因此这些资产只能通过CloudFront访问。通常可以通过将OAI添加到CloudFront发行版中，并使用CloudFront签名的URL来访问资产。Lambda@Edge提供了新的思路，可以灵活地实现相同的目标。</p><p id="4b25" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">顾名思义，Lambda@Edge在CloudFront edge位置运行Lambda函数，因此它更接近用户，运行速度也更快。最强大的武器是你可以编程控制你想要如何访问SF发行版和S3！</p><p id="6bbc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个架构有三个关键点。</p><ul class=""><li id="e785" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">资产元数据用JWT编码，JWT令牌作为参数成为资产URL的一部分。</li><li id="7613" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">Lambda@Edge与ViewerRequest相关联，它在请求到来时验证JWT令牌。</li><li id="8a7c" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">根据JWT令牌验证，继续进行不同的决策。</li></ul><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi kw"><img src="../Images/493b81adc8c2e41bc559ed144cc02e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlSONqGR90I3cIzwGVsbEQ.jpeg"/></div></div></figure></div><div class="ab cl li lj hr lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ig ih ii ij ik"><h1 id="12cd" class="lp lq in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">&gt;应用</h1><p id="139a" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">您的应用程序代码需要生成一个JWT令牌。出于演示目的，我使用jwt.io生成令牌，私有签名密钥是<code class="fe ms mt mu mv b">i-like-beijing-duck</code>，有效负载有两个密钥，<code class="fe ms mt mu mv b">key: beijing-duck.jpg</code>是S3桶中的资产密钥，<code class="fe ms mt mu mv b">iat</code>表示令牌生成的时间。分发资产时，URL类似于<a class="ae mw" href="https://public.mianio.com/chinese-food?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJiZWlqaW5nLWR1Y2suanBnIiwiaWF0IjoxNTE2MjM5MDIyfQ.H6PO-2OYbUxX-XenHLvneyrrctFekOZKNdokyVKVPKc" rel="noopener ugc nofollow" target="_blank"><em class="mx">https://public.mianio.com/chinese-food?token = eyjhbgcioijiuzi 1 NII SINR 5 CCI 6 ikpxvcj 9 . eyjrzxkioijizwlqaw 5 nlwr 1y 2 suanbniiiawf 0 ijoxnte 2 JM 5 mdiyfq . h6po-2 oybuxx-xenhlvneyrrctfekndokyvkvpkc</em></a></p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi my"><img src="../Images/4da314443fb0a520c6523c3dea372d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TAd7yZ7TB4QW0JTnVYlQ9g.png"/></div></div></figure><h1 id="4999" class="lp lq in bd lr ls mz lu lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm bi translated">&gt;λ@ Edge</h1><p id="34ee" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">lambda代码非常简单:</p><ol class=""><li id="0dc9" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh ne ko kp kq bi translated">从URL中提取令牌</li><li id="a303" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh ne ko kp kq bi translated">使用私钥验证令牌，以确保它是来自您的发行者(即您的应用程序代码)的真实令牌</li><li id="9add" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh ne ko kp kq bi translated">如果令牌是真实的，使用有效载荷中的密钥继续余下的请求旅程，即点击CloudFront -&gt; S3</li></ol><figure class="kx ky kz la gt lb"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="a6c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虽然它被称为Lambda@Edge，但它与普通Lambda函数有所不同，记住这一点非常重要。</p><ol class=""><li id="b4eb" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh ne ko kp kq bi translated">不支持环境变量。这就是为什么JWT签名令牌是从参数存储中检索，而不是从环境变量中检索。您可能会认为这样不好，因为它需要从参数存储中获取秘密，这会减慢这个过程。嗯，这是真的，但实际上并没有那么糟糕，因为正如你在演示中看到的，<code class="fe ms mt mu mv b">let secret</code>被声明为句柄外的全局变量，以便我们可以使用lambda函数缓存，只有当它是冷启动时，<code class="fe ms mt mu mv b">secret</code>是未定义的，然后代码需要从参数存储中获取。</li><li id="abb8" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh ne ko kp kq bi translated">函数内存大小只有128MB！所以你最好保持你的功能精简，不要做繁重的工作。</li><li id="8f01" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh ne ko kp kq bi translated">不支持VPC。</li><li id="5d3b" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh ne ko kp kq bi translated">5秒超时。</li></ol><p id="a139" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些限制限制了Lambda@Edge做新奇的事情。但幸运的是，这足以满足我们对JWT的需求。</p><p id="ca76" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果JWT令牌丢失，我们需要做的就是放弃请求，并将其发送到错误页面，在本例中为<code class="fe ms mt mu mv b"><a class="ae mw" href="http://www.mianio.com/401" rel="noopener ugc nofollow" target="_blank">www.mianio.com/40</a>3</code>。</p><p id="a92b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果JWT令牌无效，我们需要做的就是放弃请求，并将其发送到错误页面，在本例中为<code class="fe ms mt mu mv b"><a class="ae mw" href="http://www.mianio.com/401" rel="noopener ugc nofollow" target="_blank">www.mianio.com/401</a></code>。</p><p id="eff2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果JWT令牌有效，我们需要从有效负载中提取密钥，并通过设置<code class="fe ms mt mu mv b">request.uri=key</code>将密钥传递给请求。然后，请求将到达CloudFront，如果有命中，则为资产提供服务；如果有未命中，则请求将到达S3。</p></div><div class="ab cl li lj hr lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ig ih ii ij ik"><h1 id="52db" class="lp lq in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">&gt;上传</h1><p id="ba50" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">您只能为us-east-1地区的函数添加触发器，因此我们必须将函数上传到us-east-1。</p><p id="b451" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，我们需要创建部署包。</p><pre class="kx ky kz la gt nh mv ni nj aw nk bi"><span id="f243" class="nl lq in mv b gy nm nn l no np">zip -r viewerRequestFunc.zip .</span></pre><p id="8d77" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后我们可以上传包来创建函数。</p><pre class="kx ky kz la gt nh mv ni nj aw nk bi"><span id="08cb" class="nl lq in mv b gy nm nn l no np">aws lambda create-function --function-name viewerRequest-Mianio --zip-file fileb://viewerRequestFunc.zip --region us-east-1 --runtime nodejs12.x --role arn:aws:iam::xxxxxxxxxxx:role/service-role/viewerRequestRole --handler index.handler</span></pre><p id="482e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">稍后当我们需要更新函数时。</p><pre class="kx ky kz la gt nh mv ni nj aw nk bi"><span id="dc8a" class="nl lq in mv b gy nm nn l no np">aws lambda update-function-code --function-name viewerRequest-Mianio --zip-file fileb://viewerRequestFunc.zip --region us-east-1</span></pre><p id="9831" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你看，我需要给这个函数一个执行IAM角色，这很重要，因为这个函数需要与参数存储对话，还需要记录到CloudWatch。</p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi nq"><img src="../Images/1e96bf88c1a9850daa2368be4419e8a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bb2-r0Os8VM7LvzGkZPtkQ.png"/></div></div></figure><p id="5361" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要添加触发器，与该功能相关联的IAM执行角色必须由服务主体<code class="fe ms mt mu mv b">lambda.amazonaws.com</code>和<code class="fe ms mt mu mv b">edgelambda.amazonaws.com</code>来承担。</p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi nr"><img src="../Images/9288d7be47f921f8a696e1b2d5a753e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dkeBvSh5ghuWoUlF6BFZNA.png"/></div></div></figure><p id="f5fd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦它被上传，你可以在美国东部一台看到它</p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi ns"><img src="../Images/f1d62a0696d3b195bf2d99c1bc908374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkVVVx6zUnJrrqTIn-krlQ.png"/></div></div></figure><h1 id="92d9" class="lp lq in bd lr ls mz lu lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm bi translated">&gt;云锋</h1><p id="70f9" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">由于访问控制现在在lambda@edge中，我们需要在CloudFront配置中关闭<code class="fe ms mt mu mv b">Restrict Viewer Access</code>。</p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi nt"><img src="../Images/a669ef844474fd4fd1758a42f63dbab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TONBLnMXF6zAQ1k7ZF7ZkA.png"/></div></div></figure><h1 id="1e8b" class="lp lq in bd lr ls mz lu lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm bi translated">&gt;部署</h1><p id="330e" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">现在是时候把lambda@edge和CloudFront联系起来了。</p><ol class=""><li id="c3e1" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh ne ko kp kq bi translated">发布新版本。请记住，每当功能代码或配置发生变化时，都需要发布新的版本。</li></ol><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi nu"><img src="../Images/da7349dba08fb85b32b25d358ee7ce9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gwQWN0d2Gi6xJmSgzgXaJw.png"/></div></div></figure><p id="7f77" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.在新版本的设计器窗口中，点击<code class="fe ms mt mu mv b">+ Add triger</code>，从列表中选择CloudFront，并选择与该功能关联的CF发行版。</p><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi nv"><img src="../Images/e6838f3af14489a892a821f7ee096182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gn6zJrZDXLEar4UwI4gxmA.png"/></div></div></figure><p id="250a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将函数部署到发行版需要几分钟时间。</p><h1 id="36f2" class="lp lq in bd lr ls mz lu lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm bi translated">&gt;日志</h1><p id="a3d7" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">我花了一段时间才找到木头在哪里。因为这些功能是在边缘位置触发和执行的，所以我们需要转到边缘位置区域来查看日志。例如，在ap-southeast-2上发出一个请求，日志将在ap-southeast-2的CloudWatch上创建。日志组名称以<code class="fe ms mt mu mv b">/aws/lambda/us-east-1</code>开头</p></div><div class="ab cl li lj hr lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ig ih ii ij ik"><p id="afb8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了四种类型的CloudFront事件，ViewerRequest、OriginRequest、OriginResponse和ViewerResponse，您可以将Lambda@Edge与许多潜在事件联系起来。但是请记住<a class="ae mw" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-requirements-limits.html" rel="noopener ugc nofollow" target="_blank">的限制</a>，因为根据需求的不同，这可能不是一个理想的解决方案。</p><p id="ba5c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">源代码【https://github.com/crespowang/lambda-edge-auth T2】</p><h1 id="e1c8" class="lp lq in bd lr ls mz lu lv lw na ly lz ma nb mc md me nc mg mh mi nd mk ml mm bi translated"><strong class="ak">用简单英语写的便条</strong></h1><p id="91f8" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">你知道我们有四份出版物和一个YouTube频道吗？你可以在我们的主页<a class="ae mw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> plainenglish.io </strong> </a>找到所有这些内容——关注我们的出版物并<a class="ae mw" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">订阅我们的YouTube频道</strong> </a> <strong class="jm io">来表达你的爱吧！</strong></p></div></div>    
</body>
</html>