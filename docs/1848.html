<html>
<head>
<title>Snapshots of Material-UI styled component with React Testing Library and TypeScript.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有React测试库和类型脚本的材质UI风格组件的快照。</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/snapshots-of-material-ui-styled-component-with-react-testing-library-and-typescript-d82d7d926d2c?source=collection_archive---------6-----------------------#2020-04-28">https://javascript.plainenglish.io/snapshots-of-material-ui-styled-component-with-react-testing-library-and-typescript-d82d7d926d2c?source=collection_archive---------6-----------------------#2020-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/09f889bfdd1bfc9ac2853fd8cc6464be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SbiK9pdSzunrPBcOrFFF9A.png"/></div></div></figure><p id="7818" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个人都知道编写测试对于软件开发来说非常重要。它使我们能够以更少的错误更快地修改代码。</p><p id="171b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">说到前端，<code class="fe kw kx ky kz b">React Testing Library</code>越来越受欢迎，因为与<code class="fe kw kx ky kz b">enzyme</code>相比，它更容易测试React钩子。然而，当你想用材质UI风格的组件做快照测试时，你应该处理一件事，材质UI创建的随机类名。</p><h1 id="b04f" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">将测试库与材料用户界面(MUI)进行反应</h1><p id="6a62" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">首先，测试MUI组件与普通JSX组件基本相同。您应该关注用户如何与实际的DOM交互。</p><p id="d40a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，MUI <code class="fe kw kx ky kz b">&lt;Button /&gt;</code>组件不同于html <code class="fe kw kx ky kz b">&lt;button /&gt;</code>。但你要接触的只是从MUI消化过来的HTML。</p><h1 id="8a17" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">MUI样式的组件</h1><p id="e13d" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">有了MUI，你可以定义自己的<code class="fe kw kx ky kz b">theme</code>，用JS写CSS。要使用它，通常在使用React上下文API的根组件中提供<code class="fe kw kx ky kz b">theme</code>。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="c650" class="ml lb iq kz b gy mm mn l mo mp">// Index.tsx</span><span id="7645" class="ml lb iq kz b gy mq mn l mo mp">ReactDOM.render(<br/>  &lt;MuiThemeProvider theme={theme}&gt;<br/>    &lt;App /&gt;<br/>  &lt;/MuiThemeProvider&gt;,<br/>  document.getElementById('root'),<br/>);</span></pre><p id="7281" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个子组件如下所示。HOC可以让你用JS写CSS并提供主题。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="5e9f" class="ml lb iq kz b gy mm mn l mo mp">import React from 'react';<br/>import { withStyles, WithStyles, Theme, StyleRules } from '@material-ui/core/styles';<br/>import { Typography } from '@material-ui/core';</span><span id="7ecc" class="ml lb iq kz b gy mq mn l mo mp">const styles = (theme: Theme): StyleRules =&gt; ({<br/>  typography: {<br/>    margin: 200,<br/>  },<br/>});</span><span id="7742" class="ml lb iq kz b gy mq mn l mo mp">type HelloProps = WithStyles&lt;typeof styles&gt;;</span><span id="0687" class="ml lb iq kz b gy mq mn l mo mp">const Hello: React.FC&lt;HelloProps&gt; = ({ classes }) =&gt; (<br/>  &lt;Typography className={classes.typography} variant="h6"&gt;<br/>    Hello world!<br/>  &lt;/Typography&gt;<br/>);</span><span id="4638" class="ml lb iq kz b gy mq mn l mo mp">export default withStyles(styles)(Hello);</span></pre><p id="175f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您在浏览器中检查实际DOM的类名，您会理解MUI创建了类似于<component name=""> - <class name=""> - <random number="">的类名并将css应用于每个类。</random></class></component></p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="dfa8" class="ml lb iq kz b gy mm mn l mo mp">&lt;h6 class="MuiTypography-root MuiTypography-h6 Hello-typography-274"&gt;<br/>  Hello World!<br/>&lt;/h6&gt;</span></pre><p id="6b63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，MUI创建的类名导致了快照测试的一个问题。</p><h1 id="5c6e" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置演示应用程序</h1><p id="fb9c" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">我创建了一个演示应用程序来学习如何一步一步地测试一个样式化的组件。请克隆它。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="9b41" class="ml lb iq kz b gy mm mn l mo mp">git clone <a class="ae mr" href="https://github.com/egurinko/react-testing-library-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/egurinko/react-testing-library-demo.git</a><br/>git checkout feature/01_MUI_styled_component_test</span></pre><p id="798a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用运行应用程序</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="126a" class="ml lb iq kz b gy mm mn l mo mp">yarn<br/>yarn start</span></pre><p id="4058" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用运行测试</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="13d2" class="ml lb iq kz b gy mm mn l mo mp">yarn test</span></pre><h1 id="6c3a" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">编写第一个快照测试</h1><p id="f9d6" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">测试样式化组件的好组件是<code class="fe kw kx ky kz b">src/components/my_pokemons/Index.tsx</code>。如果你选择口袋妖怪，你可以看到你的口袋妖怪。如果你没有选择口袋妖怪，你可以看到一个信息。</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/18bf5a825c2e4f5545f62b38c6f06ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p3JWH-VlWd4sKcKJOhOLJA.png"/></div></div></figure><p id="060d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建测试文件。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="625b" class="ml lb iq kz b gy mm mn l mo mp">// src/__test__/integration/my_pokemons/index.tsx</span><span id="53c2" class="ml lb iq kz b gy mq mn l mo mp">.......</span><span id="fdd6" class="ml lb iq kz b gy mq mn l mo mp">const myPokemons: Pokemons = [<br/>  {<br/>    id: 1,<br/>    name: 'mockName',<br/>    stats: [],<br/>    sprite: 'mockSprite',<br/>  },<br/>];</span><span id="3b98" class="ml lb iq kz b gy mq mn l mo mp">let body: RenderResult;</span><span id="6363" class="ml lb iq kz b gy mq mn l mo mp">describe('&lt;Index /&gt;', () =&gt; {<br/>  beforeEach(() =&gt; {<br/>    body = render(&lt;Index myPokemons={myPokemons} /&gt;);<br/>  });</span><span id="58b8" class="ml lb iq kz b gy mq mn l mo mp">  it('matches snapshot', () =&gt; {<br/>    const { baseElement } = body;<br/>    expect(baseElement).toMatchSnapshot();   <br/>  });<br/>});</span></pre><p id="d334" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行测试。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="0862" class="ml lb iq kz b gy mm mn l mo mp">yarn test src/__test__/integration/my_pokemons/index.spec.tsx</span></pre><p id="b69d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加了一个快照测试文件，一切看起来都很好。</p><h1 id="e64d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">快照很脆弱…</h1><p id="9fc3" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">让我举个例子。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="2634" class="ml lb iq kz b gy mm mn l mo mp">// src/__test__/integration/my_pokemons/index.tsx</span><span id="2e63" class="ml lb iq kz b gy mq mn l mo mp">.......</span><span id="fd13" class="ml lb iq kz b gy mq mn l mo mp">const myPokemons: Pokemons = [<br/>  {<br/>    id: 1,<br/>    name: 'mockName',<br/>    stats: [],<br/>    sprite: 'mockSprite',<br/>  },<br/>];</span><span id="1f5b" class="ml lb iq kz b gy mq mn l mo mp">describe('&lt;Index /&gt;', () =&gt; {<br/>  beforeEach(() =&gt; {<br/>    body = render(&lt;Index myPokemons={myPokemons} /&gt;);<br/>  });<br/><br/>  // ADD a test<br/>  it('shows pokemons', ()=&gt;{<br/>    expect(body.getByText(myPokemons[0].name)).toBeInTheDocument()<br/>  });<br/>  <br/>  it('matches snapshot', () =&gt; {<br/>    const { baseElement } = body;<br/>    expect(baseElement).toMatchSnapshot();   <br/>  });<br/>});</span></pre><p id="dd0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我添加了一个通过的简单测试。但是当你测试的时候。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="d595" class="ml lb iq kz b gy mm mn l mo mp">yarn test src/__test__/integration/my_pokemons/index.spec.tsx</span></pre><p id="9ddc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您会看到快照测试失败…如下所示。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="68f0" class="ml lb iq kz b gy mm mn l mo mp">exports[`&lt;Index /&gt; with pokemons matches snapshot 1`] = `</span><span id="05be" class="ml lb iq kz b gy mq mn l mo mp">&lt;body&gt;<br/>  &lt;div&gt;<br/>    &lt;div<br/>-     class="Index-container-1"<br/>+     class="Index-container-185"<br/>    &gt;<br/>.....</span></pre><p id="7637" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当你第一次运行测试时，MUI添加<code class="fe kw kx ky kz b">1</code>作为类名的随机数。但是，通过增加一个测试，随机数变成了<code class="fe kw kx ky kz b">185</code>，就失败了。我没有改变任何事…</p><p id="3a86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么如何解决这个问题呢？？</p><h1 id="0593" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">Hack generateClassName函数</h1><p id="10fa" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv ij bi translated">提示在MUI实现中。其实有个生成类名的地方叫<a class="ae mr" href="https://github.com/mui-org/material-ui/blob/c171287d490e05a6bf23028468dea5b60047cddc/src/styles/createGenerateClassName.js#L11" rel="noopener ugc nofollow" target="_blank">createGenerateClassName</a>。</p><p id="abf6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">createGenerateClassName</code>函数返回函数取<code class="fe kw kx ky kz b">rule</code>、<code class="fe kw kx ky kz b">styleSheet</code>返回<code class="fe kw kx ky kz b">${prefix}-${rule.key}-${ruleCounter}</code>的类名字符串。<code class="fe kw kx ky kz b">ruleCounter</code>给类名添加一个随机数。</p><p id="8bd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">generateClassName</code>变量保存<code class="fe kw kx ky kz b">createGenerateClassName</code> <a class="ae mr" href="https://github.com/mui-org/material-ui/blob/c171287d490e05a6bf23028468dea5b60047cddc/src/styles/withStyles.js#L35" rel="noopener ugc nofollow" target="_blank">返回的函数，保存的函数用于<code class="fe kw kx ky kz b">StylesProvider</code>。</a></p><p id="21d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以如果你创建自己的<code class="fe kw kx ky kz b">generateClassName</code>函数并将其传递给<code class="fe kw kx ky kz b">StylesProvider</code>，类名就可以是固定的。</p><p id="135c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，创建自己的<code class="fe kw kx ky kz b">generateClassName</code>。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="ae29" class="ml lb iq kz b gy mm mn l mo mp">// src/__test__/util/themeProvider.tsx</span><span id="dcff" class="ml lb iq kz b gy mq mn l mo mp">import React, { ReactElement } from 'react';<br/>import { MuiThemeProvider } from '@material-ui/core/styles';<br/>import { StylesProvider, StylesOptions } from '@material-ui/styles/';<br/>import theme from '../../utils/theme';</span><span id="ce46" class="ml lb iq kz b gy mq mn l mo mp">const generateClassName: StylesOptions['generateClassName'] = (<br/>  rule,<br/>  sheet<br/>): string =&gt; `${sheet!.options.classNamePrefix}-${rule.key}`;</span></pre><p id="5b52" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不包括<code class="fe kw kx ky kz b">generateClassName</code>末的<code class="fe kw kx ky kz b">ruleCounter</code>。如果您将此<code class="fe kw kx ky kz b">generateClassName</code>与<code class="fe kw kx ky kz b">StylesProvider</code>一起使用，就不会创建随机数。所以将<code class="fe kw kx ky kz b">StylesProvider</code>添加到您自己的<code class="fe kw kx ky kz b">generateClassName</code>中。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="e905" class="ml lb iq kz b gy mm mn l mo mp">// src/__test__/util/themeProvider.tsx</span><span id="12a9" class="ml lb iq kz b gy mq mn l mo mp">...</span><span id="06f8" class="ml lb iq kz b gy mq mn l mo mp">): string =&gt; `${sheet!.options.classNamePrefix}-${rule.key}`;</span><span id="da67" class="ml lb iq kz b gy mq mn l mo mp">export const provideTheme = (ui: ReactElement): ReactElement =&gt; {<br/>  return (<br/>    &lt;StylesProvider generateClassName={generateClassName}&gt;<br/>      &lt;MuiThemeProvider theme={theme}&gt;{ui}&lt;/MuiThemeProvider<br/>    &lt;/StylesProvider&gt;<br/>  );<br/>};</span></pre><p id="ddb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，<code class="fe kw kx ky kz b">provideTheme</code>函数以react rement为参数，返回由<code class="fe kw kx ky kz b">StylesProvider</code>、<code class="fe kw kx ky kz b">MuiThemeProvider</code>包装的react rement。因此，如果您将ReactElement传递给<code class="fe kw kx ky kz b">provideTheme</code>，您就可以得到没有随机类名的样式化组件🎉</p><p id="4f7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您使用它时，只需在渲染前通过ReactElement。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="a292" class="ml lb iq kz b gy mm mn l mo mp">// src/__test__/integration/my_pokemons/index.spec.tsx</span><span id="1215" class="ml lb iq kz b gy mq mn l mo mp">...</span><span id="5491" class="ml lb iq kz b gy mq mn l mo mp">describe('&lt;Index /&gt;', () =&gt; {<br/>  beforeEach(() =&gt; {<br/>    body = render(provideTheme(&lt;Index myPokemons={myPokemons} /&gt;));<br/>  });</span><span id="6403" class="ml lb iq kz b gy mq mn l mo mp">....</span></pre><p id="b80c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一切都准备好了！让我们进行测试。</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="3ac7" class="ml lb iq kz b gy mm mn l mo mp">yarn test -u</span></pre><p id="ada1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它过去了🎉！如果您检查快照文件，</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="290c" class="ml lb iq kz b gy mm mn l mo mp">exports[`&lt;Index /&gt; matches snapshot 1`] = `<br/>&lt;body&gt;<br/>  &lt;div&gt;<br/>    &lt;div<br/>      class="Index-container"<br/>    &gt;</span></pre><p id="ef71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它不会在类名的末尾添加随机数！最后，快照测试变得可靠！</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="5992" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文主要讨论用TypeScript对MUI风格的组件进行快照测试。</p><p id="8555" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我写了其他关于反应测试库的文章，如果你喜欢的话，去看看吧！</p><ul class=""><li id="ad64" class="na nb iq ka b kb kc kf kg kj nc kn nd kr ne kv nf ng nh ni bi translated"><a class="ae mr" href="https://medium.com/@egctoru/the-practical-guide-to-start-react-testing-library-with-typescript-d386804a018" rel="noopener">用TypeScript启动反应测试库的实用指南。</a></li></ul><p id="73f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">谢谢你！</p><h2 id="87d3" class="ml lb iq bd lc nj nk dn lg nl nm dp lk kj nn no lo kn np nq ls kr nr ns lw nt bi translated">参考</h2><ul class=""><li id="5424" class="na nb iq ka b kb ly kf lz kj nu kn nv kr nw kv nf ng nh ni bi translated"><a class="ae mr" href="https://testing-library.com/" rel="noopener ugc nofollow" target="_blank">检测库</a></li><li id="0631" class="na nb iq ka b kb nx kf ny kj nz kn oa kr ob kv nf ng nh ni bi translated"><a class="ae mr" href="https://jestjs.io/en/" rel="noopener ugc nofollow" target="_blank"> JEST </a></li><li id="9e90" class="na nb iq ka b kb nx kf ny kj nz kn oa kr ob kv nf ng nh ni bi translated"><a class="ae mr" href="https://github.com/kulshekhar/ts-jest" rel="noopener ugc nofollow" target="_blank"> ts-jest </a></li></ul></div></div>    
</body>
</html>