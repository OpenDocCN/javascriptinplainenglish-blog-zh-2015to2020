<html>
<head>
<title>Build your own REST API with Node, Express, Knex and PostgreSQL — part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node、Express、Knex和PostgreSQL构建您自己的REST API第2部分</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-your-own-rest-api-with-node-express-knex-and-postgresql-part-2-d9ff74f6f2fa?source=collection_archive---------3-----------------------#2020-03-23">https://javascript.plainenglish.io/build-your-own-rest-api-with-node-express-knex-and-postgresql-part-2-d9ff74f6f2fa?source=collection_archive---------3-----------------------#2020-03-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/342f695501cece11b4a0dc82ddc37ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VwEyZ5IQ1WPn_nAASpCvA.png"/></div></div></figure><p id="43cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://medium.com/@fajardocj/build-your-own-rest-api-with-node-express-knex-and-postgresql-aec98fe75e5" rel="noopener">的最后一篇文章</a>中，我们建立了我们的用户模型。让我们再添加两个模型，并探索它与用户模型的关系。</p><h1 id="26d5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建帖子模型</h1><p id="9118" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">启动一个终端，再次输入<code class="fe ma mb mc md b">knex migrate:make create-posts</code>，这一次是针对评论栏:<code class="fe ma mb mc md b">knex migrate:make create-comments</code>。按照相同的顺序创建这些文件是很重要的，稍后您会明白为什么。这将创建两个名为timestamp_create-posts.js和timestamp_create-comments.js的文件。</p><p id="6582" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太好了，我们现在有两个新的迁移，我们可以开始调整。让我们从create-posts.js迁移开始，添加一个id、一个标题和一个主体:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="2276" class="mm ky iq md b gy mn mo l mp mq">exports.up = function (knex) {<br/>    return knex.schema.createTable('posts', (table) =&gt; {<br/>        table.increments(); // This is our id field<br/>        table.string('title');<br/>        table.text('body', 'longtext');<br/>    });<br/>};</span><span id="3997" class="mm ky iq md b gy mr mo l mp mq">exports.down = function (knex) {<br/>    return knex.schema.dropTable('posts')<br/>};</span></pre><h1 id="1a82" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">添加关系</h1><p id="b0b2" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们现在已经建立了posts迁移，但是我们还缺少一些东西。你想想，我们还是没有办法说出每个帖子<strong class="ka ir">属于</strong>的谁。我对我的Rails朋友使用粗体和大写。当您建立一个属于关系时，您所建立的是一个引用所述模型的“所有者”的列。让我们来看看:</p><p id="6b10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将在帖子迁移中添加一个新行，并添加:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="9afd" class="mm ky iq md b gy mn mo l mp mq">table.integer('user_id').notNullable().references('id').inTable('users').onDelete('cascade');</span></pre><p id="57ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们正在谈话！我们现在有一个名为<code class="fe ma mb mc md b">user_id</code>的专栏，可以用来跟踪我们的作者。我们在这一栏中输入的任何数字都将被视为帖子的所有者。</p><p id="1919" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，请注意，当我们设置关系时，rails提供了更多可用的方法，我们只是设置了一个简单的方法，但目前来说，这已经足够了。</p><p id="4ba4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们完成的帖子模型现在应该是这样的:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="4d74" class="mm ky iq md b gy mn mo l mp mq">exports.up = function (knex) {<br/>    return knex.schema.createTable('posts', (table) =&gt; {<br/>        table.increments(); // This is our id field<br/>        table.integer('user_id').unsigned().references('users.id');<br/>        table.string('title');<br/>        table.text('body', 'longtext');<br/>    });<br/>};</span><span id="e050" class="mm ky iq md b gy mr mo l mp mq">exports.down = function (knex) {<br/>    return knex.schema.dropTable('posts')<br/>};</span></pre><p id="be4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我选择在我的id之后添加我的关系，但是您可以选择任何您想要的地方，只要您仍然在表定义内。</p><h1 id="9b07" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在注释表中</h1><p id="5545" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">没什么新的，除了这次我们将引用我们的另外两个表，所以一个评论同时属于一个帖子和一个用户:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="d820" class="mm ky iq md b gy mn mo l mp mq">exports.up = function (knex) {<br/>    return knex.schema.createTable('comments', (table) =&gt; {<br/>        table.increments(); // Again, this will be our id<br/>        table.integer('user_id').notNullable().references('id').inTable('users').onDelete('cascade');<br/>        table.integer('post_id').notNullable().references('id').inTable('posts').onDelete('cascade');<br/>        table.text('body', 'longtext');<br/>    })<br/>};</span><span id="de7f" class="mm ky iq md b gy mr mo l mp mq">exports.down = function (knex) {<br/>    return knex.schema.dropTable('comments');<br/>};</span></pre><p id="8098" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样我们的数据库就完全建立起来了。我们现在要做的就是逃跑</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ef94" class="mm ky iq md b gy mn mo l mp mq">knex migrate:latest</span></pre><p id="4924" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">把我们的新表格输入数据库。让我们通过运行<code class="fe ma mb mc md b">psql tutorial</code>来检查一下:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5252" class="mm ky iq md b gy mn mo l mp mq">~/: psql tutorial<br/>psql (12.2)<br/>Type "help" for help.</span><span id="ff75" class="mm ky iq md b gy mr mo l mp mq">tutorial=# \d<br/>                     List of relations<br/> Schema |              Name              |   Type   | Owner <br/>--------+--------------------------------+----------+-------<br/> public | comments                       | table    | john<br/> public | comments_id_seq                | sequence | john<br/> public | knex_migrations                | table    | john<br/> public | knex_migrations_id_seq         | sequence | john<br/> public | knex_migrations_lock           | table    | john<br/> public | knex_migrations_lock_index_seq | sequence | john<br/> public | posts                          | table    | john<br/> public | posts_id_seq                   | sequence | john<br/> public | users                          | table    | john<br/> public | users_id_seq                   | sequence | john<br/>(10 rows)</span></pre><p id="4f5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太棒了。所有的东西都在那里，再加上knex创建的几个表来跟踪我们的id。</p><h1 id="f3d8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">添加更多种子数据</h1><p id="dcc9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">让我们添加一些数据，以确保我们有一些工作。运行<code class="fe ma mb mc md b">knex seed:make create_dummy_posts</code>并转到你新创建的<code class="fe ma mb mc md b">/seeds/create_dummy_posts.js</code>文件。编辑它，使它看起来像这样:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="850c" class="mm ky iq md b gy mn mo l mp mq">exports.seed = function (knex) {<br/>  return knex('table_name').del()<br/>    .then(function () {<br/>      return knex('table_name').insert([<br/>        {<br/>          user_id: 1,<br/>          title: 'JavaScript',<br/>          body: 'JavaScript, often abbreviated as JS, is a programming language that conforms to the ECMAScript specification. JavaScript is high-level, often just-in-time compiled, and multi-paradigm. It has curly-bracket syntax, dynamic typing, prototype-based object-orientation, and first-class functions.'<br/>        },<br/>        {<br/>          user_id: 1,<br/>          title: 'Node.js',<br/>          body: 'Node.js is an open-source, cross-platform, JavaScript runtime environment that executes JavaScript code outside of a web browser. Node.js lets developers use JavaScript to write command line tools and for server-side scripting—running scripts server-side to produce dynamic web page content before the page is sent to the user\'s web browser. Consequently, Node.js represents a \"JavaScript everywhere\" paradigm, unifying web-application development around a single programming language, rather than different languages for server- and client-side scripts.'<br/>        },<br/>        {<br/>          user_id: 1,<br/>          title: 'Express.js',<br/>          body: 'Express.js, or simply Express, is a web application framework for Node.js, released as free and open-source software under the MIT License. It is designed for building web applications and APIs. It has been called the de facto standard server framework for Node.js.'<br/>        }<br/>      ]);<br/>    });<br/>};</span></pre><p id="6d05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有三篇文章映射到我们的第一个用户，有标题和正文。现在让我们对我们的评论做同样的事情。运行<code class="fe ma mb mc md b">knex seed:make create_dummy_comments</code>并编辑生成的<code class="fe ma mb mc md b">/seeds/create_dummy_comments.js</code>文件:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ac3d" class="mm ky iq md b gy mn mo l mp mq">exports.seed = function (knex) {<br/>  return knex('table_name').del()<br/>    .then(function () {<br/>      // Inserts seed entries<br/>      return knex('table_name').insert([<br/>        { user_id: 1, post_id: 1, body: 'Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts.' },<br/>        { user_id: 1, post_id: 1, body: 'The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc.' },<br/>        { user_id: 1, post_id: 1, body: 'But I must explain to you how all this mistaken idea of denouncing pleasure and praising pain was born and I will give you a complete account of the system.' },<br/>        { user_id: 1, post_id: 2, body: 'Lights creepeth may. Fowl itself you\'re. Dry given moved man gathered moved replenish living. Likeness you\'ll to his can\'t every air fruit for, morning under they\'re.' },<br/>        { user_id: 1, post_id: 2, body: 'Perhaps a re-engineering of your current world view will re-energize your online nomenclature to enable a new holistic interactive enterprise internet communication solution.' },<br/>        { user_id: 1, post_id: 2, body: 'Fundamentally transforming well designed actionable information whose semantic content is virtually null.' },<br/>        { user_id: 1, post_id: 3, body: 'Empowerment in information design literacy demands the immediate and complete disregard of the entire contents of this cyberspace communication.' },<br/>        { user_id: 1, post_id: 3, body: 'Doing business like this takes much more effort than doing your own business at home' },<br/>        { user_id: 1, post_id: 4, body: ' The Big Oxmox advised her not to do so, because there were thousands of bad Commas' },<br/>      ]);<br/>    });<br/>};</span></pre><p id="8299" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们有9条评论，每条评论对应一篇文章，都映射到同一个用户。如果您愿意，您可以修改您的用户种子文件，添加更多的用户，并在种子中使用他们的id，这样就不会出现所有的评论都是由帖子作者本人在明显的精神病发作时写的。</p><p id="5f79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，让我们检查数据库，看看我们的数据是否被正确导入:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="aa33" class="mm ky iq md b gy mn mo l mp mq">tutorial=# SELECT * FROM users;<br/> id | username |        email        <br/>----+----------+---------------------<br/>  1 | John Doe | johndoe@example.com<br/>  2 | Jane Doe | janedoe@example.com<br/>(2 rows)</span><span id="22b7" class="mm ky iq md b gy mr mo l mp mq">tutorial=# SELECT * FROM posts;<br/> id | user_id |   title    |                                                                                                                                                                                       <br/>                                                                                             body                                                                                                                  <br/>                                                                                                                                                                  <br/>----+---------+------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br/>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br/>------------------------------------------------------------------------------------------------------------------------------------------------------------------<br/>  1 |       1 | JavaScript | JavaScript, often abbreviated as JS, is a programming language that conforms to the ECMAScript specification. JavaScript is high-level, often just-in-time compiled, and multi-paradig<br/>m. It has curly-bracket syntax, dynamic typing, prototype-based object-orientation, and first-class functions.<br/>  2 |       1 | Node.js    | Node.js is an open-source, cross-platform, JavaScript runtime environment that executes JavaScript code outside of a web browser. Node.js lets developers use JavaScript to write comm<br/>and line tools and for server-side scripting—running scripts server-side to produce dynamic web page content before the page is sent to the user's web browser. Consequently, Node.js represents a "JavaScript ever<br/>ywhere" paradigm, unifying web-application development around a single programming language, rather than different languages for server- and client-side scripts.<br/>  3 |       1 | Express.js | Express.js, or simply Express, is a web application framework for Node.js, released as free and open-source software under the MIT License. It is designed for building web applicatio<br/>ns and APIs. It has been called the de facto standard server framework for Node.js.<br/>(3 rows)</span><span id="06f2" class="mm ky iq md b gy mr mo l mp mq">tutorial=# SELECT * FROM comments;<br/> id | user_id | post_id |                                                                                      body                                                                                      <br/>----+---------+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br/>  1 |       1 |       1 | Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts.<br/>  2 |       1 |       1 | The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc.<br/>  3 |       1 |       1 | But I must explain to you how all this mistaken idea of denouncing pleasure and praising pain was born and I will give you a complete account of the system.<br/>  4 |       1 |       2 | Lights creepeth may. Fowl itself you're. Dry given moved man gathered moved replenish living. Likeness you'll to his can't every air fruit for, morning under they're.<br/>  5 |       1 |       2 | Perhaps a re-engineering of your current world view will re-energize your online nomenclature to enable a new holistic interactive enterprise internet communication solution.<br/>  6 |       1 |       2 | Fundamentally transforming well designed actionable information whose semantic content is virtually null.<br/>  7 |       1 |       3 | Empowerment in information design literacy demands the immediate and complete disregard of the entire contents of this cyberspace communication.<br/>  8 |       1 |       3 | Doing business like this takes much more effort than doing your own business at home<br/>  9 |       1 |       3 |  The Big Oxmox advised her not to do so, because there were thousands of bad Commas<br/>(9 rows)</span></pre><p id="b2a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然这种布局很难看到，但我们可以放心，我们的数据就在那里。现在，我们已经拥有了开始添加路线所需的一切！下周回来看《T2》第三部。</p></div></div>    
</body>
</html>