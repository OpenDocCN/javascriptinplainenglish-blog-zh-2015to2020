<html>
<head>
<title>Why and how to use stable node and npm versions across your project &amp; team</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么以及如何在您的项目和团队中使用稳定的节点和npm版本</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/why-and-how-to-use-stable-node-and-npm-versions-across-your-project-team-a4886f51a96c?source=collection_archive---------2-----------------------#2020-04-12">https://javascript.plainenglish.io/why-and-how-to-use-stable-node-and-npm-versions-across-your-project-team-a4886f51a96c?source=collection_archive---------2-----------------------#2020-04-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e0e7c77ec42d720eccc60137f8975748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FT8esHf0KxZYHCD-mI8uAw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Picture courtesy of <a class="ae kc" href="https://unsplash.com/@veverkolog" rel="noopener ugc nofollow" target="_blank">@veverkolog</a></figcaption></figure><p id="bdfc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我坚信开发环境应该尽可能稳定，以消除环境之间和开发人员之间的差异。当不去管配置时，配置有一种自然的漂移趋势，所以最好是尽可能多地自动化和强制执行。</p><p id="8357" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是为什么我认为基于节点的项目应该在任何地方都使用NodeJS和npm的稳定和已知版本:本地开发、执行测试、构建生产二进制文件以及在生产中运行应用程序。</p><p id="5721" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于项目依赖项，这很容易实施，因为您可以在package.json中列出您的依赖项，并将package-lock.json或yarn.lock文件添加到代码库。</p><p id="1a6f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是对于node本身和npm的版本，还需要做更多的工作。</p><p id="1dbb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将解释可以采取哪些步骤来确保您在任何地方都使用相同/预期的版本。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="25ae" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">节点和npm的项目范围版本</h1><p id="3b48" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">您可以做的第一件事是在项目(或monorepo)的根目录下创建文件，以声明要使用的版本。</p><p id="946d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的monorepo中，我创造了:</p><ul class=""><li id="594e" class="ml mm iq kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated">。npm版本，仅包含6.14.4</li><li id="bef5" class="ml mm iq kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">。nvmrc，包含12.15.0</li></ul><p id="5569" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">的”。npm-version“文件名是任意的，因为据我所知，对于这种特殊的需求没有约定，但是”。nvmrc”文件是著名的节点版本管理工具<a class="ae kc" href="https://github.com/nvm-sh/nvm" rel="noopener ugc nofollow" target="_blank"> nvm </a>期望的<a class="ae kc" href="https://github.com/nvm-sh/nvm#nvmrc" rel="noopener ugc nofollow" target="_blank">名。</a></p><p id="933e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加了这两个文件后，我们现在有了一个供节点和npm版本使用的真实信息来源。</p><p id="6258" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但仅此一项并没有多大作用。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="d74c" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">定义npm引擎</h1><p id="3453" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">我们可以做的第二件事是利用npm 的package.json文件中一个非常有用(但不太为人所知)的<a class="ae kc" href="https://docs.npmjs.com/files/package.json#engines" rel="noopener ugc nofollow" target="_blank">特性，称为</a><a class="ae kc" href="https://docs.npmjs.com/files/package.json#engines" rel="noopener ugc nofollow" target="_blank">引擎</a>。</p><p id="6360" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在package.json文件中，我们可以通过“引擎”字段指定不同“引擎”应该使用的版本。</p><p id="4d50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个例子:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="2003" class="ni lj iq ne b gy nj nk l nl nm">"engines": {<br/>  "node": "&gt;=12.15.0 &lt;= 12.99.0",<br/>  "npm": "&gt;=6.14.4 &lt;= 6.99.99"<br/>}</span></pre><p id="3689" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这告诉npm，它应该期望项目与等于或高于12.15.0的节点版本和等于或高于6.14.4的npm版本一起使用。</p><p id="3aa1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们当然可以更严格，但是在这个例子中我们还是坚持这样。</p><p id="f0bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，如果指定了引擎字段，npm将期望在引擎列表中至少找到“节点”。</p><p id="4722" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提示:如果你正在使用yarn，你也可以指定它的版本；纱线<a class="ae kc" href="https://classic.yarnpkg.com/en/docs/package-json/#toc-engines" rel="noopener ugc nofollow" target="_blank">也支持它</a>。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="906f" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">使用npm实施npm引擎</h1><p id="af0d" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">默认情况下，对于npm，引擎列表只是建议性的，只会产生警告。纱线不那么宽松，如果不遵守发动机清单，纱线会爆炸。</p><p id="13c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好消息是，我们可以通过设置<a class="ae kc" href="https://docs.npmjs.com/misc/config#engine-strict" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">引擎严格的</strong> </a>配置标志，配置npm来执行引擎列表。</p><p id="9fa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以指示所有的开发人员调整他们的npm配置，或者把它放在开发人员指南中，但是更好的方法是向项目中添加一个. npmrc文件，以便自动执行它。</p><p id="7863" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是一个示例:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="4bf8" class="ni lj iq ne b gy nj nk l nl nm"># Make sure that we use the expected node and npm versions<br/>engine-strict=true</span></pre><p id="0848" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这个，npm会让我们知道我们是否试图用一个意想不到的节点或npm版本来构建/安装。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="2919" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">使用环境文件</h1><p id="e10f" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">我们可以采取的另一个在整个构建生命周期中利用我们的版本的步骤是使用“<strong class="kf ir">”。env" </strong>文件。<a class="ae kc" href="https://docs.docker.com/compose/env-file/" rel="noopener ugc nofollow" target="_blank"> Env文件</a>只是环境变量的列表。</p><p id="9942" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的项目中，每当需要构建、测试、执行或部署项目时，我都会生成一个。该文件是从各种配置文件中派生出来的，我现在还不会涉及。</p><p id="f298" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重要的是当我生成。环境文件，我读了我的。NPM-版本和。以便能够正确定义NPM _版本和节点_版本变量。</p><p id="b530" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的基本变量文件中，我有以下内容:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="6614" class="ni lj iq ne b gy nj nk l nl nm">export NODE_VERSION=$(cat ./.nvmrc)<br/>export NPM_VERSION=$(cat ./.npm-version)</span></pre><p id="5604" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我只是呼应了我的。env文件使用:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="72f8" class="ni lj iq ne b gy nj nk l nl nm">echo NODE_VERSION=${NODE_VERSION} &gt;&gt; .env<br/>echo NPM_VERSION=${NPM_VERSION} &gt;&gt; .env</span></pre><p id="ce88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦完成了，我的。env文件包含我期望的内容:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="845e" class="ni lj iq ne b gy nj nk l nl nm">...<br/>NODE_VERSION=12.15.0<br/>NPM_VERSION=6.14.4<br/>...</span></pre><p id="3c55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那个。env文件很有用，因为它可以在各种上下文中加载(例如，Docker build、Docker compose、Kubernetes configMaps/secrets、shell脚本、build脚本等)。</p><p id="06c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将在下面展示一些例子。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="50b9" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">利用Dockerfile中的env文件</h1><p id="0f7f" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">正如我在上一篇文章中所展示的<a class="ae kc" href="https://medium.com/@dSebastien/speeding-up-your-ci-cd-build-times-with-a-custom-docker-image-3bfaac4e0479" rel="noopener">，我们可以将参数传递给Dockerfiles，这正是我为CI Docker形象所做的。</a></p><p id="d8ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于我们想强制执行节点和npm版本，我们需要将它们作为参数传递给Dockerfile，以便它在构建映像时使用正确的版本。</p><p id="94ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想了解更多信息，请阅读<a class="ae kc" href="https://medium.com/@dSebastien/speeding-up-your-ci-cd-build-times-with-a-custom-docker-image-3bfaac4e0479" rel="noopener">文章</a>。</p><p id="ea5b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">负责创建Docker映像的脚本也是如此；这里有一个例子:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="b0f8" class="ni lj iq ne b gy nj nk l nl nm">#!/usr/bin/env bash<br/><br/># Reference: https://stackoverflow.com/questions/19331497/set-environment-variables-from-file-of-key-value-pairs<br/># Import env vars<br/>set -o allexport<br/>source ./.env<br/>set +o allexport<br/><br/>echo "-----------------------------------"<br/>echo "Create some Docker image           "<br/>echo "-----------------------------------"<br/><br/>echo "Building the Docker image for whatever"<br/><br/># Build arg values are passed automatically because they have the same name in the Dockerfile<br/># Reference: https://vsupalov.com/docker-build-pass-environment-variables/#using-host-environment-variable-values-to-set-args<br/>docker ${DOCKER_EXTRA_OPTIONS} build \<br/>       ${DOCKER_BUILD_EXTRA_OPTIONS} \<br/>       --build-arg DOCKER_BASE_IMAGE \<br/>       --build-arg NODE_VERSION \<br/>       --build-arg NPM_VERSION \<br/>       --build-arg NODE_OPTIONS \<br/>       ...<br/>       --target ${DOCKER_BUILD_TARGET} \<br/>       --file Dockerfile \<br/>       --tag ${DOCKER_IMAGE_NAME}:latest \<br/>       --tag ${DOCKER_IMAGE_NAME}:${PROJECT_COMMIT_HASH} \<br/>       --tag ${DOCKER_IMAGE_NAME}:${PROJECT_VERSION} \<br/>       .</span></pre><p id="9537" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过将正确的参数传递给Docker文件，我们可以确保使用正确的基节点Docker图像。</p><p id="4b8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，一旦Dockerfile具有npm和节点版本的环境变量，它就可以使用它们来安装预期的版本；例如:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="30cf" class="ni lj iq ne b gy nj nk l nl nm">npm install --global npm@${NPM_VERSION}</span></pre><p id="c6f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于这一点，我们可以肯定，正确的版本将被使用。</p><p id="2a42" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，如果您像我一样使用Docker映像进行开发，那么您也可以确信Docker/Docker-compose/Kubernetes开发环境装载了预期的版本。</p><p id="2db1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于这些版本只有一个真实的来源，所以很容易适应:改变文件，重新构建/发布，就这样。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="1a33" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">结论</h1><p id="c816" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">本文介绍了一些有用的技巧，可以减少项目团队中开发人员之间的差异，同时保持开发和生产环境的一致性。</p><p id="dc80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些都是小而容易的步骤，但是它们可以极大地帮助减少“它在我的机器上工作”综合症的发生。</p><p id="5759" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天到此为止！</p></div></div>    
</body>
</html>