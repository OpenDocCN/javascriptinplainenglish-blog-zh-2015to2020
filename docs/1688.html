<html>
<head>
<title>Creating and Using Data Sources with Express and Apollo Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Express和Apollo Server创建和使用数据源</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-and-using-data-sources-with-express-and-apollo-server-d3c84758b135?source=collection_archive---------8-----------------------#2020-04-14">https://javascript.plainenglish.io/creating-and-using-data-sources-with-express-and-apollo-server-d3c84758b135?source=collection_archive---------8-----------------------#2020-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/45f0884301fd4e5b3761d5d9e8b5e16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8R0kdjaw74SoBCj9"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jrlawrence?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jeremiah Lawrence</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ef83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Apollo服务器作为节点包提供。我们可以用它来创建一个接受GraphQL请求的服务器。</p><p id="94ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究如何创建REST数据源来从外部数据源获取数据。</p><h1 id="e1c4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">REST数据源</h1><p id="bbbd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">数据源是封装从服务获取数据的类，内置了对缓存、重复数据删除和错误处理的支持。</p><p id="38d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用它来与我们的后端交互，剩下的工作由Apollo Server来完成。</p><p id="74e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建和使用<code class="fe me mf mg mh b">RESTDataSource</code>的一个简单例子如下:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f7de" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql, SchemaDirectiveVisitor } = require('apollo-server-express');<br/>const { RESTDataSource } = require('apollo-datasource-rest');</span><span id="9df8" class="mq lc iq mh b gy mv ms l mt mu">class JokesAPI extends RESTDataSource {<br/>  constructor() {<br/>    super();<br/>    this.baseUrl = 'https://api.icndb.com/';<br/>  }</span><span id="3466" class="mq lc iq mh b gy mv ms l mt mu">  async getRandomJoke() {<br/>    return this.get(`${this.baseUrl}/jokes/random`)<br/>  }<br/>}</span><span id="24e4" class="mq lc iq mh b gy mv ms l mt mu">const typeDefs = gql`<br/>  type Joke {<br/>    id: Int,<br/>    joke: String<br/>  }</span><span id="8af1" class="mq lc iq mh b gy mv ms l mt mu">  type JokeResponse {<br/>    value: Joke    <br/>  }</span><span id="affc" class="mq lc iq mh b gy mv ms l mt mu">  type Query {<br/>    joke: JokeResponse<br/>  }<br/>`;</span><span id="7720" class="mq lc iq mh b gy mv ms l mt mu">const resolvers = {<br/>  Query: {<br/>    async joke(parent, args, { dataSources }) {<br/>      return dataSources.jokesAPI.getRandomJoke();<br/>    },<br/>  },<br/>};</span><span id="61be" class="mq lc iq mh b gy mv ms l mt mu">const app = express();<br/>const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  dataSources: () =&gt; {<br/>    return {<br/>      jokesAPI: new JokesAPI(),<br/>    };<br/>  },<br/>});<br/>server.applyMiddleware({ app });</span><span id="3600" class="mq lc iq mh b gy mv ms l mt mu">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="1a7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的例子中，我们有<code class="fe me mf mg mh b">JokesAPI</code>数据源:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d59c" class="mq lc iq mh b gy mr ms l mt mu">class JokesAPI extends RESTDataSource {<br/>  constructor() {<br/>    super();<br/>    this.baseUrl = 'https://api.icndb.com/';<br/>  }</span><span id="b0ab" class="mq lc iq mh b gy mv ms l mt mu">  async getRandomJoke() {<br/>    return this.get(`${this.baseUrl}/jokes/random`)<br/>  }<br/>}</span></pre><p id="e837" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在那里，我们有一个<code class="fe me mf mg mh b">getMovie</code>方法，它用电影对象返回一个承诺。</p><p id="4de8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由<code class="fe me mf mg mh b">RESTDataSource</code>提供的<code class="fe me mf mg mh b">get</code>方法让我们向服务器发出GET请求。</p><p id="6b05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们将类型定义如下:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1a58" class="mq lc iq mh b gy mr ms l mt mu">const typeDefs = gql`<br/>  type Joke {<br/>    id: Int,<br/>    joke: String<br/>  }</span><span id="b774" class="mq lc iq mh b gy mv ms l mt mu">  type JokeResponse {<br/>    value: Joke    <br/>  }</span><span id="476c" class="mq lc iq mh b gy mv ms l mt mu">  type Query {<br/>    joke: JokeResponse<br/>  }<br/>`;</span></pre><p id="fb7b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有一个简单的带有字符串字段的类型。然后，我们将数据源添加到我们的服务器，它将在解析器的第三个参数中可用，如下所示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f015" class="mq lc iq mh b gy mr ms l mt mu">const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  dataSources: () =&gt; {<br/>    return {<br/>      moviesAPI: new MoviesAPI(),<br/>    };<br/>  },<br/>});</span></pre><p id="172e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们通过编写以下代码来添加解析器:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c0d8" class="mq lc iq mh b gy mr ms l mt mu">const resolvers = {<br/>  Query: {<br/>    async joke(parent, args, { dataSources }) {<br/>      return dataSources.jokesAPI.getRandomJoke();<br/>    },<br/>  },<br/>};</span></pre><p id="1a92" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">返回电影。<code class="fe me mf mg mh b">dataSources</code>就是我们传递给<code class="fe me mf mg mh b">ApolloServer</code>构造函数的那个。</p><p id="e59f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们进行以下查询时:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6d93" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  joke {<br/>    value {<br/>      joke<br/>    }<br/>  }<br/>}</span></pre><p id="a667" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e20e" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  "data": {<br/>    "joke": {<br/>      "value": {<br/>        "joke": "Chuck Norris does not code in cycles, he codes in strikes."<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="8a3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/3fd1fc5dd2961dc559fd7d7169cd12ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fa0oMmZtoLz8nSnI"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@iamhrithikb?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Hrithik Bachchas</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="3adc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">HTTP请求</h1><p id="86c3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以创建对服务器进行HTTP的方法。我们可以使用<code class="fe me mf mg mh b">this.post</code>发出POST请求，<code class="fe me mf mg mh b">this.put</code>发出PUT请求，<code class="fe me mf mg mh b">this.patch</code>发出PATCH请求，<code class="fe me mf mg mh b">this.delete</code>发出DELETE请求。</p><p id="198b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个参数是URL，第二个参数是有效负载。</p><p id="d38e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以像下面的<code class="fe me mf mg mh b">postTodo </code>方法一样发出POST请求:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="fe0e" class="mq lc iq mh b gy mr ms l mt mu">class TodosAPI extends RESTDataSource {<br/>  constructor() {<br/>    super();<br/>    this.baseUrl = 'https://jsonplaceholder.typicode.com/';<br/>  }</span><span id="8bc4" class="mq lc iq mh b gy mv ms l mt mu">  async postTodo(todo) {        <br/>    return this.post(`${this.baseUrl}/todos`, todo)<br/>  }<br/>}</span></pre><h1 id="cf98" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">拦截提取</h1><p id="a515" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加<code class="fe me mf mg mh b">willSendRequest</code>钩子，在将请求发送到服务器之前拦截它们。</p><p id="9b59" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以如下使用它:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4f07" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql, SchemaDirectiveVisitor } = require('apollo-server-express');<br/>const { RESTDataSource } = require('apollo-datasource-rest');</span><span id="0e97" class="mq lc iq mh b gy mv ms l mt mu">class JokesAPI extends RESTDataSource {<br/>  constructor() {<br/>    super();<br/>    this.baseUrl = 'https://api.icndb.com/';<br/>  }</span><span id="ab2c" class="mq lc iq mh b gy mv ms l mt mu">  willSendRequest(request) {<br/>    request.headers.set('Authorization', this.context.token);<br/>  }</span><span id="d4af" class="mq lc iq mh b gy mv ms l mt mu">  async getRandomJoke() {<br/>    return this.get(`${this.baseUrl}/jokes/random`)<br/>  }<br/>}</span><span id="a952" class="mq lc iq mh b gy mv ms l mt mu">const typeDefs = gql`<br/>  type Joke {<br/>    id: Int,<br/>    joke: String<br/>  }</span><span id="972d" class="mq lc iq mh b gy mv ms l mt mu">  type JokeResponse {<br/>    value: Joke    <br/>  }</span><span id="3640" class="mq lc iq mh b gy mv ms l mt mu">  type Query {<br/>    joke: JokeResponse<br/>  }<br/>`;</span><span id="10ee" class="mq lc iq mh b gy mv ms l mt mu">const resolvers = {<br/>  Query: {<br/>    async joke(parent, args, { dataSources }) {<br/>      return dataSources.jokesAPI.getRandomJoke();<br/>    },<br/>  },<br/>};</span><span id="b06a" class="mq lc iq mh b gy mv ms l mt mu">const app = express();<br/>const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  dataSources: () =&gt; {<br/>    return {<br/>      jokesAPI: new JokesAPI(),<br/>    };<br/>  },<br/>  context: () =&gt; ({ token: 'foo' })<br/>});<br/>server.applyMiddleware({ app });</span><span id="48c6" class="mq lc iq mh b gy mv ms l mt mu">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="9df6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们返回了令牌，即:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1920" class="mq lc iq mh b gy mr ms l mt mu">context: () =&gt; ({ token: 'foo' })</span></pre><p id="b808" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">willSendRequest</code>方法中，我们可以如下调用<code class="fe me mf mg mh b">request.headers.set</code>来附加我们附加到请求的<code class="fe me mf mg mh b">token</code>,如下所示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d168" class="mq lc iq mh b gy mr ms l mt mu">willSendRequest(request) {<br/>  request.headers.set('Authorization', this.context.token);<br/>}</span></pre><p id="4cd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">this.context</code>我们返回的对象是:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9cb9" class="mq lc iq mh b gy mr ms l mt mu">context: () =&gt; ({ token: 'foo' })</span></pre><p id="1f80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其余与第一个例子相同。</p><h1 id="889e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">动态解析URL</h1><p id="47c5" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过在我们的<code class="fe me mf mg mh b">RESTDataSource</code>类中为URL添加一个getter来设置请求的基本URL，如下所示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="38b3" class="mq lc iq mh b gy mr ms l mt mu">get baseURL() {<br/>  if (this.context.env === 'development') {<br/>    return '<!-- -->http://api.icndb.com/jokes/random<!-- -->';<br/>  }<br/>}</span></pre><h1 id="1f19" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="d581" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以创建自己的类来扩展<code class="fe me mf mg mh b">RESTDataSource</code>类，向其他服务器发出请求以获取和设置数据。</p><p id="6fe9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它有发出HTTP请求的方法，并且可以访问我们服务器的<code class="fe me mf mg mh b">context</code>来获取各种数据。</p><p id="ef18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们在传递给<code class="fe me mf mg mh b">ApolloServer</code>构造函数的对象中设置了<code class="fe me mf mg mh b">dataSources</code>属性，我们就可以访问这个类的实例。</p><p id="a593" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过添加一个<code class="fe me mf mg mh b">willSendRequest</code>方法来添加标题，该方法有一个<code class="fe me mf mg mh b">request</code>对象，在这里我们可以调用<code class="fe me mf mg mh b">headers</code>属性上的<code class="fe me mf mg mh b">set</code>。</p><h2 id="89a7" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="a6a1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们总是有兴趣帮助推广高质量的内容。如果你有一篇文章想用简单的英语提交给JavaScript，用你的中级用户名发邮件到<a class="ae kc" href="mailto:submissions@javascriptinplainenglish.com" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">submissions@javascriptinplainenglish.com</strong></a>给我们，我们会把你添加为作者。</p><p id="a945" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还推出了三种新的出版物！为我们的新出版物献上一点爱心吧，请跟随他们:<a class="ae kc" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="kf ir">AI in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="kf ir">UX in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="kf ir">Python in Plain English</strong></a><strong class="kf ir"/>——谢谢，继续学习！</p></div></div>    
</body>
</html>