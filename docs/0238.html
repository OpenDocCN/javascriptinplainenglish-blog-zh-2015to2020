<html>
<head>
<title>How I Setup Unit Test for MongoDB using Jest &amp; Mongoose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Jest &amp; Mongoose为MongoDB设置单元测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-i-setup-unit-test-for-mongodb-using-jest-mongoose-103b772ee164?source=collection_archive---------0-----------------------#2019-09-03">https://javascript.plainenglish.io/how-i-setup-unit-test-for-mongodb-using-jest-mongoose-103b772ee164?source=collection_archive---------0-----------------------#2019-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8b68a290a0e88d22bb157db2baccfd92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bffrrOyuv4OuQtZw"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@goshua13?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joshua Aragon</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2a02" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">背景</h1><p id="81c9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我正在做一个后端微服务项目，该项目采用了MongoDB、Express Framework、RabbitMQ等技术栈。最近，我被指派开发一个相当大的功能，它涉及不同微服务之间的变化和逻辑流。我在下面的截图中草拟了流程。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/ce99ec0fffe51cc543399a8aaa48d51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8IdODmcP8SBWnaIDZQfHw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Microservices Flow and Forgive my handwriting</figcaption></figure><p id="7115" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">如果您想要设置和运行所有相关项目并执行端到端测试，这是非常具有挑战性和耗时的，因为当您的范围非常大时，错误可能会在所有这些不同的微服务中的任何地方发生。</p><h1 id="d245" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">解决方案设计</h1><p id="8241" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我想到的解决方案是<strong class="ld ir">在每个微服务中对代码进行单元测试。</strong></p><p id="77d9" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">当你从事微服务项目时，单元测试是很重要的。这是因为在进行集成测试之前，您希望确保您的代码能够正常工作。根据您的业务用例，集成测试可能会很困难和复杂。</p><p id="bd81" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">这是我第一次觉得编写单元测试要容易得多。然而，在本文中，我们将只关注MongoDB单元测试。</p><h1 id="1ee2" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">履行</h1><p id="409d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">事不宜迟，让我们起草并分解实现步骤。</p><ol class=""><li id="078a" class="mj mk iq ld b le me li mf lm ml lq mm lu mn ly mo mp mq mr bi translated">基本快速应用程序设置</li><li id="a1f6" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly mo mp mq mr bi translated">使用Mongoose创建一个用户模型</li><li id="602e" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly mo mp mq mr bi translated">设置Jest &amp; MongoDB内存服务器</li><li id="014b" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly mo mp mq mr bi translated">单元测试</li></ol><h2 id="0c3f" class="mx ke iq bd kf my mz dn kj na nb dp kn lm nc nd kr lq ne nf kv lu ng nh kz ni bi translated">基本快速应用程序设置</h2><p id="fd14" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该应用程序使用<a class="ae kc" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>框架运行。这个设置的预期结果是，我们将有一个连接到MongoDB的功能应用程序。</p><p id="a9ba" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">要完成安装，需要下列依赖项。</p><ul class=""><li id="83de" class="mj mk iq ld b le me li mf lm ml lq mm lu mn ly nj mp mq mr bi translated"><a class="ae kc" href="https://github.com/motdotla/dotenv" rel="noopener ugc nofollow" target="_blank">昏庸</a>。这是用于管理环境变量的流行库。常见的用例是在这里存储MongoDB连接字符串，这样就可以很容易地为不同的环境配置连接字符串。</li><li id="6873" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly nj mp mq mr bi translated"><a class="ae kc" href="https://mongoosejs.com/docs/index.html" rel="noopener ugc nofollow" target="_blank">猫鼬</a>。MongoDB的数据建模库。</li></ul><p id="5e04" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated"><strong class="ld ir">为什么是猫鼬？</strong></p><p id="b776" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">我之所以用Mongoose而不是<a class="ae kc" href="https://mongodb.github.io/node-mongodb-native/3.3/" rel="noopener ugc nofollow" target="_blank"> MongoDB节点驱动</a>是因为<strong class="ld ir">模式</strong>和<strong class="ld ir">验证</strong>。我不会深入猫鼬。基本上，Mongoose提供的是允许我<strong class="ld ir">有意地</strong>定义我想要的字段，以及该字段是强制的还是可选的。有意编码非常重要，我们有责任知道每一行代码的用途。</p><p id="9730" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">似乎很复杂？不要担心设置。我为您设置了所需的依赖项。你可以通过<a class="ae kc" href="https://github.com/tlcheah2/unit-test-mongodb-with-jest/tree/initial-setup" rel="noopener ugc nofollow" target="_blank"> Github </a>下载或者克隆代码，无缝地建立你自己的单元测试项目。</p><h2 id="12b7" class="mx ke iq bd kf my mz dn kj na nb dp kn lm nc nd kr lq ne nf kv lu ng nh kz ni bi translated">使用Mongoose创建用户模型</h2><p id="8f7b" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我们成功建立项目之后。在我们创建模型之前，我们必须知道我们想要什么。</p><p id="cdcd" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">这意味着我们对用户模型有什么期望。假设我们想知道用户的<strong class="ld ir"> <em class="nk">姓名</em> </strong>、<strong class="ld ir"> <em class="nk">出生日期、年龄</em> </strong> <em class="nk">以及使用何种社交账户登录。这个过程被称为在猫鼬中定义<code class="fe nl nm nn no b">schema</code>。</em></p><p id="cc67" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">定义模式比您想象的要容易。以下是步骤和代码:</p><ol class=""><li id="9534" class="mj mk iq ld b le me li mf lm ml lq mm lu mn ly mo mp mq mr bi translated">定义用户模式。</li><li id="9473" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly mo mp mq mr bi translated">用定义的用户模式创建用户模型。</li></ol><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="d772" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">现在我们有了一个工作模式和模型。让我们继续设置Jest和单元测试。</p><h2 id="b992" class="mx ke iq bd kf my mz dn kj na nb dp kn lm nc nd kr lq ne nf kv lu ng nh kz ni bi translated">设置Jest &amp; MongoDB内存服务器</h2><p id="9312" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="ld ir">分步指南<br/> </strong>首先我们要安装Jest。我选择将它作为一个开发依赖项来安装，这样每个签出这个项目人都可以使用它，而无需在他们自己的工作站中全局安装任何依赖项。</p><p id="b00e" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated"><code class="fe nl nm nn no b">npm install jest --save-dev</code></p><p id="0012" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">我会说Jest是MongoDB进行单元测试的完美匹配，因为Jest附带了MongoDB 预置的<a class="ae kc" href="https://jestjs.io/docs/en/mongodb" rel="noopener ugc nofollow" target="_blank">,它提供了所有的配置，只需要最少的设置。一会儿我会解释更多。现在，让我们安装预置。</a></p><p id="17d8" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated"><code class="fe nl nm nn no b">npm install @shelf/jest-mongodb --save-dev</code></p><p id="db71" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">然后，在您的项目目录中创建<code class="fe nl nm nn no b">jest.config.js</code>。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="np nq l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Jest Preset</figcaption></figure><p id="6af0" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">之后，在你的项目目录下创建<code class="fe nl nm nn no b">jest-mongodb-config.js</code>,内容如下。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e3d6" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">配置到此为止。很简单，对吧？</p><p id="6a45" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated"><strong class="ld ir">为什么用MongoDB预置Jest？<br/> </strong>该预置帮助您配置所有设置<a class="ae kc" href="https://github.com/nodkz/mongodb-memory-server" rel="noopener ugc nofollow" target="_blank"> MongoDB内存服务器</a>。</p><p id="17cf" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">为什么我们需要MongoDB内存服务器？这是因为当您运行您的单元测试时，您不希望您的单元测试虚拟日期被保存到您的真实数据库中。因此，MongoDB内存服务器为您提供了只在内存中存储数据的能力。</p><p id="1128" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">有了这个预设，我们就可以忽略掉大多数让我们失去动力的设置，把大部分时间花在编写单元测试的真正工作上。</p><h2 id="35e7" class="mx ke iq bd kf my mz dn kj na nb dp kn lm nc nd kr lq ne nf kv lu ng nh kz ni bi translated">单元测试</h2><p id="0eb4" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在我们知道了<strong class="ld ir">为什么</strong>和<strong class="ld ir">如何</strong>的部分。让我们在刚刚创建的用户模型上做一些单元测试。让我们配置mongoose到Mongo内存服务器的连接，我还列出了一些非常简单的测试用例。</p><p id="1344" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">这是我们将要测试的测试用例列表。</p><ul class=""><li id="fddc" class="mj mk iq ld b le me li mf lm ml lq mm lu mn ly nj mp mq mr bi translated">将用户成功插入数据库。(测试正常用例)</li><li id="d342" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly nj mp mq mr bi translated">插入具有无效字段的用户。(模式测试)</li><li id="8541" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly nj mp mq mr bi translated">插入没有必填字段的用户。(验证测试)</li></ul><p id="8c4c" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">也可以参考下面的要旨。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="90d9" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="bbb9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我看来，开发人员总是有动力，热衷于做单元测试。但是，花费精力和时间的<strong class="ld ir">依赖嘲讽</strong>和<strong class="ld ir">配置</strong>始终是一个<strong class="ld ir"> <em class="nk">障碍和挫伤积极性的因素</em> </strong>。</p><p id="26c9" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">我自己也经历过这种情况，但我不知道如何解决依赖性，以便继续编写单元测试。最后，我跳过了单元测试，这是一种不好的感觉。</p><p id="16d7" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">现在，通过简单的设置，所有的预置和配置都为您准备好了，您可以用最少的努力编写单元测试了。相信我，你的单元测试会给你的队友留下深刻印象。</p><blockquote class="nr"><p id="b917" class="ns nt iq bd nu nv nw nx ny nz oa ly dk translated">与程序员的队友建立信任的捷径:编写测试。</p></blockquote><p id="f58e" class="pw-post-body-paragraph lb lc iq ld b le ob lg lh li oc lk ll lm od lo lp lq oe ls lt lu of lw lx ly ij bi translated">最后，我希望这篇文章能启发你编写单元测试，并给你信息编写单元测试可能比你想象的更容易。</p><h1 id="d6fd" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">参考</h1><ul class=""><li id="7e55" class="mj mk iq ld b le lf li lj lm og lq oh lu oi ly nj mp mq mr bi translated">官方笑话<a class="ae kc" href="https://jestjs.io/docs/en/mongodb" rel="noopener ugc nofollow" target="_blank">文档</a>与MongoDB</li><li id="f7d1" class="mj mk iq ld b le ms li mt lm mu lq mv lu mw ly nj mp mq mr bi translated">MongoDB内存服务器的Jest预设<a class="ae kc" href="https://github.com/shelfio/jest-mongodb" rel="noopener ugc nofollow" target="_blank"> Github </a></li></ul><p id="f59b" class="pw-post-body-paragraph lb lc iq ld b le me lg lh li mf lk ll lm mg lo lp lq mh ls lt lu mi lw lx ly ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>