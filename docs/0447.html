<html>
<head>
<title>useTime() React Hook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">useTime() React挂钩</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/usetime-react-hook-f57979338de?source=collection_archive---------1-----------------------#2019-10-17">https://javascript.plainenglish.io/usetime-react-hook-f57979338de?source=collection_archive---------1-----------------------#2019-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c809" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">React中的倒计时很复杂/很难。让我们使用钩子来创建一个useTime钩子。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/55250e1a349d25bf12bedd13e420237c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*68fPZL6QCXC19wgqi32-MA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Time keeps on ticking… Photo by <a class="ae kv" href="https://unsplash.com/@loic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Djim Loic</a> on <a class="ae kv" href="https://unsplash.com/s/photos/clock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="c5d7" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">钩子(代码优先！)</h1><p id="f29b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">复制粘贴这个要点(<a class="ae kv" href="https://gist.github.com/jamesfulford/7f3311bd918982e68d911a9c70b27415" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/jamesfulford/7f 3311 BD 918982 e 68d 911 a9 c 70 b 27415</a>)并在您的代码库中尝试一下。别担心，你回来的时候这篇文章还在。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">useTime, getTime, and sample usage in a Countdown component.</figcaption></figure><p id="1710" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">这个要点目前使用Luxon处理日期，但是注释显示了如何将其转换为使用Moment或原生JS日期。如果时区复杂，纪元整数也是明智之举。</p><p id="20a4" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">PSA:如果你正在处理时区，使用一个库。否则，这将发生在你和你所有的朋友身上(我警告过你)</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms ml l"/></div></figure><h1 id="ab1f" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">问题是</h1><p id="6117" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">渲染React组件时使用当前时间可能会很棘手。目前的文献(媒体文章、各种博客和StackOverflow答案)通常有3个问题:</p><h1 id="a836" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">实现是错误的</h1><p id="9046" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在React中使用当前时间很困难。由于对Javascript中的<code class="fe mt mu mv mw b">setInterval</code>的误解，以及对React中的<code class="fe mt mu mv mw b">state</code>转换的误解，<code class="fe mt mu mv mw b">setInterval</code>回调递增/递减状态的常见解决方案会很快失去同步。</p><p id="56ec" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">在<code class="fe mt mu mv mw b">render</code>方法中直接访问当前时间不会在需要时触发重新渲染，并且通过一个属性/上下文只会将问题委托给不同的组件。因此，使用状态的解决方案是正确的解决方案。</p><p id="6155" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">博客、媒体文章和StackOverFlow回答中的一些实现错误地更新了状态。一些倒计时实现将存储剩余秒数，然后<strong class="lq ir">将使用<code class="fe mt mu mv mw b">setInterval</code>每1000毫秒递减</strong>剩余秒数。这将很快与实际时间<em class="mr">不同步，具体取决于:</em></p><ul class=""><li id="f057" class="mx my iq lq b lr mm lu mn lx mz mb na mf nb mj nc nd ne nf bi translated">选项卡可见多长时间(出于性能原因，浏览器会降低<code class="fe mt mu mv mw b">setInterval</code>调用非焦点页面的优先级)</li><li id="7367" class="mx my iq lq b lr ng lu nh lx ni mb nj mf nk mj nc nd ne nf bi translated">应用程序的其余部分有多复杂(如果有大量工作要做，线程可能无法足够快地到达<code class="fe mt mu mv mw b">setInterval</code>回调)</li><li id="5189" class="mx my iq lq b lr ng lu nh lx ni mb nj mf nk mj nc nd ne nf bi translated">查看设备的性能规格(例如，移动设备执行JS会更慢)</li></ul><p id="d683" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">如果你想了解更多，研究一下“Javascript事件循环”——几个好的面试问题都围绕着这个概念。这不是特异反应。</p><p id="d404" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">具体到React，一些实现没有考虑到<code class="fe mt mu mv mw b">this.setState</code>不会立即更新状态的事实。这意味着在第二状态更新被排队之前，第一状态更新可能还没有被执行。<em class="mr">如果实现依赖于前一状态来决定下一状态</em>(即时间递增或递减)，这是一个问题，因为时间将失去同步(因为两个重复的更新被排队)。</p><p id="f4b7" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">解决方案是将一个函数传递给<code class="fe mt mu mv mw b">this.setState</code> <a class="ae kv" href="https://reactjs.org/docs/state-and-lifecycle.html#state-updates-may-be-asynchronous" rel="noopener ugc nofollow" target="_blank">，如React文档</a>所示，或者(更好的解决方案)不依赖于之前的状态来获取当前状态。在<code class="fe mt mu mv mw b">setInterval</code>回调函数中，用最近的时间更新状态。</p><h1 id="76e4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">没有清理工作完成</h1><p id="206d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在一个类组件中，<code class="fe mt mu mv mw b">componentWillUnmount</code>方法可以使用类似于<code class="fe mt mu mv mw b">clearInterval(this.state.intervalId)</code>的东西来清理区间id。然而，一些实现忽略了这个重要的细节，这可能会导致复制实现的人的代码中出现内存泄漏。</p><h1 id="9626" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">我的生命周期方法是巨大的(“它不是钩子”)！</h1><p id="ae98" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果一个React组件变得很大(也许您继承了坏代码)，那么从<code class="fe mt mu mv mw b">setInterval</code>调用到<code class="fe mt mu mv mw b">clearInterval</code>调用以及从<code class="fe mt mu mv mw b">this.state</code>访问当前时间可能需要相当多的滚动。这违反了我的一条个人经验法则:</p><p id="16bc" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated"><strong class="lq ir">有关联的事物，应该是彼此接近的。</strong></p><p id="2d87" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">顺便说一下，这是React中切换到钩子的动机。</p><p id="8fad" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">我还没有找到一个钩子来消耗和更新当前时间。所以，请享受我的实现。</p><p id="fd9b" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">顺便说一句，这个“相关的事物应该彼此靠近”的经验法则是我个人最喜欢的法则之一的特例(如果完全采用，它会有生命/道德的含义):</p><p id="4eff" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated"><strong class="lq ir">让做正确的事情变得容易；让做错事变得困难。</strong></p><p id="ea72" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx mo lz ma mb mp md me mf mq mh mi mj ij bi translated">要了解这种哲学的更多内容，请查阅我的一篇早期文章(嘿，你已经读到这里了！):</p><div class="nl nm gp gr nn no"><a href="https://medium.com/@james.patrick.fulford/what-to-do-when-things-go-wrong-4eaec952d157" rel="noopener follow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">出问题时该怎么办</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">错误是自然而然的。改善不会。</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">medium.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc kp no"/></div></div></a></div></div></div>    
</body>
</html>