# 将 Stripe 与 Vue 客户端基础集成

> 原文：<https://javascript.plainenglish.io/integrating-with-stripe-client-basics-c9f188329143?source=collection_archive---------0----------------------->

## 使用条纹。JS & Elements 来创建一个简单的 Vue。用于捕获卡支付的 JS 组件。

![](img/1e2e24a02df173d254baa3868659f548.png)

TM [www.stripe.com](http://www.stripe.com/) The Stripe name and logos are trademarks of Stripe, Inc. or its affiliates in the U.S. and other countries.

*免责声明:本文与 Stripe 无关，也不由 Stripe 赞助。它独特地传达了我作为独立开发人员将 Stripe 服务集成到我的平台中的知识和经验。*

TL；博士:
+您的用例可能不需要 Stripe 元素，[首先检查](https://medium.com/@marcusthesmith/integrating-with-stripe-background-cf77c3a5a41#0820)
+如果您有 Java Script，您可以实现 Stripe，我只是更喜欢 Vue
+ Vue 基本上只是一个 JavaScript 库，检查他们的[文档](https://vuejs.org/v2/guide/)
+ Stripe 是一个安全的事务服务，所以它可能有点固执己见
+ Stripe 只需要一些方法和数据来运行
+如果您想了解细节，请阅读下面的**添加 Stripe**

# 介绍

{螺母和螺栓开始于 **Vue 设置**或**为 Vue 专家添加条纹**

如果你正在读这篇文章，我想你正在寻求将支付处理集成到你的网络应用中。但是在进一步深入之前，要确定什么样的客户端集成最适合您的需求；有几种不同的选择。你可以在我之前的文章中的这里查看它们。如果你决定你需要结帐，这篇文章的内容不会对你有很大帮助。如果你决定你需要元素，你就在正确的地方，你也可以在我的另一篇文章中看到如何集成服务器端。这可以在你实现客户端之前或者之后完成，没多大关系。

还要注意，我是用 [Vue 实现的。JS](https://vuejs.org/v2/guide/index.html) 框架。你可以用 JavaScript 和 HTML 的任意组合实现 Stripe 元素，但我个人喜欢 Vue 的干净。如果你不熟悉 Vue，或者担心你无法用当前的技术体系实现它:我向你保证，如果你能实现 Stripe，你也能实现 Vue。这不是一个 Vue 教程，我将使用 Vue 的具体设计，但我希望保持足够的基础，以便没有以前的知识的人仍然可以有效地实现 Vue 的条纹；我还是建议你去看看[的文件](https://vuejs.org/v2/guide/)。我在这里使用了最普通的 Vue 形式，但是很多最近的文档都围绕着 Vue 的 [SFC](https://vuejs.org/v2/guide/single-file-components.html) 实现，我个人的实现使用了这种更复杂的格式。

和往常一样，我在这里做的事情可能不是最佳实践，但可以简化解释。尽管说出你的任何担忧，但要认识到，我试图在保持内容全面的同时，避免内容过于深入。

# Vue 设置

如果你熟悉 Vue，这应该看起来很熟悉，你可能会继续**添加条纹**。如果不是，简单来说，Vue 只是一个 JavaScript 库，所以可以和任何网页一起使用(如果你说‘JS 禁用了就不行了’，Stripe.js 也不行……所以你大概要另找一个事务服务了)。最快的方法是将 CDN 引用包含到 html 模板中(注意:对于您的具体情况，这可能不是推荐的选择)。您完全可以将这些内容添加到现有的页面中，但是一个没有其他内容的干净的索引页面看起来应该是这样的:

除了 CDN 引用之外，您还会在那里看到一个 div 和另一个脚本包含。这就是如何将 Vue 添加到页面中的方法，在所需的位置包含一个 div，它充当“注入”自定义 Vue 实例的入口。这有点像你刚刚为 div 定义了一个非常复杂的类，它恰好是一个 Vue 实例。的。js 文件将定义您的 Vue 实例，div 将该实例与“app”类一起使用；我们定义如下:

简而言之，你给 Vue 框架一个 options 对象，然后它给出一个实例，这个实例被附加到任何带有“el”定义的 div 上(你可以看到它的命名就像你给 CSS 类命名一样:。app)。el 是你进入基本 HTML 模板的钩子。一旦定义好了，这个 Vue 实例中的所有东西都是自包含的(包括其他 Vue 组件),并将通过一个虚拟 DOM 注入到那个命名的 div 中。“app”div 内模板中的任何东西都可以与 Vue 实例交互。然而，我个人喜欢保持它为空，并将我自己的模板定义为 Vue 选项之一。我也喜欢让我的实例尽可能的干净，并在组件内部构建其他的东西。我的模板选项中名为“StripeVueCard”的元素就是其中之一。

在这一点上，我们可以在组件上工作，而不用考虑 web-app 中的任何其他内容，它将显示在我们注入“app”div 的位置。要了解更多关于 Vue 实例和组件的信息，请查看[指南](https://vuejs.org/v2/guide/components.html)。为了让您理解，您需要知道的是 Vue 将代码分成几部分，将所有必要的数据、方法和模板代码打包到单独的组件中。Vue 还提供了计算属性和大量灵活的数据绑定，以使代码尽可能简洁明了。要让 Stripe 元素在这个干净的框架中工作，请继续阅读。

# **添加条纹**

Stripe 是事务服务；这就要求他们采取有效措施来确保服务的气密性和安全性。这意味着几乎任何人都可以实现安全交易服务，但需要以一种非常特殊的方式进行定制收费。首先，你**必须**使用他们基于 URL 的库。您也只能接受客户托管的元素中的敏感财务信息。因此，我们必须把他们的元素放到我们的网站上，而不是自己收集数据。只有在创建了代表用户数据的令牌时才能收费，然后可以将令牌发送到我们的后端服务，用秘密访问密钥进行处理。安装在应用程序中的这些元素负责创建令牌，并在此过程中进行其他验证。这确实简化了事情，但是当您使用它们时，仍然需要知道一些细微的差别。

首先，确保你包括条纹。JS 库，只要你有你的 Vue。JS include(或者其他一些直观的位置)。它应该是这样的:

```
**<script src=”https://js.stripe.com/v3/"></script>**
```

一旦你有了你想要的应用程序，你就可以开始构建一个 Stripe 组件；我把我的叫做 StripeVueCard(上面你会看到它的骨架)。最简单地说，要处理 Stripe 事务，您只需要一些初始化代码、模板中的一些元素和一个 send 方法。我将在这里看一下最简单的情况，然后再看一些更广泛的实现。让我们从查看相关数据开始，作为一种对所有将被使用的东西有一个感觉的方法。

## 条纹卡数据:

*注意:对于组件，数据属性不是一个对象，而是提供一个返回对象的函数。这对于保持每个组件的数据对象独立很重要，否则它们会被捆绑在一起，互相干扰。在这种情况下，它可能不那么重要，但它是正确的设计。*
虽然不是所有都明确需要，这些是我用条纹元素创建电荷的基本变量。

**Stripe 可发布密钥(spk):**Stripe 交易首先需要的是你的可发布密钥。理想情况下，这应该在组件挂载时通过 API 调用来设置。您可以在您的 Stripe [仪表盘](https://dashboard.stripe.com/test/apikeys)中找到它，它将被格式化为“pk_live_xxxxx”或“pk_test_xxxxx”作为测试密钥。

**条带对象(stripe):** 在装载时初始化，条带对象实例的作用范围是此组件，它提供我们装载的条带元素，并创建要发送到后端的收费令牌。

**Card 对象(card):** 这是由 stripe 对象创建的，安装到我们模板中的容器 div 中，并在我们创建收费请求令牌时被引用。

**你的消息(msg):** 虽然不是特别必要，但是让你的用户阅读由变量管理的消息是很好的。

**收费金额(payAmount):** 在发送收费时，需要将其分解为一个整数(格式为 1000，价格为 10.00 美元)。

**提交禁用(lockSubmit):** 用于刚发送电荷时或数据无效时的去抖。

现在我们知道了数据是什么样子，让我们看看基本的模板。

## 条纹卡模板:

我在这里使用 [Bootstrap](https://getbootstrap.com/) 来给出一些简单的 CSS 样式，而不需要自己构建一堆样式。CDN 引用可以在这里[找到](https://getbootstrap.com/docs/4.3/getting-started/introduction/#css)与你的其他脚本引用放在一起。否则，就忽略课程内容。

所以，这里的关键部分是:
**提示用户的表头。**这很容易与使用[文本插值](https://vuejs.org/v2/guide/syntax.html#Text)传递给组件的动态值联系起来，如 h2 中的 msg 和 payAmount 引用所示。金额值还应直接与费用生成相关联。

**可安装的表单控件 div。这是我们将把 Stripe 元素装入的 div。它必须可以被我们的 JS 代码轻松访问(注意 ref="card "声明),并且应该像其他控件一样进行样式化，因为 Stripe 只能为挂载的部分管理一定级别的样式化。**

**提交按钮。**非常简单，需要有一个提交按钮供用户点击。您可以看到有一个“禁用”绑定，用于防止用户双击或发送错误数据。还有一个“v-on:click”指令，在阻止了默认动作(因此 Vue 拥有完全控制权)之后，调用我们的“purchase”方法。

当然，在这一点上，实际上没有将 Stripe 元素注入到模板中。为此，我们需要在安装组件时运行一个函数，创建 Stripe 元素并将其安装在引用 div 中。安装的代码应该如下所示:

## 条纹卡安装:

Mounted 被添加为您的 Vue 组件的属性之一，并将由 mount 上的 Vue [生命周期挂钩](https://vuejs.org/v2/guide/instance.html#Instance-Lifecycle-Hooks)运行。第一行不是必需的，但是提供一个作用域变量来与 Vue 组件交互是一个很好的实践，特别是当在方法的其他作用域中工作时。关键部分是:
**初始化一个条带实例。**这将需要您的可发布密钥，我只将它作为一个组件变量(spk)存储在这里，但建议您实际上从您的 Stripe 服务器中提取它。
**初始化卡片元素实例。**所有的动作都发生在这个物体上。您可以创建几个不同的元素，但是现在我们将从 card 元素开始，它将所有必要的交易数据都包含在一个元素中。
**挂载元素。**现在，Stripe card 元素可以将其自身安装到模板中的参考元素内。因为 ref 值被添加到元素中，所以 Vue 可以通过引用$refs 轻松地访问它。{refName}。这就是我们将元素传递给 mount 方法的方式。

初始化完所有内容后，组件应该呈现出准备好使用的 Stripe card 元素。现在剩下的就是设置一个方法来处理 submit 事件。

## 条纹卡方法:

客户端处理实际上归结为两件事，从挂载的 Stripe 元素中获取收费令牌(或者在出错时返回一个错误)，以及将令牌和收费金额及其他参数一起发送到后端来处理收费。让我们一步一步来。从购买方法(将由单击提交调用)开始，第一件事是锁定您的提交以充当反跳，这样用户就不能在交易通过之前尝试提交两次。要获取收费令牌，需要将元素对象传递给组件的 Stripe 实例 createToken 方法。如果您有多个元素(单独的卡、CVV 和到期)，那么只需要传入一个。该方法是异步的，返回一个[承诺](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises),然后您可以链接您的处理逻辑。如果方法返回一个错误，捕捉它并通过错误标签或用户警告传递它。否则调用您的事务处理方法。始终对异步承诺保持警惕，即使您只是简单地使用警告将错误传递给用户(不一定是最好的选择)。

如果成功，将令牌传递给您的事务处理方法。令牌将与至少以下内容一起添加到数据对象中:货币(参见选项[这里](https://stripe.com/docs/currencies))、描述(这将出现在它们的收据上)、金额(格式化为 100000 = $ 1000.00-我使用一个简单的方法从显示的货币中提取一个值)。然后，我从一个基本 API 路由(从配置传入)和特定端点构建我的路由。要进行 API 调用，只需在其他脚本中包含 [vue-resource](https://www.npmjs.com/package/vue-resource) :

```
<script **src**="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
```

考虑到您的路由和数据变量，这是一个非常简单的 post 调用:

```
self.$http.post(route,dt, {headers:{} })
```

post 方法也是异步的，需要承诺链。一旦您的服务器返回了响应，交易就被处理了，从技术上来说您就完成了。当然，您可能至少应该通知用户它成功了还是失败了。我还建议将收据返回给用户，它作为来自 Stripe API 的 URL 给出。这可以在下面的**“建议的改进”中看到。**

现在剩下的就是在服务器端处理收费请求了。你可以在我的[上一篇文章](https://medium.com/@marcusthesmith/integrating-with-stripe-server-basics-54a928a7c13b)中看到怎么做。然而，在使用条带集成时，我认为有几件事是值得了解的。

# 建议的改进

为了使本文简短(呃)，我决定将这些改进分成一篇单独的文章。如果您想更深入地了解健壮的客户端实现，请点击这里的。

## **其他陷阱:**

使用 Stripe 时，您还应该了解其他一些小事情。

**视口宽度:**视口宽度的元标签允许条带化，以确保在所有观看情况下与其元素保持一致。你可能已经设置好了，这是很常见的，但是如果不在你的模板标题中加入以下内容，Stripe 会在任何地方都显示出来:
`<meta *name*="viewport" *content*="width=device-width,initial-scale=1"/>`

**条纹品牌化:**确保您使用的条纹[品牌资产](https://stripe.com/newsroom/brand-assets)是正确的，并且符合他们的[使用协议](https://stripe.com/marks/legal)(如果是)。

**零值:** Stripe 没有很好地处理零值付款金额。请确保发送的金额为有效的非零值。

这应该是处理条带事务所需的全部内容。如果我错过了什么，请让我知道，我会更新它。谢谢你的阅读。

保持冷静&代码开启；
-马库斯