<html>
<head>
<title>How to Join Multiple Requests in JavaScript with Promise</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Promise连接JavaScript中的多个请求</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-promises-to-consolidate-responses-from-multiple-requests-a0742ab5399a?source=collection_archive---------4-----------------------#2020-05-21">https://javascript.plainenglish.io/use-promises-to-consolidate-responses-from-multiple-requests-a0742ab5399a?source=collection_archive---------4-----------------------#2020-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f7d6ec8b4f0cd6746c5fe30c19f3bdaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7syqgKhKvzxSuzrMzxR54g.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@ryanmfranco?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Ryan Franco</a> on <a class="ae kc" href="https://unsplash.com/s/photos/pinky-promise?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fbca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我回答了一个关于堆栈溢出的<a class="ae kc" href="https://stackoverflow.com/questions/61802839/javascript-how-to-pass-data-from-two-api-ajax-calls-to-one-function/61802951#61802951" rel="noopener ugc nofollow" target="_blank">问题</a>，这个问题涉及到一个用户试图发出两个请求，并将两个请求的响应传递给一个函数。我假设该函数将用于根据命名约定填充Highchart实例，但是目前用户只是试图记录来自响应的数据。</p><p id="d46f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是初始代码。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="ca2f" class="lk ll iq lg b gy lm ln l lo lp">function getStData() {<br/>  $.ajax({<br/>    type: "GET",<br/>    url: stUrl,<br/>    async: true,<br/>    success: function (stData) {<br/>      drawHighCharts(stData)<br/>    },<br/>    error: function (e) {<br/>      // handle exception<br/>      console.log("Error occured while reading resource file: ", e);<br/>    }<br/>  });<br/>}<br/><br/>function getOdData() {<br/>  $.ajax({<br/>    type: "GET",<br/>    url: odUrl,<br/>    async: true,<br/>    success: function (odData) {<br/>      drawHighCharts(odData)<br/>    },<br/>    error: function (e) {<br/>      // handle exception<br/>      console.log("Error occured while reading resource file: ", e);<br/>    }<br/>  });<br/>}<br/><br/>function drawHighCharts(stData, odData) {<br/>    console.log(stData, "st")<br/>    console.log(odData, "od")<br/>}</span></pre><p id="ecf1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用户遇到的问题是他们能够记录<code class="fe lq lr ls lg b">stData</code>，但是他们不能记录<code class="fe lq lr ls lg b">odData</code>。如果您查看ajax请求中的成功函数，您就会发现问题所在。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d6c8" class="lk ll iq lg b gy lm ln l lo lp">//From getStData<br/>success: function (stData) {<br/>   drawHighCharts(stData)<br/>}</span><span id="9046" class="lk ll iq lg b gy lt ln l lo lp">//From getOdData<br/>success: function(odData){<br/>   drawHighCharts(odData)<br/>}</span></pre><p id="5083" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么<code class="fe lq lr ls lg b">odData</code>是<code class="fe lq lr ls lg b">drawHighCharts</code>中的<code class="fe lq lr ls lg b">undefined</code>是有道理的，因为<code class="fe lq lr ls lg b">odData</code>参数是<strong class="kf ir">而不是</strong>被<code class="fe lq lr ls lg b">getStData</code>或<code class="fe lq lr ls lg b">getOdData</code>传递给函数。在这两种情况下，<code class="fe lq lr ls lg b">drawHighCharts</code>函数只能引用传递的第一个参数，因为没有传递第二个参数<strong class="kf ir">。</strong></p><p id="1e19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二次<code class="fe lq lr ls lg b">drawHighCharts</code>被调用<strong class="kf ir">实际上是</strong>被记录<code class="fe lq lr ls lg b">odData</code>，但是由于第一个参数被调用<code class="fe lq lr ls lg b">stData</code>，对于用户来说<code class="fe lq lr ls lg b">stData</code>似乎被记录了两次。为了解决这个问题，我们需要能够将两个请求的两个响应都传递给<code class="fe lq lr ls lg b">drawHighCharts</code>。</p><p id="c598" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是怎么做呢？有了<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">的承诺</a>就这样了！</p><blockquote class="lu"><p id="ec8b" class="lv lw iq bd lx ly lz ma mb mc md la dk translated"><code class="fe lq lr ls lg b">Promise</code>对象表示异步操作的最终完成(或失败)及其结果值— MDN网络文档</p></blockquote><p id="7f2e" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated"><code class="fe lq lr ls lg b">Promise</code>的工作原理是让异步方法(发出两个ajax请求)作为一个<code class="fe lq lr ls lg b">Promise</code>对象返回值，以便在将来的某个时候提供这些值。下图解构了<code class="fe lq lr ls lg b">Promise</code>在发出请求时的工作方式。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/70c0506bd7cf09a77932942df9f0ce11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ndx34wnMVmS6IJfBr0VxTw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Image from <a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">MDN Web Docs</a></figcaption></figure><p id="ac50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么这很有帮助？在这种情况下，我们需要发出<strong class="kf ir">两个</strong>请求，等待它们都完成，然后将<strong class="kf ir">两个响应</strong>传递给代码中其他地方的另一个函数(在这种情况下是<code class="fe lq lr ls lg b">drawHighCharts</code>)。因为我们不能保证两个请求的数据同时可用，所以我们可以使用承诺来存储数据，直到两个请求都完成。这可以通过使用<code class="fe lq lr ls lg b">Promise.all</code>来完成。</p><h2 id="f0bc" class="lk ll iq bd mk ml mm dn mn mo mp dp mq ko mr ms mt ks mu mv mw kw mx my mz na bi translated">Promise.all()</h2><p id="fc6c" class="pw-post-body-paragraph kd ke iq kf b kg nb ki kj kk nc km kn ko nd kq kr ks ne ku kv kw nf ky kz la ij bi translated">这个函数将把两个请求包装在它们自己的<code class="fe lq lr ls lg b">Promise</code>中，然后等待所有的<code class="fe lq lr ls lg b">Promises</code>都被解决，然后继续执行<code class="fe lq lr ls lg b">then</code>回调函数。对于这个回调函数我们可以通过，你猜对了，<code class="fe lq lr ls lg b">drawHighCharts</code>。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/b54b06dfd13fba9c61b83e294c5a3ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*wN0bUsFQLkgYEpxsebovkw.gif"/></div></figure><p id="26a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是修改后的<code class="fe lq lr ls lg b">getStData</code>和<code class="fe lq lr ls lg b">getOdData</code>的<code class="fe lq lr ls lg b">success</code>功能。因为我们将它们包装在<code class="fe lq lr ls lg b">Promises</code>中，所以我们不需要<code class="fe lq lr ls lg b">success</code>函数单独触发<code class="fe lq lr ls lg b">drawHighCharts</code>。相反，我们可以让他们返回他们的响应数据。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="98f0" class="lk ll iq lg b gy lm ln l lo lp">//getStData<strong class="lg ir"><br/></strong>success: (stData) =&gt; stData</span><span id="2514" class="lk ll iq lg b gy lt ln l lo lp">//getOdData<strong class="lg ir"><br/></strong>success: (odData) =&gt; odData</span></pre><p id="55e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们的<code class="fe lq lr ls lg b">success</code>函数已经被修改，让我们继续我们的<code class="fe lq lr ls lg b">Promise.all</code>函数。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="5266" class="lk ll iq lg b gy lm ln l lo lp">Promise.all([<br/>  getStData(),<br/>  getOdData(),<br/>]).then(([stData, odData]) =&gt; drawHighCharts(stData, odData))</span></pre><p id="d535" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过在<code class="fe lq lr ls lg b">Promise.all</code>中包装我们的请求函数，我们都可以在前进之前等待两个响应，我们可以捕获这些响应并立即将它们传递给我们的<code class="fe lq lr ls lg b">then</code>回调。通过将两个响应传递给我们的<code class="fe lq lr ls lg b">drawHighCharts</code>，用户现在可以记录两个参数的值。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="2733" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://matt-croak.medium.com/membership" rel="noopener"> <em class="no">在这里将你的免费媒体会员升级为付费会员</em> </a> <em class="no">，每月只需5美元，你就可以获得数千位作家的无限量无广告故事。这是一个附属链接，你的会员资格的一部分帮助我为我创造的内容获得奖励。谢谢大家！</em></p><h1 id="3c9b" class="np ll iq bd mk nq nr ns mn nt nu nv mq nw nx ny mt nz oa ob mw oc od oe mz of bi translated">参考</h1><div class="og oh gp gr oi oj"><a href="https://stackoverflow.com/questions/61802839/javascript-how-to-pass-data-from-two-api-ajax-calls-to-one-function/61802951#61802951" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">JavaScript——如何将数据从两个API ajax调用传递给一个函数</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">我正在尝试对第三方API端点进行两次单独的ajax调用，并在一个高图表上显示其数据…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">stackoverflow.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox jw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">承诺</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">Promise对象表示异步操作的最终完成(或失败),及其结果…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">developer.mozilla.org</p></div></div><div class="os l"><div class="oy l ou ov ow os ox jw oj"/></div></div></a></div><h1 id="4280" class="np ll iq bd mk nq nr ns mn nt nu nv mq nw nx ny mt nz oa ob mw oc od oe mz of bi translated">用简单英语写的便条</h1><p id="f54b" class="pw-post-body-paragraph kd ke iq kf b kg nb ki kj kk nc km kn ko nd kq kr ks ne ku kv kw nf ky kz la ij bi translated">你知道我们有四份出版物和一个YouTube频道吗？你可以在我们的主页<a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> plainenglish.io </strong> </a>找到所有这些内容——关注我们的出版物并<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">来表达你的爱吧！</strong></p></div></div>    
</body>
</html>