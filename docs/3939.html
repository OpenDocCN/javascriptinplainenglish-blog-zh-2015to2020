<html>
<head>
<title>Deploying Static Websites To AWS S3 + CloudFront + Route53 Using The TypeScript AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用类型脚本AWS CDK将静态网站部署到AWS S3 + CloudFront + Route53</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/deploying-static-websites-to-aws-s3-cloudfront-route53-using-the-typescript-aws-cdk-8ae66774d1b?source=collection_archive---------14-----------------------#2020-11-04">https://javascript.plainenglish.io/deploying-static-websites-to-aws-s3-cloudfront-route53-using-the-typescript-aws-cdk-8ae66774d1b?source=collection_archive---------14-----------------------#2020-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="io ip gp gr iq ir gh gi paragraph-image"><div class="ab gu cl is"><img src="../Images/e4c12b0c44f5b5033238f38c959f8f89.png" data-original-src="https://miro.medium.com/v2/0*AS5bSh_u8u36PlOF"/></div></figure><div class=""/><p id="ea15" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在今天的帖子中，我们将一步一步地将一个静态网站部署到一个S3桶，该桶将CloudFront设置为全球CDN。</p><p id="18ee" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这篇文章是用CDK AWS打字稿写的。</p><blockquote class="ks kt ku"><p id="92a9" class="ju jv kv jw b jx jy jz ka kb kc kd ke kw kg kh ki kx kk kl km ky ko kp kq kr ij bi translated">这个例子被用作一个NextJS 10网站的静态导出的部署。在这里可以找到关于如何做的博文<a class="ae kz" href="https://blog.dennisokeeffe.com/blog/2020-11-04-exporting-static-nextjs-10-websites/" rel="noopener ugc nofollow" target="_blank">。也就是说，这篇文章旨在推动任何HTML到S3使用静态网站。我只是使用NextJS内容来演示最终产品和完成它所需的步骤变化。</a></p></blockquote><h2 id="6d2c" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">入门指南</h2><p id="4344" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">我们需要建立一个新的npm项目并安装先决条件。我们还将创建一个<code class="fe ly lz ma mb b">stacks</code>目录来存放我们的S3堆栈，并对其进行更新以进行一些定制。</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h2 id="3ac9" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">更新cdk.json</h2><p id="54de" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">添加下面的这个<code class="fe ly lz ma mb b">cdk.json</code>文件:</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h2 id="ade2" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">设置上下文</h2><p id="bf0f" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">添加下面这个<code class="fe ly lz ma mb b">cdk.json</code>文件:</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="539e" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取帐户ID的指南可在<a class="ae kz" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html" rel="noopener ugc nofollow" target="_blank"> AWS网站</a>上找到，但是如果您熟悉AWS CLI，那么您可以使用以下内容。</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="78e1" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">确保将<code class="fe ly lz ma mb b">account</code>设置为返回数字的字符串。</p><p id="ef16" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有关上下文的更多信息，请参见<a class="ae kz" href="https://docs.aws.amazon.com/cdk/latest/guide/context.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>。</p><h2 id="c29f" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">更新TypeScript配置文件</h2><p id="b65c" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">在<code class="fe ly lz ma mb b">tsconfig.json</code>中，添加以下内容:</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="a99a" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是CDK将类型脚本配置编译为JavaScript的基本类型脚本配置。</p><h2 id="67e7" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">处理静态站点堆栈</h2><p id="7e16" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">打开<code class="fe ly lz ma mb b">stacks/s3-static-site-with-cloudfront/index.ts</code>并添加以下内容:</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="107a" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以上内容是从<a class="ae kz" href="https://github.com/aws-samples/aws-cdk-examples/blob/master/typescript/static-site/static-site.ts" rel="noopener ugc nofollow" target="_blank"> AWS CDK示例</a>调整而来的，目的是将内容转换为以堆栈形式运行，而不是以构造形式运行。</p><p id="f014" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了解释这里发生的事情:</p><ol class=""><li id="47d6" class="mi mj ix jw b jx jy kb kc kf mk kj ml kn mm kr mn mo mp mq bi translated">我们有一个接口<strong class="jw iy"> StaticSiteProps </strong>，它允许up传递一个参数对象<code class="fe ly lz ma mb b">domainName</code>和<code class="fe ly lz ma mb b">siteSubDomain</code>，这将允许我们演示一个例子。如果我将【dennisokeeffe.com】作为<strong class="jw iy">推送<code class="fe ly lz ma mb b">domainName</code>作为</strong>并将<code class="fe ly lz ma mb b">siteSubDomain</code>作为<strong class="jw iy">S3-CDK-deployment-example</strong>推送，那么你会期望该网站在<strong class="jw iy">s3-cdk-deployment-example.dennisokeeffe.com</strong>可用。这在类中被指定为变量<code class="fe ly lz ma mb b">siteDomain</code>。</li><li id="2bd7" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">创建ARN证书<code class="fe ly lz ma mb b">certificateArn</code>是为了让我们能够使用<code class="fe ly lz ma mb b">https</code>。</li><li id="093f" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">一个新的CloudFront发行版被创建并分配给<code class="fe ly lz ma mb b">distribution</code>。<code class="fe ly lz ma mb b">certificateArn</code>用于配置ACM证书引用，此处使用<code class="fe ly lz ma mb b">siteDomain</code>作为名称。</li><li id="7b3d" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">为我们的<code class="fe ly lz ma mb b">siteDomain</code>值创建了一个新的别名记录，并将目标设置为新的CloudFront发行版。</li><li id="60d1" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">最后，我们从一个源<code class="fe ly lz ma mb b">./site-contents</code>部署资产，该源期望您将代码源放在相对于stacks文件夹的那个文件夹中。在我们的例子中，这将<strong class="jw iy">不是我们想要的</strong>，并且该值将被改变。部署还会使CDN上的对象失效。这可能是也可能不是您想要的，取决于您的缓存破坏机制是如何工作的。如果您已经为您的<code class="fe ly lz ma mb b">index.html</code>文件准备了散列资产和<code class="fe ly lz ma mb b">no-cache</code>或<code class="fe ly lz ma mb b">max-age=0</code>(您应该这样做)，那么您可以关闭它。失效要花钱。</li></ol><p id="4d1f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的例子中，我将调整上面的代码来导入<code class="fe ly lz ma mb b">path</code>，并将<code class="fe ly lz ma mb b">s3deploy.Source.asset('./site-contents')</code>的值改为<code class="fe ly lz ma mb b">s3deploy.Source.asset(path.resolve(__dirname, '../../../next-10-static-export/out'))</code>(它指向我的带有静态HTML构建资产的输出目录)。这和我对应的博文<a class="ae kz" href="https://blog.dennisokeeffe.com/blog/2020-11-04-exporting-static-nextjs-10-websites/" rel="noopener ugc nofollow" target="_blank">直接导出NextJS 10静态网站</a>有关。请注意，您需要在顶部添加<code class="fe ly lz ma mb b">import path = require('path')</code>并安装<code class="fe ly lz ma mb b">@types/node</code>。</p><h2 id="af98" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">使用StaticSite堆栈</h2><p id="0bf7" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">回到<code class="fe ly lz ma mb b">index.ts</code>中的根目录，让我们导入堆栈并投入使用。</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="3322" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在上面的例子中，我们简单地导入堆栈，用<code class="fe ly lz ma mb b">cdk</code> API创建一个新的应用程序，然后将该应用程序传递给<code class="fe ly lz ma mb b">StaticSite</code>的新实例。</p><p id="84fc" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您还记得，<code class="fe ly lz ma mb b">StaticSite</code>的构造函数读为<code class="fe ly lz ma mb b">constructor(parent: Construct, name: string, props: StaticSiteProps)</code>，因此它需要三个参数。</p><ol class=""><li id="f2ca" class="mi mj ix jw b jx jy kb kc kf mk kj ml kn mm kr mn mo mp mq bi translated">CDK应用程序。</li><li id="bda6" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">堆栈的“名称”或标识符。</li><li id="b77b" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">坚持我们的<code class="fe ly lz ma mb b">StaticSiteProps</code>的道具，所以在我们的例子中，一个对象通过了<code class="fe ly lz ma mb b">domainName</code>和<code class="fe ly lz ma mb b">siteSubDomain</code>。</li></ol><h2 id="6c2e" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">更新package.json</h2><p id="84f7" class="pw-post-body-paragraph ju jv ix jw b jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ij bi translated">在部署之前，让我们为一些脚本调整<code class="fe ly lz ma mb b">package.json</code>来帮助部署。</p><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="03cf" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们准备好了。</p><h2 id="38db" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">部署我们的站点</h2><blockquote class="ks kt ku"><p id="7243" class="ju jv kv jw b jx jy jz ka kb kc kd ke kw kg kh ki kx kk kl km ky ko kp kq kr ij bi translated">注意:您<strong class="jw iy">必须</strong>准备好另一个项目中的静态文件夹，这样才能工作。如果你想了解我在这里做的事情，请参考我在NextJS 10的静态站点导出上的帖子。</p></blockquote><p id="29f7" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要部署我们的站点，我们需要将类型脚本转换成JavaScript，然后运行CDK synth并部署命令。</p><blockquote class="ks kt ku"><p id="f976" class="ju jv kv jw b jx jy jz ka kb kc kd ke kw kg kh ki kx kk kl km ky ko kp kq kr ij bi translated">注意:您需要确保您的AWS凭证被配置为能够工作。我个人用的是<a class="ae kz" href="https://github.com/99designs/aws-vault" rel="noopener ugc nofollow" target="_blank"> aws-vault </a>。</p></blockquote><figure class="mc md me mf gt ir"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="e415" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在部署开始之前，您需要接受生成的新资源模板。</p><p id="dc1b" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的例子中，我使用了我在<a class="ae kz" href="https://blog.dennisokeeffe.com/blog/2020-11-04-exporting-static-nextjs-10-websites/" rel="noopener ugc nofollow" target="_blank">导出静态NextJS 10网站</a>的文章中给出的NextJS静态站点示例</p><p id="601b" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以在https://nextjs-10-static-example.dennisokeeffe.com看到最终的现场部署。</p><figure class="mc md me mf gt ir gh gi paragraph-image"><div class="ab gu cl is"><img src="../Images/7e75cddf873440c0dbb21296d0962aec.png" data-original-src="https://miro.medium.com/v2/0*6TxTw1QbFN_fMXHo"/></div></figure><h2 id="92d5" class="la lb ix bd lc ld le dn lf lg lh dp li kf lj lk ll kj lm ln lo kn lp lq lr ls bi translated">资源</h2><ol class=""><li id="b089" class="mi mj ix jw b jx lt kb lu kf mw kj mx kn my kr mn mo mp mq bi translated"><a class="ae kz" href="https://github.com/aws-samples/aws-cdk-examples/blob/master/typescript/static-site/static-site.ts" rel="noopener ugc nofollow" target="_blank"> AWS CDK静态站点示例— GitHub </a></li><li id="84b6" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://blog.dennisokeeffe.com/blog/2020-11-04-exporting-static-nextjs-10-websites/" rel="noopener ugc nofollow" target="_blank">导出静态NextJS 10网站</a></li><li id="30f5" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://github.com/99designs/aws-vault" rel="noopener ugc nofollow" target="_blank"> AWS Vault — GitHub </a></li><li id="53bd" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/cdk/latest/guide/context.html" rel="noopener ugc nofollow" target="_blank"> AWS运行时上下文</a></li><li id="d4aa" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html" rel="noopener ugc nofollow" target="_blank">获取您的帐户ID </a></li><li id="98f1" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://nextjs-10-static-example.dennisokeeffe.com" rel="noopener ugc nofollow" target="_blank">决赛，现场网站部署</a></li><li id="c944" class="mi mj ix jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae kz" href="https://github.com/okeeffed/nextjs-10-static-deployment-with-typescript-aws-cdk" rel="noopener ugc nofollow" target="_blank">最终代码</a></li></ol><p id="06f2" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kv">图片来源:</em> <a class="ae kz" href="https://unsplash.com/@ignatkushanrev" rel="noopener ugc nofollow" target="_blank"> <em class="kv">伊格纳特·库山列夫</em> </a></p><p id="3e85" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kv">原贴于我的</em> <a class="ae kz" href="https://blog.dennisokeeffe.com/blog/2020-11-04-deploying-websites-to-aws-s3-with-the-cdk/" rel="noopener ugc nofollow" target="_blank"> <em class="kv">博客</em> </a> <em class="kv">。</em></p></div></div>    
</body>
</html>