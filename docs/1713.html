<html>
<head>
<title>Add Caching to Express Apollo Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向Express Apollo应用程序添加缓存</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/add-caching-to-express-apollo-apps-7f56d398978f?source=collection_archive---------5-----------------------#2020-04-16">https://javascript.plainenglish.io/add-caching-to-express-apollo-apps-7f56d398978f?source=collection_archive---------5-----------------------#2020-04-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/61e507bf3b86bda5a6ca7e57ef6c273d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rmnM5YmpYxqaLWhF"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@mrthetrain?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joshua Hoehne</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a574" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Apollo服务器作为节点包提供。我们可以用它来创建一个接受GraphQL请求的服务器。</p><p id="cc48" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何添加缓存来提高我们的应用程序的性能。</p><h1 id="3e7b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">定义缓存提示</h1><p id="dd15" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Apollo Server为我们提供了一种机制来控制各个类型和字段的缓存控制参数。</p><p id="df55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它可以用<code class="fe me mf mg mh b">@cacheControl</code>指令静态控制，也可以用<code class="fe me mf mg mh b">info.cacheControl.setCacheHint</code> API动态控制。</p><h1 id="9954" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在我们的模式中静态添加缓存提示</h1><p id="8927" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">@cacheControl</code>指令在模式中静态添加缓存提示，如下所示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="63c5" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql } = require('apollo-server-express');<br/>const books = [<br/>  {<br/>    title: 'JavaScript for Dummies',<br/>    author: 'Jane Smith',<br/>  },<br/>  {<br/>    title: 'JavaScript Book',<br/>    author: 'Michael Smith',<br/>  },<br/>];<br/>const typeDefs = gql`<br/>  type Book @cacheControl(maxAge: 240){<br/>    title: String<br/>    author: String<br/>  }<br/>  type Query {<br/>    books: [Book] @cacheControl(maxAge: 30)<br/>  }<br/>`;<br/>const resolvers = {<br/>  Query: {<br/>    books: () =&gt; books,<br/>  },<br/>};<br/>const app = express();<br/>const server = new ApolloServer({ typeDefs, resolvers });<br/>server.applyMiddleware({ app });<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="7fb2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们将带有<code class="fe me mf mg mh b">maxAge</code>参数的<code class="fe me mf mg mh b">cacheControl</code>指令传递给了类型<code class="fe me mf mg mh b">Book</code>和字段<code class="fe me mf mg mh b">books</code>。</p><p id="d4e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">类型提示适用于返回该类型对象的所有字段。</p><p id="740d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">缓存年龄以秒为单位。这意味着<code class="fe me mf mg mh b">Book</code>被缓存240秒，而<code class="fe me mf mg mh b">books</code>被缓存30秒。</p><h1 id="0b8a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在解析器中动态添加缓存提示</h1><p id="a399" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过编写以下代码在解析器中添加动态缓存提示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="aedb" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql } = require('apollo-server-express');<br/>const books = [<br/>  {<br/>    title: 'JavaScript for Dummies',<br/>    author: 'Jane Smith',<br/>  },<br/>  {<br/>    title: 'JavaScript Book',<br/>    author: 'Michael Smith',<br/>  },<br/>];<br/>const typeDefs = gql`<br/>  type Book @cacheControl(maxAge: 240){<br/>    title: String<br/>    author: String<br/>  }<br/>  type Query {<br/>    books: [Book] @cacheControl(maxAge: 30)<br/>  }<br/>`;<br/>const resolvers = {<br/>  Query: {<br/>    books: (parent, args, context, info) =&gt; {<br/>      info.cacheControl.setCacheHint({ maxAge: 60, scope: 'PRIVATE' });<br/>      return books;<br/>    },<br/>  },<br/>};<br/>const app = express();<br/>const server = new ApolloServer({ typeDefs, resolvers });<br/>server.applyMiddleware({ app });<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="6247" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们有<code class="fe me mf mg mh b">resolvers</code>的追随者值:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c35a" class="mq lc iq mh b gy mr ms l mt mu">const resolvers = {<br/>  Query: {<br/>    books: (parent, args, context, info) =&gt; {<br/>      info.cacheControl.setCacheHint({ maxAge: 60, scope: 'PRIVATE' });<br/>      return books;<br/>    },<br/>  },<br/>};</span></pre><p id="16de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过编写以下内容来设置缓存提示:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c4d6" class="mq lc iq mh b gy mr ms l mt mu">info.cacheControl.setCacheHint({ maxAge: 60, scope: 'PRIVATE' });</span></pre><p id="446b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将查询结果设置为缓存60秒。</p><h1 id="9a55" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置默认值<code class="fe me mf mg mh b">maxAge</code></h1><p id="901f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">此外，我们可以通过在传递给<code class="fe me mf mg mh b">ApolloServer</code>构造函数的对象中添加<code class="fe me mf mg mh b">cacheControl.defaultMaxAge</code>属性来设置缓存的默认<code class="fe me mf mg mh b">maxAge</code>。</p><p id="470b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7e30" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql } = require('apollo-server-express');<br/>const books = [<br/>  {<br/>    title: 'JavaScript for Dummies',<br/>    author: 'Jane Smith',<br/>  },<br/>  {<br/>    title: 'JavaScript Book',<br/>    author: 'Michael Smith',<br/>  },<br/>];<br/>const typeDefs = gql`<br/>  type Book @cacheControl(maxAge: 240){<br/>    title: String<br/>    author: String<br/>  }<br/>  type Query {<br/>    books: [Book] @cacheControl(maxAge: 30)<br/>  }<br/>`;<br/>const resolvers = {<br/>  Query: {<br/>    books: (parent, args, context, info) =&gt; {<br/>      info.cacheControl.setCacheHint({ maxAge: 60, scope: 'PRIVATE' });<br/>      return books;<br/>    },<br/>  },<br/>};<br/>const app = express();<br/>const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  cacheControl: {<br/>    defaultMaxAge: 5,<br/>  },<br/>});<br/>server.applyMiddleware({ app });<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="6b55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6fb9" class="mq lc iq mh b gy mr ms l mt mu">const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  cacheControl: {<br/>    defaultMaxAge: 5,<br/>  },<br/>});</span></pre><p id="46ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将缓存的默认<code class="fe me mf mg mh b">maxAge</code>设置为5秒。</p><p id="cb38" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">策略的<code class="fe me mf mg mh b">maxAge</code>是请求的所有字段中的最小值<code class="fe me mf mg mh b">maxAge</code>。</p><p id="e22f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有根字段和非标量字段的默认<code class="fe me mf mg mh b">maxAge</code>为0。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/6eaf72088dd3b3974478679fad779c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-wnQauyIEvywaqLn"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@mrthetrain?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joshua Hoehne</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="abb4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将完整响应保存到缓存中</h1><p id="55b6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">apollo-server-plugin-response-cache</code>插件将完整的响应保存到缓存中。</p><p id="83da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以如下使用它:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6aa7" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql } = require('apollo-server-express');<br/>const responseCachePlugin = require('apollo-server-plugin-response-cache');</span><span id="0285" class="mq lc iq mh b gy mw ms l mt mu">const books = [<br/>  {<br/>    title: 'JavaScript for Dummies',<br/>    author: 'Jane Smith',<br/>  },<br/>  {<br/>    title: 'JavaScript Book',<br/>    author: 'Michael Smith',<br/>  },<br/>];<br/>const typeDefs = gql`<br/>  type Book{<br/>    title: String<br/>    author: String<br/>  }<br/>  type Query {<br/>    books: [Book]<br/>  }<br/>`;<br/>const resolvers = {<br/>  Query: {<br/>    books: () =&gt; books<br/>  },<br/>};<br/>const app = express();<br/>const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  plugins: [responseCachePlugin()],<br/>});<br/>server.applyMiddleware({ app });<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="3638" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们要做的就是加上:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5492" class="mq lc iq mh b gy mr ms l mt mu">plugins: [responseCachePlugin()],</span></pre><p id="42ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将启用缓存。</p><p id="bd40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要为不同的用户分别缓存结果，我们可以编写以下代码:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a619" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const { ApolloServer, gql } = require('apollo-server-express');<br/>const responseCachePlugin = require('apollo-server-plugin-response-cache');</span><span id="185a" class="mq lc iq mh b gy mw ms l mt mu">const books = [<br/>  {<br/>    title: 'JavaScript for Dummies',<br/>    author: 'Jane Smith',<br/>  },<br/>  {<br/>    title: 'JavaScript Book',<br/>    author: 'Michael Smith',<br/>  },<br/>];<br/>const typeDefs = gql`<br/>  type Book @cacheControl(scope: PRIVATE){<br/>    title: String<br/>    author: String<br/>  }<br/>  type Query {<br/>    books: [Book]<br/>  }<br/>`;<br/>const resolvers = {<br/>  Query: {<br/>    books: () =&gt; books<br/>  },<br/>};<br/>const app = express();<br/>const server = new ApolloServer({<br/>  typeDefs, resolvers,<br/>  plugins: [responseCachePlugin({<br/>    sessionId: (requestContext) =&gt; (requestContext.request.http.headers.get('sessionid') || null),<br/>  })],<br/>});<br/>server.applyMiddleware({ app });<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="f110" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们添加了:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0608" class="mq lc iq mh b gy mr ms l mt mu">@cacheControl(scope: PRIVATE)</span></pre><p id="4876" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c429" class="mq lc iq mh b gy mr ms l mt mu">plugins: [responseCachePlugin({<br/>    sessionId: (requestContext) =&gt; (requestContext.request.http.headers.get('sessionid') || null),<br/>  })],</span></pre><p id="e91b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据<code class="fe me mf mg mh b">sessionid</code>为用户单独缓存<code class="fe me mf mg mh b">Book</code>。</p><h1 id="1468" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="026c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用各种方式缓存项目。</p><p id="eb94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在固定的时间内缓存类型和字段，我们可以使用<code class="fe me mf mg mh b">@cacheControl</code>指令。</p><p id="8f56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了在解析器中使用<code class="fe me mf mg mh b">info.cacheControl.setCacheHint</code>之外，我们还可以使用<code class="fe me mf mg mh b">responseCachePlugin</code>来缓存结果。</p><h2 id="a279" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="8c95" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们已经推出了三种新的出版物！请关注我们的新出版物:<a class="ae kc" href="https://medium.com/ai-in-plain-english" rel="noopener"> <strong class="kf ir"> AI in Plain English </strong> </a>，<a class="ae kc" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="kf ir">UX in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="kf ir">Python in Plain English</strong></a><strong class="kf ir"/>——谢谢，继续学习！</p><p id="4210" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也一直有兴趣帮助推广高质量的内容。如果您有一篇文章想要提交给我们的任何出版物，请发送电子邮件至<a class="ae kc" href="mailto:submissions@plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">submissions @ plain English . io</strong></a><strong class="kf ir"/>，使用您的Medium用户名，我们会将您添加为作者。另外，请让我们知道您想加入哪个/哪些出版物。</p></div></div>    
</body>
</html>