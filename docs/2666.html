<html>
<head>
<title>Node.js Tips —MongoDB Connections, Fetch, and Exports</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示—MongoDB连接、获取和导出</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-mongodb-connections-fetch-and-exports-4847e121a724?source=collection_archive---------6-----------------------#2020-07-13">https://javascript.plainenglish.io/node-js-tips-mongodb-connections-fetch-and-exports-4847e121a724?source=collection_archive---------6-----------------------#2020-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c014e609d0588fc74c32c2d54fc225a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xzb0E983OH244yIn"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@michaelwb?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Michael Browning</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a293" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="64a9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">从Fetch API返回的ReadableStream对象中检索数据</h1><p id="56d2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过调用转换函数将数据转换成我们想要的数据类型，从一个<code class="fe me mf mg mh b">ReadableStream</code>对象中检索数据。</p><p id="1666" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5059" class="mq lc iq mh b gy mr ms l mt mu">fetch('https://api.agify.io/?name=michael')<br/>  .then(response =&gt; response.json())<br/>  .then((data) =&gt; {<br/>    console.log(data);<br/>  });</span></pre><p id="2bb2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">response.json()</code>调用完成了到JSON的转换。</p><p id="b99d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以在下一次<code class="fe me mf mg mh b">then</code>回调中得到<code class="fe me mf mg mh b">data</code>。</p><h1 id="8a51" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Node.js中的文件之间共享变量</h1><p id="07ae" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过创建模块来共享变量。</p><p id="da56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="4d31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">module.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e133" class="mq lc iq mh b gy mr ms l mt mu">const name = "foo";<br/>exports.name = name;</span></pre><p id="f682" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1d2a" class="mq lc iq mh b gy mr ms l mt mu">const module = require('./module');<br/>const name = module.name;</span></pre><p id="8147" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过将<code class="fe me mf mg mh b">name</code>常量设置为<code class="fe me mf mg mh b">exports</code>的属性来导出它。</p><p id="1f5e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe me mf mg mh b">app.js</code>中的<code class="fe me mf mg mh b">require</code>导入。</p><p id="74c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以像使用其他财产一样使用它。</p><h1 id="c5db" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Node.js中使用fs和async / await</h1><p id="d4b2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们先将<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>转换成承诺，我们可以将它们与<code class="fe me mf mg mh b">fs</code>方法一起使用。</p><p id="bf92" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b1ef" class="mq lc iq mh b gy mr ms l mt mu">const fs = require('fs');<br/>const util = require('util');</span><span id="f7a8" class="mq lc iq mh b gy mv ms l mt mu">const readdir = util.promisify(fs.readdir);</span><span id="17e7" class="mq lc iq mh b gy mv ms l mt mu">const read = async () =&gt; {<br/>  try {<br/>    const names = await readdir('/foo/bar/dir');<br/>    console.log(names);<br/>  } catch (err) {<br/>    console.log(err);<br/>  }<br/>}</span></pre><p id="b47d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">util.promisify</code>将读取目录的<code class="fe me mf mg mh b">fs.readdir</code>方法转换成promise版本。</p><p id="2575" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以配合<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>使用。</p><h1 id="c80e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Mongoose和单个Node.js项目中的多个数据库</h1><p id="ffba" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在单个节点项目中连接到多个MongoDB数据库。</p><p id="48d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="b2b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">fooDbConnect.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3ab6" class="mq lc iq mh b gy mr ms l mt mu">const mongoose = require('mongoose');<br/>mongoose.connect('mongodb://localhost/foo');<br/>module.exports = exports = mongoose;</span></pre><p id="e1c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">bazDbConnect.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0812" class="mq lc iq mh b gy mr ms l mt mu">const mongoose = require('mongoose');<br/>mongoose.connect('mongodb://localhost/baz');<br/>module.exports = exports = mongoose;</span></pre><p id="9c17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用每个文件中的<code class="fe me mf mg mh b">connect</code>连接到不同的数据库，并导出连接。</p><p id="ddf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">db.js</code>中，我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b5db" class="mq lc iq mh b gy mr ms l mt mu">const mongoose = require("./<!-- -->fooDbConnect<!-- -->");</span></pre><p id="7ff7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">连接到<code class="fe me mf mg mh b">foo</code>数据库。</p><h1 id="c065" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将module.exports用作构造函数</h1><p id="8dc7" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">module.exports</code>导出一个构造函数。</p><p id="9d50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="20b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">person.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a6cf" class="mq lc iq mh b gy mr ms l mt mu">function Person(name) {<br/>  this.name= name;<br/>}</span><span id="1f8d" class="mq lc iq mh b gy mv ms l mt mu">Person.prototype.greet = function() {<br/>  console.log(this.name);<br/>};</span><span id="042d" class="mq lc iq mh b gy mv ms l mt mu">module.exports = Person;</span></pre><p id="14c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过编写以下内容来导入它:</p><p id="bb08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9a4f" class="mq lc iq mh b gy mr ms l mt mu">const Person = require("./<!-- -->person<!-- -->");<br/>const person = new Person("james");</span></pre><p id="99be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在<code class="fe me mf mg mh b">app.js</code>中导入<code class="fe me mf mg mh b">Person</code>构造函数，然后在最后一行调用它。</p><h1 id="7f49" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Node.js读取文本文件</h1><p id="2ab8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">fs.readFile</code>方法读取文本文件。</p><p id="9fe7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="dc91" class="mq lc iq mh b gy mr ms l mt mu">const fs = require('fs');<br/><br/>fs.readFile('./foo.txt', 'utf8', (err, data) =&gt; {<br/>  if (err) {<br/>    console.log(err);<br/>  }<br/>  console.log(data);<br/>});</span></pre><p id="0fe4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将文件路径作为第一个参数传入。</p><p id="9f3a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编码是第二个参数。</p><p id="0d0a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件读取操作完成时调用的回调是第三个参数。</p><p id="9351" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">data</code>有文件而<code class="fe me mf mg mh b">err</code>有错误对象则是遇到了错误。</p><h1 id="82bd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">跨节点模块重用到MongoDB的连接</h1><p id="4d82" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以导出MongoDB连接，以便在其他节点应用程序模块中使用它们。</p><p id="f209" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="f5c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">dbConnection.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6cbe" class="mq lc iq mh b gy mr ms l mt mu">const MongoClient = require( 'mongodb' ).MongoClient;<br/>const url = "mongodb://localhost:27017";</span><span id="c00f" class="mq lc iq mh b gy mv ms l mt mu">let _db;</span><span id="c7be" class="mq lc iq mh b gy mv ms l mt mu">module.exports = {<br/>  connect(callback) {<br/>    MongoClient.connect( url, { useNewUrlParser: true }, (err, client) =&gt; {<br/>      _db  = client.db('some_db');<br/>      return callback(err, client);<br/>    });<br/>  },<br/>  <br/>  getDb() {<br/>    return _db;<br/>  }<br/>};</span></pre><p id="f25e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了<code class="fe me mf mg mh b">connect</code>函数来连接MongoDB数据库。</p><p id="cca3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">连接对象被设置为一个变量。</p><p id="ee36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它需要一个回调函数，我们可以用它来得到错误。</p><p id="54bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们创建了<code class="fe me mf mg mh b">getDb</code>函数来获取MongoDB连接。</p><p id="7e73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过写来使用<code class="fe me mf mg mh b">connect.js</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4ab4" class="mq lc iq mh b gy mr ms l mt mu">const dbConnection = require('dbConnection');<br/><br/>dbConnection.connect((err, client) =&gt; {<br/>  if (err) {<br/>    console.log(err);<br/>  }<br/>} );</span></pre><p id="af7a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过导入之前创建的<code class="fe me mf mg mh b">dbConnection</code>模块连接到文件中的数据库。</p><p id="9e8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用我们想要的回调来调用<code class="fe me mf mg mh b">connect</code>。</p><p id="62de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">dbConnection.js</code>中的<code class="fe me mf mg mh b">err</code>和<code class="fe me mf mg mh b">client</code>调用它，所以这就是我们回调的参数。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/c41c6c9a09240e12d1b7df5e8f6745e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PIVmaqh5IJhUmJFU"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@imedianamibia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alan J. Hendry</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="1af3" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="9313" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">MongoDB连接可以在模块之间共享。</p><p id="1725" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在使用数据之前，我们必须将来自<code class="fe me mf mg mh b">fetch</code>函数的原始响应转换成我们想要的数据类型。</p><p id="331c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">fs</code>方法可以转化为承诺。</p><p id="9016" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">module.exports</code>导出构造函数。</p><h2 id="fe8b" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated">简单英语的JavaScript</h2><p id="e835" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅解码，我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>