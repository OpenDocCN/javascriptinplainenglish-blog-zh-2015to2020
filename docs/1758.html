<html>
<head>
<title>Querying SQL Server in Node.js Using Async/Await</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Async/Await在Node.js中查询SQL Server</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/querying-sql-server-in-node-js-using-async-await-5cb68acf2144?source=collection_archive---------1-----------------------#2020-04-20">https://javascript.plainenglish.io/querying-sql-server-in-node-js-using-async-await-5cb68acf2144?source=collection_archive---------1-----------------------#2020-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="d0d9" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">使用数据库</h2><div class=""/><div class=""><h2 id="e832" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">一种更简洁的数据库查询方式</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/21749f04906fb43e5bdb90c6ebff0569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*niqzkr1IOzfegXdB5FV1BQ.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Photo by <a class="ae le" href="https://unsplash.com/@sortino?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Joshua Sortino</a> on <a class="ae le" href="https://unsplash.com/s/photos/data-storage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ec8c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因为数据库操作(CRUD、创建、读取、更新、删除)需要时间来执行，所以它们需要JavaScript的异步功能。这可以通过回调、承诺或异步/等待来完成。</p><p id="679e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在本文中，我们将重点关注使用<strong class="lh ja"> async/await </strong>来查询(CRUD中的R)SQL Server数据库。</p><blockquote class="mb"><p id="b63f" class="mc md iq bd me mf mg mh mi mj mk ma dk translated">Async/await是一种处理承诺的特殊语法。</p></blockquote><h2 id="4bd4" class="ml mm iq bd mn mo mp dn mq mr ms dp mt lo mu mv mw ls mx my mz lw na nb nc iw bi translated">假设</h2><p id="a3da" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">在本文中，我将假设您已经可以访问SQL Server数据库，其中至少有一个您想要查询的表，或者可以构建我们将使用的表(脚本如下。)</p><p id="ae3d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果需要，</p><ul class=""><li id="f284" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated"><em class="nr">SQL Server</em><strong class="lh ja"><em class="nr">Express</em></strong><em class="nr">和</em> <strong class="lh ja"> <em class="nr">开发者</em> </strong> <em class="nr">版本免费！并且可以在这里下载</em><a class="ae le" href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads" rel="noopener ugc nofollow" target="_blank"><em class="nr"/></a><em class="nr">。</em></li><li id="af61" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated"><em class="nr"> SQL Server Management Studio、</em><strong class="lh ja"><em class="nr">SSMS</em></strong><em class="nr">，也是免费的！并且可以在这里下载</em><a class="ae le" href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"><em class="nr"/></a><em class="nr">。</em></li></ul><p id="0040" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我将使用Visual Studio代码(<strong class="lh ja"> VSCode </strong>)来编写这段代码</p><ul class=""><li id="be28" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">VSCode免费！并且可以在这里下载<a class="ae le" href="https://code.visualstudio.com/download" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><p id="9941" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您还需要安装node.js。</p><ul class=""><li id="5fe3" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">Node.js可以在这里<a class="ae le" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">下载。</a></li></ul><p id="4adc" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="nr">为了使本文简明扼要，我将不讨论如何安装和配置这些项目。这正是这篇文章所需要的。</em></p><h1 id="85bf" class="nx mm iq bd mn ny nz oa mq ob oc od mt kf oe kg mw ki of kj mz kl og km nc oh bi translated">设置</h1><h2 id="514b" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">我的SQL Server安装程序</h2><p id="e557" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">在您的SQL Server实例上，我们将构建<strong class="lh ja">公司</strong>数据库和<strong class="lh ja">雇员</strong>表。</p><ol class=""><li id="9855" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma on no np nq bi translated">使用SSMS或下面的脚本在您的实例上创建数据库<strong class="lh ja"> Company </strong>。</li></ol><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="43f0" class="ml mm iq op b gy ot ou l ov ow">USE [master]<br/>GO<br/><br/>/****** Object:  Database [Company]    Script Date: 4/20/2020 7:48:00 AM ******/<br/>CREATE DATABASE [Company]</span></pre><p id="02f1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">2.使用以下脚本创建<strong class="lh ja">雇员</strong>表。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="2dc6" class="ml mm iq op b gy ot ou l ov ow">USE [Company]<br/>GO<br/>SET ANSI_NULLS ON<br/>GO</span><span id="33bf" class="ml mm iq op b gy ox ou l ov ow">SET QUOTED_IDENTIFIER ON<br/>GO</span><span id="17bf" class="ml mm iq op b gy ox ou l ov ow">CREATE TABLE [dbo].[Employees](<br/> [EmpId] [char](6) NOT NULL,<br/> [FirstName] [varchar](50) NULL,<br/> [LastName] [varchar](50) NULL,<br/> [Title] [varchar](50) NULL,<br/> [HireDate] [datetime] NULL,<br/> [PerformanceRating] [int] NULL,<br/> [Phone] [char](10) NULL,<br/> [Manager] [char](6) NULL,<br/> CONSTRAINT [PK_Employees] PRIMARY KEY CLUSTERED <br/>(<br/> [EmpId] ASC<br/>)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]<br/>) ON [PRIMARY]<br/>GO</span><span id="d937" class="ml mm iq op b gy ox ou l ov ow">ALTER TABLE [dbo].[Employees] ADD  CONSTRAINT [DF_Employees_PerformanceRating]  DEFAULT ((0)) FOR [PerformanceRating]<br/>GO</span></pre><p id="02cc" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">3.您可以随意在表中输入任何数据，或者运行下面的脚本。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="12f7" class="ml mm iq op b gy ot ou l ov ow">USE [Company]<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000001', N'Fred', N'Jones', N'Lawyer', CAST(N'2019-01-01T00:00:00.000' AS DateTime), 4, N'8045551212', N'000005')<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000002', N'Jane', N'Jones', N'Lawyer', CAST(N'2018-02-01T00:00:00.000' AS DateTime), 4, N'4567653434', N'000005')<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000003', N'Jill', N'Hans', N'Paralegal', CAST(N'2018-03-01T00:00:00.000' AS DateTime), 3, N'4546667777', N'000006')<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000004', N'Frank', N'Brown', N'Clerk', CAST(N'2019-02-01T00:00:00.000' AS DateTime), 4, NULL, N'000006')<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000005', N'Jillian', N'Hill', N'Manager', CAST(N'2019-01-01T00:00:00.000' AS DateTime), 4, N'8886667777', NULL)<br/>GO<br/>INSERT [dbo].[Employees] ([EmpId], [FirstName], [LastName], [Title], [HireDate], [PerformanceRating], [Phone], [Manager]) VALUES (N'000006', N'Billy', N'Smith', N'Manager', CAST(N'2019-02-01T00:00:00.000' AS DateTime), 3, NULL, NULL)<br/>GO</span></pre><p id="2e2b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">雇员表应该如下所示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oy"><img src="../Images/553f524d4d771c089b5999da8b4e5437.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvUvJTxwahquMGKWW2CTdQ.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">SQL Server Instance, Database and Table</figcaption></figure></div><div class="ab cl oz pa hu pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="ij ik il im in"><h1 id="5bb1" class="nx mm iq bd mn ny pg oa mq ob ph od mt kf pi kg mw ki pj kj mz kl pk km nc oh bi translated">我们的目标</h1><p id="dfdc" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated"><em class="nr">我们的目标是检索绩效评分为4的员工的EmpId、FirstName、LastName和Title。</em></p><p id="8594" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">SQL查询</strong></p><p id="6bcf" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们将使用SQL Server Management Studio (SSMS)中显示的以下SQL Select查询。)</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/c9d4dc8bd38e1beb3cd2abaf4eda8e6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*xliOiI5G_OEE0RV5J3FBHg.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">The SQL Query</figcaption></figure></div><div class="ab cl oz pa hu pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="ij ik il im in"><h1 id="2bdf" class="nx mm iq bd mn ny pg oa mq ob ph od mt kf pi kg mw ki pj kj mz kl pk km nc oh bi translated">我们开始吧</h1><p id="0dbd" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated"><em class="nr">我会假设你已经设置好运行node.js。如果没有，</em> <a class="ae le" href="https://code.visualstudio.com/docs/nodejs/nodejs-tutorial" rel="noopener ugc nofollow" target="_blank"> <em class="nr">这里有一个很好的教程，可以帮助你使用VSCode进行设置。</em>T5】</a></p><ol class=""><li id="906b" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma on no np nq bi translated">创建一个您希望工作的<strong class="lh ja">文件夹</strong></li><li id="bab7" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma on no np nq bi translated">打开<strong class="lh ja"> VSCode </strong>，从<strong class="lh ja">文件</strong>菜单打开该文件夹。</li><li id="3498" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma on no np nq bi translated">进入<strong class="lh ja">终端菜单</strong>并选择<strong class="lh ja">新终端。</strong></li></ol><p id="3c0d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">4.要创建默认的<strong class="lh ja"> package.json </strong>并将<strong class="lh ja"> index.js </strong>设置为默认的启动文件，请在终端窗口中键入以下内容。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="0b7c" class="ml mm iq op b gy ot ou l ov ow">npm init -y</span></pre><p id="f7fe" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">5.为了使用SQL Server，我们需要安装mssql 驱动程序。这些将存储在node_modules文件夹中。在终端窗口类型中，</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="ef80" class="ml mm iq op b gy ot ou l ov ow">npm install mssql</span></pre><h1 id="f1c1" class="nx mm iq bd mn ny nz oa mq ob oc od mt kf oe kg mw ki of kj mz kl og km nc oh bi translated">我们的准则和结果</h1><p id="7500" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">由于我们的package.json使用<em class="nr"> index.js </em>作为主文件，<strong class="lh ja">创建一个名为index.js </strong>的文件。</p><p id="9d42" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">首先，我们将<em class="nr">导入mssql驱动程序</em>，并设置连接到SQL Server实例和数据库所需的配置。我的配置如下。根据您的环境进行调整。将它放在index.js的顶部</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="b270" class="ml mm iq op b gy ot ou l ov ow">const sql = require('mssql');</span><span id="84a1" class="ml mm iq op b gy ox ou l ov ow">const config = { <br/>        user: 'your user', <br/>        password: 'your password', <br/>        server: 'LENOVOLAPTOPW10\\MSSQLSERVER01', <br/>        database: 'Company',<br/>port: 1433 };<br/></span></pre><h2 id="5646" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">关于异步/等待</h2><ul class=""><li id="398c" class="ni nj iq lh b li nd ll ne lo pm ls pn lw po ma nn no np nq bi translated">函数前的单词<strong class="lh ja"> async </strong>表示函数总是返回一个承诺。</li><li id="4e9f" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated"><strong class="lh ja"> await </strong>关键字在异步函数中只对<strong class="lh ja">起作用，并让JavaScript一直等到承诺被解析并返回结果。</strong></li></ul><p id="efa9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">接下来让我们创建我们的异步函数。它现在是空的。我们将把期望的性能作为参数传递给这个函数。</p><p id="92d8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">把它放在你的配置代码下面。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="f3b7" class="ml mm iq op b gy ot ou l ov ow">async function queryDb (queryParm) {<br/>   // We will connect to SQL Server<br/>   // Query the database<br/>   // Return an Array of data</span><span id="5bde" class="ml mm iq op b gy ox ou l ov ow">}</span></pre><p id="5968" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如前所述，一个异步函数，在本例中为queryDb，将返回一个承诺。因此我们可以使用<strong class="lh ja">。然后</strong>()一旦承诺被下定决心，就用结果去工作。</p><p id="3757" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在异步函数下面键入以下内容。稍后我们将添加一个. catch()。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="9bd5" class="ml mm iq op b gy ot ou l ov ow">queryDb(rating)<br/>.then(result=&gt;{<br/>   // Work with the result here<br/>   <br/>})</span></pre><p id="96c1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">函数调用<strong class="lh ja"> queryDb(rating) </strong>将调用<em class="nr">异步函数</em><strong class="lh ja">query db(query parm)</strong>，传递一个PerformanceRating，rating。承诺一旦解决，结果就会返回。我们可以用<strong class="lh ja">。然后</strong>()接受结果并处理它。</p><p id="6a96" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">接下来，在异步函数之上，让我们建立几个变量。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="ef13" class="ml mm iq op b gy ot ou l ov ow">let employees=[];<br/>let rating=4;</span></pre><p id="9344" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">雇员</strong>数组将存储查询返回的记录。变量<strong class="lh ja">评级</strong>是我们正在寻找的绩效评级。</p><h2 id="7703" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">目前为止的代码</h2><p id="65a3" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">至此，您的代码应该如下所示:</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="4b80" class="ml mm iq op b gy ot ou l ov ow">const sql = require('mssql');<br/>const config = { <br/>        user: 'your user', <br/>        password: 'your password', <br/>        server: 'LENOVOLAPTOPW10\\MSSQLSERVER01', <br/>        database: 'Company',<br/>port: 1433 };</span><span id="d0c4" class="ml mm iq op b gy ox ou l ov ow">let employees=[];<br/>let rating=4;</span><span id="7b3a" class="ml mm iq op b gy ox ou l ov ow">async function queryDb (queryParm) {<br/>   <br/> }</span><span id="8e41" class="ml mm iq op b gy ox ou l ov ow">queryDb(rating)<br/>.then(result=&gt;{</span><span id="b4cc" class="ml mm iq op b gy ox ou l ov ow">});</span></pre><h2 id="13a6" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">建立连接和查询</h2><p id="c6c4" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">我们现在准备好了，</p><ul class=""><li id="5d1a" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">建立一个连接池。</li><li id="e1c0" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">使用池请求运行查询。</li><li id="8f27" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">处理返回的数据。</li></ul><p id="21d2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">下面是完整的代码。</p><ul class=""><li id="9a99" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">代码已添加到异步函数queryDB()中。</li><li id="a618" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">答。catch()已添加到queryDB()调用中</li></ul><p id="b562" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">运行完代码后，我们将讨论它。</p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="5172" class="ml mm iq op b gy ot ou l ov ow">const sql = require('mssql');<br/>const config = { <br/>        user: 'your user', <br/>        password: 'your password', <br/>        server: 'LENOVOLAPTOPW10\\MSSQLSERVER01', <br/>        database: 'Company',<br/>port: 1433 };</span><span id="d5b9" class="ml mm iq op b gy ox ou l ov ow">let employees=[];<br/>let rating=4;</span><span id="5f77" class="ml mm iq op b gy ox ou l ov ow">async function queryDb (queryParm) {<br/>  <br/>        let pool = <strong class="op ja">await </strong>sql.connect(config);<br/>        let data = <strong class="op ja">await </strong>pool.request()<br/>            .input('pr', sql.Int, queryParm)<br/>            .query("Select FirstName,LastName, Title from Employees   where PerformanceRating=@pr");</span><span id="fdd0" class="ml mm iq op b gy ox ou l ov ow">           // Store each record in an array<br/>           for (let i=0;i&lt;<strong class="op ja">data</strong>.<strong class="op ja">rowsAffected</strong>;i++){<br/>                employees.push(<strong class="op ja">data</strong>.<strong class="op ja">recordset</strong>[i]);<br/>           }</span><span id="ad57" class="ml mm iq op b gy ox ou l ov ow">     pool.close;<br/>     sql.close;</span><span id="c95d" class="ml mm iq op b gy ox ou l ov ow">   return employees;</span><span id="3c52" class="ml mm iq op b gy ox ou l ov ow">}</span><span id="1987" class="ml mm iq op b gy ox ou l ov ow">// async function invocation<br/>queryDb(rating)<br/> .then(result=&gt;{</span><span id="3e71" class="ml mm iq op b gy ox ou l ov ow">result.forEach(item=&gt;{<br/>            console.log(item);<br/>        });</span><span id="2477" class="ml mm iq op b gy ox ou l ov ow">})<br/> .catch(err=&gt;{<br/>     pool.close;<br/>     sql.close;<br/>     console.log(err)<br/> })</span></pre><h2 id="0060" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">运行代码</h2><p id="f20d" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">使用<strong class="lh ja"> F5 </strong>或<strong class="lh ja"> CTRL+F5 </strong>运行代码。你应该得到一个对象数组。</p><p id="bc66" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">维奥拉！数据</strong></p><pre class="kp kq kr ks gt oo op oq or aw os bi"><span id="18f4" class="ml mm iq op b gy ot ou l ov ow">{ FirstName: 'Fred', LastName: 'Jones', Title: 'Lawyer' }<br/>{ FirstName: 'Jane', LastName: 'Jones', Title: 'Lawyer' }<br/>{ FirstName: 'Frank', LastName: 'Brown', Title: 'Clerk' }<br/>{ FirstName: 'Jillian', LastName: 'Hill', Title: 'Manager' }</span></pre><h2 id="928a" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">说明</h2><p id="a696" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated"><strong class="lh ja">开始使用</strong></p><ul class=""><li id="c3cd" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">我们导入了SQL Server驱动程序。</li><li id="854d" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">建立了连接到实例和数据库所需的配置。</li><li id="87fe" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">我们调用了异步函数queryDB，传递了等级4。</li></ul><p id="d7e6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">异步查询数据库函数内部</strong></p><ul class=""><li id="8f45" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">我们建立了一个<strong class="lh ja">连接池</strong>，向其传递建立连接所需的<strong class="lh ja">配置</strong>信息。我们在执行查询之前等待连接。</li><li id="d446" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">我们创建了一个事务<strong class="lh ja">请求</strong>，将评级存储在名为“pr”的输入参数中，并指定查询SQL。我们一直等待，直到请求将记录返回给变量<strong class="lh ja">数据</strong>。</li><li id="3d9b" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">然后，我们访问<strong class="lh ja">数据</strong>变量的<strong class="lh ja">行和<strong class="lh ja">记录集</strong>以将每个记录集对象推入一个数组。</strong></li><li id="5854" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">最后，我们关闭了连接并将数组employees返回给queryDB调用，解析了承诺。</li></ul><p id="cd7b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja">在queryDB调用内部</strong></p><ul class=""><li id="91fe" class="ni nj iq lh b li lj ll lm lo nk ls nl lw nm ma nn no np nq bi translated">我们用<strong class="lh ja">。然后</strong>()访问async queryDB函数返回的数据。这是一个数组，存储在的<strong class="lh ja">结果</strong>参数中。然后()。</li><li id="7a73" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated">然后我们输出数组的内容。当然，这就是我们可能想要对数据做更多事情的地方。</li></ul><h2 id="27ce" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">就是这样！</h2><h1 id="da14" class="nx mm iq bd mn ny nz oa mq ob oc od mt kf oe kg mw ki of kj mz kl og km nc oh bi translated">结论</h1><p id="8e7b" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">我们学习了如何查询SQL Server数据库，并了解了一些关于async/await的知识。</p><p id="8793" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">正如我们所看到的，使用async/await为我们提供了一种非常干净的处理异步操作的方式，在我们的例子中是数据库事务。</p><p id="6727" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们能做得更多吗？当然可以。</p><p id="caac" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ja"> <em class="nr">我鼓励你对这个例子进行实验和扩展</em> </strong></p><h2 id="bf57" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">感谢您花时间阅读和编写代码！</h2><p id="9c9a" class="pw-post-body-paragraph lf lg iq lh b li nd ka lk ll ne kd ln lo nf lq lr ls ng lu lv lw nh ly lz ma ij bi translated">如果你有任何问题或疑问，请回复。我的目标是你的成功。</p><p id="c96b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">想看就看，加入Medium帮我继续写作。</p><div class="pp pq gp gr pr ps"><a href="https://bobtomlin-70659.medium.com/membership" rel="noopener follow" target="_blank"><div class="pt ab fo"><div class="pu ab pv cl cj pw"><h2 class="bd ja gy z fp px fr fs py fu fw iz bi translated">通过我的推荐链接加入灵媒——重力井(罗伯·汤姆林)</h2><div class="pz l"><h3 class="bd b gy z fp px fr fs py fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="qa l"><p class="bd b dl z fp px fr fs py fu fw dk translated">bobtomlin-70659.medium.com</p></div></div><div class="qb l"><div class="qc l qd qe qf qb qg ky ps"/></div></div></a></div><h2 id="fa89" class="ml mm iq bd mn mo oi dn mq mr oj dp mt lo ok mv mw ls ol my mz lw om nb nc iw bi translated">额外资源</h2><ul class=""><li id="32f6" class="ni nj iq lh b li nd ll ne lo pm ls pn lw po ma nn no np nq bi translated"><a class="ae le" href="https://javascript.info/async-await" rel="noopener ugc nofollow" target="_blank">异步/等待</a></li><li id="7885" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated"><a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">承诺</a></li><li id="23e4" class="ni nj iq lh b li ns ll nt lo nu ls nv lw nw ma nn no np nq bi translated"><a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises" rel="noopener ugc nofollow" target="_blank">履行承诺</a></li></ul></div></div>    
</body>
</html>