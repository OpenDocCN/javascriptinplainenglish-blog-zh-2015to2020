<html>
<head>
<title>Simple OAuth 2.0 Implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简单的OAuth 2.0实现</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/simple-oauth-2-0-implementation-4bc4fd6f614e?source=collection_archive---------8-----------------------#2020-08-16">https://javascript.plainenglish.io/simple-oauth-2-0-implementation-4bc4fd6f614e?source=collection_archive---------8-----------------------#2020-08-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="0b5a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">OAuth是一个开放的授权协议，允许Twitter、GitHub或其他Web平台上的消费者应用程序访问资源所有者的资源。IETF OAuth工作组在2012年开发了OAuth 2.0。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bdc94cf256b9de59d380135c90eb7ac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jaap8LgpxyiHJkMM.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Overview of OAuth 2.0 Process</figcaption></figure><p id="8e17" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">OAuth 2.0关注产品开发人员的可用性，为web应用程序、桌面应用程序、移动电话和客厅中的设备提供独特的授权流程。</p><p id="f56d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">OAuth 2.0框架为不同的用例定义了几种授权类型，以及创建新授权类型的框架。在OAuth 2.0中，术语“授权类型”指的是应用程序获取访问令牌的方式。</p><p id="111e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">OAuth 2.0的基本授权类型如下:</p><ul class=""><li id="a7f8" class="ky kz in jm b jn jo jr js jv la jz lb kd lc kh ld le lf lg bi translated">授权代码</li><li id="9ddc" class="ky kz in jm b jn lh jr li jv lj jz lk kd ll kh ld le lf lg bi translated">密码</li><li id="ed32" class="ky kz in jm b jn lh jr li jv lj jz lk kd ll kh ld le lf lg bi translated">客户端凭据</li><li id="7750" class="ky kz in jm b jn lh jr li jv lj jz lk kd ll kh ld le lf lg bi translated">刷新令牌</li></ul><h1 id="32e2" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><strong class="ak">表格结构</strong></h1><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="eabb" class="mp ln in ml b gy mq mr l ms mt"><strong class="ml io">users</strong></span><span id="58b2" class="mp ln in ml b gy mu mr l ms mt">| Column                  | Data Type<br/>|----------               |-------------<br/>| id                      | int<br/>| name                    | string<br/>| username                | string<br/>| password                | string</span><span id="cd10" class="mp ln in ml b gy mu mr l ms mt"><strong class="ml io">client</strong></span><span id="8e94" class="mp ln in ml b gy mu mr l ms mt">| Column                  | Data Type<br/>|----------               |-------------<br/>| id                      | int<br/>| client_id               | string<br/>| client_secret           | string<br/>| name                    | string<br/>| home_page_url           | string<br/>| logo_url                | string<br/>| privacy_policy_url      | string<br/>| user_id                 | string<br/>| is_live                 | bool<br/>| redirect_uri            | []string</span><span id="2ad2" class="mp ln in ml b gy mu mr l ms mt"><strong class="ml io">client_access_tokens</strong></span><span id="1672" class="mp ln in ml b gy mu mr l ms mt">| Column                  | Data Type<br/>|----------               |-------------<br/>| id                      | int<br/>| client_id               | int<br/>| user_id                 | int<br/>| client_refresh_token_id | int<br/>| access_token            | string<br/>| grant_type              | string<br/>| scope                   | string<br/>| audience                | string<br/>| expired_at              | datetime<br/></span><span id="1d01" class="mp ln in ml b gy mu mr l ms mt"><strong class="ml io">client_refresh_tokens</strong></span><span id="3480" class="mp ln in ml b gy mu mr l ms mt">| Column                  | Data Type<br/>|----------               |-------------<br/>| id                      | int<br/>| client_id               | int<br/>| user_id                 | int<br/>| refresh_token           | string<br/>| grant_type              | string<br/>| scope                   | string<br/>| audience                | string<br/>| expired_at              | datetime<br/></span><span id="caf0" class="mp ln in ml b gy mu mr l ms mt"><strong class="ml io">client_authorization_codes</strong></span><span id="07a0" class="mp ln in ml b gy mu mr l ms mt">| Column                  | Data Type<br/>|----------               |-------------<br/>| id                      | int<br/>| client_id               | int<br/>| user_id                 | int<br/>| code                    | string<br/>| scope                   | []string<br/>| is_used                 | bool<br/>| redirect_uri            | string<br/>| expired_at              | datetime</span></pre><h1 id="0887" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">客户端凭据授予</h1><p id="bb65" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">对于这个请求，客户端需要验证自己。通常，该服务将允许接受HTTP基本auth报头中的客户端ID和秘密。</p><p id="b0a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">请求</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="f00e" class="mp ln in ml b gy mq mr l ms mt">POST /oauth/token<br/>Host: authorization-server.com<br/><br/>// header<br/>Authorization: Basic base64_encode(client_id:client_secret) // required<br/><br/>// body<br/>{<br/>  grant_type: "client_credentials", // required<br/>  scope: "get_user_profile" // optional, but if not passed will give full access of the client user<br/>}</span></pre><p id="5cc4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">回应</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="7a2d" class="mp ln in ml b gy mq mr l ms mt">// body<br/>{<br/>   tokenType: "Bearer",<br/>   expiresIn: 3600,<br/>   accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c",<br/>   refreshToken: "eqweasdasdanvbSifkLImUAtuXITjxKMzkXjZvKGGIcLyFqHIDrVNexjHwXBNRhgicutwNStdasdasdLmMjfggjHrYvzWaIANmUvNOoDtNIOKOFywqedsa",<br/>   scope: "get_user_profile"<br/>}</span></pre><h1 id="cb24" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">密码授权</h1><p id="2f7a" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">如果客户端获得了一个密码，那么客户端必须验证这个请求。通常，该服务将允许接受HTTP基本auth报头中的客户端ID和秘密。</p><p id="25f0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">请求</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="1552" class="mp ln in ml b gy mq mr l ms mt">POST /oauth/token<br/>Host: authorization-server.com<br/><br/>// header<br/>Authorization: Basic base64_encode(client_id:client_secret) // optional<br/><br/>// body<br/>{<br/>  grant_type: "password", // required<br/>  username: "yussuf", // required<br/>  password: "123456" // required<br/>  scope: "get_user_profile" // optional, but if not passed will give full access of the user<br/>}</span></pre><p id="247e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">回应</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="735f" class="mp ln in ml b gy mq mr l ms mt">// body<br/>{<br/>   tokenType: "Bearer",<br/>   expiresIn: 3600,<br/>   accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c",<br/>   refreshToken: "eqweasdasdanvbSifkLImUAtuXITjxKMzkXjZvKGGIcLyFqHIDrVNexjHwXBNRhgicutwNStdasdasdLmMjfggjHrYvzWaIANmUvNOoDtNIOKOFywqedsa",<br/>   scope: "get_user_profile"<br/>}</span></pre><h1 id="9cce" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">授权码授予</h1><p id="92ec" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">授权码是一个临时码，客户端将使用它来交换访问令牌。代码本身是从授权服务器获得的，用户有机会看到客户端请求的信息，并批准或拒绝请求。</p><p id="afbd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">web流的第一步是向用户请求授权。这是通过为用户创建一个授权请求链接来实现的。</p><p id="23b6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">授权URL通常采用如下格式:</p><blockquote class="na nb nc"><p id="45fc" class="jk jl nd jm b jn jo jp jq jr js jt ju ne jw jx jy nf ka kb kc ng ke kf kg kh ig bi translated">https://authorization-server.com/oauth/authorize?client _ id = abcdefgh &amp; response _ type = code &amp; state = testing &amp; redirect _ uri = https % 3A % 2F % 2f testing . com % 0A &amp; scope = get _ user _ profile</p></blockquote><p id="317e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在用户批准后，它应该以这种格式重定向，生成的代码只在一次与服务器交换以获得访问令牌时有效:</p><blockquote class="na nb nc"><p id="3187" class="jk jl nd jm b jn jo jp jq jr js jt ju ne jw jx jy nf ka kb kc ng ke kf kg kh ig bi translated">https://testing.com？代码= abc123 &amp;状态=测试</p></blockquote><p id="bdb8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">请求</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="02f4" class="mp ln in ml b gy mq mr l ms mt">POST /oauth/token<br/>Host: authorization-server.com<br/><br/>// header<br/>Authorization: Basic base64_encode(client_id:client_secret) // required<br/><br/>// body<br/>{<br/>  grant_type: "authorization_code", // required<br/>  code: "abc123", // required get from the redirect url code query string<br/>  redirect_uri: "https://testing.com" // required<br/>}</span></pre><p id="b645" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">响应</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="23f2" class="mp ln in ml b gy mq mr l ms mt">// body<br/>{<br/>   tokenType: "Bearer",<br/>   expiresIn: 3600,<br/>   accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c",<br/>   refreshToken: "eqweasdasdanvbSifkLImUAtuXITjxKMzkXjZvKGGIcLyFqHIDrVNexjHwXBNRhgicutwNStdasdasdLmMjfggjHrYvzWaIANmUvNOoDtNIOKOFywqedsa",<br/>   scope: "get_user_profile"<br/>}</span></pre><h1 id="05c7" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">刷新令牌授权</h1><p id="150b" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">如果客户端获得了一个密码，那么客户端必须验证这个请求。通常，该服务将允许接受HTTP基本auth报头中的客户端ID和秘密。</p><p id="c7ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该刷新令牌端点用于通过获取新的访问令牌来更新访问令牌。此端点对于授权代码授权非常重要，授权代码授权需要用户交互才能获得新的访问令牌，此授权将帮助您通过使用用户首次批准应用程序请求时获得的刷新令牌来跳过用户交互。</p><p id="5c31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">请求</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="c076" class="mp ln in ml b gy mq mr l ms mt">POST /oauth/token<br/>Host: authorization-server.com<br/><br/>// header<br/>Authorization: Basic base64_encode(client_id:client_secret) // optional<br/><br/>// body<br/>{<br/>  grant_type: "refresh_token", // required<br/>  refresh_token: "eqweasdasdanvbSifkLImUAtuXITjxKMzkXjZvKGGIcLyFqHIDrVNexjHwXBNRhgicutwNStdasdasdLmMjfggjHrYvzWaIANmUvNOoDtNIOKOFywqedsa", // required<br/>  scope: "get_user_profile" // optional, the requested scope must not include additional scopes that were not issued in the original access token, can omit some scope from the original access token.<br/>}</span></pre><p id="d4cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">响应</strong></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="c16e" class="mp ln in ml b gy mq mr l ms mt">// body<br/>{<br/>   tokenType: "Bearer",<br/>   expiresIn: 3600,<br/>   accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5cnewtoken",<br/>   refreshToken: "eqweasdasdanvbSifkLImUAtuXITjxKMzkXjZvKGGIcLyFqHIDrVNexjHwXBNRhgicutwNStdasdasdLmMjfggjHrYvzWaIANmUvNOoDtNIOKOFywqedsanewrefreshtoken",<br/>   scope: "get_user_profile"<br/>}</span></pre><h1 id="7643" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">结论</h1><p id="b2b5" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">每个公司对于自己的OAuth标准都有不同的实现，但是本文基于IETF OAuth工作组发布的OAuth 2.0授权框架(<strong class="jm io"> RFC6749 </strong>)。</p><h1 id="27e4" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><strong class="ak">参考</strong></h1><p id="5dff" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">【https://www.oauth.com/ T4】</p><p id="4d63" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae nh" href="https://tools.ietf.org/html/rfc6749" rel="noopener ugc nofollow" target="_blank">https://tools.ietf.org/html/rfc6749</a></p></div></div>    
</body>
</html>