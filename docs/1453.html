<html>
<head>
<title>Build your own REST API with Node, Express, Knex and PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node、Express、Knex和PostgreSQL构建您自己的REST API</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-your-own-rest-api-with-node-express-knex-and-postgresql-aec98fe75e5?source=collection_archive---------4-----------------------#2020-03-17">https://javascript.plainenglish.io/build-your-own-rest-api-with-node-express-knex-and-postgresql-aec98fe75e5?source=collection_archive---------4-----------------------#2020-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/342f695501cece11b4a0dc82ddc37ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VwEyZ5IQ1WPn_nAASpCvA.png"/></div></div></figure><p id="184f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然Rails是一个完美可行的快速API服务器的解决方案，但我必须承认，编程中我最喜欢的一件事就是不断学习。所以最近我决定用我通常不用的工具来构建一个API，并记录了这个过程，这样你也可以学习。</p><h1 id="b4bc" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">应用程序</h1><p id="9205" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将使用Node、Express、PostgreSQL和Knex以及身份验证来构建一个简单的博客API。将会有两种模式:用户和帖子。我们将使用从用户到帖子的一对多关系。我们开始吧！</p><h1 id="1afa" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件:</h1><ul class=""><li id="4275" class="lz ma iq ka b kb lu kf lv kj mb kn mc kr md kv me mf mg mh bi translated">最新版本的<a class="ae mi" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Nodejs </a>。</li><li id="8aea" class="lz ma iq ka b kb mj kf mk kj ml kn mm kr mn kv me mf mg mh bi translated">PostgreSQL。</li><li id="af33" class="lz ma iq ka b kb mj kf mk kj ml kn mm kr mn kv me mf mg mh bi translated">createdb —通常随默认PostgreSQL安装一起提供的CLI命令。</li><li id="eb44" class="lz ma iq ka b kb mj kf mk kj ml kn mm kr mn kv me mf mg mh bi translated">快速发电机:<code class="fe mo mp mq mr b">npm i -g express-generator</code>。</li><li id="28a6" class="lz ma iq ka b kb mj kf mk kj ml kn mm kr mn kv me mf mg mh bi translated">Knex: <code class="fe mo mp mq mr b">npm i -g knex</code>。</li></ul><h1 id="bc45" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">创建文件结构和数据库</h1><p id="94b5" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">创建一个空的文件夹，并运行<code class="fe mo mp mq mr b">express</code>。这将创建项目所需的基本文件结构。</p><p id="fb93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后通过运行<code class="fe mo mp mq mr b">createdb databaseName</code>创建数据库。我打电话给我的导师。</p><p id="5ad2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要通过输入<code class="fe mo mp mq mr b">npm i -S knex pg</code>来安装knex和pg。然后检查您的package.json文件，确认一切正常。</p><h1 id="006d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">初始化knex </strong></h1><p id="3828" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">现在键入<code class="fe mo mp mq mr b">knex init</code>在您的项目根目录下创建一个knexfile.js。编辑此文件并删除除开发文件之外的所有条目，然后将客户端从“sqlite3”更改为“postgresql ”,并将连接值从对象更改为字符串，并将其值设置为postgres://localhost/yoursdatabase name。我命名了我的教程，所以我的是这样的:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="82d3" class="na kx iq mr b gy nb nc l nd ne">module.exports = {<br/>  development: {<br/>    client: 'postgresql',<br/>    connection: 'postgres://localhost/tutorial'<br/>  }<br/>};</span></pre><h1 id="bd7c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">创建迁移</strong></h1><p id="5c57" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">现在是通过创建第一个表来定义我们的数据库的时候了。为此，键入<code class="fe mo mp mq mr b">knex migrate:make create-users</code>并检查新创建的迁移文件夹，寻找一个名为“timestamp_create-users.js”的文件。在里面，你会发现两个函数被上下调用。这是我们定义表结构的地方:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="b955" class="na kx iq mr b gy nb nc l nd ne">exports.up = function (knex) {<br/>     return knex.schema.createTable('users', (table) =&gt; {<br/>         table.increments();<br/>         table.string('username');<br/>         table.string('email');<br/>     }); };<br/>  exports.down = function (knex) {<br/>     return knex.schema.dropTable('users');<br/> };</span></pre><p id="7bdb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常简单。我们定义了三个字段:第一个将设置一个id字段，自动增量设置为true，并设置一个唯一的约束。然后我们还有两个字段:一个用于用户名，一个用于电子邮件。我们稍后会回来添加密码。</p><h1 id="9ba4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">运行迁移并检查数据库</strong></h1><p id="cc2f" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">运行<code class="fe mo mp mq mr b">knex migrate:latest</code>将新创建的模式加载到数据库中。然后启动一个终端并运行<code class="fe mo mp mq mr b">psql yourDatabaseName</code>。您会在Postgres提示符处着陆，您可以在那里键入<code class="fe mo mp mq mr b">\dt</code>，如果一切顺利，您应该会看到如下内容:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="71e4" class="na kx iq mr b gy nb nc l nd ne">List of relations</span><span id="ed29" class="na kx iq mr b gy nf nc l nd ne">Schema |         Name         | Type  | Owner</span><span id="09c0" class="na kx iq mr b gy nf nc l nd ne">--------+----------------------+-------+-------</span><span id="926f" class="na kx iq mr b gy nf nc l nd ne">public | knex_migrations      | table | john</span><span id="2e49" class="na kx iq mr b gy nf nc l nd ne">public | knex_migrations_lock | table | john</span><span id="a44a" class="na kx iq mr b gy nf nc l nd ne">public | users                | table | john</span><span id="696a" class="na kx iq mr b gy nf nc l nd ne">(3 rows)</span></pre><p id="bf45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">knex使用前两个来跟踪我们的迁移，但是注意第三个吗？太好了，那就是我们的用户将被存储的地方，让我们来看看吧！</p><p id="f4b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仍然在Postgres提示符下，键入<code class="fe mo mp mq mr b">\d users</code>来查看里面的内容:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="c1b9" class="na kx iq mr b gy nb nc l nd ne">Table "public.users"</span><span id="d1bd" class="na kx iq mr b gy nf nc l nd ne">Column  |          Type          | Collation | Nullable |              Default</span><span id="0d44" class="na kx iq mr b gy nf nc l nd ne">----------+------------------------+-----------+----------+-----------------------------------</span><span id="2b01" class="na kx iq mr b gy nf nc l nd ne">id       | integer                |           | not null | nextval('users_id_seq'::regclass)</span><span id="85f1" class="na kx iq mr b gy nf nc l nd ne">username | character varying(255) |           |          |</span><span id="1d29" class="na kx iq mr b gy nf nc l nd ne">email    | character varying(255) |           |          |</span><span id="e26e" class="na kx iq mr b gy nf nc l nd ne">Indexes:</span><span id="082a" class="na kx iq mr b gy nf nc l nd ne">"users_pkey" PRIMARY KEY, btree (id)</span></pre><p id="8878" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太好了！正如我们计划的那样，我们有一个id栏、一个电子邮件和一个用户名！现在通过键入<code class="fe mo mp mq mr b">exit</code>退出Postgres提示符。如果你读上面的表格有困难，可以随意粘贴到一个空的txt文件中。</p><h1 id="e7e1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">创建一个种子文件</strong></h1><p id="bfdc" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">没有一些虚拟数据的练习项目是不完整的，所以还是在你的终端里，运行<code class="fe mo mp mq mr b">knex seed:make create_dummy_users</code>。这将在一个新的<code class="fe mo mp mq mr b">/seeds</code>文件夹中创建一个名为<code class="fe mo mp mq mr b">create_dummy_users</code>的新文件。在这个文件中，我们有一个很好的模板来为我们的数据库填充虚拟数据。只需按照给出的格式添加几个用户:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="43a2" class="na kx iq mr b gy nb nc l nd ne">exports.seed = function(knex) {<br/>   // Deletes ALL existing entries<br/>   return knex('users').del()<br/>     .then(function () {<br/>       // Inserts seed entries<br/>       return knex('users').insert([<br/>         {username: 'John Doe', email: 'johndoe@example.com'},<br/>         {username: 'Jane Doe', email: 'janedoe@example.com'}<br/>       ]);<br/>     });<br/> };</span></pre><p id="9368" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不过有一点需要注意，最初的模板建议指定ID号。这可能适用于其他数据库，但是Postgres会自动处理它们，所以我们应该忽略它们以防止冲突。现在，通过键入“knex seed:run”来运行迁移，您的数据库应该在几秒钟内被填充。要检查它是否工作，返回Postgres提示符并键入<code class="fe mo mp mq mr b">SELECT * FROM users;</code>:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="ca9d" class="na kx iq mr b gy nb nc l nd ne">id | username |        email</span><span id="e5d2" class="na kx iq mr b gy nf nc l nd ne">----+----------+---------------------</span><span id="330d" class="na kx iq mr b gy nf nc l nd ne">1 | John Doe | johndoe@example.com</span><span id="b6fc" class="na kx iq mr b gy nf nc l nd ne">2 | Jane Doe | janedoe@example.com</span><span id="7723" class="na kx iq mr b gy nf nc l nd ne">(2 rows)</span></pre><p id="b998" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae mi" href="https://medium.com/javascript-in-plain-english/build-your-own-rest-api-with-node-express-knex-and-postgresql-part-2-d9ff74f6f2fa" rel="noopener">的下一部分</a>中，我们将添加一个文章表、用户认证和表关系。</p></div></div>    
</body>
</html>