<html>
<head>
<title>Deploying Serverless App with Next.js 8, AWS Lambda and CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Next.js 8、AWS Lambda和CircleCI部署无服务器应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/deploy-serverless-app-with-next-js-8-aws-lambda-and-circleci-part-1-a0c9c6ea7c57?source=collection_archive---------1-----------------------#2019-07-26">https://javascript.plainenglish.io/deploy-serverless-app-with-next-js-8-aws-lambda-and-circleci-part-1-a0c9c6ea7c57?source=collection_archive---------1-----------------------#2019-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="de5c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分:使用<a class="ae kf" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>、<a class="ae kf" href="https://www.npmjs.com/package/serverless-nextjs-plugin" rel="noopener ugc nofollow" target="_blank">无服务器-nextjs-plugin </a>和<a class="ae kf" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>函数部署无服务器Next.js应用程序。</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/3dbd685f1086bac164747461eaaee2b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YTpctwmgOotxWmPL.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">Next.js</figcaption></figure><p id="1a9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Next.js宣布在<a class="ae kf" href="https://nextjs.org/blog/next-8#serverless-nextjs" rel="noopener ugc nofollow" target="_blank"> v8版本</a>中支持开箱即用的无服务器部署。通过分解成lambdas函数，它提高了可靠性和可伸缩性。它提供了按需扩展和“按使用付费”模式的优势。为了简单地测试它，Next.js给了我们一个很棒的教程<a class="ae kf" href="https://blog.hasura.io/build-and-deploy-serverless-apps-with-nextjs-8-zeit-now/" rel="noopener ugc nofollow" target="_blank">和Zeit Now部署，非常简单和容易。但是在本文中，我将介绍AWS Lambda的一个部署。</a></p><p id="add3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照以下步骤进行部署:</p><ul class=""><li id="53b3" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">设置Next.js </strong></li><li id="4c38" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">安装</strong> <code class="fe mg mh mi mj b"><strong class="ky ir">Serverless</strong></code> <strong class="ky ir">框架</strong></li><li id="ed31" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">安装</strong><a class="ae kf" href="https://www.npmjs.com/package/serverless-nextjs-plugin" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">server less-nextjs-plugin</strong></a></li><li id="b24f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">展开</strong></li><li id="9353" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">应用自定义域</strong></li><li id="6f07" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><strong class="ky ir">限制IP地址</strong></li></ul><h1 id="bc7d" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">回购示例</h1><p id="95ba" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">以下是完整的代码库:</p><div class="nh ni gp gr nj nk"><a href="https://github.com/manakuro/nextjs-with-aws-lambda-sample" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">manakuro/nextjs-with-AWS-lambda-sample</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">使用Next.js 8和AWS Lambda-manakuro/nextjs-with-AWS-Lambda-sample部署无服务器应用程序</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny kq nk"/></div></div></a></div><h1 id="9ceb" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">设置Next.js</h1><p id="6140" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">要快速安装Next.js并进行设置，可以使用<code class="fe mg mh mi mj b">create-next-app</code>。</p><p id="6e05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装<code class="fe mg mh mi mj b">create-next-app</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="9271" class="od ml iq mj b gy oe of l og oh">$ npm install -g create-next-app</span></pre><p id="903b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装Next.js应用程序:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="fee8" class="od ml iq mj b gy oe of l og oh">$ create-next-app my-app</span></pre><p id="8a38" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保在<code class="fe mg mh mi mj b">package.json</code>中使用v8:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="b828" class="od ml iq mj b gy oe of l og oh">{<br/>  "name": "my-app",<br/>  "scripts": {<br/>    "dev": "next",<br/>    "build": "next build",<br/>    "start": "next start"<br/>  },<br/>  "dependencies": {<br/>    "next": "^8.1.0",<br/>    "react": "^16.8.6",<br/>    "react-dom": "^16.8.6"<br/>  },<br/>}</span></pre><p id="436e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并启动开发服务器:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="33a3" class="od ml iq mj b gy oe of l og oh">$ cd my-app<br/>$ yarn dev</span></pre><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi oi"><img src="../Images/c1677454bf58f70ffeca9b9079e3258f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ImjozweMGZMqMz5o.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">Welcome page</figcaption></figure><p id="21a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe mg mh mi mj b">next.config.js</code>中打开无服务器模式:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="1ad2" class="od ml iq mj b gy oe of l og oh">/* <!-- -->next.config.js<!-- --> */</span><span id="4606" class="od ml iq mj b gy oj of l og oh">module.exports = {<br/>  target: 'serverless', // &lt;- add here<br/>  webpack: config =&gt; {<br/>    // Fixes npm packages that depend on `fs` module<br/>    config.node = {<br/>      fs: 'empty'<br/>    }<br/>    return config<br/>  }<br/>}</span></pre><p id="1708" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">构建一个app，你可以看到<code class="fe mg mh mi mj b">.next</code>中<code class="fe mg mh mi mj b">serverless</code>的神器是这样的:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="1772" class="od ml iq mj b gy oe of l og oh">$ yarn build</span></pre><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi oi"><img src="../Images/a7e3c23f496acaa80645a2251333c581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VU9MsE4iJwN7MLVp.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">Artifacts of build</figcaption></figure><p id="1008" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些是路由到您的应用程序并在AWS中作为Lambda函数部署的函数。</p><h1 id="4a89" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">安装<code class="fe mg mh mi mj b">Serverless</code>框架</h1><p id="bded" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">可以部署到所有主要的云提供商，如AWS、GCP和Azure，并提供大量API进行部署。一个名为<code class="fe mg mh mi mj b">serverless.yml</code>的配置文件允许您列出您的函数并定义端点。你可以在这里看到AWS <a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/guide/intro/" rel="noopener ugc nofollow" target="_blank">的文档。</a></p><p id="b3f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装无服务器:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="4ebf" class="od ml iq mj b gy oe of l og oh">$ npm install serverless -g</span></pre><p id="d56c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要部署AWS Lambda，您需要配置AWS帐户:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="9f4f" class="od ml iq mj b gy oe of l og oh">$ serverless config credentials --provider aws --key {your access key id} --secret {your secret access key}</span></pre><p id="a5ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您没有AWS帐户，请按照说明在这里注册<a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/guide/credentials?source=post_page---------------------------#sign-up-for-an-aws-account" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi oi"><img src="../Images/8ab5f3230d21eb2e65c6d01129babe0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bDJwRq2Bf4TYCzzx.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">serverless — Sign up for an AWS account</figcaption></figure><p id="6fd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要通过无服务器框架进行部署，请将<code class="fe mg mh mi mj b">serverless.yml</code>添加到root:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="54e7" class="od ml iq mj b gy oe of l og oh"># serverless.yml</span><span id="a29a" class="od ml iq mj b gy oj of l og oh">service: ${self:custom.name}</span><span id="47d9" class="od ml iq mj b gy oj of l og oh">provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  stage: ${opt:stage, 'dev'}<br/>  region: ap-northeast-1 // wherever you want</span><span id="2ca8" class="od ml iq mj b gy oj of l og oh">custom:<br/>  name: my-app</span></pre><h1 id="1f53" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">安装无服务器-nextjs-plugin</h1><p id="f7ae" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">Nextjs 8无服务器模式在AWS Lambda上不能开箱即用。您需要为每个无服务器页面手动添加处理程序。但是已经有一个插件叫做<code class="fe mg mh mi mj b">serverless-nextjs-plugin</code>，它允许你在Lambda中处理下一个应用页面，而不需要任何配置。</p><p id="3222" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装<code class="fe mg mh mi mj b">serverless-nextjs-plugin</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="52e2" class="od ml iq mj b gy oe of l og oh">yarn add -D serverless-nextjs-plugin</span></pre><p id="2262" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编辑<code class="fe mg mh mi mj b">serverless.yml</code>并添加:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="d5e8" class="od ml iq mj b gy oe of l og oh">service: ${self:custom.name}</span><span id="f80f" class="od ml iq mj b gy oj of l og oh">provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  stage: ${opt:stage, 'dev'}<br/>  region: ap-northeast-1</span><span id="ef52" class="od ml iq mj b gy oj of l og oh">plugins: # &lt;- add here<br/>  - serverless-nextjs-plugin</span><span id="9efd" class="od ml iq mj b gy oj of l og oh">custom:<br/>  name: my-app<br/>  serverless-nextjs: # &lt;- add here<br/>    assetsBucketName: 'my-app-assets-${self:provider.stage}'</span><span id="f775" class="od ml iq mj b gy oj of l og oh">package: # &lt;- add here<br/>  # exclude everything<br/>  # page handlers are automatically included by the plugin<br/>  exclude:<br/>    - ./**</span></pre><p id="52ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mg mh mi mj b">assetBucketName</code>是一个具有所提供名称的S3桶。所有插件配置选项都可以在<a class="ae kf" href="https://www.npmjs.com/package/serverless-nextjs-plugin#all-plugin-configuration-options" rel="noopener ugc nofollow" target="_blank">这里</a>看到。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi oi"><img src="../Images/a45c7510f6d0397bb58b82d9bd80d431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hjqIpiZ9a1y7lq2I.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">serverless-nextjs-plugin options</figcaption></figure><h1 id="81e8" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">部署</h1><p id="49ad" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">现在，您已经准备好部署您的应用程序。</p><p id="bc47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">部署:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="7460" class="od ml iq mj b gy oe of l og oh">$ serverless deploy -v</span></pre><p id="d8c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以看到输出:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="b550" class="od ml iq mj b gy oe of l og oh">Serverless Nextjs: Started building next app ...<br/>Creating an optimized production build ...</span><span id="9596" class="od ml iq mj b gy oj of l og oh">Compiled successfully.</span><span id="4b10" class="od ml iq mj b gy oj of l og oh">Page            Size     Files  Packages<br/>┌ ⚡ /           21.1 kB      2         3<br/>├   /_app       2.04 kB      0         3<br/>├   /_document<br/>└   /_error     2.11 kB      0         3</span><span id="d4cc" class="od ml iq mj b gy oj of l og oh">Serverless Nextjs: Copying next pages to tmp build folder<br/>Serverless Nextjs: Found 3 next page(s)<br/>Serverless Nextjs: Creating compat handler for page: 404.js<br/>Serverless Nextjs: Creating compat handler for page: _error.js<br/>Serverless Nextjs: Creating compat handler for page: index.js<br/>Serverless: Packaging service...<br/>Serverless: Excluding development dependencies...<br/>Serverless Nextjs: Cleaning up tmp build folder ...<br/>Serverless Nextjs: Found bucket "my-app-assets-dev" from serverless.yml<br/>Serverless Nextjs: Proxying NextJS assets -&gt; <a class="ae kf" href="https://s3-ap-northeast-1.amazonaws.com/my-app-assets-dev/_next/{proxy" rel="noopener ugc nofollow" target="_blank">https://s3-ap-northeast-1.amazonaws.com/my-app-assets-dev/_next/{proxy</a>}<br/>Serverless Nextjs: Proxying static files -&gt; <a class="ae kf" href="https://s3-ap-northeast-1.amazonaws.com/my-app-assets-dev/static/{proxy" rel="noopener ugc nofollow" target="_blank">https://s3-ap-northeast-1.amazonaws.com/my-app-assets-dev/static/{proxy</a>}<br/>Serverless: Creating Stack...<br/>Serverless: Checking Stack create progress...<br/>CloudFormation - CREATE_IN_PROGRESS - AWS::CloudFormation::Stack - my-app-dev<br/>CloudFormation - CREATE_IN_PROGRESS - AWS::S3::Bucket - NextStaticAssetsS3Bucket<br/>CloudFormation - CREATE_IN_PROGRESS - AWS::S3::Bucket - ServerlessDeploymentBucket<br/>CloudFormation - CREATE_IN_PROGRESS - AWS::S3::Bucket - NextStaticAssetsS3Bucket<br/>CloudFormation - CREATE_IN_PROGRESS - AWS::S3::Bucket - ServerlessDeploymentBucket<br/>CloudFormation - CREATE_COMPLETE - AWS::S3::Bucket - NextStaticAssetsS3Bucket<br/>CloudFormation - CREATE_COMPLETE - AWS::S3::Bucket - ServerlessDeploymentBucket<br/>CloudFormation - CREATE_COMPLETE - AWS::CloudFormation::Stack - my-app-dev<br/>...</span><span id="5c8b" class="od ml iq mj b gy oj of l og oh">Nextjs Application Info</span><span id="b220" class="od ml iq mj b gy oj of l og oh">Application URL: <a class="ae kf" href="https://97jal1fbld.execute-api.ap-northeast-1.amazonaws.com/dev" rel="noopener ugc nofollow" target="_blank">https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/dev</a></span></pre><p id="1a6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用程序URL(<a class="ae kf" href="https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/dev?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank">https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/dev</a>)是您的应用程序URL。</p><p id="fed0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您想完全删除它，请使用:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="949e" class="od ml iq mj b gy oe of l og oh">$ serverless remove</span></pre><p id="5edd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并确保移除S3桶:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="8294" class="od ml iq mj b gy oe of l og oh">$ aws s3 rb s3://my-app-assets-dev --force</span></pre><h1 id="9e40" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">应用自定义域</h1><p id="7d81" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">现在您注意到部署的应用程序URL只是一个随机的名称，如`<a class="ae kf" href="https://97jal1fbld.execute-api.ap-northeast-1.amazonaws.com/dev" rel="noopener ugc nofollow" target="_blank">https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/</a>`。如果您想使用自定义域名，您可以创建自己的域，并使用<a class="ae kf" href="https://www.npmjs.com/package/serverless-domain-manager" rel="noopener ugc nofollow" target="_blank">server less-domain-manager</a>将其应用于无服务器框架。</p><p id="c812" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能还想部署不同的环境，比如，<code class="fe mg mh mi mj b">staging</code>和<code class="fe mg mh mi mj b">production</code>。为了处理它，使用一个子域，最后你希望它们像这样:</p><ul class=""><li id="0c02" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">https://staging.mydomain.com</code> //用于暂存环境</li><li id="ef22" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">https://mydomain.com</code> //针对生产环境</li></ul><p id="9616" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在转到下一步之前，请按照说明创建您的域并申请证书:</p><ul class=""><li id="2d0f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><a class="ae kf" href="https://serverless.com/blog/serverless-api-gateway-domain/" rel="noopener ugc nofollow" target="_blank">如何用无服务器为Lambda &amp; API网关设置自定义域名</a></li></ul><p id="d989" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们假设您在本文中使用了一个名为<code class="fe mg mh mi mj b">mydomain.me</code>的域名。</p><p id="089d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装<code class="fe mg mh mi mj b">serverless-domain-manager</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="1779" class="od ml iq mj b gy oe of l og oh">$ yarn add -D serverless-domain-manager</span></pre><p id="0a3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编辑<code class="fe mg mh mi mj b">serverless.yml</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="79ea" class="od ml iq mj b gy oe of l og oh">service: ${self:custom.name}</span><span id="4d1d" class="od ml iq mj b gy oj of l og oh">provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  stage: ${opt:stage, 'staging'}<br/>  region: ap-northeast-1</span><span id="4723" class="od ml iq mj b gy oj of l og oh">plugins:<br/>  - serverless-nextjs-plugin<br/>  - serverless-domain-manager # &lt;- add here</span><span id="af45" class="od ml iq mj b gy oj of l og oh">custom:<br/>  name: my-app<br/>  serverless-nextjs:<br/>    assetsBucketName: 'my-app-assets-${self:provider.stage}'<br/>  customDomain: # &lt;- add here<br/>    domainName: '${self:provider.stage}.mydomain.me'<br/>    certificateName: '*.mydomain.me'<br/>    basePath: ''<br/>    stage: ${self:provider.stage}<br/>    createRoute53Record: true</span><span id="1a74" class="od ml iq mj b gy oj of l og oh">package:<br/>  # exclude everything<br/>  # page handlers are automatically included by the plugin<br/>  exclude:<br/>    - ./**</span></pre><p id="539c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mg mh mi mj b">domainName</code>和<code class="fe mg mh mi mj b">certificateName</code>应该适用于你的领域。如果创建一个名为<code class="fe mg mh mi mj b">yourdomain.me</code>的域，应该是这样的:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="b2b9" class="od ml iq mj b gy oe of l og oh">customDomain:<br/>    domainName: '${self:provider.stage}.yourdomain.me'<br/>    certificateName: '*.yourdomain.me'<br/>    basePath: ''<br/>    stage: ${self:provider.stage}<br/>    createRoute53Record: true</span></pre><p id="deff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建<code class="fe mg mh mi mj b">staging</code>域:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="e186" class="od ml iq mj b gy oe of l og oh">$ serverless create_domain --stage <!-- -->staging</span><span id="27f7" class="od ml iq mj b gy oj of l og oh">...<br/>Serverless: '<!-- -->staging<!-- -->.mydomain.me' was created/updated. New domains may take up to 40 minutes to be initialized.</span></pre><p id="5336" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">40分钟后，您可以部署一个<code class="fe mg mh mi mj b">staging</code>环境:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="95d2" class="od ml iq mj b gy oe of l og oh">$ serverless deploy -v --stage staging</span></pre><p id="b19f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">很好。现在您可以访问<code class="fe mg mh mi mj b">https://staging.mydomain.me</code>。</p><p id="f9b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mg mh mi mj b">serverless.yml</code>可以根据<a class="ae kf" href="https://serverless.com/framework/docs/providers/aws/guide/variables/" rel="noopener ugc nofollow" target="_blank">指南</a>拆分成各个环境文件以便维护。所以你可以这样分割它:</p><ul class=""><li id="53ff" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">serverless.staging.yml</code></li><li id="c7af" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">serverless.production.yml</code></li></ul><p id="26cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建<code class="fe mg mh mi mj b">serverless.staging.yml</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="5d7e" class="od ml iq mj b gy oe of l og oh"># serverless.staging.yml</span><span id="8052" class="od ml iq mj b gy oj of l og oh">custom:<br/>  customDomain:<br/>    domainName: '${self:provider.stage}.mydomain.me'<br/>    certificateName: '*.mydomain.me'<br/>    basePath: ''<br/>    stage: ${self:provider.stage}<br/>    createRoute53Record: true</span></pre><p id="05e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并编辑<code class="fe mg mh mi mj b">serverless.yml</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="1c08" class="od ml iq mj b gy oe of l og oh"># serverless.yml</span><span id="494a" class="od ml iq mj b gy oj of l og oh">service: ${self:custom.name}</span><span id="cec4" class="od ml iq mj b gy oj of l og oh">provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  stage: ${opt:stage, 'staging'}<br/>  region: ap-northeast-1</span><span id="cdaa" class="od ml iq mj b gy oj of l og oh">plugins:<br/>  - serverless-nextjs-plugin<br/>  - serverless-domain-manager</span><span id="0329" class="od ml iq mj b gy oj of l og oh">custom:<br/>  name: my-app<br/>  serverless-nextjs:<br/>    assetsBucketName: 'my-app-assets-${self:provider.stage}'<br/>  customDomain: ${file(./serverless.${self:provider.stage}.yml):custom.customDomain} # &lt;- add here</span><span id="ce8e" class="od ml iq mj b gy oj of l og oh">package:<br/>  # exclude everything<br/>  # page handlers are automatically included by the plugin<br/>  exclude:<br/>    - ./**</span></pre><p id="1fea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建<code class="fe mg mh mi mj b">serverless.production.yml</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="c249" class="od ml iq mj b gy oe of l og oh"># serverless.production.yml</span><span id="6dc8" class="od ml iq mj b gy oj of l og oh">custom:<br/>  customDomain:<br/>    domainName: 'mydomain.me'<br/>    basePath: ''<br/>    stage: ${self:provider.stage}<br/>    createRoute53Record: true</span></pre><p id="0735" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">生产中的<code class="fe mg mh mi mj b">domainName</code>应该是<code class="fe mg mh mi mj b">mydomain.me</code>，不再需要<code class="fe mg mh mi mj b">certificateName</code>。</p><p id="a053" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们部署<code class="fe mg mh mi mj b">production</code>环境。创建域:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="84d7" class="od ml iq mj b gy oe of l og oh">$ serverless create_domain --stage <!-- -->production</span><span id="9239" class="od ml iq mj b gy oj of l og oh">...<br/>Serverless: 'mydomain.me' was created/updated. New domains may take up to 40 minutes to be initialized.</span></pre><p id="01f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">40分钟后，您可以部署一个<code class="fe mg mh mi mj b">production</code>环境:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="3672" class="od ml iq mj b gy oe of l og oh">$ serverless deploy -v --stage production</span></pre><p id="d3e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你可以访问<code class="fe mg mh mi mj b">https://mydomain.me</code>。</p><h2 id="1fa6" class="od ml iq bd mm ok ol dn mq om on dp mu lf oo op mw lj oq or my ln os ot na ou bi translated">限制IP地址</h2><p id="a0fb" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">您可以使用API Gateway中的资源策略来控制对您的应用程序的访问，AWS <a class="ae kf" href="https://aws.amazon.com/jp/blogs/compute/control-access-to-your-apis-using-amazon-api-gateway-resource-policies/" rel="noopener ugc nofollow" target="_blank">网站</a>上有很好的描述。<code class="fe mg mh mi mj b">Serverless framework</code>支持。</p><p id="869b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将<code class="fe mg mh mi mj b">resourcePolicy</code>添加到<code class="fe mg mh mi mj b">serverless.yml</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="1f79" class="od ml iq mj b gy oe of l og oh">service: ${self:custom.name}</span><span id="59ee" class="od ml iq mj b gy oj of l og oh">provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  stage: ${opt:stage, 'staging'}<br/>  region: ap-northeast-1<br/>  resourcePolicy: ${file(./serverless.${self:provider.stage}.yml):resourcePolicy} // &lt;- add here</span><span id="d148" class="od ml iq mj b gy oj of l og oh">...</span></pre><p id="a3a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">像这样给每个环境添加<code class="fe mg mh mi mj b">resourcePolicy</code>:</p><pre class="kh ki kj kk gt nz mj oa ob aw oc bi"><span id="a438" class="od ml iq mj b gy oe of l og oh"># <!-- -->serverless.staging.yml</span><span id="e24e" class="od ml iq mj b gy oj of l og oh">resourcePolicy:<br/>  - Effect: Allow<br/>    Principal: "*"<br/>    Action: execute-api:Invoke<br/>    Resource:<br/>      - execute-api:/*/*/*<br/>    Condition:<br/>      IpAddress:<br/>        aws:SourceIp:<br/>          - "xxx.xxx.xxx.xx"</span></pre><p id="d373" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mg mh mi mj b">aws:SrouceIp</code>是您可以访问的特定IP地址范围的白名单。部署后，API网关控制台中将有资源策略:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi oi"><img src="../Images/ad6e309f6771eced99191e2fb5aa6ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y65542y-s44WvBnA.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">API Gateway console</figcaption></figure><h2 id="6cd2" class="od ml iq bd mm ok ol dn mq om on dp mu lf oo op mw lj oq or my ln os ot na ou bi translated">结论</h2><p id="183e" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">第一部分到此为止。至此，您应该已经学会:</p><ul class=""><li id="3ae7" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">Setup Next.js</li><li id="2fc5" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">通过无服务器框架部署应用</li><li id="3265" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建自定义域</li><li id="e2d1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">限制IP地址</li></ul><p id="39cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一部分中，我们将介绍使用CircleCI部署CI。</p><div class="nh ni gp gr nj nk"><a href="https://medium.com/@manakuro/deploy-serverless-app-with-next-js-8-aws-lambda-and-circleci-part-2-60cfc8c36c86" rel="noopener follow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">使用Next.js 8、AWS Lambda和CircleCI部署无服务器应用程序—第2部分</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">使用无服务器框架、无服务器-nextjs-plugin和AWS Lambda函数部署无服务器Next.js应用程序…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">medium.com</p></div></div><div class="nt l"><div class="ov l nv nw nx nt ny kq nk"/></div></div></a></div><p id="6c66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在这里看到最终的代码库:</p><div class="nh ni gp gr nj nk"><a href="https://github.com/manakuro/nextjs-with-aws-lambda-sample" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">manakuro/nextjs-with-AWS-lambda-sample</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">使用Next.js 8和AWS Lambda-manakuro/nextjs-with-AWS-Lambda-sample部署无服务器应用程序</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny kq nk"/></div></div></a></div></div></div>    
</body>
</html>