<html>
<head>
<title>Node.js Tips — Express Templates and Requests, and MongoDB Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示— Express模板和请求，以及MongoDB查询</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-express-templates-and-requests-and-mongodb-queries-2f2afdde86fe?source=collection_archive---------7-----------------------#2020-07-21">https://javascript.plainenglish.io/node-js-tips-express-templates-and-requests-and-mongodb-queries-2f2afdde86fe?source=collection_archive---------7-----------------------#2020-07-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/66457d73e19f04c214c029e8a8214cae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0yIaTEXsBFSIbQR4"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@antonchernyavskiy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Anton Chernyavskiy</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0155" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="af97" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">关闭Express服务器</h1><p id="f8bc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们需要关闭Express服务器，我们只需在它上面调用<code class="fe me mf mg mh b">close</code>来关闭它。</p><p id="0e0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它是从<code class="fe me mf mg mh b">listen</code>返回的，是一个HTTP服务器。</p><p id="ac21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6128" class="mq lc iq mh b gy mr ms l mt mu">const server = app.listen(3000);<br/>server.close();</span></pre><h1 id="ec1f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">MongoDB和Mongoose中的全文搜索</h1><p id="be7b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过在模式的标识符上创建一个索引来搜索Mongoose。</p><p id="4507" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">索引将加快搜索速度。</p><p id="2ce2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e173" class="mq lc iq mh b gy mr ms l mt mu">const schema = new Schema({<br/>  name: String,<br/>});</span><span id="e46e" class="mq lc iq mh b gy mv ms l mt mu">schema.index({<br/>  name: 'text',<br/>});</span></pre><p id="c95f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4e60" class="mq lc iq mh b gy mr ms l mt mu">Model.find({<br/>    $text: {<br/>      $search: searchString<br/>    }<br/>  })<br/>  .skip(20)<br/>  .limit(10)<br/>  .exec((err, docs) =&gt; {<br/>    //...<br/>  });</span></pre><p id="8956" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">去做搜索。</p><p id="9bbc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">$search</code>操作符对条目进行搜索。</p><p id="d242" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">skip</code>跳过参数中给出的条目数。</p><p id="7f6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">limit</code>限制争论的数量。</p><h1 id="f61f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express中获取发出请求的域</h1><p id="0e11" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">req.get</code>从<code class="fe me mf mg mh b">host</code>头中获取主机名。</p><p id="2909" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以对跨来源请求使用thr <code class="fe me mf mg mh b">origin</code>头。</p><p id="582a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了得到<code class="fe me mf mg mh b">host</code>头，我们写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7b3d" class="mq lc iq mh b gy mr ms l mt mu">const host = req.get('host');</span></pre><p id="3e8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3087" class="mq lc iq mh b gy mr ms l mt mu">const origin = req.get('origin');</span></pre><p id="53dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了得到原点。</p><h1 id="acba" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在客户端JavaScript上访问Express.js局部变量</h1><p id="9852" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以从模板中传递数据，然后在那里解析它。</p><p id="f4bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8147" class="mq lc iq mh b gy mr ms l mt mu">script(type='text/javascript').<br/> const localData =!{JSON.stringify(data)}</span></pre><p id="6188" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们对数据进行了字符串化，这样它将被插入到模板中。</p><h1 id="1f0c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Jade/Pug有条件地添加类</h1><p id="1d03" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要有条件地添加一个类，我们可以这样写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="25b6" class="mq lc iq mh b gy mr ms l mt mu">div.collapse(class=typeof fromEdit === "undefined" ? "edit" : "")</span></pre><p id="f37d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将JavaScript表达式放在括号内，它会为我们插入类名。</p><h1 id="ba6e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将数据库配置存储在节点或Express应用程序中</h1><p id="d6d8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以将配置存储在一个JSON文件中。</p><p id="9890" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e097" class="mq lc iq mh b gy mr ms l mt mu">const fs = require('fs'),<br/>configPath = './config.json';<br/>const parsed = JSON.parse(fs.readFileSync(configPath, 'UTF-8'));<br/>exports.config = parsed;</span></pre><p id="9e0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">readFileSync</code>读取配置，然后对返回的文本字符串调用<code class="fe me mf mg mh b">JSON.parse</code>。</p><h1 id="2c6e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Mongoose从文档中排除一些字段</h1><p id="56c1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了排除一些返回的字段，我们在<code class="fe me mf mg mh b">tranform</code>方法中转换它，通过在它上面使用<code class="fe me mf mg mh b">delete</code>来删除我们想要的属性。</p><p id="00db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="fece" class="mq lc iq mh b gy mr ms l mt mu">UserSchema.set('toJSON', {<br/>  transform(doc, ret, options) {<br/>    delete ret.password;<br/>    return ret;<br/>  }<br/>});</span></pre><p id="9846" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">set</code>来添加一个方法，用<code class="fe me mf mg mh b">transform</code>方法来转换数据。</p><p id="2c3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">ret</code>有返回结果。</p><p id="1c06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们在上面调用<code class="fe me mf mg mh b">delete</code>。</p><h1 id="eb44" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在HTTP和HTTPS上监听单个Express应用程序</h1><p id="a51f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用一个快捷应用程序收听HTTP和HTTPS。</p><p id="97c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要侦听HTTP请求，我们只需读取私有文件和证书文件。</p><p id="3a74" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以用它们创建一个服务器。</p><p id="c8bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7189" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const https = require('https');<br/>const http = require('http');<br/>const fs = require('fs');<br/>const  app = express();</span><span id="5dbc" class="mq lc iq mh b gy mv ms l mt mu">const options = {<br/>  key: fs.readFileSync('/path/key.pem'),<br/>  cert: fs.readFileSync('/path/cert.pem'),<br/>  ca: fs.readFileSync('/path/ca.pem')<br/>};</span><span id="f406" class="mq lc iq mh b gy mv ms l mt mu">http.createServer(app).listen(80);<br/>https.createServer(options, app).listen(443);</span></pre><p id="a9ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">readFileSync</code>读入文件。</p><p id="7c3f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将整个事情传递给<code class="fe me mf mg mh b">https.createServer</code>方法来创建我们的服务器。</p><p id="f159" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们仍然需要<code class="fe me mf mg mh b">http.createServer</code>来监听HTTP请求。</p><h1 id="4c92" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">获取从Express中的表单传递的数据</h1><p id="5c46" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">body-parser</code>包从Express中的一个表单获取数据。</p><p id="9cde" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用它附带的<code class="fe me mf mg mh b">urlencoded</code>中间件。</p><p id="d111" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9b81" class="mq lc iq mh b gy mr ms l mt mu">const bodyParser = require('body-parser');<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="2e98" class="mq lc iq mh b gy mv ms l mt mu">app.post('/game', (req, res) =&gt; {<br/>  res.send(req.body);<br/>});</span></pre><p id="7bac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们运行了<code class="fe me mf mg mh b">urlencoded</code>中间件，它将解析来自POST请求的表单数据。</p><p id="e541" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">extended</code>意味着我们也可以在请求体中解析JSON。</p><p id="5d5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在我们的路由中，用<code class="fe me mf mg mh b">req.body</code>就可以得到数据。</p><h1 id="e244" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Jade /Pug模板引擎中的循环</h1><p id="7a07" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以像JavaScript <code class="fe me mf mg mh b">for</code>循环一样用Pug写一个循环。</p><p id="c6d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1694" class="mq lc iq mh b gy mr ms l mt mu">- for (let i = 0; i &lt; 10; i) {<br/>  li= array[i]<br/>- }</span></pre><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/2a6a0ea2cf342832c1f76df5c4541c31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LOoCooEDLsVPoLUd"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@irishkristajoy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Krista Joy Montgomery</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="82f5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="bd58" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以和帕格玩圈圈游戏。</p><p id="0cde" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以从JSON文件中读取config。</p><p id="624b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Express可以监听HTTP和HTTPS请求。</p><p id="a9dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在查询MongoDB数据时转换它们。</p><p id="4df5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了添加文本搜索功能，我们可以添加一个索引来加速搜索，并使用<code class="fe me mf mg mh b">$search</code>操作符。</p><h1 id="8fc1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">简单英语的JavaScript</h1><p id="665f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果是这样，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>