<html>
<head>
<title>Firebase-Storage File Management with Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js管理Firebase-Storage文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/firebase-storage-file-management-with-nodejs-server-side-5601ac8785f8?source=collection_archive---------12-----------------------#2020-10-06">https://javascript.plainenglish.io/firebase-storage-file-management-with-nodejs-server-side-5601ac8785f8?source=collection_archive---------12-----------------------#2020-10-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/e288e1e74bd1ea46581ec646edf42487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EnjxCHS_e6ruSCBjQ8sbug.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Preview of entire execution</figcaption></figure><p id="216f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">用Node.js执行firebase-storage文件管理操作比我想象的要麻烦得多，所以下面是我如何设法让它工作的一个演示。</p><p id="6883" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">所有相关的步骤都已经在上面的片段中设置好了，但是我想强调几点</p><h2 id="5683" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">1.谷歌-云平台</h2><p id="f3fe" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">即使您的项目是一个具有身份验证、数据库、存储等功能的firebase项目。firebase-storage全部来源于firebase，实际上依赖于<strong class="kb io"><em class="lv">Google-cloud/storage</em></strong>，需要使用他们的API来管理你的firebase-storage的内容。</p><p id="9af4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这也是为什么我们需要用第56行安装<strong class="kb io"><em class="lv">@ Google-cloud/Storage</em></strong>，并在第59行从其中导入<strong class="kb io"><em class="lv"/></strong>来设置上面代码片段中的球滚动。</p><p id="7544" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~安装google云存储包</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4db6" class="kx ky in mb b gy mf mg l mh mi"><em class="lv">yarn add @google-cloud/storage</em></span><span id="7ee1" class="kx ky in mb b gy mj mg l mh mi">or</span><span id="ccec" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">npm install @google-cloud/storage</em></span></pre><p id="4274" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~从google云存储包导入存储</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="391c" class="kx ky in mb b gy mf mg l mh mi">const { Storage } = require("@google-cloud/storage");</span></pre><h2 id="f113" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">2.设置参考</h2><p id="d44d" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">不同于通常的<strong class="kb io"> <em class="lv">存储()。我们使用客户端，由于GCP的参与，这里的引用略有不同。</em></strong></p><p id="7347" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了在这里创建一个引用，我们首先需要创建一个GCP存储类的实例，并传入包含访问firebase项目所需的认证凭证和密钥的<strong class="kb io"> <em class="lv"> keyFilename </em> </strong>配置(第62到64行)。</p><p id="379f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~创建存储类实例</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9166" class="kx ky in mb b gy mf mg l mh mi">const storage = new Storage({<br/>keyFilename: "./fbProject-name-firebase-adminsdk-58fev-c8317cb59e.json",<br/>});</span></pre><p id="4aa4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在此之后，出现了<strong class="kb io"> <em class="lv">。ref() </em> </strong>方法，我们称之为<strong class="kb io"> <em class="lv">。bucket() </em>这是一个格式为<strong class="kb io"> <em class="lv"> ` &lt;项目名称&gt; .appspot.com` </em> </strong>的字符串。虽然可以创建定制的存储桶，但是创建的默认存储桶是以firebase项目本身命名的(第67行)</strong></p><p id="612c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~创建存储包引用</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f210" class="kx ky in mb b gy mf mg l mh mi">const storageBucket = storage.bucket("fbProject-name.appspot.com"); </span></pre><h2 id="74a5" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">3.访问您的文件</h2><p id="8f97" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">如果桶就像计算机硬盘驱动器字母C:/或D:/，那么。file()方法使用文件在驱动器上的路径来知道要访问什么文件或目录。像第75行那样把它作为一个字符串传入，你应该可以在任何你需要运行它的<strong class="kb io"> <em class="lv">端点/路径</em> </strong>中做任何你想做的事情。</p><p id="67fe" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~指定要访问的文件/目录路径</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c151" class="kx ky in mb b gy mf mg l mh mi">const file = storageBucket.file(`users/${uid}/fileName.fileExtension`)</span></pre><p id="bc2c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">~运行文件管理方法/操作</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f6f8" class="kx ky in mb b gy mf mg l mh mi">file<br/>.move(`users/${uid}/selfie.jpg`) <em class="lv"><br/></em>.then((<em class="lv">data</em>) =&gt; {<br/>console.log("move res", <em class="lv">data</em>); <em class="lv"><br/></em>});</span></pre><p id="a8fe" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您可以查看第86行的参考链接，了解完整的文档以及可用于管理存储容器内容的方法/操作列表。</p><p id="74bb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，把所有这些放在一起，</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="da3e" class="kx ky in mb b gy mf mg l mh mi"><em class="lv">//1. install google-cloud/storage<br/>// yarn add @google-cloud/storage or npm install @google-cloud/storage</em></span><span id="52c0" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//2. import Storage from @google-cloud/storage<br/></em>const { Storage } = require("@google-cloud/storage");</span><span id="0e75" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//3. create storage instance with project keyFilename config<br/></em>const storage = new Storage({<br/>keyFilename: "./fbProject-name-firebase-adminsdk-58fev-c8317cb59e.json", <em class="lv">//used to get auth credentials and project keys<br/></em>});</span><span id="60b2" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//4. specify default storageBucket<br/></em>const storageBucket = storage.bucket("fbProject-name.appspot.com"); <em class="lv">//specify app storage bucket. You can refer to client google-services.json config file for bucket nam</em></span><span id="f334" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//5. server route/endpoint<br/></em>app.post("/firebase-file-rename", (<em class="lv">req</em>, <em class="lv">res</em>) =&gt; {</span><span id="0514" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//6. rename file in bucket<br/></em>storageBucket<br/>.file(`users/${uid}/fileName.fileExtension`) <em class="lv">//current path to target file(with extension) from root<br/></em>.move(`users/${uid}/selfie.jpg`) <em class="lv">//desired/destination path to target file post-operation(with extension) from root<br/></em>.then((<em class="lv">data</em>) =&gt; {<br/>console.log("move res", <em class="lv">data</em>); <em class="lv">//returns a data object with new metadata of file</em></span><span id="3944" class="kx ky in mb b gy mj mg l mh mi">//7. get file mediaLink<br/>const mediaLink = data[1].resource.mediaLink</span><span id="0f7f" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">res</em>.status(200).send(mediaLink);</span><span id="8ad8" class="kx ky in mb b gy mj mg l mh mi">});</span><span id="7d55" class="kx ky in mb b gy mj mg l mh mi"><em class="lv">//docs reference<br/>//https://googleapis.dev/nodejs/storage/latest/index.html</em></span><span id="008c" class="kx ky in mb b gy mj mg l mh mi">});</span></pre></div><div class="ab cl mk ml hr mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ig ih ii ij ik"><h2 id="7c07" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">结论</h2><p id="e388" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">Firebase文档可能非常好，但是挖掘所有这些内容并不像您所期望的那样直接，我个人并不喜欢搜索这些信息并像我必须做的那样解决问题，但是希望这可以为您节省一些时间和精力。</p><p id="ca5a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">干杯:)</p></div></div>    
</body>
</html>