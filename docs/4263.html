<html>
<head>
<title>How to make a fast Angular SEO-friendly app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何制作一个快速有棱角的SEO友好型app</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-make-a-fast-angular-seo-friendly-app-a6d769bfd8d2?source=collection_archive---------7-----------------------#2020-11-29">https://javascript.plainenglish.io/how-to-make-a-fast-angular-seo-friendly-app-a6d769bfd8d2?source=collection_archive---------7-----------------------#2020-11-29</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="cb55" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">做一个有角度的app，迟早会想到SEO。首先，我认为谷歌无论如何都会解析我的应用程序，因为我听说它可以。日子一天天过去，却没有结果，于是我开始思考我能做些什么。我的目标是SEO友好的高PageSpeed Insights分数，不要把世界上所有的钱都花在服务器上。看起来我找到了一个方法！</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj km"><img src="../Images/8e03e64099dcadb7997f7265fa96ab11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBiAn3eILjrqeR7MKWCW2A.jpeg"/></div></div><figcaption class="ky kz gk gi gj la lb bd b be z dk">85 PageSpeed Insights score for the real Angular app with SSR</figcaption></figure><p id="b3ba" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">因此，我的PageSpeed Insights得分约为80+分，它是可扩展的，而且几乎可以免费托管。在获得这些结果之前，我尝试了不同的选择:</p><h2 id="aad1" class="lc ld ir bd le lf lg dn lh li lj dp lk jz ll lm ln kd lo lp lq kh lr ls lt lu bi translated">第一次尝试:预渲染</h2><p id="589f" class="pw-post-body-paragraph jo jp ir jq b jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh lz kj kk kl ik bi translated">首先，我尝试对最重要的页面进行预渲染。理论上，它应该提供最佳性能，但我对PWA功能(渐进式Web应用程序)有很多问题。如果你不需要PWA支持，大概是你最好的选择。</p><h2 id="61b9" class="lc ld ir bd le lf lg dn lh li lj dp lk jz ll lm ln kd lo lp lq kh lr ls lt lu bi translated">第二次尝试:带有谷歌云功能的SSR</h2><p id="e5e8" class="pw-post-body-paragraph jo jp ir jq b jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh lz kj kk kl ik bi translated">通过这种方法，我的应用程序工作了很长一段时间。社交网络和爬虫可以解析应用程序的任何页面，它完全支持PWA。但是它有一个超级大的性能问题——<strong class="jq is">冷启动</strong>。云函数是无状态的，执行环境往往是从零开始初始化，这叫冷启动。开始执行前可能需要大约3-5秒+ SSR时间300-600毫秒。2020年要求用户等这么久是不能接受的。</p><h2 id="eb49" class="lc ld ir bd le lf lg dn lh li lj dp lk jz ll lm ln kd lo lp lq kh lr ls lt lu bi translated">第三次也是最后一次尝试:SSR和Google cloud Run</h2><p id="b1e4" class="pw-post-body-paragraph jo jp ir jq b jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh lz kj kk kl ik bi translated">有了Google Cloud Run，访客不必等待冷启动。该应用程序是搜索引擎友好的，并支持PWA功能。此外，谷歌提供了相当大的免费层限制，所以你托管一个应用程序可能不需要任何成本。</p><h1 id="4114" class="ma ld ir bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">那么如何设置你的app呢？</h1><p id="4a0a" class="pw-post-body-paragraph jo jp ir jq b jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh lz kj kk kl ik bi translated">首先你需要安装<code class="fe mr ms mt mu b">@nguniversal/express-engine</code>。你可以用角度示意图来做。</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="438a" class="lc ld ir mu b gz mz na l nb nc">ng add @nguniversal/express-engine</span></pre><p id="2592" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">多亏了Angular schematics，这几乎是你使用应用程序进行SSR的全部工作。您已经有了一个npm命令，它将构建应用程序和服务器的生产版本。</p><p id="4ab6" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在，我们应该将部署配置为云运行。有几个要求:</p><ul class=""><li id="e78d" class="nd ne ir jq b jr js jv jw jz nf kd ng kh nh kl ni nj nk nl bi translated">你需要<a class="ae nm" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy" rel="noopener ugc nofollow" target="_blank">安装谷歌云SDK </a>。</li><li id="ea34" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl ni nj nk nl bi translated">另外，你需要<a class="ae nm" href="https://firebase.google.com/docs/cli" rel="noopener ugc nofollow" target="_blank">安装Firebase CLI </a>。</li><li id="f298" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl ni nj nk nl bi translated">你应该在谷歌控制台启用云运行，并启用计费。即使启用了计费，您仍有免费使用限制。虽然你的应用程序负载不是很重，但它不会花费什么。</li></ul><p id="de4c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">云跑用的是Docker镜像，我们要准备一下。首先，我们需要创建一个Docker文件。对于我们的例子来说，这很简单:</p><figure class="kn ko kp kq gu kr"><div class="bz fq l di"><div class="ns nt l"/></div></figure><p id="641e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">我们到了最后一步，现在我们应该自动化docker映像的构建和部署。为了解决这个问题，我们可以看到不同的选项，我更喜欢使用npm脚本。</p><p id="43f8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为什么是多个脚本？因为我们需要多名员工。</p><ol class=""><li id="6664" class="nd ne ir jq b jr js jv jw jz nf kd ng kh nh kl nu nj nk nl bi translated">我们需要建立一个码头工人的形象。</li><li id="2691" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl nu nj nk nl bi translated">我们需要将它部署到谷歌云。</li><li id="30bf" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl nu nj nk nl bi translated">我们需要将静态文件部署到Firebase主机上，以便快速获取资产。</li></ol><p id="5153" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们将第一个脚本添加到package.json文件中。</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="0a34" class="lc ld ir mu b gz mz na l nb nc">"scripts": {</span><span id="f8ef" class="lc ld ir mu b gz nv na l nb nc">  "ng": "ng",</span><span id="43ae" class="lc ld ir mu b gz nv na l nb nc">  "start": "ng serve",</span><span id="f73f" class="lc ld ir mu b gz nv na l nb nc">  "build": "ng build --prod",</span><span id="fcae" class="lc ld ir mu b gz nv na l nb nc">  ...</span><span id="7951" class="lc ld ir mu b gz nv na l nb nc">  "docker-build": "docker build ./ -t gcr.io/CLOUD_ACCOUNT/CLOUD_PROJECT &amp;&amp; docker push gcr.io/CLOUD_ACCOUNT/CLOUD_PROJECT",</span><span id="b707" class="lc ld ir mu b gz nv na l nb nc">}</span></pre><p id="605a" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">命令<code class="fe mr ms mt mu b">npm run docker-build</code>将从我们的docker文件构建一个docker映像并添加一个标签。有了这个标签，我们可以自动地将它直接部署到云上。</p><p id="0af8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在我们将添加一个docker-deploy脚本，它将把创建的映像部署到云运行中。</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="1b58" class="lc ld ir mu b gz mz na l nb nc">"docker-deploy": "gcloud run deploy ssr --image gcr.io/CLOUD_ACCOUNT/CLOUD_PROJECT --platform managed --region us-central1"</span></pre><p id="6add" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在您的情况下，地区可能会有所不同。这取决于您在启用云运行时在云控制台中的初始配置。</p><p id="1da6" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">要在单个命令中运行这些脚本，我们可以创建<code class="fe mr ms mt mu b">docker</code>脚本:</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="cf2c" class="lc ld ir mu b gz mz na l nb nc">"docker": "npm run docker-build &amp;&amp; npm run docker-deploy</span></pre><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj nw"><img src="../Images/f513197726fecd79653aecb03853ff1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dQnO7NIT9Iz8qblkUpyXPg.png"/></div></div></figure><p id="a0ed" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">部署之后，您需要在google控制台中启用最近部署的修订版的所有流量。</p><p id="1909" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">您的容器将免费存储在5GB空间的Google云存储中。超过这个限制后，你必须为空间付费，所以如果不必要，你可能需要删除以前的修订。</p><h1 id="0520" class="ma ld ir bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">使用Firebase托管运行SSR</h1><p id="6ef5" class="pw-post-body-paragraph jo jp ir jq b jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh lz kj kk kl ik bi translated">至此，您已经完成了云运行部分。如果你使用Firebase托管，你需要做一些额外的设置和部署。</p><p id="625a" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">首先，我们需要更新firebase.json。让我们为云运行服务添加所有URL的重写。</p><figure class="kn ko kp kq gu kr"><div class="bz fq l di"><div class="ns nt l"/></div></figure><p id="0e05" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">快好了。现在我们需要在package.json文件中添加更多的脚本。</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="1f93" class="lc ld ir mu b gz mz na l nb nc">"back-up-index": "mv dist/ANGULAR_PROJECT_NAME/browser/index.html dist/ANGULAR_PROJECT_NAME/browser/_index.html",</span><span id="dc52" class="lc ld ir mu b gz nv na l nb nc">"restore-index": "mv dist/ANGULAR_PROJECT_NAME/browser/_index.html dist/ANGULAR_PROJECT_NAME/browser/index.html",</span><span id="69b1" class="lc ld ir mu b gz nv na l nb nc">"hosting-ssr": "npm run back-up-index &amp;&amp; firebase deploy --token=FIREBASE_CI_TOKEN --project=FIREBASE_PROJECT_NAME --non-interactive --only hosting &amp;&amp; npm run restore-index"</span></pre><blockquote class="nx ny nz"><p id="acce" class="jo jp oa jq b jr js jt ju jv jw jx jy ob ka kb kc oc ke kf kg od ki kj kk kl ik bi translated">要将云运行与Firebase一起使用，不要忘记从dist文件夹中删除index.html。因为该文件的优先级高于firebase重写。</p></blockquote><p id="a171" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这就是为什么我们需要在部署之前将<code class="fe mr ms mt mu b">index.html</code>重命名为<code class="fe mr ms mt mu b">_index.html</code>。</p><p id="0d04" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">要将资产部署到firebase hosting，我们只需运行:</p><pre class="kn ko kp kq gu mv mu mw mx aw my bi"><span id="4b46" class="lc ld ir mu b gz mz na l nb nc">npm run build &amp;&amp; npm run hosting-ssr</span></pre><p id="3354" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">就是这样。</p><h2 id="65f5" class="lc ld ir bd le lf lg dn lh li lj dp lk jz ll lm ln kd lo lp lq kh lr ls lt lu bi translated">概括一下:</h2><ul class=""><li id="91d9" class="nd ne ir jq b jr lv jv lw jz oe kd of kh og kl ni nj nk nl bi translated">Google Cloud Run在性能和价格上有很好的平衡。如果您需要更快的解决方案，可以选择App Engine或其他服务。</li><li id="b363" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl ni nj nk nl bi translated">使用@nguniversal/express-engine对Angular app进行服务器端渲染。</li><li id="9cdd" class="nd ne ir jq b jr nn jv no jz np kd nq kh nr kl ni nj nk nl bi translated">如果你使用Firebase托管，不要忘记从托管中删除index.html，以免中断重写。</li></ul><p id="d5bf" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">感谢阅读！如果您对此有任何想法，或者您知道如何提高Angular SSR的性能，请随时发表评论。</p></div></div>    
</body>
</html>