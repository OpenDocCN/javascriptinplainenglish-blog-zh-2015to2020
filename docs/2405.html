<html>
<head>
<title>Building an eCommerce Store from Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从零开始建立电子商务商店</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-an-ecommerce-store-from-scratch-fe80c409eb67?source=collection_archive---------3-----------------------#2020-06-21">https://javascript.plainenglish.io/building-an-ecommerce-store-from-scratch-fe80c409eb67?source=collection_archive---------3-----------------------#2020-06-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d267" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">今年夏天，我决定建立一个网上商店来组织销售我定制的印花运动衫。你可以在<a class="ae ki" href="https://shopblth.com" rel="noopener ugc nofollow" target="_blank">https://shopblth.com</a>访问这个项目，但请注意，结帐已被设置在一个开发者沙盒模式，所以付款将被拒绝在这个时候。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/98cef694426e557d1542495760ebf3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2LG41kAnj8ggjXgkksQ9w.png"/></div></div></figure><p id="ce79" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇博文的内容本质上是技术性的，所以可能有点枯燥。希望这能为从事类似项目的开发人员提供一个合适的参考指南或不错的起点！</p><h1 id="e0e0" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">概观</h1><p id="0895" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">这是一个完整的stack Node.js项目。名为Okta的服务用于用户认证。后端数据库通过MongoDB处理，前端是用CodyHouse框架组件设计的。PayPal智能按钮用于结账。所有这些技术都在各自的章节中进行了详细介绍，以便于跳过。我还包括了从头开始设计这个系统的关键要点。</p><h1 id="ca18" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">Okta用户认证</h1><p id="a8ce" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">Okta使得将登录信息集成到web应用程序和从图形界面管理用户变得简单。在这个项目中，我需要用户身份验证，以将客户购物车中的商品保存到他们的帐户中，并按客户ID组织订单详细信息。我附上了我如何将Okta集成到Node.js脚本中的图片，以及我用来设置web应用程序的路线。我主要是按照<a class="ae ki" href="https://developer.okta.com/blog/2019/05/31/simple-auth-express-fifteen-minutes" rel="noopener ugc nofollow" target="_blank">这个</a>指南作为参考。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ly lz l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Using OIDC Middleware for this project. The ‘env’ variables were generated from the Okta Dashboard. On line 16, I created a callback JSON to redirect the login URL to the product page.</figcaption></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi me"><img src="../Images/91fbb3156ef02b336542d6460a8c1cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*CdM0kMrrv9TnCnE22oeTrQ.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">You can attach several URLs to the login/logout redirects. As shown above, I still haven’t deleted my localhost and Amazon EC2 Instance URLs. The only important one to remember to change is the Initiate login URL.</figcaption></figure><h1 id="6e97" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">MongoDB集合</h1><p id="5ce5" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">要理解这一节，掌握MongoDB中元素的层次结构很重要。键值对或<strong class="jm io">字段</strong>可以组合成一个名为<strong class="jm io">文档</strong>的对象。几个<strong class="jm io">文档</strong>组成一个<strong class="jm io">集合</strong>。几个<strong class="jm io">集合</strong>形成一个<strong class="jm io">数据库</strong>。我的数据库中有两个集合:一个客户集合和一个订单集合。</p><p id="a76f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">客户文档包含以下字段:<em class="mf"> oktaSub </em>、<em class="mf"> oktaName </em>和<em class="mf"> oktaUsername </em>。oktaSub' <em class="mf"> </em>是分配给用户的唯一ID，' oktaName' <em class="mf"> </em>是注册用户的全名，' oktaUsername' <em class="mf"> </em>是用户的电子邮件地址。所有三个客户字段都有字符串值。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi me"><img src="../Images/96cfd71ebf6c8ef8e6aed4e491205fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*v2p2s2QmhMqN62J43HHqvw.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Example of Customer document.</figcaption></figure><p id="5a79" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当一个新订单生成时，它包含以下字段:<em class="mf"> oktaSub </em>、<em class="mf"> S </em>、<em class="mf"> M </em>、<em class="mf"> L </em>和<em class="mf"> openOrder </em>。和以前一样，‘okta sub’是用户的唯一ID。S '，' M '和' L' <em class="mf"> </em>取与用户添加到购物车中的每个产品尺寸的数量相对应的整数值(S =小，M =中，L =大)。openOrder' <em class="mf"> </em>有一个布尔值，通过确定最终采购订单是否已通过PayPal提交，与订单是否已完成相对应。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/3756e9f9c7398c5a99aeba8a4129eccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*c3XhwtpQzA0okDMlzdN8cQ.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Example of an open Order document. The value of ‘S’ is 3, which means that the user currently has 3 small sweatshirts saved in his/her cart. The value of ‘openOrder’ is true, which means that the user is still shopping and has not checked out yet.</figcaption></figure><p id="0ec5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当用户成功提交付款后，订单文档中会添加三个附加字段。这些字段是<em class="mf">支付地址</em>、<em class="mf">支付区域</em>和<em class="mf">支付名称</em>。“paypalAddress”和“paypalArea”是两个字符串，组合在一起构成完整的送货地址。顾名思义，“paypalName”是指注册到PayPal帐户的名称。我包含了这个字段，以防它与“oktaName”不同。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mh"><img src="../Images/68bfc1dbb8f48a1032069fa32b359d57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKc4Ww2otmILs_XtDalDEw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Example of a closed Order document. The value of ‘M’ is 1, which means that the user currently has 1 medium sweatshirt saved in his/her cart. The value of ‘openOrder’ is false, which means that the user has successfully checked out. Therefore, the three additional ‘paypal’ fields have been appended.</figcaption></figure><p id="d966" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用户首次登录后，会生成新的客户和订单文档。成功结帐后，还可以生成新的订单文档。回想一下，这是通过“openOrder”字段将值交换为“false”并添加三个“paypal”字段来分类的。</p><h1 id="9913" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">CodyHouse框架组件</h1><p id="73cf" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">框架是软件的“画布”,从中可以开发出更复杂的应用程序。CodyHouse框架包含预先构建的电子商务组件，已经附加了所有必要的HTML、SCSS和JavaScript。在这个项目中，我使用了以下你可以在他们网站上找到的组件:<a class="ae ki" href="https://codyhouse.co/ds/components/app/product" rel="noopener ugc nofollow" target="_blank">产品</a>、<a class="ae ki" href="https://codyhouse.co/ds/components/app/cart-drawer" rel="noopener ugc nofollow" target="_blank">推车抽屉</a>、<a class="ae ki" href="https://codyhouse.co/ds/components/app/dialog" rel="noopener ugc nofollow" target="_blank">对话框</a>、<a class="ae ki" href="https://codyhouse.co/ds/components/app/fill-loader" rel="noopener ugc nofollow" target="_blank">填充加载器</a>、<a class="ae ki" href="https://codyhouse.co/ds/components/app/hero" rel="noopener ugc nofollow" target="_blank">英雄</a>、<a class="ae ki" href="https://codyhouse.co/ds/components/app/alert" rel="noopener ugc nofollow" target="_blank">预警</a>。</p><p id="0dee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了建立工作环境，我遵循<a class="ae ki" href="https://codyhouse.co/ds/docs/framework" rel="noopener ugc nofollow" target="_blank">这个</a>指南。</p><h1 id="c778" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">PayPal智能按钮</h1><p id="991c" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">PayPal拥有丰富的开发者API，但集成支付的最简单方式是通过PayPal开发者网站上提供的JavaScript。我跟随他们的正式指南<a class="ae ki" href="https://developer.paypal.com/docs/checkout/" rel="noopener ugc nofollow" target="_blank">来到这里</a>。</p><p id="b287" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">PayPal按钮渲染函数附带了两个操作。第一个是“createOrder”，它创建一个包含交易金额的采购订单。第二个是“onApprove”，在成功支付后触发。在这个阶段可以编写和执行自定义操作。在我的项目中，我创建了一个不可见的表单，并附加了包含PayPal用户姓名、地址和地区的隐藏输入字段。我还创建了一个隐藏的submit按钮，并使用JavaScript在AJAX请求中处理它。为了更清楚起见，下面提供了代码。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ly lz l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">PayPal Smart Button render code. Order is created on lines 6 to 14. On line 10, the transaction amount is specified in USD. ‘subtotal’ is global variable that is updated via AJAX request (more on this in a later section).</figcaption></figure><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ly lz l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Actions taken after ‘onApprove’ function. ‘details’ is a JSON object containing PayPal data. Several hidden input elements are created and their values are set to various values from the ‘details’ JSON. These elements are then appended and subsequently to ‘dynForm’, a form object created earlier in the code. A hidden submit input is also created and clicked on line 33. All elements are subsequently removed from ‘dynform’ after submission.</figcaption></figure><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ly lz l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Handling of the form submit of dynForm. Line 11 prevents the page from refreshing after the form is submitted. A JSON package is prepared, followed by a POST request, and finally handling of the response.</figcaption></figure><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ly lz l"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Route within Node.js script for checkout. Order collection is updated as described in the MongoDB section.</figcaption></figure><h1 id="97b9" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">关键要点1: PayPal智能按钮适用于非可变购买</h1><p id="4807" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">虽然这是PayPal明确提出的，但我决定忽略这个警告。最初，我选择使用智能按钮，因为代码已经提供，而且似乎很容易集成。如PayPal部分的上图所示，创建采购订单时必须指定交易值。对于一个固定的价格，分配这个值很简单。然而，设置动态价格需要考虑一些安全因素。</p><p id="a784" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">其中一个大问题是不能从HTML DOM中获得交易总数。DOM元素可以从用户端进行编辑和操作，以影响最终的小计。像uOrigin这样的广告拦截器使用这种技术作为其主要功能之一，因此其意图并不总是恶意的，但仍可能在结账时引起问题。我的解决方法是在每次AJAX请求后更新一个全局“subtotal”变量(如果您感兴趣，可以在外卖#2中了解更多)。</p><p id="6bfc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我有目的地推迟发表这篇文章，直到我采取了现场支付，因为我仍然不知道如何“黑客”这个解决方案。我知道这比从DOM元素中提取小计要好得多，但想想还是让我不舒服。我认为正确的解决方案是使用Node.js路径并使用PayPal开发人员API来处理这种混乱。</p><h1 id="2c17" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">要点2:从按钮按压而不是从HTML <div>更新“小计”</div></h1><p id="93ad" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">我在外卖#1中提到了这一点，但是我学到的一个总的教训是，基于DOM元素更新信息是非常愚蠢的。同样，DOM元素可以从用户端操作。敏感字段不应该从HTML元素中更新它们的值。我采用的解决方法是在每次按钮按下时发送一个AJAX请求，这会影响后端。下图提供了所有相关按钮的列表。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/98cef694426e557d1542495760ebf3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2LG41kAnj8ggjXgkksQ9w.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">All AJAX buttons. (1) Obtains size selected from radio buttons. Searches Orders Collection for user and increases the quantity of the selected size. (2) Searches Order Collection for user and increases the quantity of the item size. (3) Searches Order Collection for user and decreases the quantity of the item size. (4) Searches the Order Collection for user and sets the quantity of the item size to 0. (5) Updates global ‘subtotal’ variable one last time.</figcaption></figure><h1 id="2eb1" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">要点3:不要从浏览器cookies更新后端</h1><p id="64d8" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">所有这些要点都遵循一个相似的主题，即<em class="mf">不要更新用户可以操纵的敏感信息</em>。使用浏览器cookies的好处是不需要用户注册来保存他们的购物车。不幸的是，当用户决定重置他们的浏览器历史时，cookies可能会被无意中删除。我的解决方法是要求用户登录以保存他们的购物车。我使用按钮通过AJAX请求更新用户的购物车，如外卖#2中的图所示。虽然通过Okta注册对用户来说是一个额外的麻烦，但我认为这是必要的不便。</p><h1 id="cd20" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">未解决的问题</h1><p id="b13c" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">在这一部分，我想简要概述一下这个项目中我暂时搁置的一些未解决的问题。我计划退出这个项目，但是如果没有一些遗留问题的报告和可以帮助其他开发者的改进，这个博客是不完整的。</p><p id="fa8a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，一个让我纠结并最终放弃的问题是处理失败的PayPal支付。如果信用卡被拒或用户输入的信息不正确，用户需要刷新页面，而不仅仅是重新输入信息。简单地再次输入他们的信息不会导致错误，但会“软锁定”用户访问结账过程的其余部分。根据网上的一些研究，在用户未能正确结账后，PayPal似乎无法记住之前打开的订单请求会话。</p><p id="283c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另一个需要改进的地方是替换我在设置Okta时使用的“OIDC”中间件。我在这方面没有做过很多研究，但我相信更常见的做法是使用Passport.js来代替。这将给开发者更多的灵活性，包括注册后发送定制确认邮件的能力。</p><h1 id="4a3f" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结束语</h1><p id="7e73" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">在从事这个项目的过程中，我对全栈应用程序的每个组件的了解可能比我以前所有的项目和实习经历加起来还要多。尽管如此，每年夏天我都会尝试这些项目中的一个，但总觉得自己只是刚刚触及皮毛。我期待着利用我所学到的一切，并在我的下一次冒险中加以利用。感谢阅读！</p></div></div>    
</body>
</html>