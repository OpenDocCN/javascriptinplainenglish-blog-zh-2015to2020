<html>
<head>
<title>Add a Status Monitor to an Express App with express-status-monitor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用express-status-monitor向Express应用程序添加状态监视器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/add-a-status-monitor-to-an-express-app-with-express-status-monitor-35fd7f36a8e8?source=collection_archive---------3-----------------------#2020-04-15">https://javascript.plainenglish.io/add-a-status-monitor-to-an-express-app-with-express-status-monitor-35fd7f36a8e8?source=collection_archive---------3-----------------------#2020-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e46834aecc7dda5ae2315d4035d12b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ccw74UF2C44pFbl1"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jrduncan11?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">John Duncan</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="bde1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，Express不提供跟踪我们的应用程序状态的方法。</p><p id="bdc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，我们可以添加一个包来做到这一点。</p><p id="fa07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看<code class="fe lb lc ld le b">express-status-monitor</code>包以及如何使用它。</p><h1 id="f4ea" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">装置</h1><p id="ef39" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">express-status-monitor</code>作为节点包提供。我们可以通过运行以下命令来安装它:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="6818" class="mq lg iq le b gy mr ms l mt mu">npm install express-status-monitor --save</span></pre><h1 id="497e" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用</h1><p id="ce4e" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">一旦我们安装了这个包，我们可以如下使用它:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="cc8b" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');</span><span id="482c" class="mq lg iq le b gy mv ms l mt mu">const app = express();<br/>app.use(require('express-status-monitor')());</span><span id="6c64" class="mq lg iq le b gy mv ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  res.send('hello');<br/>});</span><span id="878c" class="mq lg iq le b gy mv ms l mt mu">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="59ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们去<code class="fe lb lc ld le b">/status</code>时，我们得到一个看起来如下的屏幕:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/950478065a4305b86bba952d03bdd2d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33whD621z5T_NaiqFuO3Lw.png"/></div></div></figure><h1 id="4871" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">附加选项</h1><p id="6eb7" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以通过向<code class="fe lb lc ld le b">expressMonitor</code>构造函数传递一个对象来传递额外的选项。</p><p id="ea87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可用选项包括:</p><ul class=""><li id="c838" class="mx my iq kf b kg kh kk kl ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b">title</code> —页面标题</li><li id="67f5" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">theme</code>—CSS样式表的路径</li><li id="aa23" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">path</code> —状态页面的路径</li><li id="d0f9" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">socketPath</code> —要使用的web套接字路径</li><li id="1692" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">websocket</code> —我们想要使用的套接字IO实例</li><li id="1ed9" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">spans</code> —包含以秒为单位记录数据的<code class="fe lb lc ld le b">interval</code>和要保留的数据点数的对象，通过为<code class="fe lb lc ld le b">retention</code>属性设置一个数字来设置</li><li id="cfe6" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">chartVisibility</code> —我们希望在状态页面上看到的项目，包括处理器使用情况的<code class="fe lb lc ld le b">cpu</code>、内存使用情况的<code class="fe lb lc ld le b">mem</code>、CPU平均负载的<code class="fe lb lc ld le b">load</code>、<code class="fe lb lc ld le b">responseTime</code>是应用的响应时间、<code class="fe lb lc ld le b">rps</code>是每秒的请求数、<code class="fe lb lc ld le b">statusCodes</code>是应用返回的状态代码。如果这些被设置为<code class="fe lb lc ld le b">true</code>，那么它们将被看到。</li><li id="2fa1" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">healthChecks</code>是一个带有用于健康检查的端点的数组</li><li id="ecc3" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">ignoreStartsWith</code> —忽略从我们设置的测量值开始的路径</li></ul><h1 id="84fb" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">健康检查</h1><p id="163d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以添加一系列的健康检查，出现在其他统计数据下面。如果运行状况检查返回200状态代码，则运行状况检查成功。</p><p id="741f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以编写以下代码来添加状态页面的配置:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="7a82" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');</span><span id="a29d" class="mq lg iq le b gy mv ms l mt mu">const config = {<br/>  title: 'Express Status',<br/>  path: '/status',<br/>  spans: [{<br/>    interval: 1,<br/>    retention: 60<br/>  }, {<br/>    interval: 5,<br/>    retention: 60<br/>  }, {<br/>    interval: 15,<br/>    retention: 60<br/>  }],<br/>  chartVisibility: {<br/>    cpu: true,<br/>    mem: true,<br/>    load: true,<br/>    responseTime: true,<br/>    rps: true,<br/>    statusCodes: true<br/>  },<br/>  healthChecks: [<br/>    {<br/>      protocol: 'http',<br/>      host: 'localhost',<br/>      path: '/admin/health/ex1',<br/>      port: '3000'<br/>    }<br/>  ],<br/>  ignoreStartsWith: '/admin'<br/>}</span><span id="9b6e" class="mq lg iq le b gy mv ms l mt mu">const app = express();<br/>app.use(require('express-status-monitor')(config));</span><span id="3186" class="mq lg iq le b gy mv ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  res.send('hello');<br/>});</span><span id="7326" class="mq lg iq le b gy mv ms l mt mu">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="745f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们应该在页面底部看到一个图表，其中包含发送的状态代码和一个运行状况检查状态框。</p><h1 id="e044" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">保护端点</h1><p id="9a4b" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以使用<a class="ae kc" href="https://www.npmjs.com/package/http-auth" rel="noopener ugc nofollow" target="_blank"> http-auth </a>包来保护<code class="fe lb lc ld le b">status</code>页面。</p><p id="39bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以添加包并设置用户名和密码，以进行如下检查:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="b376" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const auth = require('http-auth');<br/>const statusMonitor = require('express-status-monitor')({ path: '' });</span><span id="b1f3" class="mq lg iq le b gy mv ms l mt mu">const basic = auth.basic({ realm: 'Monitor Area' }, (user, pass, callback) =&gt; {<br/>  callback(user === 'username' &amp;&amp; pass === 'password');<br/>});</span><span id="baa9" class="mq lg iq le b gy mv ms l mt mu">const app = express();</span><span id="4315" class="mq lg iq le b gy mv ms l mt mu">app.use(statusMonitor.middleware);<br/>app.get('/status', auth.connect(basic), statusMonitor.pageRoute);</span><span id="f9e8" class="mq lg iq le b gy mv ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  res.send('hello');<br/>});</span><span id="7aa6" class="mq lg iq le b gy mv ms l mt mu">app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="0e2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们添加了<code class="fe lb lc ld le b">http-auth</code>包，然后我们有:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="d0e9" class="mq lg iq le b gy mr ms l mt mu">const basic = auth.basic({ realm: 'Monitor Area' }, (user, pass, callback) =&gt; {<br/>  callback(user === 'username' &amp;&amp; pass === 'password');<br/>});</span></pre><p id="b49c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加一个登录对话框，检查用户名是否为<code class="fe lb lc ld le b">username</code>，密码是否为<code class="fe lb lc ld le b">password</code>。</p><p id="13bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们有:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="9428" class="mq lg iq le b gy mr ms l mt mu">app.use(statusMonitor.middleware);<br/>app.get('/status', auth.connect(basic), statusMonitor.pageRoute);</span></pre><p id="9a6d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加<code class="fe lb lc ld le b">auth.connect(basic)</code>中间件，将基本身份验证添加到状态页面，这样我们必须登录才能看到该页面。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/9afa108651b945e74551cab2b5932458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nOfdIk1F3Q5Uz2kr"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@cadop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mathew Schwartz</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="456a" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">在同一项目中使用socket.io</h1><p id="f440" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">express-status-monitor</code>可能用现有的socket.io实例破坏项目。</p><p id="2fe3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们有它，那么我们应该将socket.io实例设置为我们的应用程序的主socket.io实例。</p><h1 id="a455" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="e265" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">express-status-monitor</code>是一个方便的软件包，用于监控我们的Express应用程序的状态。</p><p id="cac0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它通过使用认证中间件来支持认证，所以它是安全的。</p><p id="c0ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以用许多选项来配置它。</p><h2 id="271e" class="mq lg iq bd lh nm nn dn ll no np dp lp ko nq nr lt ks ns nt lx kw nu nv mb nw bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="38a7" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们总是有兴趣帮助推广高质量的内容。如果你有一篇文章想用简单的英语提交给JavaScript，用你的中级用户名发邮件到<a class="ae kc" href="mailto:submissions@javascriptinplainenglish.com" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">submissions@javascriptinplainenglish.com</strong></a>给我们，我们会把你添加为作者。</p><p id="3dc7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还推出了三种新的出版物！为我们的新出版物献上一点爱心吧，请跟随他们:<a class="ae kc" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="kf ir">AI in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="kf ir">UX in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="kf ir">Python in Plain English</strong></a><strong class="kf ir"/>——谢谢，继续学习！</p></div></div>    
</body>
</html>