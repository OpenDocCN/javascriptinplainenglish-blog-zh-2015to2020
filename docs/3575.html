<html>
<head>
<title>Securing a Node.js API with Auth0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Auth0保护Node.js API</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/securing-a-node-js-api-with-auth0-7785a8f2c8e3?source=collection_archive---------3-----------------------#2020-10-10">https://javascript.plainenglish.io/securing-a-node-js-api-with-auth0-7785a8f2c8e3?source=collection_archive---------3-----------------------#2020-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="39cd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Auth0设置Node.js API的指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/92a42806b4143c096df20556814e1af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1LJ1i82_ganoqzgfSQnyaw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Made by the author in <a class="ae kv" href="https://www.canva.com/" rel="noopener ugc nofollow" target="_blank">Canva</a></figcaption></figure><p id="b0c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你读过我以前关于Auth0的文章，你就会知道我非常喜欢在新应用中使用它进行身份管理。在本文中，我将演示如何在Auth0 admin中创建一个API，构建一个使用Auth0保护的API，最后将介绍如何使用角色和权限管理用户访问。</p><p id="5586" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要完成本文中的演示API，您需要已经设置了一个<a class="ae kv" href="https://auth0.com/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>帐户，或者创建一个新帐户。如果你需要一些关于如何做到这一点的指导，一定要看看我以前的Auth0文章，我将在下面链接。</p><p id="41bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以前我写过一篇文章，介绍Auth0，并为设置新的React应用程序和使用Auth0保护它提供指导。一定要看看下面这篇文章。</p><div class="ls lt gp gr lu lv"><a href="https://medium.com/javascript-in-plain-english/securing-react-applications-with-auth0-333180f8ea06" rel="noopener follow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">使用Auth0保护React应用程序</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">使用Auth0引导新React应用程序的指南</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">medium.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj kp lv"/></div></div></a></div></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="01c1" class="mr ms iq bd mt mu mv dn mw mx my dp mz lf na nb nc lj nd ne nf ln ng nh ni nj bi translated">在Auth0中创建新的API</h2><p id="4afb" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">在开始构建Node.js API之前，我们需要在Auth0 admin中设置一个新的API。创建或使用现有帐户登录后，您需要导航到管理UI中的API部分。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/d75be166396246a23410e151638e3ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i2dB6psqkvnWjl68rL3ejw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="930d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要创建一个新的API，你会看到一个对话框，需要输入一个<code class="fe nq nr ns nt b">Name</code>和<code class="fe nq nr ns nt b">Identifier</code>。Auth0建议标识符为URL。如果你知道你将把API部署到哪个域，你可以把它作为一个标识符。我将在演示中使用一个逻辑名称。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/ca66d448d7acfbd1a3046e3c8b49616f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PV95C0KxkVrCgPrRuyAWIQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="bcc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功创建新API后，您将进入该API的设置视图。当我们稍后在这里设置我们的API时，您会想要记录这些设置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/036f36bfe3933558434732def6d41735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vIiWsleQOBLpA8cZVMAywg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="f7c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Auth0将自动创建一个测试应用程序来测试您的新API。您可以在下面的屏幕截图中看到，通过转到“机器对机器应用程序”选项卡，您可以看到这个测试应用程序。</p><p id="6f84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文的后面，您将需要<code class="fe nq nr ns nt b">client_id</code>和<code class="fe nq nr ns nt b">client_secret</code>来生成访问令牌，以测试我们的Node.js API。您可以通过点击新创建的测试应用程序的链接来找到这些设置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/ffe5f52a0d9f5e47b52b9ac1c2178f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zB7I-cyNsgO0-q9HCM9yDg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="30d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试应用程序是一个机器对机器应用程序的例子，换句话说，它是一个使用承载令牌调用API的服务。这就是我们将在本文中用于演示的内容，但是请注意，您也可以使用在您的Auth0单页应用程序中生成的不记名令牌。</p><p id="5a43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是本指南的初始管理部分。接下来，我们将设置Node.js API。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="085f" class="mr ms iq bd mt mu mv dn mw mx my dp mz lf na nb nc lj nd ne nf ln ng nh ni nj bi translated">API</h2><p id="ba9b" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们几乎准备好开始为我们的演示API编写代码了。但是在我们开始编写代码之前，我们需要创建一个新的Node.js项目，并通过npm安装一些依赖项。</p><p id="4aa1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个新目录，并在该目录下的终端中输入以下命令。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="1ed1" class="mr ms iq nt b gy ob oc l od oe">npm init<br/>npm install express express-jwt jwks-rsa express-jwt-authz</span></pre><p id="f5a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这一步是可选的，但是如果您希望API在您更改文件后自动重启，那么我建议将<em class="of"> nodemon </em>添加到依赖项中。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="7df3" class="mr ms iq nt b gy ob oc l od oe">npm install --save-dev nodemon</span></pre><p id="47b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的依赖项都已安装，现在我们可以在项目的根目录下创建<code class="fe nq nr ns nt b">index.js</code>，我们将在那里创建服务器。下面是服务器文件的启动代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="c338" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，对服务器没有什么影响。您只需要用您自己的API中的值替换<code class="fe nq nr ns nt b">audience</code>、<code class="fe nq nr ns nt b">issuer</code>和<code class="fe nq nr ns nt b">jwksUri</code>。我们使用<code class="fe nq nr ns nt b">jwt</code>中间件来验证授权头中发送的不记名令牌。请注意，因为我们已经在express应用的基础上设置了这个中间件，所以它将应用于我们创建的每个端点。</p><p id="5e5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以有选择地将它应用于一些端点，而不保护其他端点，但是如果我们像上面那样使用它，它将应用于我们创建的每条路由。</p><p id="2ef8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们准备在终端中用下面的命令运行API。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="340a" class="mr ms iq nt b gy ob oc l od oe">npx nodemon index.js<br/>// or<br/>node index.js</span></pre><p id="7acd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，随着API的运行，我们将使用curl为之前创建的测试应用程序生成一个访问令牌。使用以下命令生成令牌。必要时，确保用您自己的值替换示例值。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="5702" class="mr ms iq nt b gy ob oc l od oe">curl --request POST \<br/>  --url <a class="ae kv" href="https://dev-gkawf0h0.us.auth0.com/oauth/token" rel="noopener ugc nofollow" target="_blank">https://dev-gkawf0h0.us.auth0.com/oauth/token</a> \<br/>  --header 'content-type: application/json' \<br/>  --data '{"client_id":"YOUR_CLIENT_ID","client_secret":"YOUR_CLIENT_SECRET","audience":"<a class="ae kv" href="https://auth0-nodejs-example" rel="noopener ugc nofollow" target="_blank">https://auth0-nodejs-example</a>","grant_type":"client_credentials"}'</span></pre><p id="95f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您得到的结果将类似于以下内容:</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="7fc5" class="mr ms iq nt b gy ob oc l od oe">{<br/>  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImRaN2JYcUI3bkF4QTZ2LTZjQkZ2VSJ9.eyJpc3MiOiJodHRwczovL2Rldi1na2F3ZjBoMC51cy5hdXRoMC5jb20vIiwic3ViIjoiMWQwMVAzZExPS3VoSmxCU1IxQzBLdEx3ZW9yN3lmb3NAY2xpZW50cyIsImF1ZCI6Imh0dHBzOi8vYXV0aDAtbm9kZWpzLWV4YW1wbGUiLCJpYXQiOjE2MDIzMDA4NjksImV4cCI6MTYwMjM4NzI2OSwiYXpwIjoiMWQwMVAzZExPS3VoSmxCU1IxQzBLdEx3ZW9yN3lmb3MiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.ZIVMFbtTVHaxpFNOBs-tYV_hL2gtLAuBQnlaO-b0ooDDF2Sbh8x4xiWGXlpqrtSez7v2wd-FGPTTGPzgvF_OaLHJRva9t-lHM4TfRk4CzrgxAS-I6xXlk5YPITL6BqnYEJk0aHZS_if5Hlp0s4UCiqjjNwPfew-WXAsLmgR3946LbnKY63omwcg2RX8FwD4MnzCHutiuCyRZNdXp4dyxSlAmdKtn3v49j7DGUt9ybj_k0nZ1AbEaqLtEpOInWP5C1IzWQ0aof-95Cv0VVKLuB3jabXI6BHIL0EUt-HFi8eCjR7Bv4apxcsSgyBmLwhqnY_Hko0n-FNp-rzis1NCp-A",<br/>  "expires_in": 86400,<br/>  "token_type": "Bearer"<br/>}</span></pre><p id="fa1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要复制并粘贴发送的access_token的整个值。当我们调用API时，我们将把这个JSON Web令牌(JWT)添加到授权头中。</p><p id="a378" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了做一个快速实验来确保我们的端点是安全的，我们将尝试在没有端点的情况下调用API。在终端中使用以下curl命令进行测试。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="2958" class="mr ms iq nt b gy ob oc l od oe">curl --request GET \<br/>  --url <a class="ae kv" href="http://localhost:8000/secured" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/secured</a></span></pre><p id="e551" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果应该如下所示:</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="40dc" class="mr ms iq nt b gy ob oc l od oe">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>&lt;meta charset="utf-8"&gt;<br/>&lt;title&gt;Error&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;pre&gt;UnauthorizedError: No authorization token was found&lt;br&gt; &amp;nbsp; &amp;nbsp;at middleware (/Users/matthewbrown/develop/auth0-node-example/node_modules/express-jwt/lib/index.js:79:21)&lt;br&gt; &amp;nbsp; &amp;nbsp;at Layer.handle [as handle_request] (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/layer.js:95:5)&lt;br&gt; &amp;nbsp; &amp;nbsp;at trim_prefix (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:317:13)&lt;br&gt; &amp;nbsp; &amp;nbsp;at /Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:284:7&lt;br&gt; &amp;nbsp; &amp;nbsp;at Function.process_params (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:335:12)&lt;br&gt; &amp;nbsp; &amp;nbsp;at next (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:275:10)&lt;br&gt; &amp;nbsp; &amp;nbsp;at expressInit (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/middleware/init.js:40:5)&lt;br&gt; &amp;nbsp; &amp;nbsp;at Layer.handle [as handle_request] (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/layer.js:95:5)&lt;br&gt; &amp;nbsp; &amp;nbsp;at trim_prefix (/Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:317:13)&lt;br&gt; &amp;nbsp; &amp;nbsp;at /Users/matthewbrown/develop/auth0-node-example/node_modules/express/lib/router/index.js:284:7&lt;/pre&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="f55c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果以一大块HTML的形式返回，但是您可以看到基本思想是，如果我们试图调用没有授权令牌的安全端点，就会显示这是<code class="fe nq nr ns nt b">UnauthorizedError</code>。这很好，正是我们所期待的。</p><p id="b61c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将再次尝试，但这次使用授权令牌。请注意，您将替换授权头中“载体”之后的令牌。</p><pre class="kg kh ki kj gt nx nt ny nz aw oa bi"><span id="7b5d" class="mr ms iq nt b gy ob oc l od oe">curl --request GET \<br/>  --url <a class="ae kv" href="http://localhost:8000/secured" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/secured</a> \<br/>  --header 'authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImRaN2JYcUI3bkF4QTZ2LTZjQkZ2VSJ9.eyJpc3MiOiJodHRwczovL2Rldi1na2F3ZjBoMC51cy5hdXRoMC5jb20vIiwic3ViIjoiMWQwMVAzZExPS3VoSmxCU1IxQzBLdEx3ZW9yN3lmb3NAY2xpZW50cyIsImF1ZCI6Imh0dHBzOi8vYXV0aDAtbm9kZWpzLWV4YW1wbGUiLCJpYXQiOjE2MDIzMDA4NjksImV4cCI6MTYwMjM4NzI2OSwiYXpwIjoiMWQwMVAzZExPS3VoSmxCU1IxQzBLdEx3ZW9yN3lmb3MiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.ZIVMFbtTVHaxpFNOBs-tYV_hL2gtLAuBQnlaO-b0ooDDF2Sbh8x4xiWGXlpqrtSez7v2wd-FGPTTGPzgvF_OaLHJRva9t-lHM4TfRk4CzrgxAS-I6xXlk5YPITL6BqnYEJk0aHZS_if5Hlp0s4UCiqjjNwPfew-WXAsLmgR3946LbnKY63omwcg2RX8FwD4MnzCHutiuCyRZNdXp4dyxSlAmdKtn3v49j7DGUt9ybj_k0nZ1AbEaqLtEpOInWP5C1IzWQ0aof-95Cv0VVKLuB3jabXI6BHIL0EUt-HFi8eCjR7Bv4apxcsSgyBmLwhqnY_Hko0n-FNp-rzis1NCp-A'</span></pre><p id="7194" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这次你应该会收到我们的成功信息:<code class="fe nq nr ns nt b">{“success”:true}</code></p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="4e5e" class="mr ms iq bd mt mu mv dn mw mx my dp mz lf na nb nc lj nd ne nf ln ng nh ni nj bi translated">验证权限</h2><p id="7706" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">现在我们已经完成了基本的工作，让我们继续授权或验证访问令牌，看看它是否包含对它试图在API上访问的内容的适当权限。</p><p id="e0a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以第一件事是我们需要跳回Auth0 admin来创建一些权限。遵循下面的截图，并在您的API中创建这些:</p><ul class=""><li id="9119" class="oi oj iq ky b kz la lc ld lf ok lj ol ln om lr on oo op oq bi translated"><code class="fe nq nr ns nt b">create:users</code></li><li id="e25c" class="oi oj iq ky b kz or lc os lf ot lj ou ln ov lr on oo op oq bi translated"><code class="fe nq nr ns nt b">read:users</code></li><li id="4d0d" class="oi oj iq ky b kz or lc os lf ot lj ou ln ov lr on oo op oq bi translated"><code class="fe nq nr ns nt b">delete:users</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/15173cc6bd26828bb957c4ce330a8021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kc9fwFE9mYU9WjCmmCUWGw.png"/></div></div></figure><p id="7132" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们已经为API定义了权限，我们将希望添加更多的端点来利用这些权限。将以下代码添加到现有的<code class="fe nq nr ns nt b">index.js</code>文件中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="5cb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们创建一个检查权限的函数，作为新端点的中间件函数。我们可以传递多个权限给require，或者像上面所做的那样只传递一个权限。</p><p id="2008" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们用最新的更新运行API，并将URL从之前的<code class="fe nq nr ns nt b">curl</code>命令更新为指向<code class="fe nq nr ns nt b">GET /users</code>，我们会收到以下消息:<code class="fe nq nr ns nt b">Insufficient scope</code></p><p id="f29d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这正是我们所期望的，所以我们新的权限验证正在按预期工作。为了让它工作，我们可以简单地将这些权限添加到我们用来验证API的测试应用程序中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/8f497fc695fb52d3a99375eaf6c123c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T06UcR6YMbzx-k85ma2i8w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="7d0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们希望检查测试应用程序下的APIs选项卡中的一个或所有权限。一旦完成，我们将需要创建一个新的令牌，并确保它包含预期的权限。</p><p id="ab30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有一个简单的方法来检查这一点。复制JWT并粘贴到<a class="ae kv" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT.io </a>中。这将对令牌进行解码，您可以很容易地将其作为JSON对象进行检查。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/b10c10561507408d15f991a6e731b5db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFc815WWiSfgzQL3USdlLg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot by the author</figcaption></figure><p id="b0b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们检查scope属性中的payload部分，我们可以看到令牌包含我们刚刚添加的所有权限，因此如果我们使用新令牌再次调用API，这次应该会成功。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="dba8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="of">我希望这篇Node.js和Auth0入门指南对你有所帮助。Auth0是一个强大的身份管理工具，我在生产应用程序中使用它有很好的体验，并且喜欢帮助其他人做同样的事情。感谢阅读！</em></p></div></div>    
</body>
</html>