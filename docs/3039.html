<html>
<head>
<title>Reporting Errors via ChatOps using AWS Lambda &amp; NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda &amp; NodeJS通过ChatOps报告错误</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/serverless-ninja-part-02-reporting-errors-via-chatops-using-aws-lambda-nodejs-8d56dccadc9b?source=collection_archive---------6-----------------------#2020-08-22">https://javascript.plainenglish.io/serverless-ninja-part-02-reporting-errors-via-chatops-using-aws-lambda-nodejs-8d56dccadc9b?source=collection_archive---------6-----------------------#2020-08-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0187b90dc5401fb8691ec63d4758fa23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U3JKfzMJs1zNVTTZ.png"/></div></div></figure><p id="09ca" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文解释了如何使用ChatOps注入错误报告模块，以及它如何帮助组织更快地对运行在AWS Lambda函数中的应用程序出现的问题做出反应。在这个演示中，我将使用NodeJS，并利用Slack向重要的利益相关者发送警报:</p><ul class=""><li id="c57c" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">应用开发人员</li><li id="b13a" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">软件经理</li><li id="3ac1" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">软件测试人员</li><li id="1dd2" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">安全响应小组</li><li id="d90e" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">当东西坏了的时候，谁需要保持清醒</li></ul><h1 id="8d9f" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">利益</h1><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mf"><img src="../Images/59e3729c615801940b2f1c733cce6c45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NU8kPbAAzfNQ_LHv.png"/></div></div></figure><p id="999c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我们开始编码之前，我认为有必要了解ChatOps带来的好处，以便我们可以向我们的软件开发团队解释我们在构建这种警报机制方面所做努力的重要性。</p><h2 id="cd9d" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">软件问题的早期检测</h2><p id="93d7" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">嘿，在开发环境中捕捉bug是开发人员在代码中犯错误时可以瞄准的最好目标。这允许你和平地谷歌应用程序错误，并找到正确的方法来修复它。</p><h2 id="2137" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">对生产问题的快速响应</h2><p id="9a6a" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">向消息传递应用程序发出警报有助于软件工程团队获得到达生产阶段的问题的实时可见性。这通过减少停机时间和应用程序问题对业务的影响而使组织受益。</p><h2 id="0b41" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">它将你从无声的失败中拯救出来</h2><p id="6b0a" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">如果没有ChatOps，后台工作人员会默默无闻地失败，没有礼貌地通知您生产中出现了问题。我发现这些后台工作人员是最讨厌的，因为他们可以轻而易举地把你的工作安全置于摇椅上。安装适当的错误处理和警报机制可以避免将中断的工作交付给生产</p><h2 id="3bb8" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">刺激协作和学习</h2><p id="2a60" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">在一个渠道中提出问题，让整个团队积极倾听，通过提高意识，在以下主题上培训您的开发团队，从而微妙地让组织受益:</p><ul class=""><li id="9653" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">为什么会提出一个问题</li><li id="d382" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">可以修复问题的地方</li><li id="c11d" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">如何解决该问题</li><li id="a99c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">如何防止它再次发生</li></ul><h2 id="0c37" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">设置松弛挂钩URL</h2><p id="1ea1" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">要运行这个示例，您需要设置一个<a class="ae nb" href="https://slack.com/intl/en-sg/help/articles/115005265063-Incoming-webhooks-for-Slack" rel="noopener ugc nofollow" target="_blank"> Slack传入Webhook URL。</a></p><h2 id="1865" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">我们的解决方案架构</h2><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nc"><img src="../Images/0cc259607ee78c7027b4d92eaadb9bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6adl7YSV1fz5G2wV.jpg"/></div></div></figure><p id="cb3d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上图解释了我们想要的解决方案。把它分解成可消化的小块:</p><ul class=""><li id="3d09" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">我们正在接受HTTP请求拉忍者和武器对象</li><li id="25c7" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们使用API网关来处理公共流量，并将其卸载到适当的基于lambda的API。</li><li id="ae99" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们使用Lambda层在lambda APIs之间共享公共库和功能代码</li><li id="6b93" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们有意不提供Dynamo DB表来模拟连接问题。</li><li id="aa5e" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们将优雅地处理错误，并基于它们的元数据构建降价消息</li><li id="ee36" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">然后，我们将基于降价的消息发送到Slack Hook URLs</li><li id="bac5" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">利益相关者随后对通知做出反应</li></ul><h2 id="fa5e" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">NodeJS实现先决条件</h2><p id="9ec4" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">你需要以下资源来完成这个项目。</p><ul class=""><li id="e994" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">AWS CLI</li><li id="cce6" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">AWS SAM CLI</li><li id="92c2" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">AWS帐户</li><li id="c01e" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">Shell脚本执行环境(Linux、MAC、WSL)</li><li id="8a63" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">AWS CLI的命名配置文件</li><li id="07ff" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">用于SAM工件存储的S3桶</li><li id="56a4" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">NodeJS</li><li id="af34" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">带有传入网钩的松弛通道</li><li id="c707" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated"><a class="ae nb" href="https://github.com/allanchua101/serverless-ninja/tree/master/012-reporting-errors-via-chatops/node" rel="noopener ugc nofollow" target="_blank">克隆这个Github库</a></li></ul><div class="nd ne gp gr nf ng"><a href="https://github.com/allanchua101/serverless-ninja/tree/master/012-reporting-errors-via-chatops/node" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd io gy z fp nl fr fs nm fu fw im bi translated">allancha 101/无服务器-忍者</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">存储库的这一部分旨在展示通过基于Slack发送错误通知的NodeJS实现…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu jt ng"/></div></div></a></div><h2 id="7235" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">部署应用程序</h2><ol class=""><li id="9ff8" class="kt ku in jx b jy mw kc mx kg nv kk nw ko nx ks ny kz la lb bi translated">如果你是Linux或Mac用户，你需要提供这个<a class="ae nb" href="https://github.com/allanchua101/serverless-ninja/tree/master/012-reporting-errors-via-chatops/node" rel="noopener ugc nofollow" target="_blank">文件夹</a>根目录下的shell脚本的执行权限。如果您是windows用户，请忽略此步骤。</li></ol><pre class="mg mh mi mj gt nz oa ob oc aw od bi"><span id="b99d" class="mk li in oa b gy oe of l og oh">chmod +x *.sh</span></pre><p id="c70e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.您将需要运行<strong class="jx io">001 _ install _ dependencies . sh</strong>脚本来为基础层和API文件夹安装节点模块。</p><p id="66a9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3.您必须将<strong class="jx io">base-layer \ nodejs \ Slack . config . sample . JSON</strong>文件复制到<strong class="jx io">base-layer \ nodejs \ Slack . config . JSON</strong>，并提供您的Slack webhook URLs和所需的频道名称。如果不进行配置，您将会遇到可怕的静默故障问题，这个问题只能通过CloudWatch日志来诊断。查看下面显示文件内容的代码片段。</p><pre class="mg mh mi mj gt nz oa ob oc aw od bi"><span id="7bd1" class="mk li in oa b gy oe of l og oh">{  <br/>    "slackChannelName": "#place-your-channel-name",<br/>    "slackHookUrl": "https://place-your-hook-url-here"<br/>}</span></pre><p id="476e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4.运行shell脚本后，您必须通过执行<strong class="jx io"> 002_release_apis.sh </strong>脚本来释放APIs CloudFormation堆栈。为了验证步骤3是否正常工作，您可以访问您的AWS帐户的CloudFormation门户网站，应该能够看到名为<strong class="jx io"> dev-ninja-alarms </strong>的CloudFormation堆栈。这将包含下面列出的AWS资源:</p><ul class=""><li id="1b74" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">1个API网关</li><li id="bd4f" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">1个API密钥</li><li id="6b9c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">1 API使用计划</li><li id="e96c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">2个λ函数</li><li id="0f9f" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">2个IAM角色</li><li id="23a2" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">1λ层</li><li id="4549" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">4个Lambda权限(2个用于CORS，2个用于GET)</li></ul><h1 id="517c" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">SAM模板</h1><p id="11da" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">这是我用来在多个API端点之间共享API网关和Lambda层的SAM模板。</p><h2 id="f44c" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">测试警报</h2><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oi"><img src="../Images/41744ad01980d9810312a1d99823f546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MPBMklKIKho15xBV.png"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Trigger any endpoint using the test console from AWS.</figcaption></figure><p id="d9dc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了简化测试，您可以导航到AWS控制台的API Gateway部分，找到名为<strong class="jx io"> dev-ninja-alarms </strong>的网关，并查看其资源列表。</p><h2 id="df1e" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">查看生成的警报</h2><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi on"><img src="../Images/82b076270c5b4b5686c693f6954e6f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hr0pFGF0mRmQ62sS.png"/></div></div></figure><p id="dfa9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您应该能够在您用传入的webhook URL链接的Slack通道上获得以下错误消息。</p><h2 id="2f02" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">它是如何工作的？</h2><p id="cb6e" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">我们在共享的lambda层文件夹中创建了一个名为<strong class="jx io">base-layer \ nodejs \ slack-alarm . js</strong>的出色模块，代码如下:</p><figure class="mg mh mi mj gt jo"><div class="bz fp l di"><div class="oo op l"/></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Cloud Formation template used for provisioning the project</figcaption></figure><p id="e171" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还配置了两个基于Lambda的API来捕捉Lambda执行范围内可能出现的任何形式的异常。</p><h2 id="2c69" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">停用云形成堆栈</h2><p id="ca33" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">我知道Lambda非常便宜，你甚至可以让你的API运行，它们不会让你付出任何重大的代价。然而，为了防止您的AWS帐户变得混乱，我建议您使用脚本<strong class="jx io">003 _ decoration _ APIs . sh</strong>来解除这个示例的CloudFormation堆栈。</p><h2 id="d054" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">我在写一本关于无服务器的书！</h2><p id="2dc1" class="pw-post-body-paragraph jv jw in jx b jy mw ka kb kc mx ke kf kg my ki kj kk mz km kn ko na kq kr ks ig bi translated">如果你有兴趣了解更多关于无服务器架构的知识，你可以访问我的<a class="ae nb" href="https://github.com/allanchua101/serverless-ninja" rel="noopener ugc nofollow" target="_blank"> GitHub </a>库，阅读更多我还没有在博客中发表的主题。您还可以找到有趣的示例代码和项目，它们可以帮助您开始使用无服务器架构。</p><h2 id="ba18" class="mk li in bd lj ml mm dn ln mn mo dp lr kg mp mq lv kk mr ms lz ko mt mu md mv bi translated">相关链接</h2><ul class=""><li id="2006" class="kt ku in jx b jy mw kc mx kg nv kk nw ko nx ks ky kz la lb bi translated"><a class="ae nb" href="https://medium.com/@ac052790/serverless-ninja-part-01-serverless-efficiency-64cf77915838" rel="noopener">无服务器=效率</a></li><li id="fc8f" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated"><a class="ae nb" href="https://github.com/allanchua101/serverless-ninja" rel="noopener ugc nofollow" target="_blank"> Github库</a></li></ul></div><div class="ab cl oq or hr os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="ig ih ii ij ik"><p id="e1d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ox">原载于2020年8月22日https://www.pogsdotnet.com</em><em class="ox">的</em> <a class="ae nb" href="https://www.pogsdotnet.com/2020/08/serverless-ninja-reporting-errors-via.html" rel="noopener ugc nofollow" target="_blank"> <em class="ox">。</em></a></p></div></div>    
</body>
</html>