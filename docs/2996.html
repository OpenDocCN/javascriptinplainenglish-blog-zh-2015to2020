<html>
<head>
<title>Node.js Best Practices — Express Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践—快速应用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-best-practices-express-apps-8de9023402e4?source=collection_archive---------7-----------------------#2020-08-16">https://javascript.plainenglish.io/node-js-best-practices-express-apps-8de9023402e4?source=collection_archive---------7-----------------------#2020-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/aef4facce6c4599b18389aa12b1d483e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cBluzVRhxaoTdChO"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@snowjam?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ethan McArthur</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f4c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="c604" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Gzip压缩</h1><p id="4060" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该使用gzip压缩来压缩我们的资产。</p><p id="7c95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，用户需要下载较少的数据到他们的计算机上。</p><p id="eb44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用带有Express的<code class="fe me mf mg mh b">compression</code>中间件来实现这一点:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d2a9" class="mq lc iq mh b gy mr ms l mt mu">const compression = require('compression')<br/>const express = require('express')<br/>const app = express()<br/>app.use(compression())</span></pre><p id="b06e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于高流量的网站，我们应该在反向代理中启用gzip压缩。</p><h1 id="018a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">不要使用同步函数</h1><p id="0e5d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">对于应用程序的许多部分来说，同步功能绝对不是一个好主意。</p><p id="36d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任何可能长期运行的代码都应该是异步的。</p><p id="984c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，他们就不会阻止应用程序的其余部分运行</p><p id="105b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同步调用会大大增加和减慢我们的应用程序。</p><p id="8389" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每当同步代码运行时，我们可以使用<code class="fe me mf mg mh b">--trace-sync-io</code>命令行标志来打印警告和堆栈跟踪。</p><p id="ee02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这对于在开发环境中跟踪同步代码很有用。</p><h1 id="b740" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">正确记录</h1><p id="ed73" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了正确记录，我们应该使用比<code class="fe me mf mg mh b">console.log</code>或<code class="fe me mf mg mh b">console.error</code>更好的记录器。</p><p id="1a99" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一些像Winston这样的库可以帮助记录日志。</p><p id="6b2e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它比<code class="fe me mf mg mh b">console</code>方法有更好的特性。</p><p id="7874" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">debug</code>模块对于记录调试消息非常有用。</p><p id="750f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">DEBUG</code>环境变量来启用调试。</p><h1 id="456b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">正确处理异常</h1><p id="11bf" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用try-catch处理异常，或者用承诺处理<code class="fe me mf mg mh b">catch</code>。</p><p id="b65e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们应该确保我们的应用程序在遇到未处理的错误时自动重启。</p><p id="d63f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最好的方法是避免我们的应用程序崩溃。</p><p id="1299" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不应该做的是听<code class="fe me mf mg mh b">uncaughtException</code>事件。</p><p id="1f8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当一个异常一路冒泡回到事件循环时，就会发出这个异常。</p><p id="ad8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">向<code class="fe me mf mg mh b">uncaughtException</code>事件添加一个事件监听器将改变流程的默认行为，而不是遇到异常。</p><p id="0ff3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管出现异常，该进程仍将继续运行。</p><p id="0f67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，流程的状态变得不可靠和不可预测。</p><p id="f6c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以对同步代码使用try-catch:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e011" class="mq lc iq mh b gy mr ms l mt mu">app.get('/search', function(req, res) {<br/>  const jsonStr = req.query.params<br/>  try {<br/>    const jsonObj = JSON.parse(jsonStr)<br/>    res.send('Success')<br/>  } catch (e) {<br/>    res.status(400).send('Invalid JSON')<br/>  }<br/>})</span></pre><p id="d50f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以打电话给<code class="fe me mf mg mh b">catch</code>承诺:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="768a" class="mq lc iq mh b gy mr ms l mt mu">app.get('/', function (req, res, next) {<br/>  queryDb()<br/>    .then((data)  =&gt; {<br/>      // ...<br/>      return makeCsv(data)<br/>    })<br/>    .then(function (csv) {<br/>      // ...<br/>    })<br/>    .catch(next)<br/>})</span><span id="308f" class="mq lc iq mh b gy mv ms l mt mu">app.use(function (err, req, res, next) {<br/>  // handle error<br/>})</span></pre><p id="41f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在<code class="fe me mf mg mh b">catch</code>中有<code class="fe me mf mg mh b">next</code>，当一个错误发生时它被调用。</p><p id="e05b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将调用它下面的中间件。</p><h1 id="d9a8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将NODE_ENV设置为“生产”</h1><p id="add8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该将<code class="fe me mf mg mh b">NODE_ENV</code>设置为<code class="fe me mf mg mh b">production</code>，以便Express缓存视图模板，缓存CSS文件，并生成更少的详细警告。</p><p id="bf1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些变化将使应用程序的速度提高3倍。</p><h1 id="4abf" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">确保我们的应用程序自动重启</h1><p id="7a46" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当出现错误时，我们的应用程序应该会自动重启。</p><p id="7f3f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样崩溃的时候就不会下线了。</p><p id="0965" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过流程管理器来实现这一点。</p><p id="e991" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当节点应用程序崩溃时，它会重新启动应用程序。</p><p id="7122" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的操作系统提供的init系统可以在没有进程管理器的情况下重启进程。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/a333ef6b484328e4fb2f2b8ecaef47cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BgueNNyAPl5no1_h"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@sxy_selia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sangga Rima Roman Selia</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="273d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2b78" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该做一些像gzip压缩这样的基本改变，确保自动重启，并捕捉错误。</p><h2 id="9bd4" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript</strong></h2><p id="4f52" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>