<html>
<head>
<title>My First Foray into Serverless with AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我第一次使用AWS尝试无服务器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/my-first-foray-into-serverless-with-aws-3d7ff9df8460?source=collection_archive---------7-----------------------#2020-06-03">https://javascript.plainenglish.io/my-first-foray-into-serverless-with-aws-3d7ff9df8460?source=collection_archive---------7-----------------------#2020-06-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b002" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这一切都是从我妻子说她想要一个网站开始的，在那里她可以输入一种成分，并看到该成分从体积到重量的转换。例如，她想查找砂糖，看到一杯糖是200克。经过一系列的研究，搜索，<a class="ae ki" href="https://stackoverflow.com/" rel="noopener ugc nofollow" target="_blank">栈溢出</a>阅读，学习，我创造了<a class="ae ki" href="https://volumeweightconversion.com/" rel="noopener ugc nofollow" target="_blank">体积重量转换</a>。</p><p id="8958" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你是那种喜欢这种<a class="ae ki" href="https://www.urbandictionary.com/define.php?term=TLDR" rel="noopener ugc nofollow" target="_blank"> TLDR </a>版本的人，我使用<a class="ae ki" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>为API层创建了<a class="ae ki" href="https://volumeweightconversion.com/" rel="noopener ugc nofollow" target="_blank">https://volumeweightconversion.com/</a>，并使用以下架构为云创建了AWS:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/382dbb034059a36926baacb317f2c110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2xdtmFPTIwQo_aFG"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Single Page Webapp in Serverless on AWS</figcaption></figure><p id="c412" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你还和我在一起，我需要弄清楚从哪里获取数据，然后创建一个API来访问它，创建一个前端来调用API，并在一个网站中将它们连接在一起。</p><h1 id="4a4e" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">数据</h1><p id="61e4" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">使用谷歌，我发现一些网站已经有类似的体积重量信息，但它们的广告太多，性能和格式也不是很好。我还找到了一个包含这些数据的API，所以我可以调用第三方，但这个练习的一部分也是为了我在无服务器和AWS方面的教育，所以我决定继续寻找。我最终发现了美国农业部发布的一个很棒的数据集，叫做国家营养数据库标准参考。</p><p id="e8de" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了我的数据，我现在必须弄清楚如何把它变成一个应用程序。首先，我需要找到存放它的地方。亚马逊提供了许多不同的数据库，具有不同程度的无服务器功能，但由于我也试图保持低成本并快速完成这项工作，我选择了我知道并喜欢的数据库，即RDS上的<a class="ae ki" href="https://aws.amazon.com/rds/postgresql/" rel="noopener ugc nofollow" target="_blank">Postgres</a>，因为它有一个免费层，而且我最熟悉Postgres。使这变得更容易的是，数据集已经被规范化了，模式被记录了下来，并且很容易为关系数据存储而构建。</p><p id="21c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">也许对于这个应用程序的第二次迭代，我会看看我是否可以将数据存储移动到<a class="ae ki" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>，使用<a class="ae ki" href="https://aws.amazon.com/elasticache/redis/" rel="noopener ugc nofollow" target="_blank"> Redis </a>在内存中缓存整个数据集，或者如果足够快，也许可以尝试<a class="ae ki" href="https://aws.amazon.com/blogs/aws/s3-glacier-select/" rel="noopener ugc nofollow" target="_blank"> S3选择</a>。</p><p id="597b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我目前使用的数据库应用程序是<a class="ae ki" href="https://dbeaver.io/" rel="noopener ugc nofollow" target="_blank"> DBeaver </a>，它提供了一个社区版本。所以我启动了它，阅读了发布的模式文档，创建了表、主键/外键关系、数据类型，并使用下面显示的方便的导入工具批量加载了提供的CSV。对于QA，我仔细检查了行数，以确保数据按预期加载。将来，我可能会使用一个<a class="ae ki" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank">阶跃函数</a>，它会定期调用Lambda来自动检查新的数据集，下载它并自动加载CSV。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/3f377d07cfdaf185cf354dcd89cf4a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/0*E-blSbSJlTX5hmLn"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">DBeaver bulk import dialog</figcaption></figure><p id="5e3f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">经过一些迭代，编写一些查询来提取我正在寻找的信息，我需要构建一个接口来以编程方式安全地提取数据，所以我当然选择了<a class="ae ki" href="https://aws.amazon.com/lambda/features/" rel="noopener ugc nofollow" target="_blank"> Lambda </a>函数。我第一次尝试Python，但是无法让<a class="ae ki" href="https://github.com/jkehler/awslambda-psycopg2" rel="noopener ugc nofollow" target="_blank"> psycopg2 </a> postgres数据库连接库在我的lambda函数中工作。我也试图从源代码中构建一个，但我不确定lambda使用的是哪种linux风格/版本，我试图快速完成这个任务。我能够找到一个<a class="ae ki" href="https://node-postgres.com/" rel="noopener ugc nofollow" target="_blank">节点库</a>来轻松连接到Postgres，所以我用node来编写API。</p><h1 id="1748" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">应用程序接口</h1><p id="bd68" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我发现<a class="ae ki" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">serverless.com</a>提供了一个很棒的基于节点的框架，并且可以部署一个栈到<a class="ae ki" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation </a>和其他云提供商，以便于移植。我发现了这个很棒的使用无服务器框架的一步一步作为起点:<a class="ae ki" href="https://hackernoon.com/how-to-deploy-a-node-js-application-to-aws-lambda-using-serverless-ae7e7ebe0996" rel="noopener ugc nofollow" target="_blank">https://hacker noon . com/how-to-deploy-a-node-js-application-to-AWS-lambda-using-server less-AE 7 e 7 ebe 0996</a></p><p id="6a48" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另一个很好的基本介绍是:<br/><a class="ae ki" href="https://blog.cloudboost.io/how-to-create-serverless-node-js-apps-with-aws-lambda-d5ab23be0cfb" rel="noopener ugc nofollow" target="_blank">https://blog . cloudboost . io/如何创建无服务器节点-js-app-with-AWS-lambda-d5ab 23 be 0 CFB</a></p><p id="18ce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当所有的话都说完了，我的无服务器. yml看起来如下。</p><pre class="kk kl km kn gt md me mf mg aw mh bi"><span id="fbaf" class="mi la in me b gy mj mk l ml mm">service: serverless-nodejs-app<br/>custom:<br/>   stage: ${opt:stage, self:provider.stage}<br/>   private: true<br/>secrets: ${file(secrets.json)}<br/>provider:<br/>   name: aws<br/>   runtime: nodejs12.x<br/>   memorySize: 128 # optional, in MB, default is 1024<br/>   timeout: 5 # optional, in seconds, default is 6<br/>   apiKeys:<br/>      - ${self:service}-${self:custom.stage}-api-key<br/>stage: dev<br/>region: us-east-2</span><span id="43de" class="mi la in me b gy mn mk l ml mm"># TODO: There is probably a better way to store and encrypt these.<br/>environment:<br/>   PGDATABASE: "&lt;my_postrges_database_name&gt;"<br/>   PGHOST: "&lt;my_postgres_host_here&gt;.us-east-2.rds.amazonaws.com"<br/>   PGPASSWORD: "<em class="mo">&lt;my_postgres_password_here&gt;</em>"<br/>   PGPORT: "5432"<br/>   PGUSER: "&lt;my_postgres_username&gt;"</span><span id="70cc" class="mi la in me b gy mn mk l ml mm">functions:<br/>   app:<br/>   handler: app.server<br/>   events:<br/>      - http: # this is an API gateway HTTP event trigger<br/>         path: /<br/>         method: ANY<br/>         cors: true<br/>         private: ${self:custom.private}<br/>      - http: # all routes get proxied to the Express router<br/>         path: /{proxy+}<br/>         method: ANY<br/>         cors: true<br/>         private: ${self:custom.private}</span></pre><p id="91cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">经过大量的迭代、开发和学习，我终于可以调用我的Lambda并得到结果了。</p><p id="4af7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一步是让它可以公开访问，更安全一点，并通过我的域调用它。合适的工具是<a class="ae ki" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API Gateway </a>和<a class="ae ki" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> Route 53 </a>(在我的例子中)。对于API Gateway，我不需要做什么，因为无服务器框架为我生成了它以及用于快速部署的API键。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mp"><img src="../Images/cc8e6c0ca1c3022053ffa66a0671bf06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8We-yCXhN5sDEe6C"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">API Gateway Configuration with Serverless</figcaption></figure><h2 id="5d19" class="mi la in bd lb mq mr dn lf ms mt dp lj jv mu mv ln jz mw mx lr kd my mz lv na bi translated">克-奥二氏分级量表</h2><p id="b769" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我必须弄清楚如何通过53号公路、API Gateway、Lambda实现跨来源资源共享(CORS)。我最终通过API Gateway接口启用了CORS，如下所示，但我不确定我是否需要这样做。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/a10465ce8ab6357d3ef666fc0f0d923c.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/0*xLChcCS6P5R4G-mG"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Enable CORS in API Gateway</figcaption></figure><p id="23bf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于这是一个代理，lambda函数需要将CORS头传递回来。在部署到CloudFront之前，我想通过S3托管的静态代码调用我的API，所以我在Node应用程序中添加了一些原始处理逻辑，允许我直接从S3的浏览器轻松调试。</p><pre class="kk kl km kn gt md me mf mg aw mh bi"><span id="c157" class="mi la in me b gy mj mk l ml mm">var allow_origin = "https://volumeweightconversion.com"</span><span id="42f3" class="mi la in me b gy mn mk l ml mm">if (req.headers.origin == "&lt;MY_S3_BUCKET__REGION&gt;"){</span><span id="7aec" class="mi la in me b gy mn mk l ml mm">allow_origin = req.headers.origin;</span><span id="f7f7" class="mi la in me b gy mn mk l ml mm">}</span><span id="0444" class="mi la in me b gy mn mk l ml mm">res.setHeader('Content-Type', 'application/json');<br/>  res.setHeader('Access-Control-Allow-Origin', allow_origin);</span></pre><h2 id="1282" class="mi la in bd lb mq mr dn lf ms mt dp lj jv mu mv ln jz mw mx lr kd my mz lv na bi translated">应用编程接口网关自定义域</h2><p id="b9fd" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在设置API Gateway自定义域时，我必须按照下图所示进行配置，否则无法正常工作。我最初将<em class="mo"> Path </em>值设置为<strong class="jm io"> dev </strong>以为我会通过<a class="ae ki" href="https://api.volumeweightconversion.com/dev/" rel="noopener ugc nofollow" target="_blank">https://api.volumeweightconversion.com/dev/</a>调用我的API端点，但是当下面的方法奏效时，我无法让它生效并继续前进。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nc"><img src="../Images/d5a4bd0af22cc21c5305ab7bef928508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YttP_4fHmxbVVx2c"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">API Mappings in API Gateway Custom Domain</figcaption></figure><p id="e48b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我需要注册我的域名，所以我通过53号公路注册了，并建立了指向我的服务的ARNs的各种记录。因为我希望我的网站是安全的，我还必须添加DNS记录来显示我拥有AWS <a class="ae ki" href="https://aws.amazon.com/certificate-manager/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>提供证书的域。</p><p id="1f46" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此时我能够调用我的API并看到来自<a class="ae ki" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">邮差</a>的响应，简单的<em class="mo">卷曲</em>如下:</p><pre class="kk kl km kn gt md me mf mg aw mh bi"><span id="1d6e" class="mi la in me b gy mj mk l ml mm">curl --location --request POST 'https://api.volumeweightconversion.com/' --header 'x-api-key: &lt;my_api_key&gt;' --header 'Content-Type: application/json' --data-raw '{"food":"rice"}'</span></pre><h1 id="9997" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">网络应用</h1><p id="d259" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">现在我有了API设置，我需要一个实际的web应用程序来调用它。为此我使用了S3静态网站托管和Cloudfront。需要注意的是，我必须创建一个单独的、空的、公共的S3桶，以便设置从<a class="ae ki" href="http://www.volumeweightconversion.com" rel="noopener ugc nofollow" target="_blank">www.volumeweightconversion.com</a>到根volumeweightconversion.com的重定向，如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/45276c6a4fb47bb843b3335d699149a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/0*INHqQ9P7Ji5Kj4Cw"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">How to redirect <a class="ae ki" href="http://www.volumeweightconversion.com" rel="noopener ugc nofollow" target="_blank">www.volumeweightconversion.com</a> to volumeweightconversion.com</figcaption></figure><p id="51a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在决定使用<a class="ae ki" href="https://getbootstrap.com/" rel="noopener ugc nofollow" target="_blank"> Bootstrap </a>、<a class="ae ki" href="https://jquery.com/" rel="noopener ugc nofollow" target="_blank"> JQuery </a>和<a class="ae ki" href="https://mdbootstrap.com" rel="noopener ugc nofollow" target="_blank"> MDBootstrap </a>之后，我开始尝试正确地呈现表格，验证我的输入，并学习如何使用这个堆栈进行调试。虽然我在职业生涯中做过一些UI开发，但我绝不是UI专家，所以我遇到了一些需要解决的UI问题，包括下面这个有趣的截图，我错误地将一个表格附加到了一个旋转图标上。建议看书，找样本，知道谷歌是你的朋友。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ne"><img src="../Images/36686f50b311fc2b78075125f87b9831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EzbQFvXvdc72QH4j"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">When you mistakenly attach a table to rotating icon.</figcaption></figure><p id="1079" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我发现的一个很棒的调试工具是<a class="ae ki" href="https://dashbird.io/" rel="noopener ugc nofollow" target="_blank"> Dashbird.io </a>,因为它们让我很容易看到在我迭代开发时发生的错误。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nf"><img src="../Images/19972c4bf9dfe34120facab425c3ce19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GRxs33yX7KsLdfiM"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Very helpful Dashbird.io UI</figcaption></figure></div><div class="ab cl ng nh hr ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ig ih ii ij ik"><h1 id="9ac2" class="kz la in bd lb lc nn le lf lg no li lj lk np lm ln lo nq lq lr ls nr lu lv lw bi translated">最后的想法</h1><p id="7779" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我能够让所有东西都连接起来并正常工作。我在下面附上了一些写这篇文章时的截图。随着时间的推移，我可能会继续添加功能和迭代更多，因为人总是可以改进的。也许我会尝试react-native来构建一些移动应用程序，尝试使用Redis在搜索栏中自动完成，或者添加更多的特性和功能。我真的很喜欢它是如何快速和容易地启动这个应用程序，并认为无服务器是一个非常强大的工具，快速和容易地启动应用程序。如果您有任何问题，或者希望我进一步深入到这一部分，请随时提问！</p><div class="ns nt gp gr nu nv"><a href="https://volumeweightconversion.com" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">搜索食物成分和重量换算</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">单击带有图标的行，查看该行的体积重量转换。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">volumeweightconversion.com</p></div></div></div></a></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oe"><img src="../Images/c5c3b0847f26075f3d0157cdb4a26d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tTa4PKU8mCSCVR4z"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Home Page</figcaption></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi of"><img src="../Images/bd9d1dda66865ee9a09c73ebcffc54a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zpDfTmsmYZFXtTvA"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Conversions Popup</figcaption></figure><h2 id="5070" class="mi la in bd lb mq mr dn lf ms mt dp lj jv mu mv ln jz mw mx lr kd my mz lv na bi translated"><strong class="ak">说白了</strong></h2><p id="45de" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">通过<a class="ae ki" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">订阅我们的YouTube频道</strong> </a> <strong class="jm io">来表达爱意吧！</strong></p></div></div>    
</body>
</html>