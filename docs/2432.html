<html>
<head>
<title>How to write tests for React in 2020 (Part Two)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为2020年的React编写测试(第二部分)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-write-tests-for-react-in-2020-8cf75cc73a33?source=collection_archive---------3-----------------------#2020-06-23">https://javascript.plainenglish.io/how-to-write-tests-for-react-in-2020-8cf75cc73a33?source=collection_archive---------3-----------------------#2020-06-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f57db7b0ee770011d428e39bbdaf34c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MCViBzgDOy13L4LLwclFxQ.jpeg"/></div></div></figure><blockquote class="jy jz ka"><p id="5e5f" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用React推荐库编写React测试——面向React中级用户的Jest &amp; Testing库。</p></blockquote><h1 id="a67a" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">清注意</h1><p id="efcb" class="pw-post-body-paragraph kb kc iq ke b kf ly kh ki kj lz kl km ma mb kp kq mc md kt ku me mf kx ky kz ij bi translated">在这篇文章中，我将探索React测试中更高级的概念，我希望它们对你的情况有所帮助。如果你是React的初学者或测试新手，我建议你在继续之前查看一下第一部分<a class="ae mg" href="https://medium.com/javascript-in-plain-english/how-to-write-tests-for-react-in-2020-b27485e47a06" rel="noopener"><em class="kd"/></a><em class="kd">，了解一些基础知识，谢谢！</em></p><h1 id="bbf5" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">首先，让我们看看可访问性测试。</h1><p id="6f5d" class="pw-post-body-paragraph kb kc iq ke b kf ly kh ki kj lz kl km ma mb kp kq mc md kt ku me mf kx ky kz ij bi translated">前端开发是所有关于可视化和与最终用户互动，可访问性测试可以确保我们的应用程序可以达到尽可能多的用户。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/1f8b281579e8b509d90ad4c9af62d6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H1hcXdy72xy5f02E.png"/></div></div></figure><p id="9fce" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="kd">出自—</em></strong><a class="ae mg" href="https://reactjs.org/docs/accessibility.html" rel="noopener ugc nofollow" target="_blank"><strong class="ke ir"><em class="kd">https://reactjs.org/docs/accessibility.html</em></strong></a></p><p id="daef" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">为你的应用程序的每个方面编写<strong class="ke ir">可访问性测试</strong>看起来很吓人，但是感谢<a class="ae mg" href="https://www.deque.com/company/" rel="noopener ugc nofollow" target="_blank">Deque Systems</a>——一家致力于通过提供免费在线获得的<a class="ae mg" href="https://blog.kelvinliang.cn/www.deque.com/axe/" rel="noopener ugc nofollow" target="_blank"> Axe </a>测试包来提高软件可访问性的公司，我们现在可以通过导入<a class="ae mg" href="https://www.npmjs.com/package/jest-axe" rel="noopener ugc nofollow" target="_blank"> Jest-axe </a>和Jest库来轻松利用世界各地许多高级开发人员的专业知识来测试web应用程序的可访问性。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="b742" class="mr lb iq mn b gy ms mt l mu mv">$ npm install --save-dev jest-axe</span></pre><p id="6e55" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">或者</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7689" class="mr lb iq mn b gy ms mt l mu mv">$ yarn add --dev jest-axe</span></pre><p id="8a82" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">随着软件包的安装，我们可以像这样将<strong class="ke ir">可访问性测试</strong>添加到项目中:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="d69c" class="mr lb iq mn b gy ms mt l mu mv">// App.test.js<br/>import React from 'react';<br/>import App from './App';<br/>import { render } from '@testing-library/react';<br/>import { axe, toHaveNoViolations } from 'jest-axe';<br/>expect.extend(toHaveNoViolations);</span><span id="3149" class="mr lb iq mn b gy mw mt l mu mv">describe('App', () =&gt; {<br/>  test('should have no accessibility violations', async () =&gt; {<br/>    const { container } = render(&lt;App /&gt;);<br/>    const results = await axe(container);<br/>    expect(results).toHaveNoViolations();<br/>  });<br/>});</span></pre><p id="317a" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">这将有助于确保您的前端开发符合最新版本的<a class="ae mg" href="https://www.w3.org/WAI/standards-guidelines/wcag/" rel="noopener ugc nofollow" target="_blank"> WCAG(网页内容无障碍指南)</a>。例如，如果您给导航栏组件分配了一个错误的角色，</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="16db" class="mr lb iq mn b gy ms mt l mu mv">// ./components/navBar.js<br/>...<br/>&lt;div className="navbar" role='nav'&gt;<br/>   ...<br/>&lt;/div&gt;<br/>...</span></pre><p id="d448" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">它会像下面这样提醒你:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/d438c4535aa860b176767837113e5ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wIHvNQu86Ecsed2q.png"/></div></div></figure><blockquote class="jy jz ka"><p id="b548" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="iq">点击</em>  <em class="iq">查看WAI-ARIA角色列表</em> <a class="ae mg" href="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles" rel="noopener ugc nofollow" target="_blank"> <em class="iq">。</em></a></p></blockquote><p id="6db8" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">将nav替换为导航角色，如下所示，测试将通过。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="aaf7" class="mr lb iq mn b gy ms mt l mu mv">// ./components/navBar.js<br/>...<br/>&lt;div className="navbar" role='navigation'&gt;<br/>   ...<br/>&lt;/div&gt;<br/>...</span></pre><p id="1ae7" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">正如我们在上面看到的，这个测试将有助于确保你遵循<a class="ae mg" href="https://www.w3.org/WAI/standards-guidelines/wcag/" rel="noopener ugc nofollow" target="_blank"> WCAG(网页内容可访问性指南)</a>标准，这样你的应用就可以被大多数人使用。</p><h1 id="249b" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第二，添加快照测试。</h1><blockquote class="jy jz ka"><p id="4cf5" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当你想确保你的用户界面不会发生意外变化时，快照测试是一个非常有用的工具。—摘自 <a class="ae mg" href="http://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Jest </em> </a></p></blockquote><p id="3f00" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated"><strong class="ke ir">你可以对整个应用程序或某个特定组件进行测试</strong>。在开发周期中，它们可以用于不同的目的，你可以使用快照测试来确保你的应用程序的用户界面不会随着时间的推移而改变，或者比较上一次快照与当前输出之间的差异来迭代你的开发。</p><p id="9f28" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">让我们以编写整个应用程序的测试为例，向您展示如何编写<strong class="ke ir">快照测试</strong>。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="91f6" class="mr lb iq mn b gy ms mt l mu mv">// App.test.js<br/>import React from 'react';<br/>import App from './App';</span><span id="63dd" class="mr lb iq mn b gy mw mt l mu mv">import renderer from 'react-test-renderer';<br/>...</span><span id="7cb0" class="mr lb iq mn b gy mw mt l mu mv">describe('App', () =&gt; {<br/>  ...</span><span id="f305" class="mr lb iq mn b gy mw mt l mu mv">  test('snapShot testing', () =&gt; {<br/>    const tree = renderer.create(&lt;App /&gt;).toJSON();<br/>    expect(tree).toMatchSnapshot();<br/>  });</span><span id="9733" class="mr lb iq mn b gy mw mt l mu mv">});</span></pre><p id="fa37" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">如果这是第一次运行这个测试，Jest将创建一个快照文件(一个文件夹“<code class="fe my mz na mn b">__snapshots__</code>”也将创建)，看起来像这样。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/13dd7971ae72cbdb9a46696d94dd67d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/0*MFS4N0vrJ7k5sEiR.png"/></div></figure><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="6b4e" class="mr lb iq mn b gy ms mt l mu mv">// App.test.js.snap<br/>// Jest Snapshot v1, https://goo.gl/fbAQLP</span><span id="9ae9" class="mr lb iq mn b gy mw mt l mu mv">exports[`App snapShot testing 1`] = `<br/>&lt;div<br/>  className="App"<br/>&gt;<br/>  &lt;div<br/>    className="navbar"<br/>  &gt;<br/>    ....</span></pre><p id="fbe3" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">有了这个测试，一旦您对DOM做了任何更改，测试将失败，并以美化的格式向您显示更改的内容，如下所示:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/02b1275e4c4f6f97c2a8b43a5c639508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v5EFQDfcC6cPiujk.png"/></div></div></figure><p id="a10f" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">在这种情况下，您可以按下<code class="fe my mz na mn b">u</code>来更新快照，或者更改您的代码以使测试再次通过。</p><blockquote class="jy jz ka"><p id="b2cb" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="iq">如果您在开发的早期阶段添加了一个快照测试，您可能想要通过在测试前添加</em> <code class="fe my mz na mn b"><em class="iq">x</em></code> <em class="iq">来暂时关闭测试，以避免出现太多的错误并减慢进程。</em></p></blockquote><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="db1f" class="mr lb iq mn b gy ms mt l mu mv">xtest('should have no accessibility violations', async () =&gt; {<br/>   ...<br/>  });</span></pre><h1 id="7eb9" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第三，让我们看看如何用API调用测试一个UI。</h1><p id="a8fe" class="pw-post-body-paragraph kb kc iq ke b kf ly kh ki kj lz kl km ma mb kp kq mc md kt ku me mf kx ky kz ij bi translated">现在前端UI在呈现页面之前必须从API获取一些数据是很常见的。对于今天的前端开发来说，编写测试变得更加重要。</p><p id="620e" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">首先，让我们看看这个过程，并考虑如何测试它。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/20f9efc50496f47966e2629b1f193b26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jzxRvs9cmfA91nII.png"/></div></div></figure><ol class=""><li id="ad75" class="nd ne iq ke b kf kg kj kk ma nf mc ng me nh kz ni nj nk nl bi translated">当一个条件被满足时(比如点击一个按钮或者加载的页面)，一个API调用将被触发；</li><li id="2e54" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz ni nj nk nl bi translated">当数据从API返回时，通常响应需要在进入下一步之前进行解析(可选)；</li><li id="fca5" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz ni nj nk nl bi translated">当有适当的数据时，浏览器开始相应地呈现数据；</li><li id="c847" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz ni nj nk nl bi translated">另一方面，如果出现问题，浏览器中应该会显示一条错误消息。</li></ol><p id="cb77" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">在前端开发中，我们可以测试如下内容:</p><ul class=""><li id="3a49" class="nd ne iq ke b kf kg kj kk ma nf mc ng me nh kz nr nj nk nl bi translated">响应是否被正确解析？</li><li id="fe4e" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated">数据是否正确地呈现在浏览器的正确位置？</li><li id="ee1d" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated">出错时浏览器是否显示错误信息？</li></ul><p id="82e2" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">但是，我们不应该:</p><ul class=""><li id="31d0" class="nd ne iq ke b kf kg kj kk ma nf mc ng me nh kz nr nj nk nl bi translated">测试API调用</li><li id="63a4" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated">调用真正的API进行测试</li></ul><blockquote class="jy jz ka"><p id="fd89" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="iq">因为大部分时候API是第三方托管的，取数据的时间是不可控的。此外，对于一些API，给定相同的参数，返回的数据可能不同，这将使测试结果不可预测。</em></p></blockquote><p id="193e" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">对于使用API的测试，我们应该:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/32617a369bb64f86fef736d6c2c01f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PsqTSHg-ZrD4EVyE.png"/></div></div></figure><ul class=""><li id="5148" class="nd ne iq ke b kf kg kj kk ma nf mc ng me nh kz nr nj nk nl bi translated">使用模拟API进行测试并返回fack数据</li><li id="0e1c" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated">使用假数据来比较UI元素，看它们是否匹配</li></ul><p id="a9c6" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="kd">如果你有想法，让我们开始真正的代码实践。</em> </strong></p><p id="ea3b" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">假设我们想要测试下面的<strong class="ke ir">新闻页面</strong>组件，它从<code class="fe my mz na mn b">getNews</code> API调用中获取新闻并在浏览器上呈现它们。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="016e" class="mr lb iq mn b gy ms mt l mu mv">// ./page/News.js<br/>import React, { useState, useEffect } from 'react';<br/>import getNews from '../helpers/getNews';<br/>import NewsTable from '../components/newsTable';</span><span id="375f" class="mr lb iq mn b gy mw mt l mu mv">export default () =&gt; {<br/>  const [posts, setPosts] = useState([]);<br/>  const [loading, setLoading] = useState(true);<br/>  const [errorMsg, setErrorMsg] = useState('');<br/>  const subreddit = 'reactjs';</span><span id="597a" class="mr lb iq mn b gy mw mt l mu mv">  useEffect(() =&gt; {<br/>    getNews(subreddit)<br/>      .then(res =&gt; {<br/>        if (res.length &gt; 0) {<br/>          setPosts(res);<br/>        } else {<br/>          throw new Error('No such subreddit!');<br/>        }<br/>      })<br/>      .catch(e =&gt; {<br/>        setErrorMsg(e.message);<br/>      })<br/>      .finally(() =&gt; {<br/>        setLoading(false);<br/>      });<br/>  }, [])</span><span id="70b5" class="mr lb iq mn b gy mw mt l mu mv">  return (<br/>    &lt;&gt;<br/>      &lt;h1&gt;What is News Lately?&lt;/h1&gt;<br/>      &lt;div&gt;<br/>        {loading &amp;&amp; 'Loading news ...'}<br/>        {errorMsg &amp;&amp; &lt;p&gt;{errorMsg}&lt;/p&gt;}<br/>        {!errorMsg &amp;&amp; !loading &amp;&amp; &lt;NewsTable news={posts} subreddit={subreddit} /&gt;}<br/>      &lt;/div&gt;<br/>    &lt;/&gt;<br/>  )<br/>}</span></pre><p id="83dd" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">首先，让我们在API调用文件所在的位置创建一个<code class="fe my mz na mn b">__mocks__</code>文件夹。(在我们的例子中，API调用文件call <code class="fe my mz na mn b"><strong class="ke ir">getNews.js</strong></code>)，在这个文件夹中创建同名的模拟API调用文件。最后，在这个文件夹中准备一些模拟数据。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/609ba5c77cbaebc10411b0a912a2847f.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/0*WrAr2zHI6Sh0vC4v.png"/></div></figure><p id="5c4e" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated"><strong class="ke ir">模拟API </strong>文件(<code class="fe my mz na mn b">getNews.js</code>)应该如下所示</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="bbeb" class="mr lb iq mn b gy ms mt l mu mv">// ./helpers/__mocks__/getNews.js<br/>import mockPosts from './mockPosts_music.json';</span><span id="c2e7" class="mr lb iq mn b gy mw mt l mu mv">// Check if you are using the mock API file, can remove it later<br/>console.log('use mock api'); </span><span id="2395" class="mr lb iq mn b gy mw mt l mu mv">export default () =&gt; Promise.resolve(mockPosts);</span></pre><p id="e940" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">与真实API调用的比较</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="a954" class="mr lb iq mn b gy ms mt l mu mv">// ./helpers/getNews.js<br/>import axios from 'axios';<br/>import dayjs from 'dayjs';</span><span id="08ac" class="mr lb iq mn b gy mw mt l mu mv">// API Reference - https://reddit-api.readthedocs.io/en/latest/#searching-submissions</span><span id="634a" class="mr lb iq mn b gy mw mt l mu mv">const BASE_URL = 'https://api.pushshift.io/reddit/submission/search/';</span><span id="7e28" class="mr lb iq mn b gy mw mt l mu mv">export default async (subreddit) =&gt; {<br/>  const threeMonthAgo = dayjs().subtract(3, 'months').unix();<br/>  const numberOfPosts = 5;</span><span id="f223" class="mr lb iq mn b gy mw mt l mu mv">  const url = `${BASE_URL}?subreddit=${subreddit}&amp;after=${threeMonthAgo}&amp;size=${numberOfPosts}&amp;sort=desc&amp;sort_type=score`;</span><span id="092b" class="mr lb iq mn b gy mw mt l mu mv">  try {<br/>    const response = await axios.get(url);<br/>    if (response.status === 200) {<br/>      return response.data.data.reduce((result, post) =&gt; {<br/>        result.push({<br/>          id: post.id,<br/>          title: post.title,<br/>          full_link: post.full_link,<br/>          created_utc: post.created_utc,<br/>          score: post.score,<br/>          num_comments: post.num_comments,<br/>          author: post.author,<br/>        });<br/>        return result;<br/>      }, []);<br/>    }<br/>  } catch (error) {<br/>    throw new Error(error.message);<br/>  }<br/>  return null;<br/>};</span></pre><p id="159f" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">从上面的代码中我们可以看到，a <code class="fe my mz na mn b">mock API call</code>只是简单地返回一个解析后的模拟数据，而a <code class="fe my mz na mn b">real API call</code>需要在每次测试运行时上线并获取数据。</p><p id="23ab" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">准备好模拟API和模拟数据后，我们现在开始编写测试。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="43f2" class="mr lb iq mn b gy ms mt l mu mv">// ./page/News.test.js<br/>import React from 'react';<br/>import { render, screen, act } from '@testing-library/react';<br/>import { BrowserRouter as Router } from "react-router-dom";<br/>import News from './News';</span><span id="e75f" class="mr lb iq mn b gy mw mt l mu mv">jest.mock('../helpers/getNews');  //adding this line before any test.</span><span id="4075" class="mr lb iq mn b gy mw mt l mu mv">// I make this setup function to simplify repeated code later use in tests.<br/>const setup = (component) =&gt; (<br/>  render(<br/>   // for react-router working properly in this component<br/>  // if you don't use react-router in your project, you don't need it.<br/>    &lt;Router&gt;<br/>      {component}<br/>    &lt;/Router&gt;<br/>  )<br/>);</span><span id="2cdd" class="mr lb iq mn b gy mw mt l mu mv">...</span></pre><blockquote class="jy jz ka"><p id="c5d2" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="iq">请注意:</em> </strong></p></blockquote><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="84af" class="mr lb iq mn b gy ms mt l mu mv">jest.mock('../helpers/getNews');</span></pre><blockquote class="jy jz ka"><p id="54c9" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="iq">请将上述代码添加到每个可能触发API调用的测试文件的开头，而不仅仅是API测试文件。我在没有任何通知的情况下开始犯这个错误，直到我添加console.log('call real API ')来监视测试期间的调用。</em></p></blockquote><p id="523e" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">接下来，我们开始编写一个简单的测试来检查标题和加载消息是否正确显示。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="d3cd" class="mr lb iq mn b gy ms mt l mu mv">// ./page/News.test.js<br/>...<br/>describe('News Page', () =&gt; {<br/>  test('load title and show status', async () =&gt; {<br/>    setup(&lt;News /&gt;);  //I use setup function to simplify the code.<br/>    screen.getByText('What is News Lately?'); // check if the title show up<br/>    await waitForElementToBeRemoved(() =&gt; screen.getByText('Loading news ...'));<br/>  });<br/>...<br/>});</span></pre><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/e35067ffc1dd66c29865d5501f1658fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/0*4DUdRDzbShq5bFIw.png"/></div></figure><p id="f9a2" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">调用模拟API并按照预期呈现页面。我们现在可以继续编写更复杂的测试。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1cf6" class="mr lb iq mn b gy ms mt l mu mv">...<br/>test('load news from api correctly', async () =&gt; {<br/>    setup(&lt;News /&gt;);<br/>    screen.getByText('What is News Lately?');</span><span id="db57" class="mr lb iq mn b gy mw mt l mu mv">    // wait for API get data back<br/>    await waitForElementToBeRemoved(() =&gt; screen.getByText('Loading news ...'));</span><span id="03ba" class="mr lb iq mn b gy mw mt l mu mv">    screen.getByRole("table");  //check if a table show in UI now<br/>    const rows = screen.getAllByRole("row");  // get all news from the table</span><span id="d9f2" class="mr lb iq mn b gy mw mt l mu mv">    mockNews.forEach((post, index) =&gt; {<br/>      const row = rows[index + 1];  // ignore the header row</span><span id="eed2" class="mr lb iq mn b gy mw mt l mu mv">       // use 'within' limit search range, it is possible have same author for different post<br/>      within(row).getByText(post.title);  // compare row text with mock data <br/>      within(row).getByText(post.author); <br/>    })</span><span id="79ac" class="mr lb iq mn b gy mw mt l mu mv">    expect(getNews).toHaveBeenCalledTimes(1); // I expect the Mock API only been call once<br/>    screen.debug(); // Optionally, you can use debug to print out the whole dom<br/>  });<br/>...</span></pre><blockquote class="jy jz ka"><p id="ca43" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="iq">请注意</em> </strong></p></blockquote><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="5e08" class="mr lb iq mn b gy ms mt l mu mv">expect(getNews).toHaveBeenCalledTimes(1);</span></pre><blockquote class="jy jz ka"><p id="54e2" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="iq">这段代码对于确保API调用只按预期调用是必不可少的。</em></p></blockquote><p id="c356" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">当这个API调用测试相应地通过时，我们就可以开始探索更令人兴奋的东西了！</p><p id="bd43" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">众所周知，一个API调用有时会因为各种原因出错，我们该如何测试它呢？ </p><p id="0537" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">为此，我们需要首先重写模拟API文件。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="dbce" class="mr lb iq mn b gy ms mt l mu mv">// // ./helpers/__mocks__/getNews.js<br/>console.log('use mock api');  // optionally put here to check if the app calling the Mock API<br/>// check more about mock functions at https://jestjs.io/docs/en/mock-function-api<br/>const getNews = jest.fn().mockResolvedValue([]); <br/>export default getNews;</span></pre><p id="71e5" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">然后我们需要在<code class="fe my mz na mn b">News.test.js</code>文件中重新编写设置函数。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2076" class="mr lb iq mn b gy ms mt l mu mv">// ./page/News.test.js<br/>...<br/>// need to import mock data and getNews function<br/>import mockNews from '../helpers/__mocks__/mockPosts_music.json';<br/>import getNews from '../helpers/getNews';<br/>...<br/>// now we need to pass state and data to the initial setup<br/>const setup = (component,  state = 'pass', data = mockNews) =&gt; {<br/>  if (state === 'pass') {<br/>    getNews.mockResolvedValueOnce(data);<br/>  } else if (state === 'fail') {<br/>    getNews.mockRejectedValue(new Error(data[0]));<br/>  }</span><span id="df71" class="mr lb iq mn b gy mw mt l mu mv">  return (<br/>    render(<br/>      &lt;Router&gt;<br/>        {component}<br/>      &lt;/Router&gt;<br/>    ))<br/>};<br/>...</span></pre><p id="43b8" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">我在这里将默认值传递到设置函数中，因此您不必更改之前的测试。但是我确实建议在测试中传递它们，以使测试更具可读性。</p><p id="69c5" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">现在，让我们编写API失败的测试。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="f503" class="mr lb iq mn b gy ms mt l mu mv">// ./page/News.test.js<br/>...<br/>test('load news with network errors', async () =&gt; {<br/>    // pass whatever error message you want here.<br/>    setup(&lt;News /&gt;, 'fail', ['network error']);<br/>    screen.getByText('What is News Lately?');</span><span id="dd45" class="mr lb iq mn b gy mw mt l mu mv">    await waitForElementToBeRemoved(() =&gt; screen.getByText('Loading news ...'));<br/>    screen.getByText('network error');</span><span id="ea44" class="mr lb iq mn b gy mw mt l mu mv">    expect(getNews).toHaveBeenCalledTimes(1);<br/>  })<br/>...</span></pre><p id="566a" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">最后，你可以从<a class="ae mg" href="https://github.com/kelvin8773/react-test-examples/blob/master/src/pages/News.test.js" rel="noopener ugc nofollow" target="_blank">这里</a>找到完整的测试代码。</p><blockquote class="jy jz ka"><p id="b817" class="kb kc kd ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="iq">请注意</em> </strong> <em class="iq"> <br/>它们只是用于演示目的的简单测试用例，在真实场景中，测试会复杂得多。你可以在这里</em>  <em class="iq">查看我的另一个项目</em> <a class="ae mg" href="https://github.com/ooloo-io/reddit-timer-kelvin8773" rel="noopener ugc nofollow" target="_blank"> <em class="iq">的更多测试示例。</em></a></p></blockquote></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/1fed30d099487583fd8d46201f5cc219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AcX653G8OmgaqtVo.jpg"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk">Photo by <a class="ae mg" href="https://unsplash.com/@thisisengineering" rel="noopener ugc nofollow" target="_blank">ThisisEngineering RAEng</a> on <strong class="bd of">Unsplash</strong></figcaption></figure><h1 id="99c7" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">最后的话</h1><p id="784f" class="pw-post-body-paragraph kb kc iq ke b kf ly kh ki kj lz kl km ma mb kp kq mc md kt ku me mf kx ky kz ij bi translated">在本文中，我遵循了Kent C. Dodds在他2020年5月发表的博客文章—<a class="ae mg" href="https://kentcdodds.com/blog/common-mistakes-with-react-testing-library" rel="noopener ugc nofollow" target="_blank">React测试库的常见错误</a>中建议的最佳实践，在这篇文章中，您可能会发现我的代码与<a class="ae mg" href="https://testing-library.com/docs/react-testing-library/example-intro" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">测试库示例</strong> </a>略有不同(我认为不久Kent也会更新文档)，但我相信这应该是我们在2020年及以后编写测试的方式。</p><p id="e767" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">我在这个项目中同时使用了<a class="ae mg" href="https://testing-library.com/docs/react-testing-library/example-intro" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">样式化组件</strong> </a>和内嵌样式来使UI看起来更好，但这不是必须的，你可以在react中自由使用任何CSS框架，这不会影响测试。</p><p id="96fd" class="pw-post-body-paragraph kb kc iq ke b kf kg kh ki kj kk kl km ma ko kp kq mc ks kt ku me kw kx ky kz ij bi translated">最后，<strong class="ke ir"> <em class="kd">测试</em> </strong>是前端开发中的一个高级课题，我只接触了很少的几个方面，还在学习中。如果你和我一样，刚刚开始，我建议你使用这里的例子或者我以前的文章中的一些例子来做你的个人项目。一旦你掌握了基本原理，你就可以开始探索市场上更多的替代品，找到最适合你的需求。</p><h1 id="b1bd" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">以下是我推荐的一些继续学习的资源:</h1><ul class=""><li id="d42d" class="nd ne iq ke b kf ly kj lz ma og mc oh me oi kz nr nj nk nl bi translated"><a class="ae mg" href="https://create-react-app.dev/docs/running-tests" rel="noopener ugc nofollow" target="_blank">来自Create React应用程序的测试</a></li><li id="e4dc" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://testing-library.com/docs/guide-which-query" rel="noopener ugc nofollow" target="_blank">我应该使用测试库中的哪个查询</a></li><li id="4761" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://testing-library.com/docs/example-codesandbox" rel="noopener ugc nofollow" target="_blank">测试库中的更多示例</a></li><li id="5422" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://redux.js.org/recipes/writing-tests" rel="noopener ugc nofollow" target="_blank">从Redux.js中为Redux编写测试</a></li><li id="155a" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://www.gatsbyjs.org/docs/unit-testing/" rel="noopener ugc nofollow" target="_blank">来自Gatsby.js的单元测试</a></li><li id="a7c5" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://kentcdodds.com/blog/effective-snapshot-testing" rel="noopener ugc nofollow" target="_blank">有效的快照测试</a>来自<a class="ae mg" href="https://kentcdodds.com/" rel="noopener ugc nofollow" target="_blank">肯特·C·多兹</a>。</li></ul><h1 id="82a6" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">我引用的参考资料和文章完成了本文:</h1><ul class=""><li id="fc26" class="nd ne iq ke b kf ly kj lz ma og mc oh me oi kz nr nj nk nl bi translated"><a class="ae mg" href="https://dev.to/jkettmann/inside-a-dev-s-mind-refactoring-and-debugging-a-react-test-2jap" rel="noopener ugc nofollow" target="_blank">在开发人员的头脑中——重构和调试React测试</a>作者<a class="ae mg" href="https://dev.to/jkettmann" rel="noopener ugc nofollow" target="_blank"> Johannes Kettmann </a>。</li><li id="7b5f" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://jkettmann.com/dont-useeffect-as-callback/" rel="noopener ugc nofollow" target="_blank">不要用Effect做回调！</a>作者<a class="ae mg" href="https://dev.to/jkettmann" rel="noopener ugc nofollow" target="_blank">约翰内斯·凯特曼</a>。</li><li id="6b0d" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://kentcdodds.com/blog/common-mistakes-with-react-testing-library" rel="noopener ugc nofollow" target="_blank">Kent C . Dodds</a>的React测试库的常见错误。</li><li id="38a5" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://kentcdodds.com/blog/fix-the-not-wrapped-in-act-warning" rel="noopener ugc nofollow" target="_blank">用<a class="ae mg" href="https://kentcdodds.com/" rel="noopener ugc nofollow" target="_blank"> Kent C.Dodds </a>固定未包裹动作警告</a>。</li><li id="8efd" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://reactjs.org/docs/accessibility.html" rel="noopener ugc nofollow" target="_blank">React</a>的可达性。</li><li id="47a5" class="nd ne iq ke b kf nm kj nn ma no mc np me nq kz nr nj nk nl bi translated"><a class="ae mg" href="https://www.npmjs.com/package/jest-axe" rel="noopener ugc nofollow" target="_blank">玩笑之斧</a>。</li></ul><h2 id="6f05" class="mr lb iq bd lc oj ok dn lg ol om dp lk ma on oo lo mc op oq ls me or os lw ot bi translated">特别感谢Johannes Kettmann和他的课程。</h2></div></div>    
</body>
</html>