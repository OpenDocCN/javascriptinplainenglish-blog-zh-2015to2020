<html>
<head>
<title>How To Cancel An Async Promise with AbortController</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用AbortController取消异步承诺</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-cancel-async-promise-with-abortcontroller-1e266859615c?source=collection_archive---------4-----------------------#2020-12-01">https://javascript.plainenglish.io/how-to-cancel-async-promise-with-abortcontroller-1e266859615c?source=collection_archive---------4-----------------------#2020-12-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5ff5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用AbortController取消提取请求</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aad1583a6caf327d44c6df56723b3779.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bca0f-JoRsYYoAAu"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@goshua13?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joshua Aragon</a></figcaption></figure><p id="db47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本帖中，我们将探讨<code class="fe ls lt lu lv b">AbortController</code>以及如何使用它来取消网络请求。</p><p id="5c5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们知道<code class="fe ls lt lu lv b">fetch</code>是一个发送网络请求并返回承诺的方法，但是如果我们想取消这个正在进行的请求呢？</p><p id="363b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，考虑这样一个场景，我们想要实现一个在用户输入时显示结果的搜索功能，但是用户的输入速度会因人而异，我们想要取消前面的请求。我们可以通过使用<code class="fe ls lt lu lv b">AbortController</code>最小化服务器请求的数量来做到这一点。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="c35d" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">句法</h1><p id="5802" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated"><code class="fe ls lt lu lv b">AbortController</code>是一个对象(控制器对象),允许您在需要时中止一个或多个请求(异步请求)。</p><ul class=""><li id="0ea3" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated"><code class="fe ls lt lu lv b">signal</code>允许在属性上设置事件监听器的属性。</li><li id="ebaa" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated"><code class="fe ls lt lu lv b">abort()</code>设置信号中止标志的方法</li></ul><p id="f3d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，当调用<code class="fe ls lt lu lv b">abort()</code>方法时，它会在DOM请求完成之前取消它，并将aborted标志设置为true。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="0f82" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">使用</h1><p id="84c4" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">通常，为了取消获取请求，我们需要执行3个步骤:</p><ol class=""><li id="337e" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr no ng nh ni bi translated">创建一个具有信号属性(只读属性)的<code class="fe ls lt lu lv b">AbortController</code>实例</li></ol><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="999f" class="nt me iq lv b gy nu nv l nw nx">// creare new object instance of abortContoller let aborter = new AbortController();</span></pre><p id="4e47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.传递<code class="fe ls lt lu lv b">signal</code>属性作为信号的提取选项</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="6098" class="nt me iq lv b gy nu nv l nw nx">// we get the signal and pass it to the fetch request as param<br/>let signal = aborter.signal; // signal is read only</span><span id="fe97" class="nt me iq lv b gy ny nv l nw nx">const url =<br/>  "<a class="ae kv" href="https://api.github.com/search/repositories?q=stars:%3E1+language:javascript&amp;sort=stars&amp;order=desc&amp;type=Repositories" rel="noopener ugc nofollow" target="_blank">https://api.github.com/search/repositories?q=stars:%3E1+language:javascript&amp;sort=stars&amp;order=desc&amp;type=Repositories</a>";</span><span id="13e2" class="nt me iq lv b gy ny nv l nw nx">fetch(url, {<br/>  method: "GET",<br/>  signal<br/>})<br/>  .then((response) =&gt; response.json())<br/>  .then((res) =&gt; {<br/>    aborter = null;<br/>    return res;<br/>  })<br/>  .catch((error) =&gt; {<br/>    if (error.name === "AbortError") return;<br/>    console.log("Error ", error);<br/>  });</span></pre><p id="19ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.调用abortController的<code class="fe ls lt lu lv b">abort()</code>方法来取消所有使用该信号的未决提取。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="9766" class="nt me iq lv b gy nu nv l nw nx">aborter.abort()</span></pre></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="e05b" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">例子</h1><p id="23a2" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">Tُhe以下代码片段显示了如何使用带有fetch的abortController。以下是完整的示例:</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="86c2" class="nt me iq lv b gy nu nv l nw nx">let aborter = null;<br/>const getRepos = (lang) =&gt; {<br/>  // cancel pending request if there is any<br/>  if (aborter) aborter.abort();<br/>  aborter = new AbortController();<br/>  let signal = aborter.signal;</span><span id="9493" class="nt me iq lv b gy ny nv l nw nx">const url = `<a class="ae kv" href="https://api.github.com/search/repositories?q=stars:%3E1+language:${lang}&amp;sort=stars&amp;order=desc&amp;type=Repositories`" rel="noopener ugc nofollow" target="_blank">https://api.github.com/search/repositories?q=stars:%3E1+language:${lang}&amp;sort=stars&amp;order=desc&amp;type=Repositories`</a>;</span><span id="590b" class="nt me iq lv b gy ny nv l nw nx">return fetch(url, {<br/>    method: "GET",<br/>    signal<br/>  })<br/>    .then((response) =&gt; response.json())<br/>    .then((res) =&gt; {<br/>      aborter = null;<br/>      return res;<br/>    })<br/>    .catch((error) =&gt; {<br/>      if (error.name === "AbortError") return;<br/>      console.log("Error ", error);<br/>    });<br/>};</span><span id="b201" class="nt me iq lv b gy ny nv l nw nx">// the first call will be aborted<br/>getRepos("javascript").then((res) =&gt; {<br/>  console.log(res);<br/>});<br/>getRepos("python").then((res) =&gt; {<br/>  console.log(res);<br/>});</span></pre><p id="29b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在函数作用域之外定义aborter变量的原因是，无论函数被调用了多少次，或者有多少请求仍在等待处理，它都将只显示最后一个提交的请求的结果。</p><p id="549f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里你可以看到上面的例子，第一个调用被中止，第二个调用通过。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/c29a1b3eb4823c7c86c4aaf821f42626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxmAhbEz3mObLVXtTsLdhA.png"/></div></div></figure></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="79a6" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">结论</h1><p id="b020" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在这篇文章中，我们看了一下<code class="fe ls lt lu lv b">AbortController</code>以及如何使用它来取消网络请求，并给出了一个使用fetch的例子。</p></div></div>    
</body>
</html>