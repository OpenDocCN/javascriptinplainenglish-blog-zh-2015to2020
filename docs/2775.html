<html>
<head>
<title>Setting up an express service using Swagger 3.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用斯瓦格3.0设置快递服务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/setting-up-an-express-service-using-swagger-3-0-89733aa1ab5d?source=collection_archive---------3-----------------------#2020-07-23">https://javascript.plainenglish.io/setting-up-an-express-service-using-swagger-3-0-89733aa1ab5d?source=collection_archive---------3-----------------------#2020-07-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/429cc2cc0b0c20107770f25c5d89df78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bifx98osmioynY3QWx-A-g.png"/></div></figure><p id="05dc" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这是一个使用swagger 3.0设置简单快递服务的快速教程。</p><p id="a8bc" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果你想直接进入代码，这是Github的报告:<a class="ae kp" href="https://github.com/nkhil/swagger-3-setup" rel="noopener ugc nofollow" target="_blank">https://github.com/nkhil/swagger-3-setup</a>。</p><p id="7e00" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">注意:<em class="kq">如果你想知道为什么创建API定义可能是一个好主意，</em> <a class="ae kp" href="https://swagger.io/blog/api-development/why-you-should-create-an-api-definition/" rel="noopener ugc nofollow" target="_blank"> <em class="kq">这是一个很好的解读</em> </a> <em class="kq">。</em></p><p id="0220" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我发现斯瓦格3.0最大的优势是:</p><ul class=""><li id="2c6f" class="kr ks in jt b ju jv jy jz kc kt kg ku kk kv ko kw kx ky kz bi translated">现成的请求和响应验证</li><li id="1474" class="kr ks in jt b ju la jy lb kc lc kg ld kk le ko kw kx ky kz bi translated">替换路由器的操作处理程序</li></ul><h1 id="8bce" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">请求和响应验证</h1><p id="e3f2" class="pw-post-body-paragraph jr js in jt b ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko ig bi translated">假设我们的服务有一个名为<code class="fe mi mj mk ml b">/healthcheck/ready</code>的GET路由，我们调用它来确定服务的就绪性。</p><p id="e4d4" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们不希望只有任何人调用这个路由，所以我们需要在头部有一个授权令牌。斯瓦格让我们自动检查头中的授权，并抛出400(畸形的请求)，而不编写任何额外的代码。</p><p id="4f94" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">同样，如果<code class="fe mi mj mk ml b">/healthcheck/ready</code>路线对身体<code class="fe mi mj mk ml b">{ "ready": true }</code>返回200响应，而我们错误地对<code class="fe mi mj mk ml b">{ "status": "ready" }</code>做出响应，我们会自动捕捉到并抛出错误。</p><p id="3335" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这也使得我们的服务在不编写样板验证代码的情况下更容易测试。</p><h1 id="cf89" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">操作处理程序</h1><p id="a06d" class="pw-post-body-paragraph jr js in jt b ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko ig bi translated">代替传统的路由器，斯瓦格让我们直接在斯瓦格yaml文件中定义功能。向下滚动以查找示例</p><h1 id="5a7a" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">从基本的快递服务开始</h1><p id="0a23" class="pw-post-body-paragraph jr js in jt b ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko ig bi translated">这里<a class="ae kp" href="https://github.com/nkhil/swagger-3-setup/tree/express-scaffolding" rel="noopener ugc nofollow" target="_blank">是您可以克隆的一个分支，它从基本快递服务</a>开始。</p><h1 id="442c" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">添加霸气定义</h1><p id="a3a0" class="pw-post-body-paragraph jr js in jt b ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko ig bi translated">在项目的根目录下添加一个<code class="fe mi mj mk ml b">definitions</code>文件夹，并添加一个带有项目名称的<code class="fe mi mj mk ml b">.yaml</code>文件——在这种情况下将是<code class="fe mi mj mk ml b">swagger-three-setup.yml</code>。</p><p id="22a2" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">让我们从第一条路线开始:<code class="fe mi mj mk ml b">/healthcheck/ping</code></p><p id="9edf" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这篇文章太长了，所以我把它放在了另外一个分支上:https://github . com/nkhil/swag-3-setup/blob/swag-begin/definitions/swag-3-setup . yml。</p><p id="26ab" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mi mj mk ml b">paths</code>部分现在有了新的路线定义，接下来是<code class="fe mi mj mk ml b">components</code>部分，包括<code class="fe mi mj mk ml b">responses</code>、<code class="fe mi mj mk ml b">parameters</code>和<code class="fe mi mj mk ml b">schemas</code>。这基本上让我们可以重用我们的定义(保持我们的定义干燥)，也有助于保持招摇的可读性。</p><p id="9119" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">复制<code class="fe mi mj mk ml b">swagger-three-setup.yaml</code>的内容并粘贴到<a class="ae kp" href="http://editor.swagger.io/" rel="noopener ugc nofollow" target="_blank">http://editor.swagger.io/</a>中，以查看您的定义的可视化表示。</p><p id="ef39" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们的<code class="fe mi mj mk ml b">/healthcheck/ping</code>路由要求<code class="fe mi mj mk ml b">x-correlation-id</code>出现在报头中，并且它需要是一个UUID ( <a class="ae kp" href="https://en.wikipedia.org/wiki/Universally_unique_identifier" rel="noopener ugc nofollow" target="_blank">通用唯一标识符</a>)。</p><p id="2d30" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">你会注意到在我们下面的路径定义中，我们有一个属性<code class="fe mi mj mk ml b">x-eov-operation-id</code>和<code class="fe mi mj mk ml b">x-eov-operation-handler</code>。我们很快会回到这个话题。</p><figure class="mm mn mo mp gt jo"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="ac7a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在<code class="fe mi mj mk ml b">src/index.js</code>文件中，我们现在将安装<code class="fe mi mj mk ml b">express-openapi-validator</code>包，它允许我们实时验证请求和响应。</p><p id="82a4" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在您的<code class="fe mi mj mk ml b">./src</code>文件夹中创建一个名为<code class="fe mi mj mk ml b">handlers</code>的文件夹，我们可以用它来添加处理程序。</p><p id="44ba" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">下面是开放API验证器的设置代码(放在<code class="fe mi mj mk ml b">./src/index.js</code>文件中):</p><figure class="mm mn mo mp gt jo"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="da5b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">注意我们是如何传入<code class="fe mi mj mk ml b">apiSpec</code>的，这是我们的swagger <code class="fe mi mj mk ml b">.yml</code>文件的位置。<code class="fe mi mj mk ml b">OpenApiValidator</code>接受我们的定义，并确保任何传入的请求和传出的响应与我们指定的定义相匹配。</p><p id="beed" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">好了，我们快到了。在之前创建的<code class="fe mi mj mk ml b">./src/handlers</code>文件夹中设置一个名为<code class="fe mi mj mk ml b">healthcheck.js</code>的文件，并将它添加到那里:</p><figure class="mm mn mo mp gt jo"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="1d03" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们已经在前面指定了操作处理程序和id:</p><pre class="mm mn mo mp gt ms ml mt mu aw mv bi"><span id="1e32" class="mw lg in ml b gy mx my l mz na">/healthcheck/ping:<br/>    get:<br/>      description: Returns the readiness of the service<br/>      operationId: ping<br/>      x-eov-operation-id: ping<br/>      x-eov-operation-handler: healthcheck</span></pre><p id="55ba" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们昂首阔步的<code class="fe mi mj mk ml b">x-eov-operation-handler</code>叫做<code class="fe mi mj mk ml b">healthcheck</code>，我们的<code class="fe mi mj mk ml b">x-eov-operation-id</code>叫做<code class="fe mi mj mk ml b">ping</code>。</p><p id="0e44" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mi mj mk ml b">OpenApiValidator</code>意识到了这一点，并将所有传入<code class="fe mi mj mk ml b">/healthcheck/ping</code>的请求自动路由到<code class="fe mi mj mk ml b">ping</code>功能。</p><h1 id="65dd" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">测试设置</h1><ol class=""><li id="2d43" class="kr ks in jt b ju md jy me kc nb kg nc kk nd ko ne kx ky kz bi translated">运行<code class="fe mi mj mk ml b">npm run develop</code>,这会加速我们的服务器</li><li id="f165" class="kr ks in jt b ju la jy lb kc lc kg ld kk le ko ne kx ky kz bi translated">打开Postman向这个端点发送请求，并尝试向<code class="fe mi mj mk ml b">localhost:8080/healthcheck/ping</code>发送一个<code class="fe mi mj mk ml b">GET</code>请求</li></ol><p id="8894" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们得到一个带有以下错误的<code class="fe mi mj mk ml b">400 Bad Request</code>状态代码:</p><pre class="mm mn mo mp gt ms ml mt mu aw mv bi"><span id="5ae9" class="mw lg in ml b gy mx my l mz na">Bad Request: request.headers should have required property &amp;#39;x-correlation-id&amp;#39;&lt;br&gt; &amp;nbsp; &amp;nbsp;at Object.GET-/healthcheck/ping-not_provided (/Users/nikhil/Sandbox/swagger-3-setup/node_modules/express-openapi-validator/dist/middlewares/openapi.request.validator.js:92:31)<br/><br/>// note: This is only part of the error message</span></pre><p id="5864" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">正如我们的swagger中所指定的，甚至在我们的请求命中<code class="fe mi mj mk ml b">ping</code>函数之前，它就被验证是否匹配我们的swagger规范，如果不匹配，它会自动抛出一个<code class="fe mi mj mk ml b">400 Bad Request</code>错误。</p><p id="bbd5" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果您的代码返回错误的结果，例如，如果请求是好的，但是我们的<code class="fe mi mj mk ml b">ping</code>函数返回一个不匹配的结果。例如:</p><pre class="mm mn mo mp gt ms ml mt mu aw mv bi"><span id="7765" class="mw lg in ml b gy mx my l mz na">function ping(_, res) {<br/>  res.status(200).json({ message: { message: 'OK' } });<br/>}</span></pre><p id="85ee" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">产生的状态代码是一个带有消息的<code class="fe mi mj mk ml b">500 Internal Server Error</code>:</p><pre class="mm mn mo mp gt ms ml mt mu aw mv bi"><span id="2e24" class="mw lg in ml b gy mx my l mz na">Internal Server Error: .response.message should be string</span></pre><p id="59e7" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们现在可以使用validator对我们的代码进行快乐和不快乐路径场景的组件测试，例如:</p><ul class=""><li id="a05f" class="kr ks in jt b ju jv jy jz kc kt kg ku kk kv ko kw kx ky kz bi translated">当我的请求不正确时，我得到一个400响应代码</li><li id="e28e" class="kr ks in jt b ju la jy lb kc lc kg ld kk le ko kw kx ky kz bi translated">当我的请求正确时，我得到一个200响应代码</li><li id="5ad1" class="kr ks in jt b ju la jy lb kc lc kg ld kk le ko kw kx ky kz bi translated">当我的响应不正确时，我会得到一个500响应代码</li></ul><p id="60b6" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">你可以在这里找到代码:<a class="ae kp" href="https://github.com/nkhil/swagger-3-setup" rel="noopener ugc nofollow" target="_blank">https://github.com/nkhil/swagger-3-setup</a>。</p></div></div>    
</body>
</html>