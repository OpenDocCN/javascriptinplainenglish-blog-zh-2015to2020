<html>
<head>
<title>Best Features of ES2018 — Async Generators</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ES2018的最佳特性——异步发电机</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/best-features-of-es2018-async-generators-154d086148e0?source=collection_archive---------14-----------------------#2020-09-27">https://javascript.plainenglish.io/best-features-of-es2018-async-generators-154d086148e0?source=collection_archive---------14-----------------------#2020-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/42d53980ab495b315622c7d031e7fc7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ejmEVYq3oNsM4VCp"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jamie452?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jamie Street</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="23c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自2015年以来，JavaScript有了巨大的进步。</p><p id="c894" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在用起来比以前舒服多了。</p><p id="193a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解ES2018的最佳特性。</p><h1 id="9ebc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><code class="fe lz ma mb mc b">yield*</code>异步发电机中</h1><p id="1d82" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">yield*</code>异步发电机的工作方式类似于普通发电机。</p><p id="713d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们有:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="ff47" class="mq lc iq mc b gy mr ms l mt mu">async function* gen() {<br/>  yield 'foo';<br/>  yield 'bar';<br/>  return 'baz';<br/>}</span></pre><p id="457f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过写来使用它:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="03a8" class="mq lc iq mc b gy mr ms l mt mu">(async function() {<br/>  for await (const x of gen()) {<br/>    console.log(x);<br/>  }<br/>})();</span></pre><p id="4a37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到了:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="7a5b" class="mq lc iq mc b gy mr ms l mt mu">foo<br/>bar</span></pre><p id="e93c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">记录在案。</p><p id="7cff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与普通生成器一样，for-of循环会忽略返回值。</p><p id="4da6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">yield*</code>的操作数可以是任何异步可迭代的。</p><p id="ce8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Sync iterables会自动转换为Sync iterables，就像for-await-of一样。</p><h1 id="6f09" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">异步迭代错误</h1><p id="6f79" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">在正常的生成器中，<code class="fe lz ma mb mc b">next</code>可以抛出异常。</p><p id="9ad4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了异步发电机，<code class="fe lz ma mb mc b">next</code>就可以拒绝它回报的承诺。</p><p id="2b9b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="aee3" class="mq lc iq mc b gy mr ms l mt mu">async function* asyncGen() {<br/>  throw new Error('error');<br/>}</span></pre><p id="212d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在异步生成器中引发错误。</p><p id="2b84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过编写以下内容来捕捉错误:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="bb70" class="mq lc iq mc b gy mr ms l mt mu">asyncGen().next()<br/>  .catch(err =&gt; console.log(err));</span></pre><p id="ab07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到记录在<code class="fe lz ma mb mc b">catch</code>回调中的错误对象。</p><p id="874b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">next</code>退回被拒绝的承诺。</p><h1 id="3f9b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">异步函数和异步生成器函数之间的不同</h1><p id="fe70" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">异步函数立即返回一个承诺。</p><p id="6cfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用<code class="fe lz ma mb mc b">return</code>实现承诺或用<code class="fe lz ma mb mc b">throw</code>拒绝承诺。</p><p id="df9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们可以写:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="9419" class="mq lc iq mc b gy mr ms l mt mu">(async function () {<br/>    return 'foo';<br/>})()<br/>.then(x =&gt; console.log(x));</span></pre><p id="8a40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="a118" class="mq lc iq mc b gy mr ms l mt mu">(async function() {<br/>  throw new Error('error');<br/>})()<br/>.catch(x =&gt; console.log(x));</span></pre><p id="5166" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">异步生成器立即返回一个异步可迭代对象。</p><p id="87e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且<code class="fe lz ma mb mc b">next</code>的每次调用都用<code class="fe lz ma mb mc b">yield x</code>返回一个承诺，用<code class="fe lz ma mb mc b">{value: x, done: false}</code>完成当前的承诺。</p><p id="8419" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它还可以用<code class="fe lz ma mb mc b">err</code>抛出当前承诺的错误。</p><p id="35a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们可以写:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="a8c8" class="mq lc iq mc b gy mr ms l mt mu">async function* genFn() {<br/>  yield 'foo';<br/>}<br/>const gen = genFn();<br/>gen.next().then(x =&gt; console.log(x));</span></pre><p id="db20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么<code class="fe lz ma mb mc b">x</code>就是<code class="fe lz ma mb mc b">{value: “foo”, done: false}</code>。</p><h1 id="93e6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将异步可迭代对象转换为数组</h1><p id="4ab8" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以通过循环异步iterable将一个异步变量转换成一个数组，然后将一个值压入一个常规数组。</p><p id="1f83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="caff" class="mq lc iq mc b gy mr ms l mt mu">async function convertToArr(asyncIterable) {<br/>  const result = [];<br/>  const iterator = asyncIterable[Symbol.asyncIterator]();<br/>  for await (const v of iterator) {<br/>    result.push(v);<br/>  }<br/>  return result;<br/>}</span></pre><p id="dcf3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个采用<code class="fe lz ma mb mc b">asyncIterable</code>的函数，然后将项目推入数组并返回。</p><p id="b69b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它返回一个解析到<code class="fe lz ma mb mc b">result</code>数组的承诺。</p><p id="4795" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过写来使用它:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="54a6" class="mq lc iq mc b gy mr ms l mt mu">async function* genFn() {<br/>  yield 'foo';<br/>  yield 'bar';<br/>}</span><span id="6d6f" class="mq lc iq mc b gy mv ms l mt mu">(async () =&gt; {<br/>  const arr = await convertToArr(genFn());<br/>  console.log(arr);<br/>})()</span></pre><p id="5caa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了一个异步生成器，并将它的返回结果传递给我们之前创建的<code class="fe lz ma mb mc b">convertToArr</code>函数。</p><p id="e6bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于它返回一个解析为数组的承诺，我们将在记录它时看到值。</p><h1 id="7ba6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">异步生成器的内部属性</h1><p id="c6d9" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">异步生成器有两个内部属性。</p><p id="39a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">[[AsyncGeneratorState]]</code>具有发电机当前所处的状态。</p><p id="d53e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以是<code class="fe lz ma mb mc b">"suspendedStart"</code>、<code class="fe lz ma mb mc b">"suspendedYield"</code>、<code class="fe lz ma mb mc b">"executing"</code>、<code class="fe lz ma mb mc b">"completed"</code>或<code class="fe lz ma mb mc b">undefined</code>。</p><p id="0f6d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">没有完全初始化就是<code class="fe lz ma mb mc b">undefined</code>。</p><p id="90da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">[[AsyncGeneratorQueue]]</code>保存<code class="fe lz ma mb mc b">next</code>、<code class="fe lz ma mb mc b">throw</code>或<code class="fe lz ma mb mc b">return</code>的未决调用。</p><p id="0803" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每个队列有2个字段，分别是<code class="fe lz ma mb mc b">[[Completion]]</code>和<code class="fe lz ma mb mc b">[[Capability]]</code>。</p><p id="d9a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">[[Completion]]</code>具有用于<code class="fe lz ma mb mc b">next</code>、<code class="fe lz ma mb mc b">throw</code>或<code class="fe lz ma mb mc b">return</code>的参数，该参数导致条目排队。</p><p id="2d7d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">next</code>、<code class="fe lz ma mb mc b">throw</code>或<code class="fe lz ma mb mc b">return</code>表示创建条目的方法，并确定出队后发生的情况。</p><p id="b0a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">[[Capability]]</code>是承诺的能力。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/266f726d9b8e4fdba15f1a2771bf324b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O36HdhMt1dvepBff"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@angelopantazis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Angelo Pantazis</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="1e5c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="d83c" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">yield *</code>可以与异步生成器一起使用来调用另一个生成器。</p><p id="849c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">异步函数和异步生成器之间也有很大的区别。</p><h2 id="4d5c" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">简明英语JavaScript</strong></h2><p id="94be" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">喜欢这篇文章吗？如果是这样，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>