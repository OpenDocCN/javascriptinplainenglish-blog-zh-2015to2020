<html>
<head>
<title>AWS SES: How to send a mail with an attachment in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS SES:如何在Node.js中发送带有附件的邮件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/aws-ses-how-to-send-a-mail-with-an-attachment-nodejs-43a12cf98714?source=collection_archive---------0-----------------------#2020-11-06">https://javascript.plainenglish.io/aws-ses-how-to-send-a-mail-with-an-attachment-nodejs-43a12cf98714?source=collection_archive---------0-----------------------#2020-11-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/93c615687bfff4e1dfd554bf35d8834c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhYpJf2Pdx9uHOmo4jbzAw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Image source: <a class="ae jz" href="https://wallpaperaccess.com/" rel="noopener ugc nofollow" target="_blank">wallpaperaccess</a></figcaption></figure><p id="9594" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本文中，我将解释如何使用AWS SES发送附件，本文是为那些已经知道如何使用SES发送简单电子邮件的人准备的。</p><p id="523a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">SES只允许通过<strong class="kc io"> <em class="ky">发送附件</em>发送邮件</strong>的方法。</p><p id="c4c8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">发送电子邮件接受<strong class="kc io">多用途互联网邮件扩展</strong> ( <strong class="kc io"> MIME </strong>)类型的电子邮件正文作为数据，所以让我们看看如何准备MIME类型的电子邮件内容。</p><figure class="la lb lc ld gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi kz"><img src="../Images/8f341aced2ad6a98aa385f021fff757c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*my_zVGZ0zAdPU47ZwF5Vcg.png"/></div></div></figure><p id="bb2b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">典型的MIME电子邮件看起来像上面的例子，它是一个多部分的电子邮件，内容有HTML格式和文本格式，并且包含一个文本文件作为附件。</p><p id="c7a2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以创建一个类似于上面例子的字符串，并作为数据发送给sendRawEmail，但是格式化这个长字符串会非常混乱。为了简化MIME主体的创建，我们可以使用像mimemessage这样的npm模块。如下所示，安装mimemessage npm模块。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="4962" class="lj lk in lf b gy ll lm l ln lo">npm i mimemessage</span></pre><p id="cb8d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">mimemessage模块帮助我们轻松创建电子邮件。首先，我们需要使用如下所示的mimemessage factory方法创建<strong class="kc io"> <em class="ky"> mailContent </em> </strong>。所有邮件内容都将附加到此对象。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="1d69" class="lj lk in lf b gy ll lm l ln lo">var mimemessage = require('mimemessage');</span><span id="4344" class="lj lk in lf b gy lp lm l ln lo">var mailContent = mimemessage.factory({contentType: 'multipart/mixed',body: []});</span></pre><p id="90fe" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，让我们添加标题。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0cd8" class="lj lk in lf b gy ll lm l ln lo">mailContent.header('From', 'Sender Name &lt;sender@example.com&gt;');<br/>mailContent.header('To','recipient@example.com');<br/>mailContent.header('Subject', 'Customer service contact info');</span></pre><p id="35aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，我们添加了标题，让我们添加邮件内容。使用MIME电子邮件类型，我们可以添加相同电子邮件内容的文本和HTML变体。要拥有这两种变体，我们首先需要创建一个<em class="ky">多部分/替代</em>对象。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="8af8" class="lj lk in lf b gy ll lm l ln lo">var alternateEntity = mimemessage.factory({<br/>    contentType: 'multipart/alternate',<br/>    body: []<br/>});</span></pre><p id="063e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们需要创建HTML和文本实体，并添加到上面的<em class="ky">alternate tity中。</em></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="68ef" class="lj lk in lf b gy ll lm l ln lo">var htmlEntity = mimemessage.factory({<br/>   contentType: 'text/html;charset=utf-8',<br/>   body:  '   &lt;html&gt;  '  + <br/>          '   &lt;head&gt;&lt;/head&gt;  '  + <br/>          '   &lt;body&gt;  '  + <br/>          '   &lt;h1&gt;Hello!&lt;/h1&gt;  '  + <br/>          '   &lt;p&gt;Please see the attached file for a list of    customers to contact.&lt;/p&gt;  '  + <br/>          '   &lt;/body&gt;  '  + <br/>          '  &lt;/html&gt;  ' <br/> });</span><span id="bb57" class="lj lk in lf b gy lp lm l ln lo">var plainEntity = mimemessage.factory({<br/>   body: 'Please see the attached file for a list of    customers to contact.'<br/>});</span><span id="fef3" class="lj lk in lf b gy lp lm l ln lo">alternateEntity.body.push(htmlEntity);<br/>alternateEntity.body.push(plainEntiFirstty);</span></pre><p id="4282" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们需要将这个<em class="ky">alternate tity</em>添加到<em class="ky"> mailContent </em>体内</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="723e" class="lj lk in lf b gy ll lm l ln lo">mailContent.body.push(alternateEntity);</span></pre><h2 id="de72" class="lj lk in bd lq lr ls dn lt lu lv dp lw kl lx ly lz kp ma mb mc kt md me mf mg bi translated"><strong class="ak">如何将文件附加到邮件中</strong></h2><p id="6a36" class="pw-post-body-paragraph ka kb in kc b kd mh kf kg kh mi kj kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">我们将添加附件，作为主邮件内容对象的一部分。首先，我们需要读取文件，并将文件内容转换成base64字符串，将其作为实体的主体添加。如下所示，我们需要指定内容类型和使用的编码。我们需要添加一个名为<em class="ky">内容-处置</em>的带有相关细节的标题。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="56fa" class="lj lk in lf b gy ll lm l ln lo">var data = fs.readFileSync('customers.txt');</span><span id="d89d" class="lj lk in lf b gy lp lm l ln lo">var attachmentEntity = mimemessage.factory({<br/>contentType: 'text/plain',<br/>contentTransferEncoding: 'base64',<br/>body: data.toString('base64').replace(/([^<strong class="lf io">\0</strong>]{76})/g, "$1\n")<br/>});</span><span id="cd07" class="lj lk in lf b gy lp lm l ln lo">attachmentEntity.header('Content-Disposition', 'attachment ;filename="customers.txt"');</span></pre><p id="4930" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在将该实体附加到主邮件内容中。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="924e" class="lj lk in lf b gy ll lm l ln lo">mailContent.body.push(attachmentEntity);</span></pre><p id="5ea3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，我们的邮件对象准备好了，我们需要将它传递给SES sendRawEmail方法，如下所示。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="8a63" class="lj lk in lf b gy ll lm l ln lo">ses.sendRawEmail({<br/>    RawMessage: { Data: mailContent.toString() }<br/>}, (err, sesdata, res) =&gt; {</span><span id="3c99" class="lj lk in lf b gy lp lm l ln lo">});</span></pre><p id="bcea" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们配置正确，我们将在回调中收到一条成功消息。</p><p id="4867" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注意:SES仅允许10MB文件作为附件</p></div></div>    
</body>
</html>