<html>
<head>
<title>Using JavaScript and window.postMessage()</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用JavaScript和window.postMessage()</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-and-window-postmessage-a60c8f6adea9?source=collection_archive---------0-----------------------#2020-01-10">https://javascript.plainenglish.io/javascript-and-window-postmessage-a60c8f6adea9?source=collection_archive---------0-----------------------#2020-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1b6a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">安全跨域通信</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/872ed2f35c52f303802121f19e80e59f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IIMuSC12KdjFkvqJNvhInQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by Kate Macate on <a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="1332" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="d9c0" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi mk translated"><span class="l ml mm mn bm mo mp mq mr ms di"> C </span>跨域通信(也称为跨来源)可能会很困难，并带来安全风险。但是，HTML5 <a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank">有一个很有用却经常被忽略的特性，window.postMessage()，</a>如果使用正确是安全的。</p><p id="d81f" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">如<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"> MDN </a>上所述，</p><blockquote class="my"><p id="0ff7" class="mz na iq bd nb nc nd ne nf ng nh mj dk translated"><code class="fe ni nj nk nl b"><strong class="ak">window.postMessage()</strong></code>方法安全地启用了<code class="fe ni nj nk nl b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Window" rel="noopener ugc nofollow" target="_blank">Window</a></code>对象之间的跨原点通信；<em class="nm">例如，</em>在页面和它产生的弹出窗口之间，或者在页面和嵌入其中的iframe之间。</p></blockquote><blockquote class="nn no np"><p id="4cb7" class="lo lp nq lq b lr nr jr lt lu ns ju lw nt nu lz ma nv nw md me nx ny mh mi mj ij bi translated">在本文中，我们将关注窗口之间的通信<strong class="lq ir">，而不是窗口和iframe。</strong></p></blockquote></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="ea80" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><em class="nq">顺便说一下，MDN上的语句说弹出窗口，我们会用到，但是收件人窗口</em> <strong class="lq ir"> <em class="nq">并不一定是</em> </strong> <em class="nq">弹出的。</em></p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><h1 id="4fd7" class="kw kx iq bd ky kz og lb lc ld oh lf lg jw oi jx li jz oj ka lk kc ok kd lm ln bi translated"><strong class="ak">语法</strong></h1><h2 id="9002" class="ol kx iq bd ky om on dn lc oo op dp lg lx oq or li mb os ot lk mf ou ov lm ow bi translated">两个必需的组件及其语法</h2><p id="e0a7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">两个<strong class="lq ir">所需的</strong>部件是，</p><ol class=""><li id="5f0f" class="ox oy iq lq b lr mt lu mu lx oz mb pa mf pb mj pc pd pe pf bi translated">window.postMessage() —发送消息</li><li id="ae95" class="ox oy iq lq b lr pg lu ph lx pi mb pj mf pk mj pc pd pe pf bi translated">window.addEventListener(" <em class="nq">消息</em>"，<em class="nq">回调</em> ) —接收并处理消息</li></ol><p id="3f9b" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">postMessage()方法的语法是，</p><pre class="kg kh ki kj gt pl nl pm pn aw po bi"><span id="59ac" class="ol kx iq nl b gy pp pq l pr ps"><em class="nq">targetWindow</em>.postMessage(<em class="nq">message</em>, <em class="nq">targetOrigin</em>, [<em class="nq">transfer</em>]);</span></pre><p id="bd91" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">还有一个可选的第三个参数[transfer]，我们不会用到。您可能想了解更多关于MDN的信息。</p><ul class=""><li id="15f0" class="ox oy iq lq b lr mt lu mu lx oz mb pa mf pb mj pt pd pe pf bi translated"><strong class="lq ir"> targetWindow </strong>是你要发送消息的窗口的句柄。</li><li id="d647" class="ox oy iq lq b lr pg lu ph lx pi mb pj mf pk mj pt pd pe pf bi translated"><strong class="lq ir">消息</strong>可以是相当多的复杂对象。但是，函数不能作为消息的一部分发送，因为消息数据是使用<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/DOM/The_structured_clone_algorithm" rel="noopener ugc nofollow" target="_blank">结构化克隆算法</a>序列化的。结构化克隆算法不允许使用函数。然而，这确实意味着您可以安全地传递各种各样的数据对象。</li><li id="3fcc" class="ox oy iq lq b lr pg lu ph lx pi mb pj mf pk mj pt pd pe pf bi translated"><strong class="lq ir"> targetOrigin </strong>是<em class="nq">非常重要的一块</em>。是收件人页面的URI <strong class="lq ir">。在发送时(postMessage)，如果targetOrigin与targetWindow页面的主机名不匹配，则发送失败。<br/> <em class="nq">可以使用“*”作为targetorigin，但只是为了简单的测试才这样做(就像我们在这里做的一样。)</em></strong></li></ul><p id="9889" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">为了进一步强调这一点，在生产中，在接收端，您将需要根据targetOrigin验证接收者域。如果它们不匹配，请不要接受该邮件。</p><p id="f179" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir">小心</strong>:如果“*”被用作targetOrigin，信息可能来自任何人。</p><blockquote class="nn no np"><p id="b0eb" class="lo lp nq lq b lr mt jr lt lu mu ju lw nt mv lz ma nv mw md me nx mx mh mi mj ij bi translated">请记住，我们通常是<strong class="lq ir">从一个域发送到另一个域</strong>，所以targetOrigin必须与targetWindow侦听器的域匹配。</p></blockquote><p id="b51a" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir">换句话说</strong>，我们可能想要从<a class="ae kv" href="https://firstdomain.com" rel="noopener ugc nofollow" target="_blank">https://abcd.com</a>向<a class="ae kv" href="https://seconddomain.com." rel="noopener ugc nofollow" target="_blank">https://defg.com发送一个信息。</a>所以targetOrigin将是<a class="ae kv" href="https://def.com." rel="noopener ugc nofollow" target="_blank">https://defg.com。</a>并且受体的域也将是<a class="ae kv" href="https://defg.com" rel="noopener ugc nofollow" target="_blank">https://defg.com</a>。</p><h1 id="76e5" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">例子</h1><p id="2051" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将创建两个名为Page1.html和Page2.html的网页。Page2.html将是一个弹出窗口，它不一定是，这只是我的选择。</p><p id="d056" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">Page1.html将向Page2.html传递一个信息。</p><h2 id="28d9" class="ol kx iq bd ky om on dn lc oo op dp lg lx oq or li mb os ot lk mf ou ov lm ow bi translated"><strong class="ak">页面</strong></h2><p id="c144" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建以下文件</p><p id="73a4" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir">Page1.html(注意发送消息功能)</strong></p><pre class="kg kh ki kj gt pl nl pm pn aw po bi"><span id="7f42" class="ol kx iq nl b gy pp pq l pr ps">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/> &lt;meta charset="utf-8" /&gt;<br/>&lt;script&gt;</span><span id="9772" class="ol kx iq nl b gy pu pq l pr ps">var childwin;<br/>const childname = "popup";<br/>function openChild() {</span><span id="79ee" class="ol kx iq nl b gy pu pq l pr ps">childwin = window.open('Page2.html', childname, 'height=300px, width=500px');<br/>  <br/>}<br/>function sendMessage(){<br/>    let msg={pName : "Bob", pAge: "35"};<br/>    // In production, DO NOT use '*', use toe target domain<br/>    childwin.postMessage(msg,'*')// childwin is the targetWindow<br/>    childwin.focus();<br/>}</span><span id="43d0" class="ol kx iq nl b gy pu pq l pr ps">&lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;form&gt;<br/>        &lt;fieldset&gt;<br/>            &lt;input type='button' id='btnopen' value='Open child' onclick='openChild();' /&gt;<br/>            &lt;input type='button' id='btnSendMsg' value='Send Message' onclick='sendMessage();' /&gt;<br/>        &lt;/fieldset&gt;<br/>    &lt;/form&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="a741" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir">Page2.html(注意addEventListener中的回调函数)</strong></p><pre class="kg kh ki kj gt pl nl pm pn aw po bi"><span id="b8fc" class="ol kx iq nl b gy pp pq l pr ps">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>    &lt;meta charset="utf-8" /&gt;<br/>    &lt;script&gt;</span><span id="76cb" class="ol kx iq nl b gy pu pq l pr ps">// Allow window to listen for a postMessage<br/>    window.addEventListener("message", (event)=&gt;{</span><span id="04d4" class="ol kx iq nl b gy pu pq l pr ps">// Normally you would check event.origin<br/>        // To verify the targetOrigin matches<br/>        // this window's domain<br/>        let txt=document.querySelector('#txtMsg');<br/>        // event.data contains the message sent<br/>        txt.value=`Name is ${event.data.pName} Age is  ${event.data.pAge}` ;<br/>      <br/>    });</span><span id="02e7" class="ol kx iq nl b gy pu pq l pr ps">function closeMe() {<br/>        try {</span><span id="fe9a" class="ol kx iq nl b gy pu pq l pr ps">window.close();<br/>        } catch (e) { console.log(e) }<br/>        try {</span><span id="f294" class="ol kx iq nl b gy pu pq l pr ps">self.close();<br/>        } catch (e) { console.log(e) }</span><span id="a786" class="ol kx iq nl b gy pu pq l pr ps">}<br/>    &lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;form&gt;<br/>        &lt;h1&gt;Recipient of postMessage&lt;/h1&gt;<br/>            &lt;fieldset&gt;<br/>                &lt;input type='text' id='txtMsg' /&gt;<br/>                &lt;input type='button' id='btnCloseMe' value='Close me' onclick='closeMe();' /&gt;<br/>            &lt;/fieldset&gt;<br/>   <br/>    &lt;/form&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><h2 id="f31d" class="ol kx iq bd ky om on dn lc oo op dp lg lx oq or li mb os ot lk mf ou ov lm ow bi translated">试运转</h2><p id="cbb5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">打开Page1.html，然后单击“打开孩子”按钮。这将打开弹出窗口。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pv"><img src="../Images/80a471bf618db5b5d6a63a6fbe67b6c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5yEqYxDYT-PiPFdsFcI25A.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Popup-targetWindow</figcaption></figure><p id="e101" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">单击“发送消息”按钮。该消息由弹出窗口接收。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pw"><img src="../Images/14cc35500064119d017b9a74d1bb8e39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVa28dqNgdb1q7rRUur0OA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Result of childwin.postMessage()</figcaption></figure><h1 id="4a5c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">发生什么事了？</h1><p id="5207" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">当点击“发送消息”时，一个对象将被发送到收件人页面，并引用在窗口期间创建的窗口childwin。</p><p id="5231" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir"> childwind.postMessage(msg，“*”)</strong></p><p id="8a65" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><em class="nq">再次声明，除检测外，请勿使用“*”。</em></p><blockquote class="nn no np"><p id="ce75" class="lo lp nq lq b lr mt jr lt lu mu ju lw nt mv lz ma nv mw md me nx mx mh mi mj ij bi translated">targetOrigin应该是收件人页面所在的域。</p></blockquote><p id="3265" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">收件人窗口的事件侦听器在名为“事件”的参数中接收消息。</p><p id="36f5" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">回调函数，在我们的例子中是Arrow函数，处理消息。</p><ul class=""><li id="2070" class="ox oy iq lq b lr mt lu mu lx oz mb pa mf pb mj pt pd pe pf bi translated">该消息包含在<strong class="lq ir">事件. data </strong>中。</li><li id="2355" class="ox oy iq lq b lr pg lu ph lx pi mb pj mf pk mj pt pd pe pf bi translated">targetOrigin包含在<strong class="lq ir">事件中。origin </strong>。</li></ul><h1 id="9422" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="3e5b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">window.postMessage()是一种在不同域或不同来源的窗口之间发送消息的安全方法。人们也可以发布到IFrame。</p><p id="8365" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">正在发送的数据使用<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/DOM/The_structured_clone_algorithm" rel="noopener ugc nofollow" target="_blank">结构化克隆算法</a>进行序列化，并将接受几乎任何类型的简单或复杂数据。</p><p id="126e" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">还有一个postMessage()可以在浏览器上下文相同时使用。这涉及到一个渠道。</p><p id="7043" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">channel.postMessage()将在另一篇文章中介绍。</p><p id="86cd" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated"><strong class="lq ir">感谢您的阅读和快乐编码！</strong></p><p id="8d12" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">在Medium上阅读所有你想要的文章，并通过成为Medium会员来帮助我继续写作，每月只需5美元。</p><div class="px py gp gr pz qa"><a href="https://bobtomlin-70659.medium.com/membership" rel="noopener follow" target="_blank"><div class="qb ab fo"><div class="qc ab qd cl cj qe"><h2 class="bd ir gy z fp qf fr fs qg fu fw ip bi translated">通过我的推荐链接加入灵媒——重力井(罗伯·汤姆林)</h2><div class="qh l"><h3 class="bd b gy z fp qf fr fs qg fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="qi l"><p class="bd b dl z fp qf fr fs qg fu fw dk translated">bobtomlin-70659.medium.com</p></div></div><div class="qj l"><div class="qk l ql qm qn qj qo kp qa"/></div></div></a></div><p id="cc86" class="pw-post-body-paragraph lo lp iq lq b lr mt jr lt lu mu ju lw lx mv lz ma mb mw md me mf mx mh mi mj ij bi translated">你也可以享受，</p><div class="px py gp gr pz qa"><a href="https://medium.com/javascript-in-plain-english/using-javascript-and-the-broadcast-channel-api-a3134739781d" rel="noopener follow" target="_blank"><div class="qb ab fo"><div class="qc ab qd cl cj qe"><h2 class="bd ir gy z fp qf fr fs qg fu fw ip bi translated">使用JavaScript和广播频道API</h2><div class="qh l"><h3 class="bd b gy z fp qf fr fs qg fu fw dk translated">对于选项卡之间的浏览器上下文通信</h3></div><div class="qi l"><p class="bd b dl z fp qf fr fs qg fu fw dk translated">medium.com</p></div></div><div class="qj l"><div class="qp l ql qm qn qj qo kp qa"/></div></div></a></div><div class="px py gp gr pz qa"><a href="https://medium.com/javascript-in-plain-english/introduction-to-javascripts-geolocation-api-b01ca61e47f8" rel="noopener follow" target="_blank"><div class="qb ab fo"><div class="qc ab qd cl cj qe"><h2 class="bd ir gy z fp qf fr fs qg fu fw ip bi translated">JavaScript地理定位API简介</h2><div class="qh l"><h3 class="bd b gy z fp qf fr fs qg fu fw dk translated">JavaScript的地理定位API是什么以及如何使用它</h3></div><div class="qi l"><p class="bd b dl z fp qf fr fs qg fu fw dk translated">medium.com</p></div></div><div class="qj l"><div class="qq l ql qm qn qj qo kp qa"/></div></div></a></div><div class="px py gp gr pz qa"><a href="https://medium.com/javascript-in-plain-english/closing-a-window-with-javascript-beeec56344bb" rel="noopener follow" target="_blank"><div class="qb ab fo"><div class="qc ab qd cl cj qe"><h2 class="bd ir gy z fp qf fr fs qg fu fw ip bi translated">用JavaScript关闭窗口</h2><div class="qh l"><h3 class="bd b gy z fp qf fr fs qg fu fw dk translated">简而言之，什么可行，什么不可行</h3></div><div class="qi l"><p class="bd b dl z fp qf fr fs qg fu fw dk translated">medium.com</p></div></div><div class="qj l"><div class="qr l ql qm qn qj qo kp qa"/></div></div></a></div></div></div>    
</body>
</html>