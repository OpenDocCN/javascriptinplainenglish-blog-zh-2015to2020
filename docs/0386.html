<html>
<head>
<title>Unit testing Firebase Firestore &amp; Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å•å…ƒæµ‹è¯•Firebase Firestoreå’Œäº‘åŠŸèƒ½</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://javascript.plainenglish.io/unit-testing-firebase-firestore-cloud-functions-7192c2c4649e?source=collection_archive---------2-----------------------#2019-10-01">https://javascript.plainenglish.io/unit-testing-firebase-firestore-cloud-functions-7192c2c4649e?source=collection_archive---------2-----------------------#2019-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9bde5b36d6a089f4c86a0b9609ca01d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AoeLTzsZ6i_31FYicOLdrA.png"/></div></div></figure><div class=""/><p id="2d50" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘çš„ä¸€ä¸ªä¸ªäººé¡¹ç›®è®©æˆ‘æ‰“å¼€äº†å……æ»¡ä¹è¶£å’Œæ–°æŠ€æœ¯çš„æ½˜å¤šæ‹‰é­”ç›’ã€‚æˆ‘é€šå¸¸æ— æ³•åœ¨ç™½å¤©å·¥ä½œæ—¶ä½¿ç”¨Firebase Firestoreå’Œäº‘åŠŸèƒ½ã€‚ğŸ¤–</p><p id="6019" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘æŒ‘æˆ˜è‡ªå·±ï¼Œç¼–å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—æœ‰æ•ˆè½½è·çš„æ•°æ®ï¼Œå¹¶åœ¨Firebaseä¸­åˆ›å»ºäº†ä¸€ä¸ªè®°å½•ã€‚ä¼´éšç€è¿™ä¸ªæŒ‘æˆ˜ï¼Œæˆ‘æƒ³ç”¨å•å…ƒæµ‹è¯•æ¥åŒ…è£…æˆ‘çš„åŠŸèƒ½ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„å»¶ä¼¸ç›®æ ‡ã€‚</p><p id="e2e5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å®˜æ–¹çš„<a class="ae kw" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase Cloud Functionsæ–‡æ¡£</a>æ˜“äºé˜…è¯»å’Œç†è§£éå¸¸åŸºæœ¬çš„ç”¨ä¾‹ã€‚æˆ‘æƒ³åœ¨ä¸»è¦çš„ä¾‹å­ä¹‹å¤–å†è¿›ä¸€æ­¥ã€‚ğŸ˜„</p><h1 id="cd36" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">å¯†ç </h1><p id="0b9e" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥ç›‘å¬Firestoreæ–‡æ¡£åˆ›å»ºäº‹ä»¶ã€‚å®ƒå°†è°ƒç”¨äº‘å‡½æ•°æ¥è·å–æ•°æ®ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå…³è”è®°å½•ã€‚</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2fa8" class="mj ky jb mf b gy mk ml l mm mn">const functions = require('firebase-functions');<br/>const admin = require('firebase-admin');</span><span id="602f" class="mj ky jb mf b gy mo ml l mm mn">admin.initializeApp();<br/>let db = admin.firestore();</span><span id="b64e" class="mj ky jb mf b gy mo ml l mm mn">exports.onEpisodeTrackCreated = functions.firestore.document('episodes/{episodeId}/tracks/{trackIndex}')<br/>  .onCreate((snap, context) =&gt; {<br/>    const data = snap.data()</span><span id="f133" class="mj ky jb mf b gy mo ml l mm mn">    if (!data.name) throw new Error('Missing `name` parameter')</span><span id="e33e" class="mj ky jb mf b gy mo ml l mm mn">    const name = data.name.trim()<br/>    let tracksRef = db.collection('tracks')</span><span id="12a9" class="mj ky jb mf b gy mo ml l mm mn">    return tracksRef.where('name', '==', name).get()<br/>      .then(snapshot =&gt; {<br/>        if (snapshot.empty) {<br/>          return tracksRef.add({<br/>            name: name<br/>          })<br/>        }<br/>        let doc<br/>        snapshot.forEach(snapDoc =&gt; {<br/>          doc = snapDoc<br/>        })<br/>        return doc<br/>      })<br/>        .then((doc) =&gt; {<br/>          snap.ref.set({<br/>            trackId: doc.id<br/>          }, { merge: true })<br/>          return doc<br/>        })<br/>  })</span></pre><h1 id="22e3" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">æµ‹è¯•è®¾ç½®</h1><p id="862c" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">å®‰è£…<code class="fe mp mq mr mf b">firebase-functions-test</code>å’ŒJestä¸€ä¸ªæµè¡Œçš„â€œåŒ…å«ç”µæ± â€æµ‹è¯•æ¡†æ¶ã€‚</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4213" class="mj ky jb mf b gy mk ml l mm mn">npm install --save-dev firebase-functions-test jest</span></pre><p id="a186" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code class="fe mp mq mr mf b">test</code>æ–‡ä»¶å¤¹ï¼Œåœ¨é‚£é‡Œå­˜å‚¨æˆ‘ä»¬å‡½æ•°çš„å•å…ƒæµ‹è¯•ã€‚</p><p id="f546" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ç”¨è¦è°ƒç”¨çš„æµ‹è¯•è„šæœ¬æ›´æ–°äº†<code class="fe mp mq mr mf b">package.json</code>ã€‚</p><p id="9ef7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">"è„šæœ¬":{ <br/>"æµ‹è¯•":" jest test/" <br/> }</p><p id="4163" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebaseäº‘åŠŸèƒ½å¯ä»¥åœ¨çº¿å’Œç¦»çº¿æ¨¡å¼ä¸‹è¿è¡Œã€‚åœ¨çº¿æ¨¡å¼æ„å‘³ç€å®ƒå°†ä¸ä½ çš„Firebaseå¸æˆ·äº’åŠ¨ï¼Œåˆ›å»º/é”€æ¯æ•°æ®ã€‚ç¦»çº¿æ¨¡å¼ä¼šå¯¼è‡´æˆ‘ä»¬ä¸­æ–­é€šè¯ï¼Œåœ¨æˆ‘çœ‹æ¥è¿™æ˜¯æ’°å†™æœ¬æ–‡çš„é¦–é€‰ã€‚</p><p id="70f6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">é€šè¿‡ä¸å®šä¹‰ä»»ä½•é…ç½®é€‰é¡¹ï¼Œåœ¨ç¦»çº¿æ¨¡å¼ä¸‹åˆå§‹åŒ–SDKã€‚</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="bc54" class="mj ky jb mf b gy mk ml l mm mn">const test = require('firebase-functions-test')();</span></pre><p id="553b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è®©æˆ‘ä»¬ç»§ç»­ç¼–å†™è°ƒç”¨è¯¥å‡½æ•°çš„å•å…ƒæµ‹è¯•ï¼Œå¹¶ä¸”åº”è¯¥æˆåŠŸåœ°ç”¨async/awaitè¿›è¡Œè§£æï¼Œå¦åˆ™å®ƒå°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="387a" class="mj ky jb mf b gy mk ml l mm mn">const test = require('firebase-functions-test')();<br/>const functions = require('../index.js');</span><span id="0f16" class="mj ky jb mf b gy mo ml l mm mn">describe('onEpisodeTrackCreated', () =&gt; {<br/>  it('successfully invokes function', async () =&gt; {<br/>    const wrapped = test.wrap(functions.onEpisodeTrackCreated);<br/>    const data = { name: 'hello - world', broadcastAt: new Date() }<br/>    await wrapped({<br/>      data: () =&gt; ({<br/>        name: 'hello - world'<br/>      }),<br/>      ref:{<br/>        set: jest.fn()<br/>      }<br/>    })<br/>  })<br/>})</span></pre><p id="bb06" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å½“æˆ‘ä»¬ç°åœ¨è¿è¡Œæµ‹è¯•æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼ŸğŸ¤”</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5a06" class="mj ky jb mf b gy mk ml l mm mn">FAIL  tests/index.test.js<br/>  onEpisodeTrackCreated<br/>    âœ• successfully invokes function (832ms)</span><span id="ee8f" class="mj ky jb mf b gy mo ml l mm mn">  â— onEpisodeTrackCreated â€º successfully invokes function</span><span id="73b8" class="mj ky jb mf b gy mo ml l mm mn">    Could not load the default credentials. Browse to https://cloud.google.com/docs/authenti<br/>cation/getting-started for more information.</span><span id="7a57" class="mj ky jb mf b gy mo ml l mm mn">      at GoogleAuth.getApplicationDefaultAsync (node_modules/google-auth-library/build/src/auth/googleauth.js:161:19)<br/>      at GoogleAuth.getClient (node_modules/google-auth-library/build/src/auth/googleauth.js:503:17)<br/>      at GrpcClient._getCredentials (node_modules/google-gax/src/grpc.ts:150:20)<br/>      at GrpcClient.createStub (node_modules/google-gax/src/grpc.ts:295:19)</span><span id="6134" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 failed, 1 total<br/>Tests:       1 failed, 1 total<br/>Snapshots:   0 total<br/>Time:        1.91s</span></pre><p id="0a46" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ğŸ˜¢è¿™å¯ä¸å¥½ã€‚</p><p id="8e70" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä»”ç»†æƒ³æƒ³è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬çš„ä»£ç ä¸­ç¡®å®æœ‰å¾ˆå¤šé”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å‘Šè¯‰æˆ‘ä»¬ä¸€äº›å…³äºå‡­è¯çš„ä¿¡æ¯ã€‚æˆ–è®¸æ˜¯ä¸<code class="fe mp mq mr mf b">firebase-admin</code>å·ä¸Šçš„<code class="fe mp mq mr mf b">initializeApp</code>æœ‰å…³ï¼ŸğŸ¤”</p><p id="b1f0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬å°†å¯¹æ­¤è¿›è¡Œæ¨¡æ‹Ÿï¼Œçœ‹çœ‹æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="de3f" class="mj ky jb mf b gy mk ml l mm mn">jest.mock('firebase-admin', () =&gt; ({<br/>  initializeApp: jest.fn()<br/>}))</span></pre><p id="f5a3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è€Œç»“æœâ€¦</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7c2b" class="mj ky jb mf b gy mk ml l mm mn">FAIL  tests/index.test.js<br/>  â— Test suite failed to run</span><span id="a722" class="mj ky jb mf b gy mo ml l mm mn">    TypeError: admin.firestore is not a function</span><span id="f0fa" class="mj ky jb mf b gy mo ml l mm mn">      3 | <br/>      4 | admin.initializeApp();<br/>    &gt; 5 | let db = admin.firestore();<br/>        |                ^<br/>      6 | <br/>      7 | exports.onEpisodeTrackCreated = functions.firestore.document('episodes/{episodeId}/tracks/{trackIndex}')<br/>      8 |   .onCreate((snap, context) =&gt; {</span><span id="f6f0" class="mj ky jb mf b gy mo ml l mm mn">      at Object.firestore (index.js:5:16)<br/>      at Object.require (tests/index.test.js:23:19)</span><span id="9952" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 failed, 1 total<br/>Tests:       0 total<br/>Snapshots:   0 total<br/>Time:        1.757s</span></pre><p id="97fa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¤ªå¥½äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´å¥½çš„ä½ç½®ã€‚å› ä¸ºæˆ‘ä»¬æ­£åœ¨è°ƒç”¨<code class="fe mp mq mr mf b">firestore</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»å®Œå…¨æ¨¡æ‹Ÿäº†å®ç°ï¼Œè¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ã€‚</p><p id="a171" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨æ¥å®Œæˆè¿™ä¸ªæµ‹è¯•çš„æ¨¡æ‹Ÿã€‚ğŸ˜…</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6a43" class="mj ky jb mf b gy mk ml l mm mn">const mockQueryResponse = jest.fn()<br/>mockQueryResponse.mockResolvedValue([<br/>  {<br/>    id: 1<br/>  }<br/>])</span><span id="f925" class="mj ky jb mf b gy mo ml l mm mn">jest.mock('firebase-admin', () =&gt; ({<br/>  initializeApp: jest.fn(),<br/>  firestore: () =&gt; ({<br/>   collection: jest.fn(path =&gt; ({<br/>     where: jest.fn(queryString =&gt; ({<br/>       get: mockQueryResponse<br/>     }))<br/>   })) <br/>  })<br/>}))</span></pre><p id="1b0e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æœ€åä¸€è½®ã€‚ğŸ˜¬</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="73e9" class="mj ky jb mf b gy mk ml l mm mn">PASS  tests/index.test.js<br/>  onEpisodeTrackCreated<br/>    âœ“ successfully invokes function (3ms)</span><span id="d068" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        1.026s</span></pre><p id="4d9b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¤ªæ£’äº†ã€‚ğŸ™Œ</p><p id="e908" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘çœŸçš„å¸Œæœ›è¿™ä¸ªè§£å†³æ–¹æ¡ˆèƒ½å¸®åŠ©ä½ æµ‹è¯•ä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®ã€‚</p><h1 id="d333" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">æ¥æº</h1><p id="e7ee" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">å½“ç„¶ï¼Œè¿™ä¸ªç»“æœå¹¶ä¸æ˜¯è‡ªç„¶äº§ç”Ÿçš„ï¼Œè€Œæ˜¯é€šè¿‡ç¼–ç é˜¶æ®µåœ¨äº’è”ç½‘ä¸Šå¤§é‡æœç´¢ç›¸å…³è§£å†³æ–¹æ¡ˆçš„ç»“æœã€‚</p><ul class=""><li id="cd45" class="ms mt jb ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><a class="ae kw" href="https://medium.com/@leejh3224/testing-firebase-cloud-functions-with-jest-4156e65c7d29#0369" rel="noopener">ç”¨Gomproçš„Jestæµ‹è¯•Firebaseäº‘å‡½æ•°</a></li><li id="d67a" class="ms mt jb ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae kw" href="https://firebase.google.com/docs/functions/unit-testing#testing_background_non-http_functions" rel="noopener ugc nofollow" target="_blank">Googleæµ‹è¯•åå°(éHTTP)åŠŸèƒ½</a></li><li id="3d0a" class="ms mt jb ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae kw" href="https://jestjs.io/docs/en/asynchronous.html#async-await" rel="noopener ugc nofollow" target="_blank">å¼‚æ­¥/ç­‰å¾…åº”ç­”</a></li></ul></div></div>    
</body>
</html>