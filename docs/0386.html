<html>
<head>
<title>Unit testing Firebase Firestore &amp; Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">单元测试Firebase Firestore和云功能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/unit-testing-firebase-firestore-cloud-functions-7192c2c4649e?source=collection_archive---------2-----------------------#2019-10-01">https://javascript.plainenglish.io/unit-testing-firebase-firestore-cloud-functions-7192c2c4649e?source=collection_archive---------2-----------------------#2019-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9bde5b36d6a089f4c86a0b9609ca01d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AoeLTzsZ6i_31FYicOLdrA.png"/></div></div></figure><div class=""/><p id="2d50" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的一个个人项目让我打开了充满乐趣和新技术的潘多拉魔盒。我通常无法在白天工作时使用Firebase Firestore和云功能。🤖</p><p id="6019" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我挑战自己，编写了一个函数，它接受有效载荷的数据，并在Firebase中创建了一个记录。伴随着这个挑战，我想用单元测试来包装我的功能，作为一个新的延伸目标。</p><p id="e2e5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">官方的<a class="ae kw" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase Cloud Functions文档</a>易于阅读和理解非常基本的用例。我想在主要的例子之外再进一步。😄</p><h1 id="cd36" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">密码</h1><p id="0b9e" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里我有一个简单的函数来监听Firestore文档创建事件。它将调用云函数来获取数据，检查它是否存在，如果不存在，则创建一个关联记录。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2fa8" class="mj ky jb mf b gy mk ml l mm mn">const functions = require('firebase-functions');<br/>const admin = require('firebase-admin');</span><span id="602f" class="mj ky jb mf b gy mo ml l mm mn">admin.initializeApp();<br/>let db = admin.firestore();</span><span id="b64e" class="mj ky jb mf b gy mo ml l mm mn">exports.onEpisodeTrackCreated = functions.firestore.document('episodes/{episodeId}/tracks/{trackIndex}')<br/>  .onCreate((snap, context) =&gt; {<br/>    const data = snap.data()</span><span id="f133" class="mj ky jb mf b gy mo ml l mm mn">    if (!data.name) throw new Error('Missing `name` parameter')</span><span id="e33e" class="mj ky jb mf b gy mo ml l mm mn">    const name = data.name.trim()<br/>    let tracksRef = db.collection('tracks')</span><span id="12a9" class="mj ky jb mf b gy mo ml l mm mn">    return tracksRef.where('name', '==', name).get()<br/>      .then(snapshot =&gt; {<br/>        if (snapshot.empty) {<br/>          return tracksRef.add({<br/>            name: name<br/>          })<br/>        }<br/>        let doc<br/>        snapshot.forEach(snapDoc =&gt; {<br/>          doc = snapDoc<br/>        })<br/>        return doc<br/>      })<br/>        .then((doc) =&gt; {<br/>          snap.ref.set({<br/>            trackId: doc.id<br/>          }, { merge: true })<br/>          return doc<br/>        })<br/>  })</span></pre><h1 id="22e3" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试设置</h1><p id="862c" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装<code class="fe mp mq mr mf b">firebase-functions-test</code>和Jest一个流行的“包含电池”测试框架。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4213" class="mj ky jb mf b gy mk ml l mm mn">npm install --save-dev firebase-functions-test jest</span></pre><p id="a186" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要创建一个<code class="fe mp mq mr mf b">test</code>文件夹，在那里存储我们函数的单元测试。</p><p id="f546" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我用要调用的测试脚本更新了<code class="fe mp mq mr mf b">package.json</code>。</p><p id="9ef7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">"脚本":{ <br/>"测试":" jest test/" <br/> }</p><p id="4163" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebase云功能可以在线和离线模式下运行。在线模式意味着它将与你的Firebase帐户互动，创建/销毁数据。离线模式会导致我们中断通话，在我看来这是撰写本文的首选。</p><p id="70f6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过不定义任何配置选项，在离线模式下初始化SDK。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="bc54" class="mj ky jb mf b gy mk ml l mm mn">const test = require('firebase-functions-test')();</span></pre><p id="553b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们继续编写调用该函数的单元测试，并且应该成功地用async/await进行解析，否则它将抛出一个错误。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="387a" class="mj ky jb mf b gy mk ml l mm mn">const test = require('firebase-functions-test')();<br/>const functions = require('../index.js');</span><span id="0f16" class="mj ky jb mf b gy mo ml l mm mn">describe('onEpisodeTrackCreated', () =&gt; {<br/>  it('successfully invokes function', async () =&gt; {<br/>    const wrapped = test.wrap(functions.onEpisodeTrackCreated);<br/>    const data = { name: 'hello - world', broadcastAt: new Date() }<br/>    await wrapped({<br/>      data: () =&gt; ({<br/>        name: 'hello - world'<br/>      }),<br/>      ref:{<br/>        set: jest.fn()<br/>      }<br/>    })<br/>  })<br/>})</span></pre><p id="bb06" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们现在运行测试时会发生什么？🤔</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5a06" class="mj ky jb mf b gy mk ml l mm mn">FAIL  tests/index.test.js<br/>  onEpisodeTrackCreated<br/>    ✕ successfully invokes function (832ms)</span><span id="ee8f" class="mj ky jb mf b gy mo ml l mm mn">  ● onEpisodeTrackCreated › successfully invokes function</span><span id="73b8" class="mj ky jb mf b gy mo ml l mm mn">    Could not load the default credentials. Browse to https://cloud.google.com/docs/authenti<br/>cation/getting-started for more information.</span><span id="7a57" class="mj ky jb mf b gy mo ml l mm mn">      at GoogleAuth.getApplicationDefaultAsync (node_modules/google-auth-library/build/src/auth/googleauth.js:161:19)<br/>      at GoogleAuth.getClient (node_modules/google-auth-library/build/src/auth/googleauth.js:503:17)<br/>      at GrpcClient._getCredentials (node_modules/google-gax/src/grpc.ts:150:20)<br/>      at GrpcClient.createStub (node_modules/google-gax/src/grpc.ts:295:19)</span><span id="6134" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 failed, 1 total<br/>Tests:       1 failed, 1 total<br/>Snapshots:   0 total<br/>Time:        1.91s</span></pre><p id="0a46" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">😢这可不好。</p><p id="8e70" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仔细想想这个错误，我们的代码中确实有很多错误。这个错误告诉我们一些关于凭证的信息。或许是与<code class="fe mp mq mr mf b">firebase-admin</code>号上的<code class="fe mp mq mr mf b">initializeApp</code>有关？🤔</p><p id="b1f0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将对此进行模拟，看看接下来会发生什么。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="de3f" class="mj ky jb mf b gy mk ml l mm mn">jest.mock('firebase-admin', () =&gt; ({<br/>  initializeApp: jest.fn()<br/>}))</span></pre><p id="f5a3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而结果…</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7c2b" class="mj ky jb mf b gy mk ml l mm mn">FAIL  tests/index.test.js<br/>  ● Test suite failed to run</span><span id="a722" class="mj ky jb mf b gy mo ml l mm mn">    TypeError: admin.firestore is not a function</span><span id="f0fa" class="mj ky jb mf b gy mo ml l mm mn">      3 | <br/>      4 | admin.initializeApp();<br/>    &gt; 5 | let db = admin.firestore();<br/>        |                ^<br/>      6 | <br/>      7 | exports.onEpisodeTrackCreated = functions.firestore.document('episodes/{episodeId}/tracks/{trackIndex}')<br/>      8 |   .onCreate((snap, context) =&gt; {</span><span id="f6f0" class="mj ky jb mf b gy mo ml l mm mn">      at Object.firestore (index.js:5:16)<br/>      at Object.require (tests/index.test.js:23:19)</span><span id="9952" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 failed, 1 total<br/>Tests:       0 total<br/>Snapshots:   0 total<br/>Time:        1.757s</span></pre><p id="97fa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太好了，这是一个更好的位置。因为我们正在调用<code class="fe mp mq mr mf b">firestore</code>，但是我们已经完全模拟了实现，这是意料之中的。</p><p id="a171" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在来完成这个测试的模拟。😅</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6a43" class="mj ky jb mf b gy mk ml l mm mn">const mockQueryResponse = jest.fn()<br/>mockQueryResponse.mockResolvedValue([<br/>  {<br/>    id: 1<br/>  }<br/>])</span><span id="f925" class="mj ky jb mf b gy mo ml l mm mn">jest.mock('firebase-admin', () =&gt; ({<br/>  initializeApp: jest.fn(),<br/>  firestore: () =&gt; ({<br/>   collection: jest.fn(path =&gt; ({<br/>     where: jest.fn(queryString =&gt; ({<br/>       get: mockQueryResponse<br/>     }))<br/>   })) <br/>  })<br/>}))</span></pre><p id="1b0e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一轮。😬</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="73e9" class="mj ky jb mf b gy mk ml l mm mn">PASS  tests/index.test.js<br/>  onEpisodeTrackCreated<br/>    ✓ successfully invokes function (3ms)</span><span id="d068" class="mj ky jb mf b gy mo ml l mm mn">Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        1.026s</span></pre><p id="4d9b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太棒了。🙌</p><p id="e908" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我真的希望这个解决方案能帮助你测试你的下一个项目。</p><h1 id="d333" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">来源</h1><p id="e7ee" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">当然，这个结果并不是自然产生的，而是通过编码阶段在互联网上大量搜索相关解决方案的结果。</p><ul class=""><li id="cd45" class="ms mt jb ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><a class="ae kw" href="https://medium.com/@leejh3224/testing-firebase-cloud-functions-with-jest-4156e65c7d29#0369" rel="noopener">用Gompro的Jest测试Firebase云函数</a></li><li id="d67a" class="ms mt jb ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae kw" href="https://firebase.google.com/docs/functions/unit-testing#testing_background_non-http_functions" rel="noopener ugc nofollow" target="_blank">Google测试后台(非HTTP)功能</a></li><li id="3d0a" class="ms mt jb ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae kw" href="https://jestjs.io/docs/en/asynchronous.html#async-await" rel="noopener ugc nofollow" target="_blank">异步/等待应答</a></li></ul></div></div>    
</body>
</html>