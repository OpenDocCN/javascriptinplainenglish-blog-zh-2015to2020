<html>
<head>
<title>Things you should know before connecting your AWS Lambda function to a database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在将AWS Lambda函数连接到数据库之前，您应该知道的一些事情</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/serverless-things-i-wish-i-had-known-part-2-dynamodb-x-mongodb-x-aurora-serverless-1053cfddff36?source=collection_archive---------2-----------------------#2019-10-16">https://javascript.plainenglish.io/serverless-things-i-wish-i-had-known-part-2-dynamodb-x-mongodb-x-aurora-serverless-1053cfddff36?source=collection_archive---------2-----------------------#2019-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0f505ccef6435e385b339939980e285a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPPMYidjYN1r0So8KGYsoQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Image from <a class="ae kc" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SQLtoNoSQL.Accessing.html" rel="noopener ugc nofollow" target="_blank">Amazon documentation</a></figcaption></figure><p id="60f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">几周前，我写了一篇文章，在文章中我强调了我在使用无服务器的实现<a class="ae kc" href="https://medium.com/@cbernardes/serverless-things-i-wish-i-had-known-before-i-started-part-1-aws-cognito-cf5d3a0c3d9d" rel="noopener"> AWS Cognito用户池时遇到的一些问题。接下来，今天我想描述一下我在选择和使用具有无服务器架构的数据库时发现的一些挑战，并探讨一些重要的lambda概念，这些概念会对无服务器项目的决策产生影响。</a></p><p id="358d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> DynamoDB </strong></p><p id="f9f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您考虑过使用无服务器，并且读过一些AWS的文章或文档，那么您很可能已经找到了使用他们的dynamodb服务来持久化数据的建议。尽管这个数据库有几个好处，但它可能不是所有应用程序类型的最佳选择。让我们考虑一下中等规模API的一些要点:</p><p id="ed62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从内容组织的角度来看，在dynamodb中，表并不像大多数普通数据库那样进行聚合。因为它们是完全独立的，即使它们可以在不同的VPC中分开，所有的表都将显示在一个混合列表中。假设有两个项目，它们都有一个名为“message”的表。我们应该如何命名这些表？pr J1-消息-产品和pr J2-消息-产品？看起来很混乱。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/0e5669fe27f7dcc458129f61d2db5c37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F5H2NrM_JfQl6xV-V6cC5Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">AWS DynamoDB table list</figcaption></figure><p id="dff2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，因为它们非常独立，所以不支持join操作。连一个“填充”都没有。让我们考虑一个简单的查询，列出给定用户的所有消息。为此，有必要在用户的表模式中设计这些信息，或者运行两个查询。现在，图像用户相关的信息(评论、交易、日志、订单等)随着项目的增长而不断增加，结构和表格会变得多大？</p><p id="c7e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从查询的角度来看，语法也没有提供多少帮助。它不直观，写起来费力(这可能是因为我们缺乏经验)，而且可用的ORM也不是很支持。</p><p id="41fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，由于上述因素，我们决定将MongoDB作为无服务器项目的数据库。尽管如此，出于不同的原因(例如微服务)，该工具可能非常适合您的项目，因此，我建议您阅读<a class="ae kc" href="https://serverless.com/dynamodb/" rel="noopener ugc nofollow" target="_blank">无服务器和DynamoDB </a>终极指南，以获得更深入的理解。</p><p id="15c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MongoDB和Lambda:悖论</p><p id="7d15" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着我们向前发展，上述所有问题都很容易解决(我猜是由于以前的经验)，但问题是mongodb是一个连接驱动的数据库。这怎么成问题了？lambda是一组自给自足的代码，每次被调用时都会反复执行，这意味着每次被调用时都需要一个数据库连接。这将增加方法的执行时间并降低其性能，因为我们需要连接和断开数据库。为了更好地理解它，让我们把这个问题分成几个小的概念:</p><p id="8bc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lg">冷启动</em> </strong> <em class="lg">是lambda在其第一次请求时，准备执行其代码所需的所有依赖项的时间段。</em></p><p id="b205" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里的问题是，除了冷启动(启动容器、加载模块、配置等)，数据库连接还会延迟代码执行。请记住，db连接不是冷启动的一部分，因为它是lambda代码执行的一部分，但是它对准备好执行我们的主方法有很大的影响，从技术上讲，每次lambda冷启动时，它也必须进行连接，所以它们是相关的。</p><p id="d30b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">了解到这一点后，为什么我们在使用DynamoDB时没有这个问题呢？因为DynamoDB使用API请求来读写表中的项，而MongoDB依赖于DB连接。换句话说，即使正在使用AWS SDK或AWS CLI，也没有持久的网络连接。因此，为了提高性能，每次lambda被重新调用时，我们都需要使用相同的DB连接。</p><blockquote class="lh"><p id="6809" class="li lj iq bd lk ll lm ln lo lp lq la dk translated">DynamoDB使用API请求来读写表中的项，而MongoDB依赖于DB连接</p></blockquote><p id="1718" class="pw-post-body-paragraph kd ke iq kf b kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw lv ky kz la ij bi translated"><a class="ae kc" href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="lg">事件循环</em> </strong> </a> <em class="lg">允许Node.js执行非阻塞I/O操作——尽管JavaScript是单线程的——尽可能将操作卸载到系统内核。</em></p><p id="57c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么这些信息很重要？因为DB连接是一个工作池，lambda直到运行时堆栈中的所有操作完成后才返回回调，因此，如果连接没有关闭，lambda将超时失败。</p><p id="4f09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您到目前为止一直在跟踪，我们得到的是:为了避免访问数据库期间的性能问题，有必要保持连接打开，但是为了通过回调返回lambda响应，需要关闭连接。我们有一个悖论。</p><p id="248a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">这是怎么解决的？</strong></p><p id="47d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过重置上下文配置选项，配置lambda不等待事件循环运行时为空。</p><pre class="lc ld le lf gt lw lx ly lz aw ma bi"><span id="184a" class="mb mc iq lx b gy md me l mf mg">context.callbackWaitsForEmptyEventLoop = false;</span></pre><p id="478b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，在冻结进程并将结果返回给调用方之前，回调会一直等到运行时事件循环为空。将此属性设置为false会请求AWS Lambda在回调被调用后立即冻结进程，即使事件循环中有事件。AWS Lambda将冻结流程、任何状态数据和事件循环中的事件。如果AWS Lambda选择使用冻结的进程，则在下一次调用Lambda函数时，将处理事件循环中的任何剩余事件。参考自<a class="ae kc" href="https://docs.atlas.mongodb.com/best-practices-connecting-to-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> mongodb最佳实践</a>。</p><p id="de9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们已经从lambda的角度和db连接了解了事情是如何工作的，为了实现该解决方案，必须考虑三件事情:</p><ol class=""><li id="82fb" class="mh mi iq kf b kg kh kk kl ko mj ks mk kw ml la mm mn mo mp bi translated">连接必须在lambda处理程序之外。这是将被冻结的代码。</li><li id="3fe1" class="mh mi iq kf b kg mq kk mr ko ms ks mt kw mu la mm mn mo mp bi translated">在尝试再次连接到数据库之前，您应该检查连接是否已经打开。</li><li id="40d3" class="mh mi iq kf b kg mq kk mr ko ms ks mt kw mu la mm mn mo mp bi translated">在lambda处理程序中，将“callbackWaitsForEmptyEventLoop”设置为false。</li></ol><p id="0f5a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">这里是代码</strong></p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="9f6b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如我们在上面的例子中看到的，整个代码并不复杂，但是当理解了为什么这些配置是必要的时，就更有意义了。如果你一直在使用MySQL，杰里米·戴利的博客上有一个很好的<a class="ae kc" href="https://www.jeremydaly.com/reuse-database-connections-aws-lambda/" rel="noopener ugc nofollow" target="_blank">例子</a>。</p><p id="df9c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">未解决的问题</strong></p><p id="3129" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">考虑到我们已经完全隔离了每个lambda的连接问题，如果应用程序有100+lambda会发生什么？因为lambda是独立的，所以每一个lambda都有自己的DB连接，这将导致MaxListenersExceededWarning和潜在的<a class="ae kc" href="https://github.com/awslabs/aws-serverless-express/issues/242" rel="noopener ugc nofollow" target="_blank">问题</a>。尽管AWS会自动清理未使用的(它们的算法或周期未知)lambda环境，但有几种方法可以帮助缓解这个问题:</p><ol class=""><li id="e28b" class="mh mi iq kf b kg kh kk kl ko mj ks mk kw ml la mm mn mo mp bi translated">有多个端点方法引用同一个处理程序，这将导致创建一个lambda，但为多个方法服务。示例:假设端点get: <strong class="kf ir"> cms/messages/{id} </strong>，<strong class="kf ir"> put: cms/messages/{id} </strong>和<strong class="kf ir">delete:CMS/messages/{ id }</strong>。因为它们具有相同的结构，所以它们可以调用相同的处理程序。然后，处理程序会根据它们的方法将它们路由到不同的数据库操作。缺点是lambda需要更多的资源，缺乏粒度管理，可能还有额外的代码/架构复杂性。</li><li id="2de7" class="mh mi iq kf b kg mq kk mr ko ms ks mt kw mu la mm mn mo mp bi translated">更改数据库配置，尽量避免过多的连接，并在连接发生时做出反应。杰里米在他的博客上有一篇很棒的<a class="ae kc" href="https://www.jeremydaly.com/manage-rds-connections-aws-lambda/" rel="noopener ugc nofollow" target="_blank">文章</a>，就如何管理关系提出了建议。</li></ol><p id="e636" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">也许AWS应该为这个独特的问题提供某种共享的lambda资源。这违背了lambda独立性的目的，但对于API开发来说，这也是非常重要的。</p><p id="0ea3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好消息是，亚马逊去年(2018年8月9日)推出了Aurora无服务器服务，根据杰瑞米的<a class="ae kc" href="https://www.jeremydaly.com/aurora-serverless-the-good-the-bad-and-the-scalable/" rel="noopener ugc nofollow" target="_blank">文章</a>，这似乎是一个不错的选择。如果我几个月前就开始这个项目，我会给它一个机会。更重要的是，这一公告表明，供应商正在不断努力改善他们的服务。</p><p id="0e6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">总而言之</strong></p><p id="61c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在实现无服务器项目时，很难选择最好的工具或正确的架构，但是如果很好地理解并考虑了这些概念，做出正确的决定会变得更容易。</p><p id="fead" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">信用</strong></p><p id="3a52" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想给Jeremy的博客<a class="ae kc" href="https://www.jeremydaly.com" rel="noopener ugc nofollow" target="_blank">一点额外的奖励，在那里我找到了我所涉及的主题的很好的参考和用例。它包含了大量与无服务器相关的信息。</a></p><p id="1ef9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">资源</strong></p><p id="6334" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://serverless.com/dynamodb" rel="noopener ugc nofollow" target="_blank">https://serverless.com/dynamodb</a><br/>T3】https://docs . AWS . Amazon . com/Amazon dynamodb/latest/developer guide/SQLtoNoSQL。Accessing.html<br/><a class="ae kc" href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick" rel="noopener ugc nofollow" target="_blank">https://nodejs . org/en/docs/guides/event-loop-timers-and-next tick</a><br/><a class="ae kc" href="https://www.jeremydaly.com/reuse-database-connections-aws-lambda" rel="noopener ugc nofollow" target="_blank">https://www . Jeremy Daly . com/reuse-database-connections-AWS-lambda</a><br/><a class="ae kc" href="https://docs.atlas.mongodb.com/best-practices-connecting-to-aws-lambda" rel="noopener ugc nofollow" target="_blank">https://docs . atlas . MongoDB . com/best-practices-connecting-to-AWS-lambda</a><br/><a class="ae kc" href="https://mongoosejs.com/docs/lambda.html" rel="noopener ugc nofollow" target="_blank">https://mongoosejs.com/docs/lambda.html</a><br/><a class="ae kc" href="https://github.com/awslabs/aws-serverless-express/issues/242" rel="noopener ugc nofollow" target="_blank">https:/</a></p><h2 id="b4e6" class="mb mc iq bd mx my mz dn na nb nc dp nd ko ne nf ng ks nh ni nj kw nk nl nm nn bi translated">← <a class="ae kc" href="https://medium.com/@cbernardes/serverless-things-i-wish-i-had-known-before-i-started-part-1-aws-cognito-cf5d3a0c3d9d" rel="noopener">第1部分- AWS认知</a></h2></div></div>    
</body>
</html>