<html>
<head>
<title>Building Map Interface Apps using a Geo JSON GraphQL API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Geo JSON GraphQL API构建地图界面应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-map-interface-apps-using-a-geo-json-graphql-api-55b2f802d517?source=collection_archive---------8-----------------------#2020-09-17">https://javascript.plainenglish.io/building-map-interface-apps-using-a-geo-json-graphql-api-55b2f802d517?source=collection_archive---------8-----------------------#2020-09-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f0c046afd913816cb81a8a84ca53d3a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oDbH0lNsqggTAmQU.jpg"/></div></div></figure><p id="e83b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">开发依靠地理坐标来实现重要功能的应用程序，必须远远超越简单地存储纬度和经度数据。计算边界和距离的地理坐标算法可能是一个有趣的大脑挑战，尽管它们往往会耗费时间，分散人们对核心项目的注意力。‍</p><p id="168d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将了解如何快速设置和使用一个高级的、随时可以使用地理坐标操作的API。不管你是在构建一个基于地图的房地产应用程序，一个显示用户离餐馆距离的美食评论网站，还是任何其他需要使用地理坐标数据的应用程序；本教程将适用于任何这样的用例。</p><p id="4287" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也就是说，我们将使用一个食品评论应用程序的例子，它需要向用户显示他们离被评论的餐馆的距离。所以让我们开始吧！</p><h1 id="3dd5" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">辅导的</h1><p id="737a" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">首先，你需要一个8英尺的工作空间。这个免费计划对本教程来说很好，所以如果你还没有在app.8base.com注册，那就去注册吧。</p><p id="504a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录8base后，我们需要为我们的评论建立一个简单的数据模型。它看起来会像这样:</p><p id="f4a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">餐馆</strong></p><ul class=""><li id="ae36" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">名称:文本</li><li id="4428" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">位置:地理位置</li><li id="8a48" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">点评:有很多Reviews‍</li></ul><p id="fc96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">点评</strong></p><ul class=""><li id="abb7" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">内容:文本</li><li id="fbdb" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">评级:数字</li><li id="5f2d" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">餐馆:有一家餐馆</li></ul><h1 id="8ff1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">导入数据模型和种子数据</h1><p id="500d" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">欢迎您使用8base data builder快速构建这个数据模型。但是，我建议使用CLI导入模式和种子数据。它不仅可以快速建立数据模型，还可以用20家餐馆和40条评论填充数据库。</p><p id="273c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下命令将使您快速启动并运行！您需要将最后一个导入命令的路径提供给<a class="ae mn" href="https://github.com/8base/geo-coordinates-tutorial-101/blob/master/schema-and-data.json" rel="noopener ugc nofollow" target="_blank">这个文件</a>。‍</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6b28" class="mx kx iq mt b gy my mz l na nb"># Install the cli<br/>npm install -g 8base-cli<br/># Authenticate the CLI<br/>8base login<br/># Create an empty 8base project and select workspace<br/>8base init rr-tutorial -e<br/># Import the schema<br/>8base import -f [PATH_TO schema-and-data.json]<br/>{% code-block-end%}‍</span></pre><p id="7848" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，应该已经建立了数据模型，种子数据已经准备好可以使用了！您可以跳回8base控制台，查看Data Builder/Viewer来查看导入的模式和记录。它看起来会像下面的截图。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/f0f890f270267505458b190e6214fe81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e4-n1iE49oYuFQbUjvAclQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">8base data viewer with imported records</figcaption></figure><h1 id="6bc7" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">查看保存的位置数据</h1><p id="5de4" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果您查看<em class="nh">餐馆</em>表，您会看到有一个名为<em class="nh">位置</em>的字段，它选择了类型<em class="nh">地理</em>，格式设置为<em class="nh">点</em>。地理点只是一个纬度和经度坐标，它们共同引用了地图上的一个特定点。</p><p id="82c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在切换到数据选项卡，您将看到<em class="nh">位置</em>列以数组的形式显示所有的纬度和经度坐标。这就是API接收数据的方式，尽管当通过UI 8base编辑记录时，这两个值是分开的。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/9849bfa7dbff76d428f1cd02e470fd2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ENKar_QX8kAU7tLUdtsJsw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Editing latitude and longitude fields in 8base console</figcaption></figure><p id="d831" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了这个由8base自动生成的GraphQL API，我们所有的地理坐标操作都可以使用了。因此，让我们跳到API Explorer，看看我们可以访问什么样的查询和变化。</p><h1 id="e980" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">使用地理过滤编写查询</h1><p id="7738" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">当用户使用您的应用程序或网站时，有许多方法可以获取用户的当前位置。例如，许多现代浏览器已经实现了地理定位API，提示用户允许访问他们当前的位置。获得授权后，下面的代码片段将使用地理坐标返回用户的位置。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c471" class="mx kx iq mt b gy my mz l na nb">‍navigator.geolocation.getCurrentPosition(<br/> ({ coords: { latitude, longitude } }) =&gt; console.log([latitude, longitude])<br/>)</span></pre><p id="8cc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用返回的纬度和经度，您将能够将用户的位置作为参数传递给GraphQL查询。在这个例子中，我们只是碰巧使用了用户的当前位置。任何有效的地理坐标都可以传递给查询，用于过滤，这取决于用例。</p><p id="94ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，让我们继续编写一个查询，允许我们使用米来过滤一个餐馆离用户当前位置的距离。我们将手动设置用户的当前位置为纬度40.748981经度-73.985910大致是纽约市的帝国大厦。</p><p id="e89f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="nh">剧透提醒:餐厅数据是曼哈顿所有的地方！</em> </strong> ‍</p><p id="68c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在API Explorer中，打开<em class="nh">变量</em>输入并粘贴到下面的JSON blob中。我们将能够在查询编辑器中用作参数的顶级键。‍</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="5f64" class="mx kx iq mt b gy my mz l na nb">{<br/>  “distance”: 2500,<br/>  “userLocation”: {<br/>    “type”: “Point”,<br/>    “coordinates”: [40.748981, -73.98591]<br/>  }<br/>}</span></pre><p id="4f0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">‍Now:我们将写出实际的查询。请参阅下面的内容，并阅读代码注释中的上下文！</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f414" class="mx kx iq mt b gy my mz l na nb">query(<br/>  # Set arguments with specified required types<br/>  $userLocation: GeometryInput!<br/>  $distance: Float!<br/>) {<br/>  # User restaurantsList query with filter<br/>  restaurantsList(<br/>    filter: {<br/>      location: {<br/>        # When filtering on a Geo type Field, we can use the Distance predicate.<br/>        distance: {<br/>          # Specify the users current location (argument format)<br/>          from: $userLocation<br/>          unit: meters<br/>          value: {<br/>            # Get results LESS THAN OR EQUAL TO (lte) the specified distance<br/>            lte: $distance<br/>          }<br/>        }<br/>      }<br/>    }<br/>  ) {<br/>    count<br/>    items {<br/>      name<br/>      location {<br/>        coordinates<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="4f91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行查询，然后嘣…我们开始工作了！不完全是。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/cb4b0f2f28cf467b7941e9f93cbcc82a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LYoJXFowWal_14oghtquiA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Filtering records by distance from a lat-long point</figcaption></figure><p id="83a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">‍We可以看到，从我们给定的用户位置，6家餐馆在2500米以内。然而，我们只过滤了列表，并在响应中获得了地理坐标。我们需要的是从我们的用户那里得到实际的距离计算结果！</p><h1 id="f983" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">使用额外字段返回距离计算结果</h1><p id="5c15" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将能够使用一个叫做extraFields的API特性来完成这个任务。本质上，我们要做的是返回一个计算结果，它不是核心数据模型的一部分。这就是extraFields使我们能够做到的。</p><p id="a5ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们稍微修改一下我们的查询来完成这个需求。就像上次一样，在下面看到它，并阅读上下文的代码内注释！‍</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="965e" class="mx kx iq mt b gy my mz l na nb">query(<br/>  # Set the same arguments with specified required types<br/>  $userLocation: GeometryInput!<br/>  $distance: Float!<br/>) {<br/>  # User restaurantsList query with filter and extraFields<br/>  restaurantsList(<br/>    extraFields: {<br/>      # Specify which field the "extra field" will be calculated from<br/>      location: {<br/>        # Give the new field a unique name<br/>        as: "distanceFromUser"<br/>        fn: {<br/>          # Declare the function calculate that will be used. In this case, distance from the userLocation using meters.<br/>          distance: { from: $userLocation, unit: meters }<br/>        }<br/>      }<br/>    }<br/>    filter: {<br/>      # Instead of repeating ourselves in the filter, we can filter using the extraField that's getting calculated!<br/>      _extraField: {<br/>        # Specify the extraField we're filtering by.<br/>        alias: "distanceFromUser"<br/>        # Declare the field type and relevant predicate. In this case, a float less than the specified distance.<br/>        float: { lt: $distance }<br/>      }<br/>    }<br/>  ) {<br/>    count<br/>    items {<br/>      name<br/>      # extraFields can then be collected in the response like so.<br/>      _extraFields {<br/>        distanceFromUser: Float<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="c8dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相当酷！对吗？正如您在回复中看到的，您现在得到了用户距离不同餐馆位置的精确距离(米)。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/a8a64f7d567a10b92d18ef424337ef97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_O__WAuW8MZJz3yzSLmRw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Using extraFields distances with lat long points</figcaption></figure><h1 id="5a95" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">向查询中添加分组和聚合</h1><p id="af4e" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">可以想象，用户可以在UI中调整<code class="fe nk nl nm mt b">$distance</code>。例如，他们可以在使用应用程序时选择1公里、5公里或10公里作为距离，然后查询将相应地运行和过滤。也就是说，结合我们刚刚探索的地理坐标过滤器，可以生成其他类型的数据。</p><p id="d313" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，如果用户不仅想看到2500米内的餐馆，还想看到评论的平均评分，该怎么办？这怎么可能实现呢？</p><p id="e9fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯，通过深入API的<code class="fe nk nl nm mt b">groubBy</code>特性，我们将能够完成下一个层次的复杂性。我们来看看吧！</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c212" class="mx kx iq mt b gy my mz l na nb">query(<br/>  # Set arguments with specified required types<br/>  $userLocation: GeometryInput!<br/>  $distance: Float!<br/>) {<br/>  # User restaurantsList query with filter<br/>  restaurantsList(<br/>    extraFields: {<br/>      # Specify which field the "extra field" will be calculated from<br/>      location: {<br/>        # Give the new field a unique name<br/>        as: "distanceFromUser"<br/>        fn: {<br/>          # Declare the function calculate that will be used. In this case, distance from the userLocation using meters.<br/>          distance: { from: $userLocation, unit: meters }<br/>        }<br/>      }<br/>    }<br/>    filter: {<br/>      # Instead of repeating ourselves in the filter, we can filter using the extraField that's getting calculated!<br/>      _extraField: {<br/>        # Specify the extraField we're filtering by.<br/>        alias: "distanceFromUser"<br/>        # Declare the field type and relevant predicate. In this case, a float less than the specified distance.<br/>        float: { lt: $distance }<br/>      }<br/>    }<br/>  ) {<br/>    count<br/>    items {<br/>      name<br/>      _extraFields {<br/>        distanceFromUser: Float<br/>      }<br/>      # In the response we specify a groupBy argument to the relation<br/>      reviews(<br/>        groupBy: {<br/>          query: {<br/>            # On the ratings field, we aggregate an average of the reviews belonging to a restaurant.<br/>            rating: { as: "avgRating", fn: { aggregate: AVG } }<br/>            # We alias the grouping as reviews<br/>            _group: { as: "reviews" }<br/>          }<br/>        }<br/>      ) {<br/>        groups {<br/>          # In each group, we return the avgRating as a float<br/>          avgRating: Float<br/>          # We return the "items" (reviews) with content and the individual rating<br/>          reviews: ReviewGroup {<br/>            items {<br/>              content<br/>              rating<br/>            }<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="d184" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">预期响应的示例如下。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ab4e" class="mx kx iq mt b gy my mz l na nb">{<br/>  "data": {<br/>    "restaurantsList": {<br/>      "count": 6,<br/>      "items": [<br/>        {<br/>          "name": "The Burrito Box",<br/>          "_extraFields": {<br/>            "distanceFromUser": 2149.482589321746<br/>          },<br/>          "reviews": {<br/>            "groups": [<br/>              {<br/>                "avgRating": 4,<br/>                "reviews": {<br/>                  "items": [<br/>                    {<br/>                      "content": "I liked it!",<br/>                      "rating": 4<br/>                    },<br/>                    {<br/>                      "content": "It was okay.",<br/>                      "rating": 4<br/>                    }<br/>                  ]<br/>                }<br/>              }<br/>            ]<br/>          }<br/>        },<br/>        {<br/>          "name": "Chick'nCone",<br/>          "_extraFields": {<br/>            "distanceFromUser": 2101.9531673470437<br/>          },<br/>          "reviews": {<br/>            "groups": [<br/>              {<br/>                "avgRating": 4.5,<br/>                "reviews": {<br/>                  "items": [<br/>                    {<br/>                      "content": "It was okay.",<br/>                      "rating": 4.5<br/>                    },<br/>                    {<br/>                      "content": "I liked it!",<br/>                      "rating": 4.5<br/>                    }<br/>                  ]<br/>                }<br/>              }<br/>            ]<br/>          }<br/>        }<br/>        // ... more!<br/>      ]<br/>    }<br/>  }<br/>}‍</span></pre><h1 id="1648" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">最后的想法</h1><p id="8afc" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">正如所展示的，使用现有的API平台，我们能够快速建立一个极其强大的API，其中内置了高级地理坐标操作。这适用于您可能正在构建的各种应用程序。</p><p id="9411" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望你发现这是有用的和有趣的！如果您有任何问题，以及您最终使用8base构建了什么项目，请告诉我们！</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="0079" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh">原载于【https://www.8base.com】<a class="ae mn" href="https://www.8base.com/blog/building-map-interface-apps-using-a-geo-json-graphql-api" rel="noopener ugc nofollow" target="_blank"><em class="nh"/></a><em class="nh">。</em></em></p></div></div>    
</body>
</html>