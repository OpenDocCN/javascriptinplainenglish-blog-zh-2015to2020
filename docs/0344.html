<html>
<head>
<title>How to Schedule Cron Jobs in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Node.js中调度Cron作业</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-schedule-cron-jobs-in-node-js-897215e2e5d3?source=collection_archive---------1-----------------------#2019-09-22">https://javascript.plainenglish.io/how-to-schedule-cron-jobs-in-node-js-897215e2e5d3?source=collection_archive---------1-----------------------#2019-09-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f0a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多应用程序需要运行某种调度任务来完成系统维护、管理、每日数据备份或发送电子邮件等日常工作。Cron是一个基于时间的作业调度程序，它使应用程序能够调度作业在某个特定的日期或时间自动运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/468251591455700f4f3827650b3e1d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*L3jvQ5MsinHwxHVEkPjiGw.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Node.js</figcaption></figure><p id="c146" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Node.js中有各种开源工具可用于调度cron作业。在本文中，我们将使用一个名为<a class="ae kx" href="https://github.com/node-cron/node-cron" rel="noopener ugc nofollow" target="_blank"> <em class="ky"> node-cron </em> </a>的模块来查看一个简单的示例。</p><h1 id="a852" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">安装依赖项</h1><p id="b645" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在本文中，我们将创建一个cron作业来发送电子邮件。通过在终端或bash中运行以下命令，创建一个简单的Node.js项目。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="9472" class="mh la iq md b gy mi mj l mk ml">mkdir<!-- --> node-cron-job-scheduler</span><span id="9dce" class="mh la iq md b gy mm mj l mk ml">cd<!-- --> node-cron-job-scheduler</span><span id="cd9a" class="mh la iq md b gy mm mj l mk ml">npm<!-- --> init -y</span><span id="c095" class="mh la iq md b gy mm mj l mk ml">touch index.js</span></pre><p id="cec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装下列依赖项。</p><blockquote class="mn mo mp"><p id="283f" class="jn jo ky jp b jq jr js jt ju jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj kk ij bi translated"><code class="fe mt mu mv md b">npm install — save express node-cron nodemailer</code></p></blockquote><p id="d72e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="ky"> index.js </em>文件中，导入上述依赖关系。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="0624" class="mh la iq md b gy mi mj l mk ml">const cron = require(“node-cron”);</span><span id="ba39" class="mh la iq md b gy mm mj l mk ml">const express = require(“express”);</span><span id="6caa" class="mh la iq md b gy mm mj l mk ml">const nodeMailer = require(‘nodemailer’);</span></pre><p id="ed83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将通过添加以下内容来创建一个简单的节点服务器:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="2b82" class="mh la iq md b gy mi mj l mk ml">app = express();</span><span id="6eb3" class="mh la iq md b gy mm mj l mk ml">…</span><span id="8d23" class="mh la iq md b gy mm mj l mk ml">app.listen(8000);</span></pre><h1 id="fb4c" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建测试电子邮件帐户</h1><p id="dcb9" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在我们创建cron作业之前，让我们在<a class="ae kx" href="https://ethereal.email/" rel="noopener ugc nofollow" target="_blank">https://ethereal.email/</a>创建一个测试电子邮件帐户。我们将使用这些测试凭据发送电子邮件。我们也可以使用<a class="ae kx" href="https://nodemailer.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ky">节点邮件</em> </a>模块创建测试用户帐户，如下所示:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="e4f2" class="mh la iq md b gy mi mj l mk ml">let<!-- --> testAccount = nodemailer.createTestAccount();</span></pre><p id="a0dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mt mu mv md b"><em class="ky">testAccount.user</em> and <em class="ky">testAccount.pass </em>can be used for providing credentials to Mail transporter object.</code></p><h1 id="6476" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><code class="fe mt mu mv md b">Scheduling Cron Job</code></h1><p id="ecd6" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">让我们使用node-cron模块创建一个cron作业。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="e402" class="mh la iq md b gy mi mj l mk ml">cron.schedule(“* * * * *”, function () {</span><span id="6ff4" class="mh la iq md b gy mm mj l mk ml">console.log(“Running Cron Job”);</span><span id="e998" class="mh la iq md b gy mm mj l mk ml">});</span></pre><p id="1a11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，cron作业每分钟都在运行。启动Node.js服务器，每分钟都会在控制台看到消息<em class="ky">“Running Cron Job”</em>。我们可以将作业安排在不同的日期或时间。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/f61c56fdd7d5eb565522974c729d9236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-5M8M9hWkJ8ybVjlNnIqwA.png"/></div></div></figure><p id="6de3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:" * * 5 * *" = &gt;这表示每个月的5号。“30 7 * * *”代表每天的第7小时30分钟。</p><p id="9f72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们添加使用cron作业中的<em class="ky"> nodemailer </em>模块发送电子邮件的逻辑。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="c935" class="mh la iq md b gy mi mj l mk ml">let transporter = nodeMailer.createTransport({</span><span id="ff42" class="mh la iq md b gy mm mj l mk ml">host: ‘smtp.ethereal.email’,</span><span id="6b43" class="mh la iq md b gy mm mj l mk ml">port: 587,</span><span id="d0fc" class="mh la iq md b gy mm mj l mk ml">secure: false, // true for 465, false for other ports</span><span id="4753" class="mh la iq md b gy mm mj l mk ml">auth: {</span><span id="d336" class="mh la iq md b gy mm mj l mk ml">user: ‘&lt;TEST_USER&gt;’, // generated ethereal user</span><span id="2d6d" class="mh la iq md b gy mm mj l mk ml">pass: ‘&lt;TEST_PASSWORD&gt;’ // generated ethereal password</span><span id="7405" class="mh la iq md b gy mm mj l mk ml">}</span><span id="d01a" class="mh la iq md b gy mm mj l mk ml">});</span><span id="cc97" class="mh la iq md b gy mm mj l mk ml">const mailOptions = {</span><span id="14b9" class="mh la iq md b gy mm mj l mk ml">from: ‘“John Doe” &lt;john.doe@example.com&gt;’, // sender address</span><span id="9a41" class="mh la iq md b gy mm mj l mk ml">to: ‘jane.doe@example.com’, // list of receivers</span><span id="9f2c" class="mh la iq md b gy mm mj l mk ml">subject: ‘Hello there!’, // Subject line</span><span id="75c9" class="mh la iq md b gy mm mj l mk ml">text: ‘A Message from Node Cron App’, // plain text body</span><span id="5954" class="mh la iq md b gy mm mj l mk ml">html: ‘&lt;b&gt;A Message from Node Cron App&lt;/b&gt;’ // html body</span><span id="f836" class="mh la iq md b gy mm mj l mk ml">};</span><span id="b768" class="mh la iq md b gy mm mj l mk ml">transporter.sendMail(mailOptions, function (error, info) {</span><span id="01f6" class="mh la iq md b gy mm mj l mk ml">console.log(info.messageId);</span><span id="a9b0" class="mh la iq md b gy mm mj l mk ml">if (err) {</span><span id="743d" class="mh la iq md b gy mm mj l mk ml">console.log(err);</span><span id="704a" class="mh la iq md b gy mm mj l mk ml">}</span><span id="431f" class="mh la iq md b gy mm mj l mk ml">});</span></pre><p id="3ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们使用<em class="ky">节点邮件</em>模块创建了一个transporter对象，并且我们使用<em class="ky"> Ethereal </em>作为SMTP服务器。提供我们之前创建的测试帐户凭据。</p><p id="4df7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="ky"> mailOptions </em>对象中，我们已经提供了构建电子邮件所需的所有信息。</p><h1 id="bf56" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">测试Cron作业</h1><p id="ea88" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">使用命令<code class="fe mt mu mv md b"><em class="ky">node index.js</em></code> <em class="ky">运行服务器。</em>我们每分钟都会在控制台中看到消息Id，如下所示:</p><blockquote class="mn mo mp"><p id="a20b" class="jn jo ky jp b jq jr js jt ju jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj kk ij bi translated">运行Cron作业<br/>&lt;<a class="ae kx" href="mailto:bd7dd14e-3e9b-e495-12d5-c5e67a11af5c@example.com" rel="noopener ugc nofollow" target="_blank">bd7dd14e-3e9b-e495–12d5-c5e67a11af5c@example.com</a>&gt;</p></blockquote><p id="446a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="ky"> Ethereal站点中，</em>我们可以看到使用下面截图中的按钮从服务器发送的电子邮件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nb"><img src="../Images/022fbb84895bef8a65e8820a3befc888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q7IWBBJk3yWtxDhKo4S04A.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Ethereal website</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nb"><img src="../Images/b4c63fb20a6d8be7ab27bb9f50870e90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7z3bzhf_GH49zrhq93Z-9g.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Test Mails on Ethereal site</figcaption></figure><p id="96e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用我们选择的任何真正的SMTP服务器来发送电子邮件。</p><p id="ce6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章的例子可以在<a class="ae kx" href="https://github.com/swathisprasad/node-scheduling-cron-jobs" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>上找到。</p></div></div>    
</body>
</html>