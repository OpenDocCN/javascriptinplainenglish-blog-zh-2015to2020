<html>
<head>
<title>Create a Shopping App With NativeScript Vue, Firebase and Stripe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NativeScript Vue、Firebase和Stripe创建购物应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-a-shopping-app-with-nativescript-vue-firebase-and-stripe-f8e81a37f986?source=collection_archive---------3-----------------------#2020-01-24">https://javascript.plainenglish.io/create-a-shopping-app-with-nativescript-vue-firebase-and-stripe-f8e81a37f986?source=collection_archive---------3-----------------------#2020-01-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b71b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现代设备带来了现代化的便利，例如，无论您身在何处，都可以通过移动设备购物。使用NativeScript Vue，我将介绍如何创建一个带有产品目录的购物应用程序，该程序使用Firebase和Stripe来处理信用卡支付。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0a2b6a72d8e85a62f6221fbe32fb9df9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*wevMGFUDmx3gcmVHmflLrw.png"/></div></div></figure><p id="36e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个应用程序将依赖Firebase来满足我们的服务器需求，提供认证、数据库和云功能服务。如果你以前没有使用过Firebase，你应该通读一下我在<a class="ae ku" href="https://blog.angelengineering.com/nativescript-vue-firebase-profile/" rel="noopener ugc nofollow" target="_blank">之前的帖子，在那里我解释了如何建立一个Firebase项目</a>。运行相同的步骤来设置一个新的Firebase应用程序，注册它以用于Android和iOS，并在Firebase控制台的身份验证/登录方法下启用电子邮件/密码。您还可以在该页面的templates选项卡下更新Firebase用来发送激活和密码重置电子邮件的模板。</p><p id="9a99" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用CLI命令<code class="fe kv kw kx ky b">tns create ns6shopping</code>创建一个新的NativeScript Vue应用程序，并选择空白的Vue模板。这将是一个单一的框架应用程序，将包括登录页面，产品画廊，产品详情页面和支付页面。如果你想用<a class="ae ku" href="https://www.nativescript.org/blog/getting-your-route-on-with-nativescript-vue-episode-two" rel="noopener ugc nofollow" target="_blank">多框架应用</a>来试验，你可以用Tabs Vue模板创建一个，并在单个标签上工作来框架里面的商店页面。编辑<code class="fe kv kw kx ky b">/app.js</code>并替换为以下内容:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="2eaa" class="ld le in ky b gy lf lg l lh li">import Vue from "nativescript-vue";<br/>import Login from "./components/Login";<br/>new Vue({<br/>    template: `<br/>        &lt;Frame&gt;<br/>            &lt;Login /&gt;<br/>        &lt;/Frame&gt;`,<br/>    components: {<br/>        Login<br/>    }<br/>}).$start();</span></pre><p id="1f88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这告诉应用程序在单个框架中初始化和加载登录页面。添加新的登录页面为<code class="fe kv kw kx ky b">/app/components/Login.vue</code>:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="6c62" class="ld le in ky b gy lf lg l lh li">&lt;template&gt;<br/>    &lt;Page actionBarHidden="true" backgroundSpanUnderStatusBar="true"&gt;<br/>        &lt;FlexboxLayout class="page"&gt;<br/>            &lt;StackLayout class="form"&gt;<br/>                &lt;Image class="logo" src="~/images/NativeScript-Vue.png" /&gt;<br/>                &lt;Label class="header" text="SHOPPER" /&gt;<br/>                &lt;StackLayout class="input-field" marginBottom="25"&gt;<br/>                    &lt;TextField class="input" hint="Email" keyboardType="email" autocorrect="false" autocapitalizationType="none" v-model="user.email" returnKeyType="next" @returnPress="focusPassword" fontSize="18" /&gt;<br/>                    &lt;StackLayout class="hr-light" /&gt;<br/>                &lt;/StackLayout&gt;<br/>                &lt;StackLayout class="input-field" marginBottom="25"&gt;<br/>                    &lt;TextField ref="password" class="input" hint="Password" secure="true" v-model="user.password" :returnKeyType="isLoggingIn ? 'done' : 'next'" @returnPress="focusConfirmPassword" fontSize="18" /&gt;<br/>                    &lt;StackLayout class="hr-light" /&gt;<br/>                &lt;/StackLayout&gt;<br/>                &lt;StackLayout v-show="!isLoggingIn" class="input-field"&gt;<br/>                    &lt;TextField ref="confirmPassword" class="input" hint="Confirm password" secure="true" v-model="user.confirmPassword" returnKeyType="done" fontSize="18" /&gt;<br/>                    &lt;StackLayout class="hr-light" /&gt;<br/>                &lt;/StackLayout&gt;<br/>                &lt;Button :text="isLoggingIn ? 'Log In' : 'Sign Up'" @tap="submit" class="btn btn-primary m-t-20" /&gt;<br/>                &lt;Label v-show="isLoggingIn" text="Forgot your password?" class="login-label" @tap="forgotPassword" /&gt;<br/>                &lt;Label class="login-label sign-up-label" @tap="toggleForm"&gt;<br/>                    &lt;FormattedString&gt;<br/>                    	&lt;Span :text="isLoggingIn ? 'Don’t have an account? ' : 'Back to Login'" /&gt;<br/>                    	&lt;Span :text="isLoggingIn ? 'Sign up' : ''" class="bold" /&gt;<br/>                    &lt;/FormattedString&gt;<br/>                &lt;/Label&gt;<br/>            &lt;/StackLayout&gt;<br/>        &lt;/FlexboxLayout&gt;<br/>    &lt;/Page&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import HomePage from "./Home";<br/>var firebase = require("nativescript-plugin-firebase"); <br/>export default {<br/>    data() {<br/>        return {<br/>            isLoggingIn: true,<br/>            user: {<br/>                email: "foo@foo.com",<br/>                password: "foo",<br/>                confirmPassword: "foo"<br/>            },<br/>            userService: {<br/>                register(user) {<br/>                    return Promise.resolve(user);<br/>                },<br/>                login(user) {<br/>                    return Promise.resolve(user);<br/>                },<br/>                resetPassword(email) {<br/>                    return Promise.resolve(email);<br/>                }<br/>            }<br/>        };<br/>    },<br/>    mounted(){<br/>        firebase<br/>            .init({<br/>            })<br/>            .then(<br/>                function(instance) {<br/>                    console.log("firebase.init done");<br/>                },<br/>                function(error) {<br/>                    console.log("firebase.init error: " + error);<br/>                }<br/>            );<br/>    },<br/>    methods: {<br/>        toggleForm() {<br/>            this.isLoggingIn = !this.isLoggingIn;<br/>        },<br/>        submit() {<br/>            if (!this.user.email || !this.user.password) {<br/>                this.alert("Please provide both an email address and password.");<br/>                return;<br/>            }<br/>            if (this.isLoggingIn) {<br/>                this.login();<br/>            } else {<br/>                this.register();<br/>            }<br/>        },<br/>        login() {<br/>            let that = this<br/>            this.userService<br/>                .login(this.user)<br/>                .then(() =&gt; {<br/>                    this.$navigateTo(HomePage, { clearHistory: true });<br/>                })<br/>                .catch(() =&gt; {<br/>                    this.alert("Unfortunately we could not find your account.");<br/>                });<br/>        },<br/>        register() {<br/>            if (this.user.password != this.user.confirmPassword) {<br/>                this.alert("Your passwords do not match.");<br/>                return;<br/>            }<br/>            this.userService<br/>                .register(this.user)<br/>                .then(() =&gt; {<br/>                    this.alert("Your account was successfully created.");<br/>                    this.isLoggingIn = true;<br/>                })<br/>                .catch(() =&gt; {<br/>                    this.alert("Unfortunately we were unable to create your account.");<br/>                });<br/>        },<br/>        forgotPassword() {<br/>            let that = this<br/>            prompt({<br/>                title: "Forgot Password",<br/>                message: "Enter the email address you used to register for APP NAME to reset your password.",<br/>                inputType: "email",<br/>                defaultText: "",<br/>                okButtonText: "Ok",<br/>                cancelButtonText: "Cancel"<br/>            }).then(data =&gt; {<br/>                if (data.result) {<br/>                    that.userService<br/>                        .resetPassword(data.text.trim())<br/>                        .then(() =&gt; {<br/>                            that.alert(<br/>                                "Your password was successfully reset. Please check your email for instructions on choosing a new password."<br/>                            );<br/>                        })<br/>                        .catch(() =&gt; {<br/>                            that.alert(<br/>                                "Unfortunately, an error occurred resetting your password."<br/>                            );<br/>                        });<br/>                }<br/>            });<br/>        },<br/>        focusPassword() {<br/>            this.$refs.password.nativeView.focus();<br/>        },<br/>        focusConfirmPassword() {<br/>            if (!this.isLoggingIn) {<br/>                this.$refs.confirmPassword.nativeView.focus();<br/>            }<br/>        },<br/>        alert(message) {<br/>            return alert({<br/>                title: "Shopper",<br/>                okButtonText: "OK",<br/>                message: message<br/>            });<br/>        }<br/>    }<br/>};<br/>&lt;/script&gt;	<br/>&lt;style scoped&gt;<br/>.page {<br/>    align-items: center;<br/>    flex-direction: column;<br/>}<br/>.form {<br/>    margin-left: 30;<br/>    margin-right: 30;<br/>    flex-grow: 2;<br/>    vertical-align: middle;<br/>}<br/>.logo {<br/>    margin-bottom: 12;<br/>    height: 90;<br/>    font-weight: bold;<br/>}<br/>.header {<br/>    horizontal-align: center;<br/>    font-size: 25;<br/>    font-weight: 600;<br/>    margin-bottom: 70;<br/>    text-align: center;<br/>    color: rgb(51, 51, 206);<br/>}<br/>.input-field {<br/>    margin-bottom: 25;<br/>}<br/>.input {<br/>    font-size: 18;<br/>    placeholder-color: #A8A8A8;<br/>}<br/>.input-field .input {<br/>    font-size: 54;<br/>}<br/>.btn-primary {<br/>    height: 50;<br/>    margin: 30 5 15 5;<br/>    background-color: rgb(51, 51, 206);<br/>    color: white;<br/>    border-radius: 5;<br/>    font-size: 20;<br/>    font-weight: 600;<br/>}<br/>.login-label {<br/>    horizontal-align: center;<br/>    color: #A8A8A8;<br/>    font-size: 16;<br/>}<br/>.sign-up-label {<br/>    margin-bottom: 20;<br/>}<br/>.bold {<br/>    color: #000000;<br/>}<br/>&lt;/style&gt;</span></pre><p id="c170" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你想了解这里发生的事情，这个页面在之前的帖子中有更详细的解释。看看这个页面，你会发现我们有一个单独的页面来处理登录、注册和忘记密码的请求，现在绑定到虚拟函数。我们使用了前一篇文章中的NativeScript Vue徽标图像，复制到了<code class="fe kv kw kx ky b">/app/images/NativeScript-Vue.png</code>。</p><p id="c42f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在ios模拟器上运行该应用程序，如果运行正常，您应该会看到控制台上打印的<code class="fe kv kw kx ky b">firebase.init done</code>。确保已经从Firebase控制台下载了Android和iOS配置文件，如果没有，将它们放在<code class="fe kv kw kx ky b">app/App_Resources</code>下相应的目录中。如果你尝试在Android上运行这个，你可能会遇到下面的错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/46514a455c93318c6def4754751eafb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/0*iXS9jEo0AEtDUeZ_.png"/></div></figure><p id="e484" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了解决这个问题，我们将在<code class="fe kv kw kx ky b">app/App_Resources/Android/app.gradle</code>的<code class="fe kv kw kx ky b">defaultConfig</code>部分添加以下内容:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="de25" class="ld le in ky b gy lf lg l lh li">multiDexEnabled true</span></pre><p id="fb3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在Android上运行时，您现在应该会看到相同的成功初始化消息。运行该应用程序，您应该会看到如下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/d6a93bd50cd8a59683bedfc3bf734285.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/0*X25OQ1DzgSkYbQad.png"/></div></figure><p id="4972" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的登录前端已经准备好了，现在我们将集成Firebase来提供认证服务。</p><h1 id="7469" class="ll le in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">使用Firebase进行身份验证</h1><p id="9c67" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">在继续使用之前，我们需要为NativeScript安装Firebase插件:</p><p id="56a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe kv kw kx ky b">tns plugin add nativescript-plugin-firebase</code></p><p id="2793" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将询问您要启用哪些Firebase服务，对于身份验证、云功能和Firestore，您将回答是。在我们开始用真实的Firebase调用填充虚拟身份验证函数之前，让我们添加另一个插件，它显示一个浮动加载指示器，我们可以在调用身份验证方法和其他长延迟操作时显示该指示器。</p><p id="db08" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe kv kw kx ky b">tns plugin install @nstudio/nativescript-loading-indicator</code></p><p id="422e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">显示指示器时需要一个默认选项对象，我们将在导入后将其添加到<code class="fe kv kw kx ky b">app/app.js</code>中，并通过整个应用程序的全局对象进行访问。</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="45a1" class="ld le in ky b gy lf lg l lh li">global.loaderOptions = {<br/>    android: {<br/>        margin: 100,<br/>        dimBackground: true,<br/>        color: "#4B9ED6", <br/>        hideBezel: true, <br/>        mode: 3 <br/>    },<br/>    ios: {<br/>        dimBackground: true,<br/>        color: "#FFFFFF", <br/>        hideBezel: true, <br/>        mode: 3 <br/>    }<br/>};</span></pre><p id="5e31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们更新<code class="fe kv kw kx ky b">app/components/Login.vue</code>中的<code class="fe kv kw kx ky b">login</code>、<code class="fe kv kw kx ky b">register</code>和<code class="fe kv kw kx ky b">forgotPassword</code>方法，以便在等待Firebase操作完成时使用加载程序:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="78c4" class="ld le in ky b gy lf lg l lh li">login() {<br/>            let that = this<br/>            loader.show(global.loaderOptions);<br/>            this.userService<br/>                .login(this.user)<br/>                .then(() =&gt; {<br/>                    loader.hide()<br/>                    this.$navigateTo(HomePage, { clearHistory: true });<br/>                })<br/>                .catch((err) =&gt; {<br/>                    loader.hide()<br/>                    console.log(err)<br/>                    this.alert("Unfortunately we could not find your account.");<br/>                });<br/>        },<br/>        register() {<br/>            if (this.user.password != this.user.confirmPassword) {<br/>                this.alert("Your passwords do not match.");<br/>                return;<br/>            }<br/>            if (this.user.password.length &lt; 6) {<br/>                this.alert("Your password must be at least 6 characters.");<br/>                return;<br/>            }<br/>            loader.show(global.loaderOptions);<br/>            this.userService<br/>                .register(this.user)<br/>                .then(() =&gt; {<br/>                    this.isLoggingIn = true;<br/>                    loader.hide()<br/>                })<br/>                .catch((err) =&gt; {<br/>                    loader.hide()<br/>                    console.log(err)<br/>                    this.alert("Unfortunately we were unable to create your account.");<br/>                });<br/>        },<br/>        forgotPassword() {<br/>            let that = this<br/>            prompt({<br/>                title: "Forgot Password",<br/>                message: "Enter the email address you used to register for APP NAME to reset your password.",<br/>                inputType: "email",<br/>                defaultText: "",<br/>                okButtonText: "Ok",<br/>                cancelButtonText: "Cancel"<br/>            }).then(data =&gt; {<br/>                if (data.result) {<br/>                    loader.show(global.loaderOptions);<br/>                    that.userService<br/>                        .resetPassword(data.text.trim())<br/>                        .then(() =&gt; {<br/>                            loader.hide()<br/>                            that.alert(<br/>                                "Your password was successfully reset. Please check your email for instructions on choosing a new password."<br/>                            );<br/>                        })<br/>                        .catch(() =&gt; {<br/>                            loader.hide()<br/>                            that.alert(<br/>                                "Unfortunately, an error occurred resetting your password."<br/>                            );<br/>                        });<br/>                }<br/>            });<br/>        },</span></pre><p id="b9d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为Firebase要求密码长度至少为6个字符，所以我们在register函数中添加了一个检查。现在让我们填充<code class="fe kv kw kx ky b">userService</code>中的虚拟函数，从寄存器函数开始:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="5b06" class="ld le in ky b gy lf lg l lh li">async register(user) {<br/>                    return await firebase.createUser({<br/>                        email: user.email,<br/>                        password: user.password,<br/>                    }).then(<br/>                        function(response) {<br/>                            firebase.sendEmailVerification().then(function() {<br/>                                    alert("A verification email has been sent, click on the link to activate your account")<br/>                                },<br/>                                function(error) {<br/>                                    console.error("Error sending email verification: ", error);<br/>                                }<br/>                            )<br/>                        })<br/>                },</span></pre><p id="b45f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您会注意到，我们首先调用Firebase，使用提供的电子邮件和密码注册一个新帐户。如果成功，我们将让Firebase发送一封带有验证链接的电子邮件。由于我们正在创建一个购物应用程序，我们将限制用户登录，直到他们验证他们有权访问该电子邮件帐户。Firebase没有禁止未验证电子邮件地址的用户登录的选项，所以我们必须在登录方法中执行我们自己的检查。</p><p id="6c1d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用相应的Firebase登录函数填写<code class="fe kv kw kx ky b">userService</code>登录函数:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="e9a6" class="ld le in ky b gy lf lg l lh li">async login(user) {<br/>                    return await firebase.login({<br/>                        type: firebase.LoginType.PASSWORD,<br/>                        passwordOptions: {<br/>                            email: user.email,<br/>                            password: user.password,<br/>                        }<br/>                    })<br/>                },</span></pre><p id="f51a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们将更改主要的<code class="fe kv kw kx ky b">login</code>方法，在允许登录之前检查用户是否已经验证了他们的电子邮件地址:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="ee15" class="ld le in ky b gy lf lg l lh li">login() {<br/>            let that = this<br/>            loader.show(global.loaderOptions);<br/>            this.userService<br/>                .login(this.user)<br/>                .then((currentUser) =&gt; {<br/>                    loader.hide()<br/>                    if (!currentUser.emailVerified) {<br/>                        this.alert("Please click on the link in the verification email sent during registration. Check your Spam folder for a new link we've just emailed.");<br/>                        firebase.sendEmailVerification().then(function() { console.log("email sent") },<br/>                            function(error) {<br/>                                console.error("Error sending email verification: ", error);<br/>                            }<br/>                        )<br/>                        return false;<br/>                    }<br/>                    this.$navigateTo(HomePage);<br/>                })<br/>                .catch((err) =&gt; {<br/>                    loader.hide()<br/>                    console.log(err)<br/>                    this.alert("Unfortunately we could not find your account.");<br/>                });<br/>        },</span></pre><p id="e811" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果用户试图在未经验证的情况下登录，我们将显示一个警告，要求他们通过电子邮件链接进行验证。我们可以显示一个新的链接，使用<code class="fe kv kw kx ky b">currentUser.emailVerified</code>作为标志请求另一封验证邮件，但对于这篇文章，我们只会在他们每次尝试登录时发送一封新的验证邮件，以防他们没有收到邮件。</p><p id="728e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在填写<code class="fe kv kw kx ky b">userService</code> resetPassword函数，它将让Firebase发送一封电子邮件，其中包含一个更改密码的链接:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="bd1a" class="ld le in ky b gy lf lg l lh li">async resetPassword(email) {<br/>	return await firebase.sendPasswordResetEmail(email)<br/>}</span></pre><p id="55d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你现在在模拟器上运行这个应用程序，你应该能够使用Firebase身份验证来注册、登录和重置你的密码。登录后，您将只看到基本的模板应用程序页面，因此让我们将其转到主商店目录页面。</p><h1 id="ea17" class="ll le in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">创建商店目录</h1><p id="c155" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">让我们创建一个列出一系列待售商品的页面。为了跳过一些样式，我们将利用<a class="ae ku" href="https://github.com/nstudio/nativescript-cardview" rel="noopener ugc nofollow" target="_blank"> NativeScript Cardview插件</a>来显示材料设计CardViews中的产品，卡片以2列格式显示。使用以下方式安装插件:</p><p id="7a84" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe kv kw kx ky b">tns plugin add @nstudio/nativescript-cardview</code></p><p id="cd3e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将它作为组件导入到<code class="fe kv kw kx ky b">/app/app.js</code>中:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="e8b0" class="ld le in ky b gy lf lg l lh li">Vue.registerElement(<br/>    "CardView",<br/>    () =&gt; require("@nstudio/nativescript-cardview").CardView<br/>);</span></pre><p id="06a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将<code class="fe kv kw kx ky b">app/components/Home.vue</code>的内容替换为:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="c48b" class="ld le in ky b gy lf lg l lh li">&lt;template&gt;<br/>    &lt;Page&gt;<br/>        &lt;ActionBar&gt;<br/>            &lt;Label text="Shop"&gt;&lt;/Label&gt;<br/>        &lt;/ActionBar&gt;<br/>        &lt;ScrollView&gt;<br/>            &lt;StackLayout&gt;<br/>                &lt;GridLayout rows="*" columns="*, *" v-if="rowCount&gt;0" v-for="i in rowCount" :key="i"&gt;<br/>                    &lt;CardView class="card" margin="10" col="0" elevation="20" v-if="Items[(i - 1) * itemsPerRow] &amp;&amp; Items[(i - 1) * itemsPerRow ].name" @tap="seeDetails(Items[(i - 1) * itemsPerRow])"&gt;<br/>                        &lt;GridLayout class="card-layout" rows="120, auto,auto,auto" columns="*, *, *"&gt;<br/>                            &lt;Image v-if="Items[(i - 1) * itemsPerRow].image" :src="Items[(i - 1) * itemsPerRow].image" stretch="aspectFill" colSpan="3" row="0" /&gt;<br/>                            &lt;Label :text="Items[(i - 1) * itemsPerRow].name" class="" row="1" colSpan="3" /&gt;<br/>                            &lt;Label :text="Items[(i - 1) * itemsPerRow].price | dollars" class="" row="2" colSpan="3" /&gt;<br/>                            &lt;Button row="3" colSpan="3" text="Buy" @tap="addItem(Items[(i - 1) * itemsPerRow])" class="btn m-t-20 add-button" /&gt;<br/>                        &lt;/GridLayout&gt;<br/>                    &lt;/CardView&gt;<br/>                    &lt;CardView class="card" margin="10" col="1" elevation="20" v-if="Items[(i - 1) * itemsPerRow +1] &amp;&amp; Items[(i - 1) * itemsPerRow +1].name" @tap="seeDetails(Items[(i - 1) * itemsPerRow +1])"&gt;<br/>                        &lt;GridLayout class="card-layout" rows="120, auto,auto,auto" columns="*, *, *"&gt;<br/>                            &lt;Image v-if="Items[(i - 1) * itemsPerRow+1].image" :src="Items[(i - 1) * itemsPerRow + 1].image" stretch="aspectFill" colSpan="3" row="0" /&gt;<br/>                            &lt;Label :text="Items[(i - 1) * itemsPerRow + 1].name" class="" row="1" colSpan="3" /&gt;<br/>                            &lt;Label :text="Items[(i - 1) * itemsPerRow +1].price | dollars" class="" row="2" colSpan="3" /&gt;<br/>                            &lt;Button row="3" colSpan="3" text="Buy" @tap="addItem(Items[(i - 1) * itemsPerRow +1])" class="btn m-t-20 add-button" /&gt;<br/>                        &lt;/GridLayout&gt;<br/>                    &lt;/CardView&gt;<br/>                &lt;/GridLayout&gt;<br/>            &lt;/StackLayout&gt;<br/>        &lt;/ScrollView&gt;<br/>    &lt;/Page&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>export default {<br/>    data() {<br/>        return {<br/>            Items: [<br/>                { invId: 1, name: "An Item", image: "https://picsum.photos/300/200", price: 999, description: "This round bottle is made of opaque bright rose glass.  It has a mid-length neck, stands about seven inches tall, and the ink on its label has been washed off." },<br/>                { invId: 2, name: "Thing", image: "https://picsum.photos/300/200", price: 1499, description: "This round bottle is made of opaque chartreuse glass.  It has a mid-length neck, stands about six inches tall, and the ink on its label has been washed off." },<br/>                { invId: 3, name: "Doo-dad", image: "https://picsum.photos/300/200", price: 499, description: "This coffin-shaped bottle is made of opaque lilac glass.  It has a long neck, stands about five inches tall, and it has no label." },<br/>                { invId: 4, name: "Other thing", image: "https://picsum.photos/300/200", price: 299, description: "This cylindrical bottle is made of transparent bright turquoise glass.  It has a mid-length neck, stands about twelve inches tall, and it has a simple printed label." },<br/>                { invId: 5, name: "Last One", image: "https://picsum.photos/300/200", price: 899, description: "This teardrop-shaped bottle is made of translucent bright purple glass.  It has a mid-length neck, stands about eleven inches tall, and most of its label has been torn off." }<br/>            ],<br/>            itemsPerRow: 2<br/>        }<br/>    },<br/>    computed: {<br/>        rowCount: function() {<br/>            return Math.ceil(this.Items.length / this.itemsPerRow);<br/>        },<br/>    },<br/>    filters: {<br/>        dollars: num =&gt; `$${num / 100}`<br/>    },<br/>    methods: {<br/>        seeDetails(item) {<br/>            console.log("Showing detailed view for: ");<br/>            console.dir(item);<br/>        },<br/>        addItem(item) {<br/>            console.log("Adding item:");<br/>            console.dir(item);<br/>        }<br/>    },<br/>};<br/>&lt;/script&gt;<br/><br/>&lt;style scoped lang="scss"&gt;<br/>@import '~@nativescript/theme/scss/variables/blue'; <br/>.add-button {<br/>    height: 30;<br/>    background-color: rgb(51, 51, 206);<br/>    color: white;<br/>    border-radius: 5;<br/>    font-size: 20;<br/>    font-weight: 600;<br/>}<br/><br/>.card {<br/>    background-color: #fff;<br/>    color: #4d4d4d;<br/>    margin: 15;<br/>}<br/><br/>.card-layout {<br/>    padding: 20;<br/>}<br/>&lt;/style&gt;</span></pre><p id="026b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们使用来自<a class="ae ku" href="https://picsum.photos/" rel="noopener ugc nofollow" target="_blank"> Lorem Picsum网站</a>的图片URL定义了5个示例项目，该网站提供指定尺寸的随机图片。运行应用程序，登录，您应该会看到基本目录页面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/c02df044e5a08831a0afcccf6ef78fc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/0*5UMNojghJ9XxAPNl.png"/></div></figure><p id="98a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">目前，这个页面上的项目列表是硬编码的。相反，让我们使用Firebase Firestore来存储项目，并让应用程序从那里读取它们。</p><h1 id="b418" class="ll le in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">使用FireStore DB</h1><p id="4520" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">回到<a class="ae ku" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>，转到项目的数据库部分，为应用程序创建一个新的Firestore数据库。当询问时，选择生产安全规则(受限读/写),尽管我们在处理应用程序时会将它们更改为开发规则。创建数据库后，转到rules选项卡，将读/写访问权限更改为true:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/a1cecd209290cb6fe3c5589d7463d805.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/0*yvW_wbOt3KiNzuI_.png"/></div></figure><p id="081e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，返回主数据选项卡，开始我们商店产品的新收集。我们将这个集合命名为条目，并开始为每个条目添加与<code class="fe kv kw kx ky b">Home.vue</code>中的<code class="fe kv kw kx ky b">Items</code>数组具有相同字段和值的文档。第一项看起来像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/b39813a3d0c4fc805ad4d814568f98fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lbnFWQ_qVe_LwcL9.png"/></div></div></figure><p id="c020" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在您添加了示例项目后，让我们更新<code class="fe kv kw kx ky b">Home.vue</code>开始从Firebase Firestore阅读这些内容。我们将添加Firebase库的导入，注释掉Items数组条目，并添加<code class="fe kv kw kx ky b">created</code>函数在页面加载时从Firestore加载条目。我们还将准备两个新页面，用于显示商品详细信息和购买商品。更改顶部脚本部分，使其看起来像这样:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="0775" class="ld le in ky b gy lf lg l lh li">&lt;script&gt;<br/>import firebase from "nativescript-plugin-firebase";<br/>import ItemDetail from "./ItemDetail";<br/>import Payment from "./Payment";<br/>export default {<br/>    data() {<br/>        return {<br/>            Items: [<br/>                // { invId: 1, name: "An Item", image: "https://picsum.photos/300/200", price: 999, description: "This round bottle is made of opaque bright rose glass.  It has a mid-length neck, stands about seven inches tall, and the ink on its label has been washed off." },<br/>                // { invId: 2, name: "Thing", image: "https://picsum.photos/300/200", price: 1499, description: "This round bottle is made of opaque chartreuse glass.  It has a mid-length neck, stands about six inches tall, and the ink on its label has been washed off." },<br/>                // { invId: 3, name: "Doo-dad", image: "https://picsum.photos/300/200", price: 499, description: "This coffin-shaped bottle is made of opaque lilac glass.  It has a long neck, stands about five inches tall, and it has no label." },<br/>                // { invId: 4, name: "Other thing", image: "https://picsum.photos/300/200", price: 299, description: "This cylindrical bottle is made of transparent bright turquoise glass.  It has a mid-length neck, stands about twelve inches tall, and it has a simple printed label." },<br/>                // { invId: 5, name: "Last One", image: "https://picsum.photos/300/200", price: 899, description: "This teardrop-shaped bottle is made of translucent bright purple glass.  It has a mid-length neck, stands about eleven inches tall, and most of its label has been torn off." }<br/>            ],<br/>            itemsPerRow: 2<br/>        }<br/>    },<br/>    created() {<br/>        let that = this<br/>        firebase.firestore<br/>            .collection("Items")<br/>            .get()<br/>            .then(snapshot =&gt; {<br/>                let itemArr = [];<br/>                snapshot.forEach(document =&gt; {<br/>                    itemArr.push(document.data());<br/>                });<br/>                that.Items = itemArr<br/>            });<br/>    },<br/>    methods: {<br/>        seeDetails(item) {<br/>            this.$navigateTo(ItemDetail, { props: { item: item } });<br/>        },<br/>        addItem(item) {<br/>            this.$navigateTo(Payment, { props: { item: item } });<br/>   		}<br/>    }</span></pre><p id="4378" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们将商品详情页面添加为<code class="fe kv kw kx ky b">app/components/ItemDetail.vue</code>:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="700a" class="ld le in ky b gy lf lg l lh li">&lt;template&gt;<br/>    &lt;Page backgroundSpanUnderStatusBar="true"&gt;<br/>        &lt;ActionBar&gt;<br/>            &lt;Label text="Details"&gt;&lt;/Label&gt;<br/>        &lt;/ActionBar&gt;<br/>        &lt;ScrollView&gt;<br/>            &lt;StackLayout&gt;<br/>                &lt;CardView class="card" margin="10" col="0" elevation="20"&gt;<br/>                    &lt;GridLayout class="card-layout" rows="400, auto,auto,auto,auto,auto" columns="*, *, *"&gt;<br/>                        &lt;Image :src="item.image" stretch="aspectFill" colSpan="3" row="0" /&gt;<br/>                        &lt;Label :text="item.name" class="item-name" row="1" colSpan="3" /&gt;<br/>                        &lt;Label :text="item.price| dollars" class="item-price" row="2" colSpan="3" /&gt;<br/>                        &lt;Button row="3" colSpan="2" text="Buy" @tap="buyItem(item)" class="btn btn-primary m-t-20 add-button" /&gt;<br/>                        &lt;StackLayout class="line" row="4" colSpan="3" /&gt;<br/>                        &lt;TextView editable="false" row="5" colSpan="3" class="item-desc" textWrap="true" :text="item.description" /&gt;<br/>                    &lt;/GridLayout&gt;<br/>                &lt;/CardView&gt;<br/>            &lt;/StackLayout&gt;<br/>        &lt;/ScrollView&gt;<br/>    &lt;/Page&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import Payment from "./Payment";<br/>export default {<br/>    components: {},<br/>    filters: {<br/>        dollars: num =&gt; `$${num / 100}`<br/>    },<br/>    props: {<br/>        item: {<br/>            type: Object,<br/>            required: true<br/>        }<br/>    },<br/>    data() {<br/>        return {<br/>        }<br/>    },<br/>    computed: {<br/>    },<br/>    methods: {<br/>        buyItem(item) {<br/>            this.$navigateTo(Payment, { props: { item: item } });<br/>        }<br/>    }<br/>};<br/>&lt;/script&gt;<br/><br/>&lt;style scoped&gt;<br/>.card {<br/>    background-color: #fff;<br/>    color: #4d4d4d;<br/>    margin: 15;<br/>}<br/><br/>.card-layout {<br/>    padding: 20;<br/>}<br/><br/>.line {<br/>    background-color: #cecece;<br/>    height: 1;<br/>    margin: 0;<br/>    padding: 4;<br/>}<br/><br/>.item-name {<br/>    font-size: 16;<br/>    color: black;<br/>}<br/><br/>.item-price {<br/>    font-size: 14;<br/>    color: rgb(54, 54, 54);<br/>}<br/><br/>.item-desc {<br/>    font-size: 16;<br/>    color: black;<br/>    padding-bottom: 10;<br/>    background-color: transparent;<br/>    border-color: transparent;<br/>}<br/><br/>.add-button {<br/>    height: 30;<br/>    background-color: rgb(51, 51, 206);<br/>    color: white;<br/>    border-radius: 5;<br/>    font-size: 20;<br/>    font-weight: 600;<br/>}<br/>&lt;/style&gt;</span></pre><p id="d88c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您再次运行该应用程序，您应该仍然会看到从Firestore读取并由该应用程序显示的相同项目(由于每个平台加载/缓存url图像的方式，iOS上的图像不同，而Android上的图像相同)。如果你不创建一个空文件作为<code class="fe kv kw kx ky b">app/components/Payment.vue</code>，你会得到一些错误，这将在我们准备好我们的应用程序以使用Stripe进行支付后处理。</p><h1 id="1c6f" class="ll le in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">种类</h1><p id="3ee7" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">让我们使用<code class="fe kv kw kx ky b">tns plugin add nativescript-stripe</code>添加条纹插件。我们需要导入Stripe信用卡小部件，并通过更改<code class="fe kv kw kx ky b">app/app.js</code>来声明我们的Stripe公共令牌，如下所示:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="3282" class="ld le in ky b gy lf lg l lh li">import Vue from "nativescript-vue";<br/>import Login from "./components/Login";<br/>const application = require("tns-core-modules/application");<br/><br/>Vue.config.silent = false;<br/>global.loaderOptions = {<br/>    android: {<br/>        margin: 100,<br/>        dimBackground: true,<br/>        color: "#4B9ED6",<br/>        hideBezel: true,<br/>        mode: 3<br/>    },<br/>    ios: {<br/>        dimBackground: true,<br/>        color: "#FFFFFF",<br/>        hideBezel: true,<br/>        mode: 3<br/>    }<br/>};<br/>Vue.registerElement(<br/>    "CardView",<br/>    () =&gt; require("@nstudio/nativescript-cardview").CardView<br/>);<br/>Vue.registerElement(<br/>    "CreditCardView",<br/>    () =&gt; require("nativescript-stripe").CreditCardView<br/>);<br/>application.on(application.launchEvent, args =&gt; {<br/>    if (args.ios) {<br/>        STPPaymentConfiguration.sharedConfiguration().publishableKey = "YOUR_STRIPE_PUBLIC_TEST_KEY";<br/>    }<br/>});<br/>new Vue({<br/>    template: `<br/>        &lt;Frame&gt;<br/>            &lt;Login /&gt;<br/>        &lt;/Frame&gt;`,<br/>    components: {<br/>        Login<br/>    }<br/>}).$start();</span></pre><p id="af8f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">NativeScript Stripe插件将为我们提供一个可以在我们的应用程序中显示的信用卡小部件，以及允许我们使用公共Stripe密钥创建支付令牌的库，然后我们可以将它发送到Stripe服务器来处理支付。这种方法需要将Firebase上的Stripe服务器库作为云功能运行，以使用您的私有Stripe密钥处理支付。</p><p id="ea3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们将使用<a class="ae ku" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank">这里的指令</a>准备Firebase云函数。安装Firebase控制台CLI包，并创建一个新目录来存储函数代码</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="354b" class="ld le in ky b gy lf lg l lh li">npm install -g firebase-tools<br/>mkdir functions<br/>cd functions<br/>firebase login<br/>firebase init functions</span></pre><p id="afe2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Firebase login CLI命令应该会弹出一个窗口，请求允许使用Firebase CLI使用您的Google帐户。使用用于创建此应用程序的Firebase项目的Google帐户对其进行授权。一旦获得授权，您就可以运行CLI init命令，选择使用Javascript作为语言的现有项目，并允许它安装NPM的依赖项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/b6092d9c2b87d80ce26c6529030a1cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*sIU20hAb3-jvFuYL.png"/></div></figure><p id="e832" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们添加云功能来处理Firestore中付款集合的新条目。首先，用<code class="fe kv kw kx ky b">npm install stripe --save</code>添加Stripe库，从云函数调用Stripe API时需要用到它。编辑<code class="fe kv kw kx ky b">functions/functions/index.js</code>使其看起来像:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="c526" class="ld le in ky b gy lf lg l lh li">const functions = require("firebase-functions");<br/>const admin = require("firebase-admin");<br/>admin.initializeApp(functions.config().firebase);<br/>const stripe = require("stripe")(functions.config().stripe.token);<br/>exports.stripeCharge = functions.firestore<br/>    .document("/Payments/{paymentId}")<br/>    .onCreate(async (event, context) =&gt; {<br/>        const payment = event.data();<br/>        const paymentId = context.params.paymentId;<br/>        const amount = payment.amount; // amount must be in cents<br/>        const source = payment.token;<br/>        const currency = "usd";<br/>        const description = "Shopping App Purchase";<br/>        const newcharge = {<br/>            amount,<br/>            currency,<br/>            description,<br/>            source<br/>        };<br/>        return await stripe.charges<br/>            .create(newcharge, {<br/>                idempotencyKey: paymentId //used to prevent double charges for the same payment request<br/>            })<br/>            .then(async function(charge, err) {<br/>                if (err) console.error("error!:", err);<br/>                else {<br/>                    console.log("charge:", charge);<br/>                    return charge;<br/>                }<br/>            })<br/>            .then(newcharge =&gt; {<br/>                return admin<br/>                    .firestore()<br/>                    .collection("Payments")<br/>                    .doc(paymentId)<br/>                    .update({ charge: newcharge })<br/>                    .then(function(res) {<br/>                        console.log("Updated DB", res);<br/>                    })<br/>                    .catch(err =&gt; {<br/>                        console.error(err);<br/>                    });<br/>            });<br/>    });</span></pre><p id="cc98" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每当Firestore上的付款集合中添加新文档时，都会触发此功能。首先，它会向Stripe平台发送一个收费请求，如果成功，它会将收费收据存储回此次购买的付款文档中。我们使用async/await操作来确保条带调用和数据库更新都在云函数执行守护进程完成并失去访问授权之前运行和完成。</p><p id="4fc4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，使用CLI将您的私有测试密钥添加到Firebase Cloud Functions配置中:</p><p id="e343" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe kv kw kx ky b">firebase functions:config:set stripe.token=&lt;YOUR PRIVATE STRIPE TEST API KEY&gt;</code></p><p id="5fc4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">并通过以下方式部署该功能:</p><p id="99ba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe kv kw kx ky b">firebase deploy --only functions</code></p><p id="473a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您在部署期间收到关于条带包丢失的错误，请确保在<code class="fe kv kw kx ky b">package.json</code>依赖项中出现一个类似于<code class="fe kv kw kx ky b">"stripe": "^8.4.0"</code>的引用。</p><p id="d763" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们在我们的应用程序中创建支付页面，这样用户就可以输入他们的信用卡信息并进行购买。添加支付页面为<code class="fe kv kw kx ky b">app/components/Payment.vue</code>:</p><pre class="kj kk kl km gt kz ky la lb aw lc bi"><span id="9759" class="ld le in ky b gy lf lg l lh li">&lt;template&gt;<br/>    &lt;Page backgroundSpanUnderStatusBar="true"&gt;<br/>        &lt;ActionBar&gt;<br/>            &lt;Label text="Payment"&gt;&lt;/Label&gt;<br/>        &lt;/ActionBar&gt;<br/>        &lt;ScrollView&gt;<br/>            &lt;StackLayout&gt;<br/>                &lt;CreditCardView ref="ccview"&gt;&lt;/CreditCardView&gt;<br/>                &lt;GridLayout class="" rows="*,*,*,*,*,*" columns="100,*"&gt;<br/>                    &lt;Label ref="name" text="Name:" class="" row="0" col="0" /&gt;<br/>                    &lt;TextField class="input" row="0" col="1" hint="Joe Buyer" v-model="buyer.name" fontSize="18" /&gt;<br/>                    &lt;Label text="Email:" class="" row="1" col="0" /&gt;<br/>                    &lt;TextField ref="email" class="input" row="1" col="1" hint="joe@shopping.com" v-model="buyer.email" fontSize="18" /&gt;<br/>                    &lt;Label text="Address:" class="" row="2" col="0" /&gt;<br/>                    &lt;TextField ref="address" class="input" row="2" col="1" hint="2025 Thorntree Drive" v-model="buyer.address" fontSize="18" /&gt;<br/>                    &lt;Label text="City:" class="" row="3" col="0" /&gt;<br/>                    &lt;TextField ref="city" class="input" row="3" col="1" hint="Wallawalla" v-model="buyer.city" fontSize="18" /&gt;<br/>                    &lt;Label text="State:" class="" row="4" col="0" /&gt;<br/>                    &lt;TextField ref="state" class="input" row="4" col="1" hint="Washington" v-model="buyer.state" fontSize="18" /&gt;<br/>                    &lt;Label text="Postal Code:" textWrap="true" class="" row="5" col="0" /&gt;<br/>                    &lt;TextField ref="postalcode" class="input" row="5" col="1" hint="38291" v-model="buyer.postalcode" fontSize="18" /&gt;<br/>                &lt;/GridLayout&gt;<br/>                &lt;GridLayout rows="*" columns="*, *"&gt;<br/>                    &lt;Button row="0" col="0" text="Cancel" @tap="$navigateBack()" class="btn cancel-button m-t-20 " /&gt;<br/>                    &lt;Button row="0" col="1" text="Submit" @tap="submitPayment()" class="btn buy-button m-t-20" /&gt;<br/>                &lt;/GridLayout&gt;<br/>                &lt;CardView class="card" margin="10" elevation="20" @tap="seeDetails(item)"&gt;<br/>                    &lt;GridLayout class="card-layout" rows="50" columns="50, *,*,*"&gt;<br/>                        &lt;Image :src="item.image" stretch="aspectFill" col="0" row="0" /&gt;<br/>                        &lt;Label :text="item.name" class="" row="0" col="1" /&gt;<br/>                        &lt;Label :text="item.price | dollars" class="" row="0" col="2" /&gt;<br/>                    &lt;/GridLayout&gt;<br/>                &lt;/CardView&gt;<br/>                &lt;StackLayout class="line" /&gt;<br/>                &lt;CardView class="card" margin="10" elevation="20"&gt;<br/>                    &lt;GridLayout class="card-layout" rows="50" columns="50, *,*"&gt;<br/>                        &lt;Label text="Total:" class="" row="0" col="1" /&gt;<br/>                        &lt;Label :text="total | dollars" class="" row="0" col="2" /&gt;<br/>                    &lt;/GridLayout&gt;<br/>                &lt;/CardView&gt;<br/>            &lt;/StackLayout&gt;<br/>        &lt;/ScrollView&gt;<br/>    &lt;/Page&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import firebase from "nativescript-plugin-firebase";<br/>import ItemDetail from "./ItemDetail";<br/>import { Stripe, Card } from 'nativescript-stripe';<br/>import { isAndroid, isIOS } from "tns-core-modules/platform";<br/>export default {<br/>    components: {},<br/>    filters: {<br/>        dollars: num =&gt; `$${num / 100}`<br/>    },<br/>    data() {<br/>        return {<br/>            buyer: {},<br/>            stripeObj: null,<br/>        };<br/>    },<br/>    props: {<br/>        item: {<br/>            type: Object,<br/>            required: true<br/>        }<br/>    },<br/>    computed: {<br/>        total() {<br/>            return this.item.price<br/>        },<br/>    },<br/>    methods: {<br/>        seeDetails(item) {<br/>            this.$navigateTo(ItemDetail, { props: { item: item } });<br/>        },<br/>        submitPayment() {<br/>            let that = this<br/>            let cardobj<br/>            let ccview = this.$refs.ccview.nativeView<br/>            let myCallback = function getPaymentMethod(err, pm) {<br/>                if (pm) {<br/>                    return that.submitStripePayment(pm.id, that.buyer.email, that.total);<br/>                } else if (err) {<br/>                    console.log(err);<br/>                }<br/>            }<br/>            if (isAndroid) {<br/>                let newcard = ccview.android.getCard() //null if invalid<br/>                if (newcard &amp;&amp; newcard.validateCard()) {<br/>                    cardobj = new Card(newcard.getNumber().toString(), Number(newcard.getExpMonth()), Number(newcard.getExpYear()), newcard.getCVC().toString())<br/>                    this.stripeObj.createToken(cardobj, (error, token) =&gt; {<br/>                        if (!error) {<br/>                            that.submitStripePayment(token.id, that.buyer.email, that.total).then(() =&gt; {<br/>                                alert("Payment sent").then(() =&gt; {<br/>                                    that.$navigateBack()<br/>                                })<br/>                            }).catch(err =&gt; {<br/>                                alert("Sorry, we were unable to reach our payment server. Try again later")<br/>                            })<br/>                        } else {<br/>                            console.log("Error creating token!")<br/>                            console.log(error);<br/>                            alert("Sorry, we were unable to reach our payment server. Try again later")<br/>                        }<br/>                    })<br/>                } else {<br/>                    console.log("INVALID card")<br/>                    alert("Sorry, credit card is not valid")<br/>                }<br/>            } else if ((isIOS &amp;&amp; ccview.ios &amp;&amp; ccview.ios.isValid)) {<br/>                cardobj = new Card(ccview.ios.cardNumber.toString(), ccview.ios.expirationMonth, ccview.ios.expirationYear, ccview.ios.cvc.toString())<br/>                this.stripeObj.createToken(cardobj, (error, token) =&gt; {<br/>                    if (!error) {<br/>                        that.submitStripePayment(token.id, that.buyer.email, that.total).then(() =&gt; {<br/>                            alert("Payment sent").then(() =&gt; {<br/>                                that.$navigateBack()<br/>                            })<br/>                        }).catch(err =&gt; {<br/>                            alert("Sorry, we were unable to reach our payment server. Try again later")<br/>                        })<br/>                    } else {<br/>                        console.log("Error creating token!")<br/>                        console.log(error);<br/>                        alert("Sorry, we were unable to reach our payment server. Try again later")<br/>                    }<br/>                })<br/>            } else {<br/>                alert("Sorry, credit card is not valid")<br/>            }<br/>        },<br/>        submitStripePayment(token, email, amount) {<br/>            let charge = {};<br/>            return firebase.firestore.collection("Payments").add({<br/>                email: email,<br/>                amount: amount,<br/>                token: token,<br/>                charge: charge,<br/>                createDate: new Date()<br/>            }).then(documentRef =&gt; {<br/>                console.log(`Payment Token added with auto-generated ID: ${documentRef.id}`);<br/>                return Promise.resolve(documentRef);<br/>            }).catch(<br/>                err =&gt; {<br/>                    return Promise.reject(err);<br/>                });<br/>        },<br/>    },<br/>    created() {<br/>        this.stripeObj = new Stripe('<!-- -->YOUR_STRIPE_PUBLIC_TEST_KEY<!-- -->'); //public test key<br/>    }<br/>};<br/>&lt;/script&gt;<br/><br/>&lt;style scoped&gt;<br/>.card {<br/>    background-color: #fff;<br/>    color: #4d4d4d;<br/>    margin: 15;<br/>}<br/><br/>.card-layout {<br/>    padding: 20;<br/>}<br/><br/>.line {<br/>    background-color: #cecece;<br/>    height: 2;<br/>    margin: 0;<br/>    padding: 4;<br/>}<br/><br/>.input {<br/>    font-size: 18;<br/>    placeholder-color: #a8a8a8;<br/>}<br/><br/>.buy-button {<br/>    height: 30;<br/>    background-color: rgb(51, 51, 206);<br/>    color: white;<br/>    border-radius: 5;<br/>    font-size: 20;<br/>    font-weight: 600;<br/>}<br/><br/>.cancel-button {<br/>    height: 30;<br/>    background-color: rgb(179, 31, 31);<br/>    color: white;<br/>    border-radius: 5;<br/>    font-size: 20;<br/>    font-weight: 600;<br/>}<br/>&lt;/style&gt;</span></pre><p id="9fd8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您将会看到，我们在页面顶部使用插件的信用卡小部件，随后是为购买而收集的常规用户信息。这个小部件根据输入的信用卡信息提供视觉提示，并且还具有验证信用卡号码格式是否有效的功能。当用户希望购买一件商品时，该应用程序将验证信用卡信息，在Firestore上的支付集合中创建一个新条目，并包括从用户信用卡信息和您的公共条带密钥生成的支付令牌。确保您现在使用测试密钥，这样您就可以使用Stripe 的<a class="ae ku" href="https://stripe.com/docs/testing" rel="noopener ugc nofollow" target="_blank">测试卡之一测试支付流程。如果一切正常，当您点击某个商品的购买按钮时，您应该会看到以下屏幕:</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/2705d8725f0fc872ef83844c1e097d47.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/0*G6_XnQkwpgLbbsOX.png"/></div></figure><p id="2450" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输入其中一张测试信用卡的信息，并提交购买请求。现在，您可以检查Firebase控制台Firestore DB，查看应用程序创建的新购买条目，并在云功能完成处理后更新费用详细信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/aa50b326ac46684b1792395fc585ccd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p_CQ-vZxdo1WMv4S.png"/></div></div></figure><p id="c9a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果这不起作用，您可以检查云功能日志，以确保服务器处理没有错误地完成。如果没有问题，检查你的条纹测试仪表板，你应该看到付款。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/3f54d129fa287c5d2fe57ad72a6db72d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fLuO6hT9v8dytbvb.png"/></div></div></figure><h1 id="19d5" class="ll le in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">搞定了。</h1><p id="9195" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">这个帖子到此为止。如果你想下载最终的源文件，你可以在<a class="ae ku" href="https://github.com/drangelod/ns6shopping.git" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><p id="a226" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nb">原载于2020年1月24日https://blog.angelengineering.com</em><a class="ae ku" href="https://blog.angelengineering.com/shopping-app/" rel="noopener ugc nofollow" target="_blank"><em class="nb"/></a><em class="nb">。</em></p></div></div>    
</body>
</html>