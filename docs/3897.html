<html>
<head>
<title>Processing Images with Node.js and JIMP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和JIMP处理图像</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/processing-images-with-node-js-and-jimp-5e0519979484?source=collection_archive---------8-----------------------#2020-11-01">https://javascript.plainenglish.io/processing-images-with-node-js-and-jimp-5e0519979484?source=collection_archive---------8-----------------------#2020-11-01</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/e092697f59cb5a904cb5cd859f88d381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2EnEeJRBQnq4vyGr83uuvQ.jpeg"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk">Photo: Chris Webb</figcaption></figure><p id="825a" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">JavaScript图像处理程序，被它的朋友称为JIMP，是一个NPM软件包，提供了一系列编辑JPEG、PNG和其他一些格式的图像文件的方法。它最常见的用例可能是处理上传到基于节点的网站的图像，在本文中，我将演示如何使用它来调整图像大小、创建缩略图和添加水印。</p><p id="67f5" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在以后的文章中，我将进一步探索JIMP的能力。</p><h2 id="3b5f" class="lb lc ir bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">背景</h2><p id="8fbd" class="pw-post-body-paragraph kd ke ir kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ik bi translated">令人尴尬的是，我已经为我的照片在一个节点网站上工作了很长时间，每隔一段时间就添加一些小功能。它正接近这样一个阶段，我至少可以用基本的功能来启动它，本文描述了我编写的代码的一个压缩版本，用于在图像上传后对其进行处理。</p><p id="6682" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">这个项目的源代码在<a class="ae lz" href="https://github.com/CodeDrome/processing-uploaded-images-node-jimp" rel="noopener ugc nofollow" target="_blank"> Github库</a>中。这里我只使用JIMP的一小部分功能，但是您可能会发现官方文档很有用:</p><p id="0f2b" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><a class="ae lz" href="https://www.npmjs.com/package/jimp" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/jimp</a></p><p id="4aa6" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">正如您可能已经猜到的那样，可以使用以下命令安装JIMP:</p><p id="5ef5" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe ma mb mc md b">npm install --save jimp</code></p><h2 id="83b7" class="lb lc ir bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">“空谈是廉价的，给我看代码”</h2><p id="7320" class="pw-post-body-paragraph kd ke ir kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ik bi translated">(<em class="me">莱纳斯·托沃兹</em>)</p><p id="1022" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">好了，莱纳斯，是这样的。</p><figure class="mf mg mh mi gu js"><div class="bz fq l di"><div class="mj mk l"/></div></figure><p id="16bc" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">出于演示的目的，我写了这个从命令行运行，但是两个函数，<code class="fe ma mb mc md b">processImage</code>和<code class="fe ma mb mc md b">addWatermark</code>，可以在网站中使用。</p><p id="299d" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">哲学是建立一个单一的功能，执行所有这三项任务。因此，它只有一个参数，这个参数是一个对象，包含这样做所需的所有信息。该文件以对该函数的调用开始，尽管实际的实现会从外部调用该函数；在我的新网站中，这是在REST服务中完成的。</p><p id="6cd1" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">函数调用后是一个控制台日志。这将首先出现，尽管它是在调用<code class="fe ma mb mc md b">processImage</code>之后出现的，并且只是为了证明该过程是异步的。</p><p id="acd6" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在<code class="fe ma mb mc md b">processImage</code>函数中，我们首先需要<code class="fe ma mb mc md b">require</code> JIMP，然后使用Promise then/catch语法调用它的<code class="fe ma mb mc md b">read</code>方法。接下来发生的大部分事情都很简单明了，但是有几个特点值得指出:</p><ol class=""><li id="a4de" class="ml mm ir kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated">传递给<code class="fe ma mb mc md b">then</code>的λ是<code class="fe ma mb mc md b">async</code>(见4)</li><li id="1ae6" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">我们为缩略图创建一个图像的<code class="fe ma mb mc md b">clone</code></li><li id="00cf" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">JIMP提供了几个调整大小的函数，但<code class="fe ma mb mc md b">scaleToFit</code>可能是最有用的，因为我们只是给了它最大的尺寸，它为我们做了必要的计算，以保持高度:宽度的比例。</li><li id="4b05" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">我们<code class="fe ma mb mc md b">await</code> <code class="fe ma mb mc md b">addWatermark</code>否则代码将会在添加水印之前提前保存图像</li><li id="d7f9" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated"><code class="fe ma mb mc md b">quality</code>设定为95。它可以是0到100之间的任何值，但低值是不好的(真的不好),通常认为超过95的值会显著增加文件大小，但视觉质量不会有太大的改善。</li><li id="89e3" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">由于这段代码是为我自己的网站编写的，我认为我永远不会上传比我指定的标准尺寸小的图片。如果你想让公众在网站上自由活动，你可以保留较小的图片，或者强制设置最小尺寸。</li><li id="bb49" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">出于演示的目的，我将文件用作源和目标。您还可以使用缓冲区，实际上您几乎肯定会对上传的图像使用缓冲区，如果您希望将处理过的图像作为BLOB而不是文件系统存储在数据库中，也可以使用缓冲区。</li><li id="9344" class="ml mm ir kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">在生产系统中，您可能希望将一个“onerror”回调传递给<code class="fe ma mb mc md b">processImage</code>，而不仅仅是将错误输出到控制台。</li></ol><p id="33b3" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe ma mb mc md b">addWatermark</code>函数读取水印文件，然后计算水印的位置；我把它硬编码为右下角左上32像素。然后，合成函数将两幅图像进行组合，在这种情况下，合成函数有效地将水印图像粘贴到主图像上。我使用了可选的<code class="fe ma mb mc md b">opacitySource</code>参数来使水印半透明。</p><p id="6fd2" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">现在让我们用这个命令运行代码。(我已经对存储库提供的图像文件的名称进行了硬编码。你可能想用你自己的照片和水印来代替。)</p><p id="608e" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe ma mb mc md b">node processuploadedimage.js</code></p><p id="811b" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">这是输出。</p><figure class="mf mg mh mi gu js gi gj paragraph-image"><div class="gi gj mz"><img src="../Images/86adeb1e85a7fbd42797c37a427fe3fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*xkuBAD5R9pjjjP2vqgk1YA.png"/></div></figure><p id="0cac" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">输出非常枯燥，但至少它显示了正在发生的事情，特别是通过首先打印“starting…”来演示处理是异步的。</p><p id="c6a7" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">原始的1000 x 667图像位于页面顶部，这是调整后的600 x 400图像，带有水印。</p><figure class="mf mg mh mi gu js gi gj paragraph-image"><div class="gi gj na"><img src="../Images/01be0aba354f456636e93b2bd57c389c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*63CYQ4awoC-hC2_kpq3tzA.jpeg"/></div></figure><p id="fd15" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">最后是缩略图。</p><figure class="mf mg mh mi gu js gi gj paragraph-image"><div class="gi gj nb"><img src="../Images/d359a4d0c409198f94be73a32213ddb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*HaVTmZBhblV2GtsvxTlY4w.jpeg"/></div></figure><p id="a211" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">JIMP是相当强大的，我只是触及了它的皮毛。正如我上面提到的，我还准备了一些文章来演示进一步的功能。</p></div></div>    
</body>
</html>