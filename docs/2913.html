<html>
<head>
<title>Angular and Server Sent Events (SSE)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度和服务器发送事件(SSE)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/angular-and-server-sent-events-sse-54c29b4f174d?source=collection_archive---------2-----------------------#2020-08-05">https://javascript.plainenglish.io/angular-and-server-sent-events-sse-54c29b4f174d?source=collection_archive---------2-----------------------#2020-08-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ab65f615e0d5bef21ff09abb94cf6d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DJxqE308U1fswgNa.jpg"/></div></div></figure><p id="1e10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我将向你展示如何在<a class="ae kw" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular </a>应用中连接到<a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events" rel="noopener ugc nofollow" target="_blank">服务器发送的事件</a> (SSE)源。我们将创建一个小型原型，它将使用事件源API连接到服务器发送事件(SSE)端点，从而将事件打包到<a class="ae kw" href="https://angular.io/guide/observables" rel="noopener ugc nofollow" target="_blank">可观察的</a>中，并在<a class="ae kw" href="https://angular.io/api/core/NgZone" rel="noopener ugc nofollow" target="_blank">角度区域</a>内运行。</p><p id="f430" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">服务器发送事件</em></strong><em class="kx">(</em><strong class="ka ir"><em class="kx">SSE</em></strong><em class="kx">)是一种</em> <a class="ae kw" href="https://en.wikipedia.org/wiki/Server_push" rel="noopener ugc nofollow" target="_blank"> <em class="kx">服务器推送</em> </a> <em class="kx">技术，使客户端能够通过HTTP连接从服务器接收自动更新。服务器发送事件EventSource API由W3C</em><a class="ae kw" href="https://en.wikipedia.org/wiki/World_Wide_Web_Consortium" rel="noopener ugc nofollow" target="_blank"><em class="kx"/></a><em class="kx">标准化为</em><a class="ae kw" href="https://en.wikipedia.org/wiki/HTML5" rel="noopener ugc nofollow" target="_blank"><em class="kx">html 5</em></a><em class="kx">的一部分。——</em><a class="ae kw" href="https://en.wikipedia.org/wiki/Server-sent_events" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">维基百科</strong> </a></p><p id="0330" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于本教程，您将需要以下工具:</p><ul class=""><li id="681f" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated"><a class="ae kw" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a> —我用的是13.2.0版本</li><li id="3dc1" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">角度CLI  —我使用8.3.20版本</li></ul><h1 id="6c07" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建干净的角度项目</h1><p id="3c73" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">首先让我们创建一个干净的角度项目。从您的终端使用以下Angular CLI命令来执行此操作:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="d43d" class="my ln iq mu b gy mz na l nb nc">ng new angular-sse</span></pre><p id="e4da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此命令创建一个干净的项目并安装所有依赖项。幸运的是，这个项目不需要任何第三方dep——Angular提供了与服务器发送事件(SSE)交互所需的一切</p><h1 id="069e" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">正在连接到服务器发送的事件(SSE)端点</h1><p id="7de0" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">接下来，进入项目目录(在我的例子中是<em class="kx"> angular-sse </em>，并使用下面的终端命令创建一个新服务:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="508b" class="my ln iq mu b gy mz na l nb nc">ng generate service sse</span></pre><p id="87db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果，<code class="fe nd ne nf mu b">SseService</code>被创建并连接到角度项目中。现在，让我们写一些实际的代码。下面的代码片段是<code class="fe nd ne nf mu b">SseService</code>类的完整代码:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="dc93" class="my ln iq mu b gy mz na l nb nc">import { Injectable, NgZone } from "@angular/core";<br/>import { Observable } from "rxjs";</span><span id="8dbf" class="my ln iq mu b gy ng na l nb nc">@Injectable({<br/>  providedIn: "root"<br/>})<br/>export class SseService {<br/>  constructor(private _zone: NgZone) {}</span><span id="e479" class="my ln iq mu b gy ng na l nb nc">  getServerSentEvent(url: string): Observable&lt;any&gt; {<br/>    return Observable.create(observer =&gt; {<br/>      const eventSource = this.getEventSource(url);</span><span id="eab4" class="my ln iq mu b gy ng na l nb nc">      eventSource.onmessage = event =&gt; {<br/>        this._zone.run(() =&gt; {<br/>          observer.next(event);<br/>        });<br/>      };</span><span id="340d" class="my ln iq mu b gy ng na l nb nc">      eventSource.onerror = error =&gt; {<br/>        this._zone.run(() =&gt; {<br/>          observer.error(error);<br/>        });<br/>      };<br/>    });<br/>  }</span><span id="1e90" class="my ln iq mu b gy ng na l nb nc">  private getEventSource(url: string): EventSource {<br/>    return new EventSource(url);<br/>  }<br/>}</span></pre><p id="8ca6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成的服务创建了一个简洁易用的接口，用于与服务器发送的事件(SSE)进行交互。这里，我们统一了用于连接任何支持SSE的端点的逻辑。</p><p id="0863" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">原则上，该服务使用<a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource" rel="noopener ugc nofollow" target="_blank">事件源API </a>连接到SSE端点，允许将其打包到<code class="fe nd ne nf mu b">Observable</code>对象中。这个<a class="ae kw" href="https://angular.io/guide/observables" rel="noopener ugc nofollow" target="_blank">可观测的</a>然后在<a class="ae kw" href="https://angular.io/api/core/NgZone" rel="noopener ugc nofollow" target="_blank">角度区域</a>内运行。这允许Angular检测事件并正确执行底层逻辑。</p><h1 id="efe4" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">订阅可观察的</h1><p id="0ebf" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">接下来，让我们使用<code class="fe nd ne nf mu b">SseService</code> observable创建一个订阅SSE端点的组件。与创建服务类似，为此使用Angular CLI:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="f4a6" class="my ln iq mu b gy mz na l nb nc">ng new component home</span></pre><p id="4ed3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我将使用这个新创建的<code class="fe nd ne nf mu b">HomeComponent</code>来测试服务并连接到测试SSE端点。打开<code class="fe nd ne nf mu b">home.component.ts</code>文件并插入以下内容:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="c7e7" class="my ln iq mu b gy mz na l nb nc">import { Component, OnInit } from "@angular/core";<br/>import { SseService } from "src/app/services/sse/sse.service";</span><span id="29ab" class="my ln iq mu b gy ng na l nb nc">@Component({<br/>  selector: "app-home",<br/>  templateUrl: "./home.component.html",<br/>  styleUrls: ["./home.component.scss"]<br/>})<br/>export class HomeComponent implements OnInit {<br/>  constructor(private sseService: SseService) {}</span><span id="1d61" class="my ln iq mu b gy ng na l nb nc">  ngOnInit() {<br/>    this.sseService<br/>      .getServerSentEvent("http://localhost:8082/raw")<br/>      .subscribe(data =&gt; console.log(data));<br/>  }<br/>}</span></pre><p id="0c3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的代码使用<code class="fe nd ne nf mu b">SseService</code>连接到SSE端点(在我的例子中是<em class="kx">http://localhost:8082/raw</em>)。之后，事件被记录到控制台中，以便进行调试。</p><h1 id="199b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">摘要</h1><p id="927d" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">总之，在Angular中使用服务器发送事件(SSE)非常简单，可以创建很酷的反应式应用程序。我希望这篇文章对你有用。如果有，不要犹豫，喜欢或分享这个帖子。此外，如果你愿意，你可以在我的社交媒体上关注我:)</p><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nh ni l"/></div></figure></div></div>    
</body>
</html>