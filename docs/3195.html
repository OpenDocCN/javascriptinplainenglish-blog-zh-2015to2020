<html>
<head>
<title>How to Forge a Powerful Custom Builder in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Angular中打造强大的定制构建器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-forge-a-powerful-custom-builder-in-angular-67370ad3bb17?source=collection_archive---------5-----------------------#2020-09-08">https://javascript.plainenglish.io/how-to-forge-a-powerful-custom-builder-in-angular-67370ad3bb17?source=collection_archive---------5-----------------------#2020-09-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="358c" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">虽然Nrwl、Nest.js和Angular提供的所有构建器都很棒，但我们大多数人都忽略了定制构建器的巨大威力。从捆绑到部署，一切皆有可能。</h2></div><p id="b8f3" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ky">本文假设你已经对</em><a class="ae kz" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"><em class="ky"/></a><em class="ky"/><a class="ae kz" href="https://nx.dev/angular" rel="noopener ugc nofollow" target="_blank"><em class="ky">Nx</em></a><em class="ky">有一些常识。</em></p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/c61f87ab9d1c2b0f5e9938fe73ec953f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tbti6NhM1XyJ_kfa"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Photo by <a class="ae kz" href="https://unsplash.com/@danedeaner?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Dane Deaner</a> on <a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl lq lr hr ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ig ih ii ij ik"><h2 id="f819" class="lx ly in bd lz ma mb dn mc md me dp mf kl mg mh mi kp mj mk ml kt mm mn mo mp bi translated">构建NPM发布构建器</h2><p id="6fdf" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">我们的目标是编写一个生成器，为我们发布我们的库。构建器应该只在版本号改变时发布。它将执行以下操作:</p><ul class=""><li id="cd24" class="mv mw in ke b kf kg ki kj kl mx kp my kt mz kx na nb nc nd bi translated">执行常规构建目标，它将定期构建<code class="fe ne nf ng nh b">my-lib</code>。</li><li id="1aab" class="mv mw in ke b kf ni ki nj kl nk kp nl kt nm kx na nb nc nd bi translated">从先前构建的<code class="fe ne nf ng nh b">package.json</code>中检索本地版本。</li><li id="e96b" class="mv mw in ke b kf ni ki nj kl nk kp nl kt nm kx na nb nc nd bi translated">检查版本号是否增加。我们可以调用npm CLI来检查软件包版本。</li><li id="5880" class="mv mw in ke b kf ni ki nj kl nk kp nl kt nm kx na nb nc nd bi translated">通过再次调用npm CLI发布程序包。</li></ul><h1 id="fdac" class="nn ly in bd lz no np nq mc nr ns nt mf jt nu ju mi jw nv jx ml jz nw ka mo nx bi translated">1.设置工作空间、插件和构建器</h1><p id="05c4" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">虽然在Angular存储库中这肯定不是那么直接，但是如果您使用Nx提供的工具，创建一个定制的构建器是非常容易的。首先，如果您还没有，使用Nx创建一个存储库:</p><pre class="lb lc ld le gt ny nh nz oa aw ob bi"><span id="7937" class="lx ly in nh b gy oc od l oe of">npx create-nx-workspace my-workspace</span></pre><p id="4436" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">选择任何适合你需要的选项。我们将使用<code class="fe ne nf ng nh b">OSS</code>选项——开源工作区的配置。</p><p id="d67e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，使用另一个原理图创建一个新插件。该插件将创建一个我们可以使用的示例生成器:</p><pre class="lb lc ld le gt ny nh nz oa aw ob bi"><span id="f997" class="lx ly in nh b gy oc od l oe of">cd my-workspace</span><span id="7750" class="lx ly in nh b gy og od l oe of">npm i <a class="ae kz" href="http://twitter.com/nrwl/nx-plugin" rel="noopener ugc nofollow" target="_blank">@nrwl/nx-plugin</a></span><span id="7816" class="lx ly in nh b gy og od l oe of">nx g <a class="ae kz" href="http://twitter.com/nrwl/nx-plugin" rel="noopener ugc nofollow" target="_blank">@nrwl/nx-plugin</a>:plugin my-plugin --importPath=my-plugin</span></pre><p id="d967" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第一个<code class="fe ne nf ng nh b">my-plugin</code>是您工作区中插件的名称。<code class="fe ne nf ng nh b">--importPath=my-plugin</code>表示你将以哪个名字发布你的插件。这可能是<code class="fe ne nf ng nh b">@user/plugin-name</code>或任何有效的包名。</p><p id="4158" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你打算向npm这样的公共注册中心发布，请确保该名称仍然可以自由使用。</p><h1 id="8cb9" class="nn ly in bd lz no np nq mc nr ns nt mf jt nu ju mi jw nv jx ml jz nw ka mo nx bi translated">2.配置生成器输入</h1><p id="a29e" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">让我们看一下刚刚生成的文件。<code class="fe ne nf ng nh b">packages</code>中的<code class="fe ne nf ng nh b">my-plugin</code>文件夹包含我们新生成的插件。我们主要在构建器上工作，因此您可以放心地忘记schematics文件夹。</p><p id="6a3b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ne nf ng nh b">build/schema.d.ts</code>文件包括一个定义我们的构建器输入的接口。在这种情况下，我们希望有两个输入:</p><ul class=""><li id="aa19" class="mv mw in ke b kf kg ki kj kl mx kp my kt mz kx na nb nc nd bi translated"><code class="fe ne nf ng nh b">buildTarget</code> —告诉我们在发布包之前需要执行的构建目标。将发布此生成目标的输出。</li><li id="cb95" class="mv mw in ke b kf ni ki nj kl nk kp nl kt nm kx na nb nc nd bi translated"><code class="fe ne nf ng nh b">failOnDuplicate</code> —指示如果版本已经存在，构建是否应该失败。</li></ul><p id="6e67" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ne nf ng nh b">schema.d.ts</code>文件现在看起来像这样:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="e535" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除了<code class="fe ne nf ng nh b">schema.d.ts</code>文件之外，还生成了一个<code class="fe ne nf ng nh b">schema.json</code>。这个被用作一个<a class="ae kz" href="https://json-schema.org/" rel="noopener ugc nofollow" target="_blank"> JSON模式</a>来验证输入。我们将添加一些与我们之前的信息相匹配的简单信息:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h1 id="7db4" class="nn ly in bd lz no np nq mc nr ns nt mf jt nu ju mi jw nv jx ml jz nw ka mo nx bi translated">3.实现构建器</h1><p id="78f7" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">现在我们可以开始实现构建器了。实际的实现发生在<code class="fe ne nf ng nh b">builder.ts</code>文件中。我们将使用来自节点和<code class="fe ne nf ng nh b">@angular/devkit</code>的一些依赖关系。有时IDE不记得它们，所以我在这里为您列出了它们:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h2 id="5bb4" class="lx ly in bd lz ma mb dn mc md me dp mf kl mg mh mi kp mj mk ml kt mm mn mo mp bi translated">执行输入构建目标</h2><p id="ef97" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">首先，构建器需要执行前面的构建目标。我们可以从提供所有输入属性的<code class="fe ne nf ng nh b">options</code>对象接收目标字符串。</p><p id="0307" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了接收实际的目标信息，我们可以执行<code class="fe ne nf ng nh b">targetFromTargetString</code>函数。之后，我们执行目标。我们可以简单地在上下文对象上调用<code class="fe ne nf ng nh b">scheduleTaget(target)</code>。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="01e5" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们与目标互动时，我们已经可以保存<code class="fe ne nf ng nh b">outputPath</code>。下一步，我们将从这里构建到<code class="fe ne nf ng nh b">package.json</code>的路径。</p><h2 id="2f64" class="lx ly in bd lz ma mb dn mc md me dp mf kl mg mh mi kp mj mk ml kt mm mn mo mp bi translated"><strong class="ak"> <em class="oj">检查版本是否已经存在</em> </strong></h2><p id="93e0" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">现在是时候创建一个助手函数来检索本地包信息了。一个<code class="fe ne nf ng nh b">package.json</code>文件的路径被解析成一个JSON，如下所示:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="d312" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们需要一个函数来检查版本是否已经存在于npm上。命令<code class="fe ne nf ng nh b">npm show my-package@my-version version</code>检索包的特定版本。现在将它与我们的输入变量进行比较:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Don’t forget to call <code class="fe ne nf ng nh b">.trim()</code> on the output of the child process!</figcaption></figure><p id="95dd" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有了这两个助手函数，我们现在可以将它们集成到我们的构建函数中。将名称和版本直接传递给我们的验证函数:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="eff1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果验证失败，我们会向控制台记录一条警告。构建器的结果取决于<code class="fe ne nf ng nh b">failOnDuplicate</code>输入。</p><h2 id="268b" class="lx ly in bd lz ma mb dn mc md me dp mf kl mg mh mi kp mj mk ml kt mm mn mo mp bi translated">发布包</h2><p id="9b91" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">发布这个包真的很简单。只需在输出目录中运行<code class="fe ne nf ng nh b">npm publish</code>。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="1b16" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，通过从build函数调用publish函数来完成您的定制构建器。记住将它包装在一个try-catch块中，以处理发布期间可能发生的错误。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h1 id="1952" class="nn ly in bd lz no np nq mc nr ns nt mf jt nu ju mi jw nv jx ml jz nw ka mo nx bi translated">4.在本地注册表中尝试您的软件包</h1><p id="b8f8" class="pw-post-body-paragraph kc kd in ke b kf mq jo kh ki mr jr kk kl ms kn ko kp mt kr ks kt mu kv kw kx ig bi translated">现在我们可以试用我们自己的构建器了。我们将尝试向我们构建的插件添加一个发布目标，这样我们就可以使用它本身来发布它。疯了！</p><p id="97fe" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，安装<a class="ae kz" href="https://github.com/verdaccio/verdaccio" rel="noopener ugc nofollow" target="_blank"> Verdaccio </a>来创建一个本地包注册表——只是为了试用。安装并在第二个终端窗口中启动它:</p><pre class="lb lc ld le gt ny nh nz oa aw ob bi"><span id="68a3" class="lx ly in nh b gy oc od l oe of">npm i -g verdaccio<br/>verdaccio</span></pre><p id="963f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在Verdaccio运行之后，配置您的本地工作区，将其用作主注册表:<code class="fe ne nf ng nh b">npm set registry http://localhost:4873</code></p><p id="eb49" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">构建并发布您的插件:</p><pre class="lb lc ld le gt ny nh nz oa aw ob bi"><span id="eb5f" class="lx ly in nh b gy oc od l oe of">nx run my-plugin:build<br/>npm publish ./dist/packages/my-plugin/</span></pre><p id="a52e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用我们的构建器之前的最后一步是将其添加到我们的<code class="fe ne nf ng nh b">workspace.json</code>中。在你的建造目标上方添加你自己的目标<code class="fe ne nf ng nh b">publish</code>。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="ff8f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在安装并执行它！</p><pre class="lb lc ld le gt ny nh nz oa aw ob bi"><span id="d581" class="lx ly in nh b gy oc od l oe of">npm i <a class="ae kz" href="http://twitter.com/my" rel="noopener ugc nofollow" target="_blank">@my</a>-workspace/my-plugin</span><span id="a834" class="lx ly in nh b gy og od l oe of">nx run my-plugin:publish</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ok"><img src="../Images/bdd41cb554645e072c9b4f7ea72c3496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8In3JceLZxCEu2yZ6SE5CA.png"/></div></div></figure><p id="5b33" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出显示这个包之前已经发布过了。太好了！我们现在知道我们的版本检查正在工作。把<code class="fe ne nf ng nh b">package.json</code>里面的版本撞一下再发布:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ol"><img src="../Images/2f3f5cdc0ca74da1b786f9761f4cdfaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ofXnGIhs538g_wstc53LOw.png"/></div></div></figure><blockquote class="om"><p id="6db2" class="on oo in bd op oq or os ot ou ov kx dk translated">恭喜你，你刚刚在Angular内部编写了一个完整的定制构建器。使用Nx，你还可以为Node、Express、Nest.js和许多其他框架构建构建器。</p><p id="1f14" class="on oo in bd op oq ow ox oy oz pa kx dk translated">现在出去做点什么吧！</p></blockquote></div><div class="ab cl lq lr hr ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ig ih ii ij ik"><p id="6042" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">感谢您花时间了解Angular &amp; Nx定制构建器。如果你有任何公开的问题，请随时在Twitter <a class="ae kz" href="https://twitter.com/niklaspor" rel="noopener ugc nofollow" target="_blank"> @niklaspor </a>上给我发消息或留下评论。</p><p id="e98f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">祝你愉快。<br/> -尼克拉斯</p><p id="187d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ky">差点忘了——代码可用</em> <a class="ae kz" href="https://github.com/nx-boost/nx-boost/tree/main/packages/workspace/src/builders/publish" rel="noopener ugc nofollow" target="_blank"> <em class="ky">此处</em> </a> <em class="ky">。</em></p></div></div>    
</body>
</html>