<html>
<head>
<title>Bundling monorepos the right way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以正确的方式捆绑monorepos</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/bundling-monorepos-the-right-way-34116aa50433?source=collection_archive---------1-----------------------#2020-03-29">https://javascript.plainenglish.io/bundling-monorepos-the-right-way-34116aa50433?source=collection_archive---------1-----------------------#2020-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8f17" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何使用RollupJS和Lerna API！</h2></div><h2 id="b9e6" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">Lerna是一个很好的工具，可以在一个存储库中保存多个包。</h2><p id="a09d" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">然而，它没有为自动化构建过程提供内置的解决方案。在这里，我描述了如何创建一个使用RollupJS+Lerna API的构建脚本来:</p><ul class=""><li id="7d2b" class="lu lv iq ld b le lw lh lx ko ly ks lz kw ma lt mb mc md me bi translated">按照依赖关系的顺序编译包<em class="mf"/></li><li id="5143" class="lu lv iq ld b le mg lh mh ko mi ks mj kw mk lt mb mc md me bi translated">仅重建已经更改的包</li><li id="f8fd" class="lu lv iq ld b le mg lh mh ko mi ks mj kw mk lt mb mc md me bi translated">将多个包捆绑成一个“超级包”供用户使用——这样他们就不必构建整个项目。</li></ul><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/1bb044ec5adfe981ef84ae16ded482c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HrMS5RBPInpDJGRl"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Photo by <a class="ae nb" href="https://unsplash.com/@ikukevk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kevin Ku</a> on <a class="ae nb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="f0f6" class="nc kg iq bd kh nd ne nf kk ng nh ni kn jw nj jx kr jz nk ka kv kc nl kd kz nm bi translated">设置</h1><p id="ae8b" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">您的<code class="fe nn no np nq b">rollup.config.js</code>应该在运行时生成一个对象，而不是导出一个硬编码的静态配置对象。该文件的框架如下所示:</p><pre class="mm mn mo mp gt nr nq ns nt aw nu bi"><span id="c129" class="kf kg iq nq b gy nv nw l nx ny">async function main() {<br/>  return {<br/>    /* ... */<br/>  };<br/>}</span><span id="3651" class="kf kg iq nq b gy nz nw l nx ny">export default main();// @returns Promise&lt;RollupConfig&gt;</span></pre><h2 id="ef8c" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">安装Lerna API</h2><p id="4655" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">要创建一个包列表并按照依赖关系对它们进行排序，我们可以使用Lerna的内部API:</p><pre class="mm mn mo mp gt nr nq ns nt aw nu bi"><span id="5de2" class="kf kg iq nq b gy nv nw l nx ny">npm install -D @lerna/project @lerna/filter-packages @lerna/batch-packages</span></pre><p id="58e1" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">然后，向您的构建脚本<code class="fe nn no np nq b">rollup.config.js</code>添加一个助手函数:</p><pre class="mm mn mo mp gt nr nq ns nt aw nu bi"><span id="b8a6" class="kf kg iq nq b gy nv nw l nx ny">import { getPackages } from '@lerna/project';<br/>import filterPackages from '@lerna/filter-packages';<br/>import batchPackages from '@lerna/batch-packages';</span><span id="ff8a" class="kf kg iq nq b gy nz nw l nx ny">/**<br/> * @param {string}[scope] - packages to only build (if you don't<br/> *    want to build everything)<br/> * @param {string}[ignore] - packages to not build<br/> *<br/> * @returns {string[]} - sorted list of Package objects that<br/> *    represent packages to be built.<br/> */<br/>async function getSortedPackages(scope, ignore) {    <br/>  const packages = await getPackages(__dirname);    <br/>  const filtered = filterPackages(packages,<br/>    scope,<br/>    ignore,<br/>    false,);     <br/>  <br/>  return batchPackages(filtered)<br/>    .reduce((arr, batch) =&gt; arr.concat(batch), []);<br/>}</span></pre><p id="8831" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">这个函数有两个(可选的)参数— <code class="fe nn no np nq b">scope</code>和<code class="fe nn no np nq b">ignore</code>。如果你想<strong class="ld ir">只</strong>构建一些包，你可以在这个字符串中传递它们的名字。如果你想<strong class="ld ir">而不是</strong>构建一些包，同样，你可以在这个字符串中传递它们的名字。</p><p id="4ac6" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">通过不在配置文件中硬编码包名并使用这个函数来生成它们，重构monorepo不需要更新<code class="fe nn no np nq b">rollup.config.js</code>！</p><h1 id="c083" class="nc kg iq bd kh nd ne nf kk ng nh ni kn jw nj jx kr jz nk ka kv kc nl kd kz nm bi translated">生成配置对象</h1><h2 id="641e" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">package.json中的主/模块/包字段</h2><p id="6115" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">这个例子期望您的每个包<code class="fe nn no np nq b">package.json</code>都有一个<code class="fe nn no np nq b">main</code>字段指向它们的CommonJS包。如果还没有，请务必添加它们。</p><p id="f2a9" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">此外，如果您正在构建ESM包，应该添加<code class="fe nn no np nq b">module</code>字段。<code class="fe nn no np nq b">bundle</code>字段可用于生成生命/UMD包。</p><h2 id="d4af" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">输入文件</h2><p id="c162" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">这个例子还假设您的输入文件在您所有的包中都是<code class="fe nn no np nq b">src/index.js</code>。如果这对于您的每个包都是不同的，那么您可能想要在每个包的<code class="fe nn no np nq b">package.json</code>文件中添加一个<code class="fe nn no np nq b">input</code>字段。</p><h2 id="b451" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">返回主页面()</h2><p id="0223" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated"><code class="fe nn no np nq b">main</code>函数应该为每个包<em class="mf">按顺序</em>创建一个包含配置对象的数组:</p><blockquote class="od oe of"><p id="08f8" class="lb lc mf ld b le lw jr lg lh lx ju lj og oa ll lm oh ob lo lp oi oc lr ls lt ij bi translated"><code class="fe nn no np nq b">npm install minimist</code> —我们使用minimist包来解析命令行参数(用于范围和忽略)。</p></blockquote><pre class="mm mn mo mp gt nr nq ns nt aw nu bi"><span id="96c4" class="kf kg iq nq b gy nv nw l nx ny">import path from 'path';<br/>import minimist from 'minimist';</span><span id="a008" class="kf kg iq nq b gy nz nw l nx ny">async function main() {<br/>  const config = [];</span><span id="21c6" class="kf kg iq nq b gy nz nw l nx ny">  // Support --scope and --ignore globs if passed in via commandline<br/>  const { scope, ignore } = minimist(process.argv.slice(2));</span><span id="9198" class="kf kg iq nq b gy nz nw l nx ny">  const packages = await getSortedPackages(scope, ignore);</span><span id="7b5d" class="kf kg iq nq b gy nz nw l nx ny">  packages.forEach(pkg =&gt; {<br/>    /* Absolute path to package directory */<br/>    const basePath = path.relative(__dirname, pkg.location);</span><span id="482a" class="kf kg iq nq b gy nz nw l nx ny">    /* Absolute path to input file */<br/>    const input = path.join(basePath, 'src/index.js');</span><span id="3146" class="kf kg iq nq b gy nz nw l nx ny">    /* "main" field from package.json file. */<br/>    const { main } = pkg.toJSON();</span><span id="3f18" class="kf kg iq nq b gy nz nw l nx ny">    /* Push build config for this package. */<br/>    config.push({<br/>      input,<br/>      output: [{<br/>        file: path.join(basePath, main),<br/>        format: 'cjs',<br/>        source map: true<br/>      }, /* Add any other configs (for esm or iife format?) */]<br/>  });</span><span id="9ca4" class="kf kg iq nq b gy nz nw l nx ny">  return config;<br/>}</span></pre><p id="af8f" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated"><code class="fe nn no np nq b">rollup -c</code>现在应该构建所有的包了。</p><p id="8329" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">另外，<code class="fe nn no np nq b">rollup -c --scope @ns/pkgname</code>应该构建一个包，<code class="fe nn no np nq b">rollup -c --ignore @ns/pkgname</code>应该</p><h1 id="300f" class="nc kg iq bd kh nd ne nf kk ng nh ni kn jw nj jx kr jz nk ka kv kc nl kd kz nm bi translated">超级捆绑包</h1><p id="9ecc" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">创建一个从monorepo中导出所有内容的“超级捆绑”包的最简单方法是创建另一个包来重新导出所有包。</p><blockquote class="od oe of"><p id="1ec9" class="lb lc mf ld b le lw jr lg lh lx ju lj og oa ll lm oh ob lo lp oi oc lr ls lt ij bi translated"><code class="fe nn no np nq b">lerna create bundles/superbundle</code> —这将在<code class="fe nn no np nq b">bundles</code>文件夹中创建一个Lerna包。</p><p id="ce0a" class="lb lc mf ld b le lw jr lg lh lx ju lj og oa ll lm oh ob lo lp oi oc lr ls lt ij bi translated">创建“超级捆绑包”之后，确保将monorepo中的所有其他包作为“超级捆绑包”的依赖项添加进来。你可以通过运行<code class="fe nn no np nq b">lerna add @pkg/name1 @pkg/name2 @pkg/name3</code>来实现。</p><p id="e4e7" class="lb lc mf ld b le lw jr lg lh lx ju lj og oa ll lm oh ob lo lp oi oc lr ls lt ij bi translated">将“主/模块/包”字段添加到<code class="fe nn no np nq b">package.json</code>以生成输出。</p></blockquote><p id="e106" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">超级包应该有一个类似如下的输入文件<code class="fe nn no np nq b">src/index.js</code>:</p><pre class="mm mn mo mp gt nr nq ns nt aw nu bi"><span id="44b5" class="kf kg iq nq b gy nv nw l nx ny">import * as name1 from '@pkg/name1';<br/>import * as name2 from '@pkg/name2';<br/>import * as name3 from '@pkg/name3';</span><span id="8050" class="kf kg iq nq b gy nz nw l nx ny">/* If you want to export in a namespace */<br/>export const NS = {<br/> ...name1,<br/> ...name2,<br/> ...name3<br/>};</span><span id="7e49" class="kf kg iq nq b gy nz nw l nx ny">/* If you want to expose everything directly */<br/>export * from '@pkg/name1';<br/>export * from '@pkg/name1';<br/>export * from '@pkg/name1';</span></pre><p id="3c9a" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">运行<code class="fe nn no np nq b">rollup -c</code>应该也会自动构建超级包！</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="3658" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">嘿，伙计们，我是Shu Kant Pal——pix ijs的核心维护者和Silcos内核的创建者。喜欢我的内容？，跟我来这里:</p><div class="oq or gp gr os ot"><a href="https://twitter.com/ShukantP" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ir gy z fp oy fr fs oz fu fw ip bi translated">舒坎特·库马尔·帕尔</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">Shukant Kumar Pal (@ShukantP)的最新推文。PixiJS项目成员，pixi-UI/PuxiJS的维护者。自我…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">twitter.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph mv ot"/></div></div></a></div><p id="b12d" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated">p . s——pixi js使用这里描述的构建系统！</p><h2 id="d3f4" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">进一步阅读</h2><div class="oq or gp gr os ot"><a href="https://bit.cloud/blog/painless-monorepo-dependency-management-with-bit-l4f9fzyw" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ir gy z fp oy fr fs oz fu fw ip bi translated">使用Bit进行无痛monorepo依赖管理</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">简化monorepo中的依赖关系管理，以避免虚拟依赖关系和版本问题。了解…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">比特云</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph mv ot"/></div></div></a></div><p id="262b" class="pw-post-body-paragraph lb lc iq ld b le lw jr lg lh lx ju lj ko oa ll lm ks ob lo lp kw oc lr ls lt ij bi translated"><em class="mf">更多内容请看</em><a class="ae nb" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"><em class="mf">plain English . io</em></strong></a><em class="mf">。报名参加我们的</em> <a class="ae nb" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ld ir"> <em class="mf">免费周报</em> </strong> </a> <em class="mf">。关注我们关于</em><a class="ae nb" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"><em class="mf">Twitter</em></strong></a><a class="ae nb" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"><em class="mf">LinkedIn</em></strong></a><strong class="ld ir"><em class="mf"/></strong><a class="ae nb" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"><em class="mf">YouTube</em></strong></a><strong class="ld ir"><em class="mf">，以及</em></strong><em class="mf"/><a class="ae nb" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir"><em class="mf">不和</em> </strong> </a>  <em class="mf">对成长黑客感兴趣？检查</em> <a class="ae nb" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="ld ir"> <em class="mf">电路</em> </strong> </a> <strong class="ld ir"> <em class="mf">。</em> </strong></p></div></div>    
</body>
</html>