<html>
<head>
<title>Creating a URL shortener with Node.js and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和MongoDB创建URL shortener</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-a-url-shortener-with-node-js-and-mongodb-db4bc6488445?source=collection_archive---------2-----------------------#2020-09-29">https://javascript.plainenglish.io/creating-a-url-shortener-with-node-js-and-mongodb-db4bc6488445?source=collection_archive---------2-----------------------#2020-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2b54" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">下面是如何使用Node，MongoDB和Express创建一个定制的URL shortener。</h2></div><h1 id="ef43" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">介绍</h1><p id="8804" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">URL shortener是一个简单的网络工具，它将一个很长的URL简化为更小的、可管理的链接，使在线流量管理更加容易。最常用的网址缩写是:</p><ul class=""><li id="8578" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">bitly.com</li><li id="1255" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">tinyurl.com</li></ul><p id="f64f" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在这个故事中，我们将在Node.js和Express的帮助下，使用MongoDB作为我们的数据库，创建我们自己的URL shortener。</p><p id="7a45" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">前往<a class="ae mm" href="https://shortify-link.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://shortify-link.herokuapp.com/</a>查看现场版本。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/b5be589cf313a7fa1f9d717258ae3d35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVAvdo3JHAfNoX2xmEAH_g.png"/></div></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="8146" class="kf kg iq bd kh ki ng kk kl km nh ko kp jw ni jx kr jz nj ka kt kc nk kd kv kw bi translated">要求</h1><ul class=""><li id="5cee" class="lt lu iq kz b la lb ld le lg nl lk nm lo nn ls ma mb mc md bi translated">诺杰斯和NPM</li><li id="b304" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">MongoDB</li><li id="0039" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">Postman或类似的API测试工具</li><li id="a9e3" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">代码编辑器，如Visual Studio代码或Atom</li></ul><h1 id="451f" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">NodeJS设置</h1><p id="5dcc" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">创建您的项目目录并初始化npm包。我们称之为简化。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="ef8b" class="nt kg iq np b gy nu nv l nw nx">$ npm init</span></pre><p id="a040" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">接下来，我们将安装这个项目所需的所有包。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="bd31" class="nt kg iq np b gy nu nv l nw nx">$ npm install express mongoose fs</span></pre><p id="2cb9" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">另外，如果您还没有安装nodemon，请在您的系统上安装它。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="4e5a" class="nt kg iq np b gy nu nv l nw nx">$ npm install -g nodemon</span></pre><p id="3df4" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">我们将使用Express.js和Mongoose连接到我们的MongoDB数据库。Fs将用于呈现我们的HTML页面。</p><p id="ae29" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">您的index.js文件应该如下所示。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="faaf" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在package.json文件中包含一个启动脚本。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="34c1" class="nt kg iq np b gy nu nv l nw nx">"scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",<br/>    "start": "nodemon index.js"<br/>},</span></pre><h1 id="8d7d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">前端设置</h1><p id="06f0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们将创建两个网页，一个用于缩短网址，另一个用于分析链接。</p><p id="c46e" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在项目目录中创建视图文件夹。在这里，我们将在我们的视图文件夹中创建我们的网页，home.html和count.html。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="3905" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">创建后端API</h1><p id="1ac6" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们已经创建了我们的前端，现在我们需要我们的后端来服务它和相关的API。</p><p id="3a43" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">让我们首先创建GET请求来服务我们的web页面。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="8cf9" class="nt kg iq np b gy nu nv l nw nx">// GET request to serve home.html<br/>app.get('/', (req, res) =&gt; {<br/>  res.writeHead(200, {<br/>    'Content-Type': 'text/html'<br/>  });<br/>  fs.readFile('./views/home.html', null, function (error, data) {<br/>    if (error) {<br/>      res.writeHead(404);<br/>      res.write('Route not found!');<br/>    } else {<br/>      res.write(data);<br/>    }<br/>    res.end();<br/>  });<br/>})</span><span id="39ae" class="nt kg iq np b gy oa nv l nw nx">// GET request to redirect the shortened URL to the original URL<br/>app.get('/:route', async (req, res) =&gt; {<br/>  const route = req.params.route;<br/>  const instance = await Url.findOne({id: route});<br/>  if(instance) {<br/>    instance.visitors = instance.visitors + 1;<br/>    await instance.save();<br/>    res.redirect(`//${instance.url}`)<br/>  } else {<br/>    res.send("404")<br/>  }<br/>})</span><span id="e66b" class="nt kg iq np b gy oa nv l nw nx">// GET request to serve count.html and show analytics<br/>app.get('/analytics/:route', async (req, res) =&gt; {<br/>  res.writeHead(200, {<br/>    'Content-Type': 'text/html'<br/>  });<br/>  fs.readFile('./views/count.html', null, function (error, data) {<br/>    if (error) {<br/>      res.writeHead(404);<br/>      res.write('Route not found!');<br/>    } else {<br/>      res.write(data);<br/>    }<br/>    res.end();<br/>  });<br/>})</span></pre><p id="912b" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">现在启动本地服务器并测试主屏幕。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="29b9" class="nt kg iq np b gy nu nv l nw nx">$ npm start</span></pre><p id="add0" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">我们的网址缩写仍然没有工作。为了使这个功能，我们需要连接到我们的后端。<br/>现在，我们将创建API来连接我们的数据库和应用程序。<br/>首先，我们将在models文件夹中创建我们的URL模式。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="138d" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在index.js文件中导入模型。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="2c38" class="nt kg iq np b gy nu nv l nw nx">require('./models/Url');<br/>const Url = mongoose.model('Url');</span></pre><p id="48b1" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">现在，我们将为创建API来为网页提供内容。</p><p id="9bbf" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">首先，我们将创建一个API来缩短URL。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="01a7" class="nt kg iq np b gy nu nv l nw nx">// POST request for shortening the URL<br/>app.post('/', async (req, res) =&gt; {<br/>  const url = req.body.url;<br/>  const instance = new Url({<br/>    url: url,<br/>    visitors: 0<br/>  });<br/>  short = JSON.stringify(instance._id)<br/>  const id = short.slice(short.length-7, short.length-1)<br/>  instance.id = id;<br/>  await instance.save()<br/>  res.send({<br/>    message: `${id} was created`,<br/>    url: `${id}`,<br/>  });<br/>})</span></pre><p id="d3b8" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">当我们单击shorten按钮并返回缩短的URL时，就会调用这个API。</p><p id="66d7" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">接下来，我们将创建分析API来服务大量的访问者。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="617a" class="nt kg iq np b gy nu nv l nw nx">// POST request to send the number of visitors to count.html<br/>app.post('/analytics', async (req, res) =&gt; {<br/>  const route = req.body.route;<br/>  const instance = await Url.findOne({id: route});<br/>  res.send({<br/>    visitors: instance.visitors,<br/>    message: "Number of visitors sent!"<br/>  })<br/>})</span></pre><p id="d03a" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">现在，您的index.js文件应该看起来像这样。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="d0a2" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">这样，我们的网址缩写就准备好了。我们现在要做的就是主持它。</p><h1 id="80c8" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">功能(可选)</h1><p id="7375" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果你想了解这个网址缩写的功能，那么你可以阅读这一部分，否则你可以直接跳到主机。</p><p id="1819" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">我们的URL缩短器将给定的URL映射到更小的API URLs。我们将把原始的URL存储在我们的MongoDB数据库中。</p><p id="2b38" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">我们在index.js中创建的GET请求“/:route”将我们重定向到原始URL。通过这种方式，我们将长URL映射到更小的URL。</p><p id="a1b1" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">GET请求“/analytics/:route”返回显示该URL“/:route”的访问者数量的页面。</p><h1 id="3392" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">在Heroku上举办</h1><p id="b3a6" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">为了这个项目，我们将在Heroku上托管我们的URL shortener。</p><p id="65e0" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">如果您还没有帐户，请在Heroku上创建一个帐户。</p><p id="2b3f" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在Heroku上创建一个项目。</p><p id="e33e" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在你的终端登录你的Heroku账户。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="d289" class="nt kg iq np b gy nu nv l nw nx">$ heroku login</span></pre><p id="944d" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">在项目目录中初始化git存储库。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="ef36" class="nt kg iq np b gy nu nv l nw nx">$ git init</span></pre><p id="3322" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">添加远程git仓库。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="b01d" class="nt kg iq np b gy nu nv l nw nx">$ heroku git:remote -a project-name</span></pre><p id="7f1d" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">创建一个Procfile并将其写入文件中。Heroku部署您的应用程序需要Procfile。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="9b15" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">添加并提交所有文件。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="750f" class="nt kg iq np b gy nu nv l nw nx">$ git add .<br/>$ git commit -m "heroku deploy"</span></pre><p id="afbb" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">将您的更改推送到Heroku远程git存储库。</p><pre class="mo mp mq mr gt no np nq nr aw ns bi"><span id="75fd" class="nt kg iq np b gy nu nv l nw nx">$ git push heroku master</span></pre><p id="6cea" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">等待构建完成，然后检查你的网址缩写！</p><h1 id="b2b3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">包扎</h1><p id="a333" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您的自定义网址缩写程序现已准备就绪。你可以通过打开并使用你的Heroku应用来测试它。这是一个非常短的项目，可以在许多地方进行改进。没有适当的URL验证来检查输入的URL是否有效。通过引入一个简单的正则表达式来验证URL，可以很容易地解决这个问题。可以对Web应用程序UI进行改进。</p><p id="1f6e" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">祝贺您，您已经成功创建了自己的网址缩写程序。✌</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="2b61" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated"><em class="ob">在</em><a class="ae mm" href="https://github.com/maw1a/Shortify/tree/master" rel="noopener ugc nofollow" target="_blank"><em class="ob">【https://github.com/maw1a/Shortify/tree/master】</em></a>签出该项目的github库</p><p id="6fa2" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated"><em class="ob">如果你想使用我的这个工具，请在</em><a class="ae mm" href="https://shortify-link.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"><em class="ob">https://shortify-link.herokuapp.com/</em></a>查看现场版</p><p id="855b" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated"><em class="ob">如果对故事有任何问题或建议。请留言，我会处理的。</em></p></div></div>    
</body>
</html>