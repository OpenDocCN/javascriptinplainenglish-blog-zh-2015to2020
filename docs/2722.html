<html>
<head>
<title>Serving files using AWS Lamda and API Gateway and Serverless — 2020</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lamda和API网关和无服务器提供文件服务— 2020年</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/serving-files-using-aws-lamda-and-api-gateway-using-serverless-2020-20359c071827?source=collection_archive---------4-----------------------#2020-07-18">https://javascript.plainenglish.io/serving-files-using-aws-lamda-and-api-gateway-using-serverless-2020-20359c071827?source=collection_archive---------4-----------------------#2020-07-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="7c58" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个例子说明了我们如何使用<a class="ae ki" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lamda </a>提供文件，以及如何使用<a class="ae ki" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>提供AWS API网关。<a class="ae ki" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank">亚马逊API网关</a>支持服务二进制文件。我们将编写一个服务于图像的无服务器API。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/a5420f50df9a55f38e4a3add2be7f994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i5-_bLARZX1k3HU-Lai9pw.png"/></div></div></figure><p id="aea2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">开始之前，您需要</p><ol class=""><li id="235d" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">无服务器的基本知识</li><li id="5f84" class="kv kw in jm b jn le jr lf jv lg jz lh kd li kh la lb lc ld bi translated">系统中安装的Node.js和npm</li><li id="b6cc" class="kv kw in jm b jn le jr lf jv lg jz lh kd li kh la lb lc ld bi translated">亚马逊网络服务(AWS)帐户</li></ol><p id="26eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你不熟悉无服务器的基础知识，你可以参考这个博客</p></div><div class="ab cl lj lk hr ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ig ih ii ij ik"><h1 id="a718" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">项目设置</h1><p id="f110" class="pw-post-body-paragraph jk jl in jm b jn mo jp jq jr mp jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">我们将创建一个项目文件夹并初始化一个npm项目。在项目文件夹中创建新的无服务器服务。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="999f" class="my lr in mu b gy mz na l nb nc">mkdir my-serverless-project<br/>cd my-serverless-project<br/>npm init -y<br/>serverless create --template aws-nodejs</span></pre><p id="2e2f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">无服务器框架为应用程序生成样板文件。其中，<code class="fe nd ne nf mu b">handler.js</code>和<code class="fe nd ne nf mu b">serverless.yml</code>是重要的。</p><p id="932e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们将安装<code class="fe nd ne nf mu b"><a class="ae ki" href="https://www.npmjs.com/package/serverless-offline" rel="noopener ugc nofollow" target="_blank">serverless-offline</a></code>,这是一个用于在本地主机上运行无服务器框架的插件。这将在我们的本地机器上模拟Lambda和API网关，以加速您的开发周期。否则，我们将不得不每次都将服务部署到AWS来测试变更。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="ff55" class="my lr in mu b gy mz na l nb nc">npm install -D serverless-offline</span></pre><p id="2dab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">修改<code class="fe nd ne nf mu b">serverless.yml</code>文件以包含插件。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="dd67" class="my lr in mu b gy mz na l nb nc">service:<br/>  name: serverless<em class="ng"><br/></em>plugins:<br/>  - serverless-offline<br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>  apiGateway:<br/>    minimumCompressionSize: 1024<br/>  environment:<br/>    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: /</span></pre><p id="5dcc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，在项目文件夹中运行以下命令来启动无服务器脱机服务器。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="290b" class="my lr in mu b gy mz na l nb nc">serverless offline start</span></pre><p id="97d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们做了一个基本的无服务器应用程序。转到<code class="fe nd ne nf mu b"><a class="ae ki" href="http://localhost:3000/dev" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev</a></code>查看开发服务器。</p><h1 id="c162" class="lq lr in bd ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj nl ml mm mn bi translated">在API网关中设置二进制文件服务</h1><p id="41f6" class="pw-post-body-paragraph jk jl in jm b jn mo jp jq jr mp jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">我们将使用一个名为<code class="fe nd ne nf mu b"><a class="ae ki" href="https://github.com/maciejtreder/serverless-apigw-binary" rel="noopener ugc nofollow" target="_blank">serverless-apigw-binary</a></code>的插件通过API网关提供文件服务。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="3b85" class="my lr in mu b gy mz na l nb nc">npm install -D serverless-apigw-binary</span></pre><p id="097e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将图像文件添加到项目文件夹中。这是为了便于演示。二进制文件可以是任何类型，也可以来自不同的来源。这里我们提供的是PNG图像。我们需要在<code class="fe nd ne nf mu b">serverless.yml</code>中显式添加一行，以便在部署时包含图像文件。默认情况下，无服务器将忽略应用程序中未引用的所有文件。修改<code class="fe nd ne nf mu b">serverless.yml</code>如下</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="57cc" class="my lr in mu b gy mz na l nb nc">service:<br/>name: serverless<br/>include:<br/>  - my-image.png<br/>plugins:<br/>  - serverless-offline<br/>  - serverless-apigw-binary<br/>custom:<br/>  apigwBinary:<br/>    types:<br/>      - '*/*'<br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>  apiGateway:<br/>    minimumCompressionSize: 1024<br/>  environment:<br/>    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: /</span></pre><p id="672b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将需要相应地修改<code class="fe nd ne nf mu b">handler.js</code>。API Gateway不支持直接发送二进制数据，而是以字符串形式发送。<code class="fe nd ne nf mu b">isBase64Encoded: true</code>将让API网关知道二进制数据是以base64编码的。</p><pre class="kk kl km kn gt mt mu mv mw aw mx bi"><span id="df3d" class="my lr in mu b gy mz na l nb nc">'use strict';</span><span id="e230" class="my lr in mu b gy nm na l nb nc">const fs = require('fs');<br/>module.exports.hello = async (event) =&gt; {<br/>const file = fs.readFileSync('my-image.png');<br/><em class="ng">return</em> {<br/>  statusCode: 200,<br/>  headers: {<br/>    'Content-Type': 'image/png',<br/>  },<br/>  body: file.toString('base64'),<br/>  isBase64Encoded: true,<br/>  };<br/>};</span></pre><p id="62df" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用<code class="fe nd ne nf mu b">serverless deploy</code>部署无服务器应用程序。瞧，我们已经成功地通过AWS Lambda和API Gateway提供了二进制文件。</p></div><div class="ab cl lj lk hr ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ig ih ii ij ik"><h1 id="a352" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">包扎</h1><p id="42c6" class="pw-post-body-paragraph jk jl in jm b jn mo jp jq jr mp jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">本文向您展示了创建一个提供二进制文件的无服务器应用程序的过程。当我们创建一个涉及提供二进制文件的应用程序时，这将是很有帮助的，比如一个截图应用程序，它可以对图像进行截图。你可以在这里看到完整的代码<a class="ae ki" href="https://github.com/00karthik/serving-images-through-serverless" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>