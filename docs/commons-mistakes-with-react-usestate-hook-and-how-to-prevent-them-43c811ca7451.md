# React useState é’©å­çš„å¸¸è§é”™è¯¯ä»¥åŠå¦‚ä½•é˜²æ­¢å®ƒä»¬ã€‚

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/commons-mistakes-with-react-usestate-hook-and-how-to-prevent-them-43c811ca7451?source=collection_archive---------2----------------------->

## æŠ€æœ¯æç¤º

## æˆ‘åœ¨å„ç§ react é¡¹ç›®ä¸­çœ‹åˆ°äº†ä¸€ç³»åˆ—æ£˜æ‰‹çš„é”™è¯¯ï¼Œè€Œå¼€å‘äººå‘˜æ²¡æœ‰æ„è¯†åˆ°è¿™äº›é”™è¯¯å¯èƒ½ä¼šç ´åä»–ä»¬çš„æ•´ä¸ªåº”ç”¨ç¨‹åºï¼

![](img/6f5f3034d31d59dc3e867bf80946f52c.png)

React `useState`æ˜¯ç°ä»£ React åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œç„¶è€Œï¼Œè®¸å¤šå¼€å‘äººå‘˜åœ¨ä½¿ç”¨å®ƒæ—¶å¹¶ä¸çœŸæ­£çŸ¥é“å®ƒåœ¨åšä»€ä¹ˆã€‚

è™½ç„¶å¾ˆå®¹æ˜“å°†å®ƒç”¨äºåŸå§‹ç±»å‹ï¼Œå¦‚*å­—ç¬¦ä¸²*ã€*å¸ƒå°”*æˆ–*æ•°å­—*ï¼Œä½†å½“ä½¿ç”¨å¼•ç”¨ç±»å‹ï¼Œå¦‚*å¯¹è±¡/åœ°å›¾*æˆ–*æ•°ç»„*æ—¶ï¼Œå®ƒå¯èƒ½ä¼šå˜å¾—æ›´æ–¹ä¾¿ã€‚

è¿™äº›é”™è¯¯ä¼šäº§ç”Ÿä¸€äº›å¸¸è§çš„é—®é¢˜ï¼Œæ¯”å¦‚:

> ä¸ºä»€ä¹ˆæ›´æ”¹ React çŠ¶æ€åï¼Œæˆ‘çš„ UI ä¸æ˜¾ç¤ºæœ€æ–°çŠ¶æ€ï¼Ÿ

æˆ–è€…å¦ä¸€ä¸ªç›¸è¿‘çš„:

> æˆ‘æ›´æ–°äº†æˆ‘çš„ååº”çŠ¶æ€ï¼Œä½†æˆ‘çœ‹ä¸åˆ°å˜åŒ–ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

**ä½ å¯èƒ½å¤„äºè¿™ç§çŠ¶æ€ï¼Œç”šè‡³è‡ªå·±éƒ½ä¸çŸ¥é“ï¼Œå› ä¸ºè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå‡é˜³æ€§çš„æƒ…å†µï¼Œä¸€åˆ‡ä¼¼ä¹éƒ½æ­£å¸¸ï¼Œä½†è¿™åªæ˜¯ä¸€ä¸ªæˆåŠŸçš„éšæœºæ¡ˆä¾‹ã€‚**

# åŸºäºä»¥å‰çš„çŠ¶æ€æ—¶ä¸ä½¿ç”¨ä»¥å‰çš„å€¼

è¿™é‡Œè¦é—®çš„çœŸæ­£é—®é¢˜æ˜¯:

> å¦‚ä½•ä»å‰ä¸€ä¸ªçŠ¶æ€è®¡ç®—å‡ºååº”çŠ¶æ€ï¼Ÿ

è¿™å¯èƒ½æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œç›´åˆ°ä»Šå¤©æˆ‘è¿˜èƒ½çœ‹åˆ°è¿™æ ·çš„ä»£ç :

```
const App = () => {
  const [counter, setCounter] = useState(0);

  return (
    <button onClick={() => setCounter(counter + 1)}>
      Increment me {counter}
    </button>
  );
};
```

å¥½å§ï¼Œå®ƒå¯èƒ½éšæœºå·¥ä½œï¼Œä½†è¿™æ˜¯åä»£ç ï¼å³ä½¿ä½ å¯èƒ½åœ¨ React å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°è¿‡å®ƒã€‚è¿™å¯ä»¥å·¥ä½œï¼Œæ˜¯çš„ï¼Œè¿™å¯èƒ½åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯è¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸º React å¯ä»¥å°†çŠ¶æ€æ›´æ–°æ’é˜Ÿå¹¶è®¡ç®—åˆ°ä¸€ä¸ªæ‰¹å¤„ç†ä¸­ï¼Œä»¥å‡å°‘ä¸ dom(æˆ– React Native ä¸­çš„ç­‰æ•ˆå¯¹è±¡)çš„äº¤äº’ã€‚å¯¹äºæ€€ç–‘è®ºè€…æ¥è¯´ï¼Œçœ‹çœ‹è¿™ä¸ª:

Conventional setState vs Functional setState

å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¸å…ˆå‰çš„å€¼æ²¡æœ‰å…³ç³»ï¼Œæ‚¨å¯èƒ½ä¼šå¾—åˆ°ä¸æ­£ç¡®çš„è®¡ç®—å€¼ã€‚

åªè¦ä½ ä¾èµ–äºå…ˆå‰çš„çŠ¶æ€ï¼Œ**ä½ å°±éœ€è¦ä½¿ç”¨ä¸€ä¸ªè¢«ç»™å®šå…ˆå‰çŠ¶æ€å¹¶è¿”å›æ–°çŠ¶æ€çš„å‡½æ•°ã€‚**React çš„æ–¹å¼æ˜¯ç®€å•åœ°é“¾æ¥è¿™äº›å‡½æ•°è°ƒç”¨ä»¥è·å¾—æœ€æ–°çš„çŠ¶æ€ã€‚

```
const App = () => {
  const [counter, setCounter] = useState(0);

  return (
    <button onClick={() => 
      setCounter(prevCounter => prevCounter + 1)}
    >
      Increment me {counter}
    </button>
  );
};
```

è™½ç„¶æˆ‘ä»¬å¯ä»¥åœ¨ Javascript ä¸­ä½¿ç”¨é—­åŒ…æ¥å¤„ç†ä½œç”¨åŸŸå¹¶ä¼ é€’å€¼ï¼Œä½†å¤§å¤šæ•°æ—¶å€™ï¼Œå¦‚æœå…è®¸çš„è¯ï¼Œæœ€å¥½è¿˜æ˜¯ç¼–å†™ä¾èµ–æ³¨å…¥ä»£ç ã€‚

ä½¿ç”¨é—­åŒ…æ˜¯å¼ºå¤§è€Œæœ‰ç”¨çš„ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨å·¥å‚å‡½æ•°æ¥éšè—å…¬å…± API ä¸­çš„ä¸€äº›å˜é‡ã€‚**ä½†è¿™ä¸æ˜¯é“¶å¼¹æ¨¡å¼ã€‚**

# æ›´æ–°çŠ¶æ€å¼•ç”¨ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ†é…å®ƒ

æœ€å¸¸è§çš„é”™è¯¯æ˜¯ç†è§£ useState çš„å·¥ä½œæ–¹å¼ï¼Œå°½ç®¡åœ¨æ–‡æ¡£çš„ä¸åŒåœ°æ–¹éƒ½æœ‰æè¿°ã€‚

useState çš„å·¥ä½œåŸç†æ˜¯åœ¨æ”¹å˜æ—¶å¯¹å€¼è¿›è¡Œæµ…å±‚æ¯”è¾ƒï¼Œè¿™æ„å‘³ç€å¦‚æœä½¿ç”¨å¯¹è±¡æˆ–æ•°ç»„ï¼Œå°±éœ€è¦æ”¹å˜å¼•ç”¨ã€‚

ä»¥ä¸‹ä»£ç å¯¼è‡´åº”ç”¨ç¨‹åº UI ä¸è¢«åˆ·æ–°:

```
const App = () => {
  const [state, setState] = useState({ a: null }); return (
    <button 
      onClick={() =>
        setState((previousState) => {
          previousState.a = "newValue";
          return previousState;
        })
      }
    >
      ChangeMe {state.a}
    </button>
  );
};
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œ`previousState`ä»ç„¶æ˜¯ç›¸åŒçš„å¼•ç”¨ï¼Œæˆ‘ä»¬åªæ˜¯ç¼–è¾‘äº†å®ƒçš„ä¸€ä¸ªåµŒå¥—å±æ€§ã€‚è¿™æ ·ï¼Œè¯¥ç®—æ³•å°±ä¸èƒ½æ£€æµ‹åˆ°å˜åŒ–ï¼Œå› ä¸ºå®ƒåªåœ¨ä½¿ç”¨å¯¹è±¡/æ•°ç»„æ—¶å¯»æ‰¾å¼•ç”¨ã€‚

ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å¼•ç”¨å¹¶ä½¿ç”¨ç°æœ‰çš„å€¼

```
const App = () => {
  const [state, setState] = useState({ a: null });return (
    <button 
      onClick={() =>
        setState((previousState) => {
          return Object.assign({}, previousState, {a: "newValue"})
          // Or return {...previousState, a: "newValue"}
        })
      }
    >
      ChangeMe {state.a}
    </button>
  );
};
```

ä¸æ˜¯è¯´æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„å‚è€ƒï¼Œä¸€åˆ‡éƒ½å¾—åˆ°æ›´æ–°ã€‚è¿™æ˜¯ React ä¸­ä½¿ç”¨ä¸å˜æ€§çš„ä¸€ç§éå¸¸å¸¸è§çš„æ¨¡å¼ã€‚çœ‹çœ‹è¿™ä¸ªå›¾ä¹¦é¦†ï¼Œå®ƒçœŸçš„å¾ˆé…·ã€‚

[](https://github.com/rtfeldman/seamless-immutable) [## rtfeldman/æ— ç¼-ä¸å¯å˜

### JavaScript çš„ä¸å¯å˜æ•°æ®ç»“æ„ï¼Œå‘åå…¼å®¹æ™®é€šçš„ JS æ•°ç»„å’Œå¯¹è±¡ã€‚â€¦

github.com](https://github.com/rtfeldman/seamless-immutable) 

æ‚¨ä¹Ÿå¯ä»¥å¯¹æ•°ç»„ä½¿ç”¨æµè¡Œçš„å‡½æ•°å¼ç¼–ç¨‹å‡½æ•°ï¼Œæ¯”å¦‚è¿”å›æ–°æ•°ç»„çš„`filter`æˆ–`map`ã€‚

# æƒ³è¦å­˜å‚¨ä¸€ä¸ªå‡½æ•°ä½œä¸ºçŠ¶æ€æ¥æ”¹å˜å®ƒ

å‡ºäºæŸç§åŸå› ï¼Œæˆ‘ä¹Ÿè¯•å›¾è¿™æ ·åšâ€¦â€¦é—®é¢˜æ˜¯:è¿™æ˜¯ä¸€ä¸ªè½¯ä»¶è®¾è®¡å’Œæ€è€ƒçš„é—®é¢˜ã€‚

è¿™æ ·åšä½ æ˜¯å‘½ä»¤å¼æ€è€ƒï¼Œè€Œ React æ˜¯å£°æ˜å¼æ€è€ƒã€‚é¦–å…ˆï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä½ å°†åœ¨æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ç¬¬ä¸€ä¸ªé”™è¯¯è§£å†³æ–¹æ¡ˆä¸­ç»“æŸï¼Œå…¶ä¸­ React æä¾›å‰ä¸€ä¸ªå€¼ã€‚

è¦è¦†ç›–è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦ç»™ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä»é‚£é‡Œå¼€å§‹ï¼Œå®ƒé—»èµ·æ¥çœŸçš„åƒç‹—å±ä»£ç ï¼Œä½†è®©æˆ‘ä»¬è¯•è¯•ã€‚

```
const App = () => {
  const [callback, setCallback] = useState(() => () => "Hello world"); return (
    <button
      onClick={() => {
        *// Execute the callback code* setCallback(() => () => "Hello WORLD"+ Math.random())
      }}
    >
      Click me {callback()}
    </button>
  );
};
```

å¥½å§ï¼Œè¿™æ˜¯å¯è¡Œçš„ï¼Œå°½ç®¡å®ƒå¯¹å¼€å‘è€…å¹¶ä¸å‹å¥½ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª`useState`æ¥ä»£æ›¿å®ƒï¼Œç„¶åæŒ‰éœ€è®¡ç®—å€¼ï¼Œä½†æ˜¯å‡è®¾æˆ‘ä»¬å‡ºäºæŸç§åŸå› æƒ³è¦ä¿ç•™ä¸€ä¸ªå‡½æ•°ã€‚

æ‚¨åº”è¯¥ä½¿ç”¨`useCallback/useMemo`å¹¶åŸºäºæŸç§çŠ¶æ€è¿›è¡Œå›è°ƒæ›´æ”¹ã€‚è¿™æ ·ä½ å°±å¯ä»¥è¯´ï¼Œæˆ‘å¸Œæœ›è¿™ä¸ªå‡½æ•°å– X çš„åå­—ï¼Œåªè¦ Y ä¸å˜ï¼Œå°±ç”¨è¿™äº›å€¼æ¥æ‰§è¡Œ

```
const App = () => {
  const [clickId, setClickId] = React.useState(0);
  const callback = useCallback(() => "Hello WORLD"+ Math.random(), [clickId]) return (
    <button
      onClick={() => {
        *// Make the callback stale* setClickId(prev => prev + 1)
      }}
    >
    Click me {callback()}
    </button>
  );
};
```

ä¸‹é¢çš„ä»£ç æ˜¯æˆ‘ä»¬ä¸Šé¢å†™çš„å†…å®¹çš„å¦ä¸€ç§å†™æ³•ã€‚æˆ‘ä»¬ä½¿ç”¨å£°æ˜å¼ç¼–ç¨‹ï¼Œåªä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥ä½¿å›è°ƒçš„ç¼“å­˜æ— æ•ˆã€‚

## [ğŸ‡«ğŸ‡·å¯¹æ³•å›½äººæ¥è¯´ğŸ¥–æˆ‘æè®®ç”¨âš¡ï¸ç¼–ç ç«èŠ±å’Œä¸€ä»½æ—¶äº‹é€šè®¯æ¥æ”¶å–æŠ€æœ¯è´¹ç”¨ï¼](https://codingspark.io/?referral=medium)