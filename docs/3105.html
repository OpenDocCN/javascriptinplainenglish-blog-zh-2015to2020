<html>
<head>
<title>Node.js Best Practices — Express App Reliability and Logging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践-快速应用可靠性和日志记录</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-best-practices-express-app-reliability-and-logging-34be102aab9b?source=collection_archive---------3-----------------------#2020-08-29">https://javascript.plainenglish.io/node-js-best-practices-express-app-reliability-and-logging-34be102aab9b?source=collection_archive---------3-----------------------#2020-08-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/833809af6055aa00098b7aacebcb3538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bP5aPX3uiEjLMDsF"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@rgrzybowski?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Radek Grzybowski</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0bb6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="ffe4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结构化表达应用</h1><p id="9ee7" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们的快递应用应该有以下文件夹结构:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3fa0" class="mn lc iq mj b gy mo mp l mq mr">src/<br/>  config/<br/>  controllers/<br/>  providers/<br/>  services/<br/>  models/<br/>  routes.js<br/>  db.js<br/>  app.js<br/>test/<br/>  unit/<br/>  integration/<br/>server.js<br/>(cluster.js)<br/>test.js</span></pre><p id="e76d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有<code class="fe ms mt mu mj b">src</code>文件夹，里面有在生产中运行的代码。</p><p id="f3cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">config</code>已配置。</p><p id="22c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">controllers</code>有控制者。</p><p id="4987" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">providers</code>具有控制器路由的逻辑。</p><p id="d408" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">services</code>有商业逻辑。</p><p id="1ebf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">models</code>有数据库模型。</p><p id="29f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">routes.js</code>装载所有路线。</p><p id="ef61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">db.js</code>具有数据库路由。</p><p id="e0f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">app.js</code>加载快速应用程序。</p><p id="5456" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">test</code>已通过检测。</p><p id="76d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">unit</code>已通过单元测试。</p><p id="98ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">integration</code>已通过整合测试。</p><p id="e112" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">server.js</code>在快递应用的入口点。</p><p id="8f71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">cluster.js</code>是创建集群的可选文件。</p><p id="28d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">test.js</code>是运行<code class="fe ms mt mu mj b">test</code>目录下所有测试的主测试文件。</p><h1 id="810a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">提高Express.js的性能和可靠性</h1><p id="e6d5" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有几种方法可以提高性能和可靠性。</p><h1 id="95d4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将NODE_ENV设置为生产</h1><p id="4a83" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该将<code class="fe ms mt mu mj b">NODE_ENV</code>环境变量设置为<code class="fe ms mt mu mj b">production</code>，这样我们就可以从生产配置中获益。</p><p id="2acd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是dev的3倍。</p><p id="4030" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是因为有压缩和缓存来让我们的应用程序更快。</p><p id="c90a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以运行以下任一程序:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0631" class="mn lc iq mj b gy mo mp l mq mr">export NODE_ENV=production</span></pre><p id="c85b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置环境变量</p><p id="1a23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a534" class="mn lc iq mj b gy mo mp l mq mr">NODE_ENV=production node server.js</span></pre><p id="6e78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置环境变量并同时运行应用程序。</p><h1 id="eb73" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">启用Gzip压缩</h1><p id="51e9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以对资产启用gzip压缩，以便对我们的资产进行压缩。</p><p id="247c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过运行以下程序来安装<code class="fe ms mt mu mj b">compression</code>中间件:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="de85" class="mn lc iq mj b gy mo mp l mq mr">npm i compression</span></pre><p id="6e95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过书写来使用它:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e924" class="mn lc iq mj b gy mo mp l mq mr">const compression = require('compression')<br/>const express = require('express')<br/>const app = express()<br/>app.use(compression())</span></pre><p id="1333" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这不是进行gzip压缩的最佳方式，因为它使用了Express应用程序上的资源。</p><p id="b8c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，我们可以在Nginx中启用gzip，将工作转移到反向代理上。</p><h1 id="0b5c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">始终使用异步函数</h1><p id="7835" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们有一些简单的操作以外的东西，我们可能应该使用异步代码。</p><p id="b5a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们应该在大部分时间里做出承诺，或者干脆异步/等待。</p><p id="c481" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="40d2" class="mn lc iq mj b gy mo mp l mq mr">(async () =&gt; {<br/>  const foo = () =&gt; {<br/>    //...<br/>    return val<br/>  }<br/>​<br/>  const val = await asyncFunction;<br/>})()</span></pre><p id="3866" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有一个<code class="fe ms mt mu mj b">asyncFunction</code>来回报承诺，所以我们用<code class="fe ms mt mu mj b">await</code>来得到结果。</p><p id="ab9b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不能在不同的线程上运行同步函数，因为Node是单线程的。</p><p id="13d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们只能使用异步代码来运行长期运行的操作。</p><p id="6860" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以生成子进程或创建应用程序的多个实例，以便在不同的进程上运行不同的任务。</p><h1 id="a705" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">正确记录</h1><p id="8c03" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该在一个中心位置收集我们的日志。</p><p id="bf58" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，我们可以在需要的时候找到它们。</p><p id="d1ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.npmjs.com/package/winston" rel="noopener ugc nofollow" target="_blank"> Winston </a>和<a class="ae kc" href="https://www.npmjs.com/package/morgan" rel="noopener ugc nofollow" target="_blank"> Morgan </a>以及有用的日志包，可以集成其他服务进行集中日志记录。</p><p id="8c72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以使用一些类似于<a class="ae kc" href="https://sematext.com/" rel="noopener ugc nofollow" target="_blank"> Sematext </a>的服务来记录日志。</p><p id="790f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="186f" class="mn lc iq mj b gy mo mp l mq mr">const { stLogger, stHttpLoggerMiddleware } = require('sematext-agent-express')<br/>​<br/>const express = require('express')<br/>const app = express()<br/>app.use(stHttpLoggerMiddleware)<br/>​<br/><br/>app.get('/api', (req, res, next) =&gt; {<br/>  stLogger.info('An info.')<br/>  stLogger.debug('A debug.')<br/>  stLogger.warn('A warning.')<br/>  stLogger.error('An error.')</span><span id="71b6" class="mn lc iq mj b gy mv mp l mq mr">  res.send('Hello World.')<br/>})</span></pre><p id="d0af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有一个<code class="fe ms mt mu mj b">sematext-agent-express</code>包，它有一个日志记录器来记录Sematext服务。</p><p id="92f6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们通过服务在一个漂亮的仪表板中获取日志。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/c0e8c645e23beffed76e766c6752890c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vu_I_NV8AHOtV71M"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@purzlbaum?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">🇨🇭 Claudio Schwarz | @purzlbaum</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="f255" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="fa82" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以更好地构建Express应用程序，并在生产模式下运行production Express应用程序。</p><p id="2abd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，使用集中的日志服务可以很容易地进行日志记录。</p><h2 id="9293" class="mn lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript</strong></h2><p id="c3ba" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">你知道我们有三份出版物和一个YouTube频道吗？在<a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">plain English . io</strong></a>找到所有内容的链接！</p></div></div>    
</body>
</html>