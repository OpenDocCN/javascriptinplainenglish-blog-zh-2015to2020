<html>
<head>
<title>Authenticate GraphQL Queries with JWT in a NodeJS environment using TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TypeScript在NodeJS环境中通过JWT验证GraphQL查询</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/authenticate-graphql-queries-with-jsonwebtokens-jwt-in-orm-nodejs-environment-using-typescript-eaab53eb6d24?source=collection_archive---------3-----------------------#2019-11-10">https://javascript.plainenglish.io/authenticate-graphql-queries-with-jsonwebtokens-jwt-in-orm-nodejs-environment-using-typescript-eaab53eb6d24?source=collection_archive---------3-----------------------#2019-11-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/4fc697a46b084c6c8dcdd1575f815894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jdVggtEA4FXlN3BhlsnM_Q.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Login Query</figcaption></figure><p id="35ee" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">大家好，今天我写一篇文章，用<strong class="kb io"> JWT </strong>令牌认证<strong class="kb io"> Graphql </strong>查询。为了实现这一点，首先我要设置服务器，用户可以在其中注册/登录。成功登录后，我们进行一个需要认证的查询。</p><h2 id="9bf0" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">所以我要用的技术栈是::<strong class="ak"> Nodejs，Expressjs，Typeorm，Typegraphql，graphql，jsonwebtoken，ApolloServerExpress </strong>等等。</h2><blockquote class="lq"><p id="8afb" class="lr ls in bd lt lu lv lw lx ly lz kw dk translated">Github链接:<a class="ae ma" href="https://github.com/vinodchauhan7/Authenticate-graphql-queries-with-jwt" rel="noopener ugc nofollow" target="_blank">用JWT认证Graphql查询</a></p></blockquote><p id="2c10" class="pw-post-body-paragraph jz ka in kb b kc mb ke kf kg mc ki kj kk md km kn ko me kq kr ks mf ku kv kw ig bi translated">我在这个例子中使用了VS代码编辑器。现在请首先在您的系统上安装<strong class="kb io">节点</strong>和<strong class="kb io"> npm </strong>。请按照以下步骤快速设置服务器:</p><ol class=""><li id="a0dd" class="mg mh in kb b kc kd kg kh kk mi ko mj ks mk kw ml mm mn mo bi translated">创建“服务器”文件夹</li><li id="bbbe" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">npm安装-g类型表单</li><li id="0ff0" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">类型初始化—名称服务器—数据库postgres</li><li id="9059" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">cd服务器</li><li id="12df" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">npx tsconfig.json并在选项中选择“node”。</li></ol><p id="f10e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在我将使用<strong class="kb io"> <em class="mu">纱</em> </strong>进一步开发这个项目。</p><p id="d2ff" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">安装纱线:<strong class="kb io"> npm安装纱线-g </strong></p><p id="aea5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，点击以下按钮更新我们的软件包:</p><ol class=""><li id="0513" class="mg mh in kb b kc kd kg kh kk mi ko mj ks mk kw ml mm mn mo bi translated">纱线安装</li><li id="439d" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">纱线升级-互动-最新。在这个阶段选择下面的包:<br/>"<a class="ae ma" href="http://twitter.com/types/node" rel="noopener ugc nofollow" target="_blank">@ types/node</a>@ 12 . 12 . 7 "，" ts-node@8.4.1 "，" typescript@3.7.2 "。</li><li id="2bf4" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated">使用postgres详细信息更新ormconfig.json文件。</li></ol><figure class="mw mx my mz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/bcefe13af4841c09ee2be3c4f7e23fad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9KwCUhRc-jo-uCZICuxpRA.png"/></div></div></figure><p id="4014" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">测试服务器点击:<strong class="kb io">纱线启动<br/>并在终端中查看以下数据。</strong></p><p id="f895" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">$ ts-node src/index.ts <br/>将新用户插入数据库… <br/>保存了id: 2的新用户<br/>从数据库加载用户… <br/>加载的用户:[用户{ id: 1，名字:' Timber '，姓氏:' Saw '，年龄:25 }]</p><p id="8609" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在继续下一步，setup express，graphql &amp; apollo-server-express。</p><ol class=""><li id="2ac9" class="mg mh in kb b kc kd kg kh kk mi ko mj ks mk kw ml mm mn mo bi translated"><strong class="kb io">纱加快递阿波罗-服务器-快递graphql类型-graphql bcryptjs </strong></li><li id="f32b" class="mg mh in kb b kc mp kg mq kk mr ko ms ks mt kw ml mm mn mo bi translated"><strong class="kb io">yarn add-D @ types/node @ types/graph QL @ types/express @ types/bcryptjs</strong></li></ol><p id="2907" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在更新index.ts</p><figure class="mw mx my mz gt jo"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Index.ts</figcaption></figure><figure class="mw mx my mz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/560e2d35600ade879855f954efcf95ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LT9AF1jSp1UMhBCSyRl1cQ.png"/></div></div></figure><p id="b699" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您的Graphql服务器已经就绪。直接点击(http://localhost:4000/graphql)</p><p id="9513" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在进一步更新以实现注册/登录逻辑</p><figure class="mw mx my mz gt jo"><div class="bz fp l di"><div class="na nb l"/></div></figure><figure class="mw mx my mz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/5134dec6db41f98fe0fef8e4ee1577b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7CM8TgsoQbInc-qaDlN5KA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Register and Login demo</figcaption></figure><p id="6d98" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在安装<strong class="kb io"> jsonwebToken : <br/> 1。</strong> <em class="mu">纱加jsonwebtoken </em> <br/> 2。<em class="mu">yarn add-D @ types/jsonwebtoken</em></p><blockquote class="lq"><p id="7f80" class="lr ls in bd lt lu lv lw lx ly lz kw dk translated">return { access token:sign({ userId:user . id }，“MySecretKey”，{ expi resin:“15m”})}；</p></blockquote><p id="6a9f" class="pw-post-body-paragraph jz ka in kb b kc mb ke kf kg mc ki kj kk md km kn ko me kq kr ks mf ku kv kw ig bi translated">通过上面的代码，我们为用户提供了一个唯一的令牌，当他/她每次登录时。</p></div><div class="ab cl nc nd hr ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ig ih ii ij ik"><p id="d162" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">到目前为止，一切都很顺利，但为了验证我们的查询，我们需要任何中间件来验证我们的请求，然后让我们使用该查询。</p><p id="8aa5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们正在进行一个“我”的查询，它需要jwt令牌来进行身份验证，并告诉哪个用户当前正在登录。</p><p id="8a2b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">@ Query(()= &gt; String)<br/>@ use middleware(isAuth)<br/>async Me(@ Ctx(){ payload }:my context){<br/>return ` your user id:$ { payload！。userId } `；<br/> }</p><p id="7b74" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">“使用中间件”是我们实现认证逻辑的关键装饰。</p><figure class="mw mx my mz gt jo"><div class="bz fp l di"><div class="na nb l"/></div></figure><figure class="mw mx my mz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/fd073d409b948e8541937e659835e50a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ARME4-xNN2ZYqTx6nd0Z_Q.png"/></div></div></figure><p id="6b9e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这个中间件中，我们从请求中获得“授权”头，你可以看到我们在上面的pic中作为httpheader发送。</p><p id="5484" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Github链接:<a class="ae ma" href="https://github.com/vinodchauhan7/Authenticate-graphql-queries-with-jwt" rel="noopener ugc nofollow" target="_blank">用JWT认证Graphql查询</a></p></div></div>    
</body>
</html>