# React useEffect hook çš„å¸¸è§é”™è¯¯åŠå…¶é¢„é˜²ã€‚

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/commons-mistakes-with-react-useeffect-hook-and-how-to-prevent-them-d0ca253fb1f7?source=collection_archive---------1----------------------->

## æŠ€æœ¯æç¤º

## æˆ‘åœ¨ä½¿ç”¨`useEffect`æ—¶é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä¼šè¯•ç€ç»™ä½ ä¸€äº›å¿«é€Ÿçš„æ¨¡å¼ï¼Œè®©ä½ ä¸ä¼šé™·å…¥åŒæ ·ä»¤äººå¤±æœ›çš„çŠ¶æ€ã€‚

![](img/b0ad4c25fcb3cc8e1dead30b824a38fe.png)

`useEffect`æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œä½†ä½ éœ€è¦åœ¨æ¸…æ¥šäº†è§£å®ƒå¦‚ä½•å·¥ä½œçš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒã€‚å¦åˆ™ï¼Œæ‚¨å¯èƒ½ä¼šé™·å…¥ä»¤äººå¤±æœ›çš„å¢ƒåœ°ï¼Œå‡ºç°ä¸€äº›éš¾ä»¥è°ƒè¯•çš„æ„å¤–é”™è¯¯ã€‚

# åœ¨`useEffect`è¿”å›ä¸€ä¸ªæ‰¿è¯ºè€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°

æˆ‘æƒ³è¯´çš„ç¬¬ä¸€ä¸ªé”™è¯¯æ˜¯`useEffect`æœŸæœ›ä½ è¿”å›`undefined`æˆ–è€…ä¸€ä¸ª`cleanup function`ã€‚ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨äº†ä¸€ä¸ª`async`å‡½æ•°ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨ä¸€ä¸ªæœŸæœ›å‡½æ•°çš„åœ°æ–¹è¿”å›äº†ä¸€ä¸ªæ‰¿è¯º(æœ‰æ—¶æ˜¯ä¸€ä¸ªè§£æä¸ºå‡½æ•°çš„æ‰¿è¯º)ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆä½ çš„æ¸…ç†æ²¡æœ‰å·¥ä½œã€‚

è¿™æ˜¯å¦‚ä½•å‘ç”Ÿçš„å®Œç¾ä¾‹å­ï¼Œä»¥åæˆ‘ä»¬ä¼šçœ‹åˆ°å¤„ç†è¿™ç§æƒ…å†µçš„æ­£ç¡®æ–¹æ³•:

```
const App = () => {   
  useEffect(async () => {
    const unsubsribe = await dummySubscriber(); return () => {
       unsubscribe()
     }
   }, []) return null
}
```

ä¸Šé¢çš„ä¾‹å­æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºåœ¨é—­åŒ…ç”Ÿæˆçš„æ—¶å€™ï¼Œunsubscribe å‡½æ•°æ˜¯æœªå®šä¹‰çš„ã€‚

æˆ‘å·²ç»åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­è§£é‡Šäº†å¦‚ä½•å¤„ç†å¼‚æ­¥ä»£ç :

[](https://medium.com/javascript-in-plain-english/how-to-use-async-function-in-react-hook-useeffect-typescript-js-6204a788a435) [## å¦‚ä½•åœ¨ React hook use effect(Typescript/JS)ä¸­ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Ÿ

### ğŸ’¡é»˜è®¤æƒ…å†µä¸‹ï¼Œreact çš„ useEffect æŒ‚é’©ä¸æ”¯æŒå¼‚æ­¥å‡½æ•°ï¼Œäº†è§£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ğŸ’ªğŸ»

medium.com](https://medium.com/javascript-in-plain-english/how-to-use-async-function-in-react-hook-useeffect-typescript-js-6204a788a435) 

è¿˜è¦è®°ä½ï¼Œå³ä½¿ä½¿ç”¨å¼‚æ­¥ä»£ç ï¼Œæ•ˆæœä¹Ÿåªæ˜¯åœ¨è§¦å‘å’Œå¿˜è®°æ¨¡å¼ä¸‹è§¦å‘ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ‚¨çš„å¼‚æ­¥ä»£ç ã€‚å¦åˆ™ä¼šæœ‰ç¾éš¾æ€§çš„ç”¨æˆ·ç•Œé¢åæœã€‚

# useEffect å’Œå¼‚æ­¥æˆ–æ¡ä»¶è®¢é˜…:å¦‚ä½•æ­£ç¡®æ¸…ç†å®ƒä»¬ï¼Ÿ

å¤§å¤šæ•°äººè®¤ä¸ºä»–ä»¬æ­£åœ¨æ­£ç¡®åœ°å–æ¶ˆè®¢é˜…æˆ–é™„åŠ åˆ°å…¶èŠ‚ç‚¹çš„äº‹ä»¶ä¾¦å¬å™¨ï¼Œä½†æœ‰æ—¶ä»–ä»¬æ˜¯é”™è¯¯çš„â€¦

è™½ç„¶å½“ä»£ç æ˜¯åŒæ­¥çš„å¹¶ä¸”æ²¡æœ‰æ¡ä»¶å—æ—¶ï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œä½†å½“å®ƒä¸æ˜¯åŒæ­¥çš„æ—¶ï¼Œå¯èƒ½ä¼šå˜å¾—æœ‰ç‚¹æ£˜æ‰‹ã€‚

è€ƒè™‘ä¸‹é¢çš„äº‹ä»¶è®¢é˜…è€…ï¼Œå®ƒè¢«ç»™å®šä¸€ä¸ª`callback`å¹¶è¿”å›`unsubscribe`å‡½æ•°ã€‚

```
function dummySubscriber(callback) {
  const interval = setInterval(() => callback("ticked"), 1000);

  return function unSubscribe() {
    clearInterval(interval);
  };
}
```

æˆ‘å·²ç»çœ‹è¿‡å¤ªå¤šæ¬¡ä¸‹é¢çš„ä»£ç ï¼Œè®©å¼€å‘äººå‘˜æœŸæœ›å–æ¶ˆè®¢é˜…ã€‚

```
const App = () => {   
  useEffect(() => {
     let unsubscribe = () => undefined async function playEffect() {
       await someAsyncCode()
       unsubsribe = dummySubscriber()
     }
     playEffect() return () => {
       unsubscribe()
     }
   }, []) return null
}
```

äº‹å®æ˜¯ä¸Šé¢çš„ä»£ç ä¸ä¼šé€€è®¢ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œå› ä¸ºåœ¨ç”Ÿæˆè¿”å›å‡½æ•°çš„é‚£ä¸€åˆ»ï¼Œ`unsubscribe`è¿˜æœ‰`() => undefined`å€¼ã€‚

é€šè¿‡åœ¨å¼‚æ­¥ä»£ç ä¸­é‡æ–°åˆ†é…å®ƒï¼Œæˆ‘ä»¬æ›¿æ¢äº†å¼•ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”èµ›æ¡ä»¶ï¼Œå› æ­¤æœ‰æ—¶å¯èƒ½ä¸ä¼šå‘ç”Ÿï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒå¾ˆæ£˜æ‰‹ï¼Œä½†å®ƒä¸€ç‚¹ä¹Ÿä¸å®‰å…¨ã€‚

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å…‹æœè¿™ä¸ªé—®é¢˜:

*   ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡å¹¶ä¿®æ”¹å®ƒçš„ä¸€ä¸ªå±æ€§ï¼Œè¿™å°†ä¿æŒå¯¹æºå¯¹è±¡çš„å¼•ç”¨ã€‚
*   å†æ¬¡ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯é€šè¿‡ä½¿ç”¨`useRef` hook from Reactã€‚

ä¸¤è€…éƒ½æœ‰ç›¸åŒçš„å¥½å¤„ï¼Œä½†æ˜¯ä½¿ç”¨`useRef`å…è®¸æ‚¨ä»å…¶ä»–åœ°æ–¹ç¼–è¾‘è¿™æ®µä»£ç ã€‚

ç®€å•åœ°è¯´ï¼Œ`useRef`ç”¨`.current`è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™å…è®¸æˆ‘ä»¬é‡æ–°èµ‹å€¼å¹¶ä¿ç•™å¯¹æºå¯¹è±¡çš„å¼•ç”¨ã€‚

```
const App = () => {   
  useEffect(() => {
     const subscription = {unsubscribe: () => undefined} async function playEffect() {
       await someAsyncCode()
       subscription.unsubsribe = dummySubscriber()
     }
     playEffect() return () => {
       subscription.unsubscribe()
     }
   }, []) return null
}
```

æˆ–è€…ä½¿ç”¨ååº”å‚è€ƒ

```
const App = () => {   
  const unsubscribe = useRef(() => undefined) useEffect(() => {
    async function playEffect() {
       await someAsyncCode()
       unsubscribe.current = dummySubscriber()
     }
     playEffect() return () => {
       unsubscribe.current()
     }
   }, []) return null
}
```

ç°åœ¨ï¼Œå½“ç”Ÿæˆè¿”å›å‡½æ•°æ—¶ï¼Œå®ƒä¿ç•™äº†ä¸€ä¸ªå¯¹å¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¯¥å¯¹è±¡çš„å±æ€§`current`æˆ–`unsubscribe`è¢«æ›´æ–°ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„ clean å‡½æ•°å°±è¢«æ­£ç¡®åœ°è°ƒç”¨äº†ã€‚

# useEffect éé¢„æœŸè§¦å‘å’Œæ— é™å¾ªç¯

ç”¨`useEffect`å®ç°æ— é™å¾ªç¯æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å½“ä¸€äº›çŠ¶æ€æ”¹å˜æ—¶è§¦å‘æ•ˆæœï¼Œå½“è¿™ä¸ªçŠ¶æ€æ”¹å˜æ—¶ï¼Œä½ è¿è¡Œä¸€äº›ä»£ç è§¦å‘è¿™ä¸ªç›¸åŒçš„çŠ¶æ€æ”¹å˜ã€‚

è™½ç„¶å½“æ‚¨åªæœ‰è¿™æ ·çš„ä»£ç æ—¶ï¼Œè¿™çœ‹èµ·æ¥å¾ˆæ˜æ˜¾:

```
const App = () => {
   const [state, setState] = useState(); React.useEffect(() => {
     setState(Math.random());
   }, [state])
 }
```

å½“`deps`æ•°ç»„æœ‰å¤šä¸ªå€¼æ—¶ï¼Œè¿™éå¸¸æ–¹ä¾¿ã€‚æˆ‘çœ‹åˆ°å¾ˆå¤š(å¤ªå¤š)çš„`useEffect`å‡½æ•°åœ¨åšå¤ªå¤šçš„äº‹æƒ…ã€‚

æ€»æ˜¯å€¾å‘äºä½¿ç”¨å¤šä¸ª`useEffect`å¹¶ä¿æŒå•ä¸€è´£ä»»åŸåˆ™çš„æœ‰æ•ˆæ€§ã€‚åœ¨`useEffect`ç¬¬äºŒä¸ªå‚æ•°ä¸­ï¼Œä¾èµ–å…³ç³»è¶Šå°‘ï¼Œå‡ºç°çš„é”™è¯¯å°±è¶Šå°‘ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ è§‰å¾—ä½ çš„æ•ˆæœä¸­æœ‰å¤ªå¤šçš„ä»£ç ï¼ŒèŠ±äº›æ—¶é—´é‡æ„å¹¶æå–å®Œæˆå·¥ä½œçš„å‡½æ•°ã€‚

æˆ‘å·²ç»ä¸º`useState`é’©å­å†™äº†ä¸€ç¯‡ç±»ä¼¼çš„æ–‡ç« ï¼Œä½ å¯èƒ½ä¼šæ„Ÿå…´è¶£ã€‚

[](https://medium.com/javascript-in-plain-english/commons-mistakes-with-react-usestate-hook-and-how-to-prevent-them-43c811ca7451) [## React useState é’©å­çš„å¸¸è§é”™è¯¯ä»¥åŠå¦‚ä½•é˜²æ­¢å®ƒä»¬ã€‚

### æˆ‘åœ¨å„ç§ react é¡¹ç›®ä¸­çœ‹åˆ°äº†ä¸€ç³»åˆ—æ£˜æ‰‹çš„é”™è¯¯ï¼Œè€Œå¼€å‘äººå‘˜æ²¡æœ‰æ„è¯†åˆ°è¿™äº›é”™è¯¯å¯èƒ½ä¼šç ´åä»–ä»¬çš„æ•´ä¸ªâ€¦

medium.com](https://medium.com/javascript-in-plain-english/commons-mistakes-with-react-usestate-hook-and-how-to-prevent-them-43c811ca7451) 

## [**ğŸ‡«ğŸ‡·ä¸ºæ³•å›½äººğŸ¥–**æˆ‘æè®®å°†âš¡ï¸ **ç¼–ç  Spark** å¹¶ä»¥ç®€è®¯çš„å½¢å¼å‘å¸ƒï¼Œä»¥è·å¾—ç›¸å…³æŠ€æœ¯çš„æŠ¥é…¬ï¼](https://codingspark.io/?referral=medium)