<html>
<head>
<title>Remotely Execute Amazon EC2 Linux Commands without SSH</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">远程执行Amazon EC2 Linux命令，无需SSH</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/remotely-execute-amazon-ec2-linux-commands-without-ssh-fc2f64164410?source=collection_archive---------9-----------------------#2020-09-21">https://javascript.plainenglish.io/remotely-execute-amazon-ec2-linux-commands-without-ssh-fc2f64164410?source=collection_archive---------9-----------------------#2020-09-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><a href="http://www.dltlabs.com"><div class="gh gi jn"><img src="../Images/979caf6930f268879c6ee350ed6e5ce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UPG5MB7lbOrZcwD2DFB0Nw.png"/></div></a></figure><p id="c5c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我在DLT实验室<a class="ae ks" href="http://www.dltlabs.com" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir"/></a>担任软件工程角色时，与各种云提供商合作时，我遇到了一个非常有用的技术，我们可以利用它在亚马逊Web服务(AWS)虚拟机(EC2实例)上运行命令或脚本，而不需要SSH访问，也不允许任何端口访问。</p><p id="97bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我将使用名为<strong class="jw ir"> AWS系统管理器</strong>的服务来实现这一点。</p><p id="44ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">AWS系统管理器(SSM)是众多流行的AWS服务之一，它可以帮助您在一台或多台EC2机器上轻松运行远程命令或脚本。</p><p id="60ee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇博客中，我将分享我们如何使用<strong class="jw ir"> AWS SDK NodeJS来做到这一点。</strong></p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="59e4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">目标</h1><p id="36c2" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">在代码实施期间，我们的目标是通过使用AWS SSM在EC2机器上执行以下命令:</p><ul class=""><li id="1023" class="md me iq jw b jx jy kb kc kf mf kj mg kn mh kr mi mj mk ml bi translated">触摸sample.txt</li><li id="09a9" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated">Echo我来自目标机&gt; &gt; sample.txt</li><li id="bb51" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated">限位开关（Limit Switch）</li><li id="9747" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated">Cat sample.txt</li></ul><p id="8b19" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们将学习如何在应用服务器上查看命令状态和相应的日志。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="fec8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">先决条件</strong></h1><p id="4b4a" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">读者应该对Amazon AWS有一些了解，例如，他们应该了解IAM角色、IAM用户以及如何将角色附加到EC2实例。除此之外，我将使用NodeJS技术栈。两者的细节描述如下:</p><h2 id="9d4c" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak"> 1。</strong> <strong class="ak">需要的配置和策略。</strong></h2><ul class=""><li id="5011" class="md me iq jw b jx ly kb lz kf nd kj ne kn nf kr mi mj mk ml bi translated"><strong class="jw ir"> IAM用户的凭证:</strong>创建一个IAM用户，并将<strong class="jw ir"> EC2 </strong>和<strong class="jw ir"> SSM </strong>策略附加到该用户，以便该用户能够在目标机器上执行命令。</li><li id="9a41" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir"> IAM角色:</strong>创建一个新的IAM角色，并将<strong class="jw ir"><em class="ng">awsec 2 roleforsm</em></strong>策略附加到它。所有的目标机器都应该附加这个角色，以便SSM服务能够与EC2机器通信。</li></ul><h2 id="5731" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak"> 2。</strong> <strong class="ak">软件/库</strong></h2><ul class=""><li id="498b" class="md me iq jw b jx ly kb lz kf nd kj ne kn nf kr mi mj mk ml bi translated"><strong class="jw ir"> NodeJS引擎</strong></li><li id="39e5" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir"> AWS-SDK模块:</strong>要安装此模块，请使用:<strong class="jw ir"> npm i aws-sdk </strong></li><li id="f12c" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">蓝鸟:</strong>使用<strong class="jw ir"> npm i蓝鸟</strong></li><li id="097b" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir"> Lodash </strong>:使用<strong class="jw ir"> npm i lodash </strong></li></ul><p id="a635" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> &gt; &gt;代码实现将发生在以下阶段:</strong></p><ol class=""><li id="4db6" class="md me iq jw b jx jy kb kc kf mf kj mg kn mh kr nh mj mk ml bi translated">在向目标机器发送命令之前，首先我们将检查目标机器是否准备好接收命令。</li><li id="01c8" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr nh mj mk ml bi translated">如果机器准备好了，我们就发送指令。</li><li id="d5bf" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr nh mj mk ml bi translated">之后，我们将持续监控命令状态。</li><li id="3753" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr nh mj mk ml bi translated">一旦命令被执行，我们可以在远程机器的控制台中看到它们的日志。</li></ol><p id="cfc4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一切就绪，让我们从实际的代码实现开始。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="2f4c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">实施我们的准则</h1><p id="815b" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated"><strong class="jw ir">第一步</strong>:创建一个samplefile.js。</p><p id="7cc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">第二步:</strong>导入所有模块，并在SSM对象中设置IAM用户的凭证。</p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="f609" class="mr lb iq nn b gy nr ns l nt nu">// Importing modules</span><span id="9507" class="mr lb iq nn b gy nv ns l nt nu">const AWS = require(‘aws-sdk’)</span><span id="a291" class="mr lb iq nn b gy nv ns l nt nu">const Promise = require(‘bluebird’)</span><span id="b863" class="mr lb iq nn b gy nv ns l nt nu">const _ = require(‘lodash’)</span><span id="75d3" class="mr lb iq nn b gy nv ns l nt nu">const ssm = new AWS.SSM({</span><span id="4b88" class="mr lb iq nn b gy nv ns l nt nu">accessKeyId: ‘KLIAT7SDWDFRR4HBJ3E4N’, // Insert your IAM User Access Key</span><span id="f368" class="mr lb iq nn b gy nv ns l nt nu">secretAccessKey: ‘xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx’, //User secret key</span><span id="0cb4" class="mr lb iq nn b gy nv ns l nt nu">region: ‘us-east-2’</span><span id="659e" class="mr lb iq nn b gy nv ns l nt nu">})</span></pre><p id="3de5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤3: </strong>将以下代码片段添加到samplefile.js中</p><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="1f52" class="mr lb iq nn b gy nr ns l nt nu">// @params {Array} instanceIds : Array of instance ids</span><span id="6a3a" class="mr lb iq nn b gy nv ns l nt nu">async function mainFunction(instanceIds) {</span><span id="a723" class="mr lb iq nn b gy nv ns l nt nu">if (!Array.isArray(instanceIds)) instanceIds = [instanceIds];</span><span id="2d7d" class="mr lb iq nn b gy nv ns l nt nu">console.info(“\n”);</span><span id="e1a0" class="mr lb iq nn b gy nv ns l nt nu">console.info(“Input Instances are: “, instanceIds, “\n”);</span><span id="6bfd" class="mr lb iq nn b gy nv ns l nt nu">try {</span><span id="337c" class="mr lb iq nn b gy nv ns l nt nu">let managedInstanceIds = await checkInstanceIsReady(instanceIds)</span><span id="2879" class="mr lb iq nn b gy nv ns l nt nu">console.info(“Managed Instances list ready to receive commands : “, managedInstanceIds, “\n”);</span><span id="b898" class="mr lb iq nn b gy nv ns l nt nu">if (!_.isEmpty(managedInstanceIds)) {</span><span id="74f2" class="mr lb iq nn b gy nv ns l nt nu">let commandParameters = {</span><span id="0ca8" class="mr lb iq nn b gy nv ns l nt nu">DocumentName: “AWS-RunShellScript”,</span><span id="495e" class="mr lb iq nn b gy nv ns l nt nu">Targets: [{</span><span id="10ba" class="mr lb iq nn b gy nv ns l nt nu">Key: “InstanceIds”,</span><span id="6f92" class="mr lb iq nn b gy nv ns l nt nu">Values: managedInstanceIds</span><span id="4fec" class="mr lb iq nn b gy nv ns l nt nu">}],</span><span id="abaa" class="mr lb iq nn b gy nv ns l nt nu">Parameters: {</span><span id="ce6f" class="mr lb iq nn b gy nv ns l nt nu">workingDirectory: [“/home/mydir”],</span><span id="126c" class="mr lb iq nn b gy nv ns l nt nu">commands: [“touch sample.txt”, “echo I am from target machine &gt;&gt; sample.txt”, “ls”, “cat sample.txt”]</span><span id="81ee" class="mr lb iq nn b gy nv ns l nt nu">},</span><span id="c56a" class="mr lb iq nn b gy nv ns l nt nu">TimeoutSeconds: 60000,</span><span id="8d3f" class="mr lb iq nn b gy nv ns l nt nu">MaxConcurrency: “50”,</span><span id="9aeb" class="mr lb iq nn b gy nv ns l nt nu">MaxErrors: “0”,</span><span id="16fb" class="mr lb iq nn b gy nv ns l nt nu">};</span><span id="fd63" class="mr lb iq nn b gy nv ns l nt nu">let data = await sendCommandToInstances(commandParameters);</span><span id="186b" class="mr lb iq nn b gy nv ns l nt nu">let commandExecStatus = await checkCommandStatus(data.Command.CommandId, 80);</span><span id="44ad" class="mr lb iq nn b gy nv ns l nt nu">console.info(“Command Status is “, commandExecStatus , “\n”);</span><span id="810c" class="mr lb iq nn b gy nv ns l nt nu">for (let eachInstance = 0; eachInstance &lt; managedInstanceIds.length; eachInstance++) {</span><span id="bafa" class="mr lb iq nn b gy nv ns l nt nu">let logs = await getCommandsLogs(managedInstanceIds[eachInstance], data.Command.CommandId, commandExecStatus);</span><span id="b15f" class="mr lb iq nn b gy nv ns l nt nu">console.info(“Commands logs for instance id “, managedInstanceIds[eachInstance], “ is \n”, logs);</span><span id="3a26" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="39b8" class="mr lb iq nn b gy nv ns l nt nu">return Promise.resolve(commandExecStatus);</span><span id="3b3a" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="3c67" class="mr lb iq nn b gy nv ns l nt nu">else {</span><span id="7ce7" class="mr lb iq nn b gy nv ns l nt nu">console.error(“No Instances are ready for receiving the command”)</span><span id="2134" class="mr lb iq nn b gy nv ns l nt nu">return “No Instances are ready for receiving the commands”</span><span id="01b1" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="8b39" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="d476" class="mr lb iq nn b gy nv ns l nt nu">catch (err) {</span><span id="16f4" class="mr lb iq nn b gy nv ns l nt nu">console.error(“Error came while sending commands “, err);</span><span id="5d2a" class="mr lb iq nn b gy nv ns l nt nu">return Promise.reject(err);</span><span id="28b6" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="9407" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="f9c0" class="mr lb iq nn b gy nv ns l nt nu">try {</span><span id="b1ed" class="mr lb iq nn b gy nv ns l nt nu">mainFunction([“i-0b34cbaf7ff6aa3fd”]);</span><span id="1291" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="1010" class="mr lb iq nn b gy nv ns l nt nu">catch(err){</span><span id="47c0" class="mr lb iq nn b gy nv ns l nt nu">console.error(“Error while calling main function “, err);</span><span id="e694" class="mr lb iq nn b gy nv ns l nt nu">}</span></pre><p id="6652" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我们运行<strong class="jw ir"><em class="ng">sample file . js</em></strong>时，<strong class="jw ir">main function(<em class="ng">instance ids</em>)</strong>将是执行开始的第一个。</p><p id="f88d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后<code class="fe nw nx ny nn b"><strong class="jw ir">mainFunction(<em class="ng">instanceIds</em></strong></code> <strong class="jw ir"> ) </strong>会调用另一个函数<code class="fe nw nx ny nn b"><strong class="jw ir">checkInstanceIsReady(<em class="ng">instanceids</em>)</strong></code>。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h2 id="9f4a" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak">调用CheckInstanceIsReady<em class="nz">(instanceIdList)</em></strong></h2><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="32e1" class="mr lb iq nn b gy nr ns l nt nu">/**</span><span id="4880" class="mr lb iq nn b gy nv ns l nt nu">* Function to check whether instances are ready to receive commands</span><span id="2af8" class="mr lb iq nn b gy nv ns l nt nu">* and return an array of such instances</span><span id="bec7" class="mr lb iq nn b gy nv ns l nt nu">* @params {Array} instanceId : Array of instance ids</span><span id="3f4e" class="mr lb iq nn b gy nv ns l nt nu">*/</span><span id="12cc" class="mr lb iq nn b gy nv ns l nt nu">function checkInstanceIsReady(instanceIdList) {</span><span id="cef6" class="mr lb iq nn b gy nv ns l nt nu">let readyInstancesList = []</span><span id="7285" class="mr lb iq nn b gy nv ns l nt nu">let params = {</span><span id="7d19" class="mr lb iq nn b gy nv ns l nt nu">InstanceInformationFilterList: [</span><span id="ac31" class="mr lb iq nn b gy nv ns l nt nu">{</span><span id="b37a" class="mr lb iq nn b gy nv ns l nt nu">key: “InstanceIds”,</span><span id="7c70" class="mr lb iq nn b gy nv ns l nt nu">valueSet: instanceIdList</span><span id="8b99" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="48f6" class="mr lb iq nn b gy nv ns l nt nu">]</span><span id="2d74" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="58cf" class="mr lb iq nn b gy nv ns l nt nu">return new Promise((resolve, reject) =&gt; {</span><span id="07a5" class="mr lb iq nn b gy nv ns l nt nu">ssm.describeInstanceInformation(params, function (err, data) {</span><span id="d8cd" class="mr lb iq nn b gy nv ns l nt nu">if (err) {</span><span id="5281" class="mr lb iq nn b gy nv ns l nt nu">console.error(err);</span><span id="66aa" class="mr lb iq nn b gy nv ns l nt nu">reject(err);</span><span id="6b9a" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="7f63" class="mr lb iq nn b gy nv ns l nt nu">let instanceObj = data.InstanceInformationList</span><span id="b2a3" class="mr lb iq nn b gy nv ns l nt nu">for (let eachInstance = 0; eachInstance &lt; instanceObj.length; eachInstance++) {</span><span id="3cec" class="mr lb iq nn b gy nv ns l nt nu">readyInstancesList.push(instanceObj[eachInstance][“InstanceId”]);</span><span id="571b" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="fe49" class="mr lb iq nn b gy nv ns l nt nu">resolve(readyInstancesList);</span><span id="199b" class="mr lb iq nn b gy nv ns l nt nu">})</span><span id="fa36" class="mr lb iq nn b gy nv ns l nt nu">})</span><span id="3c0f" class="mr lb iq nn b gy nv ns l nt nu">}</span></pre><p id="e823" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">函数<code class="fe nw nx ny nn b"> <strong class="jw ir">checkInstanceIsReady(<em class="ng">instanceIds</em>)</strong></code>又调用一个AWS SSM内置函数<code class="fe nw nx ny nn b"><strong class="jw ir">describeInstanceInformation()</strong></code> <strong class="jw ir"> </strong>并返回一个包含所有准备好从远程机器接收命令的实例id的数组。</p><p id="498f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些实例被称为<strong class="jw ir"> <em class="ng">托管实例</em> </strong>，因为它们可以使用系统管理器(SSM)进行配置。</p><blockquote class="oa ob oc"><p id="e036" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><strong class="jw ir">注意:</strong> <em class="iq">如果任何实例正在运行，但仍未出现在数组中，我们需要检查以下内容:</em></p><p id="fc7e" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><em class="iq"> &gt;所需角色已正确配置(在先决条件中描述)</em></p><p id="a8a2" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><em class="iq">&gt;【SSM代理安装完毕】(如果默认不安装)</em></p></blockquote><p id="362c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在创建一个<strong class="jw ir"> <em class="ng">命令参数</em> </strong>对象，该对象将具有以下关键点:</p><ul class=""><li id="d3d3" class="md me iq jw b jx jy kb kc kf mf kj mg kn mh kr mi mj mk ml bi translated"><strong class="jw ir">文档名:</strong>要运行的系统管理器文档的名称。这可以是公共文档，也可以是自定义文档。这里我们使用的是<strong class="jw ir"><em class="ng">AWS-RunShellScript</em></strong>，它是一个公共文档，用于在EC2机器上远程执行命令。</li><li id="4069" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">参数:<em class="ng"> </em> </strong>它具有以下属性</li><li id="56b3" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">工作目录:</strong>命令将被执行的目标位置的数组。<br/> <strong class="jw ir">如</strong> <code class="fe nw nx ny nn b"><strong class="jw ir">“/home/mydir”</strong></code></li><li id="2f6f" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">命令:</strong>我们希望在目标机器上执行的命令数组。这些命令将连续执行。</li><li id="2fe5" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir"> Targets: </strong>它接受键值对来标识实例。</li><li id="8370" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">关键字:</strong>用户定义的标准，用于发送以满足标准的实例为目标的命令。</li><li id="1a5f" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">值:</strong>映射到关键字的用户定义的标准。<br/>例如，如果<strong class="jw ir">键</strong>是‘instance ids ’,那么其对应的<strong class="jw ir">值</strong>应该是实例id的数组。</li></ul><p id="3c74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个commandParameters对象将被传递给函数<code class="fe nw nx ny nn b"><strong class="jw ir">sendCommandToInstances(<em class="ng">commandParameters</em>)</strong></code>。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h2 id="d46e" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak">调用sendCommandToInstances <em class="nz">(命令参数)</em> </strong></h2><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="4d0b" class="mr lb iq nn b gy nr ns l nt nu">/**</span><span id="44e8" class="mr lb iq nn b gy nv ns l nt nu">* Function will send the command to EC2 machines</span><span id="8a7e" class="mr lb iq nn b gy nv ns l nt nu">* @params {Object} commandParameters : command parameters information</span><span id="f0a5" class="mr lb iq nn b gy nv ns l nt nu">*/</span><span id="bf5c" class="mr lb iq nn b gy nv ns l nt nu">async function sendCommandToInstances(commandParameters) {</span><span id="1603" class="mr lb iq nn b gy nv ns l nt nu">return new Promise(function (resolve, reject) {</span><span id="e98c" class="mr lb iq nn b gy nv ns l nt nu">ssm.sendCommand(commandParameters, function (err, data) {</span><span id="065d" class="mr lb iq nn b gy nv ns l nt nu">if (err) {</span><span id="ae1b" class="mr lb iq nn b gy nv ns l nt nu">console.error(“Unable to sendCommandToinstances:”, err.message);</span><span id="811c" class="mr lb iq nn b gy nv ns l nt nu">reject(“Request Failed! Instance Id/Credentials is not valid or Role not assigned to Ec2”);</span><span id="3feb" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="2340" class="mr lb iq nn b gy nv ns l nt nu">resolve(data);</span><span id="046b" class="mr lb iq nn b gy nv ns l nt nu">});</span><span id="b9e9" class="mr lb iq nn b gy nv ns l nt nu">});</span><span id="b72d" class="mr lb iq nn b gy nv ns l nt nu">}</span></pre><p id="8c2e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">函数<code class="fe nw nx ny nn b"> <strong class="jw ir">sendCommandToInstance(<em class="ng">commandParameters</em>)</strong></code>将调用另一个AWS SSM内置函数<code class="fe nw nx ny nn b">ssm.sendCommand()</code>，并返回一个包含命令信息的对象，即<em class="ng"> commandId、DocumentName、Status </em>等等。</p><p id="8579" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们将调用函数<code class="fe nw nx ny nn b"><strong class="jw ir">checkCommandStatus(<em class="ng">commandId</em>, <em class="ng">maxRetry</em>)</strong></code>，该函数随后调用AWS SSM内置函数<code class="fe nw nx ny nn b"><strong class="jw ir">ssm.listCommands()</strong></code>。基于<code class="fe nw nx ny nn b">commandId</code>，<code class="fe nw nx ny nn b"><strong class="jw ir">ssm.listCommands()</strong></code>将返回相应的命令状态。</p><h2 id="0818" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak">调用checkCommandStatus<em class="nz">(command id，maxRetry) </em> </strong></h2><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="b3e6" class="mr lb iq nn b gy nr ns l nt nu">/**</span><span id="e6f4" class="mr lb iq nn b gy nv ns l nt nu">* Function will check the command status i.e. Success, Failed</span><span id="e014" class="mr lb iq nn b gy nv ns l nt nu">* @params {String} commandId : command Id</span><span id="a729" class="mr lb iq nn b gy nv ns l nt nu">* @params {Number} maxRetry</span><span id="af44" class="mr lb iq nn b gy nv ns l nt nu">*/</span><span id="05b8" class="mr lb iq nn b gy nv ns l nt nu">async function checkCommandStatus(commandId, maxRetry) {</span><span id="f6dc" class="mr lb iq nn b gy nv ns l nt nu">let currentTry = 1;</span><span id="2056" class="mr lb iq nn b gy nv ns l nt nu">return new Promise((resolve, reject) =&gt; {</span><span id="387a" class="mr lb iq nn b gy nv ns l nt nu">let params = {</span><span id="7a28" class="mr lb iq nn b gy nv ns l nt nu">CommandId: commandId</span><span id="8e1d" class="mr lb iq nn b gy nv ns l nt nu">};</span><span id="306e" class="mr lb iq nn b gy nv ns l nt nu">let toStopInterval = setInterval(() =&gt; {</span><span id="b003" class="mr lb iq nn b gy nv ns l nt nu">ssm.listCommands(params, (err, data) =&gt; {</span><span id="ff33" class="mr lb iq nn b gy nv ns l nt nu">if (err) reject(“Command id not found”);</span><span id="03fb" class="mr lb iq nn b gy nv ns l nt nu">if (currentTry &gt; maxRetry) {</span><span id="c350" class="mr lb iq nn b gy nv ns l nt nu">clearInterval(toStopInterval);</span><span id="6467" class="mr lb iq nn b gy nv ns l nt nu">reject(“Max Limit Reached! Status cannot determined”);</span><span id="a3f8" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="179c" class="mr lb iq nn b gy nv ns l nt nu">let commandStatus = data.Commands[0].Status;</span><span id="599c" class="mr lb iq nn b gy nv ns l nt nu">if (commandStatus === ‘InProgress’) {</span><span id="aef1" class="mr lb iq nn b gy nv ns l nt nu">currentTry += 1;</span><span id="775e" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="5c44" class="mr lb iq nn b gy nv ns l nt nu">else {</span><span id="ff44" class="mr lb iq nn b gy nv ns l nt nu">clearInterval(toStopInterval);</span><span id="f4fe" class="mr lb iq nn b gy nv ns l nt nu">resolve(data.Commands[0].Status);</span><span id="3567" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="896c" class="mr lb iq nn b gy nv ns l nt nu">});</span><span id="b4a1" class="mr lb iq nn b gy nv ns l nt nu">}, 1500);</span><span id="0fca" class="mr lb iq nn b gy nv ns l nt nu">});</span><span id="942b" class="mr lb iq nn b gy nv ns l nt nu">}</span></pre><p id="0376" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们可以使用我们使用的<code class="fe nw nx ny nn b"><strong class="jw ir">setInterval()</strong>. </code>进行连续监控。</p><p id="2b10" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果命令状态为<strong class="jw ir"> <em class="ng">成功</em> </strong> <em class="ng"> </em>或<strong class="jw ir"> <em class="ng">失败</em>，</strong>控制将直接返回<code class="fe nw nx ny nn b"><strong class="jw ir">mainFunction()</strong></code>，但如果状态为<code class="fe nw nx ny nn b"><strong class="jw ir">InProgress</strong></code>，则<code class="fe nw nx ny nn b"><strong class="jw ir">ssm.listCommands()</strong> </code>功能将检查状态，直到达到<code class="fe nw nx ny nn b">maxRetry</code>极限。</p><p id="c0ba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">到目前为止，我们已经向目标机器发送了命令，并准备好查看它们的日志。</strong></p><p id="8069" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，我们调用函数<code class="fe nw nx ny nn b"><strong class="jw ir">getCommandsLogs(<em class="ng">instanceId</em>, <em class="ng">commandId, commandExecStatus</em>)</strong></code> <strong class="jw ir"> </strong>，该函数将调用AWS SSM内置函数<code class="fe nw nx ny nn b"><strong class="jw ir">ssm.getCommandInvocation()</strong></code> <strong class="jw ir"> </strong>，并将命令日志返回给<code class="fe nw nx ny nn b"><strong class="jw ir">mainFunction()</strong></code> <strong class="jw ir">。</strong></p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h2 id="f029" class="mr lb iq bd lc ms mt dn lg mu mv dp lk kf mw mx lo kj my mz ls kn na nb lw nc bi translated"><strong class="ak">调用getCommandsLogs <em class="nz"> (instanceId，commandId，commandExecStatus)</em>T3】</strong></h2><pre class="ni nj nk nl gt nm nn no np aw nq bi"><span id="fa22" class="mr lb iq nn b gy nr ns l nt nu">/**</span><span id="bdcf" class="mr lb iq nn b gy nv ns l nt nu">* Function will help to get the command logs</span><span id="ffa4" class="mr lb iq nn b gy nv ns l nt nu">* @params {Array} instanceId : Instance Id of Ec2 machine</span><span id="dd01" class="mr lb iq nn b gy nv ns l nt nu">* @params {String} commandId : command Id</span><span id="33e9" class="mr lb iq nn b gy nv ns l nt nu">* @params {String} commandExecStatus : command status</span><span id="2280" class="mr lb iq nn b gy nv ns l nt nu">*/</span><span id="bc88" class="mr lb iq nn b gy nv ns l nt nu">async function getCommandsLogs(instanceId, commandId, commandExecStatus) {</span><span id="e3af" class="mr lb iq nn b gy nv ns l nt nu">let params = {</span><span id="df5e" class="mr lb iq nn b gy nv ns l nt nu">CommandId: commandId,</span><span id="beba" class="mr lb iq nn b gy nv ns l nt nu">InstanceId: instanceId</span><span id="618a" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="4bd5" class="mr lb iq nn b gy nv ns l nt nu">return new Promise((resolve, reject) =&gt; {</span><span id="9455" class="mr lb iq nn b gy nv ns l nt nu">ssm.getCommandInvocation(params, (err, data) =&gt; {</span><span id="81b1" class="mr lb iq nn b gy nv ns l nt nu">if (err) {</span><span id="3939" class="mr lb iq nn b gy nv ns l nt nu">console.error(“Error came while fetching the logs “, err);</span><span id="8b67" class="mr lb iq nn b gy nv ns l nt nu">reject(err);</span><span id="bb13" class="mr lb iq nn b gy nv ns l nt nu">}</span><span id="bb09" class="mr lb iq nn b gy nv ns l nt nu">let logs = commandExecStatus === “Success” ? data.StandardOutputContent : data.StandardErrorContent</span><span id="7e36" class="mr lb iq nn b gy nv ns l nt nu">return resolve(logs);</span><span id="a822" class="mr lb iq nn b gy nv ns l nt nu">})</span><span id="3906" class="mr lb iq nn b gy nv ns l nt nu">})</span><span id="d840" class="mr lb iq nn b gy nv ns l nt nu">}</span></pre></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="2330" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">代码输出</strong></h1><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/1efbdc3641edb12a49c7f359a4ddf504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*M8x66-hruQESUdzhjQrZyQ.png"/></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk">Output of the above code | <a class="ae ks" href="http://www.dltlabs.com" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="4d6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这就是我们如何轻松地远程执行命令，并在控制台中查看相应的命令日志。有了SSM，我们不用登录就可以轻松地管理和配置实例。</p><div class="ol om gp gr on oo"><a href="https://medium.com/@dltlabs/enterprise-blockchain-the-cooperation-machine-e8a539f4d45" rel="noopener follow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">企业区块链:合作机器</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">企业区块链可以帮助您的内部部门保持一致并培养信任。</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">medium.com的DLT实验室</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc js oo"/></div></div></a></div><p id="022d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ng">作者</em> </strong> <em class="ng"> — Shivam Dhama，DLT实验室</em></p><p id="8971" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">关于作者</strong> — <em class="ng"> Shivam </em>目前与DL工具团队有关联，拥有亚马逊web服务、NodeJS、Python、机器学习的实践经验。</p><p id="ef2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ng">亚马逊网络服务和AWS是Amazon.com公司或其附属公司在美国和/或其他国家的商标。Node.js是Joyent公司的注册商标。npm是npm公司的注册商标。DLT实验室是DLT全球公司的商标</em></p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><blockquote class="oa ob oc"><p id="5aee" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><strong class="jw ir">参考文献:</strong></p><p id="5e32" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><a class="ae ks" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWSJavaScriptSDK/latest/AWS/SSM . html</a></p><p id="71ec" class="ju jv ng jw b jx jy jz ka kb kc kd ke od kg kh ki oe kk kl km of ko kp kq kr ij bi translated"><a class="ae ks" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/IAM.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWSJavaScriptSDK/latest/AWS/iam . html</a></p></blockquote><figure class="ni nj nk nl gt jr gh gi paragraph-image"><a href="http://www.dltlabs.com"><div class="gh gi pd"><img src="../Images/5d4875bc9a9ff22bb8fd6aad63e3d4e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*78FikurAg7_bGl_Pqh7dPA.png"/></div></a></figure></div></div>    
</body>
</html>