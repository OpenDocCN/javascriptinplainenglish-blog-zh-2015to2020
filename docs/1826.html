<html>
<head>
<title>is-promise post mortem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">死后承诺</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/is-promise-post-mortem-cab807f18dcc?source=collection_archive---------0-----------------------#2020-04-27">https://javascript.plainenglish.io/is-promise-post-mortem-cab807f18dcc?source=collection_archive---------0-----------------------#2020-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="56c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上周六，我决定试着补上一些对我的开源项目的贡献。我决定合并的第一个拉请求之一是<a class="ae kl" href="https://github.com/then/is-promise/pull/10" rel="noopener ugc nofollow" target="_blank">向is-promise </a>添加一个类型声明文件。</p><p id="a0b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">合并后，我决定这也是一个很好的时间来更新模块<a class="ae kl" href="https://github.com/then/is-promise/commit/feb90a40501c8ef69b0c65bdf1eb703182214407" rel="noopener ugc nofollow" target="_blank">支持ES模块样式导入</a>。具体来说，我希望能够<code class="fe km kn ko kp b">import isPromise from 'is-promise';</code>不需要启用合成默认导入。在这之后，我运行了测试，并发布了一个新版本。</p><p id="13e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我曾经打算将我的更多项目设置为通过CI自动发布，而不是从我的本地机器手动发布，但是因为is-promise是一个非常小的库，所以我认为这样做可能不值得。这绝对是个错误。然而，即使我通过CI is-promise设置了发布，也可能没有进行足够彻底的测试。</p><h1 id="8c2d" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">错误</h1><p id="1d53" class="pw-post-body-paragraph jn jo iq jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ij bi translated">事实证明，我在发布这个新的更新时犯了很多的错误:</p><ul class=""><li id="30d0" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">因为存储库有一个<code class="fe km kn ko kp b">.npmignore</code>文件，我假设它在package.json中没有一个<code class="fe km kn ko kp b">"files"</code>数组，所以我没有更新那个数组来包含新的<code class="fe km kn ko kp b">index.mjs</code>文件。</li><li id="9ecd" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">当将<code class="fe km kn ko kp b">"exports"</code>字段添加到<code class="fe km kn ko kp b">package.json</code>中，作为一种告诉node.js新版本ES模块版本的方式时，我假设路径的工作方式与<code class="fe km kn ko kp b">"main"</code>相同，但是它们<strong class="jp ir">需要</strong>前缀<code class="fe km kn ko kp b">./</code>。</li><li id="249d" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">我不明白<code class="fe km kn ko kp b">"exports"</code>字段到<code class="fe km kn ko kp b">package.json</code>不仅限制了<strong class="jp ir">你可以导入什么</strong>，还限制了<strong class="jp ir">你如何导入它。因此，即使我的更改允许您导入<code class="fe km kn ko kp b">index.js</code>文件，如果您正在执行<code class="fe km kn ko kp b">require('is-promise/index')</code>或<code class="fe km kn ko kp b">require('is-promise/index.js')</code>操作，它也会破坏您的代码。</strong></li><li id="4025" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">我也没有考虑到<code class="fe km kn ko kp b">package.json</code>中的<code class="fe km kn ko kp b">"exports"</code>字段会阻止您导入<code class="fe km kn ko kp b">require('is-promise/package.json')</code>。</li></ul><p id="13d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从长远来看，<code class="fe km kn ko kp b">"exports"</code>施加的限制可能是好的，但是它们确实需要测试，并且他们做了一个突破性的改变。</p><h1 id="8b01" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">时间表</h1><ul class=""><li id="d032" class="lt lu iq jp b jq lo ju lp jy mh kc mi kg mj kk ly lz ma mb bi translated">2020–04–25t 15:03:25Z—我发表了is-promise 的<a class="ae kl" href="https://github.com/then/is-promise/releases/tag/2.2.0" rel="noopener ugc nofollow" target="_blank">破碎版。主要问题是package.json </a>中的<code class="fe km kn ko kp b"><a class="ae kl" href="https://github.com/then/is-promise/blob/8e51d62bf158eb0685cd6109f0137472e8c3cb91/package.json#L7-L10" rel="noopener ugc nofollow" target="_blank">"exports"</a></code> <a class="ae kl" href="https://github.com/then/is-promise/blob/8e51d62bf158eb0685cd6109f0137472e8c3cb91/package.json#L7-L10" rel="noopener ugc nofollow" target="_blank">字段</a></li><li id="8399" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 17:16:00 z—Ryan Zimmerman<a class="ae kl" href="https://github.com/then/is-promise/pull/15" rel="noopener ugc nofollow" target="_blank">提交了一个拉动请求</a>，为大多数人解决了问题。</li><li id="bfc5" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 17:48:00 z—我收到一条脸书消息，要求我查看GitHub。这是我第一次意识到有些不对劲。</li><li id="34f7" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 17:54:00 z—<a class="ae kl" href="https://github.com/then/is-promise/releases/tag/2.2.1" rel="noopener ugc nofollow" target="_blank">我合并并释放Ryan的拉请求</a>。对于大多数人来说，这修复了库，但许多人仍然有缓存版本，一些人通过奇怪的路径导入，现在<code class="fe km kn ko kp b">package.json</code>中的<code class="fe km kn ko kp b">"exports"</code>阻止了这些路径。</li><li id="4eb8" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 17:57:00 z—通读了各种问题评论后，我将它们全部关闭，并创建了一个<a class="ae kl" href="https://github.com/then/is-promise/issues/20" rel="noopener ugc nofollow" target="_blank">新标签</a>，以便我们可以进行更有成效的讨论。</li><li id="32a8" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 18:06:00 z—<a class="ae kl" href="https://github.com/then/is-promise/issues/20#issuecomment-619418975" rel="noopener ugc nofollow" target="_blank">乔丹·哈班德向我解释了</a>为什么<code class="fe km kn ko kp b">"exports"</code>仍然是一个突破性的改变。</li><li id="bcdb" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 18:08:08Z—我将<code class="fe km kn ko kp b">package.json</code>中的<code class="fe km kn ko kp b">"exports"</code>全部移除，并且<a class="ae kl" href="https://github.com/then/is-promise/releases/tag/2.2.2" rel="noopener ugc nofollow" target="_blank">发布固定版本</a></li><li id="edcd" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">2020–04–25t 19:20:00 z—我取消了已损坏版本的发布，试图迫使任何拥有锁定文件的人从这些版本进行更新。</li></ul><p id="d4e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总的来说，图书馆被破坏了大约3个小时。</p><h1 id="57dc" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">成因</h1><p id="8a59" class="pw-post-body-paragraph jn jo iq jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ij bi translated">各种因素使我犯了我犯过的错误:</p><ul class=""><li id="f7a0" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">从我的本地机器上发布总是让人想跳过创建拉请求的重要步骤，让CI测试我的更改。</li><li id="c55b" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">我们的测试只覆盖了实际代码，他们没有检查发布给npm的内容。</li><li id="4dbc" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">我们没有在node.js的最新版本上进行测试</li><li id="fd65" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">在这次事件中，我不容易找到。尽管GitHub库上有多个贡献者，但他们没有部署新版本的权限。</li></ul><h1 id="b853" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">为防止未来问题而采取的措施</h1><ul class=""><li id="a963" class="lt lu iq jp b jq lo ju lp jy mh kc mi kg mj kk ly lz ma mb bi translated">将节点12和14添加到CI测试套件(【https://github.com/then/is-promise/pull/21】T2)</li><li id="4153" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">添加了使用<code class="fe km kn ko kp b">npm pack</code>测试实际发布的API的测试(【https://github.com/then/is-promise/pull/25】T4)</li><li id="c4ca" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">移除了<code class="fe km kn ko kp b">.npmignore</code>以减少混淆的机会(<a class="ae kl" href="https://github.com/then/is-promise/pull/28" rel="noopener ugc nofollow" target="_blank">https://github.com/then/is-promise/pull/28</a>)</li><li id="72e6" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">使用<a class="ae kl" href="https://rollingversions.com/" rel="noopener ugc nofollow" target="_blank">滚动版本</a>(<a class="ae kl" href="https://github.com/then/is-promise/pull/25" rel="noopener ugc nofollow" target="_blank">https://github.com/then/is-promise/pull/25</a>)从CI自动发布</li></ul><h1 id="48aa" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">滚动版本&amp;承诺3.0.0</h1><p id="e8fb" class="pw-post-body-paragraph jn jo iq jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ij bi translated">这件事之后，我决定尽可能地把一切都设置得更健壮。我还决定，最安全的做法是将所有这些更改作为一个新的主要版本发布，以避免破坏人们的东西，即使他们使用未记录的方法来导入。</p><p id="dbab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去的几个月里，我一直在构建滚动版本，这是一个通过持续集成来帮助您安全发布包的工具，同时还有很棒的变更日志。我现在已经将这一点添加到is-promise中，这让我对未来的版本更有信心。</p><p id="7082" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从持续集成中释放出来是你可以做的最大的事情之一，来帮助防止类似的事件发生。写变更日志也是帮助你回顾自己的变更并思考其影响的一种非常有效的方式。只有当您将更改日志作为拉请求的一部分而不是在事后编写时，这才真正有效。你可以在变更日志中看到细节的增加，因为我是事后才写的(&lt; 3.0.0) to writing them as part of the pull request (≥ 3.0.0): <a class="ae kl" href="https://github.com/then/is-promise/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/then/is-promise/releases</a></p><p id="b414" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想了解更多关于滚动版本的信息，或者想了解我对软件开发和开源的最新想法，您可以在这里订阅我的邮件列表:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/ac2a368df91a0cbd37a18872d81373ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1i_ocyaTAJs-IOO1.png"/></div></div></figure></div></div>    
</body>
</html>