<html>
<head>
<title>Janky animations? Web Workers to the rescue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Janky动画公司？网络工作者来拯救</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/janky-animations-web-workers-to-the-rescue-b650d8f18db3?source=collection_archive---------11-----------------------#2020-06-01">https://javascript.plainenglish.io/janky-animations-web-workers-to-the-rescue-b650d8f18db3?source=collection_archive---------11-----------------------#2020-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f675" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在单独的线程上运行繁重的计算</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/719930755687caba3ef0d98ef14515db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sRts9wOpUyND5bWt"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@steve_j?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Steve Johnson</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ed39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为单线程语言，JavaScript必须运行浏览器中的所有代码，并执行回流、绘制和垃圾收集。如果脚本包含CPU密集型任务，这可能会导致UI无响应。</p><p id="9b3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将使用一个例子，其中有一些繁重的计算，导致了一点点糟糕的性能，稍后提供一个web worker的解决方案。</p><h1 id="898f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">问题</strong></h1><p id="730d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们先来看看主线程的代码，这样你就能了解我们在做什么了:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="1579" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的代码是怎么回事:</p><ol class=""><li id="a567" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">点击“动画”按钮来制作盒子的动画</li><li id="c47d" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">通过点击“计算”按钮执行一些计算。</li></ol><p id="1b7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以参观<a class="ae kv" href="https://withoutwebworker.firebaseapp.com/" rel="noopener ugc nofollow" target="_blank">演示</a>来看看它是如何表现的。附上下面的用户界面图像:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/b7f657ab636f92b30bc37b749b2c63d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j51kq2URki7PGfBOYzb-ig.png"/></div></div></figure><p id="9c54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过单击“动画”然后单击“计算”来测试性能问题，直到执行计算。起初它看起来并不重要，但实际上它干扰了动画，我将通过一些剖析展示给你看。</p><p id="7439" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们用开发者工具来分析我们网站的性能(我用的是Chrome)。让我们打开开发人员工具，前往性能选项卡。</p><p id="c919" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将执行以下步骤来记录表演-</p><ol class=""><li id="486f" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">点击<strong class="ky ir">动画</strong>。</li><li id="2778" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">单击记录按钮开始分析。</li><li id="d8fe" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">点击<strong class="ky ir">计算</strong>两到三次。</li><li id="c819" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">单击“停止”按钮停止分析。</li></ol><p id="7890" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将会注意到我们的用户界面的瀑布视图，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/07b2db487a29487d1537a0f706c60ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Ij3S41cxcnGjfeQAtJAAA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Waterfall view</figcaption></figure><p id="6774" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">绿色条显示了在整个概要文件中运行的CSS动画。用黄色条显示的倾角是我们进行计算的地方。</p><p id="7c3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我突出显示了显示帧速率下降的部分。我们可以看到，对于大部分录音来说，帧速率相当健康，但每当我们按下按钮时，它就会完全崩溃。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/fe16f8b01044ac3a8eed18b96b478801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FA7NVx8B115uyRu12l_FIQ.png"/></div></div></figure><p id="be8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来让我们尝试用web worker来改善这个问题。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="a2a8" class="ls lt iq bd lu lv np lx ly lz nq mb mc jw nr jx me jz ns ka mg kc nt kd mi mj bi translated"><strong class="ak">网络工作者</strong></h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/d46486ecfb03cc5dfc980ee2cb46e0b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W-k5Z82rhQojypRX"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@christopher__burns?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Christopher Burns</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7b56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Web worker尝试在不干扰主线程的单独线程中运行脚本。主线程和工作线程不能直接相互调用，而是使用异步消息传递API进行通信。</p><p id="5c23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是我们的主线程代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="ebaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与原始版本相比，这里的主要区别在于我们需要:</p><ul class=""><li id="c2ff" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr nv mx my mz bi translated">创建一个工人</li><li id="91be" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr nv mx my mz bi translated">当我们准备好计算时，给它发一个消息</li><li id="6bf8" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr nv mx my mz bi translated">请听一个名为“done”的消息，该消息表示工作人员已经完成。</li></ul><p id="6fa1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的工作线程的代码将如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="20fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在worker中，我们必须监听告诉我们开始的消息，并在我们完成时发送一个“done”消息。长时间运行的计算实际上是和我们之前一样的循环。</p><p id="bb9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们对这个版本进行一些分析。您可以访问<a class="ae kv" href="https://webworker-7e530.firebaseapp.com/" rel="noopener ugc nofollow" target="_blank">此处</a>查看包含服务人员代码的新网站，并获取新的个人资料。</p><p id="3492" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是它的样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/9698c8fd64d82f311e9966609529244f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DAgxf6-J8ZVBASLiFt8ZAQ.png"/></div></div></figure><p id="70a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个配置文件中，我们按了两次按钮。每次按下按钮都会在概览中显示为两个黄色标记。</p><p id="1569" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以注意到，在这种情况下没有任何帧速率下降，因为计算是在一个单独的线程上处理的。一旦完成，我们就与主线程通信。这大大减少了主线程的负载，提高了性能。</p><p id="caac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑使用web workers来处理这种密集型任务，因为主JS线程被阻塞会导致性能下降。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h2 id="5b83" class="nx lt iq bd lu ny nz dn ly oa ob dp mc lf oc od me lj oe of mg ln og oh mi oi bi translated">浏览器中的Web Worker支持:</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/f8e3f59f5a0aa897262e863345eb40e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*61sIsRagHSIZtvbv-bNHyQ.png"/></div></div></figure></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="842d" class="ls lt iq bd lu lv np lx ly lz nq mb mc jw nr jx me jz ns ka mg kc nt kd mi mj bi translated">资源</h1><div class="ok ol gp gr om on"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd ir gy z fp os fr fs ot fu fw ip bi translated">使用网络工作者</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">Web Workers是Web内容在后台线程中运行脚本的一种简单方式。工作线程可以执行…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">developer.mozilla.org</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb kp on"/></div></div></a></div><div class="ok ol gp gr om on"><a href="https://caniuse.com/#search=web%20worker" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd ir gy z fp os fr fs ot fu fw ip bi translated">我能用吗...HTML5、CSS3等的支持表</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">“我可以使用吗”提供了最新的浏览器支持表，以支持桌面和移动设备上的前端web技术…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">caniuse.com</p></div></div></div></a></div><h2 id="061a" class="nx lt iq bd lu ny nz dn ly oa ob dp mc lf oc od me lj oe of mg ln og oh mi oi bi translated"><strong class="ak">一张用浅白英语写的便条</strong></h2><p id="a079" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">你知道我们有四份出版物和一个YouTube频道吗？你可以在我们的主页<a class="ae kv" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> plainenglish.io </strong> </a>上找到所有这些——关注我们的出版物并<a class="ae kv" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">订阅我们的YouTube频道</strong> </a> <strong class="ky ir">来表达你的爱吧！</strong></p></div></div>    
</body>
</html>