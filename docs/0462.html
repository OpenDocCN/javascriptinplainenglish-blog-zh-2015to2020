<html>
<head>
<title>create-react-app Setup For PWA With Lighthouse Audit.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lighthouse Audit为PWA设置create-react-app。</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/setting-up-pwa-lighthouse-audit-with-create-react-app-40e17180ea6b?source=collection_archive---------7-----------------------#2019-10-18">https://javascript.plainenglish.io/setting-up-pwa-lighthouse-audit-with-create-react-app-40e17180ea6b?source=collection_archive---------7-----------------------#2019-10-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/4d29dda30c104490294059afe0e8dc2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*owd84a_YqEeNjP9frRyzIQ.png"/></div></figure><p id="ae04" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我想用React构建一个PWA，但是<code class="fe kp kq kr ks b">create-react-app</code>不允许你在构建过程中注入你自己的服务工作者，它会生成自己的服务工作者，所以我将向你展示如何配置你的项目，以便能够使用带有<code class="fe kp kq kr ks b">create-react-app</code>的定制服务工作者构建一个PWA，并对构建执行灯塔审计。</p><p id="7ec1" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这是你可以用<code class="fe kp kq kr ks b">create-react-app</code>构建PWA的样板文件</p><div class="kt ku gp gr kv kw"><a href="https://github.com/Noor0/CRA-PWA-Boilerplate" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab fo"><div class="ky ab kz cl cj la"><h2 class="bd io gy z fp lb fr fs lc fu fw im bi translated">诺罗/CRA-PWA-样板文件</h2><div class="ld l"><h3 class="bd b gy z fp lb fr fs lc fu fw dk translated">这个样板文件是为使用create-react-app开发PWAs而配置的。使用它作为一个项目创建与CRA只是使…</h3></div><div class="le l"><p class="bd b dl z fp lb fr fs lc fu fw dk translated">github.com</p></div></div></div></a></div></div><div class="ab cl lf lg hr lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ig ih ii ij ik"><h1 id="f843" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">使用自定义ServiceWorker</h1><p id="d80f" class="pw-post-body-paragraph jr js in jt b ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk mo km kn ko ig bi translated">我们将安装一些依赖项，帮助我们在不退出项目的情况下修改CRA的webpack配置。继续安装<code class="fe kp kq kr ks b">react-app-rewired</code>、<code class="fe kp kq kr ks b">customize-cra</code>和<code class="fe kp kq kr ks b">workbox-webpack-plugin</code></p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="2598" class="mx ln in ks b gy my mz l na nb">yarn add -D react-app-rewired customize-cra workbox-webpack-plugin</span><span id="01fa" class="mx ln in ks b gy nc mz l na nb">or</span><span id="34b8" class="mx ln in ks b gy nc mz l na nb">npm i react-app-rewired customize-cra workbox-webpack-plugin --save-dev</span></pre><p id="3407" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe kp kq kr ks b">react-app-rewired</code>使用一个<code class="fe kp kq kr ks b">config-overrides.js</code>文件来修改配置，并在项目的根目录下创建文件。现在我们只导出一个什么都不做的函数。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="560b" class="mx ln in ks b gy my mz l na nb">//config-overrides.js<br/>module.exports = (config, env) =&gt; config</span></pre><p id="9c11" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">现在，我们将编写一个非常基本的服务工作者，它预先缓存我们的资产，并使用workbox从缓存中为它们提供服务。我们将这个服务工作者添加到<code class="fe kp kq kr ks b">src/</code>文件夹中，<code class="fe kp kq kr ks b">workbox-webpack-plugin</code>将使用这个服务工作者在我们的构建文件夹中生成新的服务工作者。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="63d7" class="mx ln in ks b gy my mz l na nb">// src/service-worker.js</span><span id="2ca5" class="mx ln in ks b gy nc mz l na nb">console<strong class="ks io">.</strong>log('My Custom Service Worker');<br/>workbox<strong class="ks io">.</strong><em class="nd">precaching</em><strong class="ks io">.</strong>precacheAndRoute(self<strong class="ks io">.</strong><em class="nd">__precacheManifest</em>);</span></pre><p id="2ab8" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">请注意，我们正在使用workbox和<code class="fe kp kq kr ks b">__precacheManifest</code>而没有在任何地方导入或声明它，这是因为<code class="fe kp kq kr ks b">workbox-webpack-plugin</code>将为我们完成这项工作，它将生成一个<code class="fe kp kq kr ks b">precache-manifest.js</code>文件，并将该文件和workbox的导入添加到生成的服务工作器中。</p><p id="4c70" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">是时候编写修改配置的代码了，我们将使用<code class="fe kp kq kr ks b">customize-cra</code>来注入我们的插件。</p><p id="b5f9" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们将删除生成标准<code class="fe kp kq kr ks b">create-react-app</code>服务工作者的插件，并添加使用我们的定制服务工作者的<code class="fe kp kq kr ks b">InjectManifest</code>插件。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="4df2" class="mx ln in ks b gy my mz l na nb">// config-overrides.js<br/>const { override, addWebpackPlugin } <strong class="ks io">=</strong> require('customize-cra');<br/>const { InjectManifest } <strong class="ks io">=</strong> require('workbox-webpack-plugin');</span><span id="614e" class="mx ln in ks b gy nc mz l na nb">module<strong class="ks io">.</strong>exports <strong class="ks io">=</strong> (<strong class="ks io">webpack</strong>, <strong class="ks io">...args</strong>) =&gt; {</span><span id="73e4" class="mx ln in ks b gy nc mz l na nb">  // remove GenerateSW plugin<br/>  webpack<strong class="ks io">.</strong><em class="nd">plugins</em><strong class="ks io">.</strong>pop();</span><span id="5b50" class="mx ln in ks b gy nc mz l na nb">  const overridenConf <strong class="ks io">=</strong> override(<br/>    addWebpackPlugin(<br/>      <strong class="ks io">new</strong> InjectManifest({<br/>        swSrc: './src/service-worker.js',<br/>        globDirectory: webpack<strong class="ks io">.</strong><em class="nd">output</em><strong class="ks io">.</strong><em class="nd">path</em>,<br/>        globPatterns: ['*.{png,ico}'],<br/>      }),<br/>    ),   <br/>  )(webpack, ...args);</span><span id="f857" class="mx ln in ks b gy nc mz l na nb"><strong class="ks io">  return</strong> overridenConf;<br/>};</span></pre><p id="ef2f" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe kp kq kr ks b">globPatterns</code>会将那些没有经过webpack编译的文件添加到<code class="fe kp kq kr ks b">precache-manifest.js</code>中，比如复制到构建文件夹中并且没有经过编译过程的图像和其他一些文件。我想缓存图标和图像，但<code class="fe kp kq kr ks b">globPatterns</code> &amp; <code class="fe kp kq kr ks b">globDirectory</code>是可选的，你可以省略它们。</p><p id="d9bf" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">注意:</strong>即将到来的版本，即<code class="fe kp kq kr ks b">workbox-webpack-plugin</code>的v5，将通过webpack编译过程传递给我们的服务人员，不会创建<code class="fe kp kq kr ks b">precache-manifest.js</code>文件，也不会为workbox添加导入，也不会支持glob属性，但从v4开始，它们受到支持，我们将使用它们。</p><p id="3c26" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">现在打开<code class="fe kp kq kr ks b">index.js</code>，把注销改为注册</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="91b0" class="mx ln in ks b gy my mz l na nb">-- serviceWorker<strong class="ks io">.un</strong>register();<br/>++ serviceWorker<strong class="ks io">.</strong>register();</span></pre><p id="ef2b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">将<code class="fe kp kq kr ks b">package.json</code>中的脚本改为使用<code class="fe kp kq kr ks b">react-app-rewired</code></p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="132b" class="mx ln in ks b gy my mz l na nb"><br/>--   "start": "react-scripts start",<br/>--   "build": "react-scripts build",<br/>--   "test": "react-scripts test",<br/>--   "eject": "react-scripts eject"</span><span id="1240" class="mx ln in ks b gy nc mz l na nb">++   "start": "react-app-rewired start",<br/>++   "build": "react-app-rewired build",<br/>++   "test": "react-app-rewired test",<br/>++   "eject": "react-app-rewired eject"</span></pre><p id="31ef" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">恭喜，您已经设置了<code class="fe kp kq kr ks b">create-react-app</code>来使用您的定制服务人员，现在运行<code class="fe kp kq kr ks b">yarn start</code>或<code class="fe kp kq kr ks b">yarn build</code>并查看您的PWA的所有荣耀。👀👀</p></div><div class="ab cl lf lg hr lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ig ih ii ij ik"><h1 id="4900" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">灯塔审计</h1><p id="7151" class="pw-post-body-paragraph jr js in jt b ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk mo km kn ko ig bi translated">为了审计我们的构建，我们将使用<code class="fe kp kq kr ks b">webpack-lighthouse-plugin</code>和<code class="fe kp kq kr ks b">serve</code>。这里我已经在本地安装了<code class="fe kp kq kr ks b">serve</code>，但是如果你已经在全球范围内安装了它，你就不需要这样做了。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="9b84" class="mx ln in ks b gy my mz l na nb">yarn add -D webpack-lighthouse-plugin serve</span><span id="5a4d" class="mx ln in ks b gy nc mz l na nb">or</span><span id="7058" class="mx ln in ks b gy nc mz l na nb">npm install webpack-lighthouse-plugin serve --save-dev</span></pre><p id="858d" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">继续在<code class="fe kp kq kr ks b">package.json</code>中添加以下脚本。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="7d61" class="mx ln in ks b gy my mz l na nb">"serve": "serve ./build",<br/>"build:audit": "export LIGHTHOUSE_AUDIT=true; yarn serve &amp; yarn build; kill -9 $!; kill -9 `lsof -t -i:5000`"</span></pre><p id="d816" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe kp kq kr ks b">build:audit</code>脚本将使用<code class="fe kp kq kr ks b">serve</code>服务于我们的构建，使用lighthouse审计它，并终止服务器(该命令在UNIX/Linux shell中工作，如zsh和bash)。我正在创建<code class="fe kp kq kr ks b">LIGHTHOUSE_AUDIT</code>环境变量来决定是否应该执行审计。</p><p id="d45b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">添加插件<code class="fe kp kq kr ks b">WebpackLighthousePlugin</code>，它只会在我们想要审计我们的构建时使用，否则它会被忽略。</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="6761" class="mx ln in ks b gy my mz l na nb">// config-overrides.js<br/>const { override, addWebpackPlugin } <strong class="ks io">=</strong> require('customize-cra');<br/>const { InjectManifest } <strong class="ks io">=</strong> require('workbox-webpack-plugin');<br/>++ const WebpackLighthousePlugin <strong class="ks io">=</strong> require('webpack-lighthouse-plugin');</span><span id="8f6d" class="mx ln in ks b gy nc mz l na nb">module<strong class="ks io">.</strong>exports <strong class="ks io">=</strong> (<strong class="ks io">webpack</strong>, <strong class="ks io">...args</strong>) =&gt; {</span><span id="3530" class="mx ln in ks b gy nc mz l na nb">  // remove GenerateSW plugin<br/>  webpack<strong class="ks io">.</strong><em class="nd">plugins</em><strong class="ks io">.</strong>pop();</span><span id="5ae3" class="mx ln in ks b gy nc mz l na nb">  const overridenConf <strong class="ks io">=</strong> override(<br/>    addWebpackPlugin(<br/>      <strong class="ks io">new</strong> InjectManifest({<br/>        swSrc: './src/service-worker.js',<br/>        globDirectory: webpack<strong class="ks io">.</strong><em class="nd">output</em><strong class="ks io">.</strong><em class="nd">path</em>,<br/>        globPatterns: ['*.{png,ico}'],<br/>      }),<br/>    ),<br/>++    process<strong class="ks io">.</strong>env<strong class="ks io">.</strong>LIGHTHOUSE_AUDIT <strong class="ks io">===</strong> 'true' ? addWebpackPlugin(<br/>++      <strong class="ks io">new</strong> WebpackLighthousePlugin({<br/>++       url: 'http://localhost:5000'<br/>++      }),<br/>++    ) : null,<br/>  )(webpack, ...args);</span><span id="9753" class="mx ln in ks b gy nc mz l na nb"><strong class="ks io">  return</strong> overridenConf;<br/>};</span></pre><p id="11ff" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">现在运行<code class="fe kp kq kr ks b">yarn build:audit</code>或<code class="fe kp kq kr ks b">npm run build:audit</code>构建您的react应用程序，并使用Lighthouse审计构建。它将记录审计数据，并生成项目根的审计报告，您可以通过将这些报告放入您的<code class="fe kp kq kr ks b">.gitignore</code>来忽略它们</p><pre class="mp mq mr ms gt mt ks mu mv aw mw bi"><span id="57b8" class="mx ln in ks b gy my mz l na nb"># .gitignore<br/>...<br/>...</span><span id="d4fb" class="mx ln in ks b gy nc mz l na nb">*.report.html</span><span id="8ba5" class="mx ln in ks b gy nc mz l na nb">...<br/>...</span></pre><p id="60c1" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">你可以按照这些步骤使用你自己的create-react-app服务人员，或者只是简单地复制我在本文开头链接的样板文件。</p><p id="e9ff" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">谢了。</p><h2 id="939f" class="mx ln in bd lo ne nf dn ls ng nh dp lw kc ni nj ma kg nk nl me kk nm nn mi no bi translated">用简单英语写的JavaScript的注释</h2><p id="6b31" class="pw-post-body-paragraph jr js in jt b ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk mo km kn ko ig bi translated">我们已经推出了三种新的出版物！请关注我们的新出版物:<a class="ae np" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="jt io">AI in Plain English</strong></a><a class="ae np" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="jt io">UX in Plain English</strong></a><a class="ae np" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="jt io">Python in Plain English</strong></a><strong class="jt io"/>—谢谢，继续学习！</p><p id="ac6b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们也一直有兴趣帮助推广高质量的内容。如果您有一篇文章想要提交给我们的任何出版物，请发送电子邮件至<a class="ae np" href="mailto:submissions@plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jt io">submissions @ plain English . io</strong></a><strong class="jt io"/>，使用您的Medium用户名，我们会将您添加为作者。另外，请让我们知道您想加入哪个/哪些出版物。</p></div></div>    
</body>
</html>