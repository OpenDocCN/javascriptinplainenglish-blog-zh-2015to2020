<html>
<head>
<title>Image manipulation with Sharp, AWS Lambda functions &amp; Layers, and Claudia.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Sharp、AWS Lambda函数和图层以及Claudia.js进行图像处理</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/image-manipulation-with-sharp-aws-lambda-functions-layers-and-claudia-js-876d3dadcdb4?source=collection_archive---------3-----------------------#2020-05-17">https://javascript.plainenglish.io/image-manipulation-with-sharp-aws-lambda-functions-layers-and-claudia-js-876d3dadcdb4?source=collection_archive---------3-----------------------#2020-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jn jo jp jq gh gi paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="gh gi gj"><img src="../Images/2d32b6761f4b9f80231556945fa709c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aUjH_b4sbW86J0A0bhMbAg.jpeg"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk">No manipulation here…</figcaption></figure><p id="1d3c" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">一段时间以来，我一直希望能够利用夏普(<a class="ae kz" href="https://github.com/lovell/sharp/" rel="noopener ugc nofollow" target="_blank">https://github.com/lovell/sharp/</a>)提供的强大而快速的图像处理功能，但我一直在努力寻找让它发挥作用的方法。我遇到了各种挑战，例如:</p><ol class=""><li id="8787" class="la lb iq kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">sharp的二进制文件依赖于平台。这意味着在Mac上开发并部署到Lambda(一个Linux容器)意味着用于Sharp的二进制文件是不兼容的</li><li id="5187" class="la lb iq kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">Sharp相当大，所以将它包含在lambda函数包中确实是不可行的，因此，它应该在自己的层<br/> <strong class="kd ir"> <em class="lo">编辑:自从我写这篇文章以来，我已经了解了很多关于lambda的知识，该层仍然在每次冷启动时被复制到运行时中，因此分层对冷启动时间没有帮助。事实上，我已经不再使用夏普了。我倾向于选择吉姆的ES版本</em> </strong></li><li id="4151" class="la lb iq kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">如何在Mac环境中使用正确的二进制文件创建一个层</li><li id="d896" class="la lb iq kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">如何从lambda内部引用sharp</li></ol><p id="d493" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我试着按照说明<a class="ae kz" href="https://github.com/lovell/sharp/issues/1702#issuecomment-499331245" rel="noopener ugc nofollow" target="_blank">这里</a>做，但是它们是针对一个旧版本的，我只是不能让它这样做——提到的文件不再在sharp包中。它还要求你使用Docker来创建文件并打包，对我来说这似乎是一种冗长、工具繁重的方法。</p><p id="d6f0" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我也将<a class="ae kz" href="https://claudiajs.com/" rel="noopener ugc nofollow" target="_blank"> Claudia.js </a>用于Lambda和API网关部署，这虽然极大地简化了部署过程，但当试图让所有这些不同的部分很好地一起工作时，确实增加了额外的复杂性。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="2d1c" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">让一切运转起来</h1><h2 id="d9a0" class="mu lx iq bd ly mv mw dn mc mx my dp mg km mz na mk kq nb nc mo ku nd ne ms nf bi translated">为Sharp创建图层</h2><p id="20dc" class="pw-post-body-paragraph kb kc iq kd b ke ng kg kh ki nh kk kl km ni ko kp kq nj ks kt ku nk kw kx ky ij bi translated">首先，您需要为Sharp创建一个包含正确二进制文件的项目。我是这样做的:</p><p id="2ce8" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">创建一个新文件夹并运行:</p><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="580c" class="mu lx iq nq b gy nu nv l nw nx">npm init -y</span></pre><p id="f2d8" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">(如果您想覆盖任何初始化默认值，它不必有-y标志)</p><p id="0660" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">然后你需要用Linux二进制安装Sharp:</p><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="47c3" class="mu lx iq nq b gy nu nv l nw nx">npm install --arch=x64 --platform=linux sharp</span></pre><p id="271e" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">接下来选择您的文件夹的内容，这将是一个node_modules文件夹、package.json和package-lock.json，并将它们压缩。</p><p id="4d22" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">不幸的是，还没有一种方法可以使用Claudia.js创建图层(尽管您可以引用lambdas的图层(我们很快就会谈到)</p><p id="aa46" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">因此，我们将使用控制台创建它。登录你的AWS账户，搜索Lambda并选择图层。</p><figure class="nl nm nn no gt jq gh gi paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="gh gi ny"><img src="../Images/ec6a744eebd710089217af11e385a8e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TUrLzB1R5THnydYWrKSkrw.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk">Create a new layer</figcaption></figure><p id="503b" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">给你的图层一个信息丰富的名称和描述，让我们称之为夏普。</p><p id="83c4" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">选择上传一个. zip文件，并选择您刚刚压缩的文件。兼容的运行时，我选择了node.js 10.x和12.x</p><p id="3298" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">创建完成后，您会看到一个确认屏幕，其中包含图层的ARN，请记下它</p><figure class="nl nm nn no gt jq gh gi paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="gh gi nz"><img src="../Images/1c492fc065ab9ea99ef67f30e3a7d206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xn6BYrink9wVw8FWja1UOQ.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk">Layer creation confirmation</figcaption></figure><p id="c667" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">ARN的末尾是:1 —每上传一个新版本，这个值就会增加1。</p><h2 id="7a99" class="mu lx iq bd ly mv mw dn mc mx my dp mg km mz na mk kq nb nc mo ku nd ne ms nf bi translated">利用你的新尖层</h2><p id="de69" class="pw-post-body-paragraph kb kc iq kd b ke ng kg kh ki nh kk kl km ni ko kp kq nj ks kt ku nk kw kx ky ij bi translated">Claudia.js在部署之前执行一些简便的验证，包括确保存在任何依赖关系。因为这个函数将从一个层而不是本地安装的依赖关系中加载，所以你需要延迟加载sharp来规避依赖关系检查。</p><p id="82ed" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">例如:</p><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="025c" class="mu lx iq nq b gy nu nv l nw nx"><em class="lo">export</em> <em class="lo">async</em> function <em class="lo">addPhoto</em>(contents) {</span><span id="af58" class="mu lx iq nq b gy oa nv l nw nx">  const<em class="lo"> sharp </em>=<em class="lo"> require</em>('/opt/node_modules/sharp');<br/>  const<em class="lo"> smallImg </em>=<em class="lo"> await sharp</em>(<em class="lo">contents</em>)<br/>    <em class="lo">.resize</em>({ width: 200 })<br/>    <em class="lo">.toBuffer</em>();<br/>}</span></pre><p id="7c24" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">这里发生的事情是，sharp依赖项是在使用它的函数中按需加载的。检索它的位置是/opt中的node_modules/sharp文件夹，这是AWS Lambda环境在引用层中复制的位置。</p><p id="1c65" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如果有更好的方法来实现这一点，我很乐意在评论中听到。</p><h2 id="2d86" class="mu lx iq bd ly mv mw dn mc mx my dp mg km mz na mk kq nb nc mo ku nd ne ms nf bi translated">部署</h2><p id="fcd1" class="pw-post-body-paragraph kb kc iq kd b ke ng kg kh ki nh kk kl km ni ko kp kq nj ks kt ku nk kw kx ky ij bi translated">用Claudia.js部署lambda函数代码非常简单:</p><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="932d" class="mu lx iq nq b gy nu nv l nw nx">claudia create \<br/>--description API for OMW Photos Backend \<br/>--config deploy/dev/photos-dev \<br/>--region eu-west-2 \<br/>--handler build/functions/photos.handler \<br/>--layers arn:aws:lambda:eu-west-2:XXXXXXXXX:layer:sharp:1 \<br/>--name photos-dev \<br/>--runtime nodejs12.x \<br/>--role arn:aws:iam::XXXXXXXXX:role/lambda-some-role</span></pre><p id="01e4" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">注意这里有一个图层参数，它从我们的图层中获取ARN(如果需要一个以上的图层，这可以是一个逗号分隔的ARNs数组)</p><p id="4f8e" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">这将创建你的lambda引用夏普层和你的图像处理代码应该像一个梦一样工作。</p><p id="fa1a" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我已经在网上看到了使用无服务器框架的各种方法，但由于我们使用Claudia.js并在MAC上开发，我想我应该写下我所做的，以防它能节省一些时间。</p><p id="7887" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">任何改进的想法或建议都可以在评论中看到。</p><p id="c4b2" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">感谢阅读！</p><h2 id="c756" class="mu lx iq bd ly mv mw dn mc mx my dp mg km mz na mk kq nb nc mo ku nd ne ms nf bi translated"><strong class="ak">简明英语笔记</strong></h2><p id="9372" class="pw-post-body-paragraph kb kc iq kd b ke ng kg kh ki nh kk kl km ni ko kp kq nj ks kt ku nk kw kx ky ij bi translated">你知道我们推出了一个YouTube频道吗？我们制作的每个视频都旨在教给你一些新的东西。点击<a class="ae kz" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kd ir">点击</strong> </a>查看我们，并确保订阅该频道😎</p></div></div>    
</body>
</html>