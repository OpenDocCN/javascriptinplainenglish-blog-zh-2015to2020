<html>
<head>
<title>Using Sharp in Node.js to Output, Resize and Crop Images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js中使用Sharp来输出、调整大小和裁剪图像</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/using-sharp-in-nodejs-to-output-resize-and-crop-images-on-the-fly-f8b150989760?source=collection_archive---------3-----------------------#2020-11-04">https://javascript.plainenglish.io/using-sharp-in-nodejs-to-output-resize-and-crop-images-on-the-fly-f8b150989760?source=collection_archive---------3-----------------------#2020-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/2c3c998f702b9c342cf47cfa5dc90508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RlpNHDySbRqIsfaacICLZA.png"/></div></figure><p id="6bd1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是开发人员梦寐以求的工具。</p><p id="3cfc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我正在努力争取一个完美的Google PageSpeed分数(查看我的文章'<a class="ae ks" href="https://stuartcosten.medium.com/how-to-get-over-90-on-google-pagespeed-insights-a85255ac9a05" rel="noopener">如何在Google Pagespeed Insights上得到90分</a>'以找出原因)，在点击Lighthouse run report按钮之前，我知道我必须做一些事情来加载我的图像而不影响我的分数。</p><p id="70d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我想实现两件事:首先，明显的，懒惰的加载，但另一个更好奇，我希望我的图像是webp。</p><p id="0a82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于那些不知道谷歌图像格式的人，这里有一段来自<a class="ae ks" href="https://developers.google.com/speed/webp" rel="noopener ugc nofollow" target="_blank">网页</a>的片段，比我能解释的更好:</p><blockquote class="kt ku kv"><p id="8ed5" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">WebP是一种现代图像格式，为网络上的图像提供卓越的无损和有损压缩。使用WebP，网站管理员和web开发人员可以创建更小、更丰富的图像，使web速度更快。</p></blockquote><p id="8873" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Webp图像可以比PNG图像小26%,所以将这种奇特的新图像格式与延迟加载结合起来，就性能而言，我感觉自己是赢家，可以利用这两者来实现。</p><p id="af60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一次使用NodeJs构建我的网站时，我不知道我在使用什么工具来实现我的Pagespeed性能梦想。</p><p id="4933" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我习惯于用PHP创建网站，所以我知道有一些功能可以输出webp格式的图像，通常需要在服务器上制作一个副本，然后通过一些。htaccess magicery。</p><p id="7c0a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我开始在谷歌上搜索“将图像输出为webp NodeJs ”,不断出现的一个是<a class="ae ks" href="https://www.npmjs.com/package/sharp" rel="noopener ugc nofollow" target="_blank">夏普</a>。</p><p id="49ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Sharp是一个NodeJs包，可以将各种尺寸的图像转换成各种尺寸的'<em class="kw">网页友好的JPEG、PNG和WebP图像。</em></p><p id="ec98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在想‘太好了，这正是我需要的！’</p><p id="44eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但结果是<em class="kw">所以</em>多了。</p><p id="1f85" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Sharp可以非常快速地转换图像，并声称是最快的工具，但令人难以置信的是，它可以快速转换图像，速度快如闪电。</p><p id="a681" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">这是什么意思？</strong></p><p id="d934" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">服务器上不再有不同大小或类型的复制图像。</p><p id="a927" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你所需要的只是一张图片，剩下的由夏普来做。</p><p id="8e86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">但还有更多！</strong></p><p id="fe75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">夏普不仅可以将您的图像转换成不同的大小、质量和格式。它还可以像CSS<em class="kw">background-size:cover</em>一样为你裁剪图片。</p><p id="04a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将大大减少我不得不使用css的工作量。</p><p id="e29b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，我做了什么来让它工作呢？</p><p id="3a7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，我创建了一个路径，它接受图像的名称，以及大小、裁剪和类型等变量。这给了我很大的力量来建立我的网站，因为把一张图片放入一个空间不是问题。</p><p id="553d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，为不支持webp的浏览器提供的带有png回退的html:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0a8f" class="lj lk iq lf b gy ll lm l ln lo">&lt;picture&gt;<br/> &lt;source type=”image/webp” srcset=”/site/[image_name].png?format=webp&amp;width=350&amp;height=200&amp;crop=cover&amp;quality=100"&gt;<br/> &lt;source type=”image/png” srcset=”/site/[image_name].png?format=png&amp;width=350&amp;height=200&amp;crop=cover&amp;quality=80"&gt; <br/> &lt;img src=”/site/[image_name].png?format=jpg&amp;width=350&amp;height=200&amp;crop=cover&amp;quality=10"&gt;<br/> &lt;/picture&gt;</span></pre><p id="059c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如你所看到的，图片的URL包含了生成3种图片类型的所有参数。</p><p id="5d5e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面的例子显示了PNG，但是你可以将任何类型传入其中，它将被转换成URL中声明的任何格式。</p><p id="12eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在NodeJs部分:</p><p id="cdd1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kw">安装夏普包… </em></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="e3a2" class="lj lk iq lf b gy ll lm l ln lo">npm install sharp</span></pre><p id="cf40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kw">用这个代码设置路线… </em></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="888a" class="lj lk iq lf b gy ll lm l ln lo">const express = require(“express”);<br/>const router = express.Router();<br/>const fs = require(“fs”);<br/>const Sharp = require(‘sharp’);</span><span id="1eb2" class="lj lk iq lf b gy lp lm l ln lo">router.get(‘/:imageName’, (req, res, next) =&gt; {</span><span id="ed53" class="lj lk iq lf b gy lp lm l ln lo">//set image caches<br/>res.set(‘Cache-Control’, ‘public, max-age=31557600’);</span><span id="a513" class="lj lk iq lf b gy lp lm l ln lo">//get the original image path<br/>var imagePath = “./public/images/” + req._parsedOriginalUrl.pathname;</span><span id="3d96" class="lj lk iq lf b gy lp lm l ln lo">//check if it has a format, if not choose webp<br/>const format = req.query.format ? req.query.format : “webp”;</span><span id="b957" class="lj lk iq lf b gy lp lm l ln lo">//ignore this line :-) wordpress throwback!<br/>imagePath = imagePath.replace(“-scaled”, “”);</span><span id="fb18" class="lj lk iq lf b gy lp lm l ln lo">//if it cant find an image show the image not found image<br/>if (!fs.existsSync(imagePath)) {<br/> imagePath = “./public/images/image-not-found.png”;<br/>}</span><span id="83ba" class="lj lk iq lf b gy lp lm l ln lo">//get the variables from the url<br/>const width = req.query.width ? parseInt(req.query.width) : 500;<br/>const height = req.query.height ? parseInt(req.query.height) : 400;<br/>const crop = req.query.crop ? req.query.crop : “cover”;<br/>const quality = req.query.quality ? req.query.quality :100;</span><span id="df58" class="lj lk iq lf b gy lp lm l ln lo">//create the stream — so basically read the path<br/>const stream = fs.createReadStream(imagePath);</span><span id="35e6" class="lj lk iq lf b gy lp lm l ln lo">//transform the image based on our variable, then output using the quality</span><span id="1bcb" class="lj lk iq lf b gy lp lm l ln lo">const transform = Sharp().resize(width, height, {<br/>  fit: crop<br/>}).toFormat(format, {<br/>  quality: parseInt(quality)<br/>});</span><span id="b6b3" class="lj lk iq lf b gy lp lm l ln lo">//make sure the content type is set for the correct format.<br/>res.set(‘Content-Type’, `image/${format}`);</span><span id="a4ec" class="lj lk iq lf b gy lp lm l ln lo">//then output the image<br/>stream.pipe(transform).on(‘error’, (e) =&gt; {</span><span id="3fe2" class="lj lk iq lf b gy lp lm l ln lo">}).pipe(res);</span><span id="ab09" class="lj lk iq lf b gy lp lm l ln lo">return stream;</span><span id="3148" class="lj lk iq lf b gy lp lm l ln lo">});</span><span id="9776" class="lj lk iq lf b gy lp lm l ln lo">module.exports = router;</span></pre><p id="52c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这就是全部了！</p><p id="7138" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">感谢您阅读我的教程，希望这将有助于您追求最小的服务器空间使用和一个真正优雅的方式输出图像到您的网站上使用NodeJs和夏普。</p></div></div>    
</body>
</html>