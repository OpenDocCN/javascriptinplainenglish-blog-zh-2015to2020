<html>
<head>
<title>Use Playwright To Inject Data Into Any Web Page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用剧作家注入数据到任何网页</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-playwright-to-inject-shortcut-keys-into-any-web-page-for-example-to-download-all-images-59195cf557a5?source=collection_archive---------6-----------------------#2020-12-24">https://javascript.plainenglish.io/use-playwright-to-inject-shortcut-keys-into-any-web-page-for-example-to-download-all-images-59195cf557a5?source=collection_archive---------6-----------------------#2020-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="70f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向web应用程序或网站添加快捷键组合会非常强大。当快捷键组合被激活时，事情就会发生。您在web应用程序已经提供的基础上定义的东西。在这篇文章中，我描述了我如何使用剧作家注入一个快捷组合键到一个网站。这个热键(只需按ctrl+b即可激活)运行一个功能，将当前浏览器上下文中的所有图像下载到本地文件系统。所执行的函数是一个节点(JS)函数，它一方面可以访问完整的浏览器上下文(包括DOM、JavaScript上下文、本地存储、cookies等),另一方面可以处理所有的节点和NPM。一个非常强大的组合。</p><p id="0762" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章只是一个例子，告诉你如何丰富你的SaaS网络应用、博客、云平台和任何你在浏览器中运行的东西的功能。通过使用剧作家运行浏览器，您可以获得正常的浏览器功能，以及通过剧作家提供的包装器和桥的节点世界。我在之前的一篇文章中介绍了剧作家，如果你还不知道剧作家，我强烈建议你读一下那篇文章。</p><p id="d266" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之:剧作家是一个开源软件库，它在machina中给了我们一个<em class="km">deus——</em>一个机器人在我们的浏览器中执行电源操作。这带来了从自动化测试到战术集成和RPA(机器人流程自动化)以及从deeplink书签、屏幕抓取、web应用健康监控(smoketests)和定制web应用的机会。剧作家是一个相当新的(2020)，开源的，基于JavaScript的，用于端到端测试的跨浏览器自动化库。</p><h1 id="fef6" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">如何向第三方Web应用程序添加快捷键</h1><p id="2709" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">您可能想知道我们如何扩展现有的网站或web应用程序——尤其是当它不是我们自己的时候。我们所做的是将网站或web应用程序加载到嵌入式浏览器中，我们使用剧作家库从节点应用程序运行该浏览器。这允许我们用自己的应用程序逻辑包装浏览器。在这个逻辑中，我们可以操作当前加载的页面的DOM和JavaScript上下文。</p><p id="7aef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，函数<em class="km"> handleShortCutKey </em>被注入到页面中。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="54ed" class="lz ko iq lv b gy ma mb l mc md">// create a shortcut key (ctrl + b) that triggers the JS function to download all images</span><span id="71af" class="lz ko iq lv b gy me mb l mc md">const shortCutJS  = `async function handleShortCutKey(e) { <br/>  if ('KeyB'==e.code &amp;&amp; e.ctrlKey) { // ctrl + b<br/>  const result = await window.imageDownloadFunction() ;  // invoke the Node function that was exposed to the browser context<br/>  }<br/>}</span><span id="1ae2" class="lz ko iq lv b gy me mb l mc md">document.addEventListener('keyup', handleShortCutKey);</span><span id="04f6" class="lz ko iq lv b gy me mb l mc md">await page.addScriptTag({ content: shortCutJS })</span></pre><p id="8892" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该函数被设置为key up事件的事件监听器。在handleShortCutKey中，我们测试快捷键组合ctrl+b。如果该键已被激活，该函数将调用名为<em class="km"> imageDownloadFunction </em>的函数。</p><figure class="lq lr ls lt gt mg gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/239d96d17e7df6dfdff13ba466b7c991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*bl6pwPFR9s6XrhPS.png"/></div></figure><p id="e2e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个功能不是第三方web应用程序的一部分。它也不真正存在于浏览器环境中。该函数是节点应用程序中启动浏览器和加载web应用程序的函数的占位符。使用语句</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="4277" class="lz ko iq lv b gy ma mb l mc md">await context.exposeBinding('imageDownloadFunction', allImageDownloader)</span></pre><p id="2511" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">节点应用程序中的功能<em class="km"> allImageDownloader </em>已经暴露在浏览器<em class="km">窗口</em>对象上，可以从浏览器上下文中调用该功能；这个代理的名字是<em class="km"> imageDownloadFunction </em>。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="b4f4" class="lz ko iq lv b gy ma mb l mc md">const { chromium } = require('playwright');<br/>const fs = require("fs");<br/>const request = require('request')</span><span id="3b55" class="lz ko iq lv b gy me mb l mc md">const URL = "https://www.amis.nl/"<br/>const IMAGE_PATH = "./images/"</span><span id="d337" class="lz ko iq lv b gy me mb l mc md">var streamImageFromURL = function (imageURL, imageFilename) {<br/>  request(imageURL).pipe(fs.createWriteStream(`${IMAGE_PATH}${imageFilename}`));<br/>}</span><span id="6b7e" class="lz ko iq lv b gy me mb l mc md">const allImageDownloader = async (source) =&gt; {<br/>// using the page object in source.page, get all img elements and return a collection of image objects to be processed in the Node context<br/>const images = await source.page.$$eval("img", (images) =&gt;<br/>images.map((image) =&gt; { return {src: image.src, alt: image.alt, width:image.clientWidth, height:image.clientHeight}})<br/>)</span><span id="dba8" class="lz ko iq lv b gy me mb l mc md">// for each image of substantial size - determine the name of the image file and invoke the function streamImageFromURL to download the image and save it locally<br/>    images.forEach(image =&gt; { if (image.width * image.height &gt; 2500) {<br/>    const startIndex = image.src.lastIndexOf("/") + 1 // do not include /<br/>    const endIndex = image.src.indexOf("?")&gt; -1?  image.src.indexOf("?"):500<br/>    const imageFilename = image.src.substring(startIndex,endIndex)<br/>    console.log(`download ${image.src} as ${imageFilename}`)<br/>    streamImageFromURL(image.src, imageFilename);<br/>  }<br/>  });<br/>  return images.length<br/>}</span><span id="84d5" class="lz ko iq lv b gy me mb l mc md">(async () =&gt; {<br/>  const browser = await chromium.launch({ headless: false })<br/>  const context = await browser.newContext()<br/>  // expose a Node function as binding to the page (to be invoked from the function)</span><span id="05a3" class="lz ko iq lv b gy me mb l mc md">  await context.exposeBinding('imageDownloadFunction', allImageDownloader)<br/>  const page = await context.newPage();<br/>  await page.goto(URL);</span></pre><p id="7383" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图显示了完整的设置。handleShortCutKey函数位于浏览器内部，添加到web应用程序中。当用户激活ctrl+b时调用该函数。通过到节点/剧作家上下文的桥，该函数调用节点函数allImageDownloader。这个函数检索网页中所有图像元素的列表——使用剧作家<code class="fe mj mk ml lv b">page.$$eval</code>函数。然后，它检索所有这些图像的内容，并将其写入本地文件系统。</p><figure class="lq lr ls lt gt mg gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/62120acd06c559ef6e04b049505c8232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*Bmo57y18RzhPpufN.png"/></div></figure><p id="8cce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成果:任何web应用程序或网站都可以在嵌入式浏览器中加载。自动地，功能和快捷键组合被设置在web应用程序内部。当用户按ctrl+b时，所有图像都被下载。</p><p id="c1fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，下载所有图像只是任何快捷键触发功能可以做的一个例子。你可以用同样的方式为所有类型的网站添加各种动作的功能。从而创建功能更多、更符合您需求的网站和web应用程序。</p><h1 id="2555" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">资源</h1><p id="a6ff" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">我在之前的一篇文章中介绍过剧作家</p><p id="07bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文源代码:<a class="ae kl" href="https://github.com/lucasjellema/playwright-scenarios/tree/main/inject-shortcuts" rel="noopener ugc nofollow" target="_blank">https://github . com/lucasjellema/剧作家-场景/树/主/注入-快捷方式</a></p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="bcfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">原载于2020年12月24日</em><a class="ae kl" href="https://technology.amis.nl/2020/12/24/use-playwright-to-inject-shortcut-keys-into-any-web-page-for-example-to-download-all-images/" rel="noopener ugc nofollow" target="_blank"><em class="km">https://technology . amis . nl</em></a><em class="km">。</em></p></div></div>    
</body>
</html>