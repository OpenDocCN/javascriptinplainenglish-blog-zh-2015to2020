<html>
<head>
<title>Firebase + Nuxt, Role Based Authentication &amp; Authorization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firebase + Nuxt，基于角色的认证和授权</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/firebase-nuxt-role-based-authentication-authorization-a2eea9a1a586?source=collection_archive---------1-----------------------#2020-10-15">https://javascript.plainenglish.io/firebase-nuxt-role-based-authentication-authorization-a2eea9a1a586?source=collection_archive---------1-----------------------#2020-10-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/1acf7432d9f4c84bddea077dbdb35aff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Ui-OD1VfDBOewgz3Uj-8Q.png"/></div></div></figure><h2 id="fb39" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在本文中，您将学习如何使用<a class="ae kr" href="https://firebase.google.com/docs/auth/admin/custom-claims" rel="noopener ugc nofollow" target="_blank"> Auth自定义声明</a>来设置用户角色，并在创建新的Firebase用户帐户时将用户数据存储到云Firestore。</h2><p id="325a" class="pw-post-body-paragraph ks kt in ku b kv kw kx ky kz la lb lc ke ld le lf ki lg lh li km lj lk ll lm ig bi translated">此外，我将向您展示如何在登录时基于用户角色保护路由。</p><p id="df1b" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">最后，我将向您展示当登录用户拥有管理员权限时，如何获取所有用户帐户，以及如何使用可调用的云函数来更改用户角色。</p><p id="c759" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">这是我们将要创建的3个用户角色:</strong></p><ul class=""><li id="0451" class="ls lt in ku b kv ln kz lo ke lu ki lv km lw lm lx ly lz ma bi translated"><strong class="ku io"> Admin </strong>角色可以访问存储在数据库中的所有用户，并被授予使用安全规则更改用户角色的权限。</li><li id="eb68" class="ls lt in ku b kv mb kz mc ke md ki me km mf lm lx ly lz ma bi translated"><strong class="ku io">客户</strong>角色将有权访问<strong class="ku io">客户</strong>视图，并且它将被设置为默认角色，因为大多数用户将处于该角色下。</li><li id="1ce9" class="ls lt in ku b kv mb kz mc ke md ki me km mf lm lx ly lz ma bi translated"><strong class="ku io">订户</strong>角色将有权访问<strong class="ku io">订户</strong>视图。</li></ul><ol class=""><li id="995d" class="ls lt in ku b kv ln kz lo ke lu ki lv km lw lm mg ly lz ma bi translated"><strong class="ku io">启动并运行Nuxt项目</strong></li></ol><p id="5f3d" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">我已经使用<code class="fe mh mi mj mk b">npx create-nuxt-app &lt;name&gt;</code>创建了一个<a class="ae kr" href="https://github.com/alexkasongo/firebase-nuxt-role-based-auth" rel="noopener ugc nofollow" target="_blank">启动项目</a>，并在src/pages文件夹下创建了六个页面。Nuxt处理所有路由。您可以克隆这个repo并一起编码。根据您的特定用例，您还可以将代码添加到现有项目中。</p><blockquote class="ml mm mn"><p id="2b43" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">如果你想在Vue.js应用程序中实现它，请随意在这里克隆代码的Vue版本<a class="ae kr" href="https://github.com/alexkasongo/firebase-vue-role-based-auth" rel="noopener ugc nofollow" target="_blank"/></p></blockquote><p id="2ea1" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 2。安装firebase并创建一个Firebase用户帐户</strong></p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="c2a1" class="jv jw in mk b gy na nb l nc nd">npm install firebase</span></pre><p id="cd22" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">在nuxt.config.js内的插件数组中注册firebase.js</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="f1ad" class="jv jw in mk b gy na nb l nc nd">// nuxt.config.js<br/>Plugins = [<br/>  '~/plugins/firebase.js',<br/>],</span></pre><p id="8c47" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">继续在Firebase控制台上创建一个项目。在你的Nuxt应用程序中，在<strong class="ku io"> src/plugins </strong>中创建一个名为<strong class="ku io"> firebase.js </strong>的文件，在这个文件中包含你的firebase初始化代码。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="733b" class="jv jw in mk b gy na nb l nc nd">// firebase.js<br/><em class="mo">import</em> "firebase/auth";<br/><em class="mo">import</em> "firebase/firestore";</span><span id="a74b" class="jv jw in mk b gy ne nb l nc nd">// Your web app's Firebase configuration<br/>var firebaseConfig = {<br/>  apiKey: "**************",<br/>  authDomain: "**************",<br/>  databaseURL: "**************",<br/>  projectId: "**************",<br/>  storageBucket: "",<br/>  messagingSenderId: "**************",<br/>  appId: "**************",<br/>  measurementId: "**************"<br/>};<br/>// Initialize Firebase<br/>firebase.initializeApp(firebaseConfig);</span></pre><p id="6b58" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 3。更新Default.vue </strong></p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="c0c3" class="jv jw in mk b gy na nb l nc nd">// default.vue<br/>&lt;template&gt;<br/>  &lt;div&gt;<br/>    &lt;nav class="navbar navbar-expand-lg navbar-light bg-light"&gt;<br/>      &lt;a class="navbar-brand" href="#"&gt;Navbar&lt;/a&gt;<br/>      &lt;button<br/>        class="navbar-toggler"<br/>        type="button"<br/>        data-toggle="collapse"<br/>        data-target="#navbarSupportedContent"<br/>        aria-controls="navbarSupportedContent"<br/>        aria-expanded="false"<br/>        aria-label="Toggle navigation"<br/>      &gt;<br/>        &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;<br/>      &lt;/button&gt;<br/><br/>      &lt;div class="collapse navbar-collapse" id="navbarSupportedContent"&gt;<br/>        &lt;ul class="navbar-nav mr-auto"&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;nuxt-link class="nav-link" to="/login"&gt;Login&lt;/nuxt-link&gt;<br/>          &lt;/li&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;nuxt-link class="nav-link" to="/register-customer"<br/>              &gt;Register Customer&lt;/nuxt-link<br/>            &gt;<br/>          &lt;/li&gt;<br/>          &lt;li class="nav-item"&gt;<br/>            &lt;nuxt-link class="nav-link" to="/register-admin"<br/>              &gt;Register Admin&lt;/nuxt-link<br/>            &gt;<br/>          &lt;/li&gt;<br/>        &lt;/ul&gt;<br/>      &lt;/div&gt;<br/>    &lt;/nav&gt;<br/>    &lt;div class="container mt-5"&gt;<br/>      &lt;Nuxt /&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;<br/><br/>&lt;style&gt;<br/>html {<br/>  font-family: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI",<br/>    Roboto, "Helvetica Neue", Arial, sans-serif;<br/>  font-size: 16px;<br/>  word-spacing: 1px;<br/>  -ms-text-size-adjust: 100%;<br/>  -webkit-text-size-adjust: 100%;<br/>  -moz-osx-font-smoothing: grayscale;<br/>  -webkit-font-smoothing: antialiased;<br/>  box-sizing: border-box;<br/>}<br/><br/>*,<br/>*::before,<br/>*::after {<br/>  box-sizing: border-box;<br/>  margin: 0;<br/>}<br/><br/>.button--green {<br/>  display: inline-block;<br/>  border-radius: 4px;<br/>  border: 1px solid #3b8070;<br/>  color: #3b8070;<br/>  text-decoration: none;<br/>  padding: 10px 30px;<br/>}<br/><br/>.button--green:hover {<br/>  color: #fff;<br/>  background-color: #3b8070;<br/>}<br/><br/>.button--grey {<br/>  display: inline-block;<br/>  border-radius: 4px;<br/>  border: 1px solid #35495e;<br/>  color: #35495e;<br/>  text-decoration: none;<br/>  padding: 10px 30px;<br/>  margin-left: 15px;<br/>}<br/><br/>.button--grey:hover {<br/>  color: #fff;<br/>  background-color: #35495e;<br/>}<br/>&lt;/style&gt;</span></pre><p id="0e2a" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 3。注册客户</strong></p><p id="4b43" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让我们创建一个注册表单。我用<a class="ae kr" href="https://getbootstrap.com/docs/4.5/getting-started/introduction/" rel="noopener ugc nofollow" target="_blank"> Bootstrap CDN </a>但是可以随意用你最喜欢的。用户数据将存储在角色集合下的云Firestore中。这样，当您拥有管理员权限时，就可以获得所有的用户信息。</p><blockquote class="ml mm mn"><p id="d466" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">src/页面/注册-客户</p></blockquote><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="e8a4" class="jv jw in mk b gy na nb l nc nd">// src/pages/register-customer</span><span id="71c5" class="jv jw in mk b gy ne nb l nc nd">&lt;template&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;div class="col-sm-4 off-set"&gt;<br/>      &lt;form @submit.prevent="onSubmit"&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputEmail1"&gt;Email address&lt;/label&gt;<br/>          &lt;input<br/>            type="email"<br/>            class="form-control"<br/>            placeholder="Enter email"<br/>            v-model="email"<br/>          /&gt;<br/>        &lt;/div&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputPassword1"&gt;Password&lt;/label&gt;<br/>          &lt;input<br/>            type="password"<br/>            class="form-control"<br/>            placeholder="Password"<br/>            v-model="password"<br/>          /&gt;<br/>        &lt;/div&gt;<br/>        &lt;button type="submit" class="btn btn-primary"&gt;Register Customer&lt;/button&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import * as firebase from "firebase/app";<br/>import "firebase/auth";<br/><br/>export default {<br/>  name: "RegisterCustomer",<br/>  data: () =&gt; ({<br/>    email: "",<br/>    password: "",<br/>  }),<br/>  methods: {<br/>    async onSubmit() {<br/>      try {<br/>        var { user } = await firebase<br/>          .auth()<br/>          .createUserWithEmailAndPassword(this.email, this.password);<br/>        // signout<br/>        firebase<br/>          .auth()<br/>          .signOut()<br/>          .then((user) =&gt; {<br/>            this.$router.push("/login");<br/>          });<br/>      } catch (error) {<br/>        console.log("🤡", error.message);<br/>      }<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</span></pre><p id="2401" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">当通过授权自定义声明设置用户角色时，它将在注销并重新登录后变得可用。</p><p id="5cfd" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">出于这个原因，我在创建了一个新的用户帐户后，有了下面的注销功能。</p><p id="59e3" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 4。添加Firebase云功能</strong></p><p id="0708" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">4.1 <strong class="ku io">重要:</strong>支持Node.js、10、12版本。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="4e17" class="jv jw in mk b gy na nb l nc nd">npm install -g firebase-tools</span></pre><p id="ab42" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">或者</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="8e3c" class="jv jw in mk b gy na nb l nc nd">sudo npm install -g firebase-tools</span></pre><p id="8f47" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">4.2 <strong class="ku io">重要提示:</strong>更新Firebase CLI和SDK</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="c20a" class="jv jw in mk b gy na nb l nc nd">npm install firebase-functions@latest firebase-admin@latest --save<br/>npm install -g firebase-tools</span></pre><p id="e1ad" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">4.2<strong class="ku io">T9】初始化你的项目</strong></p><p id="c8bc" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">运行<code class="fe mh mi mj mk b">firebase login</code>通过浏览器登录并验证firebase工具。</p><p id="8adc" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">运行<code class="fe mh mi mj mk b">firebase init</code></p><p id="a860" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">对于我们的案例，让我们选择以下内容:</p><p id="aba8" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">您想为此文件夹设置哪些Firebase CLI功能？</strong> <em class="mo">功能</em></p><p id="3088" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">你想用什么语言写云函数？</strong> <em class="mo"> JavaScript </em></p><p id="df6e" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">你想使用ESLint来捕捉可能的bug并加强风格吗？ <em class="mo">是</em></p><p id="3913" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">T22您想现在安装与npm的依赖关系吗？ <em class="mo">是</em></p><p id="df41" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">仅此而已！</p><p id="8bb0" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让<strong class="ku io"> Firebase CLI </strong>做项目脚手架，准备好项目文件。</p><blockquote class="ml mm mn"><p id="341e" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">src/功能</p></blockquote><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/4b1c1e36be868eca7606a33f3a9bc928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*W2n5MhSe32w845q3Pp_CMg.png"/></div></figure><p id="d9b7" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 5。添加管理员授权自定义声明</strong></p><p id="6026" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">如你所知，从客户端设置管理员角色不是一个好主意，所以我将使用Firebase Cloud函数来添加它。</p><p id="2ed9" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">创建新的Firebase用户帐户时，将触发AddUserRole()函数。</p><blockquote class="ml mm mn"><p id="1ae9" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">函数/index.js</p></blockquote><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="8ccf" class="jv jw in mk b gy na nb l nc nd">// functions/index.js<br/>const functions = require('firebase-functions');<br/>const admin = require('firebase-admin')</span><span id="2bca" class="jv jw in mk b gy ne nb l nc nd">admin.initializeApp()</span><span id="58cc" class="jv jw in mk b gy ne nb l nc nd">const db = admin.firestore()</span><span id="6aff" class="jv jw in mk b gy ne nb l nc nd"><em class="mo">// trigger function on new user creation.<br/>// when a new user is created this fucntion is triggered. When triggered a defualt<br/>// data object is pushed to the roles collection, this object contains the user's role status</em></span><span id="57e9" class="jv jw in mk b gy ne nb l nc nd">exports.AddUserRole = functions.auth.user().onCreate(async (authUser) =&gt; {<br/>  if (authUser.email) {<br/>    const customClaims = {<br/>      admin: true,<br/>    };<br/>    try {<br/>      var _ = await admin.auth().setCustomUserClaims(authUser.uid, customClaims)<br/>      return db.collection("roles").doc(authUser.uid).set({<br/>        email: authUser.email,<br/>        role: customClaims<br/>      })<br/>    } catch (error) {<br/>      console.log(error)<br/>    }<br/>  }<br/>});</span></pre><p id="0b96" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">重要提示:</strong>将功能部署到Firebase。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="3f50" class="jv jw in mk b gy na nb l nc nd">firebase deploy --only functions</span></pre><p id="99d7" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 6。注册管理员</strong></p><p id="e07a" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">从客户端设置管理员角色并不是一个好的做法，所以我将使用Firebase Cloud函数来完成这项工作。</p><blockquote class="ml mm mn"><p id="ec5d" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">src/pages/register-admin.vue</p></blockquote><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="c10f" class="jv jw in mk b gy na nb l nc nd">// src/pages/register-admin</span><span id="c700" class="jv jw in mk b gy ne nb l nc nd">&lt;template&gt;<br/>  &lt;div <em class="mo">class</em>="row"<!-- -->&gt;<br/>    &lt;div class="col-sm-4 off-set"&gt;<br/>      &lt;form @submit.prevent="onSubmit"&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputEmail1"&gt;Email address&lt;/label&gt;<br/>          &lt;input<br/>            type="text"<br/>            placeholder="Email"<br/>            v-model="email"<br/>            class="form-control"<br/>            required<br/>          /&gt;<br/>        &lt;/div&gt;</span><span id="72d0" class="jv jw in mk b gy ne nb l nc nd">        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputPassword1"&gt;Password&lt;/label&gt;<br/>          &lt;input<br/>            type="password"<br/>            placeholder="Password"<br/>            v-model="password"<br/>            class="form-control"<br/>            required<br/>          /&gt;<br/>        &lt;/div&gt;</span><span id="0d82" class="jv jw in mk b gy ne nb l nc nd">        &lt;button type="submit" class="btn btn-primary"&gt;Register Admin&lt;/button&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;</span><span id="dbbb" class="jv jw in mk b gy ne nb l nc nd">&lt;script&gt;<br/>import * as firebase from "firebase/app";<br/>import "firebase/auth";<br/>import "firebase/functions";</span><span id="06e4" class="jv jw in mk b gy ne nb l nc nd">export default {<br/>  name: "RegisterAdmin",<br/>  data() {<br/>    return {<br/>      name: "",<br/>      phone: "",<br/>      email: "",<br/>      password: "",<br/>      user: null,<br/>    };<br/>  },<br/>  methods: {<br/>    async onSubmit() {<br/>      let admin = {<br/>        role: {<br/>          admin: true,<br/>        },<br/>      };</span><span id="062f" class="jv jw in mk b gy ne nb l nc nd">      await firebase<br/>        .auth()<br/>        .createUserWithEmailAndPassword(this.email, this.password)<br/>        .then((response) =&gt; {<br/>          if (response) {<br/>            const setAdmin = firebase.functions().httpsCallable("setAdmin");<br/>            const data = { uid: response.user.uid, role: admin.role };<br/>            setAdmin(data)<br/>              .then((result) =&gt; {<br/>                console.log(`index.js - 183 - "🎉"`, result);<br/>              })<br/>              .then(() =&gt; {<br/>                // signout<br/>                firebase<br/>                  .auth()<br/>                  .signOut()<br/>                  .then(() =&gt; {<br/>                    this.$router.push("/login");<br/>                  });<br/>              });<br/>          }<br/>        })<br/>        .catch((error) =&gt; {<br/>          // Handle Errors here.<br/>          console.log("🤡", error.message);<br/>        });<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</span></pre><p id="2566" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">6.1函数/索引. js</p><p id="43eb" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">添加创建新管理员时调用的云函数。这个函数接收一个uid和新的角色数据。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="a21e" class="jv jw in mk b gy na nb l nc nd">// create admin user on signup<br/>exports.setAdmin = functions.https.onCall(async (data, context) =&gt; {<br/><br/>    // if (!context.auth.token.admin) return<br/>    if (!context.auth.token) return<br/><br/>    try {<br/>        var _ = await admin.auth().setCustomUserClaims(data.uid, data.role)<br/><br/>        return db.collection("roles").doc(data.uid).update({<br/>            role: data.role<br/>        })<br/><br/>    } catch (error) {<br/>        console.log('🤡', error)<br/>    }<br/><br/>});</span></pre><p id="c970" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">重要提示:</strong>将功能部署到Firebase。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="ed8e" class="jv jw in mk b gy na nb l nc nd">firebase deploy --only functions</span></pre><p id="f05e" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 7。登录</strong></p><p id="cd7b" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让我们使用在register-admin页面上创建的管理员帐户登录管理员帐户</p><blockquote class="ml mm mn"><p id="05ba" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">src/pages/login.vue</p></blockquote><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="fa13" class="jv jw in mk b gy na nb l nc nd">&lt;template&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;div class="col-sm-4 off-set"&gt;<br/>      &lt;form @submit.prevent="onSubmit"&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputEmail1"&gt;Email address&lt;/label&gt;<br/>          &lt;input<br/>            type="email"<br/>            class="form-control"<br/>            placeholder="Enter email"<br/>            v-model="email"<br/>          /&gt;<br/>        &lt;/div&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="exampleInputPassword1"&gt;Password&lt;/label&gt;<br/>          &lt;input<br/>            type="password"<br/>            class="form-control"<br/>            placeholder="Password"<br/>            v-model="password"<br/>          /&gt;<br/>        &lt;/div&gt;<br/>        &lt;button type="submit" class="btn btn-primary"&gt;Login&lt;/button&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import * as firebase from "firebase/app";<br/>import "firebase/auth";<br/><br/>export default {<br/>  name: "Login",<br/>  data: () =&gt; ({<br/>    email: "",<br/>    password: "",<br/>  }),<br/>  created() {<br/>    firebase.auth().onAuthStateChanged((userAuth) =&gt; {<br/>      if (userAuth) {<br/>        firebase<br/>          .auth()<br/>          .currentUser.getIdTokenResult()<br/>          .then((tokenResult) =&gt; {<br/>            console.log("🍎 ", tokenResult.claims);<br/>          });<br/>      }<br/>    });<br/>  },<br/><br/>  methods: {<br/>    async onSubmit() {<br/>      try {<br/>        const { user } = await firebase<br/>          .auth()<br/>          .signInWithEmailAndPassword(this.email, this.password);<br/>      } catch (error) {<br/>        console.log("🤡", error);<br/>      }<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</span></pre><p id="ead4" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 8.1注册客户</strong></p><p id="563c" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">转到注册客户视图，注册一个新的客户用户。注册成功后，将在云Firestore数据库中创建一个名为“角色”的新集合。</p><p id="eeb3" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 8.2登录客户</strong></p><p id="05e4" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">当您使用已经创建的客户登录时，您应该看到控制台中的自定义声明对象内的客户属性被设置为true</p><p id="ce01" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 8.2注册管理员</strong></p><p id="1e25" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">转到Register Admin视图，注册一个新的管理员用户。注册成功后，将在云Firestore数据库中创建一个名为“角色”的新集合。</p><p id="4a48" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 8.2登录管理员</strong></p><p id="84e6" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">当您使用已经创建的admin登录时，您应该看到控制台中的custom claims对象内的customer属性被设置为true</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/86712edba9389a74a4dcac8be386bf3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3MENkIaYiaDJIBl8J_eqA.png"/></div></div></figure><p id="12b9" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 9。客户视图</strong></p><p id="d32d" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">这个视图有一个简单的标题，用户电子邮件和注销按钮，驱动程序视图是相同的，除了标题文本。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="0880" class="jv jw in mk b gy na nb l nc nd">// src/pages/customer<br/>&lt;template&gt;<br/>  &lt;section&gt;<br/>    &lt;div class="ui middle aligned center aligned grid"&gt;<br/>      &lt;div class="column"&gt;<br/>        &lt;h1&gt;Customer&lt;/h1&gt;<br/>        &lt;p v-if="user"&gt;Customer: {{ user.email }}&lt;/p&gt;<br/>        &lt;button class="btn btn-primary" @click="signout"&gt;Signout&lt;/button&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/section&gt;<br/>&lt;/template&gt;<br/>&lt;script&gt;<br/>import * as firebase from "firebase/app";<br/>import "firebase/auth";</span><span id="e79d" class="jv jw in mk b gy ne nb l nc nd">export default {<br/>  data() {<br/>    return {<br/>      user: null,<br/>    };<br/>  },<br/>  created() {<br/>    var self = this;<br/>    firebase.auth().onAuthStateChanged(function (user) {<br/>      self.user = user;<br/>    });<br/>  },<br/>  methods: {<br/>    signout() {<br/>      firebase<br/>        .auth()<br/>        .signOut()<br/>        .then((user) =&gt; {<br/>          this.$router.push("/login");<br/>        });<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</span></pre><p id="3744" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">您可能想知道，如果我不想让客户或订户看到仪表板，该怎么办？如果我想将用户角色(如客户)更改为订户，反之亦然，该怎么办？</p><p id="1081" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">别担心，我一会儿会讲到的。</p><p id="b486" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 9。授权的授权守卫</strong></p><p id="3030" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让我们在src中创建一个中间件文件夹，并在其中创建一个名为<em class="mo">的文件</em></p><p id="9b93" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">重要:</strong>在nuxt.config.js中注册中间件</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="80b0" class="jv jw in mk b gy na nb l nc nd">// nuxt.config.js<br/>router: {<br/>  middleware: ['authenticated']<br/>},</span></pre><p id="b868" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">在beforeEach方法中，我使用Firebase中的onAuthStateChanged方法检查用户是否登录。</p><p id="169c" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">如果有一个用户，那么获取一个idTokeResult，它包含claims对象，我可以在其中获取在创建新用户帐户时设置的用户角色。</p><p id="df55" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">src/middleware/authenticated . js</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="a148" class="jv jw in mk b gy na nb l nc nd">import * as firebase from 'firebase/app';<br/>import 'firebase/auth';<br/><br/>export default function ({ app, store, route, redirect }) {<br/><br/>    app.router.beforeEach((to, from, next) =&gt; {<br/><br/>  firebase.auth().onAuthStateChanged(userAuth =&gt; {<br/><br/>    if (userAuth) {<br/>      firebase.auth().currentUser.getIdTokenResult()<br/>        .then(function ({<br/>          claims<br/>        }) {<br/><br/>          if (claims.customer) {<br/>            if (to.path !== '/customer')<br/>              return next({<br/>                path: '/customer',<br/>              })<br/>          } else if (claims.admin) {<br/>            if (to.path !== '/admin')<br/>              return next({<br/>                path: '/admin',<br/>              })<br/>          } else if (claims.subscriber) {<br/>            if (to.path !== '/subscriber')<br/>              return next({<br/>                path: '/subscriber',<br/>              })<br/>          }<br/><br/>        })<br/>    } else {<br/>      if (to.matched.some(record =&gt; record.meta.auth)) {<br/>        next({<br/>          path: '/login',<br/>          query: {<br/>            redirect: to.fullPath<br/>          }<br/>        })<br/>      } else {<br/>        next()<br/>      }<br/>    }<br/><br/>  })<br/><br/>  next()<br/><br/>})<br/><br/>}</span></pre><p id="4839" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io"> 11。改变用户角色</strong></p><p id="381a" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让我们在管理员帐户登录时获取所有用户帐户，以便您可以从前端将角色更改为任何用户。</p><p id="4d30" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">管理员用户界面</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="fce3" class="jv jw in mk b gy na nb l nc nd">&lt;template&gt;<br/>  &lt;section&gt;<br/>    &lt;div class="ui middle aligned center aligned grid"&gt;<br/>      &lt;div class="column"&gt;<br/>        &lt;h1&gt;Admin&lt;/h1&gt;<br/>        &lt;p v-if="user"&gt;User: {{ user.email }}&lt;/p&gt;<br/>        &lt;button class="btn btn-primary mb-4" @click="signout"&gt;Signout&lt;/button&gt;<br/>        &lt;table class="table table-hover"&gt;<br/>          &lt;thead&gt;<br/>            &lt;tr&gt;<br/>              &lt;th scope="col"&gt;Email&lt;/th&gt;<br/>              &lt;th scope="col"&gt;Role&lt;/th&gt;<br/>            &lt;/tr&gt;<br/>          &lt;/thead&gt;<br/>          &lt;tbody&gt;<br/>            &lt;tr v-for="user in users" :key="user.id"&gt;<br/>              &lt;td data-label="Name"&gt;{{ user.email }}&lt;/td&gt;<br/>              &lt;td&gt;<br/>                &lt;select @change="changeRole(user.id, $event)"&gt;<br/>                  &lt;option :selected="user.role.subscriber" value="subscriber"&gt;<br/>                    Subscriber<br/>                  &lt;/option&gt;<br/>                  &lt;option :selected="user.role.customer" value="customer"&gt;<br/>                    Customer<br/>                  &lt;/option&gt;<br/>                &lt;/select&gt;<br/>              &lt;/td&gt;<br/>            &lt;/tr&gt;<br/>          &lt;/tbody&gt;<br/>        &lt;/table&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/section&gt;<br/>&lt;/template&gt;<br/>&lt;script&gt;<br/>import * as firebase from "firebase/app";<br/>import "firebase/auth";<br/>import "firebase/functions";<br/><br/>export default {<br/>  name: "Admin",<br/>  data() {<br/>    return {<br/>      users: [],<br/>      user: null,<br/>    };<br/>  },<br/>  created() {<br/>    var self = this;<br/>    firebase.auth().onAuthStateChanged((user) =&gt; {<br/>      self.user = user;<br/>    });<br/>    this.users = [];<br/>    firebase<br/>      .firestore()<br/>      .collection("roles")<br/>      .get()<br/>      .then((snap) =&gt; {<br/>        snap.forEach((doc) =&gt; {<br/>          var user = doc.data();<br/>          user.id = doc.id;<br/>          console.log("🌿", doc.data());<br/>          if (!user.role.admin) this.users.push(user);<br/>        });<br/>      });<br/>  },<br/>  methods: {<br/>    signout() {<br/>      firebase<br/>        .auth()<br/>        .signOut()<br/>        .then((user) =&gt; {<br/>          this.$router.push("/login");<br/>        });<br/>    },<br/>    changeRole(uid, event) {<br/>      var setUserRole = firebase.functions().httpsCallable("setUserRole");<br/>      var data = { uid: uid, role: { [event.target.value]: true } };<br/>      setUserRole(data)<br/>        .then((result) =&gt; {<br/>          console.log("🎉", result);<br/>        })<br/>        .catch((error) =&gt; {<br/>          console.log("🤡", error);<br/>        });<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</span></pre><p id="66a5" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">让我们将安全规则添加到数据库级别。只有admin能够查看created()方法中roles集合的所有用户数据。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="500a" class="jv jw in mk b gy na nb l nc nd">rules_version = '2';<br/>service cloud.firestore {<br/>  match /databases/{database}/documents {<br/>     match /roles/{uid} {<br/>      allow read, write: if request.auth.token.admin == true<br/>    }<br/>    <br/>  }<br/>}</span></pre><p id="d859" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">现在，在每个用户旁边添加一个下拉菜单，显示他们可以切换到的角色，并将uid和新的角色数据发送到后端的可调用函数setUserRole()中。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="96a2" class="jv jw in mk b gy na nb l nc nd"><em class="mo">// this function can only be triggered by the admin. This function allows the admin to<br/>// set user roles accordingly.</em></span><span id="1e21" class="jv jw in mk b gy ne nb l nc nd">exports.setUserRole = functions.https.onCall(async (data, context) =&gt; {<br/>  if (!context.auth.token.admin) return<br/>  try {<br/>    var _ = await admin.auth().setCustomUserClaims(data.uid, data.role)<br/>    return db.collection("roles").doc(data.uid).update({<br/>      role: data.role<br/>    })<br/>  } catch (error) {<br/>    console.log(error)<br/>  }<br/>});</span></pre><p id="21c0" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">重要提示:</strong>将功能部署到Firebase。</p><pre class="ms mt mu mv gt mw mk mx my aw mz bi"><span id="2928" class="jv jw in mk b gy na nb l nc nd">firebase deploy --only functions</span></pre><p id="2542" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated">首先，检查请求是否是由管理员使用服务器端的自定义声明发出的。然后，使用uid为自定义声明对象设置一个新角色，并更新相应的文档以反映角色的变化。</p><blockquote class="ml mm mn"><p id="13a5" class="ks kt mo ku b kv ln kx ky kz lo lb lc mp lp le lf mq lq lh li mr lr lk ll lm ig bi translated">如果你有更好的方法来解决这个问题，请在下面的评论区告诉我。</p></blockquote><p id="622d" class="pw-post-body-paragraph ks kt in ku b kv ln kx ky kz lo lb lc ke lp le lf ki lq lh li km lr lk ll lm ig bi translated"><strong class="ku io">🍎</strong> <a class="ae kr" href="https://github.com/alexkasongo/firebase-nuxt-role-based-auth" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> GITHUB回购</strong> </a> <strong class="ku io">🍎</strong></p></div></div>    
</body>
</html>