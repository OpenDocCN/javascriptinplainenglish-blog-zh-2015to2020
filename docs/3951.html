<html>
<head>
<title>Concepts of Load Balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">负载平衡的概念</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/concepts-of-load-balancing-a53e545fcdf2?source=collection_archive---------7-----------------------#2020-11-05">https://javascript.plainenglish.io/concepts-of-load-balancing-a53e545fcdf2?source=collection_archive---------7-----------------------#2020-11-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="cfe0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于一个正在快速扩张的公司来说，处理负荷是非常重要的。跨不同组织使用的负载平衡技术通常保持不变。如果使用AWS，可以使用弹性负载均衡器(ELB ),这将有助于在多个实例之间分配流量。在本文中，我们将尝试理解负载平衡在内部是如何工作的。为了理解这个概念，我们将在单个实例上部署我们的服务，并不断增加机器的负载。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/846a0685372045a638d7abef000f0083.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*cd9gnBG7IIsQ37CXQjSlPA.png"/></div></figure><p id="3981" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们有一个服务A，它直接与互联网交互，为整个负载提供服务。现在，如果该机器上的负载增加，即请求数量增加，CPU或内存利用率增加，并且该机器将无法处理负载。那时，我们就有必要扩展我们的服务。</p><p id="ba9f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有两种扩展服务的方式-</p><p id="9a5d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.<strong class="jm io">水平扩展</strong> —增加服务A的实例数量来处理负载</p><p id="27e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.<strong class="jm io">垂直扩展</strong> —增加分配给机器的资源，即CPU、RAM、磁盘等的数量。垂直缩放不能超过某个限制。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi kq"><img src="../Images/39064e482eee374266d527977120780e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*OJYpC4b1r87xtYY2TEWwQg.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">L7 Load balancer in front of our service</figcaption></figure><p id="e30e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了横向扩展我们的服务，我们将把我们的服务放在服务前面的L7负载平衡器后面。<strong class="jm io"> L7代表第七层或应用层</strong>。这个负载平衡器能够读取请求的内容，并且能够将其重定向到实例。一般来说，<strong class="jm io"> Nginx </strong>或<strong class="jm io"> HAProxy </strong>用于实现L7负载均衡器。使用Nginx的负载平衡示例如下:</p><ul class=""><li id="c238" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">Nginx上基于请求类型的L7负载平衡:在这个例子中，我们可以基于请求重定向流量。我们还可以将请求重定向到一台机器或一组机器。Nginx配置示例如下:</li></ul><pre class="kj kk kl km gt le lf lg lh aw li bi"><span id="4212" class="lj lk in lf b gy ll lm l ln lo">upstream backend  {<br/>  least_conn;<br/>  server 10.128.1.4;<br/>  server 10.128.1.5;<br/>}<br/>server {</span><span id="06aa" class="lj lk in lf b gy lp lm l ln lo">  location /admin/ {<br/>    proxy_set_header Host $host;<br/>    proxy_pass  &lt;http://10.128.1.2&gt;;<br/>  }</span><span id="23db" class="lj lk in lf b gy lp lm l ln lo">  location /category/ {<br/>    proxy_set_header Host $host;<br/>    proxy_pass  &lt;http://10.128.1.1&gt;;<br/>  }</span><span id="95dd" class="lj lk in lf b gy lp lm l ln lo">  location / {<br/>    proxy_set_header Host $host;<br/>    proxy_pass  &lt;http://backend&gt;;<br/>  }</span><span id="6338" class="lj lk in lf b gy lp lm l ln lo">}<!-- --> </span></pre><ul class=""><li id="da68" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">基于Nginx健康检查的L7负载平衡:我们还可以使用Nginx来平衡健康/不健康实例之间的负载。配置示例如下:</li></ul><pre class="kj kk kl km gt le lf lg lh aw li bi"><span id="579b" class="lj lk in lf b gy ll lm l ln lo">server {<br/>    location / {<br/>        proxy_pass   &lt;http://backend&gt;;<br/>        health_check port=8080;<br/>    }<br/>}</span><span id="4e8c" class="lj lk in lf b gy lp lm l ln lo">http {<br/>    upstream backend {<br/>        zone backend 64k;<br/>        server backend1.example.com;<br/>        server backend2.example.com;<br/>        server backend3.example.com;<br/>        server backend4.example.com;<br/>    }<br/>}</span></pre><p id="5255" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果健康检查失败，Nginx不会将流量重定向到该节点。</p><h1 id="ae18" class="lq lk in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">进一步增加负载</h1><p id="5008" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">进一步增加负载，我们的L7负载平衡器将无法处理流量。在这种情况下，我们需要由一个L4负载平衡器来平衡多个L7负载平衡器。<strong class="jm io"> L4代表第4层或传输层负载均衡器</strong>。当第4层负载平衡器收到请求并做出负载平衡决策时，它还对请求数据包执行网络地址转换(NAT ),将记录目的地IP地址从其自己的地址更改为其在内部网络中选择的内容服务器的地址。L4负载平衡器根据从TCP流的前几个数据包中提取的地址信息做出路由决定，并且不检查数据包内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/a5a68776f5126f947e286253a5168d76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3wagL7eXGWu8x2Jkn-Q89Q.png"/></div></div></figure><p id="fd57" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第4层负载平衡通常使用HAProxy实现。在这一层，我们根据它们使用的网络层协议类型(即TCP/UDP)来平衡流量。</p><h1 id="bbf6" class="lq lk in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">进一步增加负载</h1><p id="d87f" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">在负载进一步增加的情况下，我们可以在2个L4负载平衡器之前放置一个第3层负载平衡器。<strong class="jm io"> L3代表第三层或网络层。</strong>第3层负载平衡器使用ECMP，后者通常使用等价多路径路由(ECMP)。这些设计是为了避免将来自任何特定网络流的所有数据包沿单一确定性路径发送，同时平衡多条路径上的多个流的问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/ac9db6b6374b66a05dcf36915256fe03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FNlv4pd3VM9p47eaLLkpHA.png"/></div></div></figure><h1 id="05f8" class="lq lk in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">进一步增加了负载</h1><p id="eab6" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">DNS是将名称转换成IP地址的系统。DNS服务可以为特定请求返回多个IP地址。这是一种常见的负载平衡技术。DNS提供了一些常见的负载平衡技术</p><ol class=""><li id="2cbd" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh my lb lc ld bi translated"><strong class="jm io"/></li><li id="2599" class="kv kw in jm b jn mz jr na jv nb jz nc kd nd kh my lb lc ld bi translated"><strong class="jm io">循环DNS </strong> —这是最简单的负载均衡技术。DNS服务器以Robin Robin方式用服务器的IP进行响应。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/3d4951a2c59d59c44622b82dd63dd28b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xet6RdNctRiAik7FUI_NUw.png"/></div></div></figure><p id="c4ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上述技术可以根据您的要求以不同的方式组合。几种替代风格如下—</p><ul class=""><li id="997f" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated"><strong class="jm io"> DNS到L7 ELB </strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ne"><img src="../Images/a00be127c63d827afea8392c2d3f5ece.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dWK4rCVOiO7SNcHv9KERAw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">DNS to L7 LB</figcaption></figure><ul class=""><li id="1150" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated"><strong class="jm io">从DNS到L4 ELB </strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nf"><img src="../Images/3c7485748bd5a934116d33bc4426f33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*667rHI-DYnOZTLYfZiVv2Q.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">DNS to L4 ELB</figcaption></figure><h1 id="5f19" class="lq lk in bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">摘要</h1><p id="7656" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">当您的服务由于负载增加而耗尽时，您可以旋转服务的另一个实例，并使用L7负载平衡器在服务之间平衡负载。您可以使用L3、L4和L7负载平衡器的组合来平衡系统上的流量。您必须使用什么组合主要取决于您的系统类型。您可以尝试多种组合并测量系统的吞吐量，然后选择具有最大吞吐量和最小延迟的组合。</p><p id="94b7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">参考文献:</strong></p><ul class=""><li id="a425" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated"><a class="ae ng" href="https://www.youtube.com/watch?v=IqpwSgRM2hY&amp;t=67s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=IqpwSgRM2hY&amp;t = 67s</a></li><li id="d728" class="kv kw in jm b jn mz jr na jv nb jz nc kd nd kh la lb lc ld bi translated"><a class="ae ng" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html#:~:text=Target%20Groups-,Network%20Load%20Balancer%20overview,group%20for%20the%20default%20rule" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/elasticloadbalancing/latest/Network/introduction . html #:~:text = Target % 20 groups-，Network % 20 load % 20 balancer % 20 overview，group % 20 for % 20 the % 20 default % 20 rule</a>。</li><li id="d452" class="kv kw in jm b jn mz jr na jv nb jz nc kd nd kh la lb lc ld bi translated"><a class="ae ng" href="https://www.nginx.com/resources/glossary/dns-load-balancing/" rel="noopener ugc nofollow" target="_blank">https://www . nginx . com/resources/glossary/DNS-负载平衡/ </a></li><li id="28a9" class="kv kw in jm b jn mz jr na jv nb jz nc kd nd kh la lb lc ld bi translated"><a class="ae ng" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/" rel="noopener ugc nofollow" target="_blank">https://docs . nginx . com/nginx/admin-guide/load-balancer/http-load-balancer/</a></li></ul></div></div>    
</body>
</html>