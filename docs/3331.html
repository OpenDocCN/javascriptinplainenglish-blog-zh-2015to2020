<html>
<head>
<title>Automate common pull request feedback with Danger.js and Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Danger.js和Github操作自动处理常见的拉式请求反馈</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/automate-common-pull-request-feedback-with-danger-js-and-github-actions-a09a27ec01c9?source=collection_archive---------1-----------------------#2020-09-20">https://javascript.plainenglish.io/automate-common-pull-request-feedback-with-danger-js-and-github-actions-a09a27ec01c9?source=collection_archive---------1-----------------------#2020-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a667" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我喜欢软件工程的一个原因是，如果我发现自己经常做一项任务，我可以选择将时间投资在自动化上，从长远来看可以节省时间。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a2a3e44a358701d0068354ed71a0efa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EBbBBpucqVtSfSlqENdKxw.png"/></div></div></figure><p id="8e5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在工作场所和家里的许多事情上都使用过这种技巧。</p><p id="6c51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我想买一栋特定的房子时，我已经自动化了一些事情。我没有痴迷地查看网站是否可用，而是在Node.js中编写了一个web scraper来帮我检查页面。它在AWS的服务器上每隔15分钟运行一次，当房子上市时，它会发短信告诉我预订房子所需的详细信息。</p><p id="26fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些关于自动化的讨论让我想到了我最近一直在做的事情，那就是自动化对拉请求的公共反馈。</p><h1 id="832c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">为什么要自动化拉式请求反馈？</h1><p id="5bd2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">当您提出拉动请求时，您收到反馈的速度越快，解决问题的速度就越快。因此，值得考虑的是，通过分析代码提供反馈的机器人总是比人快。</p><p id="11ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一件要考虑的事情是，当您选择自动化您的拉式请求反馈时，您也通过代理来编纂您的团队最佳实践。这可以对您的代码产生积极的影响，因为它将减少不遵循您的最佳实践的代码在正常审查中被遗漏的情况。</p><p id="66ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自动化拉式请求反馈的最后一个原因是，来自机器人的反馈与来自同事的反馈具有不同的情绪反应。一个机器人不会对其他人的代码进行人身攻击，所以这会对士气产生积极的影响。</p><p id="e621" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也就是说，拉式请求反馈的自动化应该与人工评审并行使用。自动化的重点是加强你的团队的最佳实践，而普通的评审将挑选出解决问题的整体方法的问题。</p><h1 id="cb06" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置Danger.js以提供拉取请求反馈</h1><p id="aca0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">首先，我将解释我们如何在GitHub库上设置Danger.js。在第一个实例中，它将简单地输出一条关于pull请求的消息，其中包含已更改文件的列表。</p><h2 id="a474" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">Danger.js的初始设置</h2><p id="24ca" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在项目中设置danger的第一步是创建一个新的分支，我通常在CLI中这样做</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="eca2" class="ma ky iq mn b gy mr ms l mt mu">git checkout -b danger</span></pre><p id="3682" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建了我们的分支后，我们现在需要从npm安装<code class="fe mv mw mx mn b">danger</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="9ac5" class="ma ky iq mn b gy mr ms l mt mu">npm install danger --save-dev</span></pre><p id="5a2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装了<em class="my"> Danger.js </em>之后，您现在需要在项目的根目录下创建一个<strong class="jp ir"> danger </strong>文件。为此，我们可以使用JavaScript或TypeScript，dangerfile.js用于JavaScript和dangerfile.ts。我在这里看到的使用TypeScript的主要好处是，节点模块提供的类型定义比文档更好地向您提供有关API的信息。</p><p id="91a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">dangerfile.ts/dangerfile.js</strong></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8205" class="ma ky iq mn b gy mr ms l mt mu">import {<strong class="mn ir">message</strong>, <strong class="mn ir">danger</strong>} from "danger"</span><span id="7769" class="ma ky iq mn b gy mz ms l mt mu"><em class="my">const</em> <strong class="mn ir">newFiles</strong> = danger.git.created_files.join("- ")</span><span id="027d" class="ma ky iq mn b gy mz ms l mt mu"><strong class="mn ir">message</strong>("New Files in this PR: \n - " + <strong class="mn ir">newFiles</strong>);</span></pre><h2 id="a6f2" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">配置GitHub操作</h2><p id="ad55" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">下一步是配置一个GitHub动作，在发出pull请求时运行Danger.js。</p><p id="b7f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我们需要创建一个工作流。我们通过在<code class="fe mv mw mx mn b">.github/workflows</code>目录中创建一个Yaml文件来做到这一点。下面是工作流程的一个示例:</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="0e41" class="ma ky iq mn b gy mr ms l mt mu">name: Danger JS<br/>on: [pull_request]<br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - uses: actions/checkout@master<br/>    - name: Use Node.js 12.x<br/>      uses: actions/setup-node@v1<br/>      with:<br/>        node-version: 12.x<br/>    - name: Danger<br/>      run: npx danger ci<br/>      env:<br/>        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}</span></pre><p id="fda9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们将工作流程分解成关键部分:</p><ul class=""><li id="a048" class="na nb iq jp b jq jr ju jv jy nc kc nd kg ne kk nf ng nh ni bi translated"><strong class="jp ir"> name </strong>:将出现在pull请求上的github动作的名称。</li><li id="35a7" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated"><strong class="jp ir"> on </strong>:动作运行的时间，在我们的例子中是创建或更改拉请求的时间</li><li id="0d18" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated"><strong class="jp ir">作业</strong>:将要运行的作业列表，在本例中，我们指定一个名为“test”的作业</li><li id="8997" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated"><strong class="jp ir">步骤</strong>:GitHub动作将运行的步骤，在本例中，检查存储库，设置Node.js，然后使用它运行danger。</li></ul><h2 id="0b69" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">拉取请求存在运行危险</h2><p id="96db" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">配置了Danger.js和GitHub动作工作流之后，我们现在可以在Github中通过使用我们的分支发出一个pull请求来进行测试。</p><p id="b300" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在提出我们的pull请求后，我们需要等待几分钟来运行这个动作，然后我们会在github actions bot发布的PR上看到反馈。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/d052ca1a9b4164ef326f897d39dd9036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O7tTTVRc600birdk1AtkhQ.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk">Screenshot of Danger.js with new files in the pull request</figcaption></figure><h1 id="dbda" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">其他Danger.js操作的方法</h1><p id="9404" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在初始设置中，我们只是让Danger.js留下一个注释，其中包含由pull请求添加的新文件列表。虽然一个很好的设置示例用处有限，但在本节中，我们将列出一些更多的方法，您可以使用Danger.js使其更加有用。</p><h2 id="f00f" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">如果package.json发生更改，请确保package-lock.json得到更新</h2><p id="7c17" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">从npm安装新的节点程序包时，会导致package.json和package-lock.json文件都发生更改。这两个文件都应该提交给存储库，这样如果package.json发生了变化，这个检查将确保您不会忘记提交锁文件。</p><p id="eac7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">代码示例</strong></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="a1a1" class="ma ky iq mn b gy mr ms l mt mu"><em class="my">const</em> <strong class="mn ir">packageChanged</strong> = danger.git.modified_files.includes('package.json');<br/><em class="my">const</em> <strong class="mn ir">lockfileChanged</strong> = danger.git.modified_files.includes('package-lock.json');</span><span id="b97d" class="ma ky iq mn b gy mz ms l mt mu"><em class="my">const</em> <strong class="mn ir">packageChanged</strong> = danger.git.modified_files.includes('package.json');<br/><em class="my">const</em> <strong class="mn ir">lockfileChanged</strong> = danger.git.modified_files.includes('package-lock.json');</span><span id="015b" class="ma ky iq mn b gy mz ms l mt mu">if (<strong class="mn ir">packageChanged</strong> &amp;&amp; !<strong class="mn ir">lockfileChanged</strong>) {<br/>    <strong class="mn ir">warn</strong>(`Changes were made to package.json, but not to package-lock.json - &lt;i&gt;'Perhaps you need to run `npm install`?'&lt;/i&gt;`);<br/>}</span></pre><p id="f1bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">GitHub上的输出</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/39187e16ac28c9c3abed37ecfcc637b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VNRw3ACVHn9iHNpwz4ofdg.png"/></div></div></figure><p id="7098" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在GitHub上查看菜谱:<a class="ae nu" href="https://github.com/jonathan-fielding/danger-js-example/pull/2" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Jonathan-fielding/danger-js-example/pull/2</a></p><h2 id="146e" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">鼓励小型公关</h2><p id="e3ff" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">对于一个人来说，大的拉取请求很难被准确地审阅，因为很难跟踪所有已经改变的不同事物以及它们之间的关系。为了鼓励您的团队编写更小的拉请求，您可以让Danger.js在拉请求太长时发布一个警告。</p><p id="f266" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">代码示例</strong></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="a257" class="ma ky iq mn b gy mr ms l mt mu">import {warn, danger} from "danger"</span><span id="49be" class="ma ky iq mn b gy mz ms l mt mu"><em class="my">const</em> bigPRThreshold = 600;</span><span id="7b36" class="ma ky iq mn b gy mz ms l mt mu">if (danger.github.pr.additions + danger.github.pr.deletions &gt; bigPRThreshold) {<br/>  warn('Big pull request, please keep small to make it easier to review');<br/>}</span></pre><p id="b981" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">GitHub上的输出</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nv"><img src="../Images/648f31c1273de9ada9f4968db0aac65f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iwz3ea3KAbUuZMzcYCqlIQ.png"/></div></div></figure><p id="c827" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在GitHub上查看菜谱:<a class="ae nu" href="https://github.com/jonathan-fielding/danger-js-example/pull/3" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Jonathan-fielding/danger-js-example/pull/3</a></p><h2 id="f142" class="ma ky iq bd kz mb mc dn ld md me dp lh jy mf mg ll kc mh mi lp kg mj mk lt ml bi translated">鼓励有用的提交消息</h2><p id="65f7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">当处理语义版本化的JavaScript库之类的项目时，提交消息遵循类似的结构可能会有好处。这有助于您根据自上一个版本以来的提交消息，记住您的下一个版本应该如何版本化。</p><p id="566c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Danger.js，通过检查PR中的提交消息，可以很容易地实施提交消息格式。</p><p id="5a43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">代码示例</strong></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5664" class="ma ky iq mn b gy mr ms l mt mu">import {<strong class="mn ir">fail</strong>, <strong class="mn ir">danger</strong>} from "danger"</span><span id="b4b2" class="ma ky iq mn b gy mz ms l mt mu"><strong class="mn ir">danger.git.commits.forEach</strong>(<strong class="mn ir"><em class="my">commit</em></strong> =&gt; {</span><span id="5829" class="ma ky iq mn b gy mz ms l mt mu">  if (!<strong class="mn ir">commit.message.match</strong>(/^(feat:)|(fix:)|(major:)|(chore:)/g)) {<br/>    <strong class="mn ir">fail</strong>(`Commit message '${commit.message}' does match the correct format`);<br/>  }</span><span id="372d" class="ma ky iq mn b gy mz ms l mt mu">})</span></pre><p id="c441" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">GitHub上的输出</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nw"><img src="../Images/c54543fd83c652e065da964135da803d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4a-vc-XE_3MaZeI0NyGDww.png"/></div></div></figure><p id="df42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在GitHub上查看菜谱:<a class="ae nu" href="https://github.com/jonathan-fielding/danger-js-example/pull/4" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Jonathan-fielding/danger-js-example/pull/4</a></p><h1 id="2587" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">强制执行Danger.js检查</h1><p id="d1b4" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">设置好Danger.js检查后，建议您在将代码合并到主分支之前强制执行Danger.js状态检查。</p><p id="9371" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要做到这一点，你需要查看GitHub上的存储库设置。然后，您希望选择添加规则，然后为分支启用“合并前要求通过状态检查”。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/fb59b7a0f8eb571543108c971327d13c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPuuRXgBdjcYxyUFs6ET5A.png"/></div></div></figure><h1 id="57db" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">包扎</h1><p id="69c0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在结束这篇文章时，我只想说，希望从我提供的食谱中，你可以看到你用Danger.js做的任何事情都只是JavaScript。</p><p id="20af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际上，这意味着您可以非常快速地编写更加复杂的pull请求检查，然后利用Danger.js API提供反馈。</p><p id="02a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你觉得这很有用，我鼓励你关注我的更多关于编码、性能和可访问性的帖子。</p></div></div>    
</body>
</html>