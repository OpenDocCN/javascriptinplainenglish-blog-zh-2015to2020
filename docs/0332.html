<html>
<head>
<title>Going Offline With Service Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与服务人员离线</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/going-offline-with-service-workers-44ecb46d9f?source=collection_archive---------1-----------------------#2019-09-20">https://javascript.plainenglish.io/going-offline-with-service-workers-44ecb46d9f?source=collection_archive---------1-----------------------#2019-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="adcb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当连接不存在时联系用户</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://www.webtips.dev/going-offline-with-service-workers"><div class="gh gi kf"><img src="../Images/016704af2696a2e327c99c33fed0804a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4tuSG5Oi3XnmMIQxGd00A.jpeg"/></div></a></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://www.webtips.dev/going-offline-with-service-workers"><div class="gh gi kn"><img src="../Images/c19cb3069af1beba3c93258d9fcfe139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*-PVzecNs3s4ZbJsdsgIsGA.png"/></div></a></figure><p id="1bfa" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">全球平均网速正逐年加快，但速度较慢的3G用户仍有数百万。移动互联网用户的数量正在增长，很久以前，全球范围内的移动互联网用户数量已经<a class="ae lk" href="https://techcrunch.com/2016/11/01/mobile-internet-use-passes-desktop-for-the-first-time-study-finds/" rel="noopener ugc nofollow" target="_blank">超过了</a>。这些用户的互联网连接可能不可靠，有时甚至不存在。通常，他们可能想在旅途中访问你的内容，如果你想提供无缝的用户体验——<em class="ll">考虑到这些人</em>——你必须考虑离线。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="2f54" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">离线应用</h1><p id="b371" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">离线应用试图通过引入一些巧妙的技术解决方案来解决这些连接问题，例如</p><h2 id="c84d" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">检测</strong>离线<strong class="ak">状态</strong></h2><p id="ef73" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">要使您的web应用程序离线工作，您首先需要确定您的用户的连接状态。这可以通过<code class="fe nc nd ne nf b">online</code>和<code class="fe nc nd ne nf b">offline</code> <a class="ae lk" href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorOnLine/Online_and_offline_events" rel="noopener ugc nofollow" target="_blank">事件</a>以及<code class="fe nc nd ne nf b">navigator.onLine</code>的帮助来完成。</p><h2 id="728c" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">离线存储数据和资产</strong></h2><p id="53ce" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">这是一个服务人员可以大放异彩的地方。您希望将静态资产存储在本地缓存中，这样即使互联网连接中断，您的应用程序也可以加载。它还可以帮助您的站点更快地加载，因为它从缓存中请求资源，而不是发出网络请求。</p><p id="3a2e" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于在本地存储数据，有几个选项，但是您最好的选择是使用<code class="fe nc nd ne nf b"><a class="ae lk" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" rel="noopener ugc nofollow" target="_blank">localStorage</a></code>。您还可以使用它在脱机时对请求进行排队，并在用户重新联机时调用它们。</p><h2 id="6ceb" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">与服务器同步</strong></h2><p id="7d68" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">连接恢复后，您可以与服务器同步，并将离线状态下排队的数据保存回来。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ng"><img src="../Images/e2e4f39bdfd5da311c4579953778d175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_p1DQR7Limzy0XqkH6_L0A.png"/></div></div></figure></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="cd16" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">先决条件</h1><p id="bd3b" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">在使用服务人员时，必须满足一些先决条件。首先，我们必须指出，它仍然可以被认为是一个实验性的功能，因此在您使用它之前，您必须了解浏览器的支持。然而它在不断增长，目前只有IE不受支持。如需全面覆盖，您可以参考位于<a class="ae lk" href="https://caniuse.com/#search=service%20work" rel="noopener ugc nofollow" target="_blank">caniuse.com</a>的兼容性表</p><p id="d32f" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">另一个要求是，你的网站必须通过HTTPS服务。这是出于安全原因，因为服务人员充当代理，可以改变您的回答。因此，确保服务人员没有被篡改是至关重要的。然而，在开发过程中，您仍然可以在本地使用它们。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="012a" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">生命周期</h1><p id="fee1" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">服务人员的生命周期独立于您的应用程序。它运行在一个不同的线程上，因此重要的是要提到，您将无法访问dom并做您在日常JavaScript文件中通常会做的事情，但服务人员无论如何都不打算这样做。</p><h2 id="bbee" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">注册</strong></h2><p id="c8f4" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">要为应用程序添加服务人员，首先需要在一个JavaScript文件中注册它。注册后，它将使浏览器在后台开始下一步，即:</p><h2 id="9539" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">安装</strong></h2><p id="2324" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">在安装过程中，您通常希望在站点上缓存静态资产。如果一切顺利，所有文件都成功下载，那么服务人员就可以安装了。如果这些文件中的任何一个由于某种原因下载失败，那么这个步骤将会失败，服务工作者将不会被安装。在这种情况下，它下次会再试一次。</p><h2 id="5dc9" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">激活</strong></h2><p id="1459" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">安装步骤完成后，服务人员被激活。在这一步中，您通常希望更新您的worker删除或更新旧的缓存文件。</p><h2 id="828c" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">获取</strong></h2><p id="b30c" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">一旦激活，您的服务人员就可以监听fetch事件，只要有网络请求，就会触发这些事件。在此期间，您可以拦截这些请求并返回缓存版本(如果有),或者继续处理网络请求(如果没有)。</p><h2 id="17e9" class="mq lu iq bd lv mr ms dn lz mt mu dp md kx mv mw mf lb mx my mh lf mz na mj nb bi translated"><strong class="ak">终止</strong></h2><p id="5264" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">不再使用时，服务人员将被终止以节省内存，并且仅在下次需要时才可用。</p><p id="c73d" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这些是我们在实现过程中需要经历的步骤，所以我们先从注册开始吧。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="1979" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">注册服务人员</h1><p id="24ff" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">注册可以在一行中完成:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="b66f" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">其中<code class="fe nc nd ne nf b">sw.js</code>是JavaScript文件的位置，它保存了服务人员需要执行的功能。一个常见的约定是在项目的根目录下创建服务人员的JavaScript文件，但是它可以位于任何地方，因为您可以将路径传递给register方法。</p><p id="eabc" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如前所述，还不是所有的浏览器都支持它们，所以检查<code class="fe nc nd ne nf b">serviceWorker</code>对象是否存在于<code class="fe nc nd ne nf b">navigator</code>上是个好习惯。可以通过以下方式检查支持:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="1074" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">装置</h1><p id="a495" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">在service worker文件内部，可以用<code class="fe nc nd ne nf b">self</code>关键字引用对象本身。回顾生命周期，我们可以看到我们需要采取的第一步是安装它。幸运的是，我们有方便的事件，可以为其附加事件侦听器。要安装一个服务工作者，我们必须将一个监听器连接到<code class="fe nc nd ne nf b">install</code>事件，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="2638" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">每当服务人员第一次安装时，回调函数中的所有内容都会被执行。这是您想要将文件添加到缓存的位置。为此，我们可以用下面的代码扩展<code class="fe nc nd ne nf b">install</code>事件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="3583" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">从内向外开始，<code class="fe nc nd ne nf b">cache.addAll</code>接受一个我们想要缓存的文件数组。一个很好的经验法则是只缓存很少改变的静态资产，比如字体和图像。</p><p id="ce69" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们把它返回给<code class="fe nc nd ne nf b">caches.open</code>，它接受一连串的承诺，然后<code class="fe nc nd ne nf b">cache.addAll</code>返回。<code class="fe nc nd ne nf b">sw-cache</code>字符串是要使用的缓存的名称，也可以是其他名称。</p><p id="7f49" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">然后我们把所有东西都包在<code class="fe nc nd ne nf b">event.waitUntil</code>里面。它包含一个承诺，用于了解安装需要多长时间。如果<code class="fe nc nd ne nf b">cache.addAll</code>中的任何文件下载失败，安装步骤将失败。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="e56c" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">返回缓存</h1><p id="c577" class="pw-post-body-paragraph ko kp iq kq b kr ml jr kt ku mm ju kw kx mn kz la lb mo ld le lf mp lh li lj ij bi translated">剩下要做的就是拦截请求并返回它们的缓存版本。为此，我们可以监听<code class="fe nc nd ne nf b">fetch</code>事件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="e434" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">每当用户导航到安装了服务工作者的页面时，它将开始接收来自每个请求的<code class="fe nc nd ne nf b">fetch</code>事件。这里我们使用<code class="fe nc nd ne nf b">event.respondWith</code>并传入一个承诺:<code class="fe nc nd ne nf b">caches.match</code>，它查看请求，如果发现匹配，它返回由服务工作者创建的缓存。否则，它使用<code class="fe nc nd ne nf b">fetch</code>函数通过网络请求资源，并从函数调用中返回值。这相当于说:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="6ce3" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">剩下要做的就是测试它。你可以在Chrome中打开DevTools，在network选项卡内将<code class="fe nc nd ne nf b">Online</code>状态改为<code class="fe nc nd ne nf b">Offline</code>状态。刷新页面，欣赏你的网站如何加载仍然没有问题。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nn"><img src="../Images/cde6b3abb61432f626b263e699227461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UJICgKcyb2J7OPLKymlLCw.png"/></div></div></figure><p id="ee5c" class="pw-post-body-paragraph ko kp iq kq b kr ks jr kt ku kv ju kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这也是一个很好的时间来验证，在缓慢连接的情况下，它仍然应该在微风中加载。🐌</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://medium.com/@ferencalmasi/membership"><div class="gh gi no"><img src="../Images/e66c4cd6d9849ac0bd245f3fc39b65c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZ9xuLqLkbqUG65sgVB3gg.png"/></div></a></figure></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://www.webtips.dev/how-to-sync-your-client-and-server-after-being-offline"><div class="gh gi kn"><img src="../Images/a7afaeaa55be726e015a29b8547ef700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*-Wplh20FRj8BK5QqZJuN0w.png"/></div></a></figure></div></div>    
</body>
</html>