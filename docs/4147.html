<html>
<head>
<title>Comparison of Safe Eval and Eval</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安全评估和评估的比较</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/safe-eval-and-eval-whats-the-fuss-aa495c4eaa96?source=collection_archive---------4-----------------------#2020-11-20">https://javascript.plainenglish.io/safe-eval-and-eval-whats-the-fuss-aa495c4eaa96?source=collection_archive---------4-----------------------#2020-11-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="58d5" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">评估和安全评估与示例和统计数据的比较。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/1fb3e4266b327c133b52377843d248cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9nnqx77XET9L24Z_hIwxTg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Source github:<a class="ae ks" href="https://github.com/hacksparrow/safe-eval/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">https://github.com/hacksparrow/safe-eval/blob/master/index.js</a></figcaption></figure><p id="9a51" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">嗨，我在这里分享我从一个大型nodeJS应用程序的性能优化中学到的东西。</p><p id="a0ef" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这里，我们不讨论是否应该使用eval/safeEval，我们将看到它们的性能比较和安全问题，我们还将看到safeEval的安全性和开销，如果您已经决定使用它，请阅读本文。</p><p id="d638" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">它们是什么的简介</p><p id="c0ed" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Eval用于评估以字符串格式编写的JS语句，safe Eval安全地做同样的事情。</p><p id="82ef" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">“好吧，这么详细”</p><p id="822c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当然，让我来。</p><blockquote class="lp lq lr"><p id="f733" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">Eval就像核能，如果控制住并明智地使用，你可以给整个城市供电，如果没有控制住，你可以炸毁整个城市。<br/>安全评估是核电站。</p></blockquote><p id="00c0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">“嗯”</p><p id="1ef6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Eval和safeEval用于计算表达式。<br/>点击<a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval" rel="noopener ugc nofollow" target="_blank">评估</a>和<a class="ae ks" href="https://www.npmjs.com/package/safe-eval" rel="noopener ugc nofollow" target="_blank">安全评估</a>，了解更多信息</p><p id="d6f9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是，这个博客并不是要理解什么是eval和safeEval，在这里我们将看到它们之间的区别以及它们是如何工作的。</p><blockquote class="lp lq lr"><p id="b69d" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><strong class="kv io"> safeEval </strong>创建自己的上下文，然后进行评估，相反<strong class="kv io"> eval </strong>在应用上下文中进行评估。</p></blockquote><p id="8091" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们来理解一下上面那行。</p><p id="a111" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果你看看safeEval的方法签名，它是这样的</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="adcd" class="mb mc in lx b gy md me l mf mg">function safeEval (code, context, opts)</span><span id="559e" class="mb mc in lx b gy mh me l mf mg"><a class="ae ks" href="https://github.com/hacksparrow/safe-eval/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">https://github.com/hacksparrow/safe-eval/blob/master/index.js</a></span></pre><p id="e843" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">每当我们调用safeEval时，我们向它传递上下文，假设我有一个函数sum " my math ",那么为了调用这个函数，我会这样做。</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="6eb4" class="mb mc in lx b gy md me l mf mg">mobj.sum(a,b)</span></pre><p id="56e3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">请看下面的片段</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="d548" class="mb mc in lx b gy md me l mf mg">//Addition example </span><span id="c0ff" class="mb mc in lx b gy mh me l mf mg">//MyMath.js<br/>function sum(a,b){</span><span id="002a" class="mb mc in lx b gy mh me l mf mg">return a+b;</span><span id="bfa9" class="mb mc in lx b gy mh me l mf mg">}<br/>const safeEval = require('safe-eval')<br/>const mobj = require('./MyMath');<br/>var toBeEvaluated = "mobj.sum(5,9)"</span><span id="0e92" class="mb mc in lx b gy mh me l mf mg">var evaluatedString = eval(toBeEvaluated); // --------------1 console.log("evaluatedString", evaluatedString);</span><span id="d7ed" class="mb mc in lx b gy mh me l mf mg">var safelyEvaluatedString = safeEval(toBeEvaluated);//---2 console.log("safelyEvaluatedString", safelyEvaluatedString);</span></pre><p id="7853" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">上面我们准备了一个字符串进行评估，我们对同一个字符串进行eval和safeEval并打印输出。现在，让我们看看输出</p><p id="14f1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在第一种情况下</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mi"><img src="../Images/c9fa3b02a2f3baf6221d287277d3a24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_1EKYoiE1Ty6Rmi5aA08A.png"/></div></div></figure><p id="3f03" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于第二种情况，它抛出ReferenceError。</p><p id="3ca1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们在上面的代码中添加几行代码，使它看起来像这样。(为安全评估做更改)。</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="2188" class="mb mc in lx b gy md me l mf mg">let context= {"mobj":mobj}<br/>var safelyEvaluatedString = safeEval(script,context);----------2<br/>console.log("safelyEvaluatedString", safelyEvaluatedString);</span></pre><p id="42b0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在我们得到了与上述eval相同的输出。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mj"><img src="../Images/ea5dad6513ff36dd7a7779291f2aabd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NXxjn-_85Tnm-mQnv9fUaA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Output after passing the context.</figcaption></figure><h1 id="56a4" class="mk mc in bd ml mm mn mo mp mq mr ms mt jt mu ju mv jw mw jx mx jz my ka mz na bi translated"><strong class="ak">这里发生了什么？</strong></h1><p id="5927" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated"><strong class="kv io">在评估情况下</strong></p><blockquote class="lp lq lr"><p id="bd58" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">Eval在当前<strong class="kv io">应用程序上下文中执行。</strong></p></blockquote><p id="d47f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这里，它可以访问"<strong class="kv io"> mobj" </strong> object <strong class="kv io"> </strong>和任何我们通过eval进行评估的字符串，eval将使用在它之外创建的对象并执行应用程序。让我们看看攻击者是如何利用这一点的，请看下面的代码片段。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ng"><img src="../Images/047e18844380641bcf0148c6c5b0185b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_-lVG6Mzo7t5KUOctfEXaw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Image snippet of an example exploit code. app.js</figcaption></figure><p id="7e3a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">上面curl调用代码片段的输出是目录中的文件和目录列表。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nh"><img src="../Images/b8ad34fd21abd7fb84724ba4acd8e80a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s7NgyMPBGdEVNOaSyFIarw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Curl call output to the above server code.</figcaption></figure><p id="7f1e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在上面的终端代码片段中，可以看到执行curl调用列出了app.js文件所在目录中的所有文件。</p><p id="594d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">由于<strong class="kv io"> eval </strong>可以访问res对象，因此它将在评估后返回数据字符串中所述的结果。</p><p id="1025" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">在安全案例中</strong></p><blockquote class="lp lq lr"><p id="a770" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">它创建自己的上下文，然后执行代码。</p></blockquote><p id="2648" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">因此，当我们在safeEval的上下文中传递对象时，它只能访问上下文中的那些对象，任何其他对象引用都会导致错误。<br/>现在我们知道了为什么在加法的例子中失败了，以及为什么我们一旦通过了上下文就开始工作了。</p><p id="af6c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，让我们以利用代码为例，尝试用safeEval执行它。让我们来看看结果。</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="2b6b" class="mb mc in lx b gy md me l mf mg">app.get('/', function (req, <strong class="lx io">res</strong>) {</span><span id="6e47" class="mb mc in lx b gy mh me l mf mg">const toBeEvaluated = "res.end(require('fs').readdirSync('.').toString())";<br/>evaluate = safeEval(toBeEvaluated);<br/>})</span></pre><p id="9918" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在会发生什么？你是对的，它会坏掉，但是为什么呢？你又答对了，因为它没有访问“res”对象的权限，所以它会给出一个错误，见下面的执行输出。<strong class="kv io">参考错误</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ni"><img src="../Images/fd622530461113da09653d7c101bbef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kLDZimO92Gdm3R3KHlgG2A.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Output snippet on server side (safeEval)</figcaption></figure><blockquote class="lp lq lr"><p id="cb1a" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">我们现在知道safeEval比Eval更安全。</p></blockquote><h1 id="ac32" class="mk mc in bd ml mm mn mo mp mq mr ms mt jt mu ju mv jw mw jx mx jz my ka mz na bi translated">这给我们留下了什么？</h1><p id="7147" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">你一定在想，如果要进行安全评估，有什么好大惊小怪的。</p><p id="0301" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">沉住气，让事情安全有自己的开销，上下文创建确实是一个昂贵的操作，这使得安全评估比评估慢得多，它可以在很大程度上影响应用程序的性能，所以要明智地使用它。<br/>如果需要对某个数据集进行评估，先执行safeEval，再执行Eval。</p><h1 id="fcfc" class="mk mc in bd ml mm mn mo mp mq mr ms mt jt mu ju mv jw mw jx mx jz my ka mz na bi translated">性能比较</h1><p id="c0fa" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">让我们修改上面的代码来计算eval和safeEval所用的时间。<br/>我们将使用perf_hooks的性能来计算执行所花费的时间</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nj"><img src="../Images/1ab5a6b7d30f1942454b9bb8ef114112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mCREPOKfZUYSPtRuePzOJw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Using perf_hooks to calculate the time taken</figcaption></figure><p id="3b51" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是上面运行的输出</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ni"><img src="../Images/bce4ff884f15959a5639d159b5fdcd17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RIWIOnpQsgpPv-cgnfidxA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">The output of the above code snippet (performance comparison)</figcaption></figure><p id="b124" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在上面的代码片段中，您可以看到safeEval花费的时间几乎是Eval的十八(18)倍(18在这里不是一个标准数字，只是为了便于比较)</p><ul class=""><li id="ab4a" class="nk nl in kv b kw kx kz la lc nm lg nn lk no lo np nq nr ns bi translated">*好的，伙计，我们在使用safeEval时会小心的**</li></ul><p id="d69e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">另一件我们应该小心的事情是我们将什么对象传递到上下文中，让我们以上面的例子来理解我想说的。</p><p id="655d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在上面的漏洞利用示例中，当我们使用safeEval时，它给出了<strong class="kv io"> res not found错误</strong>，因为我们没有在上下文中提供res对象，如果我们这样做并使用safeEval会怎么样:</p><pre class="kd ke kf kg gt lw lx ly lz aw ma bi"><span id="bcd2" class="mb mc in lx b gy md me l mf mg">app.get('/', function (req, <strong class="lx io">res</strong>) {</span><span id="c65f" class="mb mc in lx b gy mh me l mf mg">const toBeEvaluated = "res.end(require('fs').readdirSync('.').toString())";</span><span id="07c5" class="mb mc in lx b gy mh me l mf mg">//I know passing require in context is extreme, I am just trying to // show something </span><span id="d9ca" class="mb mc in lx b gy mh me l mf mg">let context = {"res":res,"require":require}; <br/>evaluate = safeEval(toBeEvaluated,res);<br/>})</span></pre><p id="138e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你认为现在会发生什么？</p><p id="7c98" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">是的，它将成功执行，并且输出将与<strong class="kv io"> eval相同。</strong></p><p id="71db" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">因此，我们需要小心我们在上下文中传递的内容，也许我们可以将处理敏感信息的对象与正常对象分开一次。<br/>就是不要放过里面的一切。</p><p id="7edd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你们很聪明，会处理好的。</p><h1 id="4888" class="mk mc in bd ml mm mn mo mp mq mr ms mt jt mu ju mv jw mw jx mx jz my ka mz na bi translated">结论</h1><p id="4211" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">Eval和safeEval是非常强大的工具，在使用时，我们应该考虑应用程序的安全性和性能，不应过度使用。</p><p id="e5ec" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是我的第一个媒体博客(可能你已经知道了)🤞🏽)，所以请大家的宝贵意见帮助我做得更好。请让我知道我是否应该添加更多的信息来使它变得更好。</p><p id="112a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">感谢您的耐心阅读。快乐发展。</p><p id="96c5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="ls">合十礼。</em></p></div></div>    
</body>
</html>