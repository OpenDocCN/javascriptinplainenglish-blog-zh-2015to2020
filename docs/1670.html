<html>
<head>
<title>Canceling Promises in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在JavaScript中取消承诺</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/canceling-promises-in-javascript-31f4b8524dcd?source=collection_archive---------0-----------------------#2020-04-13">https://javascript.plainenglish.io/canceling-promises-in-javascript-31f4b8524dcd?source=collection_archive---------0-----------------------#2020-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d9fa" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">或者:如何取消那封尴尬的邮件</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/467a092f4673f4a5d895413efbdbbc3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06ZBaLcXv9QUxpbPpoQPzw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@lishakov?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Andrej Lišakov</a> on <a class="ae kv" href="https://unsplash.com/s/photos/red-x?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="80e2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你有没有发过一封让你立刻后悔的邮件，或者在发现有问题的时候点击提交？“红X在哪里？我能快速停止吗？”，你哭吧！</p><h1 id="e9cb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">承诺方法</h1><p id="872a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在Javascript中，异步行为是用承诺捕获的。虽然它们比回调更干净，并且与语言(async和await)深度集成，但Promises的方法很少:<code class="fe mp mq mr ms b">then</code>接受行为成功时运行的回调，<code class="fe mp mq mr ms b">catch</code>失败时运行回调，<code class="fe mp mq mr ms b">finally</code>在两种情况下都运行。<code class="fe mp mq mr ms b">cancel</code> <strong class="ky ir">不在这些标准的许诺方式</strong>之列。</p><p id="2027" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看看如何打破承诺界面，取消行为。</p><h1 id="2cd1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">必须是可取消的行为</h1><p id="04fd" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">某些操作无法取消。虽然xhr可以被<code class="fe mp mq mr ms b">.abort()</code>d，但是用Javascript加载脚本是无法停止的。显而易见，如果没有提供接口来取消您的承诺正在包装的行为，那么您不能扩展您的承诺包装器来允许取消该行为。</p><p id="4494" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你不能让火车停下来，你的停车按钮就不会——不能——起作用。这是物理。</p><h1 id="87bc" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设计可取消的承诺</h1><p id="a484" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将返回一个<code class="fe mp mq mr ms b">cancel</code>回调，而不是仅仅返回一个承诺。调用我们的承诺构建函数的代码可以像正常情况一样处理返回的承诺，但也可以在超时、错误处理或用户调解的情况下调用<code class="fe mp mq mr ms b">cancel</code>回调。</p><p id="6012" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(你也可以在返回之前在你的承诺上设置一个<code class="fe mp mq mr ms b">cancel</code>方法，比如<code class="fe mp mq mr ms b">promise.cancel = cancel;</code>，但是TypeScript/IDE IntelliSense可能不理解这种方法。运用你的判断力。)</p><p id="0e1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当构建<code class="fe mp mq mr ms b">cancel</code>回调行为时，有4个场景需要考虑:</p><ol class=""><li id="e3be" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated"><code class="fe mp mq mr ms b">cancel</code>马上就叫，之前还有什么要清理的。(如果您启动了底层效果，请确保立即取消并清理它。)</li><li id="b37b" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><code class="fe mp mq mr ms b">cancel</code>在执行中间被调用。(清理效果。考虑拒绝或解决承诺，或者让它处于不完整的状态<strong class="ky ir">，如果它适合你的用例</strong></li><li id="9e07" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><code class="fe mp mq mr ms b">cancel</code>在完成、拒绝或解决承诺后调用。(什么都不做)。</li><li id="9fb3" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><code class="fe mp mq mr ms b">cancel</code>在执行中的任意点被多次调用。(后续调用应该什么也不做。)</li></ol><p id="6c50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记住这些场景，让我们来看一个示例实现。</p><h1 id="ef30" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">可取消承诺示例</h1><p id="6517" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">尝试将这段代码粘贴到您的浏览器控制台中。(右键单击“检查”，然后单击“控制台”选项卡。如果你用其他方式到达那里，请告诉我！)</p><p id="c02d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">捉迷藏是一种游戏，其中一个孩子数数，而其他孩子藏起来。当计数完成后,"寻找者"去找其他的孩子……假设其他的孩子都没有取消上厕所的倒计时。哪些孩子容易这样做。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="0d98" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">让我们来看看这个例子</h1><ul class=""><li id="b384" class="mt mu iq ky b kz mk lc ml lf nj lj nk ln nl lr nm mz na nb bi translated">在有机会开始之前，试着取消<strong class="ky ir">的承诺。您应该看不到任何倒计时数字:<code class="fe mp mq mr ms b">startCountingForHideAndSeek().cancel()</code></strong></li><li id="b343" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr nm mz na nb bi translated">试着在倒计时的时候<strong class="ky ir">取消承诺。你应该早点看到计数停止，承诺会拒绝:</strong></li></ul><pre class="kg kh ki kj gt nn ms no np aw nq bi"><span id="69f6" class="nr lt iq ms b gy ns nt l nu nv">const during = <!-- -->startCountingForHideAndSeek();</span><span id="fa37" class="nr lt iq ms b gy nw nt l nu nv">during<!-- -->.promise.then(() =&gt; console.log('Promise resolved.'));<br/>during.promise.catch(() =&gt; console.error('Promise rejected!'));</span><span id="ec64" class="nr lt iq ms b gy nw nt l nu nv">// Wait a bit, but not too long!</span><span id="e1cd" class="nr lt iq ms b gy nw nt l nu nv">during.cancel();</span></pre><ul class=""><li id="9f79" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr nm mz na nb bi translated">倒计时结束后，尝试取消承诺<strong class="ky ir">。您应该看不到任何事情发生(因为计数已经完成)。</strong></li></ul><pre class="kg kh ki kj gt nn ms no np aw nq bi"><span id="3933" class="nr lt iq ms b gy ns nt l nu nv">const after = startCountingForHideAndSeek();</span><span id="a6d9" class="nr lt iq ms b gy nw nt l nu nv">after.promise.then(() =&gt; console.log('Promise resolved.'));<br/>after.promise.catch(() =&gt; console.error('Promise rejected!'));</span><span id="33cc" class="nr lt iq ms b gy nw nt l nu nv">// Let the counting finish (10 seconds)</span><span id="eee3" class="nr lt iq ms b gy nw nt l nu nv">after.cancel();</span></pre><ul class=""><li id="0c96" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr nm mz na nb bi translated">尝试在任何时候多次调用<code class="fe mp mq mr ms b">cancel</code>——在执行之前、期间或之后。您应该看到第一次调用导致该行为被取消，但是接下来的调用应该安全地什么都不做。</li></ul><h1 id="f99e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><p id="f0e4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">承诺没有用于中途取消的API。要构建这个接口，如果您的异步行为支持它，您需要考虑多种场景:执行之前、期间和之后的取消，以及是否重复调用取消。</p><h2 id="00a6" class="nr lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="bf65" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们总是有兴趣帮助推广高质量的内容。如果你有一篇文章想用简单的英语提交给JavaScript，用你的中级用户名发邮件到<a class="ae kv" href="mailto:submissions@javascriptinplainenglish.com" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">submissions@javascriptinplainenglish.com</strong></a>给我们，我们会把你添加为作者。</p><p id="0276" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还推出了三种新的出版物！为我们的新出版物献上一点爱心吧，请跟随他们:<a class="ae kv" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="ky ir">AI in Plain English</strong></a>，<a class="ae kv" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="ky ir">UX in Plain English</strong></a>，<a class="ae kv" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="ky ir">Python in Plain English</strong></a><strong class="ky ir"/>——谢谢，继续学习！</p></div></div>    
</body>
</html>