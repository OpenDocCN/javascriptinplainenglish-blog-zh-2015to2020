<html>
<head>
<title>RxJS: Retry With Delay — You’ll Want to Build This Operator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RxJS:延迟重试—您将需要构建这个操作符</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/rxjs-retry-with-delay-youll-want-to-build-this-operator-3591261ff5c9?source=collection_archive---------2-----------------------#2020-08-31">https://javascript.plainenglish.io/rxjs-retry-with-delay-youll-want-to-build-this-operator-3591261ff5c9?source=collection_archive---------2-----------------------#2020-08-31</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="e908" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">在穿越RxJS的土地时，我经常发现自己渴望同一个操作员。延迟重试似乎是一种普遍需要的模式。但是在RxJS里是不是无处可寻？</h2></div><blockquote class="kc kd ke"><p id="18ce" class="kf kg kh ki b kj kk jo kl km kn jr ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">你可能是来寻求快速解决方案的。npm包<a class="ae lc" href="https://www.npmjs.com/package/rxjs-boost" rel="noopener ugc nofollow" target="_blank"> rxjs-boost </a>已经提供了一个<code class="fe ld le lf lg b">retryWithDelay</code>操作符(也已经过全面测试。)</p></blockquote><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/c48ba062c16689dc32d003db2e171ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h1QL6_9LTsZRi-ht"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk">Photo by <a class="ae lc" href="https://unsplash.com/@alschim?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alexander Schimmeck</a> on <a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="6f21" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated">运营商应该怎么做？</h1><p id="4bba" class="pw-post-body-paragraph kf kg in ki b kj mp jo kl km mq jr ko mr ms kr ks mt mu kv kw mv mw kz la lb ig bi translated">它应该重试<code class="fe ld le lf lg b">x</code>次，延迟<code class="fe ld le lf lg b">y</code>。在回顾其他方法时，我提出了这些明确的标准:</p><ol class=""><li id="9be1" class="mx my in ki b kj kk km kn mr mz mt na mv nb lb nc nd ne nf bi translated">如果出现错误，重试<code class="fe ld le lf lg b">x</code>次。</li><li id="9aa5" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">每次重试前有一个<code class="fe ld le lf lg b">y</code>的延迟。</li><li id="f516" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">如果没有错误发生，就像它不存在一样发出。</li><li id="efc8" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">在超过<code class="fe ld le lf lg b">x</code>尝试次数的情况下发出上一次抛出的错误。很多解决方案都在为此苦苦挣扎。</li></ol><h1 id="130e" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated">我们将使用什么来构建操作符？</h1><p id="241e" class="pw-post-body-paragraph kf kg in ki b kj mp jo kl km mq jr ko mr ms kr ks mt mu kv kw mv mw kz la lb ig bi translated">我们将把4个现有的RxJS操作符放在一起构建我们自己的<code class="fe ld le lf lg b">retryWithDelay</code>操作符:</p><ul class=""><li id="46bc" class="mx my in ki b kj kk km kn mr mz mt na mv nb lb nl nd ne nf bi translated"><a class="ae lc" href="https://rxjs-dev.firebaseapp.com/api/operators/retryWhen" rel="noopener ugc nofollow" target="_blank"> retryWhen </a>:镜像源可观测值。将错误映射到作为参数提供的通知程序函数中。如果通知函数发出一个值，则操作符重新订阅源可观测值。转发通知程序函数的错误和完成。</li><li id="4052" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nl nd ne nf bi translated"><a class="ae lc" href="https://rxjs-dev.firebaseapp.com/api/operators/scan" rel="noopener ugc nofollow" target="_blank">扫描</a>:对发射值应用累加器功能。提供对累加器函数的最后一个值的访问。</li><li id="2d7f" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nl nd ne nf bi translated"><a class="ae lc" href="https://rxjs-dev.firebaseapp.com/api/operators/map" rel="noopener ugc nofollow" target="_blank">轻击</a>:对每一项进行一次副作用。</li><li id="7224" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nl nd ne nf bi translated"><a class="ae lc" href="https://rxjs-dev.firebaseapp.com/api/operators/delay" rel="noopener ugc nofollow" target="_blank">延迟</a>:将接收到的项目延迟给定的超时时间。</li></ul><h1 id="9451" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated">我们如何构建我们的自定义操作符？</h1><p id="1c17" class="pw-post-body-paragraph kf kg in ki b kj mp jo kl km mq jr ko mr ms kr ks mt mu kv kw mv mw kz la lb ig bi translated">我们将把可观察到的输入输入到<code class="fe ld le lf lg b">retryWhen</code>操作符中。在这里，我们重用了另外3个运算符:</p><ol class=""><li id="1a7c" class="mx my in ki b kj kk km kn mr mz mt na mv nb lb nc nd ne nf bi translated">首先，我们使用<code class="fe ld le lf lg b">scan</code>计算操作员重试的次数。我们将每次增加一个计数。我们还会每次覆盖错误属性，并跟踪最后一个错误:</li></ol><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nm nn l"/></div></figure><blockquote class="kc kd ke"><p id="a205" class="kf kg kh ki b kj kk jo kl km kn jr ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated"><code class="fe ld le lf lg b">MonoTypeOperatorFunction</code>类型描述了一个RxJS操作符，它不修改管道的值类型。正是我们需要的！</p></blockquote><p id="d6a6" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">2.接下来，如果超过了最大重试次数，我们需要抛出最后一个错误。金额由<code class="fe ld le lf lg b">count</code>参数提供。我们可以使用<code class="fe ld le lf lg b">tap</code>操作符抛出一个错误:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="e1a6" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">3.此时，我们已经有了一个工作的<code class="fe ld le lf lg b">retry</code>参数。我们只需要添加<code class="fe ld le lf lg b">delay</code>操作符。我们已经有一个参数叫做<code class="fe ld le lf lg b">delay</code>。为了防止名称隐藏，我们可以将导入重命名为<code class="fe ld le lf lg b">delayOperator</code>。然后简单地将它连接到我们的管道上:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl no np hr nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ig ih ii ij ik"><h1 id="e383" class="lx ly in bd lz ma nv mc md me nw mg mh jt nx ju mj jw ny jx ml jz nz ka mn mo bi translated">尝试一下🎉</h1><p id="07b2" class="pw-post-body-paragraph kf kg in ki b kj mp jo kl km mq jr ko mr ms kr ks mt mu kv kw mv mw kz la lb ig bi translated">尝试它很简单。下面的脚本会一直抛出一个错误，直到<code class="fe ld le lf lg b">i</code>至少为4。控制台输出显示每个执行都被传入的参数延迟了。此外，计数选项工作完美！</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk">We use the <a class="ae lc" href="https://rxjs-dev.firebaseapp.com/api/index/function/defer" rel="noopener ugc nofollow" target="_blank">defer</a> operator here to make sure the observable is newly created on each subscription. You could use <a class="ae lc" href="https://www.npmjs.com/package/ts-node" rel="noopener ugc nofollow" target="_blank">ts-node</a> to execute this script.</figcaption></figure><p id="f98b" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated"><strong class="ki io"> retryWithDelay(1000，3): </strong></p><pre class="li lj lk ll gt oa lg ob oc aw od bi"><span id="125b" class="oe ly in lg b gy of og l oh oi">Start at 1<br/>Start at 1009<br/>Start at 2011<br/>Start at 3011<br/>Error at 3011</span></pre><p id="8107" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated"><strong class="ki io"> retryWithDelay(2000，4): </strong></p><pre class="li lj lk ll gt oa lg ob oc aw od bi"><span id="79ec" class="oe ly in lg b gy of og l oh oi">Start at 2<br/>Start at 2011<br/>Start at 4012<br/>Start at 6016<br/>Start at 8017<br/>Complete at 8018</span></pre><h2 id="ecb3" class="oe ly in bd lz oj ok dn md ol om dp mh mr on oo mj mt op oq ml mv or os mn ot bi translated">那么，就我们的起始标准而言，我们的表现如何？</h2><ol class=""><li id="bee8" class="mx my in ki b kj mp km mq mr ou mt ov mv ow lb nc nd ne nf bi translated">如果出现错误，重试<code class="fe ld le lf lg b">x</code>次。✅</li><li id="43a2" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">每次重试前有一个延迟<code class="fe ld le lf lg b">y</code>。✅</li><li id="511a" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">如果没有错误发生，就像它不存在一样发出。✅</li><li id="d127" class="mx my in ki b kj ng km nh mr ni mt nj mv nk lb nc nd ne nf bi translated">在超过<code class="fe ld le lf lg b">x</code>尝试次数的情况下，发出上一次抛出的错误。许多解决方案都在努力解决这个问题。✅</li></ol><blockquote class="kc kd ke"><p id="3e0b" class="kf kg kh ki b kj kk jo kl km kn jr ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">太好了，看来我们完成了！</p></blockquote><h1 id="8388" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated">额外收获:全面的测试覆盖</h1><p id="3de9" class="pw-post-body-paragraph kf kg in ki b kj mp jo kl km mq jr ko mr ms kr ks mt mu kv kw mv mw kz la lb ig bi translated">在某些时候，您可能希望在某些生产环境中使用它。您很有希望进行测试，并且也想测试这段漂亮的代码？</p><p id="27f4" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">我掩护你。<a class="ae lc" href="https://github.com/NiklasPor/rxjs-boost/blob/master/src/operators/retry-with-delay.spec.ts" rel="noopener ugc nofollow" target="_blank"> <strong class="ki io">该文件</strong> </a>包含了完整的测试覆盖(包括延迟等。操作员<a class="ae lc" href="https://github.com/NiklasPor/rxjs-boost/blob/master/src/operators/retry-with-delay.spec.ts" rel="noopener ugc nofollow" target="_blank">的)。</a>只需从那里复制粘贴即可。测试使用的是<a class="ae lc" href="https://www.npmjs.com/package/rxjs-marbles" rel="noopener ugc nofollow" target="_blank"> rxjs-marbles </a>，所以如果你使用不同的弹球库，你可能需要做一些调整。</p></div><div class="ab cl no np hr nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ig ih ii ij ik"><p id="173f" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">谢谢你一直坚持到我的文章结束。您刚刚创建了自己的RxJS操作符——甚至是一个非常有用的操作符！如果你发现自己有任何未解决的问题，请随时在Twitter上联系我或者发表评论👏</p><p id="2131" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">祝您愉快！</p><p id="4804" class="pw-post-body-paragraph kf kg in ki b kj kk jo kl km kn jr ko mr kq kr ks mt ku kv kw mv ky kz la lb ig bi translated">尼克拉斯</p></div></div>    
</body>
</html>