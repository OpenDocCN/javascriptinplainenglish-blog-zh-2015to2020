<html>
<head>
<title>React Native — Native Modules With Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Swift反应本地-本地模块</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-native-native-modules-with-swift-6768ea03b3f?source=collection_archive---------0-----------------------#2019-11-03">https://javascript.plainenglish.io/react-native-native-modules-with-swift-6768ea03b3f?source=collection_archive---------0-----------------------#2019-11-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/15b3d708592d430fdb8d17ec9003f4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WLNNomhONO7lQ9itTV2p6Q.jpeg"/></div></div></figure><h1 id="3326" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="7392" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用原生模块和访问iOS原生库似乎是一项艰巨的任务，但事实并非如此。这可能需要一些时间来适应，但它并不像你想象的那么难。只是一个公平的警告，你将不得不与Objective-C和Swift合作。</p><p id="f8fc" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我的原生模块之旅始于我自愿为React Native创建一个与Swift SDK交互的模块的工作。这个教程不会和我工作中的项目有关，但是会是一个会播放一个. wav文件的模块。我将向您展示如何创建一个模块来利用iOS中的AVAudioPlayer库。</p><h1 id="1c98" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">基本设置</h1><p id="4b92" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们从一个我们可以使用的示例项目开始创建我们的本机模块。</p><p id="a831" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">第一步是获得React Native <a class="ae lz" href="https://facebook.github.io/react-native/docs/native-modules-setup" rel="noopener ugc nofollow" target="_blank">文档</a>中使用的create-react-native-module工具。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="89a4" class="mj jz iq mf b gy mk ml l mm mn">Yarn global add creat-react-native-module</span></pre><h1 id="18f2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">创建我们的项目</h1><p id="4539" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在我们安装了create-react-native-module之后，是时候创建我们的本机模块项目了。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5875" class="mj jz iq mf b gy mk ml l mm mn">Create-react-native-module --package-indentifier io.myaudiolibrary ---generate-example AudioHelper.</span></pre><p id="50a0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">您现在将拥有一个名为<strong class="ky ir">react-native-audio-helper</strong>的项目目录，其中包含另一个项目的<strong class="ky ir">示例</strong>子文件夹。</p><p id="8ff3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">根文件夹<strong class="ky ir">react-native-audio-helper</strong>是我们将创建的本机模块，而<strong class="ky ir">示例</strong>文件夹是我们将用来访问本机模块的项目。</p><p id="0f33" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果您不做任何修改就运行示例项目，它将如下所示:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/c819ac5e839f8f60f8b158e7bd0a553e.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*QoNMg9-Nl0lRAV5o2RRIdg.png"/></div></figure><h1 id="df91" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">沟通目标-C和Swift</h1><p id="1441" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们开始创建Objective-C和Swift之间的桥梁。</p><p id="935e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">进入<strong class="ky ir">react-native-audio-helper/IOs</strong>文件夹，使用XCode打开名为<code class="fe mp mq mr mf b">AudioHelper.xcodeproj</code>的代码项目。</p><p id="15e3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们应该做的第一件事是在<code class="fe mp mq mr mf b">AudioHelper.m</code>的顶部插入<code class="fe mp mq mr mf b">#import &lt;React/RCTBridgeModule.h&gt;</code>。</p><p id="50e3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们将删除<code class="fe mp mq mr mf b">AudioHelper.h</code>文件，但我们希望保留RCTBridgeModule头。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/7af2b0e13a5a88fcd2100acb1943e287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QphbOBlf1mQKWbUir7tDHQ.png"/></div></div></figure><p id="9b40" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">继续删除<code class="fe mp mq mr mf b">AudioHelper.h</code>，点击“移至垃圾桶按钮”。</p><p id="5f3d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">是时候创建一个swift文件了，创建一个桥接头文件，将Objective-C文件暴露给Swift。苹果在这里提供了一个体面的解释。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/5460e69a0f862a260bf9b91de45efc23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*8abX1HeD5t-RD2KWk0IBeQ.png"/></div></figure><p id="ca94" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">文件-&gt;新建-&gt;Swift并将其命名为<code class="fe mp mq mr mf b">AudioHelper.swift</code>，点击<strong class="ky ir">创建桥头</strong>，这将创建两个新文件:</p><p id="ab08" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe mp mq mr mf b">AudioHelper.swift</code></p><p id="5fa0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe mp mq mr mf b">AudioHelper-Bridging-Header.h</code></p><p id="f2a8" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">将此代码复制并粘贴到AudioHelper中。swift:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="fe9f" class="mj jz iq mf b gy mk ml l mm mn"><strong class="mf ir">var</strong> player: AVAudioPlayer?</span><span id="eab1" class="mj jz iq mf b gy mu ml l mm mn"><strong class="mf ir">@objc(AudioHelper)<br/>class</strong> AudioHelper: NSObject {<br/>   <br/>   <strong class="mf ir">@objc(playSound:)<br/>   func</strong> playSound(url: String) {<br/>      <strong class="mf ir">guard</strong> <strong class="mf ir">let</strong> url = URL.init(string: url) <strong class="mf ir">else</strong> { <strong class="mf ir">return</strong> }<br/>      <strong class="mf ir">do</strong> {<br/>         <strong class="mf ir">if</strong> <strong class="mf ir">#available</strong>(<strong class="mf ir">iOS</strong> 10.0, *) {<br/>            <strong class="mf ir">try </strong>AVAudioSession.sharedInstance()<br/>                .setCategory(.playback, mode: .default)<br/>         } <strong class="mf ir">else</strong> {<br/>            // Fallback on earlier versions<br/>         }</span><span id="1279" class="mj jz iq mf b gy mu ml l mm mn"><strong class="mf ir">         try</strong> AVAudioSession.sharedInstance().setActive(<strong class="mf ir">true</strong>)<br/>         /* The following line is required for the player to work on iOS 11. Change the file type accordingly*/</span><span id="cc65" class="mj jz iq mf b gy mu ml l mm mn">         player = <strong class="mf ir">try</strong> AVAudioPlayer(contentsOf: url, fileTypeHint: AVFileType.mp3.rawValue)</span><span id="e0a9" class="mj jz iq mf b gy mu ml l mm mn">         /* iOS 10 and earlier require the following line:<br/>         player = try AVAudioPlayer(contentsOf: url, fileTypeHint: AVFileTypeMPEGLayer3) */</span><span id="8532" class="mj jz iq mf b gy mu ml l mm mn"><strong class="mf ir">         guard</strong> <strong class="mf ir">let</strong> player = player <strong class="mf ir">else</strong> { <strong class="mf ir">return</strong> }<br/>         player.play()<br/>      } <strong class="mf ir">catch</strong> <strong class="mf ir">let</strong> error {<br/>      print(error.localizedDescription)<br/>      }<br/>   }<br/>}</span></pre><p id="2212" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果您不熟悉Objective-C或swift，那么在Swift代码中使用<code class="fe mp mq mr mf b">@objc</code>语法是连接两种语言的关键。将<code class="fe mp mq mr mf b">@objc</code>放在swift类或函数之前会将其暴露在Objective-C方面。</p><p id="f051" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">AudioHelper.m应该是这样的:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="a097" class="mj jz iq mf b gy mk ml l mm mn"><strong class="mf ir">@interface</strong> RCT_EXTERN_MODULE(AudioHelper, NSObject)</span><span id="3ac9" class="mj jz iq mf b gy mu ml l mm mn">   RCT_EXTERN_METHOD(playSound:(NSString *)url)</span><span id="79f1" class="mj jz iq mf b gy mu ml l mm mn"><strong class="mf ir">@end</strong></span></pre><p id="a535" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">RCT _外部_模块</strong>和<strong class="ky ir">RCT _外部_方法</strong>宏暴露了<code class="fe mp mq mr mf b">AudioHelper</code> swift类和<code class="fe mp mq mr mf b">playSound</code>函数来对本机和Javascript做出反应。</p><p id="c911" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">保存项目后，我们将进入示例文件夹并重新安装新的更改:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="401f" class="mj jz iq mf b gy mk ml l mm mn">rm -rf node_modules &amp;&amp; yarn install</span></pre><p id="ea8f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这将把我们在AudioHelper模块中所做的更改更新到我们将要测试的示例项目中。</p><h1 id="1630" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">桥接Objective-C和JavaScript</h1><p id="904f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果您已经习惯了使用Native，那么Javascript部分非常简单。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8456" class="mj jz iq mf b gy mk ml l mm mn">import React, { Component } from ‘react’;<br/>import { Platform, StyleSheet, Text, View } from ‘react-native’;<br/>import AudioHelper from ‘react-native-audio-helper’;</span><span id="9c1c" class="mj jz iq mf b gy mu ml l mm mn">export default class App extends Component&lt;{}&gt; {</span><span id="13c6" class="mj jz iq mf b gy mu ml l mm mn">   componentDidMount() {<br/>      AudioHelper.playSound(“/Directory/To/Some/Mp3/Music.mp3”);<br/>   }</span><span id="e91d" class="mj jz iq mf b gy mu ml l mm mn">   render() {<br/>      return (<br/>         &lt;View style={styles.container}&gt;<br/>            &lt;Text style={styles.welcome}&gt;☆AudioHelper    example☆&lt;/Text&gt;<br/>         &lt;/View&gt;);<br/>   }<br/>}</span><span id="2624" class="mj jz iq mf b gy mu ml l mm mn">const styles = StyleSheet.create({<br/>   container: {<br/>      flex: 1,<br/>      justifyContent: ‘center’,<br/>      alignItems: ‘center’,<br/>      backgroundColor: ‘#F5FCFF’,<br/>   },<br/>});</span></pre><p id="a389" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我在这里做的是最小化自动生成的与我们的应用程序一起工作的示例项目。</p><p id="0129" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">代码中最重要的部分是import语句:</p><p id="9022" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">从<code class="fe mp mq mr mf b">react-native-audio-helper;</code>导入<strong class="ky ir"> AudioHelper </strong></p><p id="018d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以及调用本地函数调用来播放音频文件:</p><p id="051e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe mp mq mr mf b">AudioHelper.playSound(“/Directory/To/Some/Mp3/Music.mp3”);</code></p><p id="68d8" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">确保你有一个可以播放的音频文件来测试这个应用。我只是用了我硬盘上的一首旧曲目。</p><h1 id="6f11" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">思想</h1><p id="469a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">本教程只是创建React Native-Native模块的第一步。这足以让您入门，但它有局限性，因为它只允许您从Javascript-&gt;Swift进行调用。我计划写更多关于本机模块的教程，包括回调、事件和线程等主题。</p><h2 id="6830" class="mj jz iq bd ka mv mw dn ke mx my dp ki lh mz na km ll nb nc kq lp nd ne ku nf bi translated">继续学习…</h2><ul class=""><li id="528e" class="ng nh iq ky b kz la ld le lh ni ll nj lp nk lt nl nm nn no bi translated"><a class="ae lz" href="https://medium.com/@richardpetrov/react-native-native-modules-callbacks-in-swift-db627876e20f" rel="noopener">本机模块回调</a></li></ul></div></div>    
</body>
</html>