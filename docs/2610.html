<html>
<head>
<title>NestJS Serverless App with MongoDB Atlas and AWS Secret Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有MongoDB Atlas和AWS Secret Manager的NestJS无服务器应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/nestjs-serverless-app-with-mongodb-atlas-e8dec9ae7405?source=collection_archive---------1-----------------------#2020-07-09">https://javascript.plainenglish.io/nestjs-serverless-app-with-mongodb-atlas-e8dec9ae7405?source=collection_archive---------1-----------------------#2020-07-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a179063397c5e8475a9ab5e06a6742f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4rAY6QiZurz86uXcNyoow.png"/></div></div></figure><p id="193c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如AWS提到的，无服务器是创建和部署应用程序的一种经济有效的方式，您可以创建任何类型的后端应用程序，并使用API网关的优势来连接您的前端或您需要的任何其他服务。</p><p id="6d61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本指南是在AWS环境下用NestJS，Serverless和MondoDB Atlas创建一个无服务器应用程序。为了澄清我将使用图像来共享代码，我更喜欢这种方式，因为它更容易阅读，所以当你编码时要小心。</p><p id="24a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几周前我开始使用serverless，我爱上了它，我在NestJS中开发后端(顺便说一下，我也喜欢，请尝试一下)。所以我想把这两种技术结合起来，我做了一些研究，事实上serverless.com创造了一种连接这两种技术的方法，所以我把我的测试建立在这个基础上。</p><p id="bc38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这个指南对你有用，如果你有任何问题或疑问，请联系我。</p><h1 id="2703" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">为什么没有服务器？</h1><p id="29b8" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">无服务器是云的原生架构，使您能够将更多的运营责任转移到AWS，从而提高您的敏捷性和创新性。无服务器允许您构建和运行应用程序和服务，而无需考虑服务器。它消除了基础架构管理任务，如服务器或群集配置、修补、操作系统维护和容量配置。您可以为几乎任何类型的应用程序或后端服务构建它们，并且为您处理运行和扩展具有高可用性的应用程序所需的一切。</p><h1 id="d60d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">为什么使用无服务器？</h1><p id="7a85" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">无服务器使您能够以更高的灵活性和更低的总拥有成本构建<a class="ae lz" href="https://aws.amazon.com/modern-apps/" rel="noopener ugc nofollow" target="_blank">现代应用</a>。构建无服务器应用程序意味着您的开发人员可以专注于他们的核心产品，而不用担心管理和操作服务器或运行时，无论是在云中还是在本地。这种减少的开销让开发人员可以节省时间和精力，用于开发可扩展且可靠的优秀产品。</p><p id="1d99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">【https://aws.amazon.com/serverless/ T4】</p><h1 id="c94c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">首先:</strong></h1><p id="103b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将为此使用很多不同的技术，有很多信息，所以我会尽我所能尝试恢复它，请填写免费研究链接，在这里分享更多信息。</p><h2 id="15ea" class="ma kx iq bd ky mb mc dn lc md me dp lg kj mf mg lk kn mh mi lo kr mj mk ls ml bi translated">那么我们需要什么？</h2><ol class=""><li id="de72" class="mm mn iq ka b kb lu kf lv kj mo kn mp kr mq kv mr ms mt mu bi translated">创建一个AWS帐户，您将拥有一年的免费等级。</li><li id="4593" class="mm mn iq ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">安装NestJS:<a class="ae lz" href="https://nestjs.com" rel="noopener ugc nofollow" target="_blank">https://nestjs.com</a></li><li id="a15d" class="mm mn iq ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">在MongoDB中创建一个免费帐户:<a class="ae lz" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com</a></li><li id="3791" class="mm mn iq ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">用这个例子从无服务器:<a class="ae lz" href="https://www.serverless.com/examples/aws-node-typescript-nest" rel="noopener ugc nofollow" target="_blank">https://www . server less . com/examples/AWS-node-typescript-nest</a></li><li id="a2c5" class="mm mn iq ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">我们走吧！</li></ol></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="a97f" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">AWS控制台</h1><p id="1bea" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在AWS中创建帐户后，您需要生成一个IAM角色。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/1be7d1a1ddf64d69c240384beb9957b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZffDRHPk_-fKilDcTsIgOA.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk">IAM Roles AWS</figcaption></figure><p id="a346" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">IAM角色在AWS中是全局的，转到用户并创建一个新用户，我强烈建议这样做，不要使用您的根用户。你可以遵循这个指南，它会解释一切。</p><div class="nv nw gp gr nx ny"><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">在您的AWS帐户中创建IAM用户</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">您可以在AWS帐户中创建一个或多个IAM用户。当有人加入您的团队时，您可能会创建一个IAM用户，或者…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om jw ny"/></div></div></a></div><p id="0add" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">重要！保管好您的访问密钥和秘密密钥，您将在接下来的步骤中需要它。</strong></p><p id="d92e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开您的终端并安装AWS-CLI:<a class="ae lz" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/CLI-chap-install . html</a></p><p id="5a16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你完成了所有的安装，就该编码了！</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="39d3" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">编码时间到了</h1><h2 id="c113" class="ma kx iq bd ky mb mc dn lc md me dp lg kj mf mg lk kn mh mi lo kr mj mk ls ml bi translated"><strong class="ak"> 1。打开您的终端并运行这个命令:</strong></h2><pre class="nn no np nq gt on oo op oq aw or bi"><span id="158c" class="ma kx iq oo b gy os ot l ou ov">aws configure</span></pre><p id="f7a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">插入您的凭据并按照步骤操作。</p><h2 id="ec15" class="ma kx iq bd ky mb mc dn lc md me dp lg kj mf mg lk kn mh mi lo kr mj mk ls ml bi translated"><strong class="ak"> 2。创建项目</strong></h2><p id="2572" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">为此项目创建一个文件夹，并运行以下命令:</p><pre class="nn no np nq gt on oo op oq aw or bi"><span id="8bb3" class="ma kx iq oo b gy os ot l ou ov">npm install serverless -g</span><span id="0ef3" class="ma kx iq oo b gy ow ot l ou ov">serverless install -u https://github.com/serverless/examples/tree/master/aws-node-typescript-nest -n  aws-node-typescript-nest</span><span id="ab6c" class="ma kx iq oo b gy ow ot l ou ov">npm start</span></pre><p id="289c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令将创建并启动NestJS无服务器应用程序，您也可以遵循该页面上的步骤:<a class="ae lz" href="https://www.serverless.com/examples/aws-node-typescript-nest" rel="noopener ugc nofollow" target="_blank">https://www . server less . com/examples/AWS-node-typescript-nest</a></p><p id="1bdb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用带有GET to<a class="ae lz" href="http://localhost:3000/hello" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/hello</a>的Postman测试它。如果你得到回应，我们就ok了！我们继续吧。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ox"><img src="../Images/88ac77e507a6ee4494352da4a37ebb92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p4Tj6Yhe8NxPlaPSb9Impg.png"/></div></div></figure><h2 id="b157" class="ma kx iq bd ky mb mc dn lc md me dp lg kj mf mg lk kn mh mi lo kr mj mk ls ml bi translated"><strong class="ak"> 3。在AWS中部署无服务器项目</strong></h2><p id="0ee0" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">运行此命令，这将部署无服务器应用程序。创建Lambda函数，CloudWatch for logs，S3，项目的API网关和所有需要的资源。</p><p id="0941" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此命令将识别您的AWS凭据，并完成创建环境的工作。</p><pre class="nn no np nq gt on oo op oq aw or bi"><span id="baab" class="ma kx iq oo b gy os ot l ou ov">sls deploy</span></pre><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oy"><img src="../Images/bbf197481cacb46e4c39f3afd7f8d889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pM1Ci6toYKXmMj1k12vjsw.png"/></div></div></figure><p id="44cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这需要一些时间，一旦完成，你会看到这个。复制端点并像我们之前做的那样粘贴到Postman中，并将<strong class="ka ir">“{ proxy+}”</strong>替换为<strong class="ka ir">“hello”</strong>。你会收到同样的回应，完美！</p><p id="103a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以为您的应用程序创建更多的模块和端点。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="d0ec" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated"><strong class="ak">部署MongoDB Atlas </strong></h1><p id="3e0e" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在这里你可以创建一个免费的账户来创建你的数据库:<a class="ae lz" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com</a></p><p id="d64c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个免费层，您可以使用它进行测试，在us-east-1地区创建集群，并将AWS作为提供商。小心创建群集，确保选择空闲层。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oz"><img src="../Images/77853ed0c42c840ff007b7652dda1013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cpiu2Y43ra4NTBiK9UgMGA.png"/></div></div></figure><p id="5de8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建集群后，转到create database并创建一个名为test的新集合。<strong class="ka ir">您也需要为集群创建一个用户，确保提供读写权限并记住密码。</strong></p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pa"><img src="../Images/2bc19e8ab04d9e5f75a3841c2f0bc9a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOULVALtbIOkO5zMGCdDPQ.png"/></div></div></figure><p id="9aee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后转到网络访问并添加来自anyware(0 . 0 . 0 . 0/0)的访问，这对于让我们的应用程序获得数据库非常重要，您也可以添加您当前的IP地址进行测试。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pb"><img src="../Images/a033278eab8e5fc01ac66891353dd65f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E9Fliw31zuQ8Ba07cd5Ruw.png"/></div></div></figure><p id="a66a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击Confirm，就完成了，我们准备好将我们的应用程序连接到我们的NestJS Serverless。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="fdc7" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">创建配置模块</h1><p id="c92f" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">现在，我们已经准备好将应用程序连接到MongoDB。我强烈推荐使用AWS中的Secrets Manager来存储您的数据库连接。</p><p id="1e23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要创建两个文件，config.service.ts和config.module.ts。</p><p id="9983" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的config.module.ts应该如下所示:</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/d0e015ac00abbe32f3bd4cc465fc8533.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*Ef9dFpmvaR06NcWF3fvnhg.png"/></div></figure><p id="30dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的config.service.ts应该如下所示:</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/c6bddf9f253727f8b6d98da1970cbb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*XGyQ-YfxGl5vZ_NFQ42jSg.png"/></div></figure><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/fd8a08aca44087d9c1742d82724cd755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*Q7J9g6KUuBiuqLASoPuJKA.png"/></div></figure><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pe"><img src="../Images/f125fd9d9a200eb3021321717ba4e5a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yk38cdrZGaagzvQj8DGfDg.png"/></div></div></figure><p id="811b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个config.service.ts获取您的环境变量，并验证您是否通过SDK连接到AWS，所以基本上，如果您没有连接到AWS，它将获取您的本地环境变量，否则它将获取在Secret Manager上定义的变量。</p><p id="4c88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">get方法创建环境变量。这取决于构造函数。</p><p id="f8cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">getMongoConfig()使用Secret Manager变量创建到数据库的连接。</p><p id="21ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">upAWSConfig()完成这项工作。一旦你创建了你的密码，你可以在密码管理器文档中找到这个函数。</p><p id="f232" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了，我们就快到了，现在我们需要将我们的config.service.ts导入到我们的app.module.ts中。这是您的app.module.ts的配置方式。您可以看到我使用NestJS中的MongooseModule，并创建一个到数据库的异步连接，从注入configService的ConfigService调用getMongoConfig()。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/b24873b826e73c92e2e0df78f09247f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*TUlmwB-_mEQ26R-0MMZ2iA.png"/></div></figure><p id="d7c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们准备好出发了。我们更新了数据库、配置模块和app.module.ts。现在是时候创建连接并部署我们的服务了。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="a9d4" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">AWS机密管理器</h1><p id="37c8" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">到你的AWS控制台，然后到秘密管理器，创建一个新的秘密:<em class="pg">(对不起，我的AWS控制台是西班牙语)</em>。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/b8db052a07593e68163a3301123fad06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DTLOhxpIdbmxlCpz1fcYyw.png"/></div></div></figure><p id="6eaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，您添加了您的秘密MONGO_DB，为此，有不同的方法连接到您的MongoDB Atlas，我尝试了几次以不同的方式连接，我没有成功，所以如果您以不同的方式实现它，请在评论中与我分享。我相信是因为NestJS的MongooseModule。</p><p id="3281" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的理想应该是创建MONGO_USER、MONGO_HOST、MONGO_PASSWORD和MONGO_DATABASE。相反，我们将使用一个MONGO_DB secret进行测试。</p><p id="68ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到您的MongoDB Atlas帐户，转到您的集群并单击连接按钮。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pi"><img src="../Images/e3a55d898a5fb7b15a829cca77a16baa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JJdK6Ph7DaWwF4DhZ5UdcQ.png"/></div></div></figure><p id="7374" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是破解方法，点击“使用MongoDb Compass连接”。选择1.11或更低版本，并复制连接字符串。大概是这样的:</p><pre class="nn no np nq gt on oo op oq aw or bi"><span id="08be" class="ma kx iq oo b gy os ot l ou ov">mongodb://<strong class="oo ir">username</strong>:<strong class="oo ir">&lt;password&gt;</strong><a class="ae lz" href="http://twitter.com/testingscluster" rel="noopener ugc nofollow" target="_blank">@</a>clustername.mongodb.net:27017,clustername.mongodb.net:27017,clustername.mongodb.net:27017/<strong class="oo ir">test</strong>?replicaSet=TestingsCluster-shard-0&amp;ssl=true&amp;authSource=admin</span></pre><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pi"><img src="../Images/da064b185cef7933b6c55988a552b21e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OV1e6GTNUjXJuBbnvc2hXw.png"/></div></div></figure><p id="c18b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制字符串，替换您在MongoDB集群中创建的名称的“username ”,还替换“<password>”,最后替换您之前创建的数据库中集合名称的“test”。</password></p><p id="08bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在AWS Secret Manager中，将字符串粘贴到您的Secret值中，</strong>单击“下一步”，您将看到要使用的不同SDK，在那里您可以找到您会注意到的Javascript，它与我们在config.service.ts中创建的代码很相似。(无需复制此代码，我们的代码会完成这项工作)。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="a5f1" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">一些重要的配置！</h1><p id="764e" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们终于如此接近了！现在让我们在我们的serverless.yml中工作。</p><p id="b9bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在这里测试了一些东西，与我之前分享的NestJS无服务器模板的链接有些不同。</p><p id="0c1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的package.json中，您需要添加/替换这些包:</p><pre class="nn no np nq gt on oo op oq aw or bi"><span id="70b7" class="ma kx iq oo b gy os ot l ou ov">“serverless-offline”: “^5.12.1”,</span><span id="920c" class="ma kx iq oo b gy ow ot l ou ov">“serverless-plugin-optimize”: “^4.0.2-rc.1”,</span><span id="6f34" class="ma kx iq oo b gy ow ot l ou ov">“serverless-plugin-typescript”: “1.1.9”,</span></pre><p id="53ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您也可以毫无问题地将NestJS依赖项更新到7.x。记得也加上猫鼬和@ nestjs/mongose。如果您更新您的依赖项，请小心，您的main.ts中会有一个错误，所以如果您想要更新嵌套的依赖项，您的package.json依赖项应该如下所示:</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pj"><img src="../Images/20b928fa40d563b08b07e5f51aee148b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*qIKiNuknbT1yuA1meQ3LUg.png"/></div></div></figure><p id="7a4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">请记住，依赖关系可能因项目而异！</strong></p><p id="642c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，如果您继续使用我，您需要对您的main.ts进行一些更改，以便在NestJS中使用express。这里可以看到bootstrapServer()函数与Serverless发布的模板有点不同。基本上，您将使用<strong class="ka ir">“新的ExpressAdapter(expressApp)。然后返回cachedServer。</strong></p><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/bec855fe2733409f5a272f99616ac85c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*-1-GfpCj5iQuXiz9iuXqRQ.png"/></div></figure></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="c920" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated"><strong class="ak"> ARN IAM角色兼AWS秘密经理</strong></h1><p id="273a" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">最后一步，您需要创建一个角色来管理机密，并使用提供的“arn”将它分配给您的无服务器应用程序。</p><p id="e521" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到您的IAM并单击“创建新角色”。单击下一步。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pl"><img src="../Images/36bdd84c3df789c2a4e842e0ca301f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q9XHrFSd0cJ319SXLxAhHQ.png"/></div></div></figure><p id="9876" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并附上Secrets Manager的策略。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pm"><img src="../Images/5793d33272e2607d7641ba300f8dfa24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zxrRPPMVe1e9xyNBgo1s0A.png"/></div></div></figure><p id="e3a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击next直到结束，然后单击您创建的角色并复制arn。</p><p id="c2c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你需要从秘密管理器中复制你的arn，进入AWS秘密管理器，点击你的秘密并复制arn。</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pn"><img src="../Images/0607af3b4b11a7e6f3dd7be8a8faa0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C1XEU2G7DwzddXfYGayAhg.png"/></div></div></figure></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="2fa4" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">终于！Serverless.yml和部署！</h1><p id="6d85" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">谢谢你，如果你还在读这篇文章，我花了一些时间解决了许多关于NestJS和无服务器的问题，但是现在我们在这里。</p><p id="5690" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要修改我们的serverless.yml</p><figure class="nn no np nq gt jr gh gi paragraph-image"><div class="gh gi po"><img src="../Images/8f6c40e22e1b36ddf1437ccbeafcf251.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*Zywrq6kTSHLvj4PvoQkwuQ.png"/></div></figure><p id="8a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，注意插件，它们和serverless.com的模板有点不同</p><p id="b6d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您需要在AWS控制台中创建一个IAM角色，可以访问您的Secret Manager。创建角色后，复制arn并将其添加到您的“角色:”中。</p><p id="7465" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建AWS_ACTIVE变量，该变量为true，将告诉我们的config.service.ts我们希望使用AWS Secrets Manager而不是本地环境。</p><p id="ca16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加您的区域和SECRET_NAME(您在AWS控制台中创建的名称)</p><p id="65b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，添加<strong class="ka ir"> iamRoleStatements，</strong>这里您需要从您创建的秘密中粘贴<strong class="ka ir">“arn”</strong>。</p><p id="1f56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样，我们准备再次运行命令:</p><pre class="nn no np nq gt on oo op oq aw or bi"><span id="856a" class="ma kx iq oo b gy os ot l ou ov">sls deploy</span></pre><p id="4c1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将部署您的应用程序，如果一切正常，您现在连接到您的数据库，您可以使用抛出sls deploy命令的url测试Lambda。</p><p id="1cc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以现在你只需要实现一个新的模块一个接口和模式来在你的MongoDB中创建对象。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="5b2d" class="kw kx iq bd ky kz nh lb lc ld ni lf lg lh nj lj lk ll nk ln lo lp nl lr ls lt bi translated">结论</h1><p id="404c" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在没有服务器的情况下，无服务器是一种非常强大的开发方式，我意识到如果你将它与其他一些框架和技术结合起来，结果基本上是没有限制的。</p><p id="d3ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这个指南对你有所帮助，我试着用很多例子来说明它，现在享受你的应用程序，如果你有任何问题或疑问，请联系我。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="817e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随时联系我！</p><p id="16e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lz" href="https://www.linkedin.com/in/carlos-villarroel-navarro/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/carlos-villarroel-navarro/</a></p></div></div>    
</body>
</html>