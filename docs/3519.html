<html>
<head>
<title>Adding dynamic features to a static 404 page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向静态404页面添加动态功能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/adding-dynamic-features-to-a-static-404-page-1b4813026105?source=collection_archive---------16-----------------------#2020-10-05">https://javascript.plainenglish.io/adding-dynamic-features-to-a-static-404-page-1b4813026105?source=collection_archive---------16-----------------------#2020-10-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e850" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用JavaScript超越“未找到”</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a38cea6d199b687c14f01403a20d48d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*K5Je5AqFes0wOast"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kelly Sikkema</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3cc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我最近写了一篇关于<a class="ae kv" href="https://medium.com/javascript-in-plain-english/adding-dynamic-features-to-a-static-site-cf56ff7b163a" rel="noopener">给静态网站</a>添加动态特性的文章，现在我想举另一个例子:你网站的404页面。</p><p id="72ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，404页面应该是静态的，即使是在后台运行脚本语言的动态生成的站点上。这是一个错误页面，您不希望花费太多资源来应对最坏的情况。然而，我们甚至没有在静态站点上执行巧妙的服务器端处理的奢侈，所以404应该只是一些表明“未找到”的文本，对吗？不对。</p><h1 id="b20b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">基本原则</h1><p id="be37" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，您的404页面应该仍然发送404错误，而不是200 (OK)或任何重定向状态代码(3xx)，这一点很重要。通常，正如GitHub Pages 的情况一样，您的静态主机会默认启用这一功能，但这值得检查。在GitHub页面上运行意味着我只需要上传一个路径为<code class="fe mp mq mr ms b">/404.html</code>的文件，我的自定义404页面就准备好了。</p><p id="0af6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你有了一个基本的404页面，是时候考虑一下你可以在上面添加什么样的客户端功能了。我将在这里展示两种可能性:</p><ol class=""><li id="37c1" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">一些试图诊断问题的解释性文字</li><li id="53f5" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">可能是预期目标的可选页面列表</li></ol><p id="4d56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">像往常一样，我已经将这些例子的代码<a class="ae kv" href="https://github.com/bobbykjack/dynamic-static-404" rel="noopener ugc nofollow" target="_blank">上传到GitHub库</a>。</p><h1 id="f092" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">诊断</h1><p id="ea94" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了识别坏链接的来源，我们将查看<code class="fe mp mq mr ms b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/referrer" rel="noopener ugc nofollow" target="_blank">Document.referrer</a></code>属性，它告诉我们读者来自的页面的URL，前提是他们来自链接到我们的页面。</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="a6c2" class="nl lt iq ms b gy nm nn l no np">var referrer = document.referrer;</span></pre><p id="210e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你的404页面实现正确——就像在GitHub页面上一样——这将按预期工作，即使404页面本身并不是链接的实际目标。如果referrer包含一个值，我们可以将其转换为一个<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/URL" rel="noopener ugc nofollow" target="_blank"> URL </a>对象，以便进一步检查:</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="45ce" class="nl lt iq ms b gy nm nn l no np">if (ref) {<br/>    ref = new URL(ref);<br/><br/>    if (ref.hostname == curr.hostname) {<br/>        // case 1: internal link<br/>    } else {<br/>        // case 2: external link<br/>    }<br/>} else {<br/>    // case 3: insufficient info<br/>}</span></pre><p id="8cd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，我们只是通过查看<code class="fe mp mq mr ms b">hostname</code>来确定这个推荐人是我们自己的网站还是其他人的网站；这有点过于简单，但是对于我们的目的来说，这是一个合适的“站点”定义。</p><p id="18a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nq">请注意，一些浏览器可能不会在推荐人中发送外部的完整URL如果没有，他们至少应该发送完整的主机名，这比什么都没有好。</em></p><p id="bf66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里另一个有趣的部分是我们的<code class="fe mp mq mr ms b">mailto:</code>链接。这包括<code class="fe mp mq mr ms b">subject</code>和<code class="fe mp mq mr ms b">body</code>参数，全部都包含在<code class="fe mp mq mr ms b">mailto_link</code>函数中:</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="23c0" class="nl lt iq ms b gy nm nn l no np">function mailto_link(to, subject, body) {<br/>    var a = document.createElement("a"),<br/>        mail_href = "mailto:" + to<br/>            + "?subject=" + encodeURIComponent(subject)<br/>            + "&amp;body=" + encodeURIComponent(body);</span><span id="a230" class="nl lt iq ms b gy nr nn l no np">    a.setAttribute("href", mail_href);<br/>    a.appendChild(document.createTextNode("send me an email"));<br/>    return a;<br/>}</span></pre><p id="cf6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">产生的<code class="fe mp mq mr ms b">Element</code>被注入到我们的最终页面中，当我们调用这个函数时，我们传递给它一些文本，包括引用者和原始URL，例如:</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="0efa" class="nl lt iq ms b gy nm nn l no np">body = "I spotted a broken link to your site on the following "<br/>    + "URL:\n\n" + document.referrer + "\n\n"<br/>    + "It was a link to:\n\n" + window.location;</span><span id="f64d" class="nl lt iq ms b gy nr nn l no np">p.appendChild(mailto_link(to, subject, body);</span></pre><p id="0eb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这让我们的访问者有机会点击一个链接，然后立即通过电子邮件向我们发送一份“报告”,以最少的大惊小怪。你可能会在一些网站的404页面上看到类似“请联系我们并告诉我们问题”这样的内容，但是如果我们能代表读者完成大部分工作，那就更好了。</p><h1 id="519b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">建议的替代方案</h1><p id="1a1f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将在404页面上包含的另一个功能是可选页面列表。这在服务器端脚本语言中似乎是“最好”的，页面存储在数据库中，但是对于我们的静态站点，我们可以利用已经可用的页面列表:<a class="ae kv" href="https://medium.com/@bobbyjack/generating-a-sitemap-for-a-static-site-356fa3c26074" rel="noopener">我们的站点地图</a>。</p><p id="0206" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如前所述，站点地图是一个XML文档，包含我们站点的页面列表，与我们的站点内容一起托管，这使得它非常适合客户端处理。要开始使用它，使用<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" rel="noopener ugc nofollow" target="_blank"> XMLHttpRequest类</a>从服务器请求它:</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="638a" class="nl lt iq ms b gy nm nn l no np">var request = new XMLHttpRequest();<br/>request.addEventListener("load", process_sitemap);<br/>request.open("GET", "/sitemap.xml");<br/>request.send();</span></pre><p id="e632" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第二行中，<code class="fe mp mq mr ms b">process_sitemap</code>是一个回调函数的名称，一旦响应被返回，这个函数就代表我们被调用。第三行指定了我们要获取的URL:<code class="fe mp mq mr ms b">/sitemap.xml</code>。</p><p id="8e59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在回调函数中，我们可以访问sitemap <code class="fe mp mq mr ms b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document" rel="noopener ugc nofollow" target="_blank">Document</a></code>并像处理网页一样处理它；特别是，我们可以使用CSS选择器使用<code class="fe mp mq mr ms b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll" rel="noopener ugc nofollow" target="_blank">querySelectorAll()</a></code>方法获取站点地图的位置(URL ):</p><pre class="kg kh ki kj gt nh ms ni nj aw nk bi"><span id="054a" class="nl lt iq ms b gy nm nn l no np">function process_sitemap() {<br/>    var sitemap_doc = this.responseXML,<br/>        urls = sitemap_doc.querySelectorAll("urlset &gt; url &gt; loc");<br/>    ...<br/>}</span></pre><p id="3ed2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦URL列表可用，我们就可以使用任何我们认为合适的方法来选择一个接近原始请求URL的集合。在我的例子中，我使用第三方函数(<code class="fe mp mq mr ms b">getEditDistance</code>)来衡量URL的相似程度，使用<a class="ae kv" href="https://en.wikibooks.org/wiki/Algorithm_Implementation/Strings/Levenshtein_distance#JavaScript" rel="noopener ugc nofollow" target="_blank"> Levenshtein距离算法</a>。该算法的细节超出了本文的范围；重要的一点是，我们获取了自己的站点地图，并在客户端处理它，而不必求助于在数据库或服务器的文件系统中查找。</p><h1 id="b410" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">例子</h1><p id="8715" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这里有一个链接到我自己的网站的URL的例子，我在这里使用了这种技术。URL不存在，所以您应该会看到404页面，并在顶部添加了动态功能。</p><p id="b881" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kv" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">订阅解码获得更多类似内容，我们的YouTube频道</strong> </a> <strong class="ky ir">！</strong></p></div></div>    
</body>
</html>