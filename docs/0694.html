<html>
<head>
<title>Physical Simulation with JavaScript in the HTML5 Canvas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在HTML5画布中使用JavaScript进行物理模拟</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/physical-simulation-with-javascript-in-the-html5-canvas-27dc6ea121cf?source=collection_archive---------1-----------------------#2019-11-27">https://javascript.plainenglish.io/physical-simulation-with-javascript-in-the-html5-canvas-27dc6ea121cf?source=collection_archive---------1-----------------------#2019-11-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0610" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">展示真实行为的球和弹簧的演示动画</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/92b5284cdf8b49e6c3e9e6077b2171bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LLuRz2v2zqeY2_Ew"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@noahsilliman?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Noah Silliman</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5f5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将向你展示一个例子，如何使用一些基本的物理思想来创建一个简单的具有逼真行为的动画。我们将使用JavaScript在HTML5画布中呈现动画。</p><p id="da3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们深入研究代码之前，先看看在您的浏览器中运行的<a class="ae kv" href="https://doncross.net/chainsim/" rel="noopener ugc nofollow" target="_blank">模拟。尝试用鼠标点击并拖动其中一个绿色粒子。</a></p><p id="a895" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个基于浏览器的动画的完整代码可以在<a class="ae kv" href="https://github.com/cosinekitty/chainsim" rel="noopener ugc nofollow" target="_blank"> this GitHub repo </a>中找到。只有两个文件，<code class="fe ls lt lu lv b">index.html</code>和<code class="fe ls lt lu lv b">chain.js</code>，它们没有外部依赖。您可以将它们下载到自己的计算机上，修改代码，然后在浏览器中查看结果。</p><h2 id="d27a" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">物理模型</h2><p id="a86c" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">在这个示例程序中，模拟的世界是二维的。这个世界上有三种实体:球、锚、弹簧。</p><p id="01db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">球是一个质点，它有质量<em class="mu"> m </em>，位置(<em class="mu"> x </em>，<em class="mu"> y </em>)，速度(<em class="mu"> vx </em>，<em class="mu"> vy </em>)。质量是恒定的，但是位置和速度向量在每个动画帧期间根据作用在球上的总力进行更新。这些球被描绘成绿色的圆圈。还有一个重力加速度<em class="mu"> g </em> = 9.8米/秒将球拉向屏幕底部。</p><p id="2610" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">锚是一种特殊的球，不会移动。(实际上，你可以用鼠标移动它，就像你可以移动任何其他球一样。但除此之外，一个锚留在原地。)模拟中只有一个锚点，但是你可以通过在<code class="fe ls lt lu lv b">chain.js</code>中编辑代码来改变它。锚看起来像红色方块。</p><p id="cce4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">弹簧是一条弹性线段，其端点连接两个球。每个弹簧恰好连接两个球，但是一个球可以连接任意数量的弹簧。每个弹簧有两个属性:一个<em class="mu">静止长度</em>和一个<em class="mu">弹簧常数</em>。这两个都是正实数，定义了弹簧对连接到两端的两个球施加多大的力。</p><p id="1437" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">剩余长度<em class="mu"> L </em>是弹簧未拉伸或压缩时的长度。在这个长度上，它对它所连接的球施加的力为零。<em class="mu"> L </em>用米表示。</p><p id="7d82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">弹簧常数K表示弹簧的“强度”,意思是弹簧抵抗拉伸或压缩远离其静止长度的程度。<em class="mu"> K </em>以牛顿每米(N/m)为单位表示。</p><p id="b2f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们知道了玩家，让我们来探索模拟器是如何实时计算他们的行为的。</p><h2 id="9a16" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">画布中的动画</h2><p id="2eaf" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">动画本身是通过以下步骤一次绘制一个动画帧来实现的:</p><ul class=""><li id="11fc" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated">执行物理计算以更新模型状态。</li><li id="8fad" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">擦除画布的内容。</li><li id="e796" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">画出所有的球和弹簧。</li><li id="8e8a" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">用10毫秒的计时器回调来调度另一个动画帧。</li></ul><h2 id="20f6" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">计算力</h2><p id="9995" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">chain.js</code>你会发现一个类<code class="fe ls lt lu lv b">Simulation</code>。里面是一个成员函数<code class="fe ls lt lu lv b">Update</code>。它的参数<code class="fe ls lt lu lv b">dt</code>，以秒为单位，代表了一个小的时间增量，通过这个时间增量来更新模拟的状态。在阅读<code class="fe ls lt lu lv b">Update</code>函数的代码之前，先了解一下作用在球上的力会有所帮助。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/28c5adcaa6f37e47966977802826481d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-doj82A53rA8PPhgpftVA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Spring and weight forces acting on the ball B1.</figcaption></figure><p id="be43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个弹簧都作用在与之相连的两个球上。此时弹簧<em class="mu"> Sa </em>以大小相等方向相反的力<em class="mu"> Fa </em>作用在滚珠<em class="mu"> B1 </em>和<em class="mu"> B2 </em>上。同样，<em class="mu"> Sb </em>以大小相等方向相反的力<em class="mu"> Fb </em>作用在<em class="mu"> B1 </em>和<em class="mu"> B3 </em>上。</p><p id="8745" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们假设弹簧<em class="mu"> Sa </em>在所描绘的时刻被拉伸得比其静止长度更长。这就是为什么力<em class="mu"> Fa </em>的箭头指向远离球<em class="mu"> B1 </em>的方向。同时，相同的力<em class="mu"> Fa </em>在相反的方向拉<em class="mu"> B2 </em>，朝向<em class="mu"> B1 </em>。</p><p id="a31b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，假设弹簧<em class="mu"> Sb </em>被压缩得比其静止长度短。因此，<em class="mu"> Sb </em>试图将<em class="mu"> B1 </em>和<em class="mu"> B3 </em>推开。这就是为什么力矢量<em class="mu"> Fb </em>有一个指向<em class="mu"> B1 </em>的箭头。</p><p id="c29b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有球的重量<em class="mu"> mg </em>把它往下拉，这里<em class="mu"> m </em>是球的质量，单位是千克，<em class="mu"> g </em> = 9.8 m/s是重力产生的加速度。</p><p id="0f0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">函数<code class="fe ls lt lu lv b">Update</code>将每个球的所有贡献力矢量相加。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Update() calculates forces and updates ball positions and velocities accordingly.</figcaption></figure><p id="9046" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">Update</code>函数调用<code class="fe ls lt lu lv b">Spring</code>类中的<code class="fe ls lt lu lv b">AddForce</code>函数，将模拟中每个弹簧的力添加到它们连接的球上。这是函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">AddForce() calculates the force of one spring on two balls.</figcaption></figure><p id="7cf9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个弹簧都有一个力，计算方法是将弹簧常数乘以弹簧当前长度与其静止长度之差。力沿着它所连接的两个球之间的直线作用。</p><h2 id="e8eb" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">更新位置和速度向量</h2><p id="bc55" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">在计算了作用在所有球上的力之后，<code class="fe ls lt lu lv b">Update</code>返回并根据这些力更新每个球的位置和速度。球的运动行为由熟悉的牛顿物理方程<em class="mu"> F </em> = <em class="mu"> ma </em>决定。这表示质量<em class="mu"> m </em>上的合力矢量<em class="mu"> F </em>导致质量以矢量<em class="mu"> a </em>加速。</p><p id="fa38" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模拟以离散时间步长δ<em class="mu">t</em>进行。在物理学中，加速度被定义为速度相对于时间的瞬时变化率，或者用微分学符号表示为<em class="mu">a</em>= d<em class="mu">v</em>/d<em class="mu">t</em>。我们将加速度近似为有限变化的比率<em class="mu">a</em>=δ<em class="mu">v</em>/δ<em class="mu">t</em>。将这个近似值与<em class="mu"> F </em> = <em class="mu"> ma </em>放在一起，我们可以将球的速度矢量的变化解为δ<em class="mu">v</em>=(<em class="mu">F</em>/<em class="mu">m</em>)δ<em class="mu">t</em>。我们将在<em class="mu"> x- </em>和<em class="mu"> y </em>方向上作用在滚珠上的合力<em class="mu"> F </em>除以滚珠的质量<em class="mu"> m </em>，再乘以时间增量δ<em class="mu">t</em>，得到在<em class="mu"> x </em>和<em class="mu"> y </em>方向上的速度变化。</p><h2 id="4d28" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">矩阵中的一个小故障</h2><p id="6d37" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">但是δ<em class="mu">v</em>的这种近似会在仿真中引起问题。如果你使用那个简单的公式，你会发现模拟变得不稳定。与无限小的时间增量d <em class="mu"> t </em>不同，有限的增量δ<em class="mu">t</em>会导致系统总能量(动能加势能)的轻微不完美。这可能会导致球随着时间的推移移动得越来越快，并在屏幕上爆炸。</p><p id="a221" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了缓和这种行为，我们将所有的速度向量乘以一个略小于1的摩擦系数。随着时间的推移，这将抑制球的运动，并保持模拟稳定。您可以通过编辑JavaScript代码中常量<code class="fe ls lt lu lv b">FrictionHalfLifeSeconds</code>的值来调整这种摩擦行为。你把这个半衰期值做的越小，摩擦就越多。把它做得足够小，所有的东西看起来都像是在穿过蜂蜜。把半衰期常数弄得太大，就会看到爆炸问题。</p><p id="1192" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">Update</code>函数还通过将速度向量乘以时间δ<em class="mu">t</em>来更新每个球的位置，从而计算出球的位置改变了多少。</p><h2 id="78ae" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">动画</h2><p id="2bb8" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">除了上面提到的摩擦技巧，通过为每个显示的动画帧执行1000次增量模拟更新，模拟稳定性得到增强。这使得δ<em class="mu">t</em>值为屏幕更新时间间隔大小的1/1000。δ<em class="mu">t</em>的值越小，模拟越精确。</p><p id="14a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种每帧的计算量可能听起来有些过分，但是JavaScript在这些日子里效率惊人。现代浏览器将JavaScript编译成本机代码，并且进行了惊人的优化。在数字处理方面，它的性能远不及C或Fortran，但也不容小觑。</p><p id="9811" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际上，我对这段代码的性能测试显示，真正的瓶颈根本不在物理计算中。代码中最昂贵的部分是每次调用<code class="fe ls lt lu lv b">Render</code>函数时擦除画布:</p><pre class="kg kh ki kj gt nm lv nn no aw np bi"><span id="dc11" class="lw lx iq lv b gy nq nr l ns nt">context.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);</span></pre><p id="6c3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，如果你渴望让这段代码运行得更快，我建议你从这里开始！</p><p id="e38d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望您喜欢修补这些代码。我确信有一些数值模拟专家可以告诉我改进的方法，特别是用有限的时间增量更好地逼近物理行为。我很想收到你的来信！请随意发表评论，这样我们都可以学习。</p><h2 id="aa99" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">资源</h2><ul class=""><li id="3152" class="mv mw iq ky b kz mp lc mq lf nu lj nv ln nw lr na nb nc nd bi translated"><a class="ae kv" href="https://doncross.net/chainsim/" rel="noopener ugc nofollow" target="_blank"> ChainSim </a> —此处描述的基于浏览器的实时算法演示。</li><li id="5140" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><a class="ae kv" href="https://github.com/cosinekitty/chainsim" rel="noopener ugc nofollow" target="_blank">GitHub Repo</a>—chain sim的完整源代码。</li></ul></div></div>    
</body>
</html>