<html>
<head>
<title>My experience publishing a package to Github’s Package Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我将一个包发布到Github的包注册表的经历</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/my-experience-publishing-a-package-to-githubs-package-registry-988ba8cf5a0e?source=collection_archive---------0-----------------------#2019-08-24">https://javascript.plainenglish.io/my-experience-publishing-a-package-to-githubs-package-registry-988ba8cf5a0e?source=collection_archive---------0-----------------------#2019-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d761edea9cbc9d9dc8051ab0c1a01402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rPqFfu-15w6HJoVN"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@samuelzeller?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Samuel Zeller</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="23ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我最近进行的React本地组件库工作中，我遇到了一点阻碍——我需要在远程某个地方发布组件库，以便在通过CI管道构建的主应用程序中使用它。</p><p id="5804" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我目前正在做的项目不是开源的，所以不幸的是，公共的npm包不是一个选项，私有的npm注册表将会非常昂贵。</p><p id="ca7b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我最初的解决方案是使用<a class="ae kc" href="https://verdaccio.org" rel="noopener ugc nofollow" target="_blank"> Verdaccio，这是一个自托管的npm注册表，有Docker映像可用。</a></p><p id="aef7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在本地用Verdaccio做了一个快速测试，给我留下了非常深刻的印象，它是npmjs.org的替代品，安装和使用起来非常简单。</p><p id="01ef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可能会说，我将开始使用本地版本的Verdaccio来测试包的上传和下载工作，而不是使用<code class="fe lb lc ld le b">npm link</code>来本地测试包。</p><h1 id="b17b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Github的包注册表来拯救？</h1><p id="2a7d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">在寻找自托管npm解决方案时，我偶然发现了Github包注册表。</p><p id="560b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在Github似乎已经被微软接管，他们正在从存储代码的地方扩展到存储软件包的地方，我相信最终一切都与代码和项目有关。</p><p id="f252" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">具有讽刺意味的是，虽然这将是他们的最终目标，但在测试阶段，他们积极警告用户不要使用关键包的包注册表，我想如果服务下降或测试后他们不继续产品，他们会掩护他们。</p><p id="5dfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过与我的团队交谈，我发现不久前就已经有一个访问测试版的请求，所以当几天后Github发来一封电子邮件说我们已经注册了测试版时，看起来所有的部分都在一起了。</p><p id="fa6e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你作为一个组织注册了测试版，你可以看到一个在组织的名称空间下发布的包的列表，在存储库级别，你可以看到使用该代码库发布的包。</p><p id="4395" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Github管理这些链接的方式首先是要求所有npm包的作用域与Github上的组织名称相同(例如，如果你的组织是<code class="fe lb lc ld le b">github.com/acmeinc</code>，那么你的包的作用域是<code class="fe lb lc ld le b">@acmeinc</code>)</p><p id="5b6a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其次，Github使用来自您的<code class="fe lb lc ld le b">package.json</code>文件的存储库信息将发布的包链接到Github上的相关存储库。</p><p id="acac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了发布，您还需要创建一个具有<code class="fe lb lc ld le b">read:packages</code>、<code class="fe lb lc ld le b">write:packages</code>和完整<code class="fe lb lc ld le b">repo</code>范围的身份验证令牌，然后使用此令牌登录您组织的npm。</p><p id="4d55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了这些特定于平台的要求之外，使用Github包注册中心的npm端的设置类似于使用自托管的npm注册中心，在这里使用一个<code class="fe lb lc ld le b">.npmrc</code>文件并在<code class="fe lb lc ld le b">package.json</code>中添加一个<code class="fe lb lc ld le b">publishConfig</code>条目来告诉npm在哪里发布包。</p><h1 id="e349" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">薛定谔的贝塔入学</h1><p id="b489" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">但是Github注册包的测试版有一个很大的问题，那就是当你查看Github UI时，你的组织看起来是在测试版中，而当你试图发布一个包时，你的组织看起来不是在测试版中。</p><p id="ec43" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不确定这种情况的根本原因是什么，我只能假设注册表后端与UI不同步，因此需要额外的时间来准备接受包。</p><p id="d408" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个问题当然会破坏整个测试版的UX，因为作为一个开发者，我对在Github UI上显示我的包不感兴趣，我想知道我可以运行<code class="fe lb lc ld le b">npm publish</code>，然后将包添加到我的依赖项中。</p><p id="70e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Github UI真正的目的是让其他想要使用我的包的开发者了解它的存在，以及如何将它作为一个依赖项添加到他们的项目中。</p><p id="5606" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于大多数注册了Github软件包注册测试版的组织来说，我认为发布的新软件包数量相对较少，所以处于这种准注册状态是非常令人困惑的。</p><h2 id="0dc2" class="mi lg iq bd lh mj mk dn ll ml mm dp lp ko mn mo lt ks mp mq lx kw mr ms mb mt bi translated">发布到Github包注册表的疑难解答</h2><p id="38a9" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">如果你试图用不正确的名称空间发布一个包(例如，你在Github上的组织是<code class="fe lb lc ld le b">ACMEinc</code>，但是你的包名称空间是<code class="fe lb lc ld le b">ACME</code>)，你可能会看到这个错误消息:</p><pre class="mu mv mw mx gt my le mz na aw nb bi"><span id="7a23" class="mi lg iq le b gy nc nd l ne nf">npm ERR! publish Failed PUT 402<br/>npm ERR! code E402<br/>npm ERR! You must sign up for private packages : @ACME/package-name</span></pre><p id="67e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个问题很容易解决，只需在Github上将包的名称空间更新为组织的名称。</p><p id="d246" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于Github不同于他们当前使用的名称空间的组织，我不确定这将如何与已建立的作用域包一起工作。</p><p id="095b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，如果您看到以下错误，那么您就处于无法发布的准注册状态，需要联系Github支持才能获得访问权限。</p><pre class="mu mv mw mx gt my le mz na aw nb bi"><span id="3972" class="mi lg iq le b gy nc nd l ne nf">npm ERR! publish Failed PUT 400<br/>npm ERR! code E400 <br/>npm ERR! GitHub Package Registry is not enabled for user/org "ACMEinc".Unfortunately, we can't accept package uploads. : @ACMEinc/package-name</span></pre><p id="30e6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我试图诊断这个问题时，我发现这些链接很有用:</p><ul class=""><li id="8c71" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated">无法发布的详细信息:<a class="ae kc" href="https://github.com/kubernetes/org/issues/812" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/org/issues/812</a></li><li id="26b6" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated">在推特上发布回应，详细说明联系Github支持部门的必要性<a class="ae kc" href="https://twitter.com/jrsyo/status/1146636055153541122" rel="noopener ugc nofollow" target="_blank">https://twitter.com/jrsyo/status/1146636055153541122</a></li></ul><h1 id="9f02" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">发布组件库</h1><p id="8c43" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">一旦我最终获得了发布到Github包注册表的权限，我就需要:</p><ul class=""><li id="145b" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated">确保设置了正确的<code class="fe lb lc ld le b">main</code>属性，以便将库作为库而不是应用程序使用</li><li id="0c66" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated">确保最终的包中只包含了<code class="fe lb lc ld le b">src</code>和<code class="fe lb lc ld le b">assets</code>文件夹</li><li id="c7a4" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated">确保库没有拉入消费库也需要的依赖项的副本，例如React Native</li></ul><p id="8cf4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我在组件库中使用Expo和Storybook.js来提供一个展示所有组件的运行应用程序，所以我需要将<code class="fe lb lc ld le b">main</code>条目作为<code class="fe lb lc ld le b">node_modules/expo/appEntry.js</code>，但是在打包组件库时，我需要将<code class="fe lb lc ld le b">main</code>条目作为<code class="fe lb lc ld le b">src/index.js</code>，这样我就可以导入组件。</p><p id="0bba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我通过使用<code class="fe lb lc ld le b">json</code>包在<code class="fe lb lc ld le b">prepack</code>阶段覆盖<code class="fe lb lc ld le b">package.json</code>中的<code class="fe lb lc ld le b">main</code>属性为<code class="fe lb lc ld le b">src/index.js</code>，然后在<code class="fe lb lc ld le b">postpack</code>阶段将其恢复为<code class="fe lb lc ld le b">node_modules/expo/appEntry.js</code>来实现这一点。</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Package.json with pre-pack and post-pack scripts</figcaption></figure><p id="8d88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe lb lc ld le b">prepack</code> / <code class="fe lb lc ld le b">postpack</code>挂钩在<code class="fe lb lc ld le b">npm pack</code>和<code class="fe lb lc ld le b">npm publish</code>之前和之后运行，这允许发布的包具有正确的<code class="fe lb lc ld le b">main</code>条目，同时确保Expo条目不会被删除。</p><p id="dc7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了删除用于存储单元测试、故事书设置和博览会信息的无关文件夹，我使用了<code class="fe lb lc ld le b">package.json</code>中的<code class="fe lb lc ld le b">files</code>属性来告诉npm只打包<code class="fe lb lc ld le b">src</code>和<code class="fe lb lc ld le b">assets</code>文件夹。</p><p id="b048" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">至于对等依赖，这只是将React Native及其相关库从my <code class="fe lb lc ld le b">package.json</code>中的<code class="fe lb lc ld le b">dependencies</code>移动到<code class="fe lb lc ld le b">peerDependencies</code>，然后在安装组件库时确保安装对等依赖。</p><p id="c7bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这些改变，我成功地发布了组件库，并开始在主应用程序中使用它。</p><h1 id="4b81" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用组件库</h1><p id="6eab" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">为了使用我的组件库，我只需要添加<code class="fe lb lc ld le b">.npmrc</code>文件来告诉npm在Github包注册表中查找包，并将我的包包含在我的<code class="fe lb lc ld le b">package.json</code>中。</p><p id="6add" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着组件库的发布和添加到主应用程序中，我能够使用库中的组件，这反过来降低了主应用程序的复杂性，并确保显示信息和提供要显示的数据之间的关注点有明确的分离。</p><h1 id="68b7" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">最后的想法</h1><p id="8499" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">虽然设置起来有点麻烦，但Github的包注册表工作得非常好，我希望它支持许多不同的包管理器(类似于Nexus之类的东西),它将成长为一个繁荣的包生态系统，开发者不仅可以发布包，还可以利用Github提供的工具，如果他们做一些类似于他们的包自动化依赖审计工具的事情。</p><p id="468d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，我对开发周期中有多少将依赖于Github持谨慎态度，并且考虑到Github在过去被DDoS攻击的次数，这确实有可能导致一切停止。</p><p id="8141" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与git不同，git的设计本身就是分布式的，许多包注册表不是，所以除非组织使用现有的包注册表作为Github不可用的后备，否则他们会发现自己无法安装、打包和构建他们的应用程序和依赖项。</p><p id="27bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管如此，我还是很期待看到包注册中心是如何发展的，Github是如何把它的项目、管道和webhook绑定到包注册中心的。</p></div></div>    
</body>
</html>