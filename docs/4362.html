<html>
<head>
<title>Server-Side Development with Fastify — Error Handler, Route List, and Parsing Content</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fastify的服务器端开发—错误处理程序、路由列表和解析内容</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/server-side-development-with-fastify-error-handler-route-list-and-parsing-content-43f3da9f00ba?source=collection_archive---------4-----------------------#2020-12-06">https://javascript.plainenglish.io/server-side-development-with-fastify-error-handler-route-list-and-parsing-content-43f3da9f00ba?source=collection_archive---------4-----------------------#2020-12-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/66c66549b5d0d2f90bec0f1574c1cc71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sz-2LUS3nUH7axMU"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@harleydavidson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Harley-Davidson</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="cc03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify是一个用于开发后端网络应用程序的小型Node框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用Fastify创建后端应用程序。</p><h1 id="1b7b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置错误处理程序</h1><p id="d3eb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以调用<code class="fe me mf mg mh b">setErrorHandler</code>作为错误处理程序。</p><p id="116b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1c6b" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true<br/>})</span><span id="c3ab" class="mq lc iq mh b gy mv ms l mt mu">fastify.setErrorHandler(function (error, request, reply) {<br/>  this.log.error(error)<br/>  reply.status(409).send({ ok: false })<br/>})</span><span id="af5e" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="a19a" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="0caf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用我们的处理程序调用<code class="fe me mf mg mh b">setErrorHandler</code>。</p><p id="01ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过<code class="fe me mf mg mh b">error.statusCode</code>属性得到状态码:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5253" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true<br/>})</span><span id="faac" class="mq lc iq mh b gy mv ms l mt mu">fastify.setErrorHandler(function (error, request, reply) {<br/>  const { statusCode } = error.statusCode<br/>  if (statusCode &gt;= 500) {<br/>    this.log.error(error)<br/>  } else if (statusCode &gt;= 400) {<br/>    this.log.info(error)<br/>  } else {<br/>    this.log.error(error)<br/>  }  <br/>  reply.status(409).send({ ok: false })<br/>})</span><span id="52dd" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="38ef" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="1704" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在错误处理程序中检查<code class="fe me mf mg mh b">statusCode</code>。</p><h1 id="b954" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">打印路线列表</h1><p id="4d11" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过<code class="fe me mf mg mh b">fastify.printRoutes</code>方式打印路线列表。</p><p id="98a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f752" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true<br/>})</span><span id="026b" class="mq lc iq mh b gy mv ms l mt mu">fastify.ready(() =&gt; {<br/>  console.log(fastify.printRoutes())<br/>})</span><span id="6b48" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="15e7" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="abef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打印<code class="fe me mf mg mh b">fastify.ready</code>处理程序中的路由监听。</p><p id="99ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1261" class="mq lc iq mh b gy mr ms l mt mu">└── / (GET)</span></pre><p id="d013" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们用<code class="fe me mf mg mh b">get</code>定义了<code class="fe me mf mg mh b">/</code>路线。</p><h1 id="d1c2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">内容类型解析器</h1><p id="db92" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">fastify.addContentTypeParser</code>方法添加自己的内容类型解析器。</p><p id="f800" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8c92" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true<br/>})</span><span id="3d54" class="mq lc iq mh b gy mv ms l mt mu">fastify.addContentTypeParser('text/json', { asString: true }, fastify.getDefaultJsonParser('ignore', 'ignore'))</span><span id="fd46" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="4f88" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="f855" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们为<code class="fe me mf mg mh b">text/json</code> MIME类型添加了内容类型处理程序。</p><h1 id="b9ee" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">错误处理程序</h1><p id="539e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">fastify.errorHandler </code>方法添加一个错误处理程序。</p><p id="ff6b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4679" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true<br/>})</span><span id="43b2" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', {<br/>  errorHandler: (error, request, reply) =&gt; {<br/>    if (error.code === 'SOMETHING_SPECIFIC') {<br/>      reply.send({ custom: 'response' })<br/>      return<br/>    }<br/>    fastify.errorHandler(error, request, response)<br/>  }<br/>}, (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="9ff0" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="9a43" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加带有错误处理程序的<code class="fe me mf mg mh b">/</code>路由。</p><p id="8284" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们检查<code class="fe me mf mg mh b">error.code</code>属性以检查引发的错误类型。</p><p id="6ccb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当发生错误时，我们调用<code class="fe me mf mg mh b">reply.send</code>返回响应。</p><h1 id="64cd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="eb04" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以设置一个错误处理程序，内容类型解析器，并使用Fastify打印一个路由列表。</p><p id="6820" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果是这样，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获得更多类似的内容！</strong></p></div></div>    
</body>
</html>