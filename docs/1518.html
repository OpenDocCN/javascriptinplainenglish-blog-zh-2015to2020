<html>
<head>
<title>Adding Mutations with Express GraphQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Express GraphQL添加突变</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/adding-mutations-with-express-graphql-99ffc45c6c2a?source=collection_archive---------4-----------------------#2020-03-26">https://javascript.plainenglish.io/adding-mutations-with-express-graphql-99ffc45c6c2a?source=collection_archive---------4-----------------------#2020-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e5ee00422d1cc1ddd3ed21a8fa504e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wQ2OmlYw52k5MmV_"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@sxy_selia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sangga Rima Roman Selia</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ee3a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用Express创建一个简单的GraphQL服务器。为此，我们需要<code class="fe lb lc ld le b">express-graphql</code>和<code class="fe lb lc ld le b">graphql</code>包。</p><p id="2a9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用Express和GraphQL创建突变和输入类型。</p><h1 id="38bc" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">突变和输入类型</h1><p id="94d4" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">为了创建突变，我们创建一个具有<code class="fe lb lc ld le b">Mutation</code>类型而不是<code class="fe lb lc ld le b">Query</code>的模式。</p><p id="646d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后很简单，让API端点成为顶级<code class="fe lb lc ld le b">Mutation</code>类型的一部分，而不是<code class="fe lb lc ld le b">Query</code>类型。</p><p id="17f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">突变和查询都可以由根解析器来处理。</p><p id="010d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以创建一个接受查询和变异的GraphQL服务器，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="c344" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const graphqlHTTP = require('express-graphql');<br/>const { buildSchema } = require('graphql');<br/>const crypto = require('crypto');<br/>const schema = buildSchema(`<br/>  input TodoInput {<br/>    text: String    <br/>  }</span><span id="d9a3" class="mq lg iq le b gy mv ms l mt mu">  type Todo {<br/>    id: ID!<br/>    text: String    <br/>  }</span><span id="d565" class="mq lg iq le b gy mv ms l mt mu">  type Query {<br/>    getTodo(id: ID!): Todo<br/>  }</span><span id="4c75" class="mq lg iq le b gy mv ms l mt mu">  type Mutation {<br/>    createTodo(input: TodoInput): Todo<br/>    updateTodo(id: ID!, input: TodoInput): Todo<br/>  }<br/>`);</span><span id="cee8" class="mq lg iq le b gy mv ms l mt mu">class Todo {<br/>  constructor(id, { text }) {<br/>    this.id = id;<br/>    this.text = text;<br/>  }<br/>}</span><span id="a7dc" class="mq lg iq le b gy mv ms l mt mu">let todos = {};</span><span id="3a0f" class="mq lg iq le b gy mv ms l mt mu">const root = {<br/>  getTodo: ({ id }) =&gt; {<br/>    if (!todos[id]) {<br/>      throw new Error('Todo not found.');<br/>    }<br/>    return new Todo(id, todos[id]);<br/>  },<br/>  createTodo: ({ input }) =&gt; {<br/>    const id = crypto.randomBytes(10).toString('hex');<br/>    todos[id] = input;<br/>    return new Todo(id, input);<br/>  },<br/>  updateTodo: ({ id, input }) =&gt; {<br/>    if (!todos[id]) {<br/>      throw new Error('Todo not found');<br/>    }<br/>    todos[id] = input;<br/>    return new Todo(id, input);<br/>  },<br/>};</span><span id="fec9" class="mq lg iq le b gy mv ms l mt mu">const app = express();</span><span id="46ae" class="mq lg iq le b gy mv ms l mt mu">app.use('/graphql', graphqlHTTP({<br/>  schema: schema,<br/>  rootValue: root,<br/>  graphiql: true,<br/>}));<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="cdb5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们通过编写以下内容来定义我们的类型:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="db96" class="mq lg iq le b gy mr ms l mt mu">const schema = buildSchema(`<br/>  input TodoInput {<br/>    text: String    <br/>  }</span><span id="4e75" class="mq lg iq le b gy mv ms l mt mu">  type Todo {<br/>    id: ID!<br/>    text: String    <br/>  }</span><span id="160a" class="mq lg iq le b gy mv ms l mt mu">  type Query {<br/>    getTodo(id: ID!): Todo<br/>  }</span><span id="803d" class="mq lg iq le b gy mv ms l mt mu">  type Mutation {<br/>    createTodo(input: TodoInput): Todo<br/>    updateTodo(id: ID!, input: TodoInput): Todo<br/>  }<br/>`);</span></pre><p id="7c61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了输入类型<code class="fe lb lc ld le b">TodoInput</code>和<code class="fe lb lc ld le b">Todo</code>类型。然后我们用<code class="fe lb lc ld le b">getTodo</code>成员创建了<code class="fe lb lc ld le b">Query</code>类型，这样我们就可以得到我们的todo项。</p><p id="25c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在我们的<code class="fe lb lc ld le b">Mutation</code>中，我们添加了<code class="fe lb lc ld le b">createTodo</code>和<code class="fe lb lc ld le b">updateTodo</code>成员，这样我们就可以添加和更新todos。</p><p id="5789" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们创建我们的<code class="fe lb lc ld le b">Todo</code>类，这样我们可以存储todo数据:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="e2e1" class="mq lg iq le b gy mr ms l mt mu">class Todo {<br/>  constructor(id, { text }) {<br/>    this.id = id;<br/>    this.text = text;<br/>  }<br/>}</span></pre><p id="85ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们有了根解析器:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="bd81" class="mq lg iq le b gy mr ms l mt mu">const root = {<br/>  getTodo: ({ id }) =&gt; {<br/>    if (!todos[id]) {<br/>      throw new Error('Todo not found.');<br/>    }<br/>    return new Todo(id, todos[id]);<br/>  },<br/>  createTodo: ({ input }) =&gt; {<br/>    const id = crypto.randomBytes(10).toString('hex');<br/>    todos[id] = input;<br/>    return new Todo(id, input);<br/>  },<br/>  updateTodo: ({ id, input }) =&gt; {<br/>    if (!todos[id]) {<br/>      throw new Error('Todo not found');<br/>    }<br/>    todos[id] = input;<br/>    return new Todo(id, input);<br/>  },<br/>};</span></pre><p id="6fe9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它添加了与我们在模式中指定的相同的函数，以便我们在进行一些查询时可以做一些事情。</p><p id="6a86" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个例子中，<code class="fe lb lc ld le b">getTodo</code>，我们将用给定的<code class="fe lb lc ld le b">id</code>返回todo。将返回找到的todo。否则，我们抛出一个错误。</p><p id="4d95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe lb lc ld le b">createTodo</code>中，我们从查询中获得<code class="fe lb lc ld le b">input</code>，然后将todo条目添加到我们的<code class="fe lb lc ld le b">todos</code>对象中，这是我们用来存储todo的假数据库。将返回保存的todo。</p><p id="edfa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe lb lc ld le b">updateTodo</code>函数通过<code class="fe lb lc ld le b">id</code>更新todo。给定的<code class="fe lb lc ld le b">id</code>将被替换为<code class="fe lb lc ld le b">input</code>的内容。将返回保存的todo。如果没有找到给定<code class="fe lb lc ld le b">id</code>的todo，我们抛出一个错误。</p><p id="36f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们转到<code class="fe lb lc ld le b">/graphql</code>页面时，我们可以在GraphiQL窗口中键入以下内容:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="3d02" class="mq lg iq le b gy mr ms l mt mu">mutation {<br/>  createTodo(input: {text: "eat"}) {<br/>    id<br/>    text<br/>  }<br/>}</span></pre><p id="e1b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们会得到这样的结果:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="ce92" class="mq lg iq le b gy mr ms l mt mu">{<br/>  "data": {<br/>    "createTodo": {<br/>      "id": "c141d1fda69e8d9084bd",<br/>      "text": "eat"<br/>    }<br/>  }<br/>}</span></pre><p id="e50b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><p id="04eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们查询更新todo，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="8844" class="mq lg iq le b gy mr ms l mt mu">mutation {<br/>  updateTodo(id: "e99ce10750c93793a23d", input: {text: "eat"}) {<br/>    id<br/>    text<br/>  }<br/>}</span></pre><p id="24ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们会得到这样的结果:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="1477" class="mq lg iq le b gy mr ms l mt mu">{<br/>  "data": {<br/>    "updateTodo": {<br/>      "id": "e99ce10750c93793a23d",<br/>      "text": "eat"<br/>    }<br/>  }<br/>}</span></pre><p id="4cb8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><p id="cf9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果没有找到todo，那么我们得到:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="63b5" class="mq lg iq le b gy mr ms l mt mu">{<br/>  "errors": [<br/>    {<br/>      "message": "Todo not found",<br/>      "locations": [<br/>        {<br/>          "line": 9,<br/>          "column": 3<br/>        }<br/>      ],<br/>      "path": [<br/>        "updateTodo"<br/>      ]<br/>    }<br/>  ],<br/>  "data": {<br/>    "updateTodo": null<br/>  }<br/>}</span></pre><p id="aa93" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><p id="3f28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以进行如下的<code class="fe lb lc ld le b">getTodo</code>查询:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="ec04" class="mq lg iq le b gy mr ms l mt mu">query {<br/>  getTodo(id: "e99ce10750c93793a23d"){<br/>    id<br/>    text<br/>  }<br/>}</span></pre><p id="31c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们得到:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="c918" class="mq lg iq le b gy mr ms l mt mu">{<br/>  "data": {<br/>    "getTodo": {<br/>      "id": "e99ce10750c93793a23d",<br/>      "text": "eat"<br/>    }<br/>  }<br/>}</span></pre><p id="25b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/bc9f51e813916222b13a946da1bd5065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3tizGlGM65zrFatA"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@priscilladupreez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Priscilla Du Preez</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="ed17" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="59bb" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以像处理查询一样创建突变。</p><p id="8ffd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在我们的GraphQL服务器中接受变异操作，我们创建了用于存储数据的类型，然后通过用我们的成员填充<code class="fe lb lc ld le b">Mutation</code>类型来创建变异。</p><p id="34b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以使用<code class="fe lb lc ld le b">buildSchema</code>函数来构建我们刚刚指定的模式。</p><p id="b62c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在我们的根归约器中，我们用我们在类型定义中指定的名字来创建函数。</p><p id="b8c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们可以查询我们的服务器来运行突变。</p><h2 id="8afa" class="mq lg iq bd lh mx my dn ll mz na dp lp ko nb nc lt ks nd ne lx kw nf ng mb nh bi translated"><strong class="ak">用简单英语写的JavaScript的一个注释:</strong></h2><p id="a86d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们总是有兴趣帮助推广高质量的内容。如果你有一篇文章想用简单的英语提交给JavaScript，用你的中级用户名发邮件到submissions@javascriptinplainenglish.com<a class="ae kc" href="mailto:submissions@javascriptinplainenglish.com" rel="noopener ugc nofollow" target="_blank">给我们，我们会把你添加为作者。</a></p></div></div>    
</body>
</html>