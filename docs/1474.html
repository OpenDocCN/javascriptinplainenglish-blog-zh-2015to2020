<html>
<head>
<title>Serving Static Files in Express Apps with serve-static</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用serve-static在Express应用程序中提供静态文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/serving-static-files-in-express-apps-with-serve-static-f42aaa2d6c2b?source=collection_archive---------3-----------------------#2020-03-20">https://javascript.plainenglish.io/serving-static-files-in-express-apps-with-serve-static-f42aaa2d6c2b?source=collection_archive---------3-----------------------#2020-03-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/91cc7ce0b9f2ccd9738990e7e7b9c6c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iX4llExUMNwmDZSP"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@daanstevens?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Daan Stevens</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a6db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用Express应用程序提供静态文件，我们可以使用<code class="fe lb lc ld le b">serve-static</code>包来提供服务器上给定文件夹中的文件。</p><p id="6654" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用它来服务静态文件。</p><h1 id="865d" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">装置</h1><p id="0b71" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">serve-static</code>库以Node.js包的形式提供。要安装它，我们可以运行:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="8c33" class="mq lg iq le b gy mr ms l mt mu">npm install serve-static</span></pre><h1 id="bb22" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">配置</h1><p id="528d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">server-static</code>包为我们提供了一个函数，可以创建一个新的中间件函数来服务给定目录中的文件。</p><p id="a1ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将通过结合<code class="fe lb lc ld le b">req.url</code>和提供的根目录来确定要服务的文件。当找不到文件时，它将调用<code class="fe lb lc ld le b">next()</code>移动到下一个中间件，而不是用404错误来响应。</p><p id="355c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这允许调用堆栈和回退代码。</p><p id="a087" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过编写以下内容来导入模块:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="aea0" class="mq lg iq le b gy mr ms l mt mu">const serveStatic = require('serve-static');</span></pre><p id="9ad6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来自<code class="fe lb lc ld le b">serve-static</code>模块的<code class="fe lb lc ld le b">serveStatic</code>函数有两个参数。</p><p id="879c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它有一个<code class="fe lb lc ld le b">root</code>和<code class="fe lb lc ld le b">options</code>参数。</p><p id="2dfe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">root</code>是一个字符串，包含要服务的根文件夹的路径。</p><p id="b79a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">options</code>参数接受具有以下属性的对象:</p><ul class=""><li id="00a5" class="mv mw iq kf b kg kh kk kl ko mx ks my kw mz la na nb nc nd bi translated"><code class="fe lb lc ld le b">acceptRanges</code> —启用或禁用接受范围请求。默认值为<code class="fe lb lc ld le b">true</code>。禁用此项不会发送<code class="fe lb lc ld le b">Accept_ranges</code>并忽略<code class="fe lb lc ld le b">Range</code>请求报头的内容</li><li id="76d5" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">cacheControl</code> —启用或禁用设置<code class="fe lb lc ld le b">Cache-Control</code>响应报头。默认值为<code class="fe lb lc ld le b">true</code>。禁用此选项将忽略<code class="fe lb lc ld le b">immutable</code>和<code class="fe lb lc ld le b">maxAge</code>选项</li><li id="7e50" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">dotfiles</code> —让我们设置如何处理隐藏文件，即任何以点开头的文件。如果指定了<code class="fe lb lc ld le b">root</code>，只检查根目录以上的点文件。其他可能的值包括<code class="fe lb lc ld le b">allow</code>，表示对点文件没有特殊处理，<code class="fe lb lc ld le b">deny</code> —拒绝对点文件的请求(403响应)，<code class="fe lb lc ld le b">ignore</code> —假装它们不存在(404响应)</li><li id="d6f5" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">etag</code> —启用或禁用ETag生成。默认为<code class="fe lb lc ld le b">true</code></li><li id="388a" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">extensions</code> —设置文件扩展名回退。如果这是<code class="fe lb lc ld le b">true</code>当没有找到扩展名时，给定的扩展名将被添加到文件名中并被搜索。默认为<code class="fe lb lc ld le b">false</code>。</li><li id="f090" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">fallthrough</code> —设置中间件，使客户端错误作为未处理的请求通过，否则转发客户端错误。当这是<code class="fe lb lc ld le b">true</code>时，客户端错误将导致这个中间件调用<code class="fe lb lc ld le b">next</code>以移动到下一个中间件。设置为<code class="fe lb lc ld le b">false</code>将使404s短路。</li><li id="4916" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">immutable</code> —启用或禁用<code class="fe lb lc ld le b">Cache-Control</code>响应头的<code class="fe lb lc ld le b">immutable</code>指令。默认值为<code class="fe lb lc ld le b">false</code>。当设置为<code class="fe lb lc ld le b">true</code>时，还应指定<code class="fe lb lc ld le b">maxAge</code>来启用缓存</li><li id="5d9d" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">index</code> —默认情况下<code class="fe lb lc ld le b">server-static</code>将发送<code class="fe lb lc ld le b">index.html</code>文件以响应目录上的请求。将此设置为<code class="fe lb lc ld le b">false</code>将防止这种情况发生</li><li id="456b" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">lastModified</code> —启用或禁用<code class="fe lb lc ld le b">Last-Modified</code>割台。默认为<code class="fe lb lc ld le b">true</code>。该值将是文件系统中最后修改的值</li><li id="568d" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">maxAge</code> —设置缓存的最大时间(毫秒)。默认值为0。</li><li id="c863" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">redirect</code> —当路径名是目录时，重定向到结尾的<code class="fe lb lc ld le b">/</code>。默认为<code class="fe lb lc ld le b">trie</code></li><li id="c12f" class="mv mw iq kf b kg ne kk nf ko ng ks nh kw ni la na nb nc nd bi translated"><code class="fe lb lc ld le b">setHeaders</code> —设置响应的自定义标题。它的值是一个带有签名<code class="fe lb lc ld le b">fn(res, path, stat)</code>的函数。<code class="fe lb lc ld le b">res</code>是响应对象，<code class="fe lb lc ld le b">path</code>是发送的文件路径，<code class="fe lb lc ld le b">stat</code>是发送的文件的stat对象。</li></ul><h1 id="194f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">例子</h1><h2 id="894d" class="mq lg iq bd lh nj nk dn ll nl nm dp lp ko nn no lt ks np nq lx kw nr ns mb nt bi translated">简单用法</h2><p id="a07d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以将一个带有<code class="fe lb lc ld le b">foo.txt</code>的文件夹作为默认文件显示如下:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="7251" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const serveStatic = require('serve-static');<br/>const app = express();<br/>app.use(serveStatic('public/files', { 'index': ['foo.txt'] }))</span><span id="8bf6" class="mq lg iq le b gy nu ms l mt mu">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="1172" class="mq lg iq le b gy nu ms l mt mu">app.listen(3000);</span></pre><p id="f407" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们向<code class="fe lb lc ld le b">/</code>发出GET请求时，如果<code class="fe lb lc ld le b">foo.txt</code>有内容<code class="fe lb lc ld le b">foo</code>，我们就会得到显示为响应的<code class="fe lb lc ld le b">foo</code>。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/3306a5db8b254c2474b0dbbdbbe574fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lvMcU61j6ogfY7J1"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@erol?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Erol Ahmed</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="40ea" class="mq lg iq bd lh nj nk dn ll nl nm dp lp ko nn no lt ks np nq lx kw nr ns mb nt bi translated">撤退</h2><p id="76ea" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以为多个目录提供服务，后续的目录作为第一个目录的后备，如果like出现错误，当它没有被找到时:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="d776" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const serveStatic = require('serve-static');<br/>const path = require('path');<br/>const app = express();<br/>app.use(serveStatic(path.join(__dirname, 'public/files'), { 'index': ['foo'] }));<br/>app.use(serveStatic(path.join(__dirname, 'public/ftp'), { 'index': ['bar.txt'] }));</span><span id="db4a" class="mq lg iq le b gy nu ms l mt mu">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="e16e" class="mq lg iq le b gy nu ms l mt mu">app.listen(3000);</span></pre><p id="01e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当文件<code class="fe lb lc ld le b">public/files/foo</code>没有被找到时，那么<code class="fe lb lc ld le b">public/ftp/bar.txt</code>将被提供。</p><h2 id="1fde" class="mq lg iq bd lh nj nk dn ll nl nm dp lp ko nn no lt ks np nq lx kw nr ns mb nt bi translated">设置标题</h2><p id="3362" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以如下设置标题:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="7b9e" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const serveStatic = require('serve-static');<br/>const path = require('path');<br/>const app = express();<br/>const setCustomCacheControl = (res, path) =&gt; {<br/>  if (serveStatic.mime.lookup(path) === 'text/html') {<br/>    res.setHeader('Cache-Control', 'public, max-age=0')<br/>  }<br/>}</span><span id="91b7" class="mq lg iq le b gy nu ms l mt mu">app.use(serveStatic(path.join(__dirname, 'public/files'), {<br/>  setHeaders: setCustomCacheControl<br/>}));</span><span id="ee0f" class="mq lg iq le b gy nu ms l mt mu">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="5337" class="mq lg iq le b gy nu ms l mt mu">app.listen(3000);</span></pre><p id="0446" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们的文件有了<code class="fe lb lc ld le b">text/html</code> MIME-type，像默认的索引文件<code class="fe lb lc ld le b">index.html</code>，那么我们将得到<code class="fe lb lc ld le b">Cache-Control</code>响应头的值为<code class="fe lb lc ld le b">public, max-age=0</code>。</p><h1 id="eb2f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="01eb" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">有了<code class="fe lb lc ld le b">serve-static</code>包，我们可以轻松地提供静态文件。它有各种选项来控制缓存、默认文件服务、多个后备文件夹等。</p><p id="7360" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以选择是否提供隐藏文件，以及我们希望在响应和重定向中使用的标题。</p></div></div>    
</body>
</html>