<html>
<head>
<title>Your First Higher-Order Next.js Config: Generating a Sitemap for your Next.js Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您的第一个高阶Next.js配置:为您的Next.js应用程序生成一个站点地图</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/your-first-higher-order-next-js-config-cf8813b15807?source=collection_archive---------12-----------------------#2020-05-05">https://javascript.plainenglish.io/your-first-higher-order-next-js-config-cf8813b15807?source=collection_archive---------12-----------------------#2020-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b5738cc38717c5d102dc9e3bd515a061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aqzeBpBYP_flMswfYLS_JQ.png"/></div></div></figure><p id="598c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我惊讶地意识到<a class="ae kw" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>没有现成的工具来生成<em class="kx"> sitemap.xml </em>。在我的研究过程中，我偶然发现了一个<a class="ae kw" href="https://github.com/IlusionDev/nextjs-sitemap-generator" rel="noopener ugc nofollow" target="_blank">库</a>，但是我对它们提供的接口没有什么印象。所以，我决定亲自动手，设计一个更高阶的Next.js配置。让我们来讨论一下，这样当您需要时，您也可以创建一个更高阶的配置。</p><p id="2919" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">TL；DR — </strong>访问<strong class="ka ir"/><a class="ae kw" href="https://github.com/cansin/next-with-sitemap" rel="noopener ugc nofollow" target="_blank">https://github.com/cansin/next-with-sitemap</a>，开始使用npm包，如果你只是想为你的应用程序生成一个站点地图，或者继续阅读了解更多。</p><h2 id="c4f5" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">高阶Next.js配置的剖析</h2><p id="ca36" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">所以首先要做的是。您可能想知道为什么我们需要高阶配置？究竟什么是高阶配置？高阶配置是对<a class="ae kw" href="https://en.wikipedia.org/wiki/Higher-order_function" rel="noopener ugc nofollow" target="_blank">高阶功能</a>概念的文字游戏。因此，它是一个将一个配置作为参数并返回一个配置作为结果的函数。</p><blockquote class="lw"><p id="ab55" class="lx ly iq bd lz ma mb mc md me mf kv dk translated">高阶配置是一个函数，它将一个配置作为其参数，并返回一个新的配置作为其结果。</p></blockquote><p id="dbc0" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">仅仅通过在<code class="fe ml mm mn mo b">next.config.js</code>内部编写我们需要的代码，就有可能实现我们在这里要做的事情。但是根据一般经验，随着项目的增长，将某些方面封装成一段代码更易于管理。因此，希望将其作为高阶配置。</p><p id="2d20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们所说的，我们需要从创建一个函数开始，该函数将在<code class="fe ml mm mn mo b">next.config.js</code>获取现有的Next.js配置，并生成一个能够生成站点地图的增强版本。因此，在您的项目下创建一个<code class="fe ml mm mn mo b">config/withSitemap.js</code>文件，并添加以下代码:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="7fb1" class="ky kz iq mo b gy mx my l mz na">// at config/withSitemap.js</span><span id="a92d" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">function </strong><em class="kx">withSitemap</em>(nextConfig = {}) {<br/>  <strong class="mo ir">return </strong>{<br/>    ...nextConfig,<br/>    webpack(webpackConfig, options) {<br/>      <strong class="mo ir">let </strong>config = webpackConfig;<br/>      <strong class="mo ir">if </strong>(<strong class="mo ir">typeof </strong>nextConfig.<strong class="mo ir">webpack </strong>=== <strong class="mo ir">"function"</strong>) {<br/>        config = nextConfig.<strong class="mo ir">webpack</strong>(config, options);<br/>      }</span><span id="546b" class="ky kz iq mo b gy nb my l mz na">      // Do something with the config</span><span id="da5c" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir">return </strong>config;<br/>    },<br/>  };<br/>}</span><span id="8248" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir"><em class="kx">module</em></strong>.<strong class="mo ir">exports </strong>= <em class="kx">withSitemap</em>;</span></pre><p id="f369" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个骨架做了两件事。由于<code class="fe ml mm mn mo b">...nextConfig</code>的扩展，它将下一个配置中未被触及的部分传递下去。它还运行任何现有的webpack配置，这要感谢在<code class="fe ml mm mn mo b">nextConfig.webpack</code>上的条件运行。我们为什么要为webpack费心？因为我们实际上正要扩充我们的webpack配置来生成站点地图文件。但稍后会详细介绍。</p><h2 id="43d0" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">带有itemap的选项应该有</h2><p id="a04b" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">大多数现代的Next.js应用程序都有一个存放公共静态内容的<code class="fe ml mm mn mo b">public</code>文件夹，以及一个存放每个页面的JavaScript文件的<code class="fe ml mm mn mo b">pages</code>文件夹。我们还需要知道所服务的应用程序的真实领域，以便<em class="kx"> sitemap.xml </em>文件能够正确地表示它。又多了一个进入的选择。在那里，我们还可以添加一个选项来禁用<em class="kx"> sitemap.xml </em>生成，以及另一个选项来禁用<em class="kx"> robots.txt </em>生成。</p><p id="0ddc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们希望在Next.js配置中的<code class="fe ml mm mn mo b">sitemap</code>对象中接收这些选项。这样<code class="fe ml mm mn mo b">next.config.js</code>就可以是:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="8f39" class="ky kz iq mo b gy mx my l mz na">// at next.config.js (final code)</span><span id="bcfe" class="ky kz iq mo b gy nb my l mz na">const withSitemap = require("./config/withSitemap");</span><span id="85d7" class="ky kz iq mo b gy nb my l mz na">module.exports = withSitemap({<br/>  sitemap: {<br/>    domain: "https://www.example.com",<br/>    destFolder: "public",<br/>    pagesFolder: "pages",<br/>    generateRobots: true,<br/>    generateSitemap: true,<br/>  },<br/>  // .<br/>  // ..<br/>  // ... other Next.js config<br/>});</span></pre><p id="165d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来很干净，不是吗？好了，现在我们知道了要返回给Next.js配置的接口。让我们继续讨论代码的实质内容。</p><h2 id="76c8" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">创建自定义Webpack插件</h2><p id="2220" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">为了生成站点地图文件，我们将把一个webpack插件挂接到我们的应用程序上，它将从给定的选项和文件系统中读取必要的数据，并发出<code class="fe ml mm mn mo b">sitemap.xml</code>和<code class="fe ml mm mn mo b">robots.txt</code>。Webpack本身有关于<a class="ae kw" href="https://webpack.js.org/contribute/writing-a-plugin/" rel="noopener ugc nofollow" target="_blank">编写插件</a>的优秀文档。我们将遵循那里描述的最佳实践。让我们继续在<code class="fe ml mm mn mo b">config/webpack/SitemapPlugin.js</code>下创建一个名为<code class="fe ml mm mn mo b">SitemapPlugin</code>的webpack插件，并将其填写为:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="812d" class="ky kz iq mo b gy mx my l mz na">// at config/webpack/SitemapPlugin.js</span><span id="f6ef" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>validateOptions = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"schema-utils"</strong>);</span><span id="5334" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>schema = {<br/>  <strong class="mo ir">type</strong>: <strong class="mo ir">"object"</strong>,<br/>  <strong class="mo ir">properties</strong>: {<br/>    <strong class="mo ir">domain</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">destPath</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">pagesPath</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">generateRobots</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"boolean"</strong>,<br/>    },<br/>    <strong class="mo ir">generateSitemap</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"boolean"</strong>,<br/>    },<br/>  },<br/>};</span><span id="6201" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">class </strong>SitemapPlugin {<br/>  constructor(options) {<br/>    validateOptions(schema, options, <strong class="mo ir">"SitemapPlugin"</strong>);<br/>    <strong class="mo ir">this</strong>.<strong class="mo ir">options </strong>= options;<br/>  }</span><span id="bd0a" class="ky kz iq mo b gy nb my l mz na">  apply(compiler) {<br/>    // This is where the magic happens<br/>  }<br/>}</span><span id="1b92" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir"><em class="kx">module</em></strong>.<strong class="mo ir">exports </strong>= SitemapPlugin;</span></pre><p id="f10f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">模式</em>将帮助我们验证插件的给定选项。正如你可能猜到的，我们将把给高阶配置的选项传递给webpack插件。</p><h2 id="629f" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">使用withSitemap中的SitemapPlugin</h2><p id="01f3" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">下一步是用项目地图函数从<em class="kx">中调用<em class="kx">网站地图插件</em>。这很简单，因为:</em></p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="fb28" class="ky kz iq mo b gy mx my l mz na">// at config/withSitemap.js (final code)</span><span id="6fd2" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>path = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"path"</strong>);</span><span id="67fa" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>SitemapPlugin = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"./webpack/SitemapPlugin"</strong>);</span><span id="51b5" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">function </strong><em class="kx">withSitemap</em>(nextConfig = {}) {<br/>  <strong class="mo ir">return </strong>{<br/>    ...nextConfig,<br/>    webpack(webpackConfig, options) {<br/>      <strong class="mo ir">let </strong>config = webpackConfig;<br/>      <strong class="mo ir">if </strong>(<strong class="mo ir">typeof </strong>nextConfig.<strong class="mo ir">webpack </strong>=== <strong class="mo ir">"function"</strong>) {<br/>        config = nextConfig.<strong class="mo ir">webpack</strong>(config, options);<br/>      }<br/>      <br/>      // Hooking the Sitemap Plugin - start<br/>      <strong class="mo ir">const </strong>{<br/>        isServer,<br/>        config: {<br/>          pageExtensions,<br/>          sitemap: { <br/>            destFolder = <strong class="mo ir">"public"</strong>, <br/>            pagesFolder = <strong class="mo ir">"pages"</strong>, <br/>            ...sitemapOptions <br/>          } = {},<br/>        },<br/>      } = options;</span><span id="ccd9" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir">if </strong>(isServer) {<br/>        <strong class="mo ir">return </strong>config;<br/>      }</span><span id="d335" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir">const </strong>destPath = path.join(options.<strong class="mo ir">dir</strong>, destFolder);<br/>      <strong class="mo ir">const </strong>pagesPath = path.join(options.<strong class="mo ir">dir</strong>, pagesFolder);</span><span id="a13b" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir"><em class="kx">console</em></strong>.log(<strong class="mo ir">"&gt; Generating sitemap.xml and robots.txt"</strong>);<br/>      <strong class="mo ir"><em class="kx">console</em></strong>.log(<strong class="mo ir">`&gt; Pages path: "</strong>${pagesPath}<strong class="mo ir">"`</strong>);<br/>      <strong class="mo ir"><em class="kx">console</em></strong>.log(<strong class="mo ir">`&gt; Destination path: "</strong>${destPath}<strong class="mo ir">"`</strong>);</span><span id="5201" class="ky kz iq mo b gy nb my l mz na">      config.<strong class="mo ir">plugins</strong>.push(<br/>        <strong class="mo ir">new </strong>SitemapPlugin({<br/>          destPath,<br/>          pagesPath,<br/>          pageExtensions,<br/>          ...sitemapOptions,<br/>        })<br/>      );<br/>      // Hooking the Sitemap Plugin - end</span><span id="d2aa" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">return </strong>config;<br/>    },<br/>  };<br/>}</span><span id="bcef" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir"><em class="kx">module</em></strong>.<strong class="mo ir">exports </strong>= <em class="kx">withSitemap</em>;</span></pre><p id="ab13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在做一些事情。首先，我们使用析构语法为我们期望的选项提供一些合理的默认值。正如我们所讨论的，大多数Next.js应用程序将使用<code class="fe ml mm mn mo b">public</code>作为默认的<em class="kx">公共</em>文件夹，使用<code class="fe ml mm mn mo b">pages</code>作为默认的<em class="kx">页面</em>文件夹。然后我们通过一个<em class="kx">路径计算这些文件夹的实际路径。将</em>连接到由<em class="kx"> options.dir </em>指定的根目录。我们也将<code class="fe ml mm mn mo b">pageExtensions</code> Next.js配置传递给我们的插件。这是一个鲜为人知的配置，允许开发人员定义哪些文件扩展名将被视为pages文件夹下的页面文件(例如，<code class="fe ml mm mn mo b">.page.js</code>而不是<code class="fe ml mm mn mo b">.js</code>)。</p><h2 id="f613" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">实现实际的站点地图生成🎉</h2><p id="8f1e" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">我们最终把所有东西都捆绑到了我们的webpack插件上。现在是生成实际文件的时候了。我们将依靠几个外部库来完成这项工作。让我们添加它们:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="4fcb" class="ky kz iq mo b gy mx my l mz na">$ yarn add x2js xml-formatter glob schema-utils clean-webpack-plugin</span></pre><p id="51a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在库已经安装好了，让我们把代码放到插件中，讨论一下:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="a5b2" class="ky kz iq mo b gy mx my l mz na">// at config/webpack/SitemapPlugin.js (final code)</span><span id="3d40" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>fs = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"fs"</strong>);<br/><strong class="mo ir">const </strong>path = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"path"</strong>);</span><span id="462d" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>{ CleanWebpackPlugin } = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"clean-webpack-plugin"</strong>);<br/><strong class="mo ir">const </strong>validateOptions = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"schema-utils"</strong>);<br/><strong class="mo ir">const </strong>X2JS = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"x2js"</strong>);<br/><strong class="mo ir">const </strong><em class="kx">format </em>= <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"xml-formatter"</strong>);<br/><strong class="mo ir">const </strong>glob = <strong class="mo ir"><em class="kx">require</em></strong>(<strong class="mo ir">"glob"</strong>);</span><span id="4df7" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>schema = {<br/>  <strong class="mo ir">type</strong>: <strong class="mo ir">"object"</strong>,<br/>  <strong class="mo ir">properties</strong>: {<br/>    <strong class="mo ir">domain</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">destPath</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">pagesPath</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">pagesExtension</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"array"</strong>,<br/>    },<br/>    <strong class="mo ir">generateRobots</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"boolean"</strong>,<br/>    },<br/>    <strong class="mo ir">generateSitemap</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"boolean"</strong>,<br/>    },<br/>    <strong class="mo ir">robotsFilename</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>    <strong class="mo ir">sitemapFilename</strong>: {<br/>      <strong class="mo ir">type</strong>: <strong class="mo ir">"string"</strong>,<br/>    },<br/>  },<br/>};</span><span id="bbf1" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">class </strong>SitemapPlugin {<br/>  constructor(options) {<br/>    validateOptions(schema, options, <strong class="mo ir">"SitemapPlugin"</strong>);<br/>    <strong class="mo ir">this</strong>.<strong class="mo ir">options </strong>= options;<br/>  }</span><span id="110f" class="ky kz iq mo b gy nb my l mz na">  apply(compiler) {<br/>    <strong class="mo ir">const </strong>{<br/>      domain,<br/>      destPath,<br/>      pagesPath,<br/>      pageExtensions,<br/>      generateRobots = <strong class="mo ir">true</strong>,<br/>      generateSitemap = <strong class="mo ir">true</strong>,<br/>      robotsFilename = <strong class="mo ir">"robots.txt"</strong>,<br/>      sitemapFilename = <strong class="mo ir">"sitemap.xml"</strong>,<br/>    } = <strong class="mo ir">this</strong>.<strong class="mo ir">options</strong>;<br/>    <strong class="mo ir">const </strong>robotsDest = path.join(destPath, robotsFilename);<br/>    <strong class="mo ir">const </strong>sitemapDest = path.join(destPath, sitemapFilename);</span><span id="ee06" class="ky kz iq mo b gy nb my l mz na">    <strong class="mo ir">new </strong>CleanWebpackPlugin({<br/>      <strong class="mo ir">cleanOnceBeforeBuildPatterns</strong>: [robotsDest, sitemapDest],<br/>    }).apply(compiler);</span><span id="9003" class="ky kz iq mo b gy nb my l mz na">compiler.<strong class="mo ir">hooks</strong>.<strong class="mo ir">done</strong>.<strong class="mo ir">tap</strong>(<strong class="mo ir">"SitemapPlugin"</strong>, () =&gt; {<br/>      <strong class="mo ir">const </strong>x2js = <strong class="mo ir">new </strong>X2JS();<br/>      <strong class="mo ir">const </strong>pages = glob<br/>        .<em class="kx">sync</em>(<strong class="mo ir">`**/*.+(</strong>${pageExtensions.join(<strong class="mo ir">","</strong>)}<strong class="mo ir">)`</strong>, { <strong class="mo ir">cwd</strong>: pagesPath })<br/>        .map((page) =&gt;<br/>          page.replace(<br/>            <strong class="mo ir">new <em class="kx">RegExp</em></strong>(<br/>              <strong class="mo ir">`(.*?)(index)?\\.(</strong>${pageExtensions<br/>                .map((ext) =&gt; ext.replace(<strong class="mo ir">"."</strong>, <strong class="mo ir">"\\."</strong>))<br/>                .join(<strong class="mo ir">"|"</strong>)}<strong class="mo ir">)`<br/>            </strong>),<br/>            <strong class="mo ir">"$1"<br/>          </strong>)<br/>        )<br/>        .filter((page) =&gt; !page.startsWith(<strong class="mo ir">"_"</strong>));</span><span id="475b" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir">const </strong>date = <strong class="mo ir">new <em class="kx">Date</em></strong>().toISOString().slice(0, 10);<br/>      <strong class="mo ir">const </strong>sitemapObj = {<br/>        <strong class="mo ir">urlset</strong>: {<br/>          <strong class="mo ir">_xmlns</strong>: <strong class="mo ir">"https://www.sitemaps.org/schemas/sitemap/0.9/"</strong>,<br/>          <strong class="mo ir">url</strong>: [],<br/>        },<br/>      };</span><span id="5bd5" class="ky kz iq mo b gy nb my l mz na">      pages.forEach((page) =&gt; {<br/>        sitemapObj.<strong class="mo ir">urlset</strong>.<strong class="mo ir">url</strong>.push({<br/>          <strong class="mo ir">loc</strong>: <strong class="mo ir">`</strong>${domain}<strong class="mo ir">/</strong>${page}<strong class="mo ir">`</strong>,<br/>          <strong class="mo ir">lastmod</strong>: date,<br/>        });<br/>      });</span><span id="cbe7" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir">if </strong>(robots) {<br/>        <strong class="mo ir">const </strong>robotsTxt = <strong class="mo ir">`User-agent: *\nAllow: /\nSitemap: </strong>${domain}<strong class="mo ir">/</strong>${sitemapFilename}<strong class="mo ir">`</strong>;<br/>        fs.<em class="kx">writeFileSync</em>(robotsDest, robotsTxt, {<br/>          <strong class="mo ir">flag</strong>: <strong class="mo ir">"as"</strong>,<br/>        });<br/>      }</span><span id="b574" class="ky kz iq mo b gy nb my l mz na">      <strong class="mo ir">if </strong>(sitemap) {<br/>        <strong class="mo ir">const </strong>sitemapXml = <em class="kx">format</em>(<br/>          <strong class="mo ir">`&lt;?xml version="1.0" encoding="UTF-8"?&gt;</strong>${x2js.js2xml(sitemapObj)}<strong class="mo ir">`</strong>,<br/>          {<br/>            <strong class="mo ir">collapseContent</strong>: <strong class="mo ir">true</strong>,<br/>          }<br/>        );<br/>        fs.<em class="kx">writeFileSync</em>(sitemapDest, sitemapXml, {<br/>          <strong class="mo ir">flag</strong>: <strong class="mo ir">"as"</strong>,<br/>        });<br/>      }<br/>    });<br/>  }<br/>}</span><span id="e706" class="ky kz iq mo b gy nb my l mz na"><strong class="mo ir"><em class="kx">module</em></strong>.<strong class="mo ir">exports </strong>= SitemapPlugin;</span></pre><p id="3d3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，首先，我们使用CleanWebpackPlugin为<em class="kx"> sitemap.xml </em>和<em class="kx"> robots.txt </em>清除任何现有文件(可能来自以前的构建)。然后我们创建一个钩子，一旦编译器做了其他的事情，它就会运行。在这个钩子的处理程序中，我们使用了一个<a class="ae kw" href="https://en.wikipedia.org/wiki/Glob_(programming)" rel="noopener ugc nofollow" target="_blank"> glob模式</a>来遍历<em class="kx"> pagesPath中的每个页面文件名。</em>我们利用模式中的<em class="kx">页面扩展</em>来确保我们不会遍历不应该被认为是页面文件的文件名。然后，我们执行一个正则表达式替换，后面跟着一个过滤器，以获得这些页面文件将映射到的URL的干净列表(例如，<code class="fe ml mm mn mo b">pages/auth/login.js</code>变成了<code class="fe ml mm mn mo b">auth/login</code>)。</p><blockquote class="lw"><p id="e7e8" class="lx ly iq bd lz ma mb mc md me mf kv dk translated">恭喜，您刚刚创建了一个更高阶的Next.js配置，它为您的页面生成sitemap.xml。</p></blockquote><p id="9ce0" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">一旦我们知道将什么路径放入<em class="kx"> sitemap.xml </em>中，下一步实际上就是生成xml。为此，我们依赖这个叫做<a class="ae kw" href="https://github.com/x2js/x2js#readme" rel="noopener ugc nofollow" target="_blank"> x2js </a>的酷库。这个库使我们能够将普通的JavaScript对象转换成XML字符串。使用<code class="fe ml mm mn mo b">domain</code>选项和我们刚刚计算的相对页面URL，我们开始创建我们的XML对象，其中根是<code class="fe ml mm mn mo b">&lt;urlset&gt;</code>、<em class="kx">、</em>，每个URL都有一个<code class="fe ml mm mn mo b">&lt;url&gt;</code>条目。最后，我们依靠<code class="fe ml mm mn mo b">fs</code>将我们生成的内容放入<em class="kx"> sitemap.xml </em>和<em class="kx"> robots.txt. </em></p><h2 id="6436" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">让我们看看它的实际效果。</h2><p id="a896" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">现在，如果您继续运行<code class="fe ml mm mn mo b">yarn next build</code>，您应该会看到<code class="fe ml mm mn mo b">sitemap.xml</code>和<code class="fe ml mm mn mo b">robots.txt</code>都在您的<code class="fe ml mm mn mo b">public</code>文件夹中生成，它们将由Next.js在您的根域中提供服务。git忽略这两个文件，这样它们就不会提交到您的版本控制中。</p><h2 id="6374" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">潜在的改进</h2><p id="37d6" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">人们可以将更多的信息放到<em class="kx"> sitemap.xml </em>中，比如<em class="kx"> changefreq </em>和<em class="kx"> priority </em>(以及<em class="kx"> robots.txt </em> ) <em class="kx">。我们可以简单地在Next.js配置中添加更多选项来捕获这些数据，并将其传递给我们的插件。我们目前也不处理任何动态URL(例如<code class="fe ml mm mn mo b">pages/user/[id].js</code>)。这将是一个受欢迎的补充。</em></p><p id="da62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">听起来是个不错的主意？也许在https://github.com/cansin/next-with-sitemap<a class="ae kw" href="https://github.com/cansin/next-with-sitemap" rel="noopener ugc nofollow" target="_blank">创建一个拉请求(无耻的插头🤓).</a></p><h2 id="820b" class="ky kz iq bd la lb lc dn ld le lf dp lg kj lh li lj kn lk ll lm kr ln lo lp lq bi translated">结论</h2><p id="d9a6" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">一旦你学会了这种通用模式来实现自我封装的Next.js配置改进，管理你的配置将变得毫不费力，也许还能得到你希望存在的库。我希望这是对你当前/下一个项目有价值的信息。</p></div></div>    
</body>
</html>