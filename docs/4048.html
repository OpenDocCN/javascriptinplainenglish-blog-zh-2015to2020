<html>
<head>
<title>How To Log Like A Boss With Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Node.js像老板一样登录</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/log-like-a-boss-nodejs-a10f57a8e3fc?source=collection_archive---------7-----------------------#2020-11-12">https://javascript.plainenglish.io/log-like-a-boss-nodejs-a10f57a8e3fc?source=collection_archive---------7-----------------------#2020-11-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b2238ec7310a413d2dc926a6f86b39b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cALRwr7nBjGsuj5d5_6jsA.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Credits <a class="ae jz" href="https://www.baileyjavinscarter.com/wp-content/uploads/2019/08/logging-accident-1030x429.jpg" rel="noopener ugc nofollow" target="_blank">https://www.baileyjavinscarter.com/wp-content/uploads/2019/08/logging-accident-1030x429.jpg</a></figcaption></figure><p id="13a8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">过去几周对我来说很艰难。挑战性和长达数周的工作时间背后的原因是推出已经开发了七年的后端的新版本。日复一日，直到今年九月，代码库随着每一个新特性和错误修复而变得越来越大。我在2019年7月加入了这个旅程，和我的同事们一起付出了这么多努力。</p><p id="084e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，我们将应用程序分成两个逻辑分区。一个用于客户，一个用于服务提供商。然后，我们决定开始对“服务提供商”进行彻底改革，因为业务逻辑在这方面很重要。然后我们把代码库分成微服务。压力越大，忽略的东西越多。</p><p id="8d85" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当他们施加更大的压力时，高层决定忽略这些事情。最终，我们有了一个包含一些功能和一堆微服务的整体后端。可以想象事情变得复杂了。但是我们有一样东西要坚持！这是我们的伐木策略。我们记录了每一步。当一个错误发生时，我们只是打开CloudWatch日志并询问，相信我，五分钟或更短时间后，问题就在你的眼前。</p><h1 id="906c" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们是如何做到的</h1><p id="1d15" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">我们使用Node.js作为后端。说到伐木，我们有很多选择。他们都很好，但其中有一个是杰作，那就是温斯顿。我喜欢Winston，因为它很容易配置，社区也很好。它有很好的文档。你可以用传送器在任何你想去的地方记录。您也可以创建自己的自定义传输。您可以为所有日志级别单独配置Winston，从何处以及如何进行日志记录。</p><p id="b8c1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是最佳实践是将数据源从代码中分离出来。我们将Winston配置为很好地登录到控制台，并使用fluentd获取全部输出，然后填充CloudWatch。</p><p id="80c2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">CloudWatch Log Insights根本不是一项预算友好的服务，但它使您能够交互式地搜索和分析您的日志数据。您可以执行查询来帮助您更高效地响应操作问题。可以保存查询并根据您的需求创建仪表板。</p><h1 id="97f4" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们需要什么？</h1><ul class=""><li id="606a" class="mb mc in kc b kd lw kh lx kl md kp me kt mf kx mg mh mi mj bi translated">nodejs^ 10xx . x</li><li id="0eb9" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx mg mh mi mj bi translated">代码编辑器，我选择VS代码，</li><li id="cc98" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx mg mh mi mj bi translated">一个黑暗，完美的主题，我选择一个黑暗，为什么不呢？</li><li id="2ac2" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx mg mh mi mj bi translated">流体d</li></ul><p id="c009" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我将Fluentd作为一项要求添加，但我不会介绍如何安装或运行它。AWS上关于FluentD和登录CloudWatch的文档很不错。请点击<a class="ae jz" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs.html" rel="noopener ugc nofollow" target="_blank">链接获取流量</a>。</p><h1 id="90b2" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们开始吧！</h1><p id="6ec8" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">首先，我们需要创建Node.js项目并安装软件包。</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="d8e1" class="my kz in mu b gy mz na l nb nc">mkdir winston-logger &amp;&amp; cd winston-logger <br/>npm init -y #this will skip prompts<br/>npm install --save winston winston-cloudwatch winston-slack-webhook-transport <br/>touch logger.js<br/>touch index.js</span></pre><p id="fcc1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们准备好记录了！Winston提供了<code class="fe nd ne nf mu b">error</code>、<code class="fe nd ne nf mu b">verbose</code>、<code class="fe nd ne nf mu b">silly</code>、<code class="fe nd ne nf mu b">info</code>、<code class="fe nd ne nf mu b">debug</code>等分级日志。您可以为所有日志级别单独配置Winston，从何处以及如何进行日志记录。我只是简单地使用信息测试的目的，但我会稍后配置水平。</p><p id="d49e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> logger.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="e78a" class="my kz in mu b gy mz na l nb nc">const winston = require('winston');</span><span id="5564" class="my kz in mu b gy ng na l nb nc">module.exports = winston;</span></pre><p id="4469" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> index.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="a9f8" class="my kz in mu b gy mz na l nb nc">const logger = require('./logger');<br/>logger.info('Test Log', {});</span></pre><p id="afc0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您使用<code class="fe nd ne nf mu b">node index.js</code>跑步，您将获得:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="67ab" class="my kz in mu b gy mz na l nb nc">[winston] Attempt to write logs with no transports {"message":"Test Log","level":"info"}</span></pre><p id="0b9c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为我们还没有配置它。我添加了一个名为logger的变量并创建了一个实例。默认情况下，Winston可以将数据记录到<strong class="kc io">控制台、文件、Http </strong>中。我现在选择<strong class="kc io">文件</strong>,稍后将研究其他传输选项。您需要提供日志级别和文件名。详细日志记录将记录每个级别。如果您想要记录特定级别，请将级别更改为信息、错误或警告。</p><p id="a986" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> logger.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="0d6e" class="my kz in mu b gy mz na l nb nc">const winston = require('winston');</span><span id="0328" class="my kz in mu b gy ng na l nb nc">const logger = winston.createLogger({<br/>        new winston.transports.File({ level: 'verbose', filename: 'log.out' }),<br/>    ],<br/>});</span><span id="07e5" class="my kz in mu b gy ng na l nb nc">module.exports = logger;</span></pre><p id="2120" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们运行我们的应用程序。如您所见，在我们的项目目录中有一个名为<strong class="kc io"> log.out </strong>的文件。我们做到了。</p><p id="0a4d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">注销</strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="308f" class="my kz in mu b gy mz na l nb nc">{"message": "Test Log","level": "info"}</span></pre><p id="6e66" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们通过提供格式来提高可读性。我还为不同的日志级别添加了传输策略。正如你所看到的，从现在开始，我们将把所有的事情记录到控制台中，但是只把错误记录到文件中。</p><p id="a325" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> logger.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="5fd3" class="my kz in mu b gy mz na l nb nc">const winston = require('winston');</span><span id="8a3b" class="my kz in mu b gy ng na l nb nc">const logger = winston.createLogger({<br/>    format: winston.format.printf((info) =&gt; JSON.stringify(info, null, 2)),<br/>    transports: [<br/>        new winston.transports.File({ level: 'error', filename: 'log.out' }),<br/>        new winston.transports.Console({ level: 'verbose' }),<br/>    ],<br/>});</span><span id="c914" class="my kz in mu b gy ng na l nb nc">module.exports = logger;</span></pre><p id="2ae9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们运行它，就像我说的对吗？现在，我将添加一些默认值并组合格式。</p><p id="4b4e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> logger.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="7625" class="my kz in mu b gy mz na l nb nc">const winston = require('winston');</span><span id="04e7" class="my kz in mu b gy ng na l nb nc">const logger = winston.createLogger({<br/>    format: winston.format.combine(<br/>        winston.format.timestamp({<br/>            format: 'YYYY-MM-DD HH:mm:ss',<br/>        }),<br/>        winston.format.printf((info) =&gt; {<br/>            let logData = { ...info };</span><span id="580f" class="my kz in mu b gy ng na l nb nc">            if (info.error instanceof Error) {<br/>                logData.error = {<br/>                    message: info.error.message,<br/>                    stack: info.error.stack,<br/>                };<br/>            }</span><span id="29b3" class="my kz in mu b gy ng na l nb nc">            return JSON.stringify(logData, null, 2);<br/>        }),<br/>    ),<br/>    transports: [<br/>        new winston.transports.File({ level: 'error', filename: 'log.out' }),<br/>        new winston.transports.Console({ level: 'verbose' }),<br/>    ],<br/>});</span><span id="1013" class="my kz in mu b gy ng na l nb nc">module.exports = logger;</span></pre><p id="8b4d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> index.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="69da" class="my kz in mu b gy mz na l nb nc">const logger = require('./logger');<br/>logger.info('Test Log info', { error: new Error('test') });</span></pre><p id="945d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们来分解一下，我使用<code class="fe nd ne nf mu b">winston.format.combine</code>将这些格式组合在一起。这个函数以格式选项作为参数，你可以使用默认的函数如<strong class="kc io"> timestamp()、printf()、simple()、colorize() </strong>。我们可以将可选对象传递给日志，但是传递错误将是空的。因为Error对象没有它的可枚举属性，所以它打印一个空对象。</p><p id="03d0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，我检查了参数类型，并用错误堆栈更改了它。当您运行代码时，输出如下所示。</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="b9de" class="my kz in mu b gy mz na l nb nc">{<br/>  "error": {<br/>    "message": "test",<br/>    "stack": "Error: test\\n    at Object.&lt;anonymous&gt; (C:\\\\Users\\\\Eren\\\\Desktop\\\\winston-logger\\\\index.js:114:39)\\n    at Module._compile (internal/modules/cjs/loader.js:1137:30)\\n   <br/> at Object.Module._extensions..js (internal/modules/cjs/loader.js:1157:10)\\n    at Module.load (internal/modules/cjs/loader.js:985:32)\\n    at Function.Module._load (internal/modules/cjs/loader.js:878:14)\\n    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:71:12)\\n    at internal/main/run_main_module.js:17:47"<br/>  },<br/>  "level": "info",<br/>  "message": "Test Log info",<br/>  "timestamp": "2020-11-10 23:03:29"<br/>}</span></pre><p id="1103" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">奖金</strong></p><p id="7832" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">也是<strong class="kc io"> logger.js </strong>的最终版本。不要忘记提供Slack和CloudWatch的密钥。</p><p id="35b0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> logger.js </strong></p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="9fab" class="my kz in mu b gy mz na l nb nc">const winston = require('winston');<br/>const SlackHook = require('winston-slack-webhook-transport');<br/>const WinstonCloudWatch = require('winston-cloudwatch');</span><span id="2db9" class="my kz in mu b gy ng na l nb nc">const logger = winston.createLogger({<br/>    format: winston.format.combine(<br/>        winston.format.timestamp({<br/>            format: 'YYYY-MM-DD HH:mm:ss',<br/>        }),<br/>        winston.format.printf((info) =&gt; {<br/>            let logData = { ...info };</span><span id="790c" class="my kz in mu b gy ng na l nb nc">            if (info.error instanceof Error) {<br/>                logData.error = {<br/>                    message: info.error.message,<br/>                    stack: info.error.stack,<br/>                };<br/>            }</span><span id="2547" class="my kz in mu b gy ng na l nb nc">            return JSON.stringify(logData, null, 2);<br/>        }),<br/>    ),<br/>    transports: [<br/>        new winston.transports.File({ level: 'error', filename: 'log.out' }),<br/>        new winston.transports.Console({ level: 'verbose' }),<br/>    ],<br/>});</span><span id="6c52" class="my kz in mu b gy ng na l nb nc">logger.add(<br/>    new SlackHook({<br/>        webhookUrl: 'SLACK.WEBHOOK_URL',<br/>        channel: '#SLACK.CHANNEL',<br/>        username: 'SLACK.USERNAME',<br/>        iconEmoji: ':warning:',<br/>        formatter: (info) =&gt; ({<br/>            text: `_${info.timestamp}_\\n*${info.level.toUpperCase()}:*\\n&gt;${info.message}`,<br/>            attachments: [<br/>                {<br/>                    text: `\\`\\`\\`${JSON.stringify(logData, null, 2)}\\`\\`\\``,<br/>                },<br/>            ],<br/>        }),<br/>        level: 'error',<br/>    }),<br/>);</span><span id="5fef" class="my kz in mu b gy ng na l nb nc">logger.add(<br/>    new WinstonCloudWatch({<br/>        logGroupName: 'CLOUD_WATCH_LOG_GROUP',<br/>        logStreamName: 'CLOUD_WATCH_STREAM_NAME',<br/>        level: 'verbose',<br/>        messageFormatter: (info) =&gt; JSON.stringify(logData, null, 2),<br/>    }),<br/>);</span><span id="846c" class="my kz in mu b gy ng na l nb nc">module.exports = logger;</span></pre><p id="3920" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以我们到了最后，你现在可以像老板一样登录了。有能力记录总是好的，当谈到狩猎错误。希望这个配置对你有帮助。如果你有任何问题或建议，请在评论中告诉我。更多类似这样的内容可以关注我。</p><p id="c497" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">敬请期待！</strong></p></div></div>    
</body>
</html>