<html>
<head>
<title>Storing User Sessions on the Server with Express-Session</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用快速会话在服务器上存储用户会话</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/storing-user-sessions-on-the-server-with-express-session-422fe11bc500?source=collection_archive---------0-----------------------#2020-03-17">https://javascript.plainenglish.io/storing-user-sessions-on-the-server-with-express-session-422fe11bc500?source=collection_archive---------0-----------------------#2020-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a811349defeea015b7bc342c7b8827fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Ann4QreIzvUHReT"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@carlosm2514?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Carlos Macías</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b318" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了存储机密的会话数据，我们可以使用<code class="fe lb lc ld le b">express-session</code>包。它将会话数据存储在服务器上，并为客户端提供一个会话ID来访问会话数据。</p><p id="00a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究如何使用它来存储临时用户数据。</p><h1 id="d17c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">装置</h1><p id="d8e7" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">express-session</code>是节点包。我们可以通过运行以下命令来安装它:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="714e" class="mq lg iq le b gy mr ms l mt mu">npm install express-session</span></pre><p id="036d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过添加以下内容将它包含在我们的应用程序中:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="3371" class="mq lg iq le b gy mr ms l mt mu">const session = require('express-session');</span></pre><h1 id="339f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用</h1><p id="0c73" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lb lc ld le b">session</code>函数返回一个中间件，让我们存储会话。它采用具有以下属性的选项对象:</p><h2 id="e9f2" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">甜饼干</h2><p id="cdcf" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">会话ID cookie的设置对象。默认值为:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="b092" class="mq lg iq le b gy mr ms l mt mu">{ path: '/', httpOnly: true, secure: false, maxAge: null }<!-- -->.</span></pre><p id="1b84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它具有以下属性:</p><p id="e77e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.domain </strong></p><p id="f58f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它指定了<code class="fe lb lc ld le b">Domain Set-Cookie</code>属性的值。默认情况下没有设置域。大多数客户端会认为cookie只适用于当前域。</p><p id="aaac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.expires </strong></p><p id="4c91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这为<code class="fe lb lc ld le b">Expires Set-Cookie</code>属性的值指定了<code class="fe lb lc ld le b">Date</code>对象。默认情况下不设置截止日期。这意味着cookie将在会话结束时被删除。</p><p id="8176" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果<code class="fe lb lc ld le b">expires</code>和<code class="fe lb lc ld le b">maxAge</code>都被设置，那么最后一个被定义。<code class="fe lb lc ld le b">expires</code>不该直接设定。我们应该设置<code class="fe lb lc ld le b">maxAge</code>。</p><p id="0d4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.httpOnly </strong></p><p id="8242" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">指定<code class="fe lb lc ld le b">HttpOnly Set-Cookie</code>属性的布尔值。如果为真，则设置<code class="fe lb lc ld le b">HttpOnly</code>属性。否则就不是了。默认情况下，仅设置<code class="fe lb lc ld le b">HttpOnly</code>属性。</p><p id="667e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.maxAge </strong></p><p id="1fd4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">计算<code class="fe lb lc ld le b">Expires Set-Cookie</code>属性时使用的毫秒数。这是通过将当前服务器时间加上<code class="fe lb lc ld le b">maxAge</code>毫秒来计算<code class="fe lb lc ld le b">Expires</code>日期时间。默认情况下没有设置最大年龄。</p><p id="738d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.path </strong></p><p id="a52a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置<code class="fe lb lc ld le b">Path Set-Cookie</code>属性值。默认设置为<code class="fe lb lc ld le b">/</code>，这是域的根路径。</p><p id="d8ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.sameSite </strong></p><p id="0635" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用于表示<code class="fe lb lc ld le b">SameSite Set-Cookie</code>属性的值的布尔值或字符串。它可以是:</p><ul class=""><li id="0e8e" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated"><code class="fe lb lc ld le b">true</code> —将<code class="fe lb lc ld le b">SameSite</code>属性设置为<code class="fe lb lc ld le b">Strict</code>，以严格执行相同站点</li><li id="e5c0" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">false</code> —不设置<code class="fe lb lc ld le b">SameSite</code>属性</li><li id="8e90" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">'lax'</code> —将<code class="fe lb lc ld le b">SameSite</code>属性设置为<code class="fe lb lc ld le b">Lax</code>,以表示宽松的同站点执行</li><li id="ac74" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">'strict'</code>将<code class="fe lb lc ld le b">SameSite</code>属性设置为<code class="fe lb lc ld le b">Strict</code>以进行严格的同站点执行</li></ul><p id="33d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> cookie.secure </strong></p><p id="9b82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">Secure Set-Cookie</code>属性的布尔值。设置了<code class="fe lb lc ld le b">Secure</code>属性。否则就不是了。</p><p id="d41d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果设置为<code class="fe lb lc ld le b">true</code>，则不会通过HTTP连接发送Cookies。</p><p id="5dfb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，还是推荐。如果应用托管在代理之后，那么如果<code class="fe lb lc ld le b">secure</code>设置为<code class="fe lb lc ld le b">true</code>，则必须设置<code class="fe lb lc ld le b">trust proxy</code>。</p><h2 id="936b" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">genid</h2><p id="6445" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">生成新会话ID的函数。默认值是一个使用<code class="fe lb lc ld le b">uid-safe</code>库生成id的函数。</p><h2 id="152e" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">名字</h2><p id="c2ec" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">要在响应中设置的会话ID cookie的名称。默认值为<code class="fe lb lc ld le b">'connect.sid'</code>。</p><h2 id="4d75" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">代理人</h2><p id="83c2" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">通过<code class="fe lb lc ld le b">X-Forwarded-Proto</code>头设置cookies时信任反向代理。</p><p id="c489" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认值为<code class="fe lb lc ld le b">undefined</code>。其他可能性包括:</p><ul class=""><li id="3bbe" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated"><code class="fe lb lc ld le b">true</code> —将使用<code class="fe lb lc ld le b">X-Forwarded-Proto</code>割台</li><li id="c757" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">false</code> —忽略所有标头，仅当连接是直接SSL/TLS连接时，才认为该连接是安全的</li><li id="88ba" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">undefined</code> —使用快速设置中的<code class="fe lb lc ld le b">'trust proxy'</code>设置</li></ul><h2 id="36a7" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">重新保存</h2><p id="4b67" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">强制将会话保存回会话存储，即使该会话在请求期间从未被修改。</p><p id="9782" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当一个客户端向我们的服务器发出两个并行请求时，这可能会造成争用情况，并且在一个请求上对会话所做的更改可能会在另一个请求结束时被覆盖。</p><p id="e7d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认为<code class="fe lb lc ld le b">true</code>，但默认可能会在将来改变。<code class="fe lb lc ld le b">false</code>作为选项更有意义。</p><h2 id="61e5" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">旋转</h2><p id="3d03" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">强制在每个响应上设置会话标识符cookie。到期时间被重置为原来的<code class="fe lb lc ld le b">maxAge</code>，重置到期倒计时。</p><p id="8951" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认为<code class="fe lb lc ld le b">false</code>。</p><p id="0066" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当此选项设置为<code class="fe lb lc ld le b">true</code>且<code class="fe lb lc ld le b">saveUnintialized</code>选项为<code class="fe lb lc ld le b">false</code>时，cookie不会在未初始化会话的响应上设置</p><h2 id="5233" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">存储单元化</h2><p id="297b" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">强制将未初始化的会话保存到存储中。当会话是新的但未被修改时，它是未初始化的。将此项设置为<code class="fe lb lc ld le b">false</code>可减少服务器存储空间的使用，并符合存储cookies前需要许可的法律。</p><h2 id="cc8e" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">秘密</h2><p id="f7fa" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">这是密码签名会话ID cookie的必需选项。它可以是一个字符串或多个字符串机密的数组。</p><h2 id="c279" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">商店</h2><p id="6096" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">会话存储实例。它默认为一个新的<code class="fe lb lc ld le b">MemoryStore</code>实例。</p><h2 id="6f1b" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">复原</h2><p id="5b6f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">通过<code class="fe lb lc ld le b">delete</code>控制取消<code class="fe lb lc ld le b">req.session</code>的设置，设置为<code class="fe lb lc ld le b">null</code>等的结果。</p><p id="958b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认为<code class="fe lb lc ld le b">'keep'</code>。可能的值有:</p><ul class=""><li id="ec49" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated"><code class="fe lb lc ld le b">'destroy'</code> —当响应结束时，会话将被删除</li><li id="f090" class="ng nh iq kf b kg np kk nq ko nr ks ns kw nt la nl nm nn no bi translated"><code class="fe lb lc ld le b">'keep'</code> —将保留会话，但不保存请求期间所做的修改。</li></ul><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/5d6b5542e04306fb5f8e4692870a3b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vLx1CDCEw1sSCKRK"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jentheodore?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jen Theodore</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2b34" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">请求会话</h1><p id="2858" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们通过使用<code class="fe lb lc ld le b">req.session</code>来访问会话数据。数据通常是JSON格式的，所以嵌套对象没问题。</p><p id="1989" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">req.session</code>自带以下方法:</p><h2 id="a94f" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">重新生成(回调)</h2><p id="189a" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们称之为重新生成会话。一旦它被调用，一个新的会话ID和<code class="fe lb lc ld le b">Session</code>实例将在<code class="fe lb lc ld le b">req.session</code>被初始化，并且<code class="fe lb lc ld le b">callback</code>将被调用。</p><h2 id="0f74" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">销毁(回调)</h2><p id="ced4" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">销毁会话。<code class="fe lb lc ld le b">req.session</code>将被取消设置。一旦被调用，就会调用<code class="fe lb lc ld le b">callback</code>。</p><h2 id="09ab" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">重新加载(回调)</h2><p id="b35f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">从存储中重新加载会话数据，并重新填充<code class="fe lb lc ld le b">req.session</code>对象。一旦完成，就会调用<code class="fe lb lc ld le b">callback</code>。</p><h2 id="5782" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">保存(回调)</h2><p id="fa24" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">将会话保存回存储区，用内存中的内容替换存储区的内容。</p><p id="eccc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个一般不需要调用。</p><h2 id="cfc0" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">触摸()</h2><p id="4790" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">更新<code class="fe lb lc ld le b">maxAge</code>属性。这通常不应该被调用，因为这是自动完成的。</p><h2 id="d9cb" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">身份证明（identification）</h2><p id="cff0" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以用<code class="fe lb lc ld le b">id</code>属性获得会话ID。</p><h2 id="22da" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">甜饼干</h2><p id="a70c" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">该属性包含cookie内容。这也让我们可以为用户修改cookie。</p><p id="827e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Cookie.maxAge </strong></p><p id="4388" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以设置<code class="fe lb lc ld le b">maxAge</code>属性来改变以毫秒为单位的到期时间。</p><p id="57c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">cookie . original image</strong></p><p id="a43e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用它来获得最初的<code class="fe lb lc ld le b">maxAge</code>值，单位是毫秒。</p><h1 id="30cd" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">请求会话ID</h1><p id="2013" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以用<code class="fe lb lc ld le b">sessionId</code>获得加载会话的会话ID。</p><h1 id="9f7d" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">实现我们自己的会话存储</h1><p id="1963" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">会话存储必须用附加方法实现<code class="fe lb lc ld le b">EventEmitter</code>。</p><h2 id="150d" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.all(回调)</h2><p id="a293" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">一个可选的方法，将存储区中的所有会话作为一个数组。<code class="fe lb lc ld le b">callback</code>签名是<code class="fe lb lc ld le b">callback(error, sessions)</code>，一旦会话被检索，它就会被调用。</p><h2 id="6f9f" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.destroy(sid，回调)</h2><p id="8c5f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">在给定会话ID的情况下，从存储中删除会话所需的方法。回调有签名<code class="fe lb lc ld le b">callback(error)</code>。一旦会话被删除，它就会被调用。</p><h2 id="ca6a" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.clear(回调)</h2><p id="79e5" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">从存储中删除所有会话的可选方法。回调签名是<code class="fe lb lc ld le b">callback(error)</code>，它在商店清空后调用。</p><h2 id="4942" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">存储长度(回调)</h2><p id="2b17" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">计算存储中所有会话的可选方法。回调有签名<code class="fe lb lc ld le b">callback(error, len)</code>。</p><h2 id="f0a9" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.get(sid，回调)</h2><p id="7112" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">通过会话ID获取会话数据所需的方法(<code class="fe lb lc ld le b">sid</code>)。回调具有签名<code class="fe lb lc ld le b">callback(error, session)</code>。</p><p id="6cd3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果找到，则返回会话，否则返回<code class="fe lb lc ld le b">null</code>或<code class="fe lb lc ld le b">undefined</code>。</p><h2 id="47b1" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.set(sid、会话、回调)</h2><p id="06b3" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">给定会话ID<code class="fe lb lc ld le b">sid</code>，设置会话所需的方法。一旦会话被设置，回调就具有签名<code class="fe lb lc ld le b">callback(error)</code>。</p><h2 id="c30c" class="mq lg iq bd lh mv mw dn ll mx my dp lp ko mz na lt ks nb nc lx kw nd ne mb nf bi translated">store.touch(sid、会话、回调)</h2><p id="37e5" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">建议实施此方法。这用于向存储发出给定会话处于活动状态的信号。回调具有签名<code class="fe lb lc ld le b">callback(error)</code>。</p><h1 id="51fa" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">例子</h1><p id="7e7e" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">一个例子是存储浏览次数，并将该数据保存365天。我们可以这样做:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="b0fd" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const session = require('express-session');<br/>const app = express();<br/>app.set('trust proxy', 1)<br/>app.use(session({<br/>  secret: 'secret',<br/>  resave: true,<br/>  cookie: {<br/>    maxAge: 24 * 60 * 60 * 365 * 1000<br/>  }<br/>}))</span><span id="074a" class="mq lg iq le b gy nv ms l mt mu">app.use(bodyParser.json());<br/>app.use(bodyParser.urlencoded({ extended: true }));</span><span id="a38b" class="mq lg iq le b gy nv ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  if (req.session.views) {<br/>    req.session.views++;<br/>  }<br/>  else {<br/>    req.session.views = 1;<br/>  }<br/>  res.send(`${req.session.views} views`);<br/>})</span><span id="c76e" class="mq lg iq le b gy nv ms l mt mu">app.listen(3000);</span></pre><p id="708e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在代码中，我们使用了<code class="fe lb lc ld le b">secret</code>以便对cookie进行签名。然后在我们的路由处理器中，我们可以通过获取和设置我们创建的<code class="fe lb lc ld le b">req.session.views</code>来获取和设置数据。</p><p id="ab2c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们不断重新加载<code class="fe lb lc ld le b">/</code>路线时，我们应该会看到视图的数量。通过设置<code class="fe lb lc ld le b">maxAge</code>它将在365天内到期，因此该数字将继续上升。</p><p id="9771" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在响应头中，我们应该知道<code class="fe lb lc ld le b">Set-Cookie</code>响应头的值如下:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="4f3c" class="mq lg iq le b gy mr ms l mt mu">connect.sid=s%3Ad6jfPu5awWj3EXPF-MdtU8cPzjOY5NRT.33nyXjKdShPAPyw9WWwY4sywP44IOX5SPSt2WUkH0cs; Path=/; Expires=Mon, 28 Dec 2020 00:47:31 GMT; HttpOnly</span></pre><p id="e19b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有会话ID和到期时间的值。</p><h1 id="fc65" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="c098" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以使用<code class="fe lb lc ld le b">express-session</code>包在服务器端保存会话cookie数据。</p><p id="7300" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多选项，如各种cookie属性的内容和到期时间。</p><p id="420b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其他设置如ID，是否只在HTTPS保存cookie等等都可以设置。</p><p id="d8f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">cookies将存储在会话存储中。如果我们对现有的可供我们使用的商店不满意，我们也可以实现我们自己的商店。</p></div></div>    
</body>
</html>