# Nest.js & RabbitMQ ä¸­çš„æ­»å­—â€”â€”è¿™å¯èƒ½å—ï¼Ÿ

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/dead-lettering-in-nest-js-rabbitmq-is-it-even-possible-a6aa5732ef1d?source=collection_archive---------2----------------------->

ä¸Šå‘¨ï¼Œæˆ‘å‘ç°è‡ªå·±åœ¨åŠªåŠ›å¯»æ‰¾ä¸€äº›å…³äºä¸ Nest.js & RabbitMQ çš„æ­»ä¿¡äº¤æ¢çš„æ–‡æ¡£ã€‚æœ‰äº› GitHub é—®é¢˜æ¨èä½¿ç”¨å¤–éƒ¨åŒ…ï¼Œä½†æ˜¯ä½ å®é™…ä¸Šå¯ä»¥ç”¨æ™®é€šçš„ Nest.js æ¥å®ç°ï¼

æˆ‘ä»¬éœ€è¦ä¸€äº›å…³äº RabbitMQ å’Œ Nest.js çš„åŸºç¡€çŸ¥è¯†ã€‚

> å®Œæ•´çš„æºä»£ç å¯åœ¨[è¿™é‡Œ](https://github.com/NiklasPor/nestjs-rmq-dead-lettering)è·å¾—ã€‚å¦‚æœä½ æƒ³ç›´æ¥è·³åˆ°å‰é¢ã€‚

![](img/89e90bba62d244ee987d7195ece31df1.png)

Photo by [Joanna Kosinska](https://unsplash.com/@joannakosinska?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

# ä½ è¯´çš„è¿™ä¸ªæ­»å­—æ˜¯ä»€ä¹ˆï¼Ÿ

RabbitMQ æ­»ä¿¡æ¶ˆæ¯ï¼Œä»¥ä¸‹[ç‚¹ä¸­è‡³å°‘æœ‰ä¸€ç‚¹é€‚ç”¨äºè¯¥æ¶ˆæ¯](https://www.rabbitmq.com/dlx.html):

*   æ¶ˆæ¯è¢«æ‹’ç»æˆ–æœªç”¨`requeue: false`ç¡®è®¤ã€‚
*   æ¶ˆæ¯çš„ TTL(ç”Ÿå­˜æ—¶é—´)å·²è¿‡æœŸã€‚
*   è¯¥æ¶ˆæ¯å·²è¢«ä¸¢å¼ƒï¼Œå› ä¸ºå®ƒè¶…è¿‡äº†é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚

å¦‚æœæŒ‡å®šäº†æ­»ä¿¡äº¤æ¢ï¼Œåˆ™æ­»ä¿¡æ¶ˆæ¯å°†è¢«è½¬å‘åˆ°æ­»ä¿¡äº¤æ¢ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å°†å®ƒä»¬è½¬å‘åˆ°å¦ä¸€ä¸ª RabbitMQ é˜Ÿåˆ—ï¼Œå¹¶åœ¨é‚£é‡Œè¿›è¡Œå¤„ç†ã€‚è¿™ç§æ¨¡å¼éå¸¸é€‚åˆå®ç°å®¹é”™å·¥ä½œè€…ï¼

# æˆ‘ä»¬å°†å»ºé€ ä»€ä¹ˆï¼Ÿ

å¾ˆé«˜å…´ä½ é—®äº†ï¼æˆ‘ä»¬å°†æ„å»ºä¸¤ä¸ªæ¨¡æ‹Ÿæ±‰å ¡åˆ¶ä½œçš„å¾®æœåŠ¡ã€‚å¯æ‚²çš„æ˜¯ï¼Œæˆ‘ä»¬çš„å¨å¸ˆæ”¾å¼ƒäº†ä¸‰åˆ†ä¹‹ä¸€çš„æ±‰å ¡è‚‰é¥¼ã€‚æˆ‘ä»¬å°†å¼•å…¥ä¸€äº›é”™è¯¯å¤„ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

![](img/4fec789c57087f4ce1b887af492114e9.png)

Sequence Diagram of our Burger Ordering

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œåˆ¶ä½œä¸€ä¸ªæ±‰å ¡æœ‰ 4 ä¸ªç»„æˆéƒ¨åˆ†:

1.  æ±‰å ¡é˜Ÿåˆ—:æ¥æ”¶å…³äºæ±‰å ¡åˆ¶ä½œçš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶ä¸é¡¾å®¢æ²Ÿé€šã€‚
2.  Burger Worker:è·å–æ¥è‡ª`Burger Queue`çš„æ¶ˆæ¯å¹¶å¤„ç†å®ƒä»¬ã€‚
3.  æ¢å¤é˜Ÿåˆ—:æ¥æ”¶æ‰€æœ‰æ­»ä¿¡ã€‚
4.  æ¢å¤å·¥ä½œè€…:ä»`Recovery Queue`è·å–æ¶ˆæ¯ï¼Œå¹¶å°†å®ƒä»¬é‡å®šå‘åˆ°`Burger Queue`ã€‚è¿˜å°†é‡è¯•æ¬¡æ•°å¢åŠ  1ã€‚å¦‚æœé‡è¯•æ¬¡æ•°è¶…è¿‡ 4ï¼Œåˆ™å‘å‡ºå¤±è´¥ã€‚

# è®¾ç½® RabbitMQ

è®¾ç½® RabbitMQ æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ [Docker](https://docs.docker.com/get-docker/) :

```
docker run -d -p 15672:15672 -p 5672:5672 rabbitmq:3-management
```

æ‰§è¡Œè¿™ä¸ªå‘½ä»¤åï¼Œæ‚¨çš„ Docker å®ˆæŠ¤è¿›ç¨‹ä¸­å°†è¿è¡Œä¸€ä¸ª RabbitMQã€‚åœ¨`amqp://guest:guest@localhost:5672`æœ‰ï¼Œåœ¨`[http://localhost:15672](http://localhost:15672.)` [å¯ä»¥è¿›å…¥ç®¡ç†ç•Œé¢ã€‚](http://localhost:15672.)

> æ³¨æ„:å¯†ç å’Œç”¨æˆ·åéƒ½æ˜¯`*guest*`ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥è®¿é—® RabbitMQ æœ¬èº«å’Œç®¡ç†ç•Œé¢ã€‚

# è®¾ç½® Nest.js

é¦–å…ˆï¼Œæˆ‘ä»¬å°†é€šè¿‡ npm åœ¨å…¨çƒèŒƒå›´å†…å®‰è£… Nest CLI:

```
npm i -g @nestjs/cli
```

ç„¶åæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªåä¸º`burger-worker`çš„æ–°é¡¹ç›®:

```
nest new burger-worker
```

ç°åœ¨å‘é¡¹ç›®æ·»åŠ ç¬¬äºŒä¸ªåä¸º`recovery-worker`çš„åº”ç”¨ç¨‹åº:

```
cd burger-worker
nest g app recovery-worker
```

æ¥ä¸‹æ¥ï¼Œå°†åä¸º`shared`çš„åº“æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å…±äº«è¿æ¥å’Œæ¶ˆæ¯ä¿¡æ¯:

```
nest generate lib shared
```

å½“è¯¢é—®å‰ç¼€æ—¶ï¼Œåªéœ€ä¿ç•™é»˜è®¤çš„`@app`å¹¶æŒ‰å›è½¦é”®ã€‚

æœ€åï¼Œæˆ‘ä»¬å¿…é¡»æ·»åŠ ä¸€äº›ç”¨äºè¿æ¥ RabbitMQ å’Œåˆ›å»ºå¾®æœåŠ¡çš„åŒ…:

```
npm i @nestjs/microservices amqplib amqp-connection-manager
```

# åˆ›å»º RabbitMQ å’Œæ­»å­—è¿æ¥å‚æ•°

ä¸ºäº†ç»™ä¸¤ä¸ªé¡¹ç›®æä¾›é€‰é¡¹ï¼Œæˆ‘ä»¬å°†åœ¨å…±äº«åº“ä¸­åˆ›å»ºä¸€ä¸ª`queue-options.ts`æ–‡ä»¶ã€‚è¿™åŒ…æ‹¬æ­»ä¿¡äº¤æ¢çš„è®¾ç½®:

libs/shared/src/queue-options.ts

# åˆ›å»ºæ¶ˆæ¯

æˆ‘ä»¬è¿˜å°†æ·»åŠ ä¸€ä¸ª`messages.ts`æ–‡ä»¶åˆ°æˆ‘ä»¬çš„å…±äº«åº“ä¸­ã€‚è¿™å°†åŒ…æ‹¬æ‰€æœ‰æ¶ˆæ¯ã€‚æ¯æ¡æ¶ˆæ¯ç”±ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆ:

1.  æ¨¡å¼:æ¨¡å¼æ˜¯ä¸€ä¸ª`string`æˆ–`symbol`ï¼Œç”¨äºæ ‡è¯†æ¶ˆæ¯çš„ç±»å‹ã€‚
2.  æœ‰æ•ˆè´Ÿè½½/æ•°æ®:æœ‰æ•ˆè´Ÿè½½æ˜¯æ¶ˆæ¯ä¸­æä¾›çš„å®é™…æ•°æ®ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä¸»è¦æ˜¯ä¸æ±‰å ¡ç›¸å…³çš„ä¸œè¥¿å’Œé‡è¯•æ¬¡æ•°ã€‚

libs/shared/src/messages.ts

è¯·è®°ä½å¯¼å‡ºâ€œindex.tsâ€æ–‡ä»¶ä¸­çš„æ¶ˆæ¯å’Œé˜Ÿåˆ—é€‰é¡¹:

libs/shared/src/index.ts

# å°†æ±‰å ¡å·¥äººä¸å…”å­è¿æ¥èµ·æ¥

é¦–å…ˆ:ç”±äºæˆ‘ä»¬ä¸ä¼šå®ç°ä»»ä½•å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ç§»é™¤`app.service.ts`åŠå…¶æ‰€æœ‰å¼•ç”¨ã€‚

## ä¸»é¡µé¢

æˆ‘ä»¬éœ€è¦æ›¿æ¢`apps/burger-worker/src/main.ts`çš„å†…å®¹ã€‚è¿™åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œä½†æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå®ƒå°†ä½¿ç”¨`index.ts`ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªç®€å•çš„è®¾ç½®ä»£ç å®Œå…¨æ›¿æ¢`main.ts`:

apps/burger-worker/src/main.ts

## åº”ç”¨ç¨‹åºæ¨¡å—

æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æ±‰å ¡å·¥äººçš„`app.module.ts`ã€‚æˆ‘ä»¬æƒ³è¦å‘`burger-queue`å‘é€æ¶ˆæ¯ã€‚Nest.js çš„`ClientModule`ä¼šç»™æˆ‘ä»¬æä¾›è¿™ä¸ªåŠŸèƒ½:

apps/burger-worker/src/app.module.ts

## é¦–æ¬¡å¯åŠ¨

å¦‚æœæ‚¨å·²ç»å®Œæˆäº†ä¸Šè¿°æ‰€æœ‰æ­¥éª¤ï¼Œå¹¶ä¸”è¿˜æ¸…ç†äº†æ‚¨çš„`app.controller.ts`ï¼Œé‚£ä¹ˆæ‚¨ç°åœ¨å°±å¯ä»¥å¯åŠ¨`burger-worker`ï¼

```
nest start -w burger-worker
```

æ‚¨çš„ CLI åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·:

![](img/f139e282a879495e96b6bb6d517e1d18.png)

è¿™ä¹Ÿå°†åœ¨æˆ‘ä»¬çš„ RabbitMQ å®ä¾‹ä¸­åˆ›å»º`burger-queue`ã€‚æ‚¨å¯ä»¥é€šè¿‡æŸ¥çœ‹é˜Ÿåˆ—é€‰é¡¹å¡æ¥æ£€æŸ¥æ˜¯å¦ä¸€åˆ‡æ­£å¸¸:

[http://localhost:15672/#/queues](http://localhost:15672/#/queues)ã€‚

![](img/755488dc10492dd6b89fb1e4b629a87f.png)

> ç™»å½•ç®¡ç†ç•Œé¢çš„å¯†ç å’Œç”¨æˆ·åå‡ä¸º`*guest*`ã€‚ä»¥é˜²ä½ å¿˜äº†ğŸ‘Œ

# å®ç°æ±‰å ¡å·¥äºº

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ç€æ‰‹å®é™…çš„å®ç°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨`@EventPattern`è£…é¥°å™¨ä»æˆ‘ä»¬çš„`Burger Queue`æ¥æ”¶äº‹ä»¶(æ¶ˆæ¯)ã€‚`@Payload`å’Œ`@Ctx`è£…é¥°å™¨å¯ä»¥ç”¨æ¥æ¥æ”¶æ¶ˆæ¯ä¸Šä¸‹æ–‡ã€‚æˆ‘ä»¬éœ€è¦æ¶ˆæ¯ä¸Šä¸‹æ–‡æ¥ç¡®è®¤æˆ–æ‹’ç»æ¶ˆæ¯ã€‚

ä¸ºäº†å¤„ç† make burger æ¶ˆæ¯ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„æ¨¡å¼å’Œ`@EventPattern`è£…é¥°å™¨:

apps/burger-worker/src/app.controller.ts

å¦‚æœæ±‰å ¡å¯ä»¥æ¯«æ— é—®é¢˜åœ°å‡†å¤‡å¥½ï¼Œæˆ‘ä»¬å‘å‡ºæˆåŠŸ**å’Œ**ç¡®è®¤æˆ‘ä»¬å¤„ç†äº†æ¶ˆæ¯ã€‚RabbitMQ å°†çŸ¥é“å®ƒå¯ä»¥ä»é˜Ÿåˆ—ä¸­åˆ é™¤æ¶ˆæ¯ã€‚

## æ·»åŠ å¯¹å¤±è´¥å’ŒæˆåŠŸçš„å¤„ç†

æˆ‘ä»¬å°†æ·»åŠ ä¸€äº›ç®€å•çš„æ—¥å¿—ï¼Œè®°å½•æˆ‘ä»¬åœ¨åˆ¶ä½œæ±‰å ¡æ—¶æ˜¯å¦æˆåŠŸã€‚å¦å¤–ï¼Œå°†è¿™äº›å¤„ç†ç¨‹åºæ·»åŠ åˆ°æ‚¨çš„`app.controller.ts`ä¸­ã€‚

apps/burger-worker/src/app.controller.ts

> ä½ æ€»æ˜¯å¯ä»¥åœ¨è¿™é‡Œæ¯”è¾ƒä½ çš„åº“å’Œå®Œæˆçš„åº“ã€‚æˆ–è€…çœ‹ä¸€ä¸‹`*Burger Worker*`çš„æˆå“ [app.controller.ts](https://github.com/NiklasPor/nestjs-rmq-dead-lettering/blob/master/apps/burger-worker/src/app.controller.ts) ã€‚

## è¯•è¯•å§ï¼

å¯åŠ¨ burger worker å¹¶é€šè¿‡ RabbitMQ æ¥å£æäº¤ä¸€äº›æ¶ˆæ¯ã€‚è¦å‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œåªéœ€å•å‡»å®ƒå¹¶æä¾›æ¶ˆæ¯æ­£æ–‡:

![](img/fd499a2599c650f823ad42f4f4d69059.png)

[http://localhost:15672/#/queues/%2F/burger](http://localhost:15672/#/queues/%2F/burger)

åœ¨å‘å¸ƒæ¶ˆæ¯ **2** æ¬¡åï¼ŒCLI åº”è¯¥æ˜¾ç¤ºç¬¬ä¸€æ¬¡æˆåŠŸï¼Œç„¶åæ˜¾ç¤ºä¸€æ¬¡å¤±è´¥(å› ä¸ºå¨å¸ˆæ‰äº†ç¬¬ä¸‰ä¸ªæ±‰å ¡è‚‰é¥¼)ã€‚å¤±è´¥åï¼Œè¿™æ¡ä¿¡æ¯è¢«åºŸå¼ƒäº†ã€‚

![](img/812981811f9140d9cfdb76c43a3f99e7.png)

output after publishing the message **2** times

> ä½†æ˜¯ç­‰ç­‰ï¼æˆ‘ä»¬æ²¡æœ‰å®ç°æ¢å¤å·¥äººï¼Œå®ƒå¤„ç†æˆ‘ä»¬çš„æ­»ä¿¡æ¶ˆæ¯ï¼

# å°†æ¢å¤å·¥ä½œç¨‹åºè¿æ¥åˆ° RabbitMQ

è¿™å’Œæ±‰å ¡å·¥äººçš„æƒ…å†µåŸºæœ¬ç›¸åŒã€‚é™¤äº†æˆ‘ä»¬å¿…é¡»å°†`recovery-queue`è€Œä¸æ˜¯`burger-queue`æ·»åŠ åˆ°`main.ts`ä¸­ã€‚

apps/recovery-worker/src/main.ts

`app.module.ts`å®Œå…¨ç›¸åŒï¼Œå› ä¸ºæˆ‘ä»¬ä»ç„¶åªå‘`Burger Queue`å’Œ**å‘é€æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å‘`Recovery Queue`å‘é€**:

apps/recovery-worker/src/app.module.ts

# å®æ–½æ¢å¤é€»è¾‘

æ¢å¤é€»è¾‘éå¸¸ç®€å•ã€‚æˆ‘ä»¬æ­£åœ¨å¢åŠ æ¶ˆæ¯çš„é‡è¯•è®¡æ•°æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶å†æ¬¡å°†å…¶å‘é€åˆ°`Burger Queue`ã€‚å¦‚æœè¶…è¿‡äº†é‡è¯•é˜ˆå€¼ï¼Œæˆ‘ä»¬ä¼šå‘é€ä¸€æ¡å¤±è´¥æ¶ˆæ¯ã€‚

apps/recovery-worker/src/app.controller.ts

# è¿è¡Œæ‚¨çš„å¯æ‰©å±•å’Œå®¹é”™åº”ç”¨ğŸ‰

æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯æ ‡ç­¾ï¼Œè¿è¡Œ`nest start -w burger-worker`å’Œ`nest start -w recovery-worker`ã€‚ç°åœ¨å‘å¸ƒå’Œä»¥å‰ä¸€æ ·çš„æ¶ˆæ¯ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼

![](img/f3b7ef9e51026b35297b027b129303d7.png)

Output for: {patties: 2, customer: â€œJohnâ€}

å¦‚æœæˆ‘ä»¬ç°åœ¨ç‚¹äº† 3 ä¸ªä»¥ä¸Šçš„æ±‰å ¡(è®°ä½æˆ‘ä»¬çš„å¨å¸ˆæ¯ 3 ä¸ªå°±å¤±è´¥ä¸€ä¸ª)ï¼Œè¿™ä¸ªè®¢å•æ€»æ˜¯ä¼šå¤±è´¥ã€‚ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ‰§è¡Œæœ€å¤š 4 æ¬¡é‡è¯•ã€‚å¦‚æˆ‘ä»¬`Recovery Worker`ä¸­æ‰€è¿°:

![](img/f8bf069bda9449a82d829ee5373ccb13.png)

Output for: {patties: 4, customer: â€œSomeone Hungryâ€}

å¦‚æœæ²¡æœ‰`Burger Worker`å¯ç”¨ï¼Œæ¶ˆæ¯å°†åœ¨ 4 ç§’åè¶…æ—¶ã€‚ç„¶åæ¶ˆæ¯è¢«æˆ‘ä»¬çš„`Recovery Worker`å¤„ç†ã€‚é‡è¯• 4 æ¬¡åï¼Œå·¥äººå°†å‘å‡ºå¤±è´¥æ¶ˆæ¯:

![](img/66d2c647fad2a74f32e08b5f5289b906.png)

Output for no burger worker & {patties: 2, customer: â€œEmiliaâ€}

> è¿™ä¸ªæ±‰å ¡å®éªŒåˆ°æ­¤ç»“æŸã€‚å¦‚æœä½ æƒ³è¿›ä¸€æ­¥è¯•éªŒï¼Œä½ å¯ä»¥è¯•ç€å¯åŠ¨æ¯ä¸ª worker çš„å¤šä¸ªå®ä¾‹ã€‚çœ‹ä¸€çœ‹ï¼Œçœ‹çœ‹æ˜¯å¦ä¸€åˆ‡é¡ºåˆ©ï¼

æ­å–œä½ ï¼ä½ ç°åœ¨æ˜¯å°‘æ•°å‡ ä¸ªçŸ¥é“å¦‚ä½•åœ¨ Nest.js ä¸­ä½¿ç”¨æ­»å­—ä½“çš„äººä¹‹ä¸€ğŸ‘Œéå¸¸æ„Ÿè°¢æ‚¨èŠ±æ—¶é—´é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚å¦‚æœä½ æœ‰ä»»ä½•å…¬å¼€çš„é—®é¢˜ï¼Œè¯·åœ¨ Twitter [@niklaspor](https://twitter.com/niklaspor) ä¸Šç»™æˆ‘æ‰“ç”µè¯ï¼Œæˆ–è€…å‘è¡¨è¯„è®ºã€‚

> å®Œæˆé¡¹ç›®çš„æºä»£ç å¯åœ¨[è¿™é‡Œ](https://github.com/NiklasPor/nestjs-rmq-dead-lettering)è·å¾—ã€‚

ç¥æ‚¨æ„‰å¿«ï¼

å°¼å…‹æ‹‰æ–¯