<html>
<head>
<title>Use your own Components in Angular Forms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在角形中使用您自己的元件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-your-own-components-in-angular-forms-962b46025b87?source=collection_archive---------1-----------------------#2020-06-03">https://javascript.plainenglish.io/use-your-own-components-in-angular-forms-962b46025b87?source=collection_archive---------1-----------------------#2020-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/33492b0e53677b82c42d61dddfaab067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mAyFyTVYCo2-wuCZmKnfQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@codytdavis?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">davisco</a> on <a class="ae kc" href="https://unsplash.com/s/photos/colors?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="eb8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">棱角很适合造型。它对更改做出反应，跟踪表单的状态并验证用户输入。当创建一个反应式表单时，你可以在组件中创建表单控件，并在模板中添加一些指令，比如<code class="fe lb lc ld le b">formGroup</code>和<code class="fe lb lc ld le b">formControlName</code>，Angular将从那里获取它。在模板驱动的表单中，组件中的一个简单属性和一个<code class="fe lb lc ld le b">ngModel</code>就足够了。也就是说，如果你只使用经典的HTML表单元素，比如文本输入、复选框和简单的下拉菜单。如果您需要在表单中添加一些更复杂的字段，那就有点棘手了。</p><h1 id="6f23" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">控制值访问器</h1><p id="5d18" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">通过上面提到的指令，你可以告诉Angular哪个表单控件对应于哪个HTML元素。表单控件是跟踪表单域的值并验证它们的对象。当使用反应式表单时，可以在组件中创建它们。在模板驱动表单中，它们由Angular为绑定到<code class="fe lb lc ld le b">ngModel</code>的每个属性隐式创建。</p><p id="1ae5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">没有什么是神奇的。要做到这一点，必须在DOM和表单控件之间架起一座桥梁。这个东西必须监听DOM事件，比如点击和输入，并相应地更改表单控件的值，并且必须在表单控件的值以编程方式更改时通知DOM。这就是<code class="fe lb lc ld le b">ControlValueAccessor</code>的作用。</p><p id="d2ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">传统表单元素的访问器在Angular表单包中提供。你可以在下面看到复选框的代码。假设您已经导入了表单模块，这就是将这些元素绑定到表单控件的原因。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Source: <a class="ae kc" href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/checkbox_value_accessor.ts" rel="noopener ugc nofollow" target="_blank">Angular Source Code</a></figcaption></figure><p id="ff34" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像inputs和selects这样的经典表单域涵盖了大多数用例，但是有时您必须创建自己的表单元素。正如您可能已经体验过的，试图在您自己的组件上使用<code class="fe lb lc ld le b">ngModel</code>或<code class="fe lb lc ld le b">formControlName</code>会导致错误，类似于:</p><pre class="mi mj mk ml gt mo le mp mq aw mr bi"><span id="9b19" class="ms lg iq le b gy mt mu l mv mw">ERROR Error: No value accessor for form control with name: ‘my-component’</span></pre><p id="a416" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，如果组件的标记上没有name属性:</p><pre class="mi mj mk ml gt mo le mp mq aw mr bi"><span id="2a6b" class="ms lg iq le b gy mt mu l mv mw">ERROR Error: No value accessor for form control with unspecified name attribute</span></pre><p id="550f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了修正这个错误，你必须给你的组件一个自己的<code class="fe lb lc ld le b">ControlValueAccessor</code>。</p><h1 id="fd8b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">创建访问者</h1><p id="4655" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">让我们创建一个组件作为例子:多选组件。它可能看起来像这样:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="8e38" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(如果你想单独编码，或者你正在寻找一个简单的多选，你可以在GitHub的项目<a class="ae kc" href="https://github.com/Dornhoth/control-value-accessor.git" rel="noopener ugc nofollow" target="_blank">中找到完整的代码，包括我没有放在这里的样式)。</a></p><p id="4399" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您给出一组可能的条目作为输入，并在某个条目被选中(或取消选中)时得到一个输出。如果您只是简单地使用带有输入和输出的组件，这是可行的。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/5d9a43c27d143b13720c7733450d8f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gv6MjP90rbNoGjOdzdP-jA.png"/></div></div></figure><p id="c825" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是如果你试图给它添加一个<code class="fe lb lc ld le b">ngModel</code>指令，你会得到我们之前看到的错误。我们需要创建一个访问器。通过实现<code class="fe lb lc ld le b">ControlValueAccessor</code>接口，使组件本身成为访问器是标准的。如果您让组件实现它，您将看到组件需要实现以下四个方法:</p><ul class=""><li id="d12b" class="my mz iq kf b kg kh kk kl ko na ks nb kw nc la nd ne nf ng bi translated"><code class="fe lb lc ld le b">writeValue</code></li><li id="2675" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated"><code class="fe lb lc ld le b">registerOnChange</code></li><li id="8480" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated"><code class="fe lb lc ld le b">registerOnTouch</code></li><li id="c82a" class="my mz iq kf b kg nh kk ni ko nj ks nk kw nl la nd ne nf ng bi translated"><code class="fe lb lc ld le b">setDisabledState</code></li></ul><p id="d630" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">registerOnChange</code>注册一个回调函数，当DOM中的值改变时，这个函数将被调用。当选择或取消选择一个项目时，将调用此回调。我们需要创建一个<code class="fe lb lc ld le b">onChange</code>函数，如果调用了<code class="fe lb lc ld le b">registerOnChange</code>，它将被设置为回调函数。该<code class="fe lb lc ld le b">onChange</code>功能被初始化为不执行任何操作的功能。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="36d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">类似地，<code class="fe lb lc ld le b">registerOnTouched</code>注册一个回调函数，当控件被触摸或模糊时应该调用这个函数。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="af23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">writeValue</code>非常简单。它将接收一个条目数组作为输入，并应该为其设置<code class="fe lb lc ld le b">items</code>属性。它还应该调用<code class="fe lb lc ld le b">onChange</code>回调函数。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="730f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后<code class="fe lb lc ld le b">setDisabledState</code>顾名思义应该设置<code class="fe lb lc ld le b">disabled</code>状态。您有责任实现<code class="fe lb lc ld le b">disabled</code>状态，并确保如果元素被禁用，用户不能写入任何值。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="c6dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当您的字段被禁用时，您还应该调整用户界面。这需要在模板和样式上做更多的改变，你可以在GitHub上查看<a class="ae kc" href="https://github.com/Dornhoth/control-value-accessor.git" rel="noopener ugc nofollow" target="_blank">项目</a>。</p><h1 id="1a20" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">提供值访问器</h1><p id="70df" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们现在需要告诉Angular我们的组件是一个<code class="fe lb lc ld le b">ControlAccessValue</code>。您可能认为实现了接口就足够了，但是当您的TypeScript代码转换为JavaScript时，接口就消失了。这就是为什么我们需要提供它作为一个<code class="fe lb lc ld le b">NG_VALUE_ACCESSOR</code>。因为我们在实际定义组件之前提供了组件，所以我们需要使用<code class="fe lb lc ld le b">forwardRef</code>。关于<code class="fe lb lc ld le b">forwardRef</code>的更多信息，你可以查看<a class="ae kc" href="https://medium.com/javascript-in-plain-english/angular-what-is-forwardref-and-how-does-it-work-54f567e37636" rel="noopener">这篇文章</a>。</p><p id="19a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的组件最终看起来像这样:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="c487" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在可以在角度形式中使用组件，例如通过添加一个<code class="fe lb lc ld le b">ngModel</code>指令:</p><pre class="mi mj mk ml gt mo le mp mq aw mr bi"><span id="4d0c" class="ms lg iq le b gy mt mu l mv mw">&lt;app-multiselect<br/>  [items]=”possiblePets”<br/>  [(ngModel)]=”pets”<br/>&gt;&lt;/app-multiselect&gt;</span></pre><p id="df3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以以反应形式使用该组件。Angular现在会像对待其他表单元素一样对待您的组件，为您验证它，并根据表单控件的状态设置适当的类。</p><h2 id="123a" class="ms lg iq bd lh nm nn dn ll no np dp lp ko nq nr lt ks ns nt lx kw nu nv mb nw bi translated"><strong class="ak">一封用简单英语写的信</strong></h2><p id="8367" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">你知道我们有四份出版物和一个YouTube频道吗？你可以在我们的主页<a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> plainenglish.io </strong> </a>找到所有这些内容——关注我们的出版物并<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">来表达你的爱吧！</strong></p></div></div>    
</body>
</html>