<html>
<head>
<title>How I Reduced Docker Image Size from 1.43 GB to 22.4 MB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何将Docker图像大小从1.43 GB减少到22.4 MB</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-i-reduced-docker-image-size-from-1-43-gb-to-22-4-mb-84058d70574b?source=collection_archive---------0-----------------------#2020-11-11">https://javascript.plainenglish.io/how-i-reduced-docker-image-size-from-1-43-gb-to-22-4-mb-84058d70574b?source=collection_archive---------0-----------------------#2020-11-11</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="5b67" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">5个简单的步骤</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/206942efa170f5649140ee3b37e5965b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CjO8lpH_M88CnqAYlyBMTA.jpeg"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Photo by <a class="ae kw" href="https://unsplash.com/@guibolduc?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Guillaume Bolduc</a> on <a class="ae kw" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0276" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果你从事web开发，那么你可能已经知道了容器化的概念，以及它有多棒等等。</p><p id="9869" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">但是在使用<a class="ae kw" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> Docker </strong> </a>时，图像大小是一个很大的问题。仅仅是我们从<a class="ae kw" href="https://reactjs.org/docs/create-a-new-react-app.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> create-react-app </strong> </a>得到的样板文件项目，就经常超过1.43 GB</p><p id="ead1" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今天，我们将容器化一个ReactJS应用程序，并学习一些如何减少图像大小，同时提高性能的技巧。</p><p id="6192" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这里将展示ReactJS的技巧，但它适用于任何NodeJS应用程序。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="badd" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">第一步。创建您的项目</h1><ul class=""><li id="ed8e" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated">只需到你的终端键入</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="b1a1" class="ni mb ir ne b gz nj nk l nl nm">npx create-react-app docker-image-test</span></pre><ul class=""><li id="5bb9" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">然后<strong class="kz is"> create-react-app </strong>将为您提供基本的react应用程序</li><li id="1e95" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">之后，进入根目录并运行项目。</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="4e53" class="ni mb ir ne b gz nj nk l nl nm">cd docker-image-test<br/>yarn install<br/>yarn start</span></pre><ul class=""><li id="52fd" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">然后转到<a class="ae kw" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>查看您的应用程序是否启动并运行。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nv"><img src="../Images/8d94bd6b6a142397e7768aabf1165f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oScXWGrnax2J4iwF_eYlRw.png"/></div></div></figure></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="f5ef" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">第二步。建立你的第一个形象</h1><ul class=""><li id="aee9" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated">在项目的根目录中，创建一个名为<strong class="kz is"> Dockerfile </strong>的文件，并将下面的代码粘贴到那里。</li></ul><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nw nx l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Dockerfile</figcaption></figure><ul class=""><li id="7160" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">注意，我们正在从docker hub获取我们的基本映像节点:12，安装我们的依赖项，并运行基本命令。(我们不会在这里深入讨论docker命令的细节)</li><li id="a7e5" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">现在，从您的终端，为您的容器构建映像。</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="fbb5" class="ni mb ir ne b gz nj nk l nl nm">docker build -t docker-image-test .</span></pre><ul class=""><li id="7181" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">Docker会建立你的形象。完成后，您可以使用此命令查看您的图像。</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="7618" class="ni mb ir ne b gz nj nk l nl nm">docker images</span></pre><p id="325b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">列表顶部是我们新创建的图像，在最右边，我们可以看到图像的大小。暂时是<strong class="kz is"> 1.43GB </strong>。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj ny"><img src="../Images/012f0fed7423f817ce00b7e695a11b11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XdAAXgoSAUWq6ZB1LeaNUg.png"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">docker images on our machine</figcaption></figure><ul class=""><li id="3c14" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">我们可以使用以下命令来运行映像</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="84f6" class="ni mb ir ne b gz nj nk l nl nm">docker run --rm -it -p 3000:3000/tcp docker-image-test:latest</span></pre><p id="e84e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">你可以进入你的浏览器并刷新页面来验证它是否还在工作。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="d496" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">第三步。更改基础图像</h1><ul class=""><li id="2ba9" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated">在之前的配置中，我们使用<strong class="kz is">节点:12 </strong>作为我们的基础映像。但是传统上，节点图像是基于Ubuntu的，这对我们简单的React T21应用程序来说是不必要的沉重。</li><li id="6341" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">从DockerHub(官方docker映像注册表)中，我们可以看到基于alpine的映像比基于ubuntu的映像要小得多，并且它们的打包只需要最小的依赖性。</li><li id="3e5e" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">这些基本图像的大小比较如下所示。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nz"><img src="../Images/4f773b42687d47d0d16551ff0b471eb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aGjzqqMOWhedNKdkVRBtBg.png"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">node:12 vs node:12-alpine</figcaption></figure><ul class=""><li id="7c0e" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">现在我们将使用<strong class="kz is">节点:12-阿尔卑斯山</strong>作为我们的基础图像，看看会发生什么。</li></ul><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nw nx l"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Dockerfile with node:12-alpine</figcaption></figure><ul class=""><li id="6998" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">然后，我们建立我们的形象，并看到大小，因为我们之前做的。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nz"><img src="../Images/75389f4beda006ff6e3f162cb99b1f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_QtpyfIggG5K-O0UwT79yw.png"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">image with node-alpine</figcaption></figure><p id="64da" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">哇！我们的图像尺寸缩小到仅580MB。这是一个很大的进步。但是我们能做得更好吗？</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="3778" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">第四步。多阶段构建</h1><ul class=""><li id="0d2b" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated">在我们以前的配置中，我们将所有的源代码复制到工作目录中。</li><li id="5940" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">但是这是不必要的，因为我们只需要构建文件夹来服务我们的网站。所以现在，我们将使用<a class="ae kw" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">多阶段</a>构建的概念来从我们的最终映像中削减不必要的代码和依赖性。</li><li id="b31e" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">配置看起来会像这样。</li></ul><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nw nx l"/></div></figure><ul class=""><li id="6abf" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">在第一阶段，我们安装依赖项并构建我们的项目</li><li id="024e" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">在第二个阶段，我们从前面的阶段复制构建文件夹的内容，并使用它来服务我们的应用程序。</li><li id="5059" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">这样，我们在最终的图像中就不会有不必要的依赖和代码。</li></ul><p id="28fe" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">接下来，我们构建我们的图像，并像以前一样从列表中看到图像</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj oa"><img src="../Images/c0b0b836fe04577598f4d845ebb5dbab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x2uuUUXVb1P8HmljD9zO9A.png"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Image with multi-stage build</figcaption></figure><p id="bf48" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在我们的镜像大小是<strong class="kz is"> 97.5MB </strong>只有<strong class="kz is">。</strong>这有多棒？</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="4f47" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated"><strong class="ak">第五步。使用NGINX </strong></h1><ul class=""><li id="f825" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated">我们使用一个节点服务器来服务我们的<strong class="kz is"> ReactJS </strong>应用程序的静态资产，这不是服务静态内容的最佳选择。</li><li id="ca3a" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">我们可以使用更高效、更轻量级的服务器，如<a class="ae kw" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> Nginx </strong> </a>来服务我们的应用程序，看看它是否提高了我们的性能并减小了大小。</li><li id="bdb0" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">我们最终的Docker配置文件看起来会像这样。</li></ul><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nw nx l"/></div></figure><ul class=""><li id="e7f2" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">我们正在改变docker配置的第二阶段，以服务于使用Nginx的应用程序。</li><li id="a1b9" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">然后，我们使用当前配置构建我们的映像。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj oa"><img src="../Images/e15efd77b90ae90cb3b25f13a7c75f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y72IUMep-SCPNCKhxvbdBQ.png"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Final Docker Image Size</figcaption></figure><ul class=""><li id="19ff" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">图像尺寸缩小至仅<strong class="kz is"> 22.4MB </strong>！</li><li id="c746" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">与此同时，我们正在使用一个更高性能的服务器来服务我们出色的应用程序。</li><li id="64aa" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated">我们可以使用下面的命令来验证我们的应用程序是否还在工作。</li></ul><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="4505" class="ni mb ir ne b gz nj nk l nl nm">docker run --rm  -it -p 3000:80/tcp docker-image-test:latest</span></pre><ul class=""><li id="92eb" class="ms mt ir kz b la lb ld le lg nn lk no lo np ls mz na nb nc bi translated">请注意，我们将容器的80端口暴露给了外部，因为默认情况下，Nginx将在容器内部的80端口上可用。</li></ul><p id="3cae" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以这些是一些简单的技巧，你可以应用到你的任何一个<strong class="kz is"> NodeJS </strong>项目中，来大幅减少图片的大小。现在，您的容器真正变得更加便携和高效。</p><p id="9d61" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今天到此为止。编码快乐！</p><p id="98f4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">有话要说？</strong></p><pre class="kh ki kj kk gu nd ne nf ng aw nh bi"><span id="1a26" class="ni mb ir ne b gz nj nk l nl nm"><strong class="ne is">Get in touch with me via </strong><a class="ae kw" href="https://www.linkedin.com/in/56faisal/" rel="noopener ugc nofollow" target="_blank"><strong class="ne is">LinkedIn</strong></a><strong class="ne is"> or my </strong><a class="ae kw" href="https://www.mohammadfaisal.dev/" rel="noopener ugc nofollow" target="_blank"><strong class="ne is">Personal Website</strong></a><strong class="ne is">.</strong></span></pre><div class="ob oc gq gs od oe"><a href="https://betterprogramming.pub/the-7-traits-of-a-rock-star-react-developer-747fbb001c05" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fp"><div class="og ab oh cl cj oi"><h2 class="bd is gz z fq oj fs ft ok fv fx iq bi translated">摇滚明星React开发者的7个特质</h2><div class="ol l"><h3 class="bd b gz z fq oj fs ft ok fv fx dk translated">造成差异的习惯</h3></div><div class="om l"><p class="bd b dl z fq oj fs ft ok fv fx dk translated">better编程. pub</p></div></div><div class="on l"><div class="oo l op oq or on os kq oe"/></div></div></a></div><div class="ob oc gq gs od oe"><a rel="noopener  ugc nofollow" target="_blank" href="/20-essential-parts-of-any-large-scale-react-app-ee4bd35436a0"><div class="of ab fp"><div class="og ab oh cl cj oi"><h2 class="bd is gz z fq oj fs ft ok fv fx iq bi translated">任何大型React应用程序的20个基本部分</h2><div class="ol l"><h3 class="bd b gz z fq oj fs ft ok fv fx dk translated">如果您正在编写企业级代码，您需要了解这一点</h3></div><div class="om l"><p class="bd b dl z fq oj fs ft ok fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="on l"><div class="ot l op oq or on os kq oe"/></div></div></a></div><h2 id="7ae3" class="ni mb ir bd mc ou ov dn mg ow ox dp mk lg oy oz mm lk pa pb mo lo pc pd mq pe bi translated">资源</h2><ul class=""><li id="79ed" class="ms mt ir kz b la mu ld mv lg mw lk mx lo my ls mz na nb nc bi translated"><strong class="kz is"> <em class="pf">本帖灵感</em></strong>:<a class="ae kw" href="https://medium.com/the-agile-crafter/docker-image-optimization-from-1-16gb-to-22-4mb-53fdb4c53311" rel="noopener">https://medium . com/the-agile-crafter/docker-image-optimization-from-1-16gb-to-22-4mb-53 fdb4c 53311</a></li><li id="14cb" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated"><strong class="kz is"><em class="pf">Docker </em></strong>:<a class="ae kw" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/</a></li><li id="b73f" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated"><strong class="kz is"><em class="pf">Alpine Images </em></strong><a class="ae kw" href="https://hub.docker.com/_/alpine" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/_/alpine </a></li><li id="3e6d" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated"><strong class="kz is"><em class="pf">Multi-Stage Build </em></strong>:<a class="ae kw" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/develop/develop-images/multistage-build/</a></li><li id="19ee" class="ms mt ir kz b la nq ld nr lg ns lk nt lo nu ls mz na nb nc bi translated"><strong class="kz is"><em class="pf">NGINX </em></strong>:<a class="ae kw" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank">https://www.nginx.com/</a></li></ul></div></div>    
</body>
</html>