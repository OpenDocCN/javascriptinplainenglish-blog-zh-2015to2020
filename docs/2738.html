<html>
<head>
<title>Node.js Tips — Excel Files, Flash Messages, and Response Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示— Excel文件、快速消息和响应数据</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-excel-files-flash-messages-and-response-data-b93626dacb94?source=collection_archive---------7-----------------------#2020-07-19">https://javascript.plainenglish.io/node-js-tips-excel-files-flash-messages-and-response-data-b93626dacb94?source=collection_archive---------7-----------------------#2020-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b162e567b10aebaddcc9facdd3092573.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gami7I1i5AdTS8Wd"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@benobro?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">ben o'bro</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="aebe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="ff59" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">正确导出Node.js中的异步函数</h1><p id="f4ad" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以像导出其他函数一样导出一个异步函数。</p><p id="c83a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2daa" class="mn lc iq mj b gy mo mp l mq mr">async function doSomething() {<br/>  // ...<br/>}<br/><br/>module.exports.doSomething = doSomething;</span></pre><p id="af23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们像对待其他函数一样导出<code class="fe ms mt mu mj b">doSomething</code>。</p><h1 id="4cf7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Base64 Nodejs中的ReadFile</h1><p id="e391" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe ms mt mu mj b">readFileSync</code>方法将文件读入base64字符串。</p><p id="71c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="641a" class="mn lc iq mj b gy mo mp l mq mr">const fs = require('fs');<br/>const str = fs.readFileSync('/path/to/file.jpg', { encoding: 'base64' });</span></pre><p id="c20b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用一个对象传入第二个参数。</p><p id="4cc9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将<code class="fe ms mt mu mj b">encoding</code>属性设置为<code class="fe ms mt mu mj b">'base64'</code>，这样我们就可以将文件解析成base64字符串。</p><p id="ce5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它被送回并分配给<code class="fe ms mt mu mj b">str</code>。</p><h1 id="4d53" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Mongoose查找和更新子文档</h1><p id="1a0f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe ms mt mu mj b">findOneAndUpdate </code>方法找到并更新一个子文档。</p><p id="40c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2740" class="mn lc iq mj b gy mo mp l mq mr">Person.findOneAndUpdate(<br/>  { "_id": personId, "address._id": address._id },<br/>  { <br/>    "$set": {<br/>      "address.$": address<br/>    }<br/>  },<br/>  (err, doc) =&gt; {<br/>    console.log(doc);<br/>  }<br/>);</span></pre><p id="2e6f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用带有几个参数的<code class="fe ms mt mu mj b">findOneAndUpdate</code>方法。</p><p id="1895" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个是查找要更新的对象的查询。</p><p id="fcb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用它来查询父文档和子文档。</p><p id="6bdf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过ID查询<code class="fe ms mt mu mj b">person</code>文档，用<code class="fe ms mt mu mj b">address._id</code>查询<code class="fe ms mt mu mj b">address</code>。</p><p id="0582" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二个参数是为设置地址子文档的<code class="fe ms mt mu mj b">address.$</code>设置值的<code class="fe ms mt mu mj b">$set</code>方法。</p><p id="a84c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">$</code>是位置操作变量。</p><p id="da04" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它用于获取与给定位置匹配的子文档。</p><p id="d4a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦操作完成，回调就会得到结果。</p><h1 id="64f6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">如果一个测试失败，跳过Spec中后续的Mocha测试</h1><p id="1cdf" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Mocha有一个<code class="fe ms mt mu mj b">bail</code>操作，如果一个测试失败，就跳过剩余的测试。</p><p id="955b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以简称<code class="fe ms mt mu mj b">b</code>。</p><h1 id="e0ca" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">从Axios API返回数据</h1><p id="1e61" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了从Axios发出的HTTP请求中获取数据，我们可以在<code class="fe ms mt mu mj b">then</code>回调中返回<code class="fe ms mt mu mj b">response.data</code>对象。</p><p id="6c1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="02f7" class="mn lc iq mj b gy mo mp l mq mr">axios.get(url)<br/>  .then(response =&gt; {<br/>     return response.data;<br/>  })<br/>  then(data =&gt; {<br/>    res.json(data);<br/>  })</span></pre><p id="1ef8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请求成功后，我们用响应数据调用<code class="fe ms mt mu mj b">res.json</code>。</p><h1 id="4abe" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">阅读获取承诺的正文</h1><p id="c1cb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe ms mt mu mj b">json</code>方法将响应对象转换为JSON对象来获得Fetch承诺的主体。</p><p id="d059" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ff0f" class="mn lc iq mj b gy mo mp l mq mr">fetch('https://api.ipify.org?format=json')<br/>  .then(response =&gt; response.json())<br/>  .then‌​(data =&gt; console.log(data))</span></pre><p id="c022" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe ms mt mu mj b">response.json()</code>来获取JSON。</p><h1 id="b1f8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Node解析XLSX并创建JSON</h1><p id="4487" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了使在节点应用程序中解析XLSX文件变得容易，我们可以使用<code class="fe ms mt mu mj b">xlsx</code>包。</p><p id="f3b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过书写来使用它:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="bc78" class="mn lc iq mj b gy mo mp l mq mr">const XLSX = require('xlsx');<br/>const workbook = XLSX.readFile('spreadsheet.xlsx');<br/>const [sheetName] = workbook.SheetNames;<br/>const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName])</span></pre><p id="fee2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe ms mt mu mj b">xlsx</code>包装。</p><p id="d8a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以使用<code class="fe ms mt mu mj b">readFile</code>来读取给定路径的电子表格。</p><p id="4f57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">属性从XLSX文件中获取工作表名称。</p><p id="3d73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的例子中，我们得到了第一个名字。</p><p id="41ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe ms mt mu mj b">sheet_to_json</code>来转换具有给定名称的工作表。</p><p id="62cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过使用<code class="fe ms mt mu mj b">workbook.Sheets</code>对象获取工作表。</p><h1 id="5dbd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">检查NodeJS中的JSON是否为空</h1><p id="2ca9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe ms mt mu mj b">Object.keys</code>方法检查JSON对象是否为空。</p><p id="3f87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="456c" class="mn lc iq mj b gy mo mp l mq mr">Object.keys(obj).length === 0;</span></pre><p id="5963" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中<code class="fe ms mt mu mj b">obj</code>是我们要检查的JSON对象。</p><h1 id="794b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express中发送即时消息</h1><p id="7d6c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">即时消息是在会话期间存储的消息。</p><p id="e6c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用<code class="fe ms mt mu mj b">connect-flash</code>中间件向模板发送flash消息。</p><p id="2e3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了安装这个包，我们运行:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4b59" class="mn lc iq mj b gy mo mp l mq mr">npm install connect-flash</span></pre><p id="6453" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7800" class="mn lc iq mj b gy mo mp l mq mr">const flash = require('connect-flash');<br/>const app = express();</span><span id="4bda" class="mn lc iq mj b gy mv mp l mq mr">app.configure(function() {<br/>  app.use(express.cookieParser(''));<br/>  app.use(express.session({ cookie: { maxAge: 60000 }}));<br/>  app.use(flash());<br/>});</span><span id="ac24" class="mn lc iq mj b gy mv mp l mq mr">app.get('/flash', (req, res) =&gt; {<br/>  req.flash('info', 'flash message');<br/>  res.redirect('/');<br/>});</span><span id="a6ee" class="mn lc iq mj b gy mv mp l mq mr">app.get('/', (req, res) =&gt; {<br/>  res.render('index', { messages: req.flash('info') });<br/>});</span></pre><p id="1e33" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe ms mt mu mj b">req.flash</code>设置了flash消息。</p><p id="e0d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个参数是信息的关键。</p><p id="aa84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二个参数是消息本身。</p><p id="2fbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们像在<code class="fe ms mt mu mj b">'/'</code>路线上那样使用带有一个参数的<code class="fe ms mt mu mj b">req.flash</code>，我们就可以通过键获得消息。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/8404950b9be4472e5c06f90dbef6843d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gysXNfyeVItURhTq"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@luna_and_boo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Rebecca Hobbs</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="0317" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="b8bb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以像导出其他函数一样导出异步函数。</p><p id="7bdd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">connect-flash</code>包让我们存储会话期间可用的消息。</p><p id="8213" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">xlsx</code>包让我们从XLSX文件中解析数据。</p><p id="fca9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">子文档可以用Mongoose更新。</p><p id="847d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以获得各种HTTP客户端的响应数据。</p><h2 id="3e23" class="mn lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated">简单英语的JavaScript</h2><p id="af1d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅解码，我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>