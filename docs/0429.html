<html>
<head>
<title>Devil in Disguise: Jest Snapshot Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">伪装的魔鬼:Jest快照测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/devil-in-disguise-jest-snapshot-testing-7bce4573c8aa?source=collection_archive---------4-----------------------#2019-10-12">https://javascript.plainenglish.io/devil-in-disguise-jest-snapshot-testing-7bce4573c8aa?source=collection_archive---------4-----------------------#2019-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b93d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为什么应该谨慎使用快照测试</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8a7d609f8c63b06ac01659026c90bdd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*f2MjItVP35IcVFVa"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@ckhi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Hoil Ryu</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8972" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快照测试是一把双刃剑。如果你按照<a class="ae kv" href="https://jestjs.io/docs/en/snapshot-testing" rel="noopener ugc nofollow" target="_blank"> Jest </a>推荐的指南使用它，它会是一个很棒的工具。同时，大多数开发人员倾向于不惜一切代价避免它。我也是。在这篇文章中，我会举几个例子来说明为什么<code class="fe ls lt lu lv b">.toMatchSnapshot()</code>弊大于利。</p><h1 id="2a4a" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">测试变得更难阅读</h1><p id="28ec" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">测试不仅意味着在持续集成(CI)管道中运行，而且也是由人类阅读的。好的测试是你代码的活文档。从下面的测试中你能理解什么？</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="964a" class="mx lx iq lv b gy my mz l na nb">import renderer from 'react-test-renderer';<br/>import LoginForm from './LoginForm';</span><span id="c16b" class="mx lx iq lv b gy nc mz l na nb">it('should render login form', () =&gt; {<br/>  const component = render.create(&lt;LoginForm /&gt;);</span><span id="e382" class="mx lx iq lv b gy nc mz l na nb">  expect(component.toJSON()).toMatchSnapshot();<br/>});</span></pre><p id="56fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基于测试描述，您假设它将呈现<code class="fe ls lt lu lv b">LoginForm</code>组件而不会崩溃，但是您不知道子组件是什么。更令人沮丧的是，当<code class="fe ls lt lu lv b">LoginForm</code>基于这样一个布尔属性呈现登录或注册时:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="5dee" class="mx lx iq lv b gy my mz l na nb">it('should render login form', () =&gt; {<br/>  const component = render.create(&lt;LoginForm isNew={false}/&gt;);</span><span id="dc05" class="mx lx iq lv b gy nc mz l na nb">  expect(component.toJSON()).toMatchSnapshot();<br/>});</span><span id="62c7" class="mx lx iq lv b gy nc mz l na nb">it('should render signUp form', () =&gt; {<br/>  const component = render.create(&lt;LoginForm isNew={true}/&gt;);</span><span id="3988" class="mx lx iq lv b gy nc mz l na nb">  expect(component.toJSON()).toMatchSnapshot();<br/>});</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/5e9b8aa246b7ee23e7dbd9cc7a54612a.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/1*z0afYoDEuGcUyAc90zsGfw.gif"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk"><a class="ae kv" href="https://media.giphy.com/media/XD4qHZpkyUFfq/giphy.gif" rel="noopener ugc nofollow" target="_blank">https://media.giphy.com/media/XD4qHZpkyUFfq/giphy.gif</a></figcaption></figure><p id="68ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仅仅通过阅读测试，你无法区分登录表单和注册表单之间的区别。现在你必须切换到代码来看看<strong class="ky ir">如何渲染</strong>。如果测试不是您自己编写的，您还想切换到快照文件来查看<strong class="ky ir">它会呈现什么。你只需点击几下，敲几下键盘，滚动几下滚动条，就能到达你想看的地方。如果您可以简单地阅读测试中的所有内容，不是更好吗？</strong></p><h1 id="5ee3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">无需调试</h1><p id="e925" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">听起来不错？(确实讽刺……)。更改代码后，运行测试，一些快照测试失败。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/ecd3127c2acfc37645c2bd58252a401b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZjucN2qdysCtoYndQRIkw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Failed snapshot test output</figcaption></figure><p id="d20d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你认为失败是因为你想要的改变。您只需通过运行<code class="fe ls lt lu lv b">jest --updateSnapshot</code>更新快照，或者如果您使用<code class="fe ls lt lu lv b">--watch</code>运行测试，则按下<code class="fe ls lt lu lv b">u</code>。现在所有测试都通过了。您是修复失败快照测试的专家！</p><p id="d86c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当这成为一种习惯时，你可能就懒得仔细看看console的区别了。如果您的预期变更也引入了非预期的输出，该怎么办？</p><blockquote class="nf ng nh"><p id="98c3" class="kw kx ni ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated">我不知道为什么测试失败了。更新快照。我不知道为什么测试通过了。</p></blockquote><h1 id="e5ca" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">测试很容易被打破</h1><p id="60af" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在您更改某些内容后，一些测试应该会中断。这很有道理。然而，它会把你的注意力从真正重要的事情上转移开。</p><p id="c78f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">一般来说，你应该为结果写测试，而不是实现</strong>。您可能会认为快照测试只关心正在呈现的内容，但它实际上包括了如下所示的实现:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="095f" class="mx lx iq lv b gy my mz l na nb">exports[`App should render correctly`] = `</span><span id="2bff" class="mx lx iq lv b gy nc mz l na nb">&lt;div<br/>  className="App"<br/>&gt;<br/>  &lt;form<br/>   className="form"<br/>  &gt;<br/>    ...<br/>  &lt;/form&gt;<br/>&lt;/div&gt;<br/>`;</span></pre><p id="c2cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">被认为是实现，因为它只是链接到实际CSS的命名。当您想要重命名这种实现时，您不希望您的任何测试中断，但是它确实中断了。</p><h1 id="981f" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">没有粒度</h1><p id="6937" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">快照测试对整体来说是很好的，但是它不能告诉你到底哪里出错了。这可能是你的打字错误，你的逻辑，或子组件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/5d5962f4b88785b3aba4e89a253a8033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wArTl8eoyLxfexRw"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@ratushny?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Dmitry Ratushny</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="939c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能会争辩说你可以用更小的测试来获得更好的粒度。如果是这样的话，为什么一开始就需要快照测试呢？多个小测试比一个大快照测试好得多。</p><h1 id="3a30" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">如果不是快照测试，那么是什么呢？</h1><p id="28af" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">不久前引入了快照测试，因此人们能够在没有它的情况下编写好的代码和测试，你也一样。相信我。</p><p id="34eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有其他很棒的测试库，如<a class="ae kv" href="https://github.com/airbnb/enzyme" rel="noopener ugc nofollow" target="_blank">酶</a>或<a class="ae kv" href="https://github.com/testing-library/react-testing-library" rel="noopener ugc nofollow" target="_blank">反应测试库</a>。目标是关注对用户重要的事情。</p><p id="7653" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您正在测试一个登录表单，您希望确保该表单呈现一个电子邮件字段、一个密码字段和一个登录按钮。您不必编写针对颜色、字体大小或间距的测试，因为您可以在运行时看到它们。</p><h1 id="e610" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">快照测试一点好处都没有吗？</h1><p id="9d3b" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">毕竟，如果您知道快照测试的作用并以正确的理念使用它，它可能是一个好的魔鬼。快照测试是专门为UI测试而创建的。如果您关注组件中呈现的每一个细节，快照测试可能是您的守护天使。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/c5cf403d04520d06cc74b1c8de9cf42f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CQQt9LO8kd1flYst4Ny97w.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk"><a class="ae kv" href="https://www.whats-on-netflix.com/wp-content/uploads/2019/03/Lucifer-Season-4-Netflix.jpg" rel="noopener ugc nofollow" target="_blank">https://www.whats-on-netflix.com/wp-content/uploads/2019/03/Lucifer-Season-4-Netflix.jpg</a></figcaption></figure><blockquote class="nf ng nh"><p id="4637" class="kw kx ni ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated">当你想确保你的用户界面不会发生意外变化时，快照测试是一个非常有用的工具。——【https://jestjs.io/docs/en/snapshot-testing T4】</p></blockquote><p id="f7ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以进一步阅读<a class="ae kv" href="https://benmccormick.org/2016/09/19/testing-with-jest-snapshots-first-impressions/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>来决定snapshot是否适合你的项目。</p><h1 id="6292" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">最后的话</h1><p id="3959" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">我并不完全反对快照测试，因为它确实达到了预期目的。当人们滥用它或者为了测试覆盖率而编写它时，它就变得适得其反。如果团队中的每个人都有同样的感觉，那么就彻底停止使用快照测试。相反，编写更有意义的测试。快乐测试😃！</p></div></div>    
</body>
</html>