<html>
<head>
<title>Secure your React/Angular/Vue app and REST API deployed using GCP App Engine with IAP (Identity-Aware Proxy)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护您的React/Angular/Vue应用程序和REST API，使用GCP应用程序引擎和IAP(身份识别代理)进行部署</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/secure-your-spa-react-angular-vue-and-rest-api-deployed-using-gcp-app-engine-with-iap-f325182ddcb0?source=collection_archive---------1-----------------------#2020-01-24">https://javascript.plainenglish.io/secure-your-spa-react-angular-vue-and-rest-api-deployed-using-gcp-app-engine-with-iap-f325182ddcb0?source=collection_archive---------1-----------------------#2020-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f5701ae38dbbb40cd1d5fe62b7165069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBgTwv7yZmXQ7q8iVbKlsg.jpeg"/></div></div></figure><p id="aa0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将介绍使用谷歌云的IAP ( <a class="ae kw" href="https://cloud.google.com/iap/" rel="noopener ugc nofollow" target="_blank">云身份感知代理</a>)来<strong class="ka ir">保护两个应用</strong>；一个是UI ( <a class="ae kw" href="https://en.wikipedia.org/wiki/Single-page_application" rel="noopener ugc nofollow" target="_blank"> SPA </a>)应用，例如Angular或React应用，另一个是SPA使用REST范式与之交互的API。</p><p id="a066" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">两者都已经作为服务部署在GCP的应用引擎灵活环境中。</p><p id="a01c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">注意:如果您在GCP项目中部署了多个应用程序，那么您必须使用flex环境，而不是标准环境。</em>T11】</strong></p><p id="0ec7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在最简单的形式中，我们的架构可以这样描述:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/f17fb35564553b3a46b5e1caf4530b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*Oe2Qv8qqtIkQR17gRQ2E_w.png"/></div></figure><p id="d0da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，这两种服务都向公众公开，并可通过类似以下的URL获得:</p><p id="c654" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">https://single-spa-dot-project-123.appspot.com<br/>https://rest-api-dot-project-123.appspot.com</p><p id="c69f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们希望保护这些应用程序，以便能够验证用户对我们应用程序的访问。</p><p id="0cd4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们已经在GCP部署了我们的应用程序，依靠一些谷歌魔法来保护我们的应用程序是有意义的。</p><p id="e189" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，IAP可以成为谷歌推向市场的几乎所有应用的一个重要入口。</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/ce6b32061004b695be0302a7319a352e.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/0*Jd2djXKP3zQ6S0GR"/></div></figure></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="809d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">启用IAP</h1><p id="43c9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">开启IAP再简单不过了。下面的文章中提到了一些配置步骤，但实际上就像轻触开关并为一些用户设置正确的IAM权限一样简单。</p><div class="mo mp gp gr mq mr"><a href="https://cloud.google.com/iap/docs/app-engine-quickstart" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">快速入门:使用Google帐户管理访问|身份识别代理文档| Google云</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">本页将引导您部署App Engine标准或灵活环境应用程序，并通过以下方式保护它</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">cloud.google.com</p></div></div></div></a></div><p id="bb62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你完成了上述文章中的步骤，当你试图访问你的公共网址时，它会提示你登录。</p><p id="fa3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">提示:如果你已经有一个谷歌认证会话，使用一个匿名窗口，在这种情况下，它会使用这个窗口并绕过认证屏幕。</em></p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/333aefe1e1d0025568cc1b897c88dbb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*2J7kiHdnSwglmeM0bb5B5g.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">Google Auth Screen</figcaption></figure><p id="b531" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们的简单架构可以说明如下，其中IAP现在保护我们的应用程序引擎服务(应用程序):</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/b7fe094532cdb79b205edae312b765ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*ZnUTFCcuwV6QjUG4SVP0hQ.png"/></div></figure><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/26d9a975282d94f9ef7d1aab36367fdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/0*o9ysYDoGAJu5heUK.jpg"/></div></figure></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="f3bd" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">访问我们IAP保护的应用程序</h1><p id="ae6a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">IAP对我们的单个SPA应用程序非常有效，为我们的内部应用程序提供了一个类似硬壳的外部环境，有助于减少对我们应用程序的授权访问。</p><p id="cfa7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">事实上，这一切都是在没有一行代码的情况下实现的，这很了不起——感谢谷歌！</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/cc1387df43622834734c39ce926eb0fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*Fm1duGfqLrX60Nlf.jpg"/></div></figure><p id="640d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是REST API呢……那不是一样简单吗？</p><p id="3e67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，如果您通过浏览器会话访问API，那么它将作为单个SPA应用程序工作。</p><p id="96f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是一般来说，对于REST APIs，您将使用一个不能像浏览器一样处理auth重定向的客户端。</p><p id="7bf3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以……我们如何为我们的REST APIs处理这个问题呢？</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="be9a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用IAP服务帐户保护REST API</h1><p id="5bcf" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我在互联网上搜索了几个小时，找到了一个很好的解决方案，我能想到的最好的办法是使用一个Google服务帐户来处理API认证，现在我将带您浏览一下...</p><p id="3bc6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">这个概念很大程度上是从这篇文章中搬来的:</em></p><div class="mo mp gp gr mq mr"><a href="https://cloud.google.com/iap/docs/authentication-howto" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">程序化认证|身份识别代理文档| Google云</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">本页描述如何从用户帐户或身份识别代理(IAP)安全资源进行身份验证</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">cloud.google.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm jw mr"/></div></div></a></div><p id="79a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的SPA应用程序(<em class="kx">静态文件</em>)是使用<a class="ae kw" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express节点提供的。JS </a>服务器内部App Engine，大概如下图:</p><pre class="kz la lb lc gt nn no np nq aw nr bi"><span id="05ae" class="ns lm iq no b gy nt nu l nv nw">const express = require('express');</span><span id="bf69" class="ns lm iq no b gy nx nu l nv nw">const app = express();</span><span id="0c8b" class="ns lm iq no b gy nx nu l nv nw">app.use(express.static('dist'));</span><span id="7f21" class="ns lm iq no b gy nx nu l nv nw">app.listen($PORT, $HOST);</span></pre><p id="5895" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用IAP保护之前，我的API调用是通过<a class="ae kw" href="https://github.com/chimurai/http-proxy-middleware" rel="noopener ugc nofollow" target="_blank"> http-proxy-middleware </a>代理的，这意味着来自<em class="kx">https://single-spa-dot-project-123.appspot.com/api/foo</em>的调用被代理到<a class="ae kw" href="https://reset-api-dot-project-123.appspot.com/foo." rel="noopener ugc nofollow" target="_blank"><em class="kx">https://rest-api-dot-project-123.appspot.com/foo</em>。</a></p><pre class="kz la lb lc gt nn no np nq aw nr bi"><span id="9496" class="ns lm iq no b gy nt nu l nv nw">const express = require('express');<br/>const proxy = require('http-proxy-middleware');<br/><br/>const app = express();</span><span id="7bdf" class="ns lm iq no b gy nx nu l nv nw">app.use(express.static('dist'));</span><span id="c873" class="ns lm iq no b gy nx nu l nv nw">app.use('/api/*', proxy({<br/>   pathRewrite: {<br/>      '^/api': ''<br/>   },<br/>   target: '<a class="ae kw" href="https://reset-api-dot-project-123.appspot.com" rel="noopener ugc nofollow" target="_blank">https://rest-api-dot-project-123.appspot.com</a>',<br/>   secure: false,<br/>   changeOrigin: true<br/>}));</span></pre><p id="1d4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用上述方法，当我激活IAP时，我的API调用不再工作，因为对REST API的调用不知道我的Google auth会话。</p><p id="e878" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在几次拦截请求头并试图将它们传递给REST API应用程序的尝试失败后(<em class="kx">顺便说一下</em>这不起作用)，我想到了以下依赖于<a class="ae kw" href="https://github.com/googleapis/google-auth-library-nodejs" rel="noopener ugc nofollow" target="_blank">Google-auth-library-nodejs</a>库的解决方案:</p><pre class="kz la lb lc gt nn no np nq aw nr bi"><span id="e575" class="ns lm iq no b gy nt nu l nv nw">const { auth } = require('google-auth-library');</span><span id="e4b1" class="ns lm iq no b gy nx nu l nv nw">const SERVICE_ACCOUNT = require('./my-service-account-key.json');<br/>const CLIENT_ID = 'my-service-account-id.apps.googleusercontent.com';</span><span id="a8e2" class="ns lm iq no b gy nx nu l nv nw">async function useServiceAccount(options) {<br/>   const client = auth.fromJSON(SERVICE_ACCOUNT);<br/>   client.additionalClaims = { target_audience: CLIENT_ID };<br/>   const response = await client.request(options);<br/>   return response.data;<br/>}</span></pre><p id="2452" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">为了上面的工作，你需要做以下事情:</em></p><ul class=""><li id="1b83" class="ny nz iq ka b kb kc kf kg kj oa kn ob kr oc kv od oe of og bi translated">创建服务帐户来处理IAP认证并获取JSON密钥(上面代码片段中的<em class="kx">my-service-account-key . JSON</em>)</li><li id="c587" class="ny nz iq ka b kb oh kf oi kj oj kn ok kr ol kv od oe of og bi translated">从GCP控制台的IAP页面获取OAuth客户端ID(上面代码片段中的<em class="kx">my-service-account-id.apps.googleusercontent.com</em></li></ul><p id="cdfd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这两个步骤在下面的文章中都有描述</p><div class="mo mp gp gr mq mr"><a href="https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_service_account" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd ir gy z fp mw fr fs mx fu fw ip bi translated">程序化认证|身份识别代理文档| Google云</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">本页描述如何从用户帐户或身份识别代理(IAP)安全资源进行身份验证</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">cloud.google.com</p></div></div><div class="nh l"><div class="om l nj nk nl nh nm jw mr"/></div></div></a></div><p id="d1e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦有了这两条信息，您就可以更改代理来使用我们的<strong class="ka ir"> useServiceAccount() </strong>方法:</p><pre class="kz la lb lc gt nn no np nq aw nr bi"><span id="f26b" class="ns lm iq no b gy nt nu l nv nw">app.use(express.json());</span><span id="583e" class="ns lm iq no b gy nx nu l nv nw">app.use('/api/*', async (req, res) =&gt; {</span><span id="8475" class="ns lm iq no b gy nx nu l nv nw">   let options = {<br/>      url:  `<a class="ae kw" href="https://rest-api-dot-project-123.appspot.com" rel="noopener ugc nofollow" target="_blank">https://rest-api-dot-project-123.appspot.com</a>/${req.baseUrl.replace('/api/','')}`,<br/>      method: req.method<br/>   }</span><span id="6e8e" class="ns lm iq no b gy nx nu l nv nw">   if (options.method === "POST" || options.method === "PUT") {<br/>      options = {<br/>         ...options,<br/>         data: req.body<br/>      }<br/>   }</span><span id="4fd3" class="ns lm iq no b gy nx nu l nv nw">   body = await useServiceAccount(options);</span><span id="086b" class="ns lm iq no b gy nx nu l nv nw">});</span></pre><p id="fcc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">注意:</em> </strong> <em class="kx">我们在这里将POST和PUT方法的JSON主体作为数据(而不是主体)传递，因此它将被依赖于</em> <a class="ae kw" href="https://github.com/googleapis/gaxios/" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> gaxios </em> </a> <em class="kx">客户端的Google Auth库正确地序列化为JSON。</em></p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="63bf" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">包扎</h1><p id="4c87" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在本文中，我们发现了如何在我们的App Engine应用程序上激活Google的IAP服务，以及它对我们的单个SPA (UI)和REST API的影响。</p><p id="710f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然单个SPA运行得很好，但我选择在一个节点内使用服务帐户。JS Express服务器运行在我的单个SPA中，使用Google的auth库代理对我的REST API应用程序的请求。</p><p id="2f8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我建议增加的一项内容是，在尝试使用服务帐户获得额外的安全层之前，在我的节点代理中使用</strong> <code class="fe on oo op no b"><strong class="ka ir">X-Goog-IAP-JWT-Assertion</strong></code> <strong class="ka ir">请求头来验证用户。</strong></p><p id="e18a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望这对某人有所帮助，并随时建议替代/更好的方法。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><blockquote class="oq or os"><p id="92a5" class="jy jz kx ka b kb kc kd ke kf kg kh ki ot kk kl km ou ko kp kq ov ks kt ku kv ij bi translated">感谢您花时间阅读我的文章。</p></blockquote></div></div>    
</body>
</html>