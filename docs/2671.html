<html>
<head>
<title>Node.js Tips — Send Message, Adding End of Line, and S3 Uploads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示—发送消息、添加行尾和S3上传</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-send-message-adding-end-of-line-and-s3-uploads-699a5fe466da?source=collection_archive---------11-----------------------#2020-07-13">https://javascript.plainenglish.io/node-js-tips-send-message-adding-end-of-line-and-s3-uploads-699a5fe466da?source=collection_archive---------11-----------------------#2020-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b60bcf898db2b4602f1254d2a642a02d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u3wt_s_0mwvZHiyi"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@markuswinkler?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Winkler</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5e6b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="5629" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Socket.io向特定客户端发送消息</h1><p id="401d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe me mf mg mh b">emit</code>方法用socket.io向特定的客户端发送消息。</p><p id="ad49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9e92" class="mq lc iq mh b gy mr ms l mt mu">io.to(socket.id).emit("event", data);</span></pre><p id="e6c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用我们想要向其发送消息的客户机的ID调用<code class="fe me mf mg mh b">io.to</code>方法。</p><h1 id="4e5e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Node.js中的JSON对象进行响应</h1><p id="8063" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用带有Express的<code class="fe me mf mg mh b">res.json</code>方法来返回JSON响应。</p><p id="e262" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a0ac" class="mq lc iq mh b gy mr ms l mt mu">res.json({ foo: 'bar' });</span></pre><p id="0b83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">返回我们传入的JSON对象。</p><h1 id="0a1e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">检查是否安装了Node.js</h1><p id="3524" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe me mf mg mh b">node -v</code>命令显示节点版本来检查节点是否已安装。</p><h1 id="83f9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用node-mongodb-native选择并更新文档by _id</h1><p id="e103" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了通过文档的<code class="fe me mf mg mh b">_id</code>来选择和更新文档，我们可以使用<code class="fe me mf mg mh b">mongo.ObjectID</code>构造函数来创建ID对象。</p><p id="062c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5c5d" class="mq lc iq mh b gy mr ms l mt mu">const mongo = require('mongodb');<br/>const id = new mongo.ObjectID(theId);<br/>collection.update({ '_id': id });</span></pre><p id="6388" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">theId</code>是ID的字符串。</p><p id="ece1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用它作为<code class="fe me mf mg mh b">'_id'</code>属性的值。</p><h1 id="601d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">如何在Node.js中追加到新行</h1><p id="0c7b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe me mf mg mh b">open</code>和<code class="fe me mf mg mh b">write</code>方法在节点应用程序的文件中添加新的一行。</p><p id="44f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了添加新行，我们使用<code class="fe me mf mg mh b">os.EOL</code>属性来添加新行字符。</p><p id="14ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，新行将在所有平台上正确插入。</p><p id="08f6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2a69" class="mq lc iq mh b gy mr ms l mt mu">const os = require("os");</span><span id="d8db" class="mq lc iq mh b gy mv ms l mt mu">const addNewLine = (text) =&gt; {     <br/>  fs.open('/path/to/file', 'a', 666, (e, id) =&gt; {<br/>    fs.write(id, `${text}${os.EOL}`, null, 'utf8', () =&gt; {<br/>      fs.close(id, () =&gt; {<br/>       console.log('file is updated');<br/>      });<br/>    });<br/>  });<br/>}</span></pre><p id="d9a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了<code class="fe me mf mg mh b">addNewLine</code>方法来打开文件。</p><p id="e567" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用追加权限打开它，如<code class="fe me mf mg mh b">'a'</code>所示。</p><p id="ae21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">666是文件权限，包括读和写。</p><p id="3e64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们在回调中获得文件ID，这样我们就可以用它来更新文件。</p><p id="75f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">fs.write</code>调用中，<code class="fe me mf mg mh b">id</code>是文件ID。第二个参数是文本内容。</p><p id="8cec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">os.EOL</code>是平台无关的新行常量。</p><p id="d071" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">'utf8'</code>是UTF-8编码。</p><p id="7b35" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在写入完成时调用回调。</p><p id="b725" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe me mf mg mh b">fs.close</code>清理文件句柄。</p><h1 id="23cb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">通过Node.js将base64编码的图像上传到亚马逊S3</h1><p id="2667" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要用S3上传base64图像，我们可以将其转换到缓冲区。</p><p id="3e44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以调用<code class="fe me mf mg mh b">putObject</code>来上传文件。</p><p id="dd41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0dec" class="mq lc iq mh b gy mr ms l mt mu">const AWS = require('aws-sdk');<br/>AWS.config.loadFromPath('./config.json');<br/>const s3Bucket = new AWS.S3( { params: { Bucket: 'someBucket'} } );</span><span id="a11b" class="mq lc iq mh b gy mv ms l mt mu">const buffer = new Buffer(req.body.imageBinary.replace(/^data:image\/\w+;base64,/, ""),'base64');</span><span id="368a" class="mq lc iq mh b gy mv ms l mt mu">const data = {<br/>  Key: 123, <br/>  Body: buffer,<br/>  ContentEncoding: 'base64',<br/>  ContentType: 'image/jpeg'<br/>};</span><span id="e6ec" class="mq lc iq mh b gy mv ms l mt mu">s3Bucket.putObject(data, (err, data) =&gt; {<br/>  if (err) { <br/>    console.log(err, data);<br/>  } else {<br/>    console.log('success');<br/>  }<br/>});</span></pre><p id="d7d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先从<code class="fe me mf mg mh b">config.json</code>文件中获取凭证，以对AWS SDK进行身份验证。</p><p id="8dd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们从base64字符串创建一个缓冲区。</p><p id="711f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须取出<code class="fe me mf mg mh b">data:image\/\w+;base64</code>部分。</p><p id="9280" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们创建一个具有<code class="fe me mf mg mh b">Key</code>、<code class="fe me mf mg mh b">Body</code>、<code class="fe me mf mg mh b">ContentEncoding</code>和<code class="fe me mf mg mh b">ContentType</code>属性的<code class="fe me mf mg mh b">data</code>对象。</p><p id="c83f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Key</code>是文件的路径。</p><p id="5533" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Body</code>有文件的内容。</p><p id="0d28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">ContentEncoding</code>有编码。</p><p id="c783" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">ContentType</code>有数据类型。</p><p id="b43f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe me mf mg mh b">putObject</code>来上传文件。</p><p id="38d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">config.json</code>有:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f6ad" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  "accessKeyId":"xxxxxxxxxxxxxxxx",<br/>  "secretAccessKey":"xxxxxxxxxxxxxx",<br/>  "region":"us-east-1"<br/>}</span></pre><h1 id="c45e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用节点child_process的exec的Stdout缓冲区问题—超出maxBuffer</h1><p id="5cfc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们得到“超出最大缓冲区”错误，我们可以使用设置<code class="fe me mf mg mh b">exec</code>上的<code class="fe me mf mg mh b">maxBuffer</code>选项来增加缓冲区大小。</p><p id="66d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1a91" class="mq lc iq mh b gy mr ms l mt mu">exec('ls', { maxBuffer: 1024 ** 2 }, (error, stdout, stderr) =&gt; { <br/>  console.log(error, stdout); <br/>});</span></pre><p id="14cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在第二个参数中设置对象的<code class="fe me mf mg mh b">maxBuffer</code>大小。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/3a056616b4cde5e364f6c850f9f8d222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s36ac5rcINZDNvzZ"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@reskp?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jametlene Reskp</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="7cc2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="967f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">io.to</code>方法将消息发送给给定的客户端。</p><p id="a291" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要发送JSON响应，我们可以使用<code class="fe me mf mg mh b">res.json</code>。</p><p id="8029" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用ID更新。</p><p id="635c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以增加<code class="fe me mf mg mh b">exec</code>的最大缓冲区大小。</p><p id="e20d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">os.EOL</code>常量来添加一个平台无关的行尾字符。</p><h2 id="24a1" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated">简单英语的JavaScript</h2><p id="e835" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>