<html>
<head>
<title>How to deploy an Angular app to Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Angular app部署到Docker</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-angular-application-with-lint-unit-tests-chrome-headless-and-release-to-nginx-inside-bdc84ea9e5ab?source=collection_archive---------0-----------------------#2019-02-01">https://javascript.plainenglish.io/build-angular-application-with-lint-unit-tests-chrome-headless-and-release-to-nginx-inside-bdc84ea9e5ab?source=collection_archive---------0-----------------------#2019-02-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="ad9a" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用lint，单元测试(chrome headless)并发布到nginx</h2></div><p id="0139" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">基于我以前的一些关于UI微前端/微服务的帖子，我一直在使用Docker为Angular应用程序构建创建容器。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/19bafbc0564ed14c26cc1cd5bf0e3899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YItL6VzdXRolLpL4oqmi0Q.png"/></div></div></figure><p id="782e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在Docker内部建造棱角分明的建筑实际上非常简单。让我们直接从基本的角度构建开始，然后发布到nginx:</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="7634" class="lp lq in ll b gy lr ls l lt lu">FROM nginx:alpine as env</span><span id="ed45" class="lp lq in ll b gy lv ls l lt lu"># fetch dependencies</span><span id="f0e2" class="lp lq in ll b gy lv ls l lt lu">RUN apk add --no-cache nodejs nodejs-npm &amp;&amp; \<br/>apk upgrade --no-cache --available &amp;&amp; \<br/>npm config set unsafe-perm true &amp;&amp; \<br/>npm install -g @angular/cli npm-snapshot &amp;&amp; \<br/>npm cache clean --force</span><span id="8eb7" class="lp lq in ll b gy lv ls l lt lu"># build step</span><span id="04df" class="lp lq in ll b gy lv ls l lt lu">FROM env as dev<br/>COPY . src<br/>WORKDIR src<br/>RUN npm install &amp;&amp; \<br/>npm rebuild node-sass &amp;&amp; \<br/>ng build</span><span id="1a76" class="lp lq in ll b gy lv ls l lt lu"># release stage</span><span id="5e6b" class="lp lq in ll b gy lv ls l lt lu">FROM nginx:latest AS release<br/>COPY --from=dev src/dist/ /usr/share/nginx/html/</span></pre><p id="8ee6" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">好了，现在我们来分解一下:</p><h1 id="96a3" class="lw lq in bd lx ly lz ma mb mc md me mf jt mg ju mh jw mi jx mj jz mk ka ml mm bi translated">预构建</h1><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="d530" class="lp lq in ll b gy lr ls l lt lu">FROM nginx:alpine as env</span><span id="b652" class="lp lq in ll b gy lv ls l lt lu"># fetch dependencies</span><span id="6d37" class="lp lq in ll b gy lv ls l lt lu">RUN apk add --no-cache nodejs nodejs-npm &amp;&amp; \<br/>apk upgrade --no-cache --available &amp;&amp; \<br/>npm config set unsafe-perm true &amp;&amp; \<br/>npm install -g @angular/cli npm-snapshot &amp;&amp; \<br/>npm cache clean --force</span></pre><p id="7a7b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里我使用的是<code class="fe mn mo mp ll b">nginx:alpine</code>基本图像——我们的Angular应用程序最终将通过nginx服务器提供服务。</p><p id="69c4" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们正试图在我们所有的微服务中标准化容器，因此我们使用alpine (linux)基础映像。</p><p id="3933" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以将<code class="fe mn mo mp ll b">ngnix:alpine</code>切换到<code class="fe mn mo mp ll b">node:latest</code>，这样您就不需要<code class="fe mn mo mp ll b">RUN apk add</code>步骤，这让我很好地获取我们的依赖项…</p><p id="e428" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为我们从alpine开始，所以我们没有在容器中安装npm或nodejs，所以我们必须在安装Angular CLI之前获取并安装它们。</p><p id="bf85" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> <em class="mq">注意:</em> </strong> <em class="mq">如果你是基于nodejs或者npm的话，应该是这样的:</em></p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="c39c" class="lp lq in ll b gy lr ls l lt lu">FROM node:latest as env</span><span id="886b" class="lp lq in ll b gy lv ls l lt lu">RUN npm config set unsafe-perm true &amp;&amp; \<br/>npm install -g @angular/cli npm-snapshot &amp;&amp; \<br/>npm cache clean --force</span></pre><h1 id="325c" class="lw lq in bd lx ly lz ma mb mc md me mf jt mg ju mh jw mi jx mj jz mk ka ml mm bi translated">建设</h1><p id="0ad4" class="pw-post-body-paragraph kc kd in ke b kf mr jo kh ki ms jr kk kl mt kn ko kp mu kr ks kt mv kv kw kx ig bi translated">一旦我们安装了依赖项，现在让我们在容器中构建我们的Angular应用程序:</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="76e8" class="lp lq in ll b gy lr ls l lt lu"># build step</span><span id="1099" class="lp lq in ll b gy lv ls l lt lu">FROM env as dev<br/>COPY . src<br/>WORKDIR src<br/>RUN npm install &amp;&amp; \<br/>npm rebuild node-sass &amp;&amp; \<br/>ng build</span></pre><p id="4b84" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这里，我们将所有文件复制到一个<strong class="ke io"> /src </strong>文件夹中，然后使用<code class="fe mn mo mp ll b">npm install</code>从npm安装我们的项目依赖项。</p><p id="729b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> <em class="mq">注意:</em> </strong> <em class="mq">我在这里包含了一个</em> <code class="fe mn mo mp ll b">npm rebuild node-sass</code> <em class="mq">步骤，因为node-sass通常绑定到您的操作系统，所以除非您在alpine内部进行本地开发，否则您可能会遇到没有它的diffs，因为您的package-lock.json将锁定到您的本地操作系统版本。</em></p><p id="c4df" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，我们可以使用<code class="fe mn mo mp ll b">ng build</code>运行我们的构建步骤，这会将我们的项目构建到一个<strong class="ke io"> /src/dist </strong>文件夹中。</p><h1 id="32f0" class="lw lq in bd lx ly lz ma mb mc md me mf jt mg ju mh jw mi jx mj jz mk ka ml mm bi translated">释放；排放；发布</h1><p id="7695" class="pw-post-body-paragraph kc kd in ke b kf mr jo kh ki ms jr kk kl mt kn ko kp mu kr ks kt mv kv kw kx ig bi translated">现在我们已经准备好将构建好的文件发布到ngnix服务器上，方法是将它们复制到ngnix的根目录，如下所示。</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="67c6" class="lp lq in ll b gy lr ls l lt lu"># release stage</span><span id="39cc" class="lp lq in ll b gy lv ls l lt lu">FROM nginx:latest AS releaseCOPY --from=dev src/dist/&lt;project&gt;/ /usr/share/nginx/html/</span></pre><p id="da1c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="mq">注意:根据Angular应用程序的构建设置，您可能需要指定将文件构建到哪个文件夹。</em></p><h1 id="168e" class="lw lq in bd lx ly lz ma mb mc md me mf jt mg ju mh jw mi jx mj jz mk ka ml mm bi translated">棉绒/单元测试</h1><p id="d904" class="pw-post-body-paragraph kc kd in ke b kf mr jo kh ki ms jr kk kl mt kn ko kp mu kr ks kt mv kv kw kx ig bi translated">现在，在Docker中运行lint和单元测试不是很好吗？</p><p id="58dc" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为此，我们首先需要获取alpine所需的chrome驱动程序，将<strong class="ke io"> RUN apk add </strong>行改为如下:</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="ac7f" class="lp lq in ll b gy lr ls l lt lu">RUN apk add --no-cache nodejs nodejs-npm bash chromium nss chromium-chromedriver &amp;&amp; \</span></pre><p id="64b0" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让单元测试在Chrome headless中运行有点棘手。简而言之，Docker不太喜欢Chrome headless，除非你在特权模式下运行你的容器。假设你不是，我们需要告诉Karma (Angular的单元测试运行程序)用<code class="fe mn mo mp ll b">--no-sandbox</code>标志运行ChromeHeadless。</p><p id="0d02" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我发现的最简单的方法是给你的<strong class="ke io"> src/karma.conf.js </strong>添加一个customLauncher，如下所示:</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="4b61" class="lp lq in ll b gy lr ls l lt lu">customLaunchers: {<br/>  ChromeHeadless_without_sandox: {<br/>    base: 'ChromeHeadless',<br/>    flags: ['--no-sandbox']<br/>  }<br/>},<br/>browsers: ['ChromeHeadless_without_sandox']</span></pre><p id="19a9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在可以添加lint和单元测试步骤，如下图:</p><pre class="kz la lb lc gt lk ll lm ln aw lo bi"><span id="3fc1" class="lp lq in ll b gy lr ls l lt lu"># lint and unit test</span><span id="b33b" class="lp lq in ll b gy lv ls l lt lu">FROM dev as test<br/>RUN ng lint &amp;&amp; \<br/>ng test --watch=false</span></pre><p id="237e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">就是这样！现在你应该能够在Docker内部构建、测试和发布了。</p><p id="1929" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里有一个完整的单元测试的工作示例:</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">Add custom launcher to karma.config.js</figcaption></figure><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">Build Angular application with lint and unit tests</figcaption></figure><blockquote class="nd ne nf"><p id="edbc" class="kc kd mq ke b kf kg jo kh ki kj jr kk ng km kn ko nh kq kr ks ni ku kv kw kx ig bi translated">感谢您花时间阅读我的文章。</p></blockquote></div></div>    
</body>
</html>