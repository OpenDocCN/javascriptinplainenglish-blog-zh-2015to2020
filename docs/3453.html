<html>
<head>
<title>JWT Auth with Node and Passport JS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有节点和护照JS的JWT身份验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/jwt-auth-with-node-and-passport-js-c41a91d333e0?source=collection_archive---------0-----------------------#2020-09-30">https://javascript.plainenglish.io/jwt-auth-with-node-and-passport-js-c41a91d333e0?source=collection_archive---------0-----------------------#2020-09-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/5adb3e94ce5d4761ad46c819057fd2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R2th-cAP0HQJJGPaWLnxJw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Cover Image</figcaption></figure><p id="f233" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">JWT是在双方之间安全传输数据的开放标准。它与身份验证系统一起使用，以发出经过身份验证的请求。它包括<code class="fe kx ky kz la b">header</code>、<code class="fe kx ky kz la b">payload</code>和<code class="fe kx ky kz la b">signature</code>。JWT是一种无状态认证机制，即它在客户端维护会话，而不是将其存储在服务器中。</p><p id="0fe6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">JWT的工作流程非常简单。JWT是用一个秘密密钥创建的，这个秘密密钥将被秘密保存在你的应用程序中。当您的应用程序从任何客户端接收到JWT密钥时，您的应用程序会用私钥验证该密钥。从客户端修改公钥将导致身份验证失败。JWT由用点分隔的三个不同部分组成。最初的部分是标题。第二部分是有效载荷，第三部分是签名。JWT令牌的语法是</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="b4c4" class="lj lk in la b gy ll lm l ln lo">HEADER + '.' + PAYLOAD + '.' + SIGNATURE</span></pre><div class="lp lq gp gr lr ls"><a href="https://jwt.io/" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd io gy z fp lx fr fs ly fu fw im bi translated">JWT。超正析象管(Image Orthicon)</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">JSON Web Token (JWT)是一种简洁的、URL安全的方式，用于表示要在双方之间传输的声明。的…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">jwt.io</p></div></div><div class="mb l"><div class="mc l md me mf mb mg jt ls"/></div></div></a></div><p id="7460" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Passport JS是Node和Express JS的认证中间件。Passport JS可以与任何Express JS应用程序一起使用。它为我们提供了一个名为Passport JWT的策略，帮助我们进行认证请求，并验证令牌是否有效。</p><div class="lp lq gp gr lr ls"><a href="http://www.passportjs.org/packages/passport-jwt/" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd io gy z fp lx fr fs ly fu fw im bi translated">护照-jwt</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">使用JSON Web令牌进行身份验证的Passport策略。这个模块让您使用JSON来验证端点…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">www.passportjs.org</p></div></div><div class="mb l"><div class="mh l md me mf mb mg jt ls"/></div></div></a></div></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><p id="9910" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">目录</strong></p><ol class=""><li id="6ffb" class="mp mq in kb b kc kd kg kh kk mr ko ms ks mt kw mu mv mw mx bi translated"><a class="ae my" href="#5fe1" rel="noopener ugc nofollow">初始化一个节点项目</a></li><li id="563b" class="mp mq in kb b kc mz kg na kk nb ko nc ks nd kw mu mv mw mx bi translated"><a class="ae my" href="#29e0" rel="noopener ugc nofollow">创建JWT令牌</a></li><li id="13de" class="mp mq in kb b kc mz kg na kk nb ko nc ks nd kw mu mv mw mx bi translated"><a class="ae my" href="#c91b" rel="noopener ugc nofollow">实施passport的JWT战略</a></li></ol></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><ol class=""><li id="5fe1" class="mp mq in kb b kc kd kg kh kk mr ko ms ks mt kw mu mv mw mx bi translated"><strong class="kb io">初始化一个节点项目</strong></li></ol><p id="af2b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">首先，让我们创建一个新的Node js项目。下面的命令创建一个新文件夹，然后初始化我们项目的节点。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="2845" class="lj lk in la b gy ll lm l ln lo">mkdir jwt_passport<br/>cd jwt_passport/<br/>npm init -y<br/>touch index.js</span></pre><p id="f728" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在安装所需的软件包:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="70c5" class="lj lk in la b gy ll lm l ln lo">npm i express cookie-session mongoose passport <!-- -->passport-jwt <!-- -->jsonwebtoken body-parser</span></pre><p id="964c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">安装后，将下面的代码复制到您的<code class="fe kx ky kz la b">index.js</code>文件中。</p><p id="b3f7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">index.js</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="1a33" class="lj lk in la b gy ll lm l ln lo">const express = require('express')<br/>const mongoose = require('mongoose')<br/><strong class="la io">const bodyParser = require('body-parser')<br/></strong>const app = express()</span><span id="634c" class="lj lk in la b gy ne lm l ln lo"><strong class="la io">app.use(bodyParser.json())<br/></strong>app.get('/',(req,res)=&gt;{<br/>  res.send('Hello world')<br/>})</span><span id="1c50" class="lj lk in la b gy ne lm l ln lo">mongoose.connect(<strong class="la io">"mongodb://localhost/louji", {useNewUrlParser: true, useUnifiedTopology: true}</strong>);</span><span id="509a" class="lj lk in la b gy ne lm l ln lo">mongoose.connection.once('open',function(){<br/>  console.log('Connected to Mongo');<br/>}).on('error',function(err){<br/>  console.log('Mongo Error', err);<br/>})</span><span id="2471" class="lj lk in la b gy ne lm l ln lo">app.listen(8000,()=&gt;{<br/>  console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="4d70" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在使用<code class="fe kx ky kz la b">node index.js</code>启动服务器。然后导航到<a class="ae my" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000/ </a>。您应该会看到浏览器中显示“Hello world”。</p><p id="29e0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">2.<strong class="kb io">创造JWT令牌</strong></p><p id="9487" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">首先，让我们为用户创建一个JWT令牌。为此，让我们创建一个注册API。</p><p id="1fd3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因为我们要处理用户注册，所以我们需要一个用户模型。我已经创建了一个带有电子邮件和密码属性的用户模型。将其复制到您的模型文件中。</p><p id="4083" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">Models/User.js</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="24eb" class="lj lk in la b gy ll lm l ln lo">const  mongoose = require('mongoose')</span><span id="4ce8" class="lj lk in la b gy ne lm l ln lo"><strong class="la io">const UserSchema = new mongoose.Schema({<br/>  email: {<br/>    type: String,<br/>    required: true,<br/>  },<br/>  password: {<br/>    type: String,<br/>    required: true, <br/>  }<br/>})</strong></span><span id="a7a8" class="lj lk in la b gy ne lm l ln lo">module.exports = mongoose.model('User',UserSchema)</span></pre><p id="edfb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">创建一个名为<code class="fe kx ky kz la b">passport.js</code>的新文件，复制下面的代码。这个文件将成为验证我们的JWT令牌的中间件。</p><p id="0c7c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">passport.js</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="de8b" class="lj lk in la b gy ll lm l ln lo">const passport = require('passport')<br/><strong class="la io">const passportJWT = require("passport-jwt");<br/>const JWTStrategy   = passportJWT.Strategy;</strong><br/>const ExtractJWT = passportJWT.ExtractJwt;const User = require('./Models/User')</span><span id="2763" class="lj lk in la b gy ne lm l ln lo">passport.use(new JWTStrategy({<br/><strong class="la io">  jwtFromRequest: ExtractJWT.fromAuthHeaderAsBearerToken(),<br/>  secretOrKey   : 'joanlouji'</strong><br/>},<br/> function (jwtPayload, done) {<br/><strong class="la io">   return User.findById(jwtPayload.sub)<br/></strong>   .then(user =&gt; <br/>   {<br/>     return done(null, user);<br/>   }<br/> ).catch(err =&gt; <br/> {<br/>   return done(err);<br/> });<br/>}<br/>))</span></pre><p id="5510" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">创建中间件后，指向<code class="fe kx ky kz la b">index.js</code>文件并复制下面的代码。在这段代码中，我创建了一条名为<code class="fe kx ky kz la b">/register</code>的新路线，并将用户值插入到数据库中。如果用户值有效，将生成JWT令牌。</p><p id="72df" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">index.js</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="a756" class="lj lk in la b gy ll lm l ln lo">const express = require('express')<br/>const mongoose = require('mongoose')<br/>const bodyParser = require('body-parser')<strong class="la io"><br/>const User = require('./Models/User')<br/>const jwt = require('jsonwebtoken');<br/>require('./passport')</strong><br/>const app = express()</span><span id="7150" class="lj lk in la b gy ne lm l ln lo"><strong class="la io">genToken = user =&gt; {<br/>  return jwt.sign({<br/>    iss: 'Joan_Louji',<br/>    sub: user.id,<br/>    iat: new Date().getTime(),<br/>    exp: new Date().setDate(new Date().getDate() + 1)<br/>  }, 'joanlouji');<br/>}</strong></span><span id="3044" class="lj lk in la b gy ne lm l ln lo">app.use(bodyParser.json())<strong class="la io"><br/></strong>app.get('/',(req,res)=&gt;{<br/>  res.send('Hello world')<br/>})<br/><strong class="la io">app.post('/register', async function (req, res, next) {<br/>  const { email, password } = req.body;<br/>  <br/>  //Check If User Exists<br/>  let foundUser = await User.findOne({ email });<br/>  if (foundUser) {<br/>    return res.status(403).json({ error: 'Email is already in use'});<br/>  }<br/> <br/>  const newUser = new User({ email, password})<br/>  await newUser.save()</strong></span><span id="7a50" class="lj lk in la b gy ne lm l ln lo"><strong class="la io">  // Generate JWT token<br/>  const token = genToken(newUser)<br/>  res.status(200).json({token})<br/>});</strong></span><span id="9ee2" class="lj lk in la b gy ne lm l ln lo">mongoose.connect("mongodb://localhost/louji", {useNewUrlParser: true, useUnifiedTopology: true});</span><span id="2f93" class="lj lk in la b gy ne lm l ln lo">mongoose.connection.once('open',function(){<br/>  console.log('Connected to Mongo');<br/>}).on('error',function(err){<br/>  console.log('Mongo Error', err);<br/>})</span><span id="19d8" class="lj lk in la b gy ne lm l ln lo">app.listen(8000,()=&gt;{<br/>  console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="6e1f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在尝试用邮箱和密码向<a class="ae my" href="http://localhost:8000/register" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/register</a>发出post请求。如果他们是有效的，你会收到一个JWT令牌。</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nf"><img src="../Images/5fa611418c08ff07ac5861eefbdf0174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kl5oKooqwX1h7Cqpe-dQLA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">JWT Token</figcaption></figure><p id="c91b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">3.<strong class="kb io">实施passport的JWT战略</strong></p><p id="1327" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在让我们创建一个路由来发出一个经过身份验证的请求。要做到这一点，只需通过<code class="fe kx ky kz la b">passport.authenticate</code>到路线。这将检查请求是否有JWT令牌，以及JWT令牌是否有效。</p><p id="5511" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">index.js</code></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="7786" class="lj lk in la b gy ll lm l ln lo"><strong class="la io">const passport = require('passport')</strong></span><span id="844a" class="lj lk in la b gy ne lm l ln lo"><strong class="la io">app.get('/secret', passport.authenticate('jwt',{session: false}),(req,res,next)=&gt;{<br/>  res.json("Secret Data")<br/>})</strong></span></pre><p id="6f6e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在没有授权令牌的情况下向<a class="ae my" href="http://localhost:8000/secret" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/secret</a>发出GET请求时，您将得到一条错误消息。</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/747a22e5e7f034698ebc75e8e69a733f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37ivDeMWr4LY0lJHiLy_Jw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Accessing a route without JWT token</figcaption></figure><p id="a059" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在用JWT令牌发出同样的请求。你会看到秘密数据。</p><p id="1146" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">注</strong>:在令牌前添加持票人。语法是<code class="fe kx ky kz la b">Authorization: bearer JSON_WEB_TOKEN_STRING</code>。<a class="ae my" href="https://github.com/mikenicholson/passport-jwt" rel="noopener ugc nofollow" target="_blank"> Passport JS还提供了从请求中获取令牌的其他不同方式</a>。</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/4410886a78c2bac42fba71cf4cfeaa3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLApjB1eCLKab7YYKKR4Bg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Accessing a route with JWT token</figcaption></figure><p id="fada" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如有任何疑问，请随时联系我。电子邮件:sjlouji10@gmail.com。领英:<a class="ae my" href="https://www.linkedin.com/in/sjlouji/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/sjlouji/</a></p><p id="7b22" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我的GitHub上的完整代码:</p><div class="lp lq gp gr lr ls"><a href="https://github.com/sjlouji/Passport-Strategies---Medium/tree/master/jwt_passport" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd io gy z fp lx fr fs ly fu fw im bi translated">sjlouji/Passport-策略-中等</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">护照策略。在GitHub上创建一个帐户，为sjlouji/Passport-Strategies-Medium开发做出贡献。</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">github.com</p></div></div><div class="mb l"><div class="ni l md me mf mb mg jt ls"/></div></div></a></div><p id="1958" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">编码快乐！</p></div></div>    
</body>
</html>