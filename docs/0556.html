<html>
<head>
<title>Creating a drag and drop uploader with previews using React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React创建带有预览的拖放上传程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-a-drag-and-drop-uploader-with-previews-using-react-aa794972c43e?source=collection_archive---------3-----------------------#2019-11-07">https://javascript.plainenglish.io/creating-a-drag-and-drop-uploader-with-previews-using-react-aa794972c43e?source=collection_archive---------3-----------------------#2019-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9b620b88b07ba8f20a3b6d49d95b74fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tGfhB8ZybTjSLH9t139OIA.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">an illustration header because every good medium article has one</figcaption></figure><div class=""/><div class=""><h2 id="9ea7" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">并在这个过程中编写你的第一个定制钩子</h2></div><p id="2fd2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">有很多图书馆可以为你做这些。为什么你会傻到去重新发明轮子？嗯，第一个原因是你会学到新的东西。第二个原因是，也许你的应用程序有目前的库中没有的特殊需求。也许你需要隐藏的输入，因为性能的原因，你的整个应用依赖于表单而不是有状态的输入。</p><p id="72ad" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们要做<strong class="kw jg"> <em class="lq">定制挂钩。</em> </strong>学新东西？大概？嗯，我们将学习一些关于文件列表、文件和上传的新知识。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="6eb2" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">结构和先决条件</h2><p id="13fc" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">你需要知道的只是一些基本的React、Javascript和钩子(但是不要担心，我们也可以用类来做这个，钩子只是现在才出现)。</p><p id="a837" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">为了创建它，我们需要弄清楚<strong class="kw jg">文件</strong>和<strong class="kw jg">文件列表</strong>是什么。什么是<strong class="kw jg">斑点</strong>以及如何缓存图像以作为预览的斑点。我们需要熟悉onDrop和类似的活动。</p><h2 id="9294" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">引用自MDN</h2><blockquote class="mw mx my"><p id="4363" class="ku kv lq kw b kx ky kg kz la lb kj lc mz le lf lg na li lj lk nb lm ln lo lp ij bi translated"><code class="fe nc nd ne nf b"><strong class="kw jg">File</strong></code>接口提供关于文件的信息，并允许网页中的JavaScript访问它们的内容。— <a class="ae ng" href="https://developer.mozilla.org/en/docs/Web/API/File" rel="noopener ugc nofollow" target="_blank"> MDN </a></p><p id="baf5" class="ku kv lq kw b kx ky kg kz la lb kj lc mz le lf lg na li lj lk nb lm ln lo lp ij bi translated">这种类型的对象由HTML <code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input" rel="noopener ugc nofollow" target="_blank">&lt;input&gt;</a></code>元素的<code class="fe nc nd ne nf b">files</code>属性返回；这允许您访问用<code class="fe nc nd ne nf b">&lt;input type="file"&gt;</code>元素选择的文件列表。它还用于在使用拖放API时放入web内容的文件列表；关于这个用法的详细信息，请参见<code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/DragDrop/DataTransfer" rel="noopener ugc nofollow" target="_blank">DataTransfer</a></code>对象。— <a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/FileList" rel="noopener ugc nofollow" target="_blank"> MDN </a></p><p id="bb13" class="ku kv lq kw b kx ky kg kz la lb kj lc mz le lf lg na li lj lk nb lm ln lo lp ij bi translated">静态方法<code class="fe nc nd ne nf b"><strong class="kw jg">URL.createObjectURL()</strong></code>创建一个包含URL的<code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/DOMString" rel="noopener ugc nofollow" target="_blank">DOMString</a></code>,该URL表示参数中给定的对象。URL的生命周期依赖于创建它的窗口中的<code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/Document" rel="noopener ugc nofollow" target="_blank">document</a></code>。新的对象URL代表指定的<code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/File" rel="noopener ugc nofollow" target="_blank">File</a></code>对象或<code class="fe nc nd ne nf b"><a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/Blob" rel="noopener ugc nofollow" target="_blank">Blob</a></code>对象。— <a class="ae ng" href="https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL" rel="noopener ugc nofollow" target="_blank"> MDN </a></p></blockquote><p id="ba88" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">专业提示:阅读文档</p><p id="4a9b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">那不碍事。我们走吧。</p><h1 id="76cc" class="nh lz jf bd ma ni nj nk md nl nm nn mg kl no km mj ko np kp mm kr nq ks mp nr bi translated">样式和DOM节点</h1><p id="583e" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">对于样式，我们将使用scss，我们将制作一个简单的容器，它有一个不透明的绝对背景图像。upload-container类之上的over类，这样我们就可以在用户在容器上放置文件时触发(我们将使用<strong class="kw jg">状态</strong>和<strong class="kw jg"> onDrop </strong>事件来管理这一点)。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">The style at the start of the project</figcaption></figure><p id="de02" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于dom，我们需要两个容器。一个用于显示图像，另一个用于用户拖放图像</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">The dom at the start of the project</figcaption></figure><figure class="ns nt nu nv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ny"><img src="../Images/2bae5398e2bae33aa55dc4b90187f579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YoFBCHRCt6fFV3BO6QzPBg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">this is how it looks like</figcaption></figure><h1 id="253e" class="nh lz jf bd ma ni nj nk md nl nm nn mg kl no km mj ko np kp mm kr nq ks mp nr bi translated">状态和事件:惩罚</h1><p id="b320" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">这东西要做的是:</p><ol class=""><li id="d376" class="nz oa jf kw b kx ky la lb ld ob lh oc ll od lp oe of og oh bi translated">确保用户可以点击容器并打开一个对话框</li><li id="3ebd" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">根据道具限制文件最大数量</li><li id="b95b" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">在图片上传为blobs之前查看图片</li><li id="f2e0" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">将文件添加到状态，使用效果将文件传递到道具</li></ol><h2 id="e22b" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">点击时的输入对话框</h2><p id="3dcc" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">这可以说是最容易做到的事情。添加display: none文件输入，并在用户单击容器时单击它。将文件添加到state，但是首先我们必须将文件列表转换为数组。别担心，超级简单。毁掉它。我们需要担心的事件是:</p><ol class=""><li id="cdab" class="nz oa jf kw b kx ky la lb ld ob lh oc ll od lp oe of og oh bi translated">onDrop —文件已被删除(覆盖已完成)</li><li id="74c6" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">onDragOver —文件正在被丢弃(正在发生覆盖)</li><li id="2821" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">onDragLeave —文件消失了(结束了(？))</li></ol><p id="7e32" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们相应地调整状态。</p><p id="c2a3" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">最重要的是，我们防止默认事件动作，因为我们想自己管理整个事情。我们通过调用</p><pre class="ns nt nu nv gt on nf oo op aw oq bi"><span id="4f61" class="ly lz jf nf b gy or os l ot ou">e.preventDefault()</span></pre><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">pretty easy, right?</figcaption></figure><h2 id="94e4" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">斑点预览和<em class="ov">自定义挂钩:推算</em></h2><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="ow nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">just trust me</figcaption></figure><p id="d609" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">定制钩子听起来令人生畏，但实际上很简单。您只需扩展已经建立的useState挂钩。我们要做的基本上是，获取文件，并使用Object.assign或mapping将它们添加到文件中。我将使用map方法，因为如果您一直在使用React，这应该是您的第二天性。</p><p id="c75e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我在做什么？我采用useState公开的setstate方法并扩展它。我正在获取文件，对它们进行析构，并添加一个预览属性来公开本地blob预览。在判断出空值是否是图像后，从数组中删除空值。我也从上传的东西中移除了析构，因为我们正在析构我们的useBlobs <strong class="kw jg"> <em class="lq">自定义钩子</em> </strong>中的文件列表。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="ec3d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在我们的上传组件看起来像这样:</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="ox nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">custom hooks. told you so</figcaption></figure><h2 id="61d0" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">onDrop事件和处理大量文件:报复</h2><p id="c1d6" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">现在，对于onDrop道具，我们将把它与一个效果混合起来，这个效果将调用道具(如果它存在的话)。对于最大数量的文件，我们将传递一个prop，但默认为1。如果maxFiles属性大于1，则将多个属性添加到输入中。</p><pre class="ns nt nu nv gt on nf oo op aw oq bi"><span id="28b1" class="ly lz jf nf b gy or os l ot ou">&lt;input multiple={maxFiles &gt; 1} /&gt;</span></pre><p id="8b68" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们的函数声明和useFiles挂钩将如下所示:</p><pre class="ns nt nu nv gt on nf oo op aw oq bi"><span id="0aa7" class="ly lz jf nf b gy or os l ot ou">function Upload({ onDrop, maxFiles = 1 });</span><span id="5075" class="ly lz jf nf b gy oy os l ot ou">function useFiles({ initialState = [], maxFiles });</span><span id="8bd4" class="ly lz jf nf b gy oy os l ot ou">const [files, setfiles] = useFiles([], maxFiles);</span></pre><p id="eb6c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">让我们创建一个快速函数来删除数组的最后N项。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="098b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">并使用计算的差异属性将其调用到我们的useFiles挂钩中。差异是丢弃的文件数量减去最大文件数量。为了方便起见，将析构后的文件列表放入一个新变量中，计算差值，然后使用URL Blob魔术。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="b165" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在我们的Upload function函数中，让我们添加一个效果钩子，这样我们就可以调用作为道具传下来的onDrop事件(并且<strong class="kw jg"> <em class="lq">总是</em> </strong>检查它是否存在)。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="daf5" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们完事了。</p><h2 id="cee4" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">图像预览</h2><p id="ae17" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">这将是迄今为止我们要做的最简单的事情！只需映射出文件，添加一个图像节点，并将其源设置为file.preview属性。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="nw nx l"/></div></figure><figure class="ns nt nu nv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oz"><img src="../Images/8348361e993903a481001ee59847a0ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8g7_D55dkNQjBGGRwWV1Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">whos that handsome fella?</figcaption></figure><h1 id="8c71" class="nh lz jf bd ma ni nj nk md nl nm nn mg kl no km mj ko np kp mm kr nq ks mp nr bi translated">结论</h1><p id="b506" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">希望在这整个代码和荣誉的惨败之后，你已经设法弄清楚如何创建定制挂钩，更好地处理事件，并成为一个更好的球员和程序员(<strong class="kw jg">附加提示:不要总是追求三个</strong>)。</p><figure class="ns nt nu nv gt is"><div class="bz fp l di"><div class="pa nx l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">check it out for yourself (you have to open the sandbox for it work because of blobs and permissions)</figcaption></figure><h2 id="41cb" class="ly lz jf bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">外卖:</h2><ol class=""><li id="900a" class="nz oa jf kw b kx mr la ms ld pb lh pc ll pd lp oe of og oh bi translated">如果您正在修改事件，请始终阻止事件的默认操作</li><li id="fd9a" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">事情并不像看起来那么难</li><li id="13f6" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">永远学习</li><li id="b671" class="nz oa jf kw b kx oi la oj ld ok lh ol ll om lp oe of og oh bi translated">钩子非常简单，编写定制的钩子只能缩短你必须编写的代码，硬拉是困难的</li></ol><figure class="ns nt nu nv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pe"><img src="../Images/73befda9f54e053625a3fa378783981e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*Eo2Z7UAchKEKjdKJd3ODiw.png"/></div></div></figure><h1 id="1706" class="nh lz jf bd ma ni nj nk md nl nm nn mg kl no km mj ko np kp mm kr nq ks mp nr bi translated">社交——跟踪我</h1><p id="4c7c" class="pw-post-body-paragraph ku kv jf kw b kx mr kg kz la ms kj lc ld mt lf lg lh mu lj lk ll mv ln lo lp ij bi translated">我是一名全栈开发者。我举重。我看动漫。我写JavaScript，我没有斯德哥尔摩综合症。</p><p id="3d1e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">🔗<a class="ae ng" href="https://alekangelov.com" rel="noopener ugc nofollow" target="_blank">网站</a></p><p id="a9ce" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">🔒<a class="ae ng" href="https://www.linkedin.com/in/alekangelov/" rel="noopener ugc nofollow" target="_blank">领英</a></p><p id="e9f6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">🦜 <a class="ae ng" href="https://twitter.com/39strife" rel="noopener ugc nofollow" target="_blank">推特</a></p><p id="f457" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">图片致谢:<a class="ae ng" href="https://freepik.com" rel="noopener ugc nofollow" target="_blank">免费赠送</a></p></div></div>    
</body>
</html>