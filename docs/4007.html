<html>
<head>
<title>Jasmine — Async Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jasmine —异步测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/jasmine-async-tests-e9837ddf91b6?source=collection_archive---------4-----------------------#2020-11-10">https://javascript.plainenglish.io/jasmine-async-tests-e9837ddf91b6?source=collection_archive---------4-----------------------#2020-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b92656d16e14396434c36296e8ce01c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lD2ETmKg7DAmi1La"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@avincp?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Avin CP</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="66f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试是JavaScript的一个重要部分。</p><p id="6eb1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用Jasmine创建更复杂的测试。</p><h1 id="9b62" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">测试承诺</h1><p id="12d0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用茉莉来测试承诺。</p><p id="2875" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">beforeAll</code>、<code class="fe me mf mg mh b">afterAll</code>、<code class="fe me mf mg mh b">beforeEach</code>和<code class="fe me mf mg mh b">afterEach</code>功能都支持承诺。</p><p id="2625" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d2a7" class="mq lc iq mh b gy mr ms l mt mu">describe("Using promises", function () {<br/>  let value;</span><span id="c6c6" class="mq lc iq mh b gy mv ms l mt mu">  beforeEach(function () {<br/>    return Promise.resolve().then(function () {<br/>      value = 0;<br/>    });<br/>  });</span><span id="d6c3" class="mq lc iq mh b gy mv ms l mt mu">  it("should support async execution of tests", function () {<br/>    return Promise.resolve().then(function () {<br/>      value++;<br/>      expect(value).toBeGreaterThan(0);<br/>    });<br/>  });<br/>});</span></pre><p id="dc05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在<code class="fe me mf mg mh b">beforeEach</code>和<code class="fe me mf mg mh b">it</code>的复试中给<code class="fe me mf mg mh b">then</code>打了电话。</p><p id="b30e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以检查那里的值。</p><p id="9aee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它也适用于<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>语法。</p><p id="188d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="63d0" class="mq lc iq mh b gy mr ms l mt mu">describe("Using promises", function () {<br/>  let value;</span><span id="1792" class="mq lc iq mh b gy mv ms l mt mu">  beforeEach(async function () {<br/>    await Promise.resolve()<br/>    value = 0;<br/>  });</span><span id="c6a7" class="mq lc iq mh b gy mv ms l mt mu">  it("should support async execution of tests", async function () {<br/>    await Promise.resolve()<br/>    value++;<br/>    expect(value).toBeGreaterThan(0);<br/>  });<br/>});</span></pre><p id="d336" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只是用<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>语法重写了承诺。</p><p id="17b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这两个例子中，它们将按顺序运行。</p><p id="86b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试从<code class="fe me mf mg mh b">beforeEach</code>回调开始，然后运行<code class="fe me mf mg mh b">it</code>回调。</p><h1 id="a413" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">改变等待时间</h1><p id="0ecc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe me mf mg mh b">beforeEach</code>和<code class="fe me mf mg mh b">afterEach</code>函数采用可选的第二个参数来设置等待，直到<code class="fe me mf mg mh b">done</code>完成。</p><p id="7252" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8bf7" class="mq lc iq mh b gy mr ms l mt mu">describe("long asynchronous specs", function () {<br/>  beforeEach(function (done) {<br/>    done();<br/>  }, 1000);</span><span id="8a3c" class="mq lc iq mh b gy mv ms l mt mu">  it("takes a long time", function (done) {<br/>    setTimeout(function () {<br/>      done();<br/>    }, 9000);<br/>  }, 10000);</span><span id="81bc" class="mq lc iq mh b gy mv ms l mt mu">  afterEach(function (done) {<br/>    done();<br/>  }, 1000);<br/>});</span></pre><p id="94fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">传递第二个参数，等待时间以毫秒为单位。</p><h1 id="e1bb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">处理故障</h1><p id="c891" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">用承诺处理失败可以像任何其他代码一样完成。</p><p id="9fd4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一个承诺在我们的测试中被拒绝，那么测试就会失败。</p><p id="a88e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我们有:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ae4f" class="mq lc iq mh b gy mr ms l mt mu">describe("promise test", function () {<br/>  it('does a thing', function () {<br/>    return Promise.reject()<br/>  });<br/>});</span></pre><p id="edd4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么测试就会失败。</p><p id="4408" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>，我们得到相同的结果:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="eb99" class="mq lc iq mh b gy mr ms l mt mu">describe("long asynchronous specs", function () {<br/>  it('does a thing', async function () {<br/>    await Promise.reject()<br/>  });<br/>});</span></pre><p id="1f40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这也会失败。</p><p id="3c03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过复试来让测试失败。</p><p id="11ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从Jasmine 3.0开始，<code class="fe me mf mg mh b">done</code>函数可以检测是否有一个<code class="fe me mf mg mh b">Error</code>对象被传递给该函数。</p><p id="c710" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果是，那么测试将失败。</p><p id="bf87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="cb38" class="mq lc iq mh b gy mr ms l mt mu">describe("long asynchronous specs", function () {<br/>  beforeEach(function (done) {<br/>    setTimeout(function () {<br/>      let err;</span><span id="2ece" class="mq lc iq mh b gy mv ms l mt mu">      try {<br/>        throw new Error()<br/>      } catch (e) {<br/>        err = e;<br/>      }</span><span id="abe9" class="mq lc iq mh b gy mv ms l mt mu">      done(err);<br/>    });<br/>  });</span><span id="5ecd" class="mq lc iq mh b gy mv ms l mt mu">  it('does something', () =&gt; { })<br/>});</span></pre><p id="3e62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的<code class="fe me mf mg mh b">beforeEach</code>回调抛出一个错误。</p><p id="a6fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，既然我们用<code class="fe me mf mg mh b">err</code>对象调用<code class="fe me mf mg mh b">done</code>，我们将会看到测试将会失败。</p><h1 id="a08e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">模拟时钟</h1><p id="2f70" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用模拟时钟来避免编写异步测试。</p><p id="b304" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将使异步代码同步运行。</p><p id="4e2c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7c09" class="mq lc iq mh b gy mr ms l mt mu">describe("long asynchronous specs", function () {<br/>  beforeEach(function () {<br/>    jasmine.clock().install();<br/>  });</span><span id="8d37" class="mq lc iq mh b gy mv ms l mt mu">  afterEach(function () {<br/>    jasmine.clock().uninstall();<br/>  });</span><span id="d6b5" class="mq lc iq mh b gy mv ms l mt mu">  it('does something after 10 seconds', function () {<br/>    const callback = jasmine.createSpy('callback');<br/>    setTimeout(function () {<br/>      callback('foo');<br/>    }, 10000);<br/>    jasmine.clock().tick(10000);<br/>    expect(callback).toHaveBeenCalledWith('foo');<br/>  });<br/>});</span></pre><p id="cb29" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用模拟时钟创建一个测试。</p><p id="6270" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">jasmine.clock().install()</code>来创建时钟。</p><p id="2004" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们通过调用<code class="fe me mf mg mh b">tick</code>运行测试代码，移动到我们想要的时间。</p><p id="524f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当测试完成时，我们调用<code class="fe me mf mg mh b">jasmine.clock().uninstall()</code>来移除模拟时钟。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/bf68f682b6abda420b8d2de91337a8ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5lqVx4wT-77fJ9Vk"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@autumnkuney?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Autumn Kuney</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="02a1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="e5f4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Jasmine测试各种类型的异步代码。</p><p id="3214" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">承诺和回调都是支持的。</p><p id="69a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以让计时器代码与模拟时钟同步。</p><p id="c7ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果是这样，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅解码获得更多类似内容，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>