<html>
<head>
<title>GraphQL best practices: Use graphql-middleware for cross-cutting concerns</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL最佳实践:将graphql中间件用于横切关注点</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/graphql-best-practices-use-graphql-middleware-for-cross-cutting-concerns-57de2aafbb7b?source=collection_archive---------4-----------------------#2020-01-31">https://javascript.plainenglish.io/graphql-best-practices-use-graphql-middleware-for-cross-cutting-concerns-57de2aafbb7b?source=collection_archive---------4-----------------------#2020-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3559" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用graphql日志记录中间件来委托日志记录，避免增加维护成本并保持代码模块化</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47b65ead5cf8f84a502090b293b7d8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_NyTuevjXFDbns3htQrN3g.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@evphotocinema?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Evan Dvorkin</a> on <a class="ae kv" href="https://unsplash.com/s/photos/assembly-line?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="da0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">敏捷方法的信条之一强调快速迭代，包括交付和重构。大多数开发团队往往忽略的是导致大量杂乱代码的重构部分，这使得应用程序难以管理，GraphQL服务器也不例外。</p><p id="c983" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Cross-cutting_concern" rel="noopener ugc nofollow" target="_blank">交叉问题</a>如果处理不好，会严重加剧这个问题，而且随着时间的推移，这些问题会变得更加严重</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="2754" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">问题:</h2><p id="9aed" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">横切关注点，如日志、度量、跟踪、缓存、国际化和本地化等。如果没有在应用程序的架构和设计阶段进行规划，就开始逐渐进入代码库。应用程序可能很快开始让这种横切关注点的意大利面条式代码遍布整个代码库<strong class="ky ir"> <em class="mx"> </em> </strong>，导致<strong class="ky ir"> <em class="mx">代码模块性的丧失和维护成本的增加</em> </strong></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="ab56" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">解决方案:</h2><p id="f0ce" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">使用<strong class="ky ir"> <em class="mx">中间件</em> </strong>可以很好地封装横切关注点，由于其基于<em class="mx">洋葱原则</em>的行为，中间件是web应用服务器中广泛采用的模式。</p><blockquote class="my mz na"><p id="4c1c" class="kw kx mx ky b kz la jr lb lc ld ju le nb lg lh li nc lk ll lm nd lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/prisma-labs/graphql-middleware#overview" rel="noopener ugc nofollow" target="_blank"> GraphQL中间件</a>是一个模式包装器，它允许你跨多个解析器有效地管理额外的功能。它们被应用于请求路径的向内指向的同心环和响应路径的向外指向的同心环。</p></blockquote><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="1bd7" class="lz ma iq nf b gy nj nk l nl nm">const schema = applyMiddleware(originalSchema, logMiddleware, tracingMiddleware)</span></pre><p id="f9bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于具有如上配置的日志和跟踪中间件的GraphQL服务器模式，解析器流程如图1所示</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/b5b7fd8829ba8376d1fbfd0ac3ba07a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*OOBCgKEEGwodnHbTvGwbMg.jpeg"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">1. Middlewares applied to a GraphQL resolver</figcaption></figure><h2 id="1eb2" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">日志中间件</h2><p id="5ed0" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">应用程序最广泛使用的横切关注点是它的工具。我们将看到如何使用<code class="fe no np nq nf b">graphql-pino-middleware</code>从graphql服务器中提取日志问题，并在Graphql解析器<code class="fe no np nq nf b">context</code>上公开一个<code class="fe no np nq nf b">pino</code>日志记录器，并避免与在应用程序的每一层配置日志记录器相关的样板文件</p><div class="nr ns gp gr nt nu"><a href="https://github.com/addityasingh/graphql-pino-middleware" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">附加软件/图形输入中间件</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">GraphQL中间件，用于使用pino记录器检测解析器。该中间件旨在消除横切关注点…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi kp nu"/></div></div></a></div><p id="ba98" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先安装<code class="fe no np nq nf b">graphql-pino-middleware</code>和<code class="fe no np nq nf b">graphql-middleware</code>包并导入，实例化<code class="fe no np nq nf b">pino</code>中间件</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="1cdb" class="lz ma iq nf b gy nj nk l nl nm">yarn add graphql-pino-middleware graphql-middleware</span><span id="1d97" class="lz ma iq nf b gy oj nk l nl nm">// server.ts<br/>import graphqlPinoMiddleware from "graphql-pino-middleware";<br/>import { applyMiddleware } from "graphql-middleware";</span><span id="2507" class="lz ma iq nf b gy oj nk l nl nm">const pinoMiddleware = graphqlPinoMiddleware();</span></pre><p id="34f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe no np nq nf b">typedefs</code>和<code class="fe no np nq nf b">resolvers</code>创建模式，并应用<code class="fe no np nq nf b">graphql-pino-middleware</code>创建支持登录解析器上下文的模式</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="8211" class="lz ma iq nf b gy nj nk l nl nm">import { makeExecutableSchema } from "graphql-tools";</span><span id="b433" class="lz ma iq nf b gy oj nk l nl nm">// Construct a schema, using GraphQL schema language<br/>const typeDefs = `<br/>  type Query {<br/>    hello(name: String): String<br/>  }<br/>`;</span><span id="adde" class="lz ma iq nf b gy oj nk l nl nm">const resolvers = {<br/>  Query: {<br/>    hello: (parent, args, context) =&gt; {<br/>      return `Hello ${args.name ? args.name : "world"}!`;<br/>    }<br/>  }<br/>};</span><span id="2530" class="lz ma iq nf b gy oj nk l nl nm">const schema = makeExecutableSchema({ typeDefs, resolvers });</span><span id="29cd" class="lz ma iq nf b gy oj nk l nl nm">// apply the middleware to the schema<br/>const schemaWithLogger = applyMiddleware(<br/>  schema,<br/>  pinoMiddleware<br/>);</span><span id="d2a6" class="lz ma iq nf b gy oj nk l nl nm">// Use the schema in your graphql server<br/>const app = express();<br/>app.use("/graphql", graphqlExpressHttp({<br/>    schema: schema,<br/>    rootValue: resolvers,<br/>    graphiql: true<br/>  })<br/>);</span><span id="e4e8" class="lz ma iq nf b gy oj nk l nl nm">app.listen(4001, () =&gt; {<br/>  console.log('Graphql server running at port 4001')<br/>})</span></pre><p id="498c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这个设置，现在<code class="fe no np nq nf b">logger</code>出现在解算器的<code class="fe no np nq nf b">context</code>上，可以用于记录。我们将更新<code class="fe no np nq nf b">Query.name</code>字段的解析器，如下所示，以记录结果</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="26a0" class="lz ma iq nf b gy nj nk l nl nm">const resolvers = {<br/>  Query: {<br/>    hello: (parent, args, context) =&gt; {<br/>      const result = `Hello ${args.name ? args.name : "world"}!`;<br/>      context.logger.info("Result for field hello is "+ result);<br/>      return result;<br/>    }<br/>  }<br/>};</span></pre><p id="b75e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种中间件的设置现在允许我们从解析器、模型和连接器使用GraphQL服务器应用程序的每一层上的记录器。这避免了在应用程序的每一层初始化日志记录器的需要，从而产生模块化的应用程序特定代码，并控制维护成本。</p><p id="dbc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与<code class="fe no np nq nf b">graphql-pino-middleware</code>类似，您也可以使用<code class="fe no np nq nf b">graphql-lightstep-middleware</code>通过<code class="fe no np nq nf b">lightstep</code>跟踪为您的解析器提供工具，以便打开跟踪</p><div class="nr ns gp gr nt nu"><a href="https://github.com/addityasingh/graphql-lightstep-middleware" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">addit as Singh/graph QL-light step-中间件</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">GraphQL中间件使用open tracing traces for light step collector来检测解析器</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="ok l of og oh od oi kp nu"/></div></div></a></div><h2 id="9a36" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">参考</h2><ol class=""><li id="30f0" class="ol om iq ky b kz ms lc mt lf on lj oo ln op lr oq or os ot bi translated"><a class="ae kv" href="https://github.com/prisma-labs/graphql-middleware" rel="noopener ugc nofollow" target="_blank"> Prisma GraphQL中间件</a></li><li id="4685" class="ol om iq ky b kz ou lc ov lf ow lj ox ln oy lr oq or os ot bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Cross-cutting_concern" rel="noopener ugc nofollow" target="_blank">软件横切关注点</a></li></ol></div></div>    
</body>
</html>