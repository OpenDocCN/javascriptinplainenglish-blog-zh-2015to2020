<html>
<head>
<title>Stream XML file to PostgreSQL with NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NodeJS将XML文件流式传输到PostgreSQL</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/stream-xml-file-to-postgresql-with-nodejs-564f18ec7840?source=collection_archive---------5-----------------------#2020-07-11">https://javascript.plainenglish.io/stream-xml-file-to-postgresql-with-nodejs-564f18ec7840?source=collection_archive---------5-----------------------#2020-07-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/97ca24fe3f72648cbfd750199e8dd717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UiQ34MI65sQtJF_4"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jonflobrant?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jon Flobrant</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="cd94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我职业生涯的大部分时间都是一名Java开发人员，但是最近我对Node JS的所有强大功能越来越感兴趣。正因为如此，我决定用Node JS + Typescript来实现我最近在工作中不得不处理的一个问题的解决方案。</p><p id="ba91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">问题是从远程XML文件中提取数据，解析信息，并将其插入Postgres。表格的结构与此类似:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="69f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">XML文件包含欧元外汇参考汇率，这些汇率是公开的，任何人都可以从欧洲中央银行的网站上下载。XML文件的结构如下:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="8355" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以看到，标签<strong class="kf ir"><em class="lh">“gesmes:Envelope&gt;Cube&gt;Cube】</em></strong>包含特定一天的汇率信息。从1999年1月4日到今天，每天的信息都会重复这个标签。</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h1 id="7f6d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">流解决方案</h1><p id="5d4e" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">解决这个问题的一个可靠方法是使用流。将使用以下软件包:</p><ul class=""><li id="281f" class="ms mt iq kf b kg kh kk kl ko mu ks mv kw mw la mx my mz na bi translated"><strong class="kf ir"> <em class="lh"> https </em> </strong>:从远程服务器流式传输XML文件。</li><li id="276b" class="ms mt iq kf b kg nb kk nc ko nd ks ne kw nf la mx my mz na bi translated"><strong class="kf ir"> <em class="lh"> xml-stream </em> </strong>:解析xml数据流。</li><li id="eaf1" class="ms mt iq kf b kg nb kk nc ko nd ks ne kw nf la mx my mz na bi translated"><strong class="kf ir"> <em class="lh"> pg </em> </strong>:连接Postgres数据库。</li><li id="ad25" class="ms mt iq kf b kg nb kk nc ko nd ks ne kw nf la mx my mz na bi translated"><strong class="kf ir"><em class="lh">pg-copy-streams</em></strong>:将解析后的数据流式传输到Postgres。</li></ul><p id="5a02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一步是配置到Postgres的连接:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="b1f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">批量插入Postgres的一个有效方法是使用<strong class="kf ir"> <em class="lh"> COPY </em> </strong>命令。这个想法是将解析后的XML数据流式传输到<strong class="kf ir"> <em class="lh"> COPY </em> </strong>命令。这可以通过包<strong class="kf ir"><em class="lh">pg-copy-stream</em></strong>实现，如下所示:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="4443" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在最后一段代码中，常量<strong class="kf ir"> <em class="lh">数据流</em> </strong>包含一个将使用<strong class="kf ir"> <em class="lh"> COPY </em> </strong>命令将数据加载到Postgres中的流。在这种情况下，<strong class="kf ir"> <em class="lh">复制</em> </strong>命令期望CSV格式的数据，因此，包<strong class="kf ir"> <em class="lh"> xml-stream </em> </strong>将用于将xml文件中的信息转换为可以插入到表中的CSV格式。此外，需要包<strong class="kf ir"> <em class="lh"> https </em> </strong>向远程服务器发出HTTP请求:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="59ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本质上，XML流被配置为接收传入的HTTP响应，并基于两个事件<strong class="kf ir"> <em class="lh"> updateElement </em> </strong>和<strong class="kf ir"> <em class="lh"> end </em> </strong>来处理数据。每当一个标签<strong class="kf ir"><em class="lh">" gesmes:Envelope&gt;Cube&gt;Cube "</em></strong>通过XML流时，就会发出一个<strong class="kf ir"><em class="lh">update element</em></strong>事件，该事件将用于将数据转换为CSV格式，并将该数据发送到数据库流。<strong class="kf ir"> <em class="lh"> end </em> </strong>事件用于向数据库流指示，不再有数据需要处理。</p><h2 id="b1f7" class="ng lq iq bd lr nh ni dn lv nj nk dp lz ko nl nm md ks nn no mh kw np nq ml nr bi translated">完全码</h2><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><h2 id="95b1" class="ng lq iq bd lr nh ni dn lv nj nk dp lz ko nl nm md ks nn no mh kw np nq ml nr bi translated">执行时间</h2><p id="a197" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">显然，执行时间会受到到文件服务器和数据库的连接时间的影响。但至少在我的本地机器上，我能够流式传输一个6 MB的文件，转换它的数据，并在7秒内插入近173K行。</p></div></div>    
</body>
</html>