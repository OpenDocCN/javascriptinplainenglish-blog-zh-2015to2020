<html>
<head>
<title>Restify — Versioned Routes and Upgrade Requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Restify版本化的路由和升级请求</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/restify-versioned-routes-and-upgrade-requests-458865add47?source=collection_archive---------16-----------------------#2020-11-29">https://javascript.plainenglish.io/restify-versioned-routes-and-upgrade-requests-458865add47?source=collection_archive---------16-----------------------#2020-11-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/cd599108a99de9709c9ae150276168f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ocb9NjUqyYtKAXkC"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@anynieel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Angelina Kichukova</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3a0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Restify是一个简单的节点后端框架。</p><p id="dd41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用Restify添加路由。</p><h1 id="171e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">版本化路由</h1><p id="79ea" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Restify路由可以进行版本控制。</p><p id="38f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">版本号应该遵循语义版本控制。</p><p id="c5b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8528" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');</span><span id="108f" class="mn lc iq mj b gy ms mp l mq mr">var server = restify.createServer();</span><span id="80ef" class="mn lc iq mj b gy ms mp l mq mr">function sendV1(req, res, next) {<br/>  res.send(`hello: ${req.params.name}`);<br/>  return next();<br/>}</span><span id="944d" class="mn lc iq mj b gy ms mp l mq mr">function sendV2(req, res, next) {<br/>  res.send({ hello: req.params.name });<br/>  return next();<br/>}</span><span id="c9ad" class="mn lc iq mj b gy ms mp l mq mr">server.get('/hello/:name', restify.plugins.conditionalHandler([<br/>  { version: '1.1.3', handler: sendV1 },<br/>  { version: '2.0.0', handler: sendV2 }<br/>]));</span><span id="f6e1" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="adfb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">拥有不同版本的路由。</p><p id="4018" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以用版本号作为值的<code class="fe mt mu mv mj b">accept-version</code>头进行请求。</p><p id="910d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果没有提供这个头，那么最新版本的处理程序将运行。</p><p id="1eab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我们运行:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9235" class="mn lc iq mj b gy mo mp l mq mr">curl -s localhost:8080/hello/foo</span></pre><p id="c97f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d517" class="mn lc iq mj b gy mo mp l mq mr">{<br/>    "hello": "foo"<br/>}</span></pre><p id="6f73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们逃跑:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b2c0" class="mn lc iq mj b gy mo mp l mq mr">curl -s -H 'accept-version: ~1' localhost:8080/hello/foo</span></pre><p id="f0a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1b53" class="mn lc iq mj b gy mo mp l mq mr">"hello: foo"</span></pre><p id="ac7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们逃跑:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ed31" class="mn lc iq mj b gy mo mp l mq mr">curl -s -H 'accept-version: ~2' localhost:8080/hello/foo</span></pre><p id="fcb1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4f31" class="mn lc iq mj b gy mo mp l mq mr">{<br/>    "hello": "foo"<br/>}</span></pre><p id="7f51" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们的标题中有无效的版本号，比如:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d1fe" class="mn lc iq mj b gy mo mp l mq mr">curl -s -H 'accept-version: ~3' localhost:8080/hello/foo</span></pre><p id="bc55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6a27" class="mn lc iq mj b gy mo mp l mq mr">{<br/>    "code": "InvalidVersion",<br/>    "message": "~3 is not supported by GET /hello/foo"<br/>}</span></pre><p id="089e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过传入一个数组，我们可以对多个版本使用相同的路由处理程序:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d84e" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');</span><span id="578e" class="mn lc iq mj b gy ms mp l mq mr">var server = restify.createServer();</span><span id="5b4d" class="mn lc iq mj b gy ms mp l mq mr">function sendV1(req, res, next) {<br/>  res.send(`hello: ${req.params.name}`);<br/>  return next();<br/>}</span><span id="66df" class="mn lc iq mj b gy ms mp l mq mr">function sendV2(req, res, next) {<br/>  res.send({ hello: req.params.name });<br/>  return next();<br/>}</span><span id="6896" class="mn lc iq mj b gy ms mp l mq mr">server.get('/hello/:name', restify.plugins.conditionalHandler([<br/>  { version: '1.1.3', handler: sendV1 },<br/>  { version: ['2.0.0', '2.1.0', '2.2.0'], handler: sendV2 }<br/>]));</span><span id="2abf" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="372c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我们也可以通过<code class="fe mt mu mv mj b">req.version</code>方法得到最初请求的版本。</p><p id="689e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以得到Restify与<code class="fe mt mu mv mj b">matchedVersion</code>方法相匹配的版本。</p><p id="8e4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9cbc" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');</span><span id="1815" class="mn lc iq mj b gy ms mp l mq mr">var server = restify.createServer();</span><span id="f0ca" class="mn lc iq mj b gy ms mp l mq mr">server.get('/hello/:name', restify.plugins.conditionalHandler([<br/> {<br/>    version: ['2.0.0', '2.1.0', '2.2.0'],<br/>    handler: function (req, res, next) {<br/>      res.send(200, {<br/>        requestedVersion: req.version(),<br/>        matchedVersion: req.matchedVersion()<br/>      });<br/>      return next();<br/>    }<br/>  }<br/>]));</span><span id="01f9" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="68b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们跑了:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4c0e" class="mn lc iq mj b gy mo mp l mq mr">curl -s -H 'accept-version: ~2' localhost:8080/hello/foo</span></pre><p id="dbda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8a55" class="mn lc iq mj b gy mo mp l mq mr">{<br/>    "requestedVersion": "~2",<br/>    "matchedVersion": "2.2.0"<br/>}</span></pre><h1 id="286c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">升级请求</h1><p id="b093" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果传入的HTTP请求有<code class="fe mt mu mv mj b">Connection: Upgrade</code>头，那么节点服务器会以不同的方式处理它。</p><p id="8de7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，它不会被推送到Restify。</p><p id="659b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过<code class="fe mt mu mv mj b">handleUpgrades</code>方案实现这一目标。</p><p id="3c0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="63a4" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var Watershed = require('Watershed');</span><span id="7d98" class="mn lc iq mj b gy ms mp l mq mr">var server = restify.createServer();</span><span id="9867" class="mn lc iq mj b gy ms mp l mq mr">var ws = new Watershed();<br/>server.get('/websocket/attach', function(req, res, next) {<br/>  if (!res.claimUpgrade) {<br/>    next(new Error('Connection Must Upgrade For WebSockets'));<br/>    return;<br/>  }</span><span id="b343" class="mn lc iq mj b gy ms mp l mq mr">var upgrade = res.claimUpgrade();<br/>  var shed = ws.accept(req, upgrade.socket, upgrade.head);<br/>  shed.on('text', function(msg) {<br/>    console.log('Received message from websocket client: ' + msg);<br/>  });<br/>  shed.send('hello there!');</span><span id="a572" class="mn lc iq mj b gy ms mp l mq mr">  next(false);<br/>});</span><span id="9c8f" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="801d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建<code class="fe mt mu mv mj b">Watershed</code>实例来监听网络套接字连接。</p><h1 id="bb36" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="3cbe" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Restify版本化我们的路线。</p><p id="9a64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以使用<code class="fe mt mu mv mj b">Watershed</code>来处理网站请求。</p><p id="20d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果是这样的话，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获得更多类似的内容吧！</strong></p></div></div>    
</body>
</html>