<html>
<head>
<title>WeakMaps: Illustrated</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WeakMaps:插图</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/weakmaps-illustrated-8169ce4764bb?source=collection_archive---------1-----------------------#2020-08-03">https://javascript.plainenglish.io/weakmaps-illustrated-8169ce4764bb?source=collection_archive---------1-----------------------#2020-08-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="191b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ki kj kk kl b">WeakMap</code>是ES6推出的系列之一。你应该麻烦或者只是在所有事情上使用<code class="fe ki kj kk kl b">Map</code>？</p><p id="235e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">简短的回答是，您可能应该这样做，因为<code class="fe ki kj kk kl b">WeakMap</code>提供了一种方便的方法来扩展一个对象，而不需要修改它或者干扰垃圾收集。</p><p id="3fb7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">垃圾收集什么？这有什么关系？在本帖中，我们将讨论<code class="fe ki kj kk kl b">WeakMap</code>，它的用例，以及Google Polymer项目的一个真实用例。</p><p id="6ccc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">到这篇文章结束时，你应该明白:</p><ol class=""><li id="b329" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">WeakMap</code>的重要性质</li><li id="0c77" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">与<code class="fe ki kj kk kl b">Map</code>的区别</li><li id="a91d" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">何时使用<code class="fe ki kj kk kl b">WeakMap</code></li></ol><h1 id="05e3" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">地图对地图</h1><p id="be62" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><strong class="jm io">一个</strong> <code class="fe ki kj kk kl b"><strong class="jm io">WeakMap</strong></code> <strong class="jm io">只是一个</strong> <code class="fe ki kj kk kl b"><strong class="jm io">Map</strong></code> <strong class="jm io">，有3个重要区别:</strong></p><ol class=""><li id="5cb4" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">键必须是对象</li><li id="7df5" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">键被弱引用</li><li id="c84e" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">WeakMap</code>是一个黑盒，没有办法检索出密钥或者<code class="fe ki kj kk kl b">WeakMap</code>的大小</li></ol><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/c73896b94521411905c54f403b1140cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*hX_LBQfUAZdjp35fyOEqUw.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">A WeakMap is a black-box, we cannot access its values without the keys</figcaption></figure><p id="f3ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们不能循环访问<code class="fe ki kj kk kl b">WeakMap</code>键和对象，我们只能在有键的情况下使用<code class="fe ki kj kk kl b">get(key)</code>方法访问它的值。这对于管理对象中的私有数据非常有用。</p><p id="262b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">这些是</strong> <code class="fe ki kj kk kl b"><strong class="jm io">WeakMap</strong></code> <strong class="jm io">方法:</strong></p><ol class=""><li id="b5ac" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">get(key)</code></li><li id="79fe" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">set(key, value)</code></li><li id="f8ab" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">delete(key)</code></li><li id="a808" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">has(key)</code></li></ol><p id="7e8b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这么多限制，为什么不直接用<code class="fe ki kj kk kl b">Map</code>？问题是，在<code class="fe ki kj kk kl b">Map</code>上存储一个对象可能会阻止对象的垃圾收集并导致内存泄漏。<code class="fe ki kj kk kl b">WeakMap</code>防止仅使用<em class="mp">弱</em>参考。</p><p id="cee6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们看一些具体的用例，这会给我们更多的线索。</p><h1 id="8c2c" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">用例</h1><p id="d62d" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><code class="fe ki kj kk kl b">WeakMap</code>最常见的用例是在一个对象上存储额外的数据。</p><h2 id="69e7" class="mq lb in bd lc mr ms dn lg mt mu dp lk jv mv mw lo jz mx my ls kd mz na lw nb bi translated">假设我们在DOM上有一堆按钮，我们想记录每个按钮被用户按了多少次。</h2><p id="79f8" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><strong class="jm io">使用一个</strong> <code class="fe ki kj kk kl b"><strong class="jm io">Map</strong></code></p><p id="251f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以将按钮对象作为一个键存储在一个<code class="fe ki kj kk kl b">Map</code>中，并跟踪次数作为它的值。但是，一旦我们不再需要按钮对象，这将导致内存泄漏，也许过一会儿，我们将从DOM或其他地方删除按钮。</p><p id="1eea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在代码中，它看起来像这样:</p><ol class=""><li id="12da" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">我们在<code class="fe ki kj kk kl b">btn1</code>中获得了对按钮对象的引用</li><li id="1b9b" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">我们初始化<code class="fe ki kj kk kl b">Map</code>并将点击计数存储为<code class="fe ki kj kk kl b">0</code></li><li id="f10f" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">每点击一次，我们就增加<code class="fe ki kj kk kl b">Map</code>中的点击计数</li></ol><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f1a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们画一些图来更好地理解这里发生的事情。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/a7ca7e8b45dc626fe127c01db3c18b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rW1HuM8F4D7FRd4TtsHE-w.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">The references to the button object</figcaption></figure><p id="4e6d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将有一个引用按钮对象的<code class="fe ki kj kk kl b">btn1</code>变量。这个引用可以用来监听它的点击事件。我们还有我们的<code class="fe ki kj kk kl b">Map</code>,它维护了对<code class="fe ki kj kk kl b">btn1</code>的引用作为它的键。</p><p id="fd27" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">过了一段时间，我们不再需要这个按钮，也不再维护对它的引用。</strong>垃圾收集器现在可以收集这个对象，为其他按钮释放更多宝贵的空间。但是看看我们得到了什么，一个<em class="mp">内存泄漏</em>！垃圾收集器无法释放对象，因为我们的<code class="fe ki kj kk kl b">Map</code>仍然维护着对按钮的引用。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/86425ec7ef13aeaafacb566804562e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*Cbi8aRtCvn0LHBCYJUf1Ag.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Our btn1 no longer references our button object, but the Map still references it!</figcaption></figure><blockquote class="nk nl nm"><p id="aeb6" class="jk jl mp jm b jn jo jp jq jr js jt ju nn jw jx jy no ka kb kc np ke kf kg kh ig bi translated">你们中的一些人可能想知道为什么我们不在重新分配我们的<code class="fe ki kj kk kl b">btn1</code>之前清除这个键。这听起来很简单，但必须记住手动管理引用可能容易出错，并引入一些精神开销！更好的选择是使用<code class="fe ki kj kk kl b">WeakMap</code>。</p></blockquote><h1 id="6f7a" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">WeakMap前来救援</h1><p id="b6cb" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><code class="fe ki kj kk kl b">WeakMap</code>通过维护对对象的“弱”引用来防止内存泄漏问题。这使我们能够存储点击计数，而无需修改按钮对象或导致垃圾收集问题。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/66c41d1d7252bbec4aad2efcf7e894f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*X6LayVq5izl3qmu9rYYmUg.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Garbage collector collects the button object because there is no strong references</figcaption></figure><p id="b385" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在代码中，这将类似于:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="6381" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们只改变第二行初始化<code class="fe ki kj kk kl b">WeakMap</code>而不是<code class="fe ki kj kk kl b">Map</code>，简单！</p><h1 id="79e3" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">外卖</h1><p id="3adc" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><strong class="jm io"> A </strong> <code class="fe ki kj kk kl b"><strong class="jm io">WeakMap</strong></code> <strong class="jm io">简单地允许我们<em class="mp">存储与某个对象相关的额外数据</em>，而无需修改它或担心内存管理！</strong></p><p id="1bb1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这种需要存储额外数据的场景经常出现，例如:</p><p id="525d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">缓存中:</strong></p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="281b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的函数计算了<code class="fe ki kj kk kl b">basket</code>数组中所有商品的总价。记住<em class="mp">数组也是对象</em>，所以它可以作为键存储在<code class="fe ki kj kk kl b">WeakMap</code>中！</p><p id="fb08" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">跟踪DOM变化:</strong></p><p id="d806" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还可以存储DOM节点的附加信息，而无需修改它们。事实上，<a class="ae nq" href="https://github.com/Polymer" rel="noopener ugc nofollow" target="_blank"> Google Polymer项目</a>使用<code class="fe ki kj kk kl b">WeakMap</code> s来跟踪DOM节点的编辑、删除和更改！</p><p id="0998" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">存储类的私有数据:</strong></p><p id="1881" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于<code class="fe ki kj kk kl b">WeakMap</code>也是黑盒，我们也可以用它来存储类和对象的私有数据。但是这是一个不太常见的用例，在JavaScript 中还有许多其他管理私有数据的方法。</p><p id="280e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">这里的经验法则是，每当你需要跟踪一个对象的额外数据或行为时，但是:</strong></p><ol class=""><li id="0d1c" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">您不想修改或附加对象的附加属性</li><li id="f75b" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">你不想担心内存管理</li></ol><p id="d5d6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">就用<code class="fe ki kj kk kl b">WeakMap</code>！</p><p id="2e12" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你想了解更多关于<code class="fe ki kj kk kl b">WeakMap</code>和<code class="fe ki kj kk kl b">WeakSet</code>的信息，看看这些有用的文章:</p><ol class=""><li id="015b" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated"><a class="ae nq" href="https://javascript.info/weakmap-weakset" rel="noopener ugc nofollow" target="_blank"> JavaScript信息:WeakMap和WeakSet </a></li><li id="e28b" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><a class="ae nq" href="https://2ality.com/2016/01/private-data-classes.html" rel="noopener ugc nofollow" target="_blank">管理类中的私有数据</a></li><li id="d6f2" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><a class="ae nq" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap" rel="noopener ugc nofollow" target="_blank"> MDN文档:WeakMap </a></li></ol></div><div class="ab cl nr ns hr nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ig ih ii ij ik"><p id="b887" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望这有助于你下次需要扩展一个对象。感谢阅读！</p><h2 id="637c" class="mq lb in bd lc mr ms dn lg mt mu dp lk jv mv mw lo jz mx my ls kd mz na lw nb bi translated"><strong class="ak">简明英语JavaScript</strong></h2><p id="884c" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">喜欢这篇文章吗？如果有，通过<a class="ae nq" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="jm io">！</strong></p></div></div>    
</body>
</html>