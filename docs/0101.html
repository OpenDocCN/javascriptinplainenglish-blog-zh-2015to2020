<html>
<head>
<title>Writing a Jest Test Reporter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">写一个笑话测试记者</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/writing-a-jest-test-reporter-cb7c123ec211?source=collection_archive---------0-----------------------#2019-03-16">https://javascript.plainenglish.io/writing-a-jest-test-reporter-cb7c123ec211?source=collection_archive---------0-----------------------#2019-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="99ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近在工作中，我一直在构建一种方法，通过泽法将我们端到端测试的试运行数据上传到<a class="ae kl" href="https://marketplace.atlassian.com/apps/1014681/zephyr-for-jira-test-management?hosting=cloud&amp;tab=overview" rel="noopener ugc nofollow" target="_blank">吉拉。</a></p><p id="3a0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常集成测试运行结果的方法是将它们导出为JUnit兼容的文档，并将它们上传到支持该格式的工具中。</p><p id="3585" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">泽法有一个API，其他团队中的一个已经建立了一个与之交互的库，所以我决定利用它在测试运行结束时上传结果。</p><p id="1e38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像这样使用泽法的好处之一是，我可以获得环境变量，并将其作为测试运行元数据的一部分，以帮助跟踪每个环境中的每个测试运行。</p><h1 id="963c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么是测试记者？</h1><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/227500d7146d5016f2ab5e6dda6b98ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7XSJ9qMZ0QOUZwr5"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">Photo by <a class="ae kl" href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">rawpixel</a> on <a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e125" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试报告程序是测试运行程序的挂钩，它允许在测试运行的开始和结束时执行代码。</p><p id="6ebc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多测试记者可以开玩笑；处理不同数据格式、与不同系统集成或者只是帮助通知的那些。</p><p id="c973" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用一个测试报告器，你首先通过<code class="fe ma mb mc md b">npm install</code>安装这个包，然后在你的<code class="fe ma mb mc md b">jest.config.js</code>中把它的名字添加到<code class="fe ma mb mc md b">reports</code>数组中。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="me mf l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">Example jest.config.js to include a customer reporter (in this case it upserts test run data to Couchbase)</figcaption></figure><h1 id="e784" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">测试记者可以进入的阶段</h1><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mg"><img src="../Images/819dcfd28579a68e00acbf4a90ab934e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B77HZCtLT8Htxl2b"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">Photo by <a class="ae kl" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">chuttersnap</a> on <a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0c25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试记者参与了两个事件:</p><p id="d8ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ma mb mc md b">onRunStart</code>这个阶段是在测试运行开始之前，但是测试套件的数量(<code class="fe ma mb mc md b">describe</code>块)已经被计算出来，所以如果你愿意，你可以使用这个值为结果创建占位符。</p><p id="9e9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ma mb mc md b">onTestResult</code>该阶段在测试套件结束时启动，可用于处理测试套件的结果以及更新测试运行本身的进度。</p><p id="1305" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想在测试运行时可视化测试进度，这将是最好的选择。</p><p id="1a0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ma mb mc md b">onRunComplete</code>此阶段随后启动，可用于处理所有测试运行后的测试结果(或在测试运行因错误而中止的情况下)。</p><p id="9bfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想批量上传所有测试的结果，这将是最好的选择。</p><h1 id="3d4b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">各阶段提供的数据</h1><p id="5044" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我没有找到太多关于传递到每个阶段的数据的文档，所以我决定在https://gitlab.com/colinfwren/containerised-jest运行测试，并收集每个阶段传递的参数。</p><p id="a6b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该过程的输出将是一个JavaScript对象，每个位置参数都由它在函数签名中的索引来表示。为该参数传递的数据是该键的值。</p><p id="3450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经创建了一个<a class="ae kl" href="https://gitlab.com/colinfwren/jest-reporter-debug" rel="noopener ugc nofollow" target="_blank">自定义Jest reporter来帮助记录作为测试运行生命周期</a>的一部分接收到的数据。这包括一个包含数据结构的JSDoc。</p><h2 id="d54d" class="mm kn iq bd ko mn mo dn ks mp mq dp kw jy mr ms la kc mt mu le kg mv mw li mx bi translated">onRunStart</h2><p id="e590" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">由于在此阶段没有传递太多数据，因此通常会看到第一个参数被解构以收集<code class="fe ma mb mc md b">numTotalTestSuites</code>值，例如:</p><pre class="ll lm ln lo gt my md mz na aw nb bi"><span id="693a" class="mm kn iq md b gy nc nd l ne nf">onRunStart({ numTotalTestSuites }) {<br/>    // do some stuff<br/>}</span></pre><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="me mf l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">The arguments onRunStart is called with</figcaption></figure><h2 id="affe" class="mm kn iq bd ko mn mo dn ks mp mq dp kw jy mr ms la kc mt mu le kg mv mw li mx bi translated">onTestResult</h2><p id="6f0e" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">传递的第一个参数提供了正在执行的测试的上下文，例如测试运行程序的配置和它作为其一部分运行的包。</p><p id="e3c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传递的第二个参数提供了关于测试套件和执行的测试的信息，例如:</p><ul class=""><li id="f5df" class="ng nh iq jp b jq jr ju jv jy ni kc nj kg nk kk nl nm nn no bi translated">测试套件中通过了多少测试</li><li id="6d8a" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试套件中有多少测试失败</li><li id="8659" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试套件中所有测试花费的时间</li><li id="90e1" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试套件的文件路径</li><li id="20b7" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试运行的快照更改</li><li id="fd3e" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试的名称</li><li id="02aa" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试持续时间</li><li id="1962" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试的祖先(对嵌套的描述块有用)</li><li id="8e26" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试失败时的失败消息(用于将堆栈跟踪作为失败测试的注释)</li></ul><p id="5d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传递的第三个参数提供了在该时间点的完整测试运行的信息，比如到目前为止运行的测试总数、通过/失败的测试总数以及通过/失败的测试套件。该对象还包含作为第二个参数传递的测试套件数据。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="me mf l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">Arguments passed to onTestResult</figcaption></figure><h2 id="a643" class="mm kn iq bd ko mn mo dn ks mp mq dp kw jy mr ms la kc mt mu le kg mv mw li mx bi translated">未完成时</h2><p id="2c68" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">第一个参数似乎不包含任何信息，但我相信它包含了关于最后一次测试运行的信息。</p><p id="a04a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个参数包含测试运行的结果，例如:</p><ul class=""><li id="202f" class="ng nh iq jp b jq jr ju jv jy ni kc nj kg nk kk nl nm nn no bi translated">运行测试套件和测试用例的总数</li><li id="fa30" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">通过/失败的测试套件总数</li><li id="b29b" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">通过/失败测试的总数</li><li id="3c4d" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">测试运行的快照信息</li><li id="59f7" class="ng nh iq jp b jq np ju nq jy nr kc ns kg nt kk nl nm nn no bi translated">每个测试套件的测试结果信息，包含测试套件中每个测试的测试结果信息</li></ul><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="me mf l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk">Arguments passed to onRunComplete</figcaption></figure><h1 id="4876" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">更多资源</h1><p id="dee4" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我发现Jest repo上的以下帖子有助于弄清楚测试记者可以使用什么钩子:<a class="ae kl" href="https://github.com/facebook/jest/issues/4471" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/jest/issues/4471</a></p><p id="176f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在npm 或者<a class="ae kl" href="https://github.com/search?utf8=%E2%9C%93&amp;q=jest-reporter&amp;type=" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到很多不同的<a class="ae kl" href="https://www.npmjs.com/search?q=jest-reporter" rel="noopener ugc nofollow" target="_blank"> jest记者。</a></p><p id="eb16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还用jsdoc为定制报告器创建了一个示例项目，它记录传递给每个钩子的参数，以帮助记录定制报告器可以处理的数据。</p></div></div>    
</body>
</html>