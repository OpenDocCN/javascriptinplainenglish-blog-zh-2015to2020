<html>
<head>
<title>How to Add Authenticated Routes to Your React App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何向React应用程序添加经过认证的路线</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-add-authenticated-routes-to-your-react-app-f496ff266533?source=collection_archive---------5-----------------------#2019-11-10">https://javascript.plainenglish.io/how-to-add-authenticated-routes-to-your-react-app-f496ff266533?source=collection_archive---------5-----------------------#2019-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5036" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用高阶元件很容易制作认证的反应路线。高阶组件是以组件为道具并返回渲染一个新组件的组件。</p><p id="6e6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，要创建经过身份验证的路由，我们可以编写:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="4425" class="ku kv iq kq b gy kw kx l ky kz">import React from "react";<br/>import { Redirect } from "react-router-dom";</span><span id="1764" class="ku kv iq kq b gy la kx l ky kz">function RequireAuth({ Component }) {<br/>  if (!localStorage.getItem("token")) {<br/>    return &lt;Redirect to="/" /&gt;;<br/>  }<br/>  return &lt;Component /&gt;;<br/>}</span><span id="436a" class="ku kv iq kq b gy la kx l ky kz">export default RequireAuth;</span></pre><p id="7b8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lb lc ld kq b">RequireAuth</code>是带<code class="fe lb lc ld kq b">Component</code>道具的组件。<code class="fe lb lc ld kq b">Component</code>是一个道具，是一个反应组件。我们检查本地存储中是否存在认证令牌，如果存在，那么我们呈现需要认证的路由<code class="fe lb lc ld kq b">Component</code>。否则，我们将重定向到不需要身份验证的路由。</p><p id="acf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将制作一个简单的Bitbucket应用程序，它具有经过身份验证的React路由。我们将让用户注册一个帐户，并为他们的帐户设置他们的位桶用户名和密码。一旦用户登录并设置了他们的位存储桶凭证，他们就可以查看他们的存储库和每个存储库的提交。</p><p id="163f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Bitbucket是一个很棒的存储库托管服务，可以让你免费托管Git存储库。您可以升级到他们的付费计划，以低价获得更多功能。它还有一个全面的自动化和获取数据的API。</p><p id="5f2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开发者为Bitbucket的API做了Node.js客户端。我们可以很容易地使用它来做我们想做的事情，如操纵提交、添加、删除或编辑存储库、跟踪问题、操纵构建管道等等。</p><p id="3e16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Bitbucket.js包是用于编写Node.js Bitbucket应用程序的最简单的包之一。我们所要做的就是用我们的Bitbucket用户名和密码登录Bitbucket实例，并调用在<a class="ae le" href="https://bitbucketjs.netlify.com/#api-_" rel="noopener ugc nofollow" target="_blank">https://bitbucketjs.netlify.com/#api-_</a>中列出的内置函数来对Bitbucket包做几乎任何我们想做的事情。</p><p id="c4b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的应用程序将包括后端和前端。后端处理用户身份验证，并通过Bitbucket API与Bitbucket通信。前端有注册表单，登录表单，用于设置密码和位桶用户名和密码的设置表单。</p><p id="e3dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了开始构建应用程序，我们创建一个项目文件夹，里面有<code class="fe lb lc ld kq b">backend</code>文件夹。然后我们进入<code class="fe lb lc ld kq b">backend</code>文件夹，通过运行<code class="fe lb lc ld kq b">npx express-generator</code>来运行快速生成器。接下来我们自己安装一些包。我们需要Babel来使用<code class="fe lb lc ld kq b">import</code>，BCrypt来散列密码，Bitbucket.js来使用Bitbucket API。Crypto-JS用于加密和解密我们的位桶密码，Dotenv用于存储哈希和加密秘密，Sequelize用于ORM，JSON Web Token包用于身份验证，CORS用于跨域通信，SQLite用于数据库。</p><p id="0e91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe lb lc ld kq b">npm i @babel/cli @babel/core @babel/node @babel/preset-env bcrypt bitbucket cors crypto-js dotenv jsonwebtoken sequelize sqlite3</code>安装软件包。</p><p id="3c6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lb lc ld kq b">package.json</code>的<code class="fe lb lc ld kq b">script</code>部分，输入:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="be97" class="ku kv iq kq b gy kw kx l ky kz">"start": "nodemon --exec npm run babel-node --  ./bin/www",<br/>"babel-node": "babel-node"</span></pre><p id="ae73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Babel Node启动我们的应用程序，而不是常规的Node.js运行时，这样我们就可以获得最新的JavaScript特性。</p><p id="5841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们在<code class="fe lb lc ld kq b">backend</code>文件夹中创建一个名为<code class="fe lb lc ld kq b">.babelrc</code>的文件，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="bac0" class="ku kv iq kq b gy kw kx l ky kz">{<br/>    "presets": [<br/>        "<a class="ae le" href="http://twitter.com/babel/preset-env" rel="noopener ugc nofollow" target="_blank">@babel/preset-env</a>"<br/>    ]<br/>}</span></pre><p id="5e4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启用最新功能。</p><p id="f252" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们必须通过运行<code class="fe lb lc ld kq b">npx sequelize-cli init</code>来添加序列代码。之后，我们应该在<code class="fe lb lc ld kq b">config</code>文件夹中得到一个<code class="fe lb lc ld kq b">config.json</code>文件。</p><p id="e5e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lb lc ld kq b">config.json</code>中，我们把:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="0018" class="ku kv iq kq b gy kw kx l ky kz">{<br/>  "development": {<br/>    "dialect": "sqlite",<br/>    "storage": "development.db"<br/>  },<br/>  "test": {<br/>    "dialect": "sqlite",<br/>    "storage": "test.db"<br/>  },<br/>  "production": {<br/>    "dialect": "sqlite",<br/>    "storage": "production.db"<br/>  }<br/>}</span></pre><p id="6137" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用SQLite作为我们的数据库。</p><p id="ad86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们添加一个用于验证认证令牌的中间件，在<code class="fe lb lc ld kq b">backend</code>文件夹中添加一个<code class="fe lb lc ld kq b">middllewares</code>文件夹，并在其中添加<code class="fe lb lc ld kq b">authCheck.js</code>。在文件中，添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="c8ab" class="ku kv iq kq b gy kw kx l ky kz">const jwt = require("jsonwebtoken");<br/>const secret = process.env.JWT_SECRET;</span><span id="fb0f" class="ku kv iq kq b gy la kx l ky kz">export const authCheck = (req, res, next) =&gt; {<br/>  if (req.headers.authorization) {<br/>    const token = req.headers.authorization;<br/>    jwt.verify(token, secret, (err, decoded) =&gt; {<br/>      if (err) {<br/>        res.send(401);<br/>      } else {<br/>        next();<br/>      }<br/>    });<br/>  } else {<br/>    res.send(401);<br/>  }<br/>};</span></pre><p id="0ae3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果令牌无效，我们返回401响应。</p><p id="3f32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们创建一些迁移和模型。运行:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="ec1b" class="ku kv iq kq b gy kw kx l ky kz">npx sequelize-cli model:create --name User --attributes username:string,password:string,bitBucketUsername:string,bitBucketPassword:string</span></pre><p id="c9bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来创建模型。请注意，属性选项没有空格。</p><p id="900d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们向Users表的<code class="fe lb lc ld kq b">username</code>列添加unique约束。为此，请运行:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="6dd4" class="ku kv iq kq b gy kw kx l ky kz">npx sequelize-cli migration:create addUniqueConstraintToUser</span></pre><p id="99d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在新创建的迁移文件中，添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="124c" class="ku kv iq kq b gy kw kx l ky kz">"use strict";</span><span id="97ac" class="ku kv iq kq b gy la kx l ky kz">module.exports = {<br/>  up: (queryInterface, Sequelize) =&gt; {<br/>    return queryInterface.addConstraint("Users", ["username"], {<br/>      type: "unique",<br/>      name: "usernameUnique"<br/>    });<br/>  },</span><span id="cfb5" class="ku kv iq kq b gy la kx l ky kz">down: (queryInterface, Sequelize) =&gt; {<br/>    return queryInterface.removeConstraint("Users", "usernameUnique");<br/>  }<br/>};</span></pre><p id="5c0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe lb lc ld kq b">npx sequelize-cli db:migrate</code>运行所有迁移。</p><p id="1fad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们创建路线。创建一个名为<code class="fe lb lc ld kq b">bitbucket.js</code>的文件，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="4579" class="ku kv iq kq b gy kw kx l ky kz">var express = require("express");<br/>const models = require("../models");<br/>const CryptoJS = require("crypto-js");<br/>const Bitbucket = require("bitbucket");<br/>const jwt = require("jsonwebtoken");<br/>import { authCheck } from "../middlewares/authCheck";</span><span id="e593" class="ku kv iq kq b gy la kx l ky kz">const bitbucket = new Bitbucket();<br/>var router = express.Router();</span><span id="4189" class="ku kv iq kq b gy la kx l ky kz">router.post("/setBitbucketCredentials", authCheck, async (req, res, next) =&gt; {<br/>  const { bitBucketUsername, bitBucketPassword } = req.body;<br/>  const token = req.headers.authorization;<br/>  const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>  const id = decoded.userId;<br/>  const cipherText = CryptoJS.AES.encrypt(<br/>    bitBucketPassword,<br/>    process.env.CRYPTO_SECRET<br/>  );<br/>  await models.User.update(<br/>    {<br/>      bitBucketUsername,<br/>      bitBucketPassword: cipherText.toString()<br/>    },<br/>    {<br/>      where: { id }<br/>    }<br/>  );<br/>  res.json({});<br/>});</span><span id="9698" class="ku kv iq kq b gy la kx l ky kz">router.get("/repos/:page", authCheck, async (req, res, next) =&gt; {<br/>  const page = req.params.page || 1;<br/>  const token = req.headers.authorization;<br/>  const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>  const id = decoded.userId;<br/>  const users = await models.User.findAll({ where: { id } });<br/>  const user = users[0];<br/>  const bytes = CryptoJS.AES.decrypt(<br/>    user.bitBucketPassword.toString(),<br/>    process.env.CRYPTO_SECRET<br/>  );<br/>  const password = bytes.toString(CryptoJS.enc.Utf8);<br/>  bitbucket.authenticate({<br/>    type: "basic",<br/>    username: user.bitBucketUsername,<br/>    password<br/>  });<br/>  let { data } = await bitbucket.repositories.list({<br/>    username: user.bitBucketUsername,<br/>    page,<br/>    sort: "-updated_on"<br/>  });<br/>  res.json(data);<br/>});</span><span id="81c6" class="ku kv iq kq b gy la kx l ky kz">router.get("/commits/:repoName", authCheck, async (req, res, next) =&gt; {<br/>  const token = req.headers.authorization;<br/>  const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>  const id = decoded.userId;<br/>  const users = await models.User.findAll({ where: { id } });<br/>  const user = users[0];<br/>  const repoName = req.params.repoName;<br/>  const bytes = CryptoJS.AES.decrypt(<br/>    user.bitBucketPassword.toString(),<br/>    process.env.CRYPTO_SECRET<br/>  );<br/>  const password = bytes.toString(CryptoJS.enc.Utf8);<br/>  bitbucket.authenticate({<br/>    type: "basic",<br/>    username: user.bitBucketUsername,<br/>    password<br/>  });<br/>  let { data } = await bitbucket.commits.list({<br/>    username: user.bitBucketUsername,<br/>    repo_slug: repoName,<br/>    sort: "-date"<br/>  });<br/>  res.json(data);<br/>});</span><span id="3ec0" class="ku kv iq kq b gy la kx l ky kz">module.exports = router;</span></pre><p id="04cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在每个路由中，我们从令牌中获取用户，因为我们将把用户ID添加到令牌中，并从令牌中获取Bitbucket用户名和密码，用于登录Bitbucket API。请注意，我们必须解密密码，因为我们在将密码保存到数据库之前对其进行了加密。</p><p id="fef9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<code class="fe lb lc ld kq b">setBitbucketCredentials</code>路由中设置位桶凭证。我们在保存密码之前对其进行加密，以确保其安全。</p><p id="d54a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在<code class="fe lb lc ld kq b">repos</code>路径中，我们得到用户的repos，并按照相反的<code class="fe lb lc ld kq b">update_on</code>顺序排序，因为我们在<code class="fe lb lc ld kq b">sort</code>参数中指定了<code class="fe lb lc ld kq b">-updated_on</code>。因为我们在<code class="fe lb lc ld kq b">sort</code>参数中指定了<code class="fe lb lc ld kq b">-date</code>，所以提交是以日期倒序排列的。</p><p id="d24f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将<code class="fe lb lc ld kq b">user.js</code>添加到<code class="fe lb lc ld kq b">routes</code>文件夹中，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="de9d" class="ku kv iq kq b gy kw kx l ky kz">const express = require("express");<br/>const models = require("../models");<br/>const bcrypt = require("bcrypt");<br/>const jwt = require("jsonwebtoken");<br/>import { authCheck } from "../middlewares/authCheck";<br/>const router = express.Router();</span><span id="423a" class="ku kv iq kq b gy la kx l ky kz">router.post("/signup", async (req, res, next) =&gt; {<br/>  const { username, password } = req.body;<br/>  const hashedPassword = await bcrypt.hash(password, 10);<br/>  const user = await models.User.create({ username, password: hashedPassword });<br/>  res.json(user);<br/>});</span><span id="5b71" class="ku kv iq kq b gy la kx l ky kz">router.post("/login", async (req, res, next) =&gt; {<br/>  const { username, password } = req.body;<br/>  const users = await models.User.findAll({ where: { username } });<br/>  const user = users[0];<br/>  await bcrypt.compare(password, user.password);<br/>  const token = jwt.sign({ userId: user.id }, process.env.JWT_SECRET);<br/>  res.json({ token });<br/>});</span><span id="0a0f" class="ku kv iq kq b gy la kx l ky kz">router.post("/changePassword", authCheck, async (req, res, next) =&gt; {<br/>  const { password } = req.body;<br/>  const token = req.headers.authorization;<br/>  const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>  const id = decoded.userId;<br/>  const hashedPassword = await bcrypt.hash(password, 10);<br/>  await models.User.update({ password: hashedPassword }, { where: { id } });<br/>  res.json({});<br/>});</span><span id="ad1d" class="ku kv iq kq b gy la kx l ky kz">router.get("/currentUser", authCheck, async (req, res, next) =&gt; {<br/>  const token = req.headers.authorization;<br/>  const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>  const id = decoded.userId;<br/>  const users = await models.User.findAll({ where: { id } });<br/>  const { username, bitBucketUsername } = users[0];<br/>  res.json({ username, bitBucketUsername });<br/>});</span><span id="2e2c" class="ku kv iq kq b gy la kx l ky kz">module.exports = router;</span></pre><p id="d153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有注册、登录和更改密码的路径。当我们注册或更改密码时，我们会在保存之前对密码进行哈希运算。</p><p id="490d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lb lc ld kq b">currentUser</code>路径将用于前端的设置表单。</p><p id="d220" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lb lc ld kq b">app.js</code>中，我们将现有代码替换为:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="aa3a" class="ku kv iq kq b gy kw kx l ky kz">require("dotenv").config();<br/>var createError = require("http-errors");<br/>var express = require("express");<br/>var path = require("path");<br/>var cookieParser = require("cookie-parser");<br/>var logger = require("morgan");<br/>const cors = require("cors");</span><span id="7057" class="ku kv iq kq b gy la kx l ky kz">var indexRouter = require("./routes/index");<br/>var usersRouter = require("./routes/users");<br/>var bitbucketRouter = require("./routes/bitbucket");</span><span id="2981" class="ku kv iq kq b gy la kx l ky kz">var app = express();</span><span id="4ce3" class="ku kv iq kq b gy la kx l ky kz">// view engine setup<br/>app.set("views", path.join(__dirname, "views"));<br/>app.set("view engine", "jade");</span><span id="8dba" class="ku kv iq kq b gy la kx l ky kz">app.use(logger("dev"));<br/>app.use(express.json());<br/>app.use(express.urlencoded({ extended: false }));<br/>app.use(cookieParser());<br/>app.use(express.static(path.join(__dirname, "public")));<br/>app.use(cors());</span><span id="d5ee" class="ku kv iq kq b gy la kx l ky kz">app.use("/", indexRouter);<br/>app.use("/users", usersRouter);<br/>app.use("/bitbucket", bitbucketRouter);</span><span id="05b3" class="ku kv iq kq b gy la kx l ky kz">// catch 404 and forward to error handler<br/>app.use(function(req, res, next) {<br/>  next(createError(404));<br/>});</span><span id="db74" class="ku kv iq kq b gy la kx l ky kz">// error handler<br/>app.use(function(err, req, res, next) {<br/>  // set locals, only providing error in development<br/>  res.locals.message = err.message;<br/>  res.locals.error = req.app.get("env") === "development" ? err : {};</span><span id="0f9c" class="ku kv iq kq b gy la kx l ky kz">// render the error page<br/>  res.status(err.status || 500);<br/>  res.render("error");<br/>});</span><span id="63e9" class="ku kv iq kq b gy la kx l ky kz">module.exports = app;</span></pre><p id="dd89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加CORS插件以支持跨域通信，并通过添加以下内容在我们的应用程序中添加<code class="fe lb lc ld kq b">users</code>和<code class="fe lb lc ld kq b">bitbucket</code>路线:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="ba34" class="ku kv iq kq b gy kw kx l ky kz">app.use("/users", usersRouter);<br/>app.use("/bitbucket", bitbucketRouter);</span></pre><p id="5be1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这完成了应用程序的后端部分。现在我们可以构建前端了。我们将用React构建它，所以我们从项目的根文件夹运行<code class="fe lb lc ld kq b">npx create-react-app frontend</code>开始。</p><p id="6222" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们必须安装一些软件包。我们将安装用于样式化的Bootstrap，用于路由的React Router，分别用于表单值处理和表单验证的Formik和Yup，以及用于发出HTTP请求的Axios。</p><p id="7ca5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，运行<code class="fe lb lc ld kq b">npm i axios bootstrap formik react-bootstrap react-router-dom yup</code>来安装所有的包。</p><p id="4729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们修改<code class="fe lb lc ld kq b">App.js</code>文件夹，用以下代码替换现有代码:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="f8f1" class="ku kv iq kq b gy kw kx l ky kz">import React from "react";<br/>import HomePage from "./HomePage";<br/>import "./App.css";<br/>import ReposPage from "./ReposPage";<br/>import CommitsPage from "./CommitsPage";<br/>import SettingsPage from "./SettingsPage";<br/>import { createBrowserHistory as createHistory } from "history";<br/>import { Router, Route } from "react-router-dom";<br/>import SignUpPage from "./SignUpPage";<br/>import RequireAuth from "./RequireAuth";<br/>const history = createHistory();</span><span id="f9e1" class="ku kv iq kq b gy la kx l ky kz">function App() {<br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;Router history={history}&gt;<br/>        &lt;Route path="/" exact component={HomePage} /&gt;<br/>        &lt;Route path="/signup" exact component={SignUpPage} /&gt;<br/>        &lt;Route<br/>          path="/settings"<br/>          component={props =&gt; (<br/>            &lt;RequireAuth {...props} Component={SettingsPage} /&gt;<br/>          )}<br/>        /&gt;<br/>        &lt;Route<br/>          path="/repos"<br/>          exact<br/>          component={props =&gt; &lt;RequireAuth {...props} Component={ReposPage} /&gt;}<br/>        /&gt;<br/>        &lt;Route<br/>          path="/commits/:repoName"<br/>          exact<br/>          component={props =&gt; (<br/>            &lt;RequireAuth {...props} Component={CommitsPage} /&gt;<br/>          )}<br/>        /&gt;<br/>      &lt;/Router&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="3837" class="ku kv iq kq b gy la kx l ky kz">export default App;</span></pre><p id="3ab9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在这里为应用程序中的页面添加路线。<code class="fe lb lc ld kq b">RequiredAuth</code>是一个更高阶的组件，它接受一个需要认证的组件来访问，如果没有被授权，则返回重定向，如果用户被授权，则返回页面。我们在这个路径中传递需要认证的组件，比如<code class="fe lb lc ld kq b">ReposPage</code>、<code class="fe lb lc ld kq b">SettingsPage</code>和<code class="fe lb lc ld kq b">CommitPage</code>。</p><p id="9cd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lb lc ld kq b">App.css</code>中，我们将现有代码替换为:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="6867" class="ku kv iq kq b gy kw kx l ky kz">.page {<br/>    padding: 20px;<br/>}</span></pre><p id="90d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一些填充。</p><p id="b297" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将<code class="fe lb lc ld kq b">CommitsPage.js</code>添加到<code class="fe lb lc ld kq b">src</code>文件夹中，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="0c37" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState, useEffect } from "react";<br/>import { withRouter } from "react-router-dom";<br/>import { commits } from "./requests";<br/>import Card from "react-bootstrap/Card";<br/>import LoggedInTopBar from "./LoggedInTopBar";<br/>const moment = require("moment");</span><span id="49fd" class="ku kv iq kq b gy la kx l ky kz">function CommitsPage({ match: { params } }) {<br/>  const [initialized, setInitialized] = useState(false);<br/>  const [repoCommits, setRepoCommits] = useState([]);</span><span id="2d4e" class="ku kv iq kq b gy la kx l ky kz">const getCommits = async page =&gt; {<br/>    const repoName = params.repoName;<br/>    const response = await commits(repoName, page);<br/>    setRepoCommits(response.data.values);<br/>  };</span><span id="774a" class="ku kv iq kq b gy la kx l ky kz">useEffect(() =&gt; {<br/>    if (!initialized) {<br/>      getCommits(1);<br/>      setInitialized(true);<br/>    }<br/>  });</span><span id="a217" class="ku kv iq kq b gy la kx l ky kz">return (<br/>    &lt;&gt;<br/>      &lt;LoggedInTopBar /&gt;<br/>      &lt;div className="page"&gt;<br/>        &lt;h1 className="text-center"&gt;Commits&lt;/h1&gt;<br/>        {repoCommits.map(rc =&gt; {<br/>          return (<br/>            &lt;Card style={{ width: "90vw", margin: "0 auto" }}&gt;<br/>              &lt;Card.Body&gt;<br/>                &lt;Card.Title&gt;{rc.message}&lt;/Card.Title&gt;<br/>                &lt;p&gt;Message: {rc.author.raw}&lt;/p&gt;<br/>                &lt;p&gt;<br/>                  Date:{" "}<br/>                  {moment(rc.date).format("dddd, MMMM Do YYYY, h:mm:ss a")}<br/>                &lt;/p&gt;<br/>                &lt;p&gt;Hash: {rc.hash}&lt;/p&gt;<br/>              &lt;/Card.Body&gt;<br/>            &lt;/Card&gt;<br/>          );<br/>        })}<br/>      &lt;/div&gt;<br/>    &lt;/&gt;<br/>  );<br/>}</span><span id="2508" class="ku kv iq kq b gy la kx l ky kz">export default withRouter(CommitsPage);</span></pre><p id="0459" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们获得URL参数中给定的存储库名称的提交，并将它们显示在React Bootstrap提供的列表<code class="fe lb lc ld kq b">Cards</code>中。</p><p id="284a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们创建主页，让我们登录。在<code class="fe lb lc ld kq b">src</code>文件夹中创建一个<code class="fe lb lc ld kq b">HomePage.js</code>文件，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="7843" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState, useEffect } from "react";<br/>import { Formik } from "formik";<br/>import Form from "react-bootstrap/Form";<br/>import Col from "react-bootstrap/Col";<br/>import Button from "react-bootstrap/Button";<br/>import { Link } from "react-router-dom";<br/>import * as yup from "yup";<br/>import { logIn } from "./requests";<br/>import { Redirect } from "react-router-dom";<br/>import Navbar from "react-bootstrap/Navbar";</span><span id="c6a1" class="ku kv iq kq b gy la kx l ky kz">const schema = yup.object({<br/>  username: yup.string().required("Username is required"),<br/>  password: yup.string().required("Password is required")<br/>});</span><span id="60b3" class="ku kv iq kq b gy la kx l ky kz">function HomePage() {<br/>  const [redirect, setRedirect] = useState(false);</span><span id="2547" class="ku kv iq kq b gy la kx l ky kz">const handleSubmit = async evt =&gt; {<br/>    const isValid = await schema.validate(evt);<br/>    if (!isValid) {<br/>      return;<br/>    }<br/>    try {<br/>      const response = await logIn(evt);<br/>      localStorage.setItem("token", response.data.token);<br/>      setRedirect(true);<br/>    } catch (ex) {<br/>      alert("Invalid username or password");<br/>    }<br/>  };</span><span id="d5b3" class="ku kv iq kq b gy la kx l ky kz">if (redirect) {<br/>    return &lt;Redirect to="/repos" /&gt;;<br/>  }</span><span id="925b" class="ku kv iq kq b gy la kx l ky kz">return (<br/>    &lt;&gt;<br/>      &lt;Navbar bg="primary" expand="lg" variant="dark"&gt;<br/>        &lt;Navbar.Brand href="#home"&gt;Bitbucket App&lt;/Navbar.Brand&gt;<br/>      &lt;/Navbar&gt;<br/>      &lt;div className="page"&gt;<br/>        &lt;h1 className="text-center"&gt;Log In&lt;/h1&gt;<br/>        &lt;Formik validationSchema={schema} onSubmit={handleSubmit}&gt;<br/>          {({<br/>            handleSubmit,<br/>            handleChange,<br/>            handleBlur,<br/>            values,<br/>            touched,<br/>            isInvalid,<br/>            errors<br/>          }) =&gt; (<br/>            &lt;Form noValidate onSubmit={handleSubmit}&gt;<br/>              &lt;Form.Row&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="username"&gt;<br/>                  &lt;Form.Label&gt;Username&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="text"<br/>                    name="username"<br/>                    placeholder="Username"<br/>                    value={values.username || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.username &amp;&amp; errors.username}<br/>                  /&gt;<br/>                  &lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.username}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="password"&gt;<br/>                  &lt;Form.Label&gt;Password&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="password"<br/>                    name="password"<br/>                    placeholder="Password"<br/>                    value={values.password || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.password &amp;&amp; errors.password}<br/>                  /&gt;</span><span id="eecd" class="ku kv iq kq b gy la kx l ky kz">&lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.password}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>              &lt;/Form.Row&gt;<br/>              &lt;Button type="submit" style={{ marginRight: "10px" }}&gt;<br/>                Log In<br/>              &lt;/Button&gt;<br/>              &lt;Link<br/>                className="btn btn-primary"<br/>                to="/signup"<br/>                style={{ marginRight: "10px", color: "white" }}<br/>              &gt;<br/>                Sign Up<br/>              &lt;/Link&gt;<br/>            &lt;/Form&gt;<br/>          )}<br/>        &lt;/Formik&gt;<br/>      &lt;/div&gt;<br/>    &lt;/&gt;<br/>  );<br/>}</span><span id="aed0" class="ku kv iq kq b gy la kx l ky kz">export default HomePage;</span></pre><p id="6499" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用Formik提供的<code class="fe lb lc ld kq b">Formik</code>组件来自动处理表单值。它将把这些值直接传送给<code class="fe lb lc ld kq b">onSubmit</code>处理程序的参数。在<code class="fe lb lc ld kq b">handleSubmit</code>函数中，我们运行<code class="fe lb lc ld kq b">schema.validate</code>函数，根据从Yup库生成的<code class="fe lb lc ld kq b">schema</code>对象检查表单值的有效性，如果成功，那么我们从我们将创建的<code class="fe lb lc ld kq b">requests.js</code>文件中调用<code class="fe lb lc ld kq b">login</code>。</p><p id="6563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们创建顶栏。在<code class="fe lb lc ld kq b">src</code>文件夹中创建<code class="fe lb lc ld kq b">LoggedInTopBar.js</code>并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="0971" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState } from "react";<br/>import Navbar from "react-bootstrap/Navbar";<br/>import Nav from "react-bootstrap/Nav";<br/>import { withRouter, Redirect } from "react-router-dom";</span><span id="ebdf" class="ku kv iq kq b gy la kx l ky kz">function LoggedInTopBar({ location }) {<br/>  const [redirect, setRedirect] = useState(false);<br/>  const { pathname } = location;</span><span id="1b0e" class="ku kv iq kq b gy la kx l ky kz">  const isLoggedIn = () =&gt; !!localStorage.getItem("token");</span><span id="6b20" class="ku kv iq kq b gy la kx l ky kz">  if (redirect) {<br/>    return &lt;Redirect to="/" /&gt;;<br/>  }</span><span id="7ae4" class="ku kv iq kq b gy la kx l ky kz">  return (<br/>    &lt;div&gt;<br/>      {isLoggedIn() ? (<br/>        &lt;Navbar bg="primary" expand="lg" variant="dark"&gt;<br/>          &lt;Navbar.Brand href="#home"&gt;Bitbucket App&lt;/Navbar.Brand&gt;<br/>          &lt;Navbar.Toggle aria-controls="basic-navbar-nav" /&gt;<br/>          &lt;Navbar.Collapse id="basic-navbar-nav"&gt;<br/>            &lt;Nav className="mr-auto"&gt;<br/>              &lt;Nav.Link href="/settings" active={pathname == "/settings"}&gt;<br/>                Settings<br/>              &lt;/Nav.Link&gt;<br/>              &lt;Nav.Link href="/repos" active={pathname == "/repos"}&gt;<br/>                Repos<br/>              &lt;/Nav.Link&gt;<br/>              &lt;Nav.Link&gt;<br/>                &lt;span<br/>                  onClick={() =&gt; {<br/>                    localStorage.clear();<br/>                    setRedirect(true);<br/>                  }}<br/>                &gt;<br/>                  Log Out<br/>                &lt;/span&gt;<br/>              &lt;/Nav.Link&gt;<br/>            &lt;/Nav&gt;<br/>          &lt;/Navbar.Collapse&gt;<br/>        &lt;/Navbar&gt;<br/>      ) : null}<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="e8cd" class="ku kv iq kq b gy la kx l ky kz">export default withRouter(LoggedInTopBar);</span></pre><p id="f5e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这包含了React引导程序<code class="fe lb lc ld kq b">Navbar</code>来显示一个带有主页链接和应用程序名称的顶栏。我们只显示本地存储器中的<code class="fe lb lc ld kq b">token</code>。我们检查<code class="fe lb lc ld kq b">pathname</code>，通过设置<code class="fe lb lc ld kq b">active</code>道具来突出显示正确的链接。</p><p id="8871" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来在<code class="fe lb lc ld kq b">src</code>文件夹中创建<code class="fe lb lc ld kq b">ReposPage.js</code>来显示用户拥有的存储库列表。我们补充:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="a3a7" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState, useEffect } from "react";<br/>import { repos } from "./requests";<br/>import Card from "react-bootstrap/Card";<br/>import { Link } from "react-router-dom";<br/>import Pagination from "react-bootstrap/Pagination";<br/>import LoggedInTopBar from "./LoggedInTopBar";</span><span id="5d16" class="ku kv iq kq b gy la kx l ky kz">function ReposPage() {<br/>  const [initialized, setInitialized] = useState(false);<br/>  const [repositories, setRepositories] = useState([]);<br/>  const [page, setPage] = useState(1);<br/>  const [totalPages, setTotalPages] = useState(1);</span><span id="b64f" class="ku kv iq kq b gy la kx l ky kz">  const getRepos = async page =&gt; {<br/>    const response = await repos(page);<br/>    setRepositories(response.data.values);<br/>    setTotalPages(Math.ceil(response.data.size / response.data.pagelen));<br/>  };</span><span id="a9a7" class="ku kv iq kq b gy la kx l ky kz">  useEffect(() =&gt; {<br/>    if (!initialized) {<br/>      getRepos(1);<br/>      setInitialized(true);<br/>    }<br/>  });</span><span id="c4ee" class="ku kv iq kq b gy la kx l ky kz">  return (<br/>    &lt;div&gt;<br/>      &lt;LoggedInTopBar /&gt;<br/>      &lt;h1 className="text-center"&gt;Your Repositories&lt;/h1&gt;<br/>      {repositories.map((r, i) =&gt; {<br/>        return (<br/>          &lt;Card style={{ width: "90vw", margin: "0 auto" }} key={i}&gt;<br/>            &lt;Card.Body&gt;<br/>              &lt;Card.Title&gt;{r.slug}&lt;/Card.Title&gt;<br/>              &lt;Link className="btn btn-primary" to={`/commits/${r.slug}`}&gt;<br/>                Go<br/>              &lt;/Link&gt;<br/>            &lt;/Card.Body&gt;<br/>          &lt;/Card&gt;<br/>        );<br/>      })}<br/>      &lt;br /&gt;<br/>      &lt;Pagination style={{ width: "90vw", margin: "0 auto" }}&gt;<br/>        &lt;Pagination.First onClick={() =&gt; getRepos(1)} /&gt;<br/>        &lt;Pagination.Prev<br/>          onClick={() =&gt; {<br/>            let p = page - 1;<br/>            getRepos(p);<br/>            setPage(p);<br/>          }}<br/>        /&gt;<br/>        &lt;Pagination.Next<br/>          onClick={() =&gt; {<br/>            let p = page + 1;<br/>            getRepos(p);<br/>            setPage(p);<br/>          }}<br/>        /&gt;<br/>        &lt;Pagination.Last onClick={() =&gt; getRepos(totalPages)} /&gt;<br/>      &lt;/Pagination&gt;<br/>      &lt;br /&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="8e80" class="ku kv iq kq b gy la kx l ky kz">export default ReposPage;</span></pre><p id="6af9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们获得列表存储库，并添加分页以获得更多的存储库。</p><p id="074c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lb lc ld kq b">requests.js</code>中，我们添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="d45f" class="ku kv iq kq b gy kw kx l ky kz">const axios = require("axios");<br/>const APIURL = "<a class="ae le" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a>";</span><span id="649f" class="ku kv iq kq b gy la kx l ky kz">axios.interceptors.request.use(<br/>  config =&gt; {<br/>    config.headers.authorization = localStorage.getItem("token");<br/>    return config;<br/>  },<br/>  error =&gt; Promise.reject(error)<br/>);</span><span id="e576" class="ku kv iq kq b gy la kx l ky kz">axios.interceptors.response.use(<br/>  response =&gt; {<br/>    return response;<br/>  },<br/>  error =&gt; {<br/>    if (error.response.status == 401) {<br/>      localStorage.clear();<br/>    }<br/>    return error;<br/>  }<br/>);</span><span id="ef63" class="ku kv iq kq b gy la kx l ky kz">export const signUp = data =&gt; axios.post(`${APIURL}/users/signup`, data);</span><span id="3bf3" class="ku kv iq kq b gy la kx l ky kz">export const logIn = data =&gt; axios.post(`${APIURL}/users/login`, data);</span><span id="d2f6" class="ku kv iq kq b gy la kx l ky kz">export const changePassword = data =&gt;<br/>  axios.post(`${APIURL}/users/changePassword`, data);</span><span id="59c7" class="ku kv iq kq b gy la kx l ky kz">export const currentUser = () =&gt; axios.get(`${APIURL}/users/currentUser`);</span><span id="7ebe" class="ku kv iq kq b gy la kx l ky kz">export const setBitbucketCredentials = data =&gt;<br/>  axios.post(`${APIURL}/bitbucket/setBitbucketCredentials`, data);</span><span id="ecf8" class="ku kv iq kq b gy la kx l ky kz">export const repos = page =&gt;<br/>  axios.get(`${APIURL}/bitbucket/repos/${page || 1}`);</span><span id="2c8e" class="ku kv iq kq b gy la kx l ky kz">export const commits = (repoName) =&gt;<br/>  axios.get(`${APIURL}/bitbucket/commits/${repoName}`);</span></pre><p id="7512" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个文件包含我们注册、登录、设置凭证、获取存储库和提交等所有HTTP请求。</p><p id="fa36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于处理响应，如果我们得到401响应，那么我们清除本地存储，这样我们就不会使用无效的令牌。代码如下:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="f245" class="ku kv iq kq b gy kw kx l ky kz">axios.interceptors.response.use(<br/>  response =&gt; {<br/>    return response;<br/>  },<br/>  error =&gt; {<br/>    if (error.response.status == 401) {<br/>      localStorage.clear();<br/>    }<br/>    return error;<br/>  }<br/>);</span></pre><p id="f4e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用以下内容将令牌附加到请求头:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="6c54" class="ku kv iq kq b gy kw kx l ky kz">axios.interceptors.request.use(<br/>  config =&gt; {<br/>    config.headers.authorization = localStorage.getItem("token");<br/>    return config;<br/>  },<br/>  error =&gt; Promise.reject(error)<br/>);</span></pre><p id="2efc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们不必为每个经过身份验证的请求设置它。</p><p id="0af6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来在<code class="fe lb lc ld kq b">src</code>文件夹中创建一个名为<code class="fe lb lc ld kq b">RequiredAuth.js</code>的文件，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="996c" class="ku kv iq kq b gy kw kx l ky kz">import React from "react";<br/>import { Redirect } from "react-router-dom";</span><span id="7790" class="ku kv iq kq b gy la kx l ky kz">function RequireAuth({ Component }) {<br/>  if (!localStorage.getItem("token")) {<br/>    return &lt;Redirect to="/" /&gt;;<br/>  }<br/>  return &lt;Component /&gt;;<br/>}</span><span id="a642" class="ku kv iq kq b gy la kx l ky kz">export default RequireAuth;</span></pre><p id="3bdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们检查令牌在认证路由中的存在，如果令牌存在，则呈现传入的<code class="fe lb lc ld kq b">Component</code> prop。</p><p id="aaed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们在<code class="fe lb lc ld kq b">src</code>文件夹中创建一个名为<code class="fe lb lc ld kq b">SettingsPage.js</code>的文件，并添加:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="7258" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState, useEffect } from "react";<br/>import { Formik } from "formik";<br/>import Form from "react-bootstrap/Form";<br/>import Col from "react-bootstrap/Col";<br/>import Button from "react-bootstrap/Button";<br/>import * as yup from "yup";<br/>import {<br/>  currentUser,<br/>  setBitbucketCredentials,<br/>  changePassword<br/>} from "./requests";<br/>import LoggedInTopBar from "./LoggedInTopBar";</span><span id="5fa0" class="ku kv iq kq b gy la kx l ky kz">const userFormSchema = yup.object({<br/>  username: yup.string().required("Username is required"),<br/>  password: yup.string().required("Password is required")<br/>});</span><span id="7d7e" class="ku kv iq kq b gy la kx l ky kz">const bitBucketFormSchema = yup.object({<br/>  bitBucketUsername: yup.string().required("Username is required"),<br/>  bitBucketPassword: yup.string().required("Password is required")<br/>});</span><span id="6cb1" class="ku kv iq kq b gy la kx l ky kz">function SettingsPage() {<br/>  const [initialized, setInitialized] = useState(false);<br/>  const [user, setUser] = useState({});<br/>  const [bitbucketUser, setBitbucketUser] = useState({});</span><span id="f333" class="ku kv iq kq b gy la kx l ky kz">  const handleUserSubmit = async evt =&gt; {<br/>    const isValid = await userFormSchema.validate(evt);<br/>    if (!isValid) {<br/>      return;<br/>    }<br/>    try {<br/>      await changePassword(evt);<br/>      alert("Password changed");<br/>    } catch (error) {<br/>      alert("Password change failed");<br/>    }<br/>  };</span><span id="dc11" class="ku kv iq kq b gy la kx l ky kz">const handleBitbucketSubmit = async evt =&gt; {<br/>    const isValid = await bitBucketFormSchema.validate(evt);<br/>    if (!isValid) {<br/>      return;<br/>    }<br/>    try {<br/>      await setBitbucketCredentials(evt);<br/>      alert("Bitbucket credentials changed");<br/>    } catch (error) {<br/>      alert("Bitbucket credentials change failed");<br/>    }<br/>  };</span><span id="2894" class="ku kv iq kq b gy la kx l ky kz">const getCurrentUser = async () =&gt; {<br/>    const response = await currentUser();<br/>    const { username, bitBucketUsername } = response.data;<br/>    setUser({ username });<br/>    setBitbucketUser({ bitBucketUsername });<br/>  };</span><span id="056f" class="ku kv iq kq b gy la kx l ky kz">useEffect(() =&gt; {<br/>    if (!initialized) {<br/>      getCurrentUser();<br/>      setInitialized(true);<br/>    }<br/>  });</span><span id="f9fc" class="ku kv iq kq b gy la kx l ky kz">return (<br/>    &lt;&gt;<br/>      &lt;LoggedInTopBar /&gt;<br/>      &lt;div className="page"&gt;<br/>        &lt;h1 className="text-center"&gt;Settings&lt;/h1&gt;<br/>        &lt;h2&gt;User Settings&lt;/h2&gt;<br/>        &lt;Formik<br/>          validationSchema={userFormSchema}<br/>          onSubmit={handleUserSubmit}<br/>          initialValues={user}<br/>          enableReinitialize={true}<br/>        &gt;<br/>          {({<br/>            handleSubmit,<br/>            handleChange,<br/>            handleBlur,<br/>            values,<br/>            touched,<br/>            isInvalid,<br/>            errors<br/>          }) =&gt; (<br/>            &lt;Form noValidate onSubmit={handleSubmit}&gt;<br/>              &lt;Form.Row&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="username"&gt;<br/>                  &lt;Form.Label&gt;Username&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="text"<br/>                    name="username"<br/>                    placeholder="Username"<br/>                    value={values.username || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.username &amp;&amp; errors.username}<br/>                    disabled<br/>                  /&gt;<br/>                  &lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.username}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="password"&gt;<br/>                  &lt;Form.Label&gt;Password&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="password"<br/>                    name="password"<br/>                    placeholder="Password"<br/>                    value={values.password || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.password &amp;&amp; errors.password}<br/>                  /&gt;</span><span id="9970" class="ku kv iq kq b gy la kx l ky kz">&lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.password}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>              &lt;/Form.Row&gt;<br/>              &lt;Button type="submit" style={{ marginRight: "10px" }}&gt;<br/>                Save<br/>              &lt;/Button&gt;<br/>            &lt;/Form&gt;<br/>          )}<br/>        &lt;/Formik&gt;</span><span id="bf85" class="ku kv iq kq b gy la kx l ky kz">&lt;br /&gt;<br/>        &lt;h2&gt;BitBucket Settings&lt;/h2&gt;<br/>        &lt;Formik<br/>          validationSchema={bitBucketFormSchema}<br/>          onSubmit={handleBitbucketSubmit}<br/>          initialValues={bitbucketUser}<br/>          enableReinitialize={true}<br/>        &gt;<br/>          {({<br/>            handleSubmit,<br/>            handleChange,<br/>            handleBlur,<br/>            values,<br/>            touched,<br/>            isInvalid,<br/>            errors<br/>          }) =&gt; (<br/>            &lt;Form noValidate onSubmit={handleSubmit}&gt;<br/>              &lt;Form.Row&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="bitBucketUsername"&gt;<br/>                  &lt;Form.Label&gt;BitBucket Username&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="text"<br/>                    name="bitBucketUsername"<br/>                    placeholder="BitBucket Username"<br/>                    value={values.bitBucketUsername || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={<br/>                      touched.bitBucketUsername &amp;&amp; errors.bitBucketUsername<br/>                    }<br/>                  /&gt;<br/>                  &lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.bitBucketUsername}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="bitBucketPassword"&gt;<br/>                  &lt;Form.Label&gt;Password&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="password"<br/>                    name="bitBucketPassword"<br/>                    placeholder="Bitbucket Password"<br/>                    value={values.bitBucketPassword || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={<br/>                      touched.bitBucketPassword &amp;&amp; errors.bitBucketPassword<br/>                    }<br/>                  /&gt;</span><span id="53b0" class="ku kv iq kq b gy la kx l ky kz">&lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.bitbucketPassword}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>              &lt;/Form.Row&gt;<br/>              &lt;Button type="submit" style={{ marginRight: "10px" }}&gt;<br/>                Save<br/>              &lt;/Button&gt;<br/>            &lt;/Form&gt;<br/>          )}<br/>        &lt;/Formik&gt;<br/>      &lt;/div&gt;<br/>    &lt;/&gt;<br/>  );<br/>}</span><span id="41f8" class="ku kv iq kq b gy la kx l ky kz">export default SettingsPage;</span></pre><p id="4acd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有两种形式。一个用于设置用户的密码，另一个用于保存位桶凭证。如果输入的数据有效，我们在单独的Yup模式中都有效，并向后端发出请求。</p><p id="b1ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们通过在<code class="fe lb lc ld kq b">src</code>文件夹中创建<code class="fe lb lc ld kq b">SignUpPage.js</code>来创建注册页面。我们补充:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="ede8" class="ku kv iq kq b gy kw kx l ky kz">import React, { useState, useEffect } from "react";<br/>import { Formik } from "formik";<br/>import Form from "react-bootstrap/Form";<br/>import Col from "react-bootstrap/Col";<br/>import Button from "react-bootstrap/Button";<br/>import { Redirect } from "react-router-dom";<br/>import * as yup from "yup";<br/>import { signUp } from "./requests";<br/>import Navbar from "react-bootstrap/Navbar";</span><span id="5145" class="ku kv iq kq b gy la kx l ky kz">const schema = yup.object({<br/>  username: yup.string().required("Username is required"),<br/>  password: yup.string().required("Password is required")<br/>});</span><span id="d6ce" class="ku kv iq kq b gy la kx l ky kz">function SignUpPage() {<br/>  const [redirect, setRedirect] = useState(false);</span><span id="9b69" class="ku kv iq kq b gy la kx l ky kz">  const handleSubmit = async evt =&gt; {<br/>    const isValid = await schema.validate(evt);<br/>    if (!isValid) {<br/>      return;<br/>    }<br/>    try {<br/>      await signUp(evt);<br/>      setRedirect(true);<br/>    } catch (ex) {<br/>      alert("Username already taken");<br/>    }<br/>  };</span><span id="38fa" class="ku kv iq kq b gy la kx l ky kz">  if (redirect) {<br/>    return &lt;Redirect to="/" /&gt;;<br/>  }</span><span id="f9f7" class="ku kv iq kq b gy la kx l ky kz">  return (<br/>    &lt;&gt;<br/>      &lt;Navbar bg="primary" expand="lg" variant="dark"&gt;<br/>        &lt;Navbar.Brand href="#home"&gt;Bitbucket App&lt;/Navbar.Brand&gt;<br/>      &lt;/Navbar&gt;<br/>      &lt;div className="page"&gt;<br/>        &lt;h1 className="text-center"&gt;Sign Up&lt;/h1&gt;<br/>        &lt;Formik validationSchema={schema} onSubmit={handleSubmit}&gt;<br/>          {({<br/>            handleSubmit,<br/>            handleChange,<br/>            handleBlur,<br/>            values,<br/>            touched,<br/>            isInvalid,<br/>            errors<br/>          }) =&gt; (<br/>            &lt;Form noValidate onSubmit={handleSubmit}&gt;<br/>              &lt;Form.Row&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="username"&gt;<br/>                  &lt;Form.Label&gt;Username&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="text"<br/>                    name="username"<br/>                    placeholder="Username"<br/>                    value={values.username || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.username &amp;&amp; errors.username}<br/>                  /&gt;<br/>                  &lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.username}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>                &lt;Form.Group as={Col} md="12" controlId="password"&gt;<br/>                  &lt;Form.Label&gt;Password&lt;/Form.Label&gt;<br/>                  &lt;Form.Control<br/>                    type="password"<br/>                    name="password"<br/>                    placeholder="Password"<br/>                    value={values.password || ""}<br/>                    onChange={handleChange}<br/>                    isInvalid={touched.password &amp;&amp; errors.password}<br/>                  /&gt;</span><span id="adfa" class="ku kv iq kq b gy la kx l ky kz">                  &lt;Form.Control.Feedback type="invalid"&gt;<br/>                    {errors.password}<br/>                  &lt;/Form.Control.Feedback&gt;<br/>                &lt;/Form.Group&gt;<br/>              &lt;/Form.Row&gt;<br/>              &lt;Button type="submit" style={{ marginRight: "10px" }}&gt;<br/>                Sign Up<br/>              &lt;/Button&gt;<br/>            &lt;/Form&gt;<br/>          )}<br/>        &lt;/Formik&gt;<br/>      &lt;/div&gt;<br/>    &lt;/&gt;<br/>  );<br/>}</span><span id="2ea4" class="ku kv iq kq b gy la kx l ky kz">export default SignUpPage;</span></pre><p id="5f65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它类似于另一个登录请求，除了我们调用注册请求而不是登录。</p><p id="a38e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，在<code class="fe lb lc ld kq b">index.html</code>中，我们将现有代码替换为:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="566c" class="ku kv iq kq b gy kw kx l ky kz">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8" /&gt;<br/>    &lt;link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico" /&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;<br/>    &lt;meta name="theme-color" content="#000000" /&gt;<br/>    &lt;meta<br/>      name="description"<br/>      content="Web site created using create-react-app"<br/>    /&gt;<br/>    &lt;link rel="apple-touch-icon" href="logo192.png" /&gt;<br/>    &lt;!--<br/>      manifest.json provides metadata used when your web app is installed on a<br/>      user's mobile device or desktop. See <a class="ae le" href="https://developers.google.com/web/fundamentals/web-app-manifest/" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/web/fundamentals/web-app-manifest/</a><br/>    --&gt;<br/>    &lt;link rel="manifest" href="%PUBLIC_URL%/manifest.json" /&gt;<br/>    &lt;!--<br/>      Notice the use of %PUBLIC_URL% in the tags above.<br/>      It will be replaced with the URL of the `public` folder during the build.<br/>      Only files inside the `public` folder can be referenced from the HTML.</span><span id="08ad" class="ku kv iq kq b gy la kx l ky kz">Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will<br/>      work correctly both with client-side routing and a non-root public URL.<br/>      Learn how to configure a non-root public URL by running `npm run build`.<br/>    --&gt;<br/>    &lt;title&gt;Bitbucket App&lt;/title&gt;<br/>    &lt;link<br/>      rel="stylesheet"<br/>      href="<a class="ae le" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="noopener ugc nofollow" target="_blank">https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css</a>"<br/>      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"<br/>      crossorigin="anonymous"<br/>    /&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;noscript&gt;You need to enable JavaScript to run this app.&lt;/noscript&gt;<br/>    &lt;div id="root"&gt;&lt;/div&gt;<br/>    &lt;!--<br/>      This HTML file is a template.<br/>      If you open it directly in the browser, you will see an empty page.</span><span id="a3f5" class="ku kv iq kq b gy la kx l ky kz">You can add webfonts, meta tags, or analytics to this file.<br/>      The build step will place the bundled scripts into the &lt;body&gt; tag.</span><span id="3e04" class="ku kv iq kq b gy la kx l ky kz">To begin the development, run `npm start` or `yarn start`.<br/>      To create a production bundle, use `npm run build` or `yarn build`.<br/>    --&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="a92e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加引导CSS并更改标题。</p><p id="196a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">写完所有代码后，我们就可以运行我们的应用程序了。在运行任何东西之前，通过运行<code class="fe lb lc ld kq b">npm i -g nodemon</code>来安装<code class="fe lb lc ld kq b">nodemon</code>,这样我们就不必在文件改变时自己重启后端。</p><p id="d085" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后通过运行<code class="fe lb lc ld kq b">backend</code>文件夹中的<code class="fe lb lc ld kq b">npm start</code>和<code class="fe lb lc ld kq b">frontend</code>文件夹中的<code class="fe lb lc ld kq b">npm start</code>来运行后端，如果要求您从不同的端口运行它，请选择“是”。</p><p id="d229" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后你会得到:</p><figure class="kl km kn ko gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lf"><img src="../Images/4e82acf2c9685609c083a42f1ed09cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PlzSs0liudzoJLj33DUOrA.png"/></div></div></figure><figure class="kl km kn ko gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ln"><img src="../Images/390a6f6aeb050007f9e6ea72f0535aa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZtvB7HvFVY024bfDHN3TkA.png"/></div></div></figure><figure class="kl km kn ko gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ln"><img src="../Images/cd6088601428b87b86fa6ae83d85b6bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sqpgUmb3zyVypmoTRWy-wg.png"/></div></div></figure><figure class="kl km kn ko gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ln"><img src="../Images/884c08389b1c6a9836986a4b7fafa557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N93E2bq9fQpKfoztp8VoJg.png"/></div></div></figure><figure class="kl km kn ko gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ln"><img src="../Images/b782e1d0eedb39f64523e86abdd4740e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VFhKddBJCxSYAQJskJ7BSg.png"/></div></div></figure></div></div>    
</body>
</html>