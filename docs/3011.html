<html>
<head>
<title>Node.js Tips — MongoDB, Express and Socket.io, and Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示— MongoDB、Express和Socket.io以及Postgres</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-mongodb-express-and-socket-io-and-postgres-afaf246b9fdd?source=collection_archive---------1-----------------------#2020-08-18">https://javascript.plainenglish.io/node-js-tips-mongodb-express-and-socket-io-and-postgres-afaf246b9fdd?source=collection_archive---------1-----------------------#2020-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/349e82ea6c5daff75c0390f8d024041e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uXfLGAua6Nv_w0tG"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@polarmermaid?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Anne Nygård</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f9aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="ebfb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">获取NodeJS中Mongo数据库中插入文档的id</h1><p id="1beb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以从由<code class="fe me mf mg mh b">insert</code>方法调用的回调中获得Mongo数据库中插入文档的<code class="fe me mf mg mh b">_id</code>。</p><p id="19ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="333c" class="mq lc iq mh b gy mr ms l mt mu">collection.insert(obj, (err, docsInserted) =&gt;{<br/>  console.log(docsInserted);<br/>});</span></pre><p id="280f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe me mf mg mh b">obj</code>传递给<code class="fe me mf mg mh b">collection</code>。</p><p id="b6f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们获取<code class="fe me mf mg mh b">docsInserted</code>参数的值，以获得整个对象，包括带有<code class="fe me mf mg mh b">_id</code>的ID。</p><h1 id="57b3" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Redis中的数据值更改时通知节点应用程序</h1><p id="fe83" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用Redis client for Node来观察数据值的变化。</p><p id="4359" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="662e" class="mq lc iq mh b gy mr ms l mt mu">const redis = require("redis");<br/>const client = redis.createClient();</span><span id="3d74" class="mq lc iq mh b gy mv ms l mt mu">client.subscribe("pubsub");<br/>client.on("message", (channel, message) =&gt; {<br/>  console.log(channel, message);<br/>});</span></pre><p id="9abe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只是调用<code class="fe me mf mg mh b">createClient</code>来创建一个Redis客户端实例。</p><p id="a8c2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们订阅<code class="fe me mf mg mh b">pubsub</code>动作来监听发布的变更。</p><p id="fdd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们监听<code class="fe me mf mg mh b">'message'</code>事件来获取消息。</p><h1 id="939f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Sequelize.js删除查询</h1><p id="ea7e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Sequelize编写一个删除查询:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6947" class="mq lc iq mh b gy mr ms l mt mu">Model.destroy({<br/>  where: {<br/>    id: 123<br/>  }<br/>})</span></pre><p id="6247" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中<code class="fe me mf mg mh b">Model</code>是数据表的模型类，它包含我们想要删除的条目。</p><p id="3741" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe me mf mg mh b">destroy</code>删除条目。</p><p id="cf80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">where</code>已经到了哪里。<code class="fe me mf mg mh b">id</code>是ID字段。</p><p id="deec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它可以用其他标准代替。</p><h1 id="e4ef" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">让Express.js应用程序在不同的端口上工作</h1><p id="3923" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们不必硬编码Express应用程序监听的端口。</p><p id="b4ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，我们可以从环境变量中读取值。</p><p id="5450" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="b1af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7f73" class="mq lc iq mh b gy mr ms l mt mu">const express = require("express");<br/>const app = express();</span><span id="dd97" class="mq lc iq mh b gy mv ms l mt mu">app.set('port', process.env.PORT || 3000);</span><span id="b046" class="mq lc iq mh b gy mv ms l mt mu">app.get('/', (req, res) =&gt; {<br/>  res.send('hello world');<br/>});</span><span id="6ba8" class="mq lc iq mh b gy mv ms l mt mu">app.listen(app.get('port'));</span></pre><p id="766b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们从环境变量中获取端口，而不是对端口进行硬编码。</p><p id="7586" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">process.env.PORT</code>是<code class="fe me mf mg mh b">PORT</code>环境变量的值。</p><p id="308c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们可以通过运行以下命令来设置端口并同时运行我们的应用程序:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="eb7f" class="mq lc iq mh b gy mr ms l mt mu">PORT=8080 node app.js</span></pre><h1 id="ef12" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用节点Postgres模块连接到Postgres数据库</h1><p id="7c99" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要使用节点Postgres模块连接到Postgres数据库，我们可以使用<code class="fe me mf mg mh b">pg.connect</code>方法。</p><p id="7d81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9302" class="mq lc iq mh b gy mr ms l mt mu">module.exports = {<br/>  query(text, values, cb) {<br/>    pg.connect((err, client, done) =&gt; {<br/>      client.query(text, values, (err, result) =&gt; {<br/>        done();<br/>        cb(err, result);<br/>      })<br/>    });<br/>  }<br/>}</span></pre><p id="afe5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们利用<code class="fe me mf mg mh b">pg.connect</code>方法连接到数据库。</p><p id="005a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们使用数据库客户机对象<code class="fe me mf mg mh b">client</code>进行查询。</p><p id="4413" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">text</code>有参数化查询。</p><p id="114e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">values</code>有用于查询的值。</p><p id="4b3b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当查询完成时，回调被调用。</p><p id="a031" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">result</code>有了结果。</p><p id="40bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用我们的<code class="fe me mf mg mh b">cb</code>回调，以便当我们调用<code class="fe me mf mg mh b">query</code>方法时可以获得结果。</p><h1 id="37ef" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express 4和express-generator的/bin/www中使用socket.io</h1><p id="070e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过将<code class="fe me mf mg mh b">io</code>对象添加到<code class="fe me mf mg mh b">app.js</code>文件中来使用socket.io:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1d0c" class="mq lc iq mh b gy mr ms l mt mu">const express = require("express");<br/>const socketIo = require("socket.io");<br/>const app = express();<br/>const io = socketIo();<br/>app.io = io;</span><span id="1d9b" class="mq lc iq mh b gy mv ms l mt mu">io.on("connection", ( socket ) =&gt; {<br/>  console.log('connected');<br/>});</span><span id="1ff6" class="mq lc iq mh b gy mv ms l mt mu">module.exports = app;</span></pre><p id="6a2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe me mf mg mh b">io</code>对象附加为<code class="fe me mf mg mh b">app</code>的属性。</p><p id="6004" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">on</code>方法监听<code class="fe me mf mg mh b">'connection'</code>事件。</p><p id="cc3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过在<code class="fe me mf mg mh b">bin/www</code>中编写以下内容来使用它:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="402a" class="mq lc iq mh b gy mr ms l mt mu">//...<br/>const server = http.createServer(app);</span><span id="a14c" class="mq lc iq mh b gy mv ms l mt mu">const io = app.io;<br/>io.attach(server);</span></pre><p id="42be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在调用<code class="fe me mf mg mh b">createServer</code>之前导入<code class="fe me mf mg mh b">app</code>对象，然后调用<code class="fe me mf mg mh b">io.attach</code>将socket.io监听器附加到Express应用程序。</p><p id="d09d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在我们的路由文件中，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7545" class="mq lc iq mh b gy mr ms l mt mu">const app = require('express');</span><span id="32cc" class="mq lc iq mh b gy mv ms l mt mu">module.exports = (io) =&gt; {<br/>  const router = app.Router();</span><span id="fa70" class="mq lc iq mh b gy mv ms l mt mu">  io.on('connection', (socket) =&gt; { <br/>    //...<br/>  });<br/>  return router;<br/>}</span></pre><p id="c9a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将<code class="fe me mf mg mh b">app.js</code>改为:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a312" class="mq lc iq mh b gy mr ms l mt mu">const express = require("express");<br/>const socketIo = require("socket.io");<br/>const app = express();<br/>const io = socketIo();<br/>app.io = io;<br/>io.on("connection", ( socket ) =&gt; {<br/>  console.log('connected');<br/>});</span><span id="3fbb" class="mq lc iq mh b gy mv ms l mt mu">const routes = require('./routes/index')(io);</span><span id="d11d" class="mq lc iq mh b gy mv ms l mt mu">//...</span><span id="6eb3" class="mq lc iq mh b gy mv ms l mt mu">module.exports = app;</span></pre><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/53ca7a12fd2e125d4997665007d199d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L9GK_kueY0ao65kh"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@riley_shannon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Peyton</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="160a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="dc00" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以从<code class="fe me mf mg mh b">insert</code>回调中获得插入的MongoDB文档的ID。</p><p id="14e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过将<code class="fe me mf mg mh b">io</code>对象附加到<code class="fe me mf mg mh b">app</code>来将socket.io合并到由express-generator生成的Express应用程序中。</p><p id="3211" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，通过连接到数据库并使用创建连接后返回的客户端对象，我们可以将Postgres数据库与节点应用程序一起使用。</p><h2 id="f633" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript</strong></h2><p id="7860" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅获取更多类似内容解码，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>