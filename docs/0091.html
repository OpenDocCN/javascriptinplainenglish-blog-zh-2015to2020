<html>
<head>
<title>Breathing easy with Awair and Electron</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用空气和电子轻松呼吸</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/breathing-easy-with-awair-and-electron-a6a87bc5a513?source=collection_archive---------1-----------------------#2019-03-02">https://javascript.plainenglish.io/breathing-easy-with-awair-and-electron-a6a87bc5a513?source=collection_archive---------1-----------------------#2019-03-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/eb5de4eba5b6027033b96cf0d106716c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EOs7JLxiNVwtaiuj"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@sidbobs?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sid Leigh</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="201d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我最近买了一个<a class="ae jz" href="https://getawair.com/" rel="noopener ugc nofollow" target="_blank"> Awair，一个漂亮的小盒子</a>,可以读取它所在房间的温度、湿度、二氧化碳、化学物质和灰尘含量。</p><p id="616b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我买它是因为我和我的女朋友在我们的卧室里有一些不通风的问题，并且会气喘吁吁地醒来，所以我想知道我们的空气质量是怎么回事。</p><p id="2e11" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">它真的帮了我们，我们打开它的第一个晚上就发现了问题，我们的二氧化碳水平是晚上应有水平的六倍，这是因为窗户被关闭以保持房间安静，门也被关闭。</p><p id="44c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你的空气质量由于某种特殊原因而下降，比如你刚刚在房间里喷洒了一些刺激性化学物质，它会通过设备上的蜂鸣声和手机上的警报来提醒你(尽管当我知道我的女朋友因为我收到的警报而一直在除尘时，她会吓坏的)。</p><p id="0685" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过在一个标尺上显示不同的传感器读数，Awair可以更容易地了解空气质量，我现在一看就知道房间是否需要打开窗户或打开暖气才能让事情变得更好。</p><p id="06b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此外，Awair会读取所有传感器读数及其在天平上的位置，并创建一个分数，只要该分数高于80，通常就意味着一切正常。</p><p id="e336" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除了让我呼吸的事实之外，我喜欢Awair的一点是，它有一个API，所以你可以建立自己的应用程序来分析你的数据，这就是我所做的。</p><p id="fb6f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在<a class="ae jz" href="https://monzo.com/" rel="noopener ugc nofollow" target="_blank">的Monzo </a>银行存款，发现了一个非常棒的<a class="ae jz" href="https://github.com/johneas10/bankBar" rel="noopener ugc nofollow" target="_blank">工具栏应用程序，叫做BankBar，由John Easton </a>开发，它允许你查看你的余额，并使用Mac OSX的工具栏管理你的账户，这是电子版的，所以我想做一些类似的东西(<em class="ky">阅读:我抄袭了这个想法</em>)。</p><figure class="la lb lc ld gt jo gh gi paragraph-image"><div class="gh gi kz"><img src="../Images/6a3c0e7569b7b46f66e23fcadcaaa551.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/1*aE1ncpjA9FLpgBX3fWZCaA.gif"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">A demo of my toolbar app</figcaption></figure><h1 id="d651" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用Awair API构建应用程序</h1><p id="5ebc" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">Awair的API曾经是私有的，有一系列对来自iOS应用程序的调用进行逆向工程的库，但他们已经开放了一些东西，你可以通过他们的开发者门户注册一个API密钥。</p><p id="aebd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Awair API可以通过访问令牌用于个人用途，或者如果您希望其他人登录并访问他们的数据，您可以注册一个OAuth2应用程序。我正在构建的应用程序需要使用OAuth2，因为我希望人们能够下载它，登录并查看他们的数据。</p><h2 id="3c24" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">OAuth2随电子流动</h2><p id="9b9b" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">标准的OAuth2流程如下:</p><ul class=""><li id="e2bb" class="mt mu in kc b kd ke kh ki kl mv kp mw kt mx kx my mz na nb bi translated">你将用户发送到一个他们可以登录的页面，该页面包含你的应用的凭据和一个重定向URL，用户通过身份验证后，该页面会将用户发送到该URL</li><li id="64ce" class="mt mu in kc b kd nc kh nd kl ne kp nf kt ng kx my mz na nb bi translated">当请求访问令牌或刷新令牌时，会向重定向URL发送授权码，供您的应用程序使用</li><li id="7924" class="mt mu in kc b kd nc kh nd kl ne kp nf kt ng kx my mz na nb bi translated">然后你用你的授权码调用API来获得一个访问令牌，你用它来授权你的应用程序对用户数据的请求</li><li id="eb12" class="mt mu in kc b kd nc kh nd kl ne kp nf kt ng kx my mz na nb bi translated">当调用API时，您可以将访问令牌包含在头中或作为参数，如果访问令牌过期，您可以请求刷新令牌以继续通过API访问用户数据</li></ul><p id="973d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">桌面和移动设备上的现代操作系统都能够将协议与应用程序相关联，这意味着对<code class="fe nh ni nj nk b">awairbar://</code>的调用将与<a class="ae jz" href="https://gitlab.com/colinfwren/AwairBar" rel="noopener ugc nofollow" target="_blank"> my app AwairBar相关联。</a></p><p id="9920" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Electron允许你使用<code class="fe nh ni nj nk b">app.setAsDefaultProtocolClient()</code>功能将你的应用程序设置为协议的默认处理器(这里你不需要包含<code class="fe nh ni nj nk b">://</code>部分)。</p><p id="bc40" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后使用<code class="fe nh ni nj nk b">app.on('open-url', (event, url))</code>，它将接收协议使用的URL。对于来自OAuth2应用程序的重定向，您可以使用(假设它发送的数据在请求参数中)这个来获得授权码请求的响应。</p><h2 id="c2c9" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">访问和刷新令牌</h2><p id="6f48" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">Awair在处理OAuth2生命周期方面有一个非常好的指南，但它的基础是，一旦你从重定向中获得了授权码，你就可以启动它以及你的应用程序的客户端id、客户端密码和你所请求的令牌类型。</p><p id="287a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将返回一个包含访问令牌的对象，您将使用该对象进行后续的API调用。</p><h2 id="7aad" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">从Awair API获取数据</h2><p id="6fb5" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated"><a class="ae jz" href="https://docs.developer.getawair.com/" rel="noopener ugc nofollow" target="_blank"> Awair API文档非常全面</a>，包含常用的OpenAPI功能，因此很容易获取和使用。</p><p id="94ea" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我的应用程序需要的主要端点是:</p><p id="b63d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="http://developer-apis.awair.is/v1/users/self/devices" rel="noopener ugc nofollow" target="_blank">http://developer-apis.awair.is/v1/users/self/devices</a>返回与用户账户相关的所有Awair设备列表。您将需要这个列表来从设备获取读数，因为这些端点需要<code class="fe nh ni nj nk b">deviceType</code>和<code class="fe nh ni nj nk b">deviceId</code>属性。</p><p id="f0d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="http://developer-apis.awair.is/v1/users/self/devices/:device_type/:device_id/air-data/latest" rel="noopener ugc nofollow" target="_blank">http://developer-APIs . awair . is/v1/users/self/devices/:device _ type/:device _ id/air-data/latest</a>在调用时返回设备的最新读数。这将返回一个对象，其中包含读数的时间、读数的空气分数以及来自不同传感器的原始值，原始值的范围为1-5(1表示良好)。</p><h1 id="6732" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">用电子构建工具栏应用程序</h1><p id="3593" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">正如我之前提到的，我受BankBar的“启发”开发了一个工具栏应用程序，因为我认为这是一个很好的数据访问方式，并且生命周期更容易管理。</p><p id="6513" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">幸运的是，对我来说，构建一个工具栏(或者用电子术语来说是<code class="fe nh ni nj nk b">Tray</code>)应用程序非常简单。</p><h2 id="9129" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">创建托盘应用程序</h2><p id="2d69" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">要构建一个托盘应用程序，你只需<a class="ae jz" href="https://electronjs.org/docs/api/tray" rel="noopener ugc nofollow" target="_blank">创建一个新的</a> <code class="fe nh ni nj nk b"><a class="ae jz" href="https://electronjs.org/docs/api/tray" rel="noopener ugc nofollow" target="_blank">Tray</a></code> <a class="ae jz" href="https://electronjs.org/docs/api/tray" rel="noopener ugc nofollow" target="_blank">实例</a>，它会获取一个指向托盘应用程序图标的路径(在Mac OS X上，你可以提供<code class="fe nh ni nj nk b">icon.png</code>，但如果你在同一个目录中有<code class="fe nh ni nj nk b">icon@2x.png</code>，它会将该路径用于retina显示屏)。</p><p id="4d8c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">托盘将仅在工具栏上显示一个图标，因此您需要<a class="ae jz" href="https://electronjs.org/docs/api/menu" rel="noopener ugc nofollow" target="_blank">将该图标与</a> <code class="fe nh ni nj nk b"><a class="ae jz" href="https://electronjs.org/docs/api/menu" rel="noopener ugc nofollow" target="_blank">Menu</a></code> <a class="ae jz" href="https://electronjs.org/docs/api/menu" rel="noopener ugc nofollow" target="_blank"> </a>相结合，并使用<code class="fe nh ni nj nk b">tray.setContextMenu()</code>将该菜单与托盘相关联。</p><p id="90d5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">由于<code class="fe nh ni nj nk b">Menu.buildFromTemplate()</code>接受一个对象数组，创建菜单非常简单，每个对象充当一个菜单项，也可以有自己的子菜单。</p><p id="64f5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您定义的每个菜单项都有一个<code class="fe nh ni nj nk b">label</code>，您可以定义一个<code class="fe nh ni nj nk b">click()</code>函数来处理单击该菜单项。还有一些<a class="ae jz" href="https://electronjs.org/docs/api/menu-item#roles" rel="noopener ugc nofollow" target="_blank">你可以让菜单项扮演的角色</a>来管理这些动作，而不需要额外的代码。</p><p id="b702" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">分别使用<code class="fe nh ni nj nk b">tray.setTitle()</code>和<code class="fe nh ni nj nk b">tray.setImage()</code>可以动态更新托盘的图像和标题。只要你有访问托盘实例的权限，你就可以在应用生命周期的任何时候调用它们。</p><h2 id="5785" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">持久数据</h2><p id="d2af" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">我使用<code class="fe nh ni nj nk b">electron-store</code>来保存我的应用程序使用的数据。它提供了一个简单的API来获取和设置存储中的值，并且可以存储任何JavaScript文字，所以不需要使用<code class="fe nh ni nj nk b">stringify</code>和<code class="fe nh ni nj nk b">parse</code>JSON对象来存储复杂的值。</p><p id="be04" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于<code class="fe nh ni nj nk b">electron-store</code>,我发现一件棘手的事情是，当编写代码的单元测试时，如果代码导入了一个创建了<code class="fe nh ni nj nk b">Store</code>实例的依赖项，这是因为构造函数要求代码在Electron app生命周期内运行，而我的测试并没有这样做。</p><p id="939d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了绕过这个问题，我利用Jest强大的模仿功能来模仿:</p><figure class="la lb lc ld gt jo"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Mocking the electron-store constructor</figcaption></figure><p id="3105" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我可以从<code class="fe nh ni nj nk b">electron-store</code>导入<code class="fe nh ni nj nk b">setMock</code>和<code class="fe nh ni nj nk b">getMock</code>来访问我提供的模拟函数，并断言它们被调用，或者设置它们在我的测试中返回的值。</p><h2 id="2c8e" class="mh lf in bd lg mi mj dn lk mk ml dp lo kl mm mn ls kp mo mp lw kt mq mr ma ms bi translated">为菜单栏重新创建Awair乐谱图形</h2><p id="5a2c" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">Awair分数在应用程序中通过一个圆圈周围的环来可视化，该环根据分数有不同的完成程度。</p><p id="0964" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了将这个构建到我的工具栏应用程序中，我决定只为10的每一个倍数创建图形，因为屏幕很小，我想大多数人不会在细粒度上看到太多的差异。</p><p id="2d01" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我使用Sketch来创建我的图形(如果你不使用它，并且你在Mac上，我强烈推荐它，它很便宜，对于制作模型来说真的很棒)并且<a class="ae jz" href="https://www.invisionapp.com/inside-design/sketch-tutorial-radial-progress-bars/" rel="noopener ugc nofollow" target="_blank">通过InVision </a>找到了这个教程，尽管本质上它归结为使用间隙和破折号作为边界以及一些Pi相关的数学来使破折号只扩展到所需的百分比。</p><h1 id="45fd" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">摘要</h1><p id="ec68" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl me kn ko kp mf kr ks kt mg kv kw kx ig bi translated">我真的很高兴Electron用JavaScript轻松地创建了一个桌面应用程序。我能够在一个晚上内让这个应用程序处于一个粗略的工作状态，棘手的部分是处理<code class="fe nh ni nj nk b">electron-store</code>以及如何测试它。</p><p id="d51f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我想<a class="ae jz" href="https://electronjs.org/spectron" rel="noopener ugc nofollow" target="_blank">用Spectron </a>为应用程序编写一些测试，Spectron是基于Chromedriver的电子UI自动化框架，但我还没有研究这将如何容易地与基于<code class="fe nh ni nj nk b">Tray</code>和<code class="fe nh ni nj nk b">Menu</code>的应用程序一起工作。</p><p id="13ea" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你想尝试一下，这个应用的代码是<a class="ae jz" href="https://gitlab.com/colinfwren/AwairBar" rel="noopener ugc nofollow" target="_blank"> my Gitlab </a>(你需要在Awair的开发者门户注册你自己的OAuth2应用，以便在本地运行它)。</p></div></div>    
</body>
</html>