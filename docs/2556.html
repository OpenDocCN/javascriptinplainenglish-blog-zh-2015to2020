<html>
<head>
<title>Using Node.js in Production (Part I)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中使用Node.js(第一部分)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/using-node-js-in-production-i-e747e4091934?source=collection_archive---------3-----------------------#2020-07-05">https://javascript.plainenglish.io/using-node-js-in-production-i-e747e4091934?source=collection_archive---------3-----------------------#2020-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6d82" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何将Node.js应用程序部署到生产环境中，并拥有从开发到部署的健壮管道</h2></div><p id="618e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是系列的第一部分，我们将看看PM2作为一个过程管理器帮助扩展我们的应用程序。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/cd17d5de07186ee8e28457155ff920e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*80dr8k3pK371Wzi0UG064A.png"/></div></figure><div class="lj lk gp gr ll lm"><a href="https://github.com/RyanDsilva/nodejs-in-production" rel="noopener  ugc nofollow" target="_blank"><div class="ln ab fo"><div class="lo ab lp cl cj lq"><h2 class="bd ir gy z fp lr fr fs ls fu fw ip bi translated">RyanDsilva/生产中节点</h2><div class="lt l"><h3 class="bd b gy z fp lr fr fs ls fu fw dk translated">gear:在生产中部署Node.js应用程序的分步指南:gear:-RyanDsilva/nodejs-in-production</h3></div><div class="lu l"><p class="bd b dl z fp lr fr fs ls fu fw dk translated">github.com</p></div></div><div class="lv l"><div class="lw l lx ly lz lv ma lh lm"/></div></div></a></div><p id="cbd5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们许多人在构建后端服务器时选择Node.js作为我们的运行时，原因有很多——它速度快，使用JavaScript，npm生态系统无与伦比。但是我们大多数人让我们的应用程序只使用默认配置，运行—</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="f375" class="mg mh iq mc b gy mi mj l mk ml">node server.js</span></pre><p id="6d92" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然这很容易，但由于Node.js的单线程性质，它是不可伸缩的。在大多数情况下，部署系统/虚拟机将有不止一个可用线程，运行默认命令将导致可用资源的次优使用，因为只有一个线程用于运行这个Node.js进程。理想情况下，您希望运行的Node.js进程的数量与您可用的内核/线程的数量一样多(对于monolith应用程序)。</p><p id="3f19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是PM2出手相救的地方。PM2是Node.js应用程序的生产流程经理。使用PM2有很多优点——运行多个Node.js实例、高级监控和日志记录、正常重启等。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mn"><img src="../Images/481e397cc2638949f0664b9e0420a114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nio3CzcEkbTmBFTVLTfdsg.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk">PM2 — Production-grade process manager for Node.js</figcaption></figure><p id="725c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用一个虚拟的Node.js应用程序，它是我为了这个演示的目的而构建的。你可以找到任何PM2配置之前的初始状态，<a class="ae mm" href="https://github.com/RyanDsilva/nodejs-in-production" rel="noopener ugc nofollow" target="_blank">这里</a>。根据您阅读这篇文章的时间,<code class="fe mw mx my mc b">master</code>分支将始终保存项目的最新状态，因此要找到初始代码，请切换到<code class="fe mw mx my mc b">initial</code>分支。对于本教程，我们将在<code class="fe mw mx my mc b">pm2</code>分公司工作。</p><p id="7039" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们需要将PM2设置为一个全球依赖项。为此:</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="ecff" class="mg mh iq mc b gy mi mj l mk ml">npm i -g pm2@latest</span></pre><p id="36cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mz">有些人可能不得不使用</em> <code class="fe mw mx my mc b"><em class="mz">sudo</em></code> <em class="mz">来运行这个命令。</em></p><p id="8bd8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另外，你可能想做的另一件事是让PM2在系统启动时加载，这取决于你使用的操作系统，情况可能会有所不同。但幸运的是，PM2也为你提供了保障:</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="d88f" class="mg mh iq mc b gy mi mj l mk ml">pm2 startup</span></pre><p id="df2c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将打印出您需要运行的命令，该命令将使PM2在系统启动时加载。这个命令需要你使用<code class="fe mw mx my mc b">sudo</code></p><p id="b717" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们已经可以运行Node.js应用程序的多个实例，只需从命令行使用PM2，在参数中指定配置</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="7db5" class="mg mh iq mc b gy mi mj l mk ml">pm2 start server.js -i 0</span></pre><p id="5da5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该命令将启动与可用线程/内核数量一样多的Node.js进程。可选地，您可以通过用您喜欢的任何数字替换0来定制进程的数量。</p><p id="7762" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该知道的有用的附加命令包括—</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="8743" class="mg mh iq mc b gy mi mj l mk ml"># List all processes<br/>pm2 list</span><span id="b53b" class="mg mh iq mc b gy na mj l mk ml"># Monitoring<br/>pm2 monit</span><span id="7b29" class="mg mh iq mc b gy na mj l mk ml"># Stop All Processes<br/>pm2 stop all</span><span id="e8ac" class="mg mh iq mc b gy na mj l mk ml"># Delete All Processes<br/>pm2 delete all</span><span id="c9be" class="mg mh iq mc b gy na mj l mk ml"># Start All Processes<br/>pm2 start all</span></pre><p id="ea2e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然这样做效果很好，但我喜欢一种更加定制的方法，我们可以使用一个名为<code class="fe mw mx my mc b">ecosystem.config.js</code>的文件来实现，我们可以使用<code class="fe mw mx my mc b">pm2 ecosystem</code> <br/>轻松地生成一个样板文件。在这个示例中，我们不会使用该文件的<code class="fe mw mx my mc b">deploy</code>部分，所以我们可以删除它。我们将把<code class="fe mw mx my mc b">ecosystem.config.js</code>修改成这样——</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="ba04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，这有很多术语要解释，但我们会解决的。<code class="fe mw mx my mc b">apps</code>列表包含我们想要运行的所有Node.js应用程序的列表，在我们的例子中，这只是我们拥有的一个应用程序。让我们看看<code class="fe mw mx my mc b">apps</code>列表中对象的属性。</p><ul class=""><li id="3029" class="nd ne iq kh b ki kj kl km ko nf ks ng kw nh la ni nj nk nl bi translated"><strong class="kh ir"> <em class="mz">名称</em> </strong>是指PM2将引用的应用程序的名称。这将显示在进程列表中。</li><li id="4ce4" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><strong class="kh ir"> <em class="mz">脚本</em> </strong>是应用的起点，对于我们来说就是<code class="fe mw mx my mc b">server.js</code>文件。</li><li id="e61e" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><strong class="kh ir"> <em class="mz">实例</em> </strong>是指PM2产生的Node.js进程的数量，可以是任意数量。将其设置为<em class="mz"> max </em>会产生与线程/内核数量相等的进程。</li><li id="4e13" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated"><strong class="kh ir"> <em class="mz"> exec_mode </em> </strong>是一个属性，它允许我们的Node.js应用程序通过将其设置为<code class="fe mw mx my mc b">cluster</code>模式来跨CPU内核扩展。通过这样做，我们基本上实现了“负载平衡”来提高应用程序的性能。</li><li id="8e48" class="nd ne iq kh b ki nm kl nn ko no ks np kw nq la ni nj nk nl bi translated">下一个对象是应用程序的环境变量，我们可以根据需要拥有任意多的环境变量，每个变量都以<strong class="kh ir"> <em class="mz"> env_* </em> </strong>开头。在这种情况下，我们有两个端口<em class="mz">端口</em>和<em class="mz">节点_环境</em>。</li></ul><p id="e9a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们运行应用程序所需的所有配置。现在让我们修改<code class="fe mw mx my mc b">package.json</code>文件中的启动脚本来使用PM2。</p><pre class="lc ld le lf gt mb mc md me aw mf bi"><span id="f674" class="mg mh iq mc b gy mi mj l mk ml">start: "<!-- -->pm2 start ecosystem.config.js --env production<!-- -->"</span></pre><p id="0fcc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">恭喜你！这样，Node.js应用程序就可以扩展到使用所有可用的CPU内核以及额外的功能，如正常关机/重启、监控等。</p><p id="e5fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">非常感谢你能走到这一步，我希望这是有用的。请分享这一点，并感谢任何反馈。第2部分见。</p><div class="lj lk gp gr ll lm"><a href="https://medium.com/@ryan.dsilva/using-node-js-in-production-ii-c3906990e61e" rel="noopener follow" target="_blank"><div class="ln ab fo"><div class="lo ab lp cl cj lq"><h2 class="bd ir gy z fp lr fr fs ls fu fw ip bi translated">在生产中使用node . js—II</h2><div class="lt l"><h3 class="bd b gy z fp lr fr fs ls fu fw dk translated">这是如何将Node.js应用程序部署到生产环境中的系列文章的第2部分</h3></div><div class="lu l"><p class="bd b dl z fp lr fr fs ls fu fw dk translated">medium.com</p></div></div><div class="lv l"><div class="nr l lx ly lz lv ma lh lm"/></div></div></a></div></div></div>    
</body>
</html>