<html>
<head>
<title>Setup Amazon OAuth With Node and Passport JS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用节点和Passport JS设置Amazon OAuth</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/setup-amazon-oauth-with-node-and-passport-js-26686f972c15?source=collection_archive---------11-----------------------#2020-09-27">https://javascript.plainenglish.io/setup-amazon-oauth-with-node-and-passport-js-26686f972c15?source=collection_archive---------11-----------------------#2020-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/203ad492baf65bdc0d5594f92ad3cd3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*L9pt3oClyTrQRWER5uJ2Mw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk">Cover</figcaption></figure><p id="059e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇博客中，我将演示如何用Node和Passport JS实现Amazon OAuth。为了实现这一点，我们将使用一个名为Passport JS的第三方库。Passport JS是Node和Express JS的认证中间件。Passport JS可以与任何Express JS应用程序一起使用。Passport JS提供500 +策略。</p><div class="kw kx gp gr ky kz"><a href="http://www.passportjs.org/packages/passport-amazon" rel="noopener  ugc nofollow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd ir gy z fp le fr fs lf fu fw ip bi translated">护照-亚马逊</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">使用OAuth 2.0 API向Amazon认证的Passport策略。此模块允许您使用以下方式进行身份验证…</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">www.passportjs.org</p></div></div><div class="li l"><div class="lj l lk ll lm li ln js kz"/></div></div></a></div></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><p id="31c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目录</p><ol class=""><li id="61ad" class="lv lw iq ka b kb kc kf kg kj lx kn ly kr lz kv ma mb mc md bi translated"><a class="ae me" href="#8692" rel="noopener ugc nofollow">初始化一个节点JS项目</a></li><li id="98de" class="lv lw iq ka b kb mf kf mg kj mh kn mi kr mj kv ma mb mc md bi translated"><a class="ae me" href="#20ba" rel="noopener ugc nofollow">创建amazon OAuth客户端ID </a></li><li id="58bd" class="lv lw iq ka b kb mf kf mg kj mh kn mi kr mj kv ma mb mc md bi translated"><a class="ae me" href="#b955" rel="noopener ugc nofollow">配置亚马逊OAuth </a></li><li id="7084" class="lv lw iq ka b kb mf kf mg kj mh kn mi kr mj kv ma mb mc md bi translated"><a class="ae me" href="#8e6d" rel="noopener ugc nofollow">保护路由并添加注销</a></li></ol></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><ol class=""><li id="8692" class="lv lw iq ka b kb kc kf kg kj lx kn ly kr lz kv ma mb mc md bi translated"><strong class="ka ir">初始化一个节点JS项目</strong></li></ol><p id="d4e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们创建一个新的Node js项目。下面的命令创建一个新文件夹，然后初始化我们项目的节点。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="e8fc" class="mt mu iq mp b gy mv mw l mx my">mkdir amazon_passport<br/>cd amazon_passport/<br/>npm init -y<br/>touch index.js</span></pre><p id="a531" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在安装所需的软件包:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="dfbf" class="mt mu iq mp b gy mv mw l mx my">npm i express cookie-session passport passport-amazon</span></pre><p id="b3c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装后，将下面的代码复制到您的<code class="fe mz na nb mp b">index.js</code>文件中。</p><p id="992f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mz na nb mp b">index.js</code></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="14b1" class="mt mu iq mp b gy mv mw l mx my">const express = require('express')<br/>const app = express()</span><span id="dbec" class="mt mu iq mp b gy nc mw l mx my">app.get('/',(req,res)=&gt;{<br/>  res.send('Hello world')<br/>})</span><span id="3d89" class="mt mu iq mp b gy nc mw l mx my">app.listen(8000,()=&gt;{<br/>  console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="5442" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用<code class="fe mz na nb mp b">node index.js</code>启动服务器。然后导航到<a class="ae me" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000/ </a>。您应该会看到浏览器中显示“Hello world”。</p><p id="20ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.<strong class="ka ir">创建一个亚马逊OAuth客户端ID </strong></p><p id="89ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用passport的亚马逊认证策略之前，您应该已经在亚马逊注册了您的应用程序或网络应用程序。为此，请遵循以下步骤。</p><p id="2c9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到链接:</p><div class="kw kx gp gr ky kz"><a href="https://developer.amazon.com/loginwithamazon/console/site/lwa/overview.html" rel="noopener  ugc nofollow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd ir gy z fp le fr fs lf fu fw ip bi translated">登录</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">编辑描述</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">developer.amazon.com</p></div></div><div class="li l"><div class="nd l lk ll lm li ln js kz"/></div></div></a></div><p id="656f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该链接会将您导航到Amazon开发人员的仪表板。点击创建新的安全性配置文件按钮。输入应用的名称。</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/d70be7543048e6d4815058eb6a0ca10f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LVtTUl__H4dL9AdF5MniUA.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk">Creating a new App</figcaption></figure><p id="31d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建时，您将被导航到一个控制面板，在那里您可以看到客户端ID和客户端密码。把它记下来。</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nj"><img src="../Images/c06f796b849df6f7efd3a48f6b18e822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YuvZL_eTn6cGfxzPC8S4qw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk">Creating OAuth Client ID</figcaption></figure><p id="8955" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，导航到应用程序的设置页面，添加返回或回拨网址。</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nk"><img src="../Images/3a1e78a109fe2b2c308be45ff860afcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6kHuyUzigGmWDM0XVdO27Q.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk">Callback</figcaption></figure><p id="b955" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.<strong class="ka ir">配置亚马逊OAuth </strong></p><p id="19eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们开始将Amazon身份验证集成到我们的项目中。为此，我创建了一个名为<code class="fe mz na nb mp b">passport.js</code>的新文件，它保存了我们从Amazon的OAuth页面创建的凭证。</p><p id="f59a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mz na nb mp b">passport.js</code></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="3f40" class="mt mu iq mp b gy mv mw l mx my">const passport = require('passport');<br/>const AmazonStrategy = require('passport-amazon').Strategy;</span><span id="4083" class="mt mu iq mp b gy nc mw l mx my">passport.serializeUser(function(user, done) {<br/>    done(null, user);<br/>});<br/>passport.deserializeUser(function(user, done) {<br/>    done(null, user);<br/>});<br/><strong class="mp ir">passport.use(new AmazonStrategy({<br/>  clientID: "am********************************************0076",<br/>  clientSecret: "5077******************************************1d4e",<br/>  callbackURL: "http://localhost:8000/auth/amazon/callback"<br/>},</strong><br/>function(accessToken, refreshToken, profile, done) {<br/>  return done(null, profile);<br/>}<br/>));</span></pre><p id="6bca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将以下代码复制并粘贴到您的<code class="fe mz na nb mp b">index.js</code>文件中。</p><p id="2e7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">route <code class="fe mz na nb mp b">/auth/amazon</code>将客户端重定向到亚马逊的登录页面。</p><p id="8ed2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">route <code class="fe mz na nb mp b">/auth/amazon/callback</code>将充当回调URL，如果Amazon认证成功，将调用该URL。</p><p id="b053" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果在Amazon验证过程中出现任何错误，将调用路线<code class="fe mz na nb mp b">/ath/error</code>。</p><p id="9678" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mz na nb mp b">index.js</code></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="ce21" class="mt mu iq mp b gy mv mw l mx my">const express = require('express')<br/>const app = express()<br/>const cookieSession = require('cookie-session')<br/>const passport = require('passport');<br/>require('./passport')</span><span id="f1eb" class="mt mu iq mp b gy nc mw l mx my">app.use(cookieSession({<br/>  name: 'amazon-auth-session',<br/>  keys: ['key1', 'key2']<br/>}))<br/>app.use(passport.initialize());<br/>app.use(passport.session());</span><span id="b5c9" class="mt mu iq mp b gy nc mw l mx my">app.get('/',(req,res)=&gt;{<br/>res.send(`Hello world ${req.user.displayName}`)<br/>})</span><span id="a819" class="mt mu iq mp b gy nc mw l mx my"><strong class="mp ir">app.get('/auth/error', (req, res) =&gt; res.send('Unknown Error'))</strong></span><span id="1e32" class="mt mu iq mp b gy nc mw l mx my"><strong class="mp ir">app.get('/auth/amazon',passport.authenticate('amazon',{scope: ['profile', 'postal_code']}));</strong></span><span id="10f9" class="mt mu iq mp b gy nc mw l mx my"><strong class="mp ir">app.get('/auth/amazon/callback',passport.authenticate('amazon', { failureRedirect: '/auth/error' }),<br/>function(req, res) {<br/>    res.redirect('/');<br/>});</strong></span><span id="00cc" class="mt mu iq mp b gy nc mw l mx my">app.listen(8000,()=&gt;{<br/>    console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="2d51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在导航到<a class="ae me" href="http://localhost:8000/auth/amazon" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/auth/Amazon</a>。你将被重定向到亚马逊的登录页面。登录您的亚马逊帐户后，您将被重定向回我们的网页，您将看到您的亚马逊用户名显示在我们的网页上。</p><p id="8e6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.<strong class="ka ir">保护路由和添加注销</strong></p><p id="d60f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们添加中间件，看看用户是否已经登录。为此，我在中间件文件夹中创建了一个名为<code class="fe mz na nb mp b">auth.js</code>的文件。</p><p id="7de2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mz na nb mp b">Middleware/auth.js</code></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="9a89" class="mt mu iq mp b gy mv mw l mx my">const isLoggedIn = (req, res, next) =&gt; {<br/>  if (req.user) {<br/>    next();<br/>  } else {<br/>    res.status(401).send('Not Logged In'); <br/>  }<br/>}</span><span id="9fbd" class="mt mu iq mp b gy nc mw l mx my">module.exports = isLoggedIn</span></pre><p id="2294" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成后，将中间件传递给路由<code class="fe mz na nb mp b">/</code>。现在自动导航至网址<code class="fe mz na nb mp b"><a class="ae me" href="http://localhost:8000/auth" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/</a>.</code>，您将被重定向至<code class="fe mz na nb mp b">/auth/amazon</code>路线。</p><p id="2dd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们创建一个注销函数。只要调用函数<code class="fe mz na nb mp b">req.logout()</code>你就可以从亚马逊账户注销。</p><p id="6a19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mz na nb mp b">index.js</code></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="6ecc" class="mt mu iq mp b gy mv mw l mx my">const isLoggedIn = require('./Middleware/auth')</span><span id="6a9d" class="mt mu iq mp b gy nc mw l mx my">app.get('/',<strong class="mp ir">isLoggedIn</strong>,(req,res)=&gt;{<br/>    res.send(`Hello world ${req.user.displayName}`)<br/>})</span><span id="fa3b" class="mt mu iq mp b gy nc mw l mx my">app.get('/logout', (req, res) =&gt; {<br/>  req.session = null;<br/>  req.logout();<br/>  res.redirect('/');<br/>})</span></pre><p id="92e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到<a class="ae me" href="http://localhost:8000/logout" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/logout</a>。您将被注销。</p><p id="a3a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如有任何疑问，请随时联系我。电子邮件:sjlouji10@gmail.com。领英:<a class="ae me" href="https://www.linkedin.com/in/sjlouji/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/sjlouji/</a></p><p id="40f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的GitHub上的完整代码:</p><div class="kw kx gp gr ky kz"><a href="https://github.com/sjlouji/Passport-Strategies---Medium/tree/master/Amazon_OAuth" rel="noopener  ugc nofollow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd ir gy z fp le fr fs lf fu fw ip bi translated">sjlouji/Passport-策略-中等</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">护照策略。在GitHub上创建一个帐户，为sjlouji/Passport-Strategies-Medium开发做出贡献。</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">github.com</p></div></div><div class="li l"><div class="nl l lk ll lm li ln js kz"/></div></div></a></div><p id="5e26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编码快乐！</p></div></div>    
</body>
</html>