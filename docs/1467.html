<html>
<head>
<title>Build a Searchable Query in Apollo GraphQL and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apollo GraphQL和MongoDB中构建可搜索的查询</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-a-searchable-query-in-apollo-graphql-and-mongodb-747b183f832c?source=collection_archive---------2-----------------------#2020-03-19">https://javascript.plainenglish.io/build-a-searchable-query-in-apollo-graphql-and-mongodb-747b183f832c?source=collection_archive---------2-----------------------#2020-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3333c54bbaee1bcf819ca15e07eb0da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ib0O0zFby7zwaN-j"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Image Credit: Apollo</figcaption></figure><h1 id="34f4" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">介绍</h1><p id="d87c" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">自2015年公开发布以来，GraphQL的人气一直在攀升，并被选为久经考验的REST API的替代产品。以下是我自己喜欢使用GraphQL的几个原因:</p><ol class=""><li id="1189" class="ly lz iq lc b ld ma lh mb ll mc lp md lt me lx mf mg mh mi bi translated">开箱即用的验证和类型检查</li><li id="97d6" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">查询基本上是自我记录的</li><li id="594d" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">只检索您需要的数据，这样您就不会过量提取</li><li id="9726" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">所有查询的单一端点</li><li id="6a13" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">提供详细的错误消息</li></ol><p id="a878" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果您想了解更多，有大量的文章讨论了使用GraphQL的好处。如果您是GraphQL的新手，我还强烈建议您深入研究GraphQL的文档。</p><div class="mr ms gp gr mt mu"><a href="https://graphql.org/" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd ir gy z fp mz fr fs na fu fw ip bi translated">GraphQL:一种API查询语言。</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">学习准则社区规范行为准则基金会景观学习准则社区规范行为准则基金会…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">graphql.org</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni jw mu"/></div></div></a></div><p id="a5b4" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">在本文中，我将向您展示如何在Apollo GraphQL中构建可搜索的查询。您可以在这里找到完整项目的代码:</p><div class="mr ms gp gr mt mu"><a href="https://github.com/kluu1/users-api" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd ir gy z fp mz fr fs na fu fw ip bi translated">kluu1/用户-api</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">这是我在Medium上发表的博客文章“用Apollo GraphQL和MongoDB构建可搜索查询”的完整代码。检查…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.comm</p></div></div><div class="nd l"><div class="nj l nf ng nh nd ni jw mu"/></div></div></a></div></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="5a10" class="kc kd iq bd ke kf nr kh ki kj ns kl km kn nt kp kq kr nu kt ku kv nv kx ky kz bi translated">先决条件</h1><p id="edda" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">拥有Node.js、GraphQL和MongoDB的坚实基础会有所帮助，但不是必需的。</p><p id="acd9" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">但是，您需要有一个MongoDB的实例，要么在本地，要么在MongoDB Atlas这样的托管平台上。我正在使用MongoDB Atlas的免费层。</p><div class="mr ms gp gr mt mu"><a href="https://www.mongodb.com/cloud/atlas" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd ir gy z fp mz fr fs na fu fw ip bi translated">托管MongoDB托管|数据库即服务</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">借助云MongoDB服务加快移动速度。专为那些宁愿花时间构建应用程序也不愿管理应用程序的敏捷团队打造…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">www.mongodb.com</p></div></div><div class="nd l"><div class="nw l nf ng nh nd ni jw mu"/></div></div></a></div><p id="ff66" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">下面是我们构建用户api应用程序的步骤:</p><ol class=""><li id="d1d3" class="ly lz iq lc b ld ma lh mb ll mc lp md lt me lx mf mg mh mi bi translated">项目设置</li><li id="ccb7" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">生成用户数据并将其插入MongoDB</li><li id="44f6" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">创建Mongoose用户模型</li><li id="c572" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">设置类型定义</li><li id="a2ad" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">设置解析器</li><li id="4eba" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">设置GraphQL服务器</li><li id="9d9c" class="ly lz iq lc b ld mj lh mk ll ml lp mm lt mn lx mf mg mh mi bi translated">启动GraphQL服务器并测试我们的查询</li></ol></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="fa18" class="kc kd iq bd ke kf nr kh ki kj ns kl km kn nt kp kq kr nu kt ku kv nv kx ky kz bi translated">1.项目设置</h1><p id="6ecb" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">让我们设置我们的项目文件夹结构。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="74e4" class="og kd iq oc b gy oh oi l oj ok">mkdir users-api<br/>cd users-api<br/>mkdir models<br/>mkdir scripts<br/>mkdir graphql<br/>git init<br/>npm init -y<br/>touch .gitignore<br/>echo node_modules &gt;&gt; .gitignore<br/>echo .env &gt;&gt; .gitignore<br/>npm install apollo-server dotenv faker graphql mongodb mongoose</span></pre><h1 id="0942" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">2.生成用户数据并将其插入MongoDB</h1><p id="615d" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">在<strong class="lc ir">脚本</strong>文件夹中新建一个名为<strong class="lc ir"> data.js </strong>的文件。该脚本将生成100个假用户，并将其插入MongoDB。</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">/scripts/data.js</figcaption></figure><p id="ef05" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">创造一个<strong class="lc ir">。在运行脚本之前，将您的连接字符串设置为<strong class="lc ir"> MONGO_URI </strong>。参见下面的例子。</strong></p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Create a .env file in the root of the project directory</figcaption></figure><p id="3ce9" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">在您的终端根目录下运行以下命令来执行data.js脚本。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="def2" class="og kd iq oc b gy oh oi l oj ok">node scripts/data.js</span></pre><p id="4c28" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">验证用户数据已经插入到您的MongoDB中。由于我使用的是MongoDB Atlas，所以可以通过web门户进行验证。</p><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/4ca69d0ddc77b552d861fbabc3535ca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXBBtV9RwvUDfqCMoLmpbw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Verified user data has been generated in MongoDB Atlas</figcaption></figure><h1 id="d198" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">3.创建Mongoose用户模型</h1><p id="9991" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">在<strong class="lc ir">模型</strong>文件夹中创建一个名为<strong class="lc ir"> users.js </strong>的新文件。这是我们的猫鼬模型。</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">/models/user.js</figcaption></figure><h1 id="96b3" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">4.设置类型定义</h1><p id="1bd7" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">在<strong class="lc ir"> graphql </strong>文件夹中创建一个新文件<strong class="lc ir"> typeDefs.js </strong>。这个文件描述了数据的外观和类型。它还公开了GraphQL中可用的查询。</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">/graphql/typeDefs.js</figcaption></figure><h1 id="50ea" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">5.设置解析器</h1><p id="d0c1" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">在<strong class="lc ir"> graphql </strong>文件夹中创建一个新文件<strong class="lc ir"> resolvers.js </strong>。解析器基本上是处理逻辑的地方。这是您执行检索、更新和删除数据等操作的地方。</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">/graphql/resolver.js</figcaption></figure><p id="09d8" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如您所见，大部分搜索逻辑都在这里。当"<strong class="lc ir"> getUsers </strong>查询被触发时，我们首先从参数中析构<strong class="lc ir">搜索</strong>、<strong class="lc ir">页面</strong>和<strong class="lc ir">限制</strong>。我们还设置了默认值，以防它们没有被传入。</p><p id="5411" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">在第10行，我们检查<strong class="lc ir">搜索</strong>是否包含任何搜索值。如果是，我们构建搜索查询，使用regex对所有字段执行部分匹配。我们还传入了<strong class="lc ir"> $options: 'i' </strong>，使我们的搜索不区分大小写。然后我们执行查询。</p><p id="3c6c" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">我们还对查询进行了一些简单的分页。<strong class="lc ir">页面</strong>是您正在尝试检索的当前页面。<strong class="lc ir">限制</strong>是您尝试检索的文档数量。如果您想了解关于简单分页的更多信息，请查看我的博客“<a class="ae oo" href="https://medium.com/javascript-in-plain-english/simple-pagination-with-node-js-mongoose-and-express-4942af479ab2" rel="noopener">使用Node.js、Express和mongose</a>进行简单分页”</p><h1 id="e489" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">6.设置GraphQL服务器</h1><p id="9ba8" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">最后，我们创建我们的服务器。在根目录下创建一个名为“<strong class="lc ir"> app.js </strong>的新文件，并复制以下内容:</p><figure class="nx ny nz oa gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Our GraphQL Server</figcaption></figure><h1 id="8105" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">7.启动GraphQL服务器并测试我们的查询</h1><p id="da12" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">现在我们可以启动我们的GraphQL服务器了。在您的终端中，在项目根目录下运行下面的命令。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="c6aa" class="og kd iq oc b gy oh oi l oj ok">node app.js</span></pre><p id="bbd7" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">我们应该能够在您的浏览器中访问<a class="ae oo" href="http://localhost:4000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4000/ </a>并看到GraphQL Playground。</p><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/628a4061895e23b97c30207b8c1adf37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0RFjsZMPZexDpjejWUoeKQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">GraphQL Playground</figcaption></figure><p id="b602" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">复制并粘贴下面的查询，并根据需要更新查询参数。单击“播放”按钮执行查询。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="9429" class="og kd iq oc b gy oh oi l oj ok">{<br/>  getUsers(search: "ka", page: 1, limit: 5) {<br/>    currentPage<br/>    totalPages<br/>    users {<br/>      firstName<br/>      lastName<br/>      userName<br/>      email<br/>      jobTitle<br/>    }<br/>  }<br/>}</span></pre><figure class="nx ny nz oa gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/8854b093fcb5bd37c9e756ff0d86d43e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMFw_g0qsxJlqUAy_343pQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">It works!</figcaption></figure></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="51dd" class="kc kd iq bd ke kf nr kh ki kj ns kl km kn nt kp kq kr nu kt ku kv nv kx ky kz bi translated">摘要🙌</h1><p id="d1e3" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">现在我们有了。总而言之，我们现在有了一个带有MongoDB数据库的Apollo GraphQL服务器。我们有一个“<strong class="lc ir"> getUsers </strong>”查询，可以通过传入一个<strong class="lc ir"> search </strong>值进行搜索。另外，我们还有分页功能。</p><p id="5f48" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">如果你遇到任何问题，请随时给我发消息或在评论中留言。我希望你像我写这篇文章时一样喜欢它。感谢阅读！🍻</p><p id="0190" class="pw-post-body-paragraph la lb iq lc b ld ma lf lg lh mb lj lk ll mo ln lo lp mp lr ls lt mq lv lw lx ij bi translated">我在业余时间写这些文章是为了娱乐。如果你喜欢这篇文章，请在下面留下你的喜欢和评论！可以关注我上 <a class="ae oo" href="https://medium.com/@this.kevinluu" rel="noopener"> <em class="or">中</em> </a> <em class="or">和</em> <a class="ae oo" href="https://twitter.com/kluu_10" rel="noopener ugc nofollow" target="_blank"> <em class="or">推特</em> </a> <em class="or">。感谢支持！</em></p></div></div>    
</body>
</html>