<html>
<head>
<title>How to Debug SAM-based TypeScript Lambdas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何调试基于SAM的类型脚本Lambdas</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/debugging-sam-based-typescript-lambdas-1c9584fafa73?source=collection_archive---------5-----------------------#2020-09-18">https://javascript.plainenglish.io/debugging-sam-based-typescript-lambdas-1c9584fafa73?source=collection_archive---------5-----------------------#2020-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5583764e1a84dfded82a2b7d165a157a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*28xmbrd4lIOB0lfZ.jpg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><a class="ae kc" href="https://flic.kr/p/Em7wAx" rel="noopener ugc nofollow" target="_blank">https://flic.kr/p/Em7wAx</a></figcaption></figure><p id="f8e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你必须在2020年使用AWS无服务器应用程序模型(SAM)和AWS Lambda创建无服务器应用程序或服务，那么你会遇到一个问题——设置断点并以传统方式进行调试。AWS工具包目前不支持用Webstorm调试typescript。本文帮助您在选择的TypeScript Lambda repo中设置调试。</p><ul class=""><li id="d214" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">安装AWS SAM CLI工具。有关如何为您的操作系统执行此操作的说明，请访问<a class="ae kc" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/server less-application-model/latest/developer guide/server less-Sam-CLI-install . html</a></li><li id="d8da" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">如果Docker不可用，请安装它。如何操作的说明可以在https://docs.docker.com/get-docker/<a class="ae kc" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">找到</a></li><li id="e90f" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">可以在https://github.com/rtre84/typescript-aws-sam的<a class="ae kc" href="https://github.com/rtre84/typescript-aws-sam" rel="noopener ugc nofollow" target="_blank">找到Lambda starter的工作打字稿</a></li></ul><p id="73e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启动器有。idea文件夹，当在你最喜欢的Jetbrains IDE中打开时，也会自动继承配置。请感谢决定这么做的善良灵魂。</p><ul class=""><li id="f825" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">为Webstorm安装AWS工具包。这将为您提供SAM Lambda本地调试选项。</li></ul><p id="97c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于安装工具包的说明可以在<a class="ae kc" href="https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/setup-toolkit.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/toolkit-for-jetbrains/latest/user guide/setup-toolkit . html</a>找到</p><p id="cdd5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你注意到，默认情况下，从现在(2020年8月23日)开始，用TypeScript编写的lambda处理程序将不会被默认选择。Webstorm的调试器和AWS工具包需要一些推动，让我们设置断点和调试ts文件。</p><p id="fc15" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解决方法是通过包装函数公开您的处理程序。我不完全确定为什么这能工作，或者为什么Webstorm调试器以某种方式需要它，但是它确实能工作。</p><p id="a447" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再次链接工作样板，查看<a class="ae kc" href="https://github.com/rtre84/typescript-aws-sam" rel="noopener ugc nofollow" target="_blank">https://github.com/rtre84/typescript-aws-sam</a></p><p id="f6e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设您的lambda处理程序名为handler，在index.ts或app.ts文件的底部公开它，如下所示。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e604" class="ly lz iq lu b gy ma mb l mc md">export const lambdaHandler = (event, context) =&gt;<br/>  wrapper(handler)(event, context, {});</span></pre><p id="8aa5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看位于<a class="ae kc" href="https://github.com/rtre84/typescript-aws-sam/blob/master/hello-world/app.ts" rel="noopener ugc nofollow" target="_blank">https://github . com/rtre 84/typescript-AWS-Sam/blob/master/hello-world/app . ts</a>的文件，获取一个工作示例。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="9019" class="ly lz iq lu b gy ma mb l mc md">import {<br/>  APIGatewayProxyEvent,<br/>  APIGatewayProxyHandler,<br/>  Callback,<br/>  Context,<br/>  Handler<br/>} from "aws-lambda";<br/>import { parse } from "querystring";<br/><br/>export type LambdaFnWrapper = () =&gt; (fn: Handler) =&gt; LambdaProxyHandler;<br/>export type LambdaProxyHandler = (<br/>  event: APIGatewayProxyEvent,<br/>  context: Context,<br/>  callback: Callback<br/>) =&gt; Promise&lt;APIGatewayProxyHandler&gt; | void;<br/><br/>const lambdaFnWrapper: LambdaFnWrapper = (): ((<br/>  fn: Handler<br/>) =&gt; LambdaProxyHandler) =&gt; {<br/>  return (fn: Handler): LambdaProxyHandler =&gt; {<br/>    return (<br/>      event: APIGatewayProxyEvent,<br/>      context: Context,<br/>      callback: Callback<br/>    ): Promise&lt;APIGatewayProxyHandler&gt; | void =&gt; {<br/>      // TODO add any pre processing of incoming requests<br/>      if (<br/>        event.headers["Content-Type"] === "application/x-www-form-urlencoded"<br/>      ) {<br/>        (event as any).body = parse((event as any).body);<br/>      }<br/><br/>      return fn(event, context, callback);<br/>    };<br/>  };<br/>};<br/><br/>export const httpFn: (fn: Handler) =&gt; LambdaProxyHandler = lambdaFnWrapper();<br/><br/>const middleware: (fn: Handler) =&gt; LambdaProxyHandler = (<br/>  fn: Handler<br/>): LambdaProxyHandler =&gt; {<br/>  return (<br/>    event: APIGatewayProxyEvent,<br/>    context: Context,<br/>    callback: Callback<br/>  ): Promise&lt;APIGatewayProxyHandler&gt; | void =&gt; {<br/>    (context as any).myName = "Miro";<br/><br/>    return fn(event, context, callback);<br/>  };<br/>};<br/><br/>export const wrapper: (fn: Handler) =&gt; LambdaProxyHandler = (<br/>  fn: Handler<br/>): LambdaProxyHandler =&gt; httpFn(middleware(fn));</span></pre><p id="f9d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">包装函数可以在<a class="ae kc" href="https://github.com/rtre84/typescript-aws-sam/blob/master/hello-world/mw/mw.ts" rel="noopener ugc nofollow" target="_blank">https://github . com/rtre 84/typescript-AWS-Sam/blob/master/hello-world/MW/MW . ts</a>找到</p><ul class=""><li id="ac76" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">右键单击包含您的TypeScript Lambda源代码的目录，然后选择<code class="fe me mf mg lu b">Mark directory as</code>。在随后的子菜单中，选择<code class="fe me mf mg lu b">Resource Root</code>。这应该可以解决lambda处理程序找不到的大多数问题。</li></ul><h1 id="9e43" class="mh lz iq bd mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd bi translated">调试器配置</h1><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/bdc903960b257d46f79210d2d4808aa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Stjg84GgouqW4u56.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Lambda Debugger Configuration</figcaption></figure><p id="8dda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在模板字段中选择Cloudformation模板。下拉菜单应该填充，您的Lambda函数现在应该是可选的。</p><p id="f6df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我更喜欢在SAM CLI配置中使用<code class="fe me mf mg lu b">--debug</code>标志，这样输出会很详细。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/5fb0c95437c057d8dc742960aa5d2062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N8mU95rHJz_6HkFZ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Lambda Debugger Configuration SAM CLI Section</figcaption></figure><p id="0e1a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">AWS部分应该类似于下面的内容。如果您在公司VPN后面或通过联合帐户尝试这样做，您可能需要生成临时AWS凭证。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/b3f3f8806f0b93ae1396a2b1d5e9b2ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HYtsHEoauH8CnHha.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Lambda Debugger Configuration AWS Connection</figcaption></figure><p id="564f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在输入字段中，复制粘贴以下内容作为您的事件模板。这只有在你使用上面提到的样板文件时才有效。如果你正在建立自己的回购，这可能是不相关的。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e3b6" class="ly lz iq lu b gy ma mb l mc md">{<br/>  "body": "{\"test\":\"body\"}",<br/>  "resource": "/{proxy+}",<br/>  "path": "/path/to/resource",<br/>  "httpMethod": "POST",<br/>  "queryStringParameters": {<br/>    "foo": "bar"<br/>  },<br/>  "pathParameters": {<br/>    "proxy": "path/to/resource"<br/>  },<br/>  "stageVariables": {<br/>    "baz": "qux"<br/>  },<br/>  "headers": {<br/>    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",<br/>    "Accept-Encoding": "gzip, deflate, sdch",<br/>    "Accept-Language": "en-US,en;q=0.8",<br/>    "Cache-Control": "max-age=0",<br/>    "CloudFront-Forwarded-Proto": "https",<br/>    "CloudFront-Is-Desktop-Viewer": "true",<br/>    "CloudFront-Is-Mobile-Viewer": "false",<br/>    "CloudFront-Is-SmartTV-Viewer": "false",<br/>    "CloudFront-Is-Tablet-Viewer": "false",<br/>    "CloudFront-Viewer-Country": "US",<br/>    "Host": "1234567890.execute-api.{dns_suffix}",<br/>    "Upgrade-Insecure-Requests": "1",<br/>    "User-Agent": "Custom User Agent String",<br/>    "Via": "1.1 08f323deadbeefa7af34d5feb414ce27.cloudfront.net (CloudFront)",<br/>    "X-Amz-Cf-Id": "cDehVQoZnx43VYQb9j2-nvCh-9z396Uhbp027Y2JvkCPNLmGJHqlaA==",<br/>    "X-Forwarded-For": "127.0.0.1, 127.0.0.2",<br/>    "X-Forwarded-Port": "443",<br/>    "X-Forwarded-Proto": "https"<br/>  },<br/>  "requestContext": {<br/>    "accountId": "123456789012",<br/>    "resourceId": "123456",<br/>    "stage": "prod",<br/>    "requestId": "c6af9ac6-7b61-11e6-9a41-93e8deadbeef",<br/>    "identity": {<br/>      "cognitoIdentityPoolId": null,<br/>      "accountId": null,<br/>      "cognitoIdentityId": null,<br/>      "caller": null,<br/>      "apiKey": null,<br/>      "sourceIp": "127.0.0.1",<br/>      "cognitoAuthenticationType": null,<br/>      "cognitoAuthenticationProvider": null,<br/>      "userArn": null,<br/>      "userAgent": "Custom User Agent String",<br/>      "user": null<br/>    },<br/>    "resourcePath": "/{proxy+}",<br/>    "httpMethod": "POST",<br/>    "apiId": "1234567890"<br/>  }<br/>}</span></pre><p id="7c67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，你应该在顶部有一个类似这样的工具栏。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/2aaa67d3520639d53a5402d56ad20b86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*upu8Qc8eOUd7Ymew.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Debugger Toolbar</figcaption></figure><p id="f709" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">恭喜你！您现在应该有一个工作调试配置。在选择的. ts文件中设置断点，并通过单击调试图标进行调试。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/4ab13a7bd6a5888591bbcd7d1ea2d956.png" data-original-src="https://miro.medium.com/v2/resize:fit:72/format:webp/0*YKOr-ErVRc4sw8hX.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Debug icon</figcaption></figure><h1 id="e5cc" class="mh lz iq bd mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd bi translated">附录</h1><p id="d921" class="pw-post-body-paragraph kd ke iq kf b kg nj ki kj kk nk km kn ko nl kq kr ks nm ku kv kw nn ky kz la ij bi translated">另一个打字稿Lambda Starter:<a class="ae kc" href="https://github.com/mir4ef/aws-lambda-typescript-starter" rel="noopener ugc nofollow" target="_blank">https://github.com/mir4ef/aws-lambda-typescript-starter</a></p><p id="92c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.flickr.com/photos/pagedooley/25169160699/in/photolist-Em7wAx-aRVsKv-rcJuLr-AyUxTf-96RucU-qiUL-2jf67N4-69Yugv-2hYWb3T-2jy8Aza-pcGzVY-2j1Q9ps-rrEdsm-rac7Df-quYb1c-quL1zU-rpsCN5-rabb5o-rpsDas-quL1af-rpsD69-rpsCVu-2jpcf7x-2iZfWLL-2iX6zAk-2j25Jg2-2bzcLQ-2iZfWKZ-akhS9Y-8gSPsR-4qzfNu-2o3zry-4rURJR-51qgSf-2jvWpdz-2jycW34-9t9ex-Bux4oA-4HYU56-2jxXVpx-2jxEJ1Q-2jxFN3m-2jsK162-9uK6cj-9A6zhw-9uFKug-29nsiJJ-FVSBun-2jxEDUi-5nP2AJ" rel="noopener ugc nofollow" target="_blank"> Flickr图片来源</a></p><p id="e380" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="no">更多内容请看</em><a class="ae kc" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="no">plain English . io</em></strong></a></p></div></div>    
</body>
</html>