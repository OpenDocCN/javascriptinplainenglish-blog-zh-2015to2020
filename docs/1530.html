<html>
<head>
<title>Simple Authentication and Authorization in GraphQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL中的简单认证和授权</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/simple-authentication-and-authorization-in-graphql-5293c0458fc?source=collection_archive---------8-----------------------#2020-03-27">https://javascript.plainenglish.io/simple-authentication-and-authorization-in-graphql-5293c0458fc?source=collection_archive---------8-----------------------#2020-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1bc7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在GraphQL中实现身份验证和授权的简单方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b43f37fd254e82fd2a44eefe840d0ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MjReT3L-Ly2GeDkZ"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@wirhabenzeit?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Dominik Schröder</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="9ba1" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="170a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">有句谚语说“GraphQL不关心如何实现身份验证或授权”。这可能会导致很多混乱，因为有很多方法可以处理它。</p><p id="f884" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本教程中，我将向您展示如何以最简单的方式在GraphQL中实现身份验证和授权——通过在构建<code class="fe mp mq mr ms b">context</code>对象时对用户进行身份验证，并在解析器上实现授权。</p><p id="a443" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mp mq mr ms b">context</code>对象是传递给每个解析器的对象。这使得它成为执行身份验证的逻辑位置。我们开始吧！</p><h1 id="b90b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">项目设置</h1><p id="dee0" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我提供了起始代码，所以我们可以专注于实现身份验证部分，跳过设置GraphQL服务器。</p><div class="mt mu gp gr mv mw"><a href="https://github.com/kluu1/simple-graphql-auth" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">kluu1/simple-graphql-auth</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">如何以简单的方式实现GraphQL身份验证- kluu1/simple-graphql-auth</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk kp mw"/></div></div></a></div><p id="6b1d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们拉下这个项目并安装依赖项。</p><pre class="kg kh ki kj gt nl ms nm nn aw no bi"><span id="11d1" class="np kx iq ms b gy nq nr l ns nt">git clone <a class="ae kv" href="https://github.com/kluu1/simple-graphql-auth" rel="noopener ugc nofollow" target="_blank">https://github.com/kluu1/simple-graphql-auth</a><br/>cd simple-graphql-auth<br/>npm install</span></pre><p id="d906" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们可以开始这个项目，并验证一切都正常。运行<code class="fe mp mq mr ms b">npm run dev</code>命令启动开发服务器。</p><pre class="kg kh ki kj gt nl ms nm nn aw no bi"><span id="3792" class="np kx iq ms b gy nq nr l ns nt">npm run dev</span></pre><p id="a8dd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">访问<a class="ae kv" href="http://localhost:4000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4000/ </a>查询<code class="fe mp mq mr ms b">books</code>得到<code class="fe mp mq mr ms b">title</code>和<code class="fe mp mq mr ms b">author</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/15d1f25cf90582d5d5240c340141dab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8rreY1Teyuq5zVHJ9EpQoA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Verified everything is working</figcaption></figure><h1 id="2e86" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">实现身份验证</h1><p id="814c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如前所述，我们将在构建<code class="fe mp mq mr ms b">context</code>对象时对用户进行身份验证。让我们看看如何使用<code class="fe mp mq mr ms b">context</code>功能。</p><p id="0509" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在代码编辑器中打开项目，修改<code class="fe mp mq mr ms b">app.js</code>文件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="acbf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第9行，我们添加了一个函数来构建我们的<code class="fe mp mq mr ms b">context</code>对象。我们从请求中提取<code class="fe mp mq mr ms b">req</code>对象，并从请求头中获取令牌。</p><p id="ffec" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第14行，我们检查令牌是否存在，如果不存在，我们抛出<code class="fe mp mq mr ms b">AuthenticationError</code>，这是阿波罗服务器提供给我们的。</p><p id="d69f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在第19行，我们调用<code class="fe mp mq mr ms b">getUser</code>函数并传入令牌。我将<code class="fe mp mq mr ms b">getUser</code>函数分离到一个名为<code class="fe mp mq mr ms b">auth.js</code>的文件中。请注意，这是根据您使用的身份验证解决方案执行身份验证的地方。例如，如果使用AWS cognitio，则需要调用AWS Cognito API来对用户进行身份验证。</p><p id="55da" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了使本教程简单，我们只检查令牌是否等于<code class="fe mp mq mr ms b">1234567890</code>。如果没有，我们抛出<code class="fe mp mq mr ms b">AuthenticationError</code>表示‘无效令牌’。如果令牌有效，则返回<code class="fe mp mq mr ms b">user</code>对象。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="0cd7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦认证成功并且检索到用户，我们就可以返回<code class="fe mp mq mr ms b">user</code>对象并将其添加到<code class="fe mp mq mr ms b">context</code>中。现在所有解析器都可以访问<code class="fe mp mq mr ms b">user</code>对象，所以我们可以在下一节中执行授权。</p><p id="2fcd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们启动应用程序备份，并测试我们的更改。首先，在不设置任何HTTP头的情况下进行查询。我们会收到一个错误“所需的令牌丢失”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/477ef8c0ef55c1f0807c2bd85f5f0329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JY8qe6X0blKn-kSPK3T4NQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Missing authorization headers</figcaption></figure><p id="5063" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，让我们传入一个无效的令牌。在<code class="fe mp mq mr ms b">HTTP HEADERS</code>中，将<code class="fe mp mq mr ms b">authorization</code>设置为<code class="fe mp mq mr ms b">1234</code>。我们应该会看到“无效令牌”引发的错误。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/c4a209a3fc2ebb428a0423715d1ad8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZFvB2xXzkq5yAKKuHfaOPQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Passing in an invalid token</figcaption></figure><p id="ec2b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，传入我们的有效令牌<code class="fe mp mq mr ms b">1234567890</code>。我们应该期待我们的查询现在通过！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/28cfc85394d77c93fb2e93d40297689e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckV9RMlcWXk9SJEJ-3xhYQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Passing in a valid token</figcaption></figure><h1 id="60a6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">在解析器上实现授权</h1><p id="a75a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在让我们修改<code class="fe mp mq mr ms b">books</code>解析器，这样只有具有“管理员”角色的用户才能访问。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="e1bb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">解析器中的第三个参数是<code class="fe mp mq mr ms b">context</code>对象。我们从<code class="fe mp mq mr ms b">context</code>中破坏<code class="fe mp mq mr ms b">user</code>并简单地检查用户的角色是否等同于“管理员”。如果没有，我们抛出一个“未授权”错误</p><p id="150b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在重启应用程序，测试我们的查询。一切都应该如预期的那样运行，因为我们当前的用户有“管理员”的角色。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/f7eeaaf2c0df445ff700dc194d435019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TaCA9q7cf19bSHLcWanrZw.png"/></div></div></figure><p id="1045" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们在<code class="fe mp mq mr ms b">auth.js</code>文件中修改我们的用户，并将角色更改为<code class="fe mp mq mr ms b">nonadmin</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="9385" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们重新启动应用程序，再次测试我们的查询。我们应该会看到“未授权”的错误。酷！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/3700cd3def29b9454787a7301b142179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUeFQK1bURYjC79hFj9p4w.png"/></div></div></figure><h1 id="29f8" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">摘要</h1><p id="5796" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本文中，我们介绍了如何在GraphQL中轻松实现身份验证和授权。当我第一次自己学习GraphQL时，我发现了许多不同的方法来实现身份验证和授权，并且不确定选择哪种方法。我发现这个解决方案是最简单的方法，它满足了我的所有要求。GraphQL的一个好处是，每当您遇到错误时，消息通常都会很有帮助，并且您可以快速找到问题所在。话虽如此，我希望你喜欢这篇文章，并对你有所帮助！</p><p id="747e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><em class="oc">我在业余时间写这些文章是为了好玩。如果你喜欢这篇文章，请在下面留下你的喜欢和评论！你可以在</em> <a class="ae kv" href="https://medium.com/@this.kevinluu" rel="noopener"> <em class="oc">中</em> </a> <em class="oc">和</em> <a class="ae kv" href="https://twitter.com/kluu_10" rel="noopener ugc nofollow" target="_blank"> <em class="oc">推特</em> </a> <em class="oc">上跟随我。谢谢你的支持！</em></p></div></div>    
</body>
</html>