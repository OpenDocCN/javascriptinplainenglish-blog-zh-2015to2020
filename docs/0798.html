<html>
<head>
<title>Testing Apollo React Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试阿波罗反应钩</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/testing-apollo-react-hooks-a7698067b8a0?source=collection_archive---------2-----------------------#2019-12-12">https://javascript.plainenglish.io/testing-apollo-react-hooks-a7698067b8a0?source=collection_archive---------2-----------------------#2019-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ffc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试你的软件是最重要的步骤之一，不幸的是，这也是最难的步骤之一。每当你在项目中引入新技术时，你必须考虑如何测试它们。您还需要确保这些测试健壮、灵活，并为您的客户带来卓越的用户体验。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a94d6c62d8b6819b4e62188221c4f1b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iZCqQnP2fbpcwVo01G9qAw.jpeg"/></div></div></figure><p id="ee66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">阅读本指南后，你将知道如何使用<a class="ae kx" href="https://jestjs.io/docs/en/getting-started" rel="noopener ugc nofollow" target="_blank"> Jest </a>和<a class="ae kx" href="https://testing-library.com/docs/react-testing-library/intro" rel="noopener ugc nofollow" target="_blank"> React测试库</a>来测试<a class="ae kx" href="https://www.apollographql.com/docs/react/api/react-hooks/" rel="noopener ugc nofollow" target="_blank"> @apollo/react-hooks </a>。</p><p id="9d3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Apollo的文档不是已经教你如何使用@apollo/react-hooks 来<a class="ae kx" href="https://www.apollographql.com/docs/react/development-testing/testing/" rel="noopener ugc nofollow" target="_blank">测试React组件了吗？Apollo文档中的测试方法可能导致不完整的测试用例。MockProvider要求您模拟函数输入和结果。结果应该来自GraphQL服务器，所以可以随意模仿。输入应该提供给应用程序的变异或查询，而不是模仿。</a></p><p id="2c48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来自<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.apollographql.com/docs/react/api/react-testing/" rel="noopener ugc nofollow" target="_blank">@apollo/react-testing</a></code>的MockedProvider组件迫使您模拟查询的输入和输出，这并没有为我们提供我们正在寻找的测试覆盖。我们想做的是:从我们的表单元素动态地提供输入，并模拟结果。</p><p id="71f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么？React组件负责查询的输入，而不是输出。服务器负责输出。当我们动态提供输入时，我们可以断言查询是用表单中提供的输入调用的。</p><h2 id="5471" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">React测试库？</h2><p id="5013" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果你已经熟悉React测试库，请跳到<em class="ma">测试登录表单。</em></p><p id="c23d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能想知道为什么你会选择使用React测试库而不是酶。虽然Enzyme很棒，也达到了它的目的，但React测试库已经与测试理念保持一致，为您的客户带来更强大的测试和更可靠的软件。这个库是由Kent C. Dodds提供的，他可能是最著名的JavaScript测试权威。</p><p id="daca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TL；为什么你应该在酶之前到达React测试库的原因是React测试库使你难以测试实现细节。相反，它试图强迫你以用户使用的方式测试你的软件。</p><blockquote class="mb mc md"><p id="99dd" class="jn jo ma jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">你想为你的React组件编写可维护的测试。作为这一目标的一部分，您希望您的测试避免包含组件的实现细节，而是专注于使您的测试给您预期的信心。作为其中的一部分，您希望您的测试库在长期内是可维护的，这样您的组件的重构(对实现而不是功能的更改)就不会中断您的测试并减慢您和您的团队的速度。——【https://github.com/testing-library/react-testing-library T2】</p></blockquote></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h2 id="3eb2" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">测试登录表单</h2><p id="605a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了测试包含GraphQL查询或变体的组件，我们想要模拟Apollo客户端，这将允许我们创建返回模拟值的处理程序，并查看该处理程序调用了什么。</p><p id="5a00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们从任何应用程序中最常见的表单之一开始，即登录表单。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="7c0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的登录表单中，useLoginMutation来自一个生成文件，由<a class="ae kx" href="https://graphql-code-generator.com/" rel="noopener ugc nofollow" target="_blank"> GraphQL代码生成器</a>创建。生成文件的输出是用<a class="ae kx" href="https://www.apollographql.com/docs/react/api/react-hooks/#usemutation" rel="noopener ugc nofollow" target="_blank"> useMutation </a>创建的@apollo/react-hook。</p><p id="1560" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">为了测试我们想要的登录表单:</strong></p><ol class=""><li id="8055" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">断言使用表单中的数据调用loginMutation</li><li id="b6ac" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">如果突变返回一个错误，断言显示一个错误</li></ol><p id="fdee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您最初的想法可能是嘲笑useLoginMutation。不幸的是，这很复杂，也没有必要。问题是:useLoginMutation是一个钩子生成器，它返回LoginMutation，以及关于函数调用的元数据，如数据、调用、错误和加载。</p><p id="b124" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试表单更容易也更合适的方法是使用@apollo/react-hooks包中的ApolloProvider，并用<a class="ae kx" href="https://www.npmjs.com/package/mock-apollo-client" rel="noopener ugc nofollow" target="_blank"> mock-apollo-client </a>模拟客户端。</p><p id="d3a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在devDependencies中安装所需的模块:</p><pre class="km kn ko kp gt ne lb nf ng aw nh bi"><span id="2ed5" class="lc ld iq lb b gy ni nj l nk nl">npm i mock-apollo-client --save-dev</span></pre><p id="af38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><pre class="km kn ko kp gt ne lb nf ng aw nh bi"><span id="970f" class="lc ld iq lb b gy ni nj l nk nl">yarn add mock-apollo-client -D</span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="afbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">以上测试:</strong></p><ol class=""><li id="4270" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">初始化模拟客户端</li><li id="dd3d" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">定义了登录变异的模拟响应</li><li id="3c32" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">呈现登录表单</li><li id="da22" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">用定义的数据填充表单</li><li id="439f" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">单击提交按钮，触发loginMutation</li><li id="0cd1" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">断言loginMutation是用表单中的数据调用的</li></ol><h2 id="ecac" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">测试重新提取查询</h2><p id="f6e1" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在调用了一个突变之后，通常使用<a class="ae kx" href="https://www.apollographql.com/docs/react/data/mutations/#options" rel="noopener ugc nofollow" target="_blank"> refetchQueries </a>获取数据，或者使用awaitRefetchQueries异步获取数据。</p><p id="c815" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的测试应该断言refetchQueries被调用，并且是用正确的输入调用的。</p><p id="aba2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录表单有一个对“Me”的refetch查询，该查询返回当前登录的用户。</p><p id="06cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将原始查询导入到您的测试中，并向模拟客户端添加另一个处理程序。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="51b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以断言currentUserQueryHandler被调用了一次。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="fb68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述解决方案将帮助您测试大多数应用程序逻辑。可能有一些场景没有在这里讨论。如果你在React中测试GraphQL挂钩需要帮助，请在评论区告诉我。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h2 id="cb84" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">🌎让我们保持联系</h2><p id="52a0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae kx" href="https://www.youtube.com/TomDoesTech" rel="noopener ugc nofollow" target="_blank">在YouTube上订阅</a> <br/> <a class="ae kx" href="https://discord.gg/4ae2Esm6P7" rel="noopener ugc nofollow" target="_blank">不和</a> <br/> <a class="ae kx" href="https://twitter.com/tomdoes_tech" rel="noopener ugc nofollow" target="_blank">推特</a> <br/> <a class="ae kx" href="https://www.tiktok.com/@tomdoestech" rel="noopener ugc nofollow" target="_blank">抖音</a> <br/> <a class="ae kx" href="https://www.facebook.com/tomdoestech" rel="noopener ugc nofollow" target="_blank">脸书</a><br/><a class="ae kx" href="https://www.instagram.com/tomdoestech" rel="noopener ugc nofollow" target="_blank">insta gram</a><br/><a class="ae kx" href="https://www.buymeacoffee.com/tomn" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a></p></div></div>    
</body>
</html>