<html>
<head>
<title>How to get a random document from Firebase Cloud Firestore with Ionic Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Ionic Angular从Firebase Cloud Firestore获得随机文档</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-get-a-random-document-from-firebase-cloud-firestore-with-ionic-angular-a59940efb55e?source=collection_archive---------1-----------------------#2020-05-13">https://javascript.plainenglish.io/how-to-get-a-random-document-from-firebase-cloud-firestore-with-ionic-angular-a59940efb55e?source=collection_archive---------1-----------------------#2020-05-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="92df" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我目前正在建立这个应用程序，我正在谷歌寻找一种方法来从云Firestore获得随机文件。了解Firebase和云Firestore的酷功能，肯定有一个简单的方法可以做到这一点。然而…</h2></div></div><div class="ab cl kf kg hu kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="ij ik il im in"><p id="42ca" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">我无法找到任何方法，可以实现这一点与离子角。不相信我，就去试着找找吧。因此，我决定为那些想使用Ionic Angular从Firebase Cloud Firestore的集合中随机抽取文档的开发人员编写一个指南</p><p id="b134" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">首先，我想说的是，我很惊讶的发现，但是没有官方的指导。有人会认为现在已经有人写了一个简单的指南，但是相信我，我没有找到。我发现了一个关于堆栈溢出的解决方案，我已经将其用于Ionic Angular，特别是TypeScript，我将在本文中详细介绍。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/74681ffaabd0810850ea7b79075849fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yuXJmVenV-1PU_D-yFeg5Q.jpeg"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">Photo by <a class="ae ly" href="https://unsplash.com/@patrickian4?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Patrick Fore</a> on <a class="ae ly" href="https://unsplash.com/s/photos/random-selection?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7c15" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">但首先，在我继续向您展示该方法之前，只是简单解释一下<strong class="ko ir">什么是Firebase </strong>和<strong class="ko ir">什么是Firebase Cloud Firestore，</strong>，以防您偶然看到这篇文章，并想了解更多有关该主题的信息。</p><blockquote class="lz ma mb"><p id="32ca" class="km kn mc ko b kp kq jr kr ks kt ju ku md kw kx ky me la lb lc mf le lf lg lh ij bi translated">Firebase是一个移动和web应用程序开发平台，由Firebase，Inc .于2011年开发，随后于2014年被谷歌收购。截至2020年3月，Firebase平台有19款产品，被超过150万个应用程序使用-</p><p id="06d2" class="km kn mc ko b kp kq jr kr ks kt ju ku md kw kx ky me la lb lc mf le lf lg lh ij bi translated">来自<a class="ae ly" href="https://en.wikipedia.org/wiki/Firebase" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="5e48" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">Firebase提供的19个产品之一是一个功能齐全、可查询的NoSql数据库，名为Cloud Firestore。</p><blockquote class="lz ma mb"><p id="59ed" class="km kn mc ko b kp kq jr kr ks kt ju ku md kw kx ky me la lb lc mf le lf lg lh ij bi translated">Cloud Firestore是一个灵活、可扩展的数据库，用于Firebase和Google云平台的移动、web和服务器开发。像Firebase实时数据库一样，它通过实时监听器使您的数据在客户端应用程序之间保持同步，并为移动和web提供离线支持，因此您可以构建响应迅速的应用程序，无论网络延迟或互联网连接如何。Cloud Firestore还提供了与其他Firebase和Google云平台产品的无缝集成，包括云功能。</p><p id="2827" class="km kn mc ko b kp kq jr kr ks kt ju ku md kw kx ky me la lb lc mf le lf lg lh ij bi translated">来自<a class="ae ly" href="https://firebase.google.com" rel="noopener ugc nofollow" target="_blank"> Firebase网站</a></p></blockquote><p id="eb3b" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">要了解更多关于Firebase、云Firestore和其他Firebase相关产品的信息，请访问Firebase网站</p><div class="mg mh gp gr mi mj"><a href="https://firebase.google.com" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">重火力点</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">Firebase为您提供了分析、数据库、消息传递和崩溃报告等功能，因此您可以快速移动并…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">firebase.google.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx ls mj"/></div></div></a></div><h2 id="1ca4" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">从云Firestore中提取随机数据，高级概述</strong></h2><p id="b4ca" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">从很高的层面来看，你需要在你的文档中有一个递增的或者随机的ID号。</p><p id="c5c0" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">您的数据应该如下所示:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/f93bef01cd8eea36d8907a4ae82ac3cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*vlC5Vu-7dy12jlCEexWYhw.png"/></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">DIAGRAM 1: SHOWING INCREMENTAL ID INSIDE DOCUMENT</figcaption></figure><p id="89ae" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><em class="mc">“但我没有在我的文档中添加增量或随机id，我有1000多个条目。我如何将它添加到每个文档中？”</em></p><p id="a39a" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">别担心，我也一样，所以我决定写点东西来帮助我解决那个问题。解决方案是构建一个简单的Firebase函数，它会自动为您完成这项工作。您可以使用我写的这个简单的代码片段，它将通过<code class="fe nx ny nz oa b">for</code>循环在每个文档中添加和更新字段<code class="fe nx ny nz oa b">id</code>。</p><pre class="lj lk ll lm gt ob oa oc od aw oe bi"><span id="c24d" class="my mz iq oa b gy of og l oh oi">const admin = require("firebase-admin");</span><span id="2a57" class="my mz iq oa b gy oj og l oh oi">admin.initializeApp(functions.config().firebase);</span><span id="9342" class="my mz iq oa b gy oj og l oh oi">...</span><span id="080d" class="my mz iq oa b gy oj og l oh oi">exports.updateRandom=functions.https.onRequest((request, response) =&gt; {<br/>  admin<br/>   .firestore()<br/>   .collection("user")<br/>   .get()<br/>   .then(res =&gt; {<br/>           var pack_data = [];<br/>           res.forEach(datax =&gt; {<br/>             pack_data.push({id: datax.id});<br/>           });</span><span id="c02f" class="my mz iq oa b gy oj og l oh oi">for(var x=0;x&lt;pack_data.length;x++)<br/>           {<br/>             var random=Math.floor((Math.random() * pack_data.length) + 1);<br/>             admin<br/>             .firestore()<br/>             .collection("user")<br/>             .doc(pack_data[x].id)<br/>             .update({id:random})<br/>           }</span><span id="1566" class="my mz iq oa b gy oj og l oh oi">return response.send("OK");<br/>    })<br/>    .catch(err=&gt;{<br/>      return response.send("ERROR "+err);<br/>    })<br/>})</span></pre><p id="219c" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">所以现在我们已经添加了一个随机化的<code class="fe nx ny nz oa b">id</code>，我们需要做的就是生成一个随机数，并从云Firestore查询这个随机数。</p><h2 id="4165" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">随机拉一个用户文档</strong></h2><p id="4ec2" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">例如，假设我们正在构建一个raffles draw应用程序，我们需要从Cloud Firestore中的用户集合中随机抽取一个用户文档。假设我们已经在每个文档中添加了一个随机的或递增的ID字段，下一步就是进行查询。</p><h2 id="659f" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">步骤1:生成随机数</strong></h2><p id="cc3e" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">在客户端应用程序中，我们需要生成一个随机数。当我们从Cloud Firestore中抽取一个随机的文档时，这个随机数将成为引用的密钥。</p><p id="bd12" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">假设我们有超过1500个用户，通过使用下面的代码片段，我们可以得到一个介于0到1499(记住，程序员从0开始计数)之间的随机数:</p><pre class="lj lk ll lm gt ob oa oc od aw oe bi"><span id="dcd5" class="my mz iq oa b gy of og l oh oi">var random=Math.floor((Math.random() * documentSize.length));</span></pre><h2 id="0d55" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">第二步:查询随机数</strong></h2><p id="38a4" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">一旦我们生成了一个随机数，我们就可以在客户端应用程序中查询云Firestore。我们需要写一个函数来完成这个任务。在这种情况下，让我们调用我们的函数<code class="fe nx ny nz oa b">getRandomUser():</code></p><pre class="lj lk ll lm gt ob oa oc od aw oe bi"><span id="7f72" class="my mz iq oa b gy of og l oh oi">getRandomUser(){</span><span id="d30e" class="my mz iq oa b gy oj og l oh oi">return new Promise(async (resolve)=&gt;{</span><span id="d440" class="my mz iq oa b gy oj og l oh oi">var random = Math.floor((Math.random() * documentSize.length));</span><span id="3711" class="my mz iq oa b gy oj og l oh oi">await firebase<br/>        .firestore()<br/>        .collection("user")<br/>        .where("id","&gt;=" , random)<br/>        .limit(1)<br/>        .get()<br/>        .then((res)=&gt;{<br/>          let pack_data:any=[];<br/>          res.forEach(quest=&gt;{<br/>            pack_data.push(quest.data());<br/>          });</span><span id="f6a2" class="my mz iq oa b gy oj og l oh oi">          resolve(pack_data[0]);</span><span id="806c" class="my mz iq oa b gy oj og l oh oi">})</span><span id="08b5" class="my mz iq oa b gy oj og l oh oi">}</span></pre><p id="4eff" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">如果您注意到了<code class="fe nx ny nz oa b">.where</code>语句，我们实际上是在这里查询数据库，以返回与我们生成的随机数相同或更大的数。这将返回最接近随机数的项，即使随机生成的数不返回文档。</p><p id="f1c7" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">虽然这个方法是进行单向查询，但是如果您想进行双向查询，也可以采用同样的方法，我在这里不做介绍，因为使用这个单向方法可以返回我正在寻找的随机项，但是我只想指出，也可以进行双向查询。</p><h2 id="2bb0" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">第三步:获取随机文件</strong></h2><p id="da71" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">上一节中方法的查询解析一个承诺并返回<code class="fe nx ny nz oa b">pack_data[0]</code>。这将是我们想要的随机文档，然后我们可以在我们的应用程序中使用它。</p><p id="d6ed" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><strong class="ko ir">总结</strong></p><p id="ce4a" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">如果你能够完成上述3个任务，你应该能够返回并从你的云Firestore获得一个随机文件。一定要试一试。</p><p id="458c" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><strong class="ko ir">编码快乐！</strong></p><p id="5937" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><strong class="ko ir">建议增强功能</strong></p><ol class=""><li id="a3b9" class="ok ol iq ko b kp kq ks kt kv om kz on ld oo lh op oq or os bi translated">如上所述，您可以向查询添加双向方法</li><li id="3d90" class="ok ol iq ko b kp ot ks ou kv ov kz ow ld ox lh op oq or os bi translated">如果返回了1个以上的文档，您可以添加另一层随机性。在上述带有<code class="fe nx ny nz oa b">limit(1)</code>的文件中，我们已经将限制设置为1，但是我们可以将限制返回到5，并对返回的5份文件进行进一步的随机化。</li></ol><h2 id="16eb" class="my mz iq bd na nb nc dn nd ne nf dp ng kv nh ni nj kz nk nl nm ld nn no np nq bi translated"><strong class="ak">简单英语团队的通知</strong></h2><p id="39c6" class="pw-post-body-paragraph km kn iq ko b kp nr jr kr ks ns ju ku kv nt kx ky kz nu lb lc ld nv lf lg lh ij bi translated">你知道我们有四种出版物吗？给他们一个如下的提示来表达爱意:<a class="ae ly" href="https://medium.com/javascript-in-plain-english" rel="noopener"> <strong class="ko ir">简单的JavaScript</strong></a>、<a class="ae ly" href="https://medium.com/ai-in-plain-english" rel="noopener">、<strong class="ko ir">简单的AI</strong>、</a>、<a class="ae ly" href="https://medium.com/ux-in-plain-english" rel="noopener">、<strong class="ko ir">简单的UX</strong>、</a>、<a class="ae ly" href="https://medium.com/python-in-plain-english" rel="noopener">、<strong class="ko ir">简单的Python</strong>、</a>、<strong class="ko ir">、</strong>——谢谢你，继续学习吧！</p><p id="a747" class="pw-post-body-paragraph km kn iq ko b kp kq jr kr ks kt ju ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">此外，我们一直对帮助推广好的内容感兴趣。如果您有任何想提交给我们的出版物的文章，请发邮件至<a class="ae ly" href="mailto:submissions@plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="ko ir">submissions @ plain English . io</strong></a><strong class="ko ir"/>并附上您的Medium用户名和您感兴趣的文章，我们将回复您！</p></div></div>    
</body>
</html>