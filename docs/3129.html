<html>
<head>
<title>Debugging NestJS in VSCode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在VSCode中调试NestJS</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/debugging-nestjs-in-vscode-d474a088c63b?source=collection_archive---------0-----------------------#2020-09-01">https://javascript.plainenglish.io/debugging-nestjs-in-vscode-d474a088c63b?source=collection_archive---------0-----------------------#2020-09-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4cfa" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用VSCode调试NestJS应用程序和Jest测试的分步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d463ba4786c1068b6540f38078ab15a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pmiPNItzJ0vjTwKS"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@olav_ahrens?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Olav Ahrens Røtne</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d335" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文将介绍用VSCode调试NestJS应用程序的三种不同技术。</p><p id="7900" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要快速了解NestJS，<a class="ae kv" href="https://codeburst.io/why-you-should-use-nestjs-for-your-next-project-6a0f6c993be" rel="noopener" target="_blank">请查看本文</a>。</p><p id="7301" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Visual Studio Code，或称VSCode，是一个轻量级的源代码编辑器，支持跨平台，拥有令人印象深刻的各种功能。这些特性中包括用于调试应用程序的优秀工具，包括对Node.js和TypeScript的内置支持。</p><p id="75ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然<a class="ae kv" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank"> NestJS文档</a>很全面，但是它目前还没有深入讨论的一件事是调试。</p><p id="e00a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">幸运的是，VSCode使得调试NestJS应用程序代码和使用<a class="ae kv" href="https://jestjs.io/docs/en/getting-started" rel="noopener ugc nofollow" target="_blank"> Jest测试框架</a>编写的测试变得非常简单。所需要的只是一点点调整。</p><p id="415b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记住这一点，让我们开始吧。</p><h1 id="abb4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">方法1:启动配置</h1><p id="6547" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">第一种方法依赖于工作空间根目录下的<code class="fe mp mq mr ms b">.vscode/ </code>目录中包含的<code class="fe mp mq mr ms b">launch.json</code>文件。</p><p id="2e1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个JSON文件提供了VSCode在确定如何正确调试应用程序时使用的配置信息。</p><p id="19f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看<a class="ae kv" href="https://code.visualstudio.com/docs/editor/debugging#_launchjson-attributes" rel="noopener ugc nofollow" target="_blank">这些文档</a>了解更多关于配置<code class="fe mp mq mr ms b">launch.json</code>文件的信息。</p><p id="bdda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">JSON文件将如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Launch configuration for debugging NestJS</figcaption></figure><p id="7712" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的文件中发生了很多事情，所以让我们逐个属性地分解它:</p><ul class=""><li id="59f4" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated"><strong class="ky ir">类型</strong>–指示要使用的调试器的类型。在我们的例子中，它是<code class="fe mp mq mr ms b">node</code>，但是如果你有Go的调试扩展，你可以把它设置为<code class="fe mp mq mr ms b">go</code>，等等。</li><li id="cb67" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">请求</strong>–配置的请求类型。这可以是<code class="fe mp mq mr ms b">launch</code>或<code class="fe mp mq mr ms b">attach</code>(启动新流程或附加到现有流程)</li><li id="ca3c" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">name</strong>–您希望与您的调试配置相关联的名称</li><li id="4d05" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">args–</strong>传递给正在调试的程序的参数。在这种情况下，我们提供了到我们的<code class="fe mp mq mr ms b">main.ts</code>文件的路径，这是应用程序的入口点</li><li id="3b41" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">runtime args–</strong>传递给运行时可执行文件的可选参数。因为我们直接向Node.js提供了一个TypeScript文件，所以我们使用<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.npmjs.com/package/ts-node" rel="noopener ugc nofollow" target="_blank">ts-node</a></code>来运行该文件，而不需要手动使用TypeScript编译器</li><li id="84a8" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">源地图–</strong>如果找到，使用源地图。这很重要，因为它允许我们单步执行原始的类型脚本代码，而不是编译的JavaScript</li><li id="fb2f" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">env file-</strong>一个<code class="fe mp mq mr ms b">.env</code>文件的可选路径。如果您的应用程序依赖于存储在<code class="fe mp mq mr ms b">.env</code>文件中的环境变量，这是必要的</li><li id="2a2f" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">用于查找依赖项和其他文件的当前工作目录</li><li id="4722" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">控制台—</strong>显示调试输出时使用哪个控制台。在这种情况下，我们表示希望在VSCode中使用集成终端</li><li id="85ad" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><strong class="ky ir">协议—</strong>使用哪个Node.js调试运行时协议。<code class="fe mp mq mr ms b">inspector</code>协议是最新的</li></ul><p id="a665" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要使用这种<code class="fe mp mq mr ms b">launch.json</code>配置，首先在应用程序代码中的某个地方设置一个断点。</p><p id="f6cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，通过单击图标或使用键盘快捷键(<code class="fe mp mq mr ms b">ctrl+shift+D</code> / <code class="fe mp mq mr ms b">cmd+shift+D</code>)导航到VSCode活动栏中的debug窗格。</p><p id="9c4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，从下拉菜单中选择<code class="fe mp mq mr ms b">Debug NestJS Framework</code>配置，并通过点击开始图标或使用键盘快捷键(F5)运行调试器。</p><p id="023d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，代码应该在断点处暂停，允许您进行调试。</p><h1 id="4e13" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">方法2: Nodemon</h1><p id="70d1" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">调试NestJS的第二种方法是将<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.npmjs.com/package/nodemon" rel="noopener ugc nofollow" target="_blank">nodemo</a>n</code>与VSCode的<a class="ae kv" href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_auto-attach-feature" rel="noopener ugc nofollow" target="_blank">自动附加特性</a>结合使用。</p><p id="1bd2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为快速复习，<code class="fe mp mq mr ms b">nodemon</code>是一个NPM包，在开发Node.js应用程序时很有帮助。当检测到对源代码文件的更改时，它会自动重新启动应用程序。</p><p id="09c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要通过运行<code class="fe mp mq mr ms b">npm i --save-dev nodemon</code>来确保我们已经将<code class="fe mp mq mr ms b">nodemon</code>安装为开发依赖项。</p><p id="cc70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这个，我们还需要在我们的<code class="fe mp mq mr ms b">package.json</code>中有一个npm脚本来运行<code class="fe mp mq mr ms b">nodemon</code>。</p><p id="6146" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">具体来说，我们加上<code class="fe mp mq mr ms b">"start:debug": "nodemon --config nodemon-debug.json"</code>。</p><p id="8484" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要上面脚本中引用的<code class="fe mp mq mr ms b">nodemon-debug.json</code>文件，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Nodemon debugging configuration</figcaption></figure><p id="bcd6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的配置文件告诉<code class="fe mp mq mr ms b">nodemon</code>做以下事情:</p><ul class=""><li id="8782" class="mv mw iq ky b kz la lc ld lf mx lj my ln mz lr na nb nc nd bi translated">观察<code class="fe mp mq mr ms b">src/</code>目录中的代码是否有变化</li><li id="e261" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">寻找扩展名为<code class="fe mp mq mr ms b">.ts</code>的文件</li><li id="c449" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">忽略<code class="fe mp mq mr ms b">src/</code>目录中任何以<code class="fe mp mq mr ms b">.spec.ts</code>结尾的文件(我们的测试文件)</li><li id="e603" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated">执行命令。在上面，我们使用Node.js运行时以及<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.npmjs.com/package/ts-node" rel="noopener ugc nofollow" target="_blank">ts-node</a></code>在调试模式下运行我们的应用程序</li></ul><p id="d7af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后一步是启用VSCode的自动附加功能。此功能会自动将VSCode调试器连接到集成终端中已启动的任何Node.js进程。</p><p id="5fa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<a class="ae kv" href="https://code.visualstudio.com/docs/getstarted/userinterface#_command-palette" rel="noopener ugc nofollow" target="_blank">命令面板</a> ( <code class="fe mp mq mr ms b">ctrl+shift+P</code> / <code class="fe mp mq mr ms b">cmd+shift+P</code>)并选择<code class="fe mp mq mr ms b">Toggle Auto Attach</code>可以打开该功能。</p><p id="aeaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您现在可以设置一个断点，在集成终端中运行<code class="fe mp mq mr ms b">npm run start:debug</code>，并调试您的应用程序。</p><h1 id="58ac" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">方法3:启动Jest的配置</h1><p id="446d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">最后一种方法将包括使用<code class="fe mp mq mr ms b">launch.json</code>中的新配置在您的NestJS应用程序中调试Jest测试。</p><p id="dbbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要添加到<code class="fe mp mq mr ms b">launch.json</code>文件中用于调试Jest的配置如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Launch configuration for debugging Jest tests</figcaption></figure><p id="72d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个配置类似于我们用于调试NestJS应用程序代码的第一个配置，尽管这次它将<code class="fe mp mq mr ms b">node_modules/.bin/</code>中Jest可执行文件的路径传递给Node.js运行时。</p><p id="3bb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还指示Jest串行运行测试(而不是缺省的并发),给定数组<code class="fe mp mq mr ms b">runtimeArgs</code>中的<code class="fe mp mq mr ms b">--runInBand</code>标志。当调试给定的<code class="fe mp mq mr ms b">--coverage</code>设置为false时，我们选择不收集测试覆盖率。</p><p id="aae4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这个配置集，我们可以在测试文件中的任何地方设置断点，并运行VSCode调试器(假设您已经从活动栏的调试窗格的下拉列表中选择了新的<code class="fe mp mq mr ms b">Debug Jest Tests</code>配置)。</p><h1 id="58c8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结束语</h1><p id="32a7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">虽然quick <code class="fe mp mq mr ms b">console.log</code>语句通常对快速调试任务很有用，但在调试大型、更复杂的问题时，它的伸缩性并不好。这种情况下，健壮的调试设置就派上了用场。</p><p id="a5ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑到框架对类型脚本和依赖注入的使用，调试NestJS可能是一个挑战。对我们来说幸运的是，VSCode的调试工具使这种体验相对轻松。</p><p id="6b68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望这篇文章能提供信息，并简化下一个NestJS项目的调试。</p><p id="d031" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一如既往，我很乐意听到任何关于NestJS/VSCode/debugging的想法和反馈。下次见，感谢阅读。</p><h1 id="e52c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考</h1><ul class=""><li id="72b4" class="mv mw iq ky b kz mk lc ml lf nj lj nk ln nl lr na nb nc nd bi translated"><a class="ae kv" href="https://github.com/nmchenry01/nestjs-blogs/tree/debugging-nestjs" rel="noopener ugc nofollow" target="_blank">本文源代码</a></li><li id="2814" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><a class="ae kv" href="https://codeburst.io/why-you-should-use-nestjs-for-your-next-project-6a0f6c993be" rel="noopener" target="_blank">NestJS简介</a></li><li id="e93e" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><a class="ae kv" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank"> NestJS文档</a></li><li id="39d7" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><a class="ae kv" href="https://code.visualstudio.com/docs" rel="noopener ugc nofollow" target="_blank"> VSCode文档</a></li><li id="1662" class="mv mw iq ky b kz ne lc nf lf ng lj nh ln ni lr na nb nc nd bi translated"><a class="ae kv" href="https://jestjs.io/docs/en/getting-started" rel="noopener ugc nofollow" target="_blank"> Jest文档</a></li></ul></div></div>    
</body>
</html>