<html>
<head>
<title>How To Easily Persist Your Data With Context And AsyncStorage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过上下文和异步存储轻松持久化数据</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-easily-persist-your-data-with-context-and-asyncstorage-99d26d331992?source=collection_archive---------1-----------------------#2020-10-11">https://javascript.plainenglish.io/how-to-easily-persist-your-data-with-context-and-asyncstorage-99d26d331992?source=collection_archive---------1-----------------------#2020-10-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="7b02" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">学习在React Native中使用钩子和异步存储</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/1c4d17804c63bab62c9e89b2906ece2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-8uombwBQ_OJzCpcxBDnQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">cat in a box</figcaption></figure><p id="be52" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">在大多数移动应用程序中，在会话之间持久保存用户数据是一种相当常见的做法，使用<a class="ae lo" href="https://reactnative.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> React Native </strong> </a>来完成这一点就像使用<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> AsyncStorage </strong> </a>一样简单。这将允许您保留对任何组件的更改或更新，即使应用程序重新启动、刷新或关闭。</p><p id="ef9e" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">以这个计数器为例，如果您增加或减少计数并重新启动应用程序，计数将重置为零。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="bade" class="lu lv in lq b gy lw lx l ly lz">import React, { useContext, createContext, useState } from 'react';<br/>import { View, Button, StyleSheet, Text } from 'react-native';</span><span id="8dd0" class="lu lv in lq b gy ma lx l ly lz">const CounterContext = createContext(0);</span><span id="d93b" class="lu lv in lq b gy ma lx l ly lz">const useCounter = () =&gt; useContext(CounterContext);</span><span id="3e36" class="lu lv in lq b gy ma lx l ly lz">const CounterContextProvider = ({ children }) =&gt; {<br/>  const [count, setCount] = useState(0);<br/>  const increment = () =&gt; setCount((value) =&gt; value + 1);<br/>  const decrement = () =&gt; setCount((value) =&gt; value - 1);</span><span id="9c45" class="lu lv in lq b gy ma lx l ly lz">return (<br/>    &lt;CounterContext.Provider <br/>      value={{ <br/>        count, <br/>        increment, <br/>        decrement<br/>       }}&gt;<br/>         {children}<br/>    &lt;/CounterContext.Provider&gt;<br/>  );<br/>};</span><span id="a129" class="lu lv in lq b gy ma lx l ly lz">const App = () =&gt; {<br/>  const { count, increment, decrement } = useCounter();</span><span id="aa81" class="lu lv in lq b gy ma lx l ly lz">  return (<br/>    &lt;View <br/>      style={styles.container}&gt;<br/>      &lt;Text&gt;{count}&lt;/Text&gt;<br/>      &lt;Button title="Increment" onPress={() =&gt; increment()} /&gt;<br/>      &lt;Button title="Decrement" onPress={() =&gt; decrement()} /&gt;<br/>    &lt;/View&gt;<br/>  );<br/>};</span><span id="fede" class="lu lv in lq b gy ma lx l ly lz">const styles = StyleSheet.create({   <br/>  container: {     <br/>    flex: 1,     <br/>    alignItems: 'center',     <br/>    justifyContent: 'center',   <br/>  }<br/>});</span><span id="b6d2" class="lu lv in lq b gy ma lx l ly lz">export default () =&gt; (<br/>  &lt;CounterContextProvider&gt;<br/>    &lt;App /&gt;<br/>  &lt;/CounterContextProvider&gt;<br/>);</span></pre><p id="be5b" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">为了解决这个问题，让我们实现<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> AsyncStorage </strong> </a>。</p><p id="4c06" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">首先用<a class="ae lo" href="https://reactjs.org/docs/hooks-effect.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> useEffect </strong> </a>钩子将计数值存储在<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> AsyncStorage </strong> </a>中，并添加计数作为依赖项。通过这样做，每次计数值被更新时，它将被存储。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="be64" class="lu lv in lq b gy lw lx l ly lz">import React, { useContext, createContext, useState, useEffect } from 'react';<br/>import { View, Button, StyleSheet, Text } from 'react-native';<br/>import AsyncStorage from '<a class="ae lo" href="http://twitter.com/react" rel="noopener ugc nofollow" target="_blank">@react</a>-native-community/async-storage';</span><span id="65f8" class="lu lv in lq b gy ma lx l ly lz">// ...</span><span id="e853" class="lu lv in lq b gy ma lx l ly lz">const CounterContextProvider = ({ children }) =&gt; {<br/>  const [count, setCount] = useState(0);<br/>  const increment = () =&gt; setCount((value) =&gt; value + 1);<br/>  const decrement = () =&gt; setCount((value) =&gt; value - 1);<br/>  <br/>  useEffect(() =&gt; {<br/>    AsyncStorage.setItem('COUNTER_APP::COUNT_VALUE', `${count}`);<br/>  }, [count]);</span><span id="bb80" class="lu lv in lq b gy ma lx l ly lz">  return (<br/>    &lt;CounterContext.Provider <br/>      value={{ <br/>        count, <br/>        increment, <br/>        decrement<br/>    }}&gt;<br/>      {children}<br/>    &lt;/CounterContext.Provider&gt;<br/>  );<br/>};</span><span id="0408" class="lu lv in lq b gy ma lx l ly lz">// ...</span></pre><p id="f6c5" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">不要忘记在存储之前将值转换成字符串。</p><p id="38ee" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">现在从<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> AsyncStorage </strong> </a>中检索已有数据的状态。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="5507" class="lu lv in lq b gy lw lx l ly lz">const INITIAL_COUNT = 0;</span><span id="0544" class="lu lv in lq b gy ma lx l ly lz">const CounterContextProvider = ({ children }) =&gt; {<br/>  const [count, setCount] = useState(INITIAL_COUNT);<br/>  const increment = () =&gt; setCount((value) =&gt; value + 1);<br/>  const decrement = () =&gt; setCount((value) =&gt; value - 1);</span><span id="5e5b" class="lu lv in lq b gy ma lx l ly lz">  useEffect(() =&gt; {<br/>    AsyncStorage.getItem('COUNTER_APP::COUNT_VALUE')<br/>      .then((value) =    { <br/>        if (value) {<br/>        setCount(parseInt(value));<br/>      }<br/>    });<br/>  }, []);</span><span id="e1a3" class="lu lv in lq b gy ma lx l ly lz">  useEffect(() =&gt; {<br/>    if (count !== INITIAL_COUNT) {<br/>      AsyncStorage.setItem('COUNTER_APP::COUNT_VALUE', `${count}`);<br/>    }<br/>  }, [count]);</span><span id="f82a" class="lu lv in lq b gy ma lx l ly lz">return (<br/>    &lt;CounterContext.Provider <br/>      value={{ <br/>        count, <br/>        increment, <br/>        decrement<br/>      }}&gt;<br/>        {children}<br/>    &lt;/CounterContext.Provider&gt;<br/>  );<br/>};</span><span id="0729" class="lu lv in lq b gy ma lx l ly lz">// ...</span></pre><p id="ddf7" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">请注意，新的<a class="ae lo" href="https://reactjs.org/docs/hooks-effect.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> useEffect </strong> </a>钩子从<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> AsyncStorage </strong> </a>中检索数据将只在挂载时运行，因为它没有依赖关系；它获取现有值，并在用该值更新计数之前将其解析为一个整数。</p><p id="b8eb" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">此外，现有的<a class="ae lo" href="https://reactjs.org/docs/hooks-effect.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io">使用效果</strong> </a>将数据存储在<a class="ae lo" href="https://github.com/react-native-community/async-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io">异步存储</strong> </a>中，现在检查以确保存储的值不会被状态中的初始值覆盖。</p><p id="28e4" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">这种基本模式很容易扩展到存储更复杂的JSON对象。</p><p id="9af9" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">这里是<strong class="ku io">最终代码</strong>供你参考。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="88dd" class="lu lv in lq b gy lw lx l ly lz">// App.js<br/>import React, { useContext, createContext, useState, useEffect } from 'react';<br/>import { View, TouchableOpacity, StyleSheet, Text } from 'react-native';<br/>import AsyncStorage from '<a class="ae lo" href="http://twitter.com/react" rel="noopener ugc nofollow" target="_blank">@react</a>-native-community/async-storage';</span><span id="ffb6" class="lu lv in lq b gy ma lx l ly lz">const CounterContext = createContext(0);<br/>const useCounter = () =&gt; useContext(CounterContext);<br/>const CounterContextProvider = ({ children }) =&gt; {<br/>  const [count, setCount] = useState(0);</span><span id="709a" class="lu lv in lq b gy ma lx l ly lz">  const increment = () =&gt; {<br/>    setCount((value) =&gt; value + 1);<br/>  };</span><span id="f5b4" class="lu lv in lq b gy ma lx l ly lz">  const decrement = () =&gt; setCount((value) =&gt; value - 1);<br/>  <br/>  useEffect(() =&gt; {<br/>    if (count !== 0) {<br/>      AsyncStorage.setItem('COUNTER_APP::COUNT_VALUE', `${count}`);<br/>    }<br/>  }, [count]);</span><span id="9fa7" class="lu lv in lq b gy ma lx l ly lz">  useEffect(() =&gt; {<br/>    AsyncStorage.getItem('COUNTER_APP::COUNT_VALUE')<br/>    .then((value) =&gt; {<br/>      if (value) {<br/>        setCount(parseInt(value));<br/>      }<br/>    });<br/>  }, []);<br/>  <br/>  return (<br/>    &lt;CounterContext.Provider<br/>      value={{<br/>        count,<br/>        increment,<br/>        decrement,<br/>      }}&gt;<br/>      {children}<br/>    &lt;/CounterContext.Provider&gt;<br/>  );<br/>};</span><span id="6719" class="lu lv in lq b gy ma lx l ly lz">const App = () =&gt; {<br/>  const { count, increment, decrement } = useCounter();<br/>  return (<br/>    &lt;View style={styles.container}&gt;<br/>      &lt;Text style={styles.counterText}&gt;{count}&lt;/Text&gt;<br/>      &lt;View style={styles.group}&gt;<br/>        &lt;TouchableOpacity <br/>          onPress={() =&gt; increment()} <br/>          style={styles.button}&gt;<br/>          &lt;Text style={styles.buttonTitle}&gt;+&lt;/Text&gt;<br/>        &lt;/TouchableOpacity&gt;<br/>        &lt;TouchableOpacity <br/>          onPress={() =&gt; decrement()} <br/>          style={styles.button}&gt;<br/>          &lt;Text style={styles.buttonTitle}&gt;-&lt;/Text&gt;<br/>        &lt;/TouchableOpacity&gt;<br/>      &lt;/View&gt;<br/>    &lt;/View&gt;<br/>  );<br/>};</span><span id="9ada" class="lu lv in lq b gy ma lx l ly lz">const styles = StyleSheet.create({<br/>  container: {<br/>    flex: 1,<br/>    alignItems: 'center',<br/>    justifyContent: 'center',<br/>  },<br/>  button: {<br/>    backgroundColor: '#ff5f00',<br/>    width: 45,<br/>    justifyContent: 'center',<br/>    alignItems: 'center',<br/>    marginVertical: 8,<br/>    marginHorizontal: 8,<br/>  },<br/>  buttonTitle: {<br/>    fontSize: 34,<br/>    color: '#FFF',<br/>  },<br/>  counterText: {<br/>    fontSize: 24,<br/>  },<br/>  group: {<br/>    flexDirection: 'row',<br/>  },<br/>});</span><span id="7ee8" class="lu lv in lq b gy ma lx l ly lz">export default () =&gt; (<br/>  &lt;CounterContextProvider&gt;<br/>    &lt;App /&gt;<br/>  &lt;/CounterContextProvider&gt;<br/>);</span></pre><p id="008d" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">谢谢，别忘了在<a class="ae lo" href="https://twitter.com/useEffectReact" rel="noopener ugc nofollow" target="_blank"> <strong class="ku io"> Twitter </strong> </a>上关注我，你可以对这篇文章发表评论或提出问题。</p></div></div>    
</body>
</html>