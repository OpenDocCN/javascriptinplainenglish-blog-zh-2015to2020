<html>
<head>
<title>Build Two-factor Authentication in Angular with Twilio Authy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Twilio Authy在Angular中构建双因素身份验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-two-factor-authentication-in-angular-with-twilio-authy-b94f700d1866?source=collection_archive---------0-----------------------#2019-11-07">https://javascript.plainenglish.io/build-two-factor-authentication-in-angular-with-twilio-authy-b94f700d1866?source=collection_archive---------0-----------------------#2019-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b881998e193a4aa0c2f806d9c8abbea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4two647hrlMctXd1.jpg"/></div></div></figure><p id="59f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用户身份验证是许多Angular应用程序的关键要求，简单地使用用户ID和密码登录越来越不够安全。双因素身份认证(2FA)提供了基于设备的安全性，这大大增加了黑客攻击的难度，但构建自己的2FA系统是一项艰巨的挑战。<a class="ae kw" href="https://www.twilio.com/docs/authy" rel="noopener ugc nofollow" target="_blank"> Twilio Authy </a>让给Angular应用添加2FA变得很容易。</p><p id="afce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章将向你展示如何添加Authy到你的Angular项目中。您还将了解如何通过使用Angular Universal实现登录过程来改善用户体验和应用程序的安全性。</p><p id="409a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本帖中，我们将:</p><ul class=""><li id="193f" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">创建一个带有登录页面的基本Angular应用程序</li><li id="e370" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">建立授权保护服务和授权服务</li><li id="a2eb" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用<a class="ae kw" href="https://angular.io/guide/universal" rel="noopener ugc nofollow" target="_blank">角度通用</a>添加服务器端渲染</li><li id="0c43" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">设置服务器端身份验证</li><li id="723a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用<a class="ae kw" href="https://www.twilio.com/authy" rel="noopener ugc nofollow" target="_blank"> Twilio Authy </a>实施双因素认证</li></ul><h1 id="df98" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用Angular和Authy进行构建的先决条件</h1><p id="741a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">为了完成这篇文章中的任务，你需要:</p><ul class=""><li id="502c" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js和npm</a>(node . js安装也会安装NPM。)</li><li id="a8a3" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://cli.angular.io/" rel="noopener ugc nofollow" target="_blank">角度CLI </a></li><li id="841d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">Twilio账户(<a class="ae kw" href="https://www.twilio.com/try-twilio" rel="noopener ugc nofollow" target="_blank">注册</a>免费账户。)</li></ul><p id="f627" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些工具在说明中有提及，但不是必需的:</p><ul class=""><li id="6cca" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank"> Git </a></li></ul><p id="343e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要从这篇文章中最有效地学习，你应该具备以下条件:</p><ul class=""><li id="2a80" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">打字稿和角度框架的工作知识</li><li id="ee90" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">熟悉角度观察值、依赖注入和管道</li></ul><p id="59fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://github.com/maciejtreder/angular-twilio-authy" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上有这篇文章的配套项目。本文中的每个主要步骤在存储库中都有自己的分支。</p><h1 id="6518" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建角度项目并生成零部件</h1><p id="fdf4" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">每个Angular项目都是从必要的包的初始化和安装开始的。</p><p id="96da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到您想要创建项目的目录，并输入以下命令行指令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="33c9" class="mx lm iq mt b gy my mz l na nb">ng new angular-twilio-authy --style css --routing true<br/>cd angular-twilio-authy/<br/>ng g c loginPage --spec false<br/>ng g c protectedPage --spec false</span></pre><p id="d536" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">前面的命令创建了应用程序并生成了两个组件:</p><ul class=""><li id="fef2" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><code class="fe nc nd ne mt b">LoginPageComponent</code>用于收集用户ID和密码的表单</li><li id="765e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nc nd ne mt b">ProtectedPageComponent</code>将成为<code class="fe nc nd ne mt b">home</code>路径目标的页面。</li></ul><p id="d37b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该应用程序将使用一项服务来确定用户是否有权访问应用程序中的特定页面，如页面<code class="fe nc nd ne mt b">ProtectedPageComponent</code>。</p><p id="cf53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在命令行输入以下内容生成<code class="fe nc nd ne mt b">AuthService</code>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="5d0f" class="mx lm iq mt b gy my mz l na nb">ng g s auth --spec false</span></pre><p id="9e87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过用以下代码替换<em class="nf">src/app/auth . service . ts</em>的内容来实现服务:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="333f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe nc nd ne mt b">auth</code>方法中，为了简单起见，用户ID、<code class="fe nc nd ne mt b">login</code>和<code class="fe nc nd ne mt b">password</code>的值是硬编码的。在生产应用程序中，在/ <em class="nf"> login </em>页面上收集并传递给方法的值将根据从持久数据存储(如数据库)中检索的数据进行验证。</p><p id="95af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果凭证被验证，布尔标志<code class="fe nc nd ne mt b">authenticated</code>被设置为真，并且用户被重定向到由<code class="fe nc nd ne mt b">AuthGuardService</code>传递的URL。</p><p id="38d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一种服务称为<em class="nf">路由保护</em>，如果<code class="fe nc nd ne mt b">AuthService</code>提供的值不是<code class="fe nc nd ne mt b">true</code>，它会将用户从受保护的组件重定向到/ <em class="nf">登录</em>路由。用这个命令创建<code class="fe nc nd ne mt b">AuthGuardComponent</code>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="5ecb" class="mx lm iq mt b gy my mz l na nb">ng g s authGuard --spec false</span></pre><p id="67b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过用以下代码替换<em class="nf">src/app/auth-guard . service . ts</em>中的现有代码来实现服务:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="1544" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nc nd ne mt b">AuthGuardService</code>类实现了<code class="fe nc nd ne mt b">CanActivate</code>接口，该接口指定了<code class="fe nc nd ne mt b">public canActivate(): boolean</code>方法。该方法使用<code class="fe nc nd ne mt b">AuthService</code>来确定用户是否被认证。如果没有，该方法将调用<code class="fe nc nd ne mt b">AuthGuardService</code>的路由URL传递给<code class="fe nc nd ne mt b">AuthService</code>并返回<code class="fe nc nd ne mt b">false</code>。当用户成功登录时,<code class="fe nc nd ne mt b">AuthService</code>会自动将他们引导至登录前想要到达的页面。如果用户通过了身份验证，该方法返回<code class="fe nc nd ne mt b">true</code>，使用户能够导航到组件。</p><p id="2cad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nc nd ne mt b">LoginPageComponent</code>、<code class="fe nc nd ne mt b">ProtectedPageComponent</code>和<code class="fe nc nd ne mt b">AuthGuardService</code>需要添加到应用程序路由中。用以下内容替换<em class="nf">src/app/app-routing . module . ts</em>的内容:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="97b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用程序的路由现在包括一个/ <em class="nf">登录</em>路径和一个/ <em class="nf">主页</em>路径，它们使用了前面创建的组件。还有一个将根URL重定向到/ <em class="nf"> home </em>路径的路由。</p><p id="440e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">/ <em class="nf"> home </em>路径使用受<code class="fe nc nd ne mt b">AuthGuardService</code>服务保护的<code class="fe nc nd ne mt b">ProtectedPageComponent</code>，如下所示:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a4f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当用户导航到应用程序的基本URL(www.example.com)或/ <em class="nf"> home </em>路径时，Angular触发<code class="fe nc nd ne mt b">canActivate</code>方法，该方法决定用户是否被允许打开给定的资源。</p><p id="9a3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了简化应用程序呈现的HTML，从<em class="nf">src/app/app . component . HTML</em>中移除所有HTML元素，以下元素除外:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="edd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，用以下内容替换<em class="nf">src/app/log in-page/log in-page . component . html</em>中的登录页面模板:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="6164" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录页面的逻辑需要反映页面的设计并实现<code class="fe nc nd ne mt b">AuthService</code>。将<em class="nf">src/app/log in-page/log in-page . component . ts</em>的内容替换为:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="d0c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为登录组件使用了<a class="ae kw" href="https://angular.io/guide/reactive-forms" rel="noopener ugc nofollow" target="_blank">反应式表单</a>的概念，所以<code class="fe nc nd ne mt b">ReactiveFormsModule</code>需要包含在app入口点中。这需要对<em class="nf"> src/app/app.module.ts </em>文件进行两处修改。</p><ol class=""><li id="a2ce" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ni ld le lf bi translated">将下面一行添加到文件的顶部:</li></ol><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="76a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.通过添加ReactiveFormsModule来更新imports部分，如下所示:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="61c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在命令行输入以下命令，验证应用程序是否正在运行:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6daf" class="mx lm iq mt b gy my mz l na nb">ng serve</span></pre><p id="d01f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开浏览器的开发工具(F12)并导航至<a class="ae kw" href="http://localhost:4200" rel="noopener ugc nofollow" target="_blank"> http://localhost:4200 </a>。您应该会看到类似下面的内容:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/3e224e5fadbc029472af3793099e98a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HLPDbTexIp6SYBVE.png"/></div></div></figure><p id="2e38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">刚刚发生了什么？您导航到应用程序的根路径，该路径将您重定向到/ <em class="nf"> home </em>路径，该路径由<code class="fe nc nd ne mt b">AuthGuardService</code>保护。因为您尚未获得授权，所以您被重定向至<em class="nf">/登录</em>路径。</p><p id="4a0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输入登录凭证(login: foo和password: bar)并提交表单:您应该看到您已经被重定向到<em class="nf"> /home </em>路径，并显示来自<em class="nf">protected-page.component.html</em>的HTML。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/bcf7428ec84cbfc43188c1d0d8d1d000.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sS2j7TgtWkoO5XRS.png"/></div></div></figure><p id="75f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回想一下，<code class="fe nc nd ne mt b">ProtectedPageComponent</code>是作为<em class="nf"> app-routing.module.ts </em>中/ <em class="nf"> home </em>路由的目标提供的，并且登录凭证是硬编码在<em class="nf"> server.ts </em>中的。</p><p id="ad55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想赶上这一步，您可以克隆配套GitHub库的这个分支，并通过在您想要构建项目的目录中执行下面的命令来运行应用程序。(您需要在您的机器上安装Git来克隆存储库。)</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="94d2" class="mx lm iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/angular-twilio-authy.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/angular-twilio-authy.git</a><br/>cd angular-twilio-authy<br/>git co step1<br/>npm install <br/>ng serve</span></pre><h1 id="6f5b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">将用户验证移至服务器</h1><p id="5688" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">将身份验证逻辑保留在浏览器中并不是一个好主意。在这一步中，我们将通过<a class="ae kw" href="https://www.twilio.com/blog/faster-javascript-web-apps-angular-universal-transferstate-api-watchdog" rel="noopener ugc nofollow" target="_blank">添加角形通用支架</a>来“在一个火上烤两次”。使用角度通用(AU)将:</p><ol class=""><li id="1887" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ni ld le lf bi translated">通过减少到第一次有意义的绘制<a class="ae kw" href="https://developers.google.com/web/tools/lighthouse/audits/first-meaningful-paint" rel="noopener ugc nofollow" target="_blank">和</a>的时间，改善用户体验并增强搜索引擎优化(SEO)</li><li id="0ac9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">将授权和身份验证逻辑移到应用程序的服务器端，以获得更高的安全性。</li></ol><p id="760b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过输入以下命令，使用<a class="ae kw" href="https://github.com/maciejtreder/ng-toolkit" rel="noopener ugc nofollow" target="_blank"> @ng-toolkit </a>安装角形万向支架:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="afc2" class="mx lm iq mt b gy my mz l na nb">ng add @ng-toolkit/universal</span></pre><p id="55e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">已经在应用程序前端的浏览器中运行的/ <em class="nf">登录</em>路径需要替换为服务器后端的<em class="nf"> /auth/login </em>端点。用以下内容替换<em class="nf">/angular-twilio-authy/server . ts</em>文件中的代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="0c0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些更改创建了一个<code class="fe nc nd ne mt b">HttpPost</code>端点<em class="nf">/认证/登录</em>，它根据应用程序已知的值来验证用户提供的凭证，如下所示。尽管登录凭证在这里是硬编码的，但是在生产应用程序中，通常会使用查询针对持久性数据存储对它们进行验证。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="be7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用程序中的<code class="fe nc nd ne mt b">AuthService</code>将消耗服务器的<em class="nf"> /auth/login </em>端点。要更改<code class="fe nc nd ne mt b">AuthService</code>的实现，请用以下代码替换<em class="nf">src/app/auth . service . ts</em>文件中的代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="8541" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为<code class="fe nc nd ne mt b">auth</code>方法不再返回<code class="fe nc nd ne mt b">void</code>，现在返回一个<code class="fe nc nd ne mt b">Observable</code>，所以<code class="fe nc nd ne mt b">LoginComponent</code>需要订阅它。将<em class="nf">src/app/log in-page/log in-page . component . ts</em>文件中<code class="fe nc nd ne mt b">onSubmit()</code>方法的实现修改如下:</p><p id="d72b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(<strong class="ka ir">注意:代码块中的</strong>省略号(<code class="fe nc nd ne mt b">...</code>))表示为了简洁而编辑的一段代码。)</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a073" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在是检查应用程序是否按预期工作的好时机。使用以下命令编译并运行服务器:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="d9cc" class="mx lm iq mt b gy my mz l na nb">npm run build:prod<br/>npm run server</span></pre><p id="cee1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在浏览器中打开开发工具(F12)并选择网络选项卡，这样您就可以看到浏览器和服务器之间的通信。导航到<a class="ae kw" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>。单页应用程序(SPA)将从后端提供服务。记下最初为页面提供服务时加载的资源，如下图所示。</p><p id="5851" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输入登录凭证，并观察开发人员工具的网络选项卡中的变化。您应该看到浏览器中运行的SPA已经对<em class="nf"> /auth/login </em>端点执行了REST调用，并返回了状态代码<code class="fe nc nd ne mt b">200 (OK)</code>。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/932aa8d0e061efccc88b3fa78d4873e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*xJpW713ihnMxfMRq"/></div></figure><p id="ad37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想赶上这一步，请运行以下命令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="969e" class="mx lm iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/angular-twilio-authy.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/angular-twilio-authy.git</a><br/>cd angular-twilio-authy<br/>git co step2<br/>npm install <br/>npm run build:prod<br/>npm run server</span></pre><p id="e458" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(请注意，运行应用程序的命令与上次运行时不同。)</p><h1 id="ddc6" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">在Angular中实现双因素身份认证</h1><p id="a347" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">应用程序现在有了一个安全的服务器端身份验证系统。但是它依赖于一个单一的因素，即用户拥有的用户ID和密码。这是用户<em class="nf">知道</em>的一个因素。众所周知，这些凭证很容易受到各种方式的破坏和滥用，那么如何使应用程序更加安全呢？</p><p id="75e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最好的方法之一是实现第二认证因子。</p><p id="bc5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了用户<em class="nf">知道</em>的东西，双因素认证还需要用户<em class="nf">拥有</em>(占有)或者<em class="nf">是</em>(继承)的东西。</p><p id="28e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生物认证通过要求用户的独特物理特征(如指纹或视网膜图案)来建立他们的身份，从而实现了继承。这种方法非常安全，但是可能需要昂贵的专用硬件。</p><h1 id="6105" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Twilio Authy用于双因素身份验证</h1><p id="83b9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><a class="ae kw" href="https://www.twilio.com/authy" rel="noopener ugc nofollow" target="_blank"> Twilio Authy </a>通过<em class="nf">拥有</em>提供了第二个因素，通过几乎每个用户<em class="nf">都拥有的东西</em>:手机(或其他设备)。</p><p id="65a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果手机使用面部识别或指纹解锁，也可以实现基于继承的认证:用户需要<em class="nf">知道</em>他们的用户ID和密码，<em class="nf">拥有</em>他们的手机，并且(可选地)<em class="nf">是拥有解锁手机或电脑所需的面部或手指的用户。不良行为者可能会泄露用户的登录ID和密码，但他们要获得与用户相关的凭据、设备和生物特征数据要困难得多，至少在相当长的时间内是如此。</em></p><p id="6959" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Authy具有许多功能，可同时增强用户体验并提供灵活的身份验证选项:</p><ul class=""><li id="2e44" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">推送通知</li><li id="1352" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">软令牌(一次性代码)</li><li id="0ce3" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">短信和语音安全代码</li><li id="dd07" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">适用于iOS、Android、Windows和macOS的授权应用</li></ul><p id="c46d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该项目的这一部分将展示如何快速添加2FA到一个角应用与Authy应用。您需要一个Twilio帐户来完成这些步骤。你可以在几分钟内注册一个<a class="ae kw" href="https://www.twilio.com/try-twilio" rel="noopener ugc nofollow" target="_blank">免费试用账户</a>。</p><p id="368b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你有了Twilio账户，登录并导航到<a class="ae kw" href="https://www.twilio.com/console" rel="noopener ugc nofollow" target="_blank"> Twilio控制台</a>的授权部分，完成以下步骤。你会在几分钟内完成。</p><ol class=""><li id="7101" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ni ld le lf bi translated">在Twilio控制台的Authy部分，创建一个新的应用程序。</li><li id="3d4b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">将应用程序的<strong class="ka ir">生产API密钥</strong>复制到安全的地方。(如果您放错了，可以在应用程序的设置中找到密钥。)</li><li id="e61b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">在您创建的应用程序中，使用您首选的电子邮件地址和手机号码将自己注册为新用户。</li><li id="0fce" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">将您刚刚创建的用户的<strong class="ka ir">授权ID </strong>复制到一个安全的地方。</li><li id="0036" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">在手机上安装Authy应用程序。您应该会收到一条文本通知，其中包含获取代码以完成安装的链接。</li></ol><p id="915b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">成功完成上述步骤后，您可以实施双因素身份认证。下图说明了浏览器、服务器和Twilio之间的通信流程:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/4b61278abd89c98dc9f8d38fc4692aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gPgOQZlG6zf62PKO.png"/></div></div></figure><ol class=""><li id="5ec8" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ni ld le lf bi translated">客户端发出GET /请求</li><li id="dec4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">服务器生成登录页面</li><li id="6d3e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">客户端发送/验证/登录的帖子</li><li id="935b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">服务器向Authy请求第二因素身份验证</li><li id="69a9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">Authy用request_id响应</li><li id="5242" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">服务器将request_id传递给浏览器</li><li id="f39f" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">浏览器询问服务器(重复)用户是否已通过第二个因素授权</li><li id="9631" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">服务器向Twilio询问状态</li><li id="4abb" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">Twilio以授权状态响应</li><li id="075f" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">服务器将状态传递给浏览器</li></ol><p id="8997" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">返回到项目目录中的命令行，通过执行以下命令在项目中安装必要的依赖项:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8152" class="mx lm iq mt b gy my mz l na nb">npm install authy<br/>npm install cookie-parser</span></pre><p id="7608" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在服务器上实施双因素身份验证将需要两个新端点，并修改现有的<em class="nf"> /auth/login </em>端点:</p><ul class=""><li id="922a" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><em class="nf"> /auth/status </em>将提供用户对给定授权请求的响应状态(<em class="nf">批准</em>、<em class="nf">拒绝</em>、<em class="nf">无响应</em>)。</li><li id="b307" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><em class="nf"> /auth/isLogged </em>将为浏览器提供一个加密的cookie来指示用户已登录。</li><li id="96f4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">除了验证登录凭证之外，<em class="nf"> /auth/login </em>将获得Authy过程的结果。</li></ul><p id="36ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用以下代码替换<em class="nf"> server.ts </em>中的代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a984" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在用设置Authy时从Twilio控制台复制的值替换占位符。将<strong class="ka ir">生产API关键字</strong>放在声明部分:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="cd7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了使演示更简单，我们硬编码了<code class="fe nc nd ne mt b">login</code>(用户ID)和<code class="fe nc nd ne mt b">password</code>的值。在生产应用程序中，您通常会根据持久性数据存储来检查所提供的值。</p><p id="d0b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">如果</strong>用户已经提供了有效的凭证，2FA中的下一步是使用用户的Authy ID向用户的设备触发Twilio Authy消息。正如我们跳过了在应用程序中注册用户的过程一样，我们也跳过了以编程方式向Authy注册用户的过程。为了使演示更简单，我们对您直接在Authy中将自己注册为用户时创建的Authy ID进行了硬编码。</p><p id="62db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nf"> /auth/login </em>端点的代码中，用创建用户时保存的Authy ID值替换占位符:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="bf7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当用户通过应用程序授权时，服务器会发送包含超级加密值的cookie。客户端将能够通过调用<em class="nf"> /auth/isLogged </em>端点来确定用户是否登录。</p><p id="4ba4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看<em class="nf"> /auth/isLogged </em>端点的代码，如下所示。尽管cookie的值是硬编码的，但在生产应用程序中，您应该生成一个唯一的加密值。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="ef6f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为cookie有一个<code class="fe nc nd ne mt b">httpOnly</code>属性，所以它在浏览器中是不可访问的。cookie是使用包含用户授权范围或其他敏感数据的<a class="ae kw" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌(JWT) </a>的好地方。加密的cookie还提供保护，防止令牌数据在<a class="ae kw" href="https://en.wikipedia.org/wiki/Cross-site_scripting" rel="noopener ugc nofollow" target="_blank">跨站点脚本</a> (XSS)攻击中被窃取。</p><p id="ac0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在新的端点已经在服务器上就位，可以在AuthService中使用它们了。用以下代码替换<em class="nf">src/app/auth . service . ts</em>中的现有代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="d012" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码太多了。什么变了？</p><p id="edfb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，“auth”方法使用带Authy的双因素身份验证。当调用<em class="nf"> /auth/login </em>端点的可观察对象以肯定消息响应时，使用来自Authy API的令牌作为参数调用<code class="fe nc nd ne mt b">secondFactor()</code>方法:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="3f4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nc nd ne mt b">secondFactor</code>函数使用<code class="fe nc nd ne mt b">rxjs</code>库中的<code class="fe nc nd ne mt b">timer</code>方法，在等待来自服务器上的<em class="nf"> /auth/status </em>端点的响应时，每秒发出一个数字。如果响应是<code class="fe nc nd ne mt b">approved</code>，用户被重定向到提供给<code class="fe nc nd ne mt b">auth</code>功能的URL。该URL是用户在被要求登录之前最初尝试导航到的路径。</p><p id="3436" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果来自<em class="nf"> /auth/status </em>的响应为<code class="fe nc nd ne mt b">denied</code>，或者60秒后没有响应，则可观测返回<code class="fe nc nd ne mt b">false</code>并关闭。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="fd5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nc nd ne mt b">AuthGuardService</code>的<code class="fe nc nd ne mt b">canActivate</code>方法需要通过一个observable来消费<code class="fe nc nd ne mt b">AuthService</code>并返回重定向URL而不是一个boolean。通过将以下代码复制到<em class="nf">src/app/auth-guard . service . ts</em>文件中来进行这些更改:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="731a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nc nd ne mt b">LoginPageComponent</code>应该让用户了解登录过程的状态。这可以通过rxjs <a class="ae kw" href="https://stackoverflow.com/questions/39494058/behaviorsubject-vs-observable" rel="noopener ugc nofollow" target="_blank"> BehaviorSubject </a>来完成，它是一种可观察的类型，使<code class="fe nc nd ne mt b">LoginPageComponent</code>能够将<code class="fe nc nd ne mt b">login</code>和<code class="fe nc nd ne mt b">password</code>的值发送给<code class="fe nc nd ne mt b">auth</code>方法，并接收认证尝试的状态。</p><p id="98f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用以下内容替换<em class="nf">src/app/log in-page/log in-page . component . ts</em>文件的内容:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="cff0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">BehaviorSubject <code class="fe nc nd ne mt b">message</code>的值可以显示在登录页面上。在<em class="nf">src/app/log in-page/log in-page . component . html</em>文件中现有代码的底部添加以下代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><h1 id="841a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用Authy运行和测试双因素身份认证</h1><p id="22d9" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通过输入以下命令，重新编译并运行应用程序:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="d335" class="mx lm iq mt b gy my mz l na nb">npm run build:prod<br/>npm run server</span></pre><p id="2865" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在浏览器中打开开发工具(F12)并选择网络选项卡，这样您就可以观察服务器和浏览器之间的通信。导航到<a class="ae kw" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>，输入登录凭证(登录名:<strong class="ka ir"> foo </strong>，密码:<strong class="ka ir">栏</strong>，点击<strong class="ka ir">提交</strong>。</p><p id="e5aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">两件事应该会接连发生:</p><ol class=""><li id="ad41" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv ni ld le lf bi translated">由于<code class="fe nc nd ne mt b">LoginPageComponent</code>从<code class="fe nc nd ne mt b">AuthService</code>中的可观察对象<code class="fe nc nd ne mt b">secondFactor</code>接收到每秒一次的推送通知，网络选项卡将显示一系列“状态”事件。这些事件将继续发生，直到Authy收到您手机上的应用程序的响应或60秒过去。</li><li id="e6d5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv ni ld le lf bi translated">您应该会在移动设备上收到如下所示的推送请求。</li></ol><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/51c0a6adea2f011ff914e168e3c422bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VWrdcPZt9PMByMmR.png"/></div></div></figure><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/cda6317fcbb30cbb37da509260120f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EmiPSy955vTbqSkF.png"/></div></div></figure><p id="0cf3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">批准身份验证请求。移动应用将安全地将批准传输到Twilio的Authy基础设施，该基础设施将向服务器进程发送推送通知。</p><p id="d905" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的浏览器中运行的Angular SPA将收到来自服务器上的<em class="nf"> /auth/status </em>端点的肯定响应以及身份验证cookie。在下图中，您可以看到<code class="fe nc nd ne mt b">isLogged</code>响应和cookie:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/ee7fef765db774512fbb21ed7b1b2302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X5YT6iNeB2nfN51w.png"/></div></div></figure><p id="6bd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想赶上这一步，请执行以下命令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="04c4" class="mx lm iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/angular-twilio-authy.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/angular-twilio-authy.git</a><br/>cd angular-twilio-authy<br/>git co step3<br/>npm install <br/>npm run build:prod<br/>npm run server</span></pre><h1 id="5be5" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">为生产准备角度和权限</h1><p id="603a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如本案例研究所示，您可以使用Twilio Authy和Angular Universal在Angular应用程序中轻松实现全功能和高性能的双因素身份验证。但是在您的应用程序准备好投入生产之前，还有其他一些考虑事项。</p><p id="7f99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其中最重要的是为浏览器和服务器之间的加密通信实现TLS/SSL。实现TLS/SSL的完整过程超出了本教程的范围，并且将取决于您的操作系统和其他因素，但是您可以轻松地配置上面显示的代码来使用安装在您的开发机器上的自签名OpenSSL证书。</p><p id="e9bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用以下代码替换<em class="nf"> local.js </em>文件的内容，并根据您的配置需要修改<em class="nf"> localhost.key </em>和<em class="nf"> localhost.cert </em>的路径:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="b4e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该代码可以在伙伴库的<strong class="ka ir">步骤4 </strong>分支中找到。</p><p id="b8b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其他生产考虑因素包括:</p><ul class=""><li id="f921" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">将用户凭证(用户ID和密码)以加密形式存储在持久性数据存储中(如数据库)</li><li id="21c2" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">验证和安全存储与用户账户相关联的电话号码</li><li id="d043" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">在Authy中创建新用户并将他们的Authy ID安全地存储在数据存储中</li><li id="0063" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用JSON Web令牌(JWT)或其他技术加密用于验证浏览器和服务器之间身份验证的cookie</li><li id="b31a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">设置用户ID要求和验证电子邮件地址</li><li id="a325" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">设置密码要求和处理密码重置</li></ul><p id="7650" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Twilio博客上寻找关于这些话题的帖子。</p><h1 id="73c5" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">摘要:使用Angular和Authy构建双因素身份认证</h1><p id="61b4" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们讨论了所有成熟应用程序面临的一个重要挑战:双因素身份验证(2FA)的安全性。我们看到了如何使用Angular Universal在服务器上实现身份验证，这使得该过程快速而安全。我们使用Twilio Authy实施了2FA，这是一套全面的身份验证工具，包括API、基于web的控制台和移动应用。</p><h1 id="0af4" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">附加角度通用资源</h1><p id="f415" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">如果你想了解更多关于Angular Universal技术的知识，请查看Twilio博客上的其他帖子:</p><ul class=""><li id="5f3b" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://www.twilio.com/blog/angular-universal-javascript-node-js-aws-lambda" rel="noopener ugc nofollow" target="_blank">开始使用AWS Lambda上的无服务器Angular Universal</a></li><li id="ca35" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.twilio.com/blog/create-search-engine-friendly-internationalized-web-apps-angular-universal-ngx-translate" rel="noopener ugc nofollow" target="_blank">如何用Angular Universal和ngx-translate创建搜索引擎友好的国际化网络应用</a></li><li id="aff0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.twilio.com/blog/faster-javascript-web-apps-angular-universal-transferstate-api-watchdog" rel="noopener ugc nofollow" target="_blank">用Angular Universal、TransferState服务和API看门狗构建快速高效的Angular应用</a></li></ul><p id="62c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章中使用的代码可以在<a class="ae kw" href="https://github.com/maciejtreder/angular-twilio-authy" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><p id="7cc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我是Maciej Treder，请通过<a class="ae kw" href="mailto:contact@maciejtreder.com" rel="noopener ugc nofollow" target="_blank">contact@maciejtreder.com</a>、<a class="ae kw" href="https://www.maciejtreder.com/" rel="noopener ugc nofollow" target="_blank">https://www.maciejtreder.com</a>或@maciejtreder在<a class="ae kw" href="http://github.com/maciejtreder" rel="noopener ugc nofollow" target="_blank"> GitHub </a>、<a class="ae kw" href="https://twitter.com/maciejtreder" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae kw" href="https://www.linkedin.com/in/maciej-treder/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我。</p><p id="0008" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nf">本帖原载于</em> <a class="ae kw" href="https://www.twilio.com/blog/two-factor-authentication-angular-twilio-authy" rel="noopener ugc nofollow" target="_blank"> <em class="nf">朱婷博客</em> </a> <em class="nf">。</em></p></div></div>    
</body>
</html>