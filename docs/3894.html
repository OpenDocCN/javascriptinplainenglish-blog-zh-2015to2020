<html>
<head>
<title>How to play YouTube Audio in the background on Android/iOS using JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用JavaScript在Android/iOS上后台播放YouTube音频</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/playing-youtube-audio-in-the-background-using-javascript-on-mobile-c19aea937ec1?source=collection_archive---------5-----------------------#2020-11-01">https://javascript.plainenglish.io/playing-youtube-audio-in-the-background-using-javascript-on-mobile-c19aea937ec1?source=collection_archive---------5-----------------------#2020-11-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="4561" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用Node.js流服务器构建一个基于JavaScript和HTML的音频播放器来播放YouTube音频</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/594a6375a2408bd27076e2d2d2d449b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-3_p8rm8fJDq8He33swhTg.png"/></div></div></figure><p id="04e0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">流行音乐流媒体服务在我居住的地方并不流行，所以YouTube一直是我的音乐来源。随着时间的推移，我开始接触Spotify，但我意识到YouTube更了解我的音乐品味，更不用说有很多Ted演讲了。我遇到的最大问题是没有后台支持！(显然是在手机上)，所以我的通勤<strong class="kq io">是</strong>非常空白(呆在家里！注意安全！).让我们利用JavaScript的力量来解决这个问题。</p><p id="16e7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="lk">免责声明:这只是一个有趣的项目，解决我自己的问题。我正在分享建立一个快速MVP的经验。一定要去看看YouTube上的音乐，然后这又是一个可用性的问题。</em></p><p id="9b90" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们进入代码之前，让我们达成共识。我要全力以赴，让我的心灵和你们交流。</p></div><div class="ab cl ll lm hr ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ig ih ii ij ik"><p id="8c3f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我试图解决的问题已经是一个解决方案了！在我看到这篇文章之前，我已经使用这个<a class="ae ls" href="https://www.theverge.com/2020/4/8/21210101/youtube-android-phones-ios-iphones-how-to-pip" rel="noopener ugc nofollow" target="_blank">技巧</a>很久了。但我遇到的最大问题是数据的使用及其不可靠性。不像大多数国家，我有让我们把它作为“有限的”数据。我能想到的最好的替代方案是从视频中提取音频，并以某种方式进行流式传输。这就是我们将要使用Node.js作为流媒体服务器和简单的基于JavaScript的前端来构建的东西。</p><p id="9dbe" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你在GitHub上搜索基于JavaScript的YouTube下载模块，你肯定会遇到<a class="ae ls" href="https://github.com/fent/node-ytdl-core" rel="noopener ugc nofollow" target="_blank"> ytdl-core </a>。最好的部分是，这个包提取特定YouTube视频的各种视频/音频格式的URL。我的想法是将音频URL发送到音频元素的前端，实际上我在本地做得非常好！但是当我遇到一个产品bug时，我的快乐列车就到此为止了:)</p><p id="8919" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当我在Heroku上托管应用程序时，我不断地从音频URL获得HTTP 403。在进一步挖掘文档后，我发现这些URL是基于IP的，因此解释了当我试图从我的本地IP访问它时出现的403错误。嗯，MVP #1在制作过程中完成了坠入死亡之谷。显然，那次发布是一次重大失败。</p><p id="8a9a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">进入MVP #2，流媒体服务器。如果你更关注ytdl-core，它清楚地表明</p><blockquote class="lt lu lv"><p id="bf33" class="ko kp lk kq b kr ks jo kt ku kv jr kw lw ky kz la lx lc ld le ly lg lh li lj ig bi translated">"只用Javascript和一个节点友好的流接口编写."</p></blockquote><p id="7d80" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">MVP #2不依赖于将URL发送到前端，而是有一个端点接受YouTube视频id，并将“audioonly”流作为响应。它非常有效！IP限制显然被克服了，因为请求URL的IP就是消费它的IP。但是还有另一个问题。缓冲和懒加载！</p><p id="33a4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">MVP #2需要更多的改进。在我将它与前端集成后，我意识到在开始播放之前，整个音频需要下载/流式传输。对我来说，这真的很烦人！因为有时我想跳到音频中的某个运行时，这是可能的，除非所有的东西都被下载了。如果所有的流媒体服务器都这样做，以块的形式发送数据，这种情况可以得到缓解！默认情况下，音频/视频HTML元素使用“Range”头请求将特定的字节传输给它。只要我们的backed支持部分响应，我们就是好的。这可以通过发送“<em class="lk"> Content-Length </em>”、“<em class="lk"> Content-Range </em>”、“<em class="lk"> Accept-Ranges </em>”作为基于从请求发送的范围的响应头来容易地实现。</p><p id="b8c4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因为我们都赶上了。让我们看一下代码</p><p id="88b2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们开始之前，让我们建立一个npm项目并安装必要的模块。打开终端，键入以下命令</p><p id="7de9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">创建一个名为<code class="fe lz ma mb mc b">uscream</code>(你想叫它什么都行:D) <br/> <code class="fe lz ma mb mc b"><em class="lk">mkdir uscream</em></code>的文件夹</p><p id="b38e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">将目录更改为新创建的文件夹<br/> <code class="fe lz ma mb mc b"> cd uscream</code></p><p id="5a19" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">初始化一个npm项目<br/>T3】</p><p id="623c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">火起来VS代码(VS代码是bae！如果你不同意……时间重新考虑)<br/> <code class="fe lz ma mb mc b"> code .</code></p></div><div class="ab cl ll lm hr ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ig ih ii ij ik"><p id="a19f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">创建一个名为<code class="fe lz ma mb mc b">server.js</code>的文件，并复制粘贴下面的代码。当你这样做的时候，试着去理解正在发生的事情，然后回来花两分钱。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="77da" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lz ma mb mc b"><strong class="kq io">getInfo,</strong></code>请求处理器功能连接到<code class="fe lz ma mb mc b">/info</code>路径。该路由接受一个查询参数<code class="fe lz ma mb mc b">url</code>，它是YouTube的URL。该逻辑包含在一个<code class="fe lz ma mb mc b">try catch</code>块中，如果失败，将返回一个带有消息的<code class="fe lz ma mb mc b">500</code>响应。实现相当简单</p><ol class=""><li id="d2cf" class="mf mg in kq b kr ks ku kv kx mh lb mi lf mj lj mk ml mm mn bi translated">从传递的URL获取YouTube视频id。这确保了使用方便的<code class="fe lz ma mb mc b">getURLVideoID</code>方法提供的URL是有效的。有效的请求应该是这样的</li></ol><pre class="kd ke kf kg gt mo mc mp mq aw mr bi"><span id="c430" class="ms mt in mc b gy mu mv l mw mx"><a class="ae ls" href="http://localhost:4000/info?url=https://www.youtube.com/watch?v=MdZAMSyn_As" rel="noopener ugc nofollow" target="_blank">http://localhost:4000/info?url=https://www.youtube.com/watch?v=xxxx</a></span><span id="bd18" class="ms mt in mc b gy my mv l mw mx">xxxx is a video id<br/>4000 is the port number where the app is served</span></pre><p id="b5f3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">2.使用带有视频id的<code class="fe lz ma mb mc b">ytdl.getInfo</code>函数提取视频元细节，并将其作为JSON响应发送。我在这里使用JSON是因为我们将发送一个<code class="fe lz ma mb mc b">fetch</code>请求来获取元数据。</p><p id="e102" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从线<code class="fe lz ma mb mc b">31 — 77</code>移动到下一个请求处理器<code class="fe lz ma mb mc b">getAudioStream</code>处理音频流。这个功能的核心逻辑依赖于线条<code class="fe lz ma mb mc b">56 — 71</code>。响应头是根据<code class="fe lz ma mb mc b">audio</code>元素(在前端)请求的<code class="fe lz ma mb mc b">range</code>字节定义的。</p><ol class=""><li id="12f4" class="mf mg in kq b kr ks ku kv kx mh lb mi lf mj lj mk ml mm mn bi translated">要点<br/>中的行<code class="fe lz ma mb mc b">35–50</code>-验证YouTube视频id <br/> -抛出一个错误无效<br/> -从使用由<code class="fe lz ma mb mc b">audioonly</code>和<code class="fe lz ma mb mc b">highestaudio</code>过滤的<code class="fe lz ma mb mc b">ytdl-core</code>包中获取元细节。该过滤器确保我们获得最佳质量的音频。</li><li id="38c0" class="mf mg in kq b kr mz ku na kx nb lb nc lf nd lj mk ml mm mn bi translated">线<code class="fe lz ma mb mc b">53 —71</code>处理音频流的部分响应。请记住，在Express中，请求处理程序的<code class="fe lz ma mb mc b">req</code>(请求)和<code class="fe lz ma mb mc b">res</code>(响应)是流。<code class="fe lz ma mb mc b">req</code>是可读的数据流，而<code class="fe lz ma mb mc b">res</code>是可写的数据流。因此从<code class="fe lz ma mb mc b">ytdl</code>函数返回的<code class="fe lz ma mb mc b">Readable</code>流可以通过管道或连接到<code class="fe lz ma mb mc b">res</code>。</li></ol><p id="bca0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为了增加一个<code class="fe lz ma mb mc b">audio</code>元素的查找能力，我们需要根据请求<code class="fe lz ma mb mc b">start</code>和<code class="fe lz ma mb mc b">end</code>范围发送流。根据请求字节的<code class="fe lz ma mb mc b">start</code>和<code class="fe lz ma mb mc b">end</code>范围计算要发送的块大小。如果请求头不包含<code class="fe lz ma mb mc b">range</code>，则<code class="fe lz ma mb mc b">startRange</code>和<code class="fe lz ma mb mc b">endRange</code>默认为<code class="fe lz ma mb mc b">0</code>和<code class="fe lz ma mb mc b">contentLength -1</code>。HTTP状态码206表示正在发送<code class="fe lz ma mb mc b">Partial Content</code>。如果有错误，便捷的<code class="fe lz ma mb mc b">try catch</code>模块会发送一个带有状态代码<code class="fe lz ma mb mc b">500</code>的空体。</p><p id="8b52" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们完了。这就完成了流媒体服务器。万岁！！！</p><p id="f55c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在下一篇文章中，让我们开始集成这个前端，并在Heroku上托管应用程序！如果你不耐烦，你可以去Github <a class="ae ls" href="https://github.com/octalpixel/uscream" rel="noopener ugc nofollow" target="_blank">库</a>看看代码。</p><p id="496c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">此外，如果我们可以获得播放列表支持，这个应用程序有一个更好的用例。；)将留给你们这些有思想的家伙</p></div></div>    
</body>
</html>