<html>
<head>
<title>How to Build a WebSocket Chat Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建WebSocket聊天应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-build-a-websocket-chat-application-819399d55800?source=collection_archive---------0-----------------------#2020-12-27">https://javascript.plainenglish.io/how-to-build-a-websocket-chat-application-819399d55800?source=collection_archive---------0-----------------------#2020-12-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7b7b5c2ccc5679c33540486db0066f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yqJGEvW2Q8r9efXQ"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@yogasdesign?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Yogas Design</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ebe2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在进入这篇博客之前，我建议看一下我以前的博客，在那里我介绍了<a class="ae jz" href="http://Introduction to WebSockets" rel="noopener ugc nofollow" target="_blank">web socket API</a>。从本文中，您会发现web sockets API如何工作以及WebSocket API的主要组件的高级概述。这篇博客将重点介绍我用来创建WebSocket聊天应用程序的技术和步骤，该应用程序符合以下准则:</p><ul class=""><li id="0793" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">在消息发生时记录消息，并立即与连接到应用程序的每个人分享这些消息。</li><li id="dd21" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">结果保留在会话之间，只有最后十条消息按从最近到最早的降序显示。</li></ul><h2 id="443e" class="lm ln in bd lo lp lq dn lr ls lt dp lu kl lv lw lx kp ly lz ma kt mb mc md me bi translated">技术</h2><p id="c6af" class="pw-post-body-paragraph ka kb in kc b kd mf kf kg kh mg kj kk kl mh kn ko kp mi kr ks kt mj kv kw kx ig bi translated"><strong class="kc io">后端</strong> : CRUD WebSocket API: Node.js、Express.js、Socket.io、PostgreSQL</p><p id="3934" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">前端</strong> : React和Socket.io</p><p id="9852" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">部署 : Heroku和Netlify</p><h2 id="1ddc" class="lm ln in bd lo lp lq dn lr ls lt dp lu kl lv lw lx kp ly lz ma kt mb mc md me bi translated">后端</h2><p id="9e39" class="pw-post-body-paragraph ka kb in kc b kd mf kf kg kh mg kj kk kl mh kn ko kp mi kr ks kt mj kv kw kx ig bi translated"><strong class="kc io">概述:</strong>我们的后端将由一个CRUD WebSocket API组成，该API使用在Express.js服务器上运行的Node.js环境，该服务器利用Socket.io和PostgreSQL数据库。现在，一次列出了很多词汇和技术。所以，在我们开始编码之前，让我们定义每一部分。</p><ul class=""><li id="0e54" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated"><strong class="kc io"> CRUD </strong> — CRUD代表(创建、读取、更新和删除)，是API的四个关键功能。我们的聊天应用程序将利用创建和只读。</li><li id="27d3" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc io"> API(应用程序编程接口)</strong>—“…是一组编程代码，支持一个软件产品和另一个软件产品之间的数据传输。它还包含此数据交换的条款”(Altexsoft)。</li><li id="5a95" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc io">web socket API</strong>—“…一种先进的技术，可以在用户的浏览器和服务器之间开启双向互动通信会话。”(Mozilla)。更多信息<a class="ae jz" href="https://sedlacek1991.medium.com/introduction-to-websockets-8583403d401d" rel="noopener">点击这里</a>。</li><li id="fdde" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc io">node . js</strong>——“一个开源的、跨平台的、后端的JavaScript运行时环境，在web浏览器之外执行JavaScript代码”(维基百科)。</li><li id="15c0" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">Express . js—“…一个最小且灵活的Node.js web应用程序框架，为web和移动应用程序提供了一组强大的功能”(Express)。</li><li id="42a0" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc io">PostgreSQL(Postgres)</strong>—“…一个强大的开源对象关系数据库系统，经过30多年的积极开发，它在可靠性、功能健壮性和性能方面赢得了良好的声誉”(Postgresql.org)。</li><li id="e2c2" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc io">Socket . io</strong>——“Socket。IO是一个库，支持浏览器和服务器之间的实时、双向和基于事件的通信。它由Node.js服务器和浏览器的Javascript客户端库组成”(Socket.io)。</li></ul><p id="e09e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们通过创建Postgres数据库来开始编码。</p><p id="2589" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">数据库创建</strong></p><p id="8a0f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">说明要求家酿安装在您的本地机器上。有关设置说明，请参见<a class="ae jz" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><ol class=""><li id="8250" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">如果您尚未安装PostgreSQL，请安装它。对于Mac用户，在终端中键入<code class="fe ml mm mn mo b">brew install postgresql</code>。</li><li id="3ec2" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">通过在您的终端中键入<code class="fe ml mm mn mo b">psql postgres</code>连接到默认的postgres数据库</li><li id="18d4" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">创建一个用户名为me，密码为<code class="fe ml mm mn mo b">CREATE ROLE me WITH LOGIN PASSWORD 'password';</code>的用户</li><li id="dbda" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">给我创建数据库的能力<code class="fe ml mm mn mo b">ALTER ROLE me CREATEDB;</code></li><li id="cb61" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">使用<code class="fe ml mm mn mo b">\q</code>退出默认postgres</li><li id="d19b" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">连接postgres和我<code class="fe ml mm mn mo b">psql -d postgres -U me</code></li><li id="3688" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">创建数据库<code class="fe ml mm mn mo b">CREATE DATABASE api;</code></li><li id="c12f" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">连接到新的api数据库<code class="fe ml mm mn mo b">\c api</code></li><li id="81c3" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">使用下面的SQL命令在api数据库中创建一个表。这个SQL命令在Postgres表中为ID、文本、用户名和created_at时间戳创建列。请根据您的应用需求随意编辑。</li></ol><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="b9e0" class="lm ln in mo b gy mx my l mz na">CREATE TABLE messages (<br/>  ID SERIAL PRIMARY KEY,<br/>  text varchar(255) NOT NULL,<br/>  username varchar(255) NOT NULL,<br/>  created_at TIMESTAMP NOT NULL DEFAULT now()<br/>);</span></pre><p id="d881" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">10.将时区设置为UTC。<code class="fe ml mm mn mo b">SET TIMEZONE='UTC';</code>。这一步不是必需的，但它允许您在前端使用Moment.js将UTC时间戳转换为用户的本地时间。要了解更多，请阅读我的博客<a class="ae jz" href="https://levelup.gitconnected.com/seize-the-moment-js-43b3210a27a5" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="1ef1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">11.使用下面的SQL命令植入消息表。(确保列名与您在步骤9中创建的表一致)</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="1ec1" class="lm ln in mo b gy mx my l mz na">INSERT INTO messages (text, username)<br/>  VALUES ('1+1=2', 'matthew'), ('2+2=4', 'blake'), ('3+3=6', 'julie'), ('4+4=8', 'courtney'), ('5+5=10', 'brian'), ('6+6=12', 'michael'), ('7+7=14', 'edward'), ('1+1=2', 'matthew'), ('2+2=4', 'blake'), ('3+3=6', 'julie');</span></pre><p id="a99e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">12.数据库现在已经设置好了，您可以将psql和<code class="fe ml mm mn mo b">\q</code>一起留在您的终端中。</p><p id="796a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> Express.js服务器设置</strong></p><p id="b8c4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，我们已经有了种子Postgres数据库，我们需要创建我们的服务器。</p><ol class=""><li id="39a5" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">在GitHub中，创建一个空白存储库，并将其克隆到您选择的文件夹中</li></ol><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/99cc6780311834ab5f9c4d545a9d4b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*uRQj3zk67e8T0xTYdivKEw.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">I recommend initializing your GitHub Repo with a README and .gitignore</figcaption></figure><p id="ad39" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">2.使用<code class="fe ml mm mn mo b">cd</code>输入克隆的存储库</p><p id="adbc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.要创建我们的package.json文件，请键入<code class="fe ml mm mn mo b">npm init -y</code></p><p id="008c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">4.在您选择的代码编辑器中打开您的目录</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="0dc7" class="lm ln in mo b gy mx my l mz na">// Your package.json file should look similar to this</span><span id="597a" class="lm ln in mo b gy nc my l mz na">{<br/>  "name": "node-api-postgres",<br/>  "version": "1.0.0",<br/>  "description": "index.js",<br/>  "main": "",<br/>  "license": "ISC"<br/>}</span></pre><p id="63b2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">5.为我们的服务器安装express . js<code class="fe ml mm mn mo b">npm install express --save</code></p><p id="40b6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">6.使用node -postgres连接到postgres <code class="fe ml mm mn mo b">npm install pg</code></p><p id="042e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的服务器现在在node_modules和package.json文件中有了所需的依赖项。我建议将您的工作提交给GitHub，并在此时创建一个本地分支<code class="fe ml mm mn mo b">git checkout -b local</code></p><p id="6f0b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">创建Express.js服务器入口点</strong></p><p id="370a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们服务器的入口点将是index.js</p><ol class=""><li id="1a5b" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">在代码编辑器中创建index.js文件</li><li id="4942" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">将以下代码输入index.js文件</li></ol><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="f2f7" class="lm ln in mo b gy mx my l mz na">const express = require('express')<br/>const bodyParser = require('body-parser')<br/>const app = express()<br/>const port = 3000<br/><br/>app.use(bodyParser.json())<br/>app.use(<br/>  bodyParser.urlencoded({<br/>    extended: true,<br/>  })<br/>)</span><span id="8dba" class="lm ln in mo b gy nc my l mz na">app.get('/', (request, response) =&gt; {<br/>  response.json({ info: 'Our app is up and running' })<br/>})</span><span id="b0d9" class="lm ln in mo b gy nc my l mz na">app.listen(port, () =&gt; {<br/>  console.log(`App running on ${port}.`)<br/>})</span></pre><p id="25ca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在上面，我们需要require express和一个名为body-parser的内置express中间件。NPM解释说，主体解析，“在你的处理程序之前，解析中间件中的传入请求主体，在<code class="fe ml mm mn mo b">req.body</code>属性下可用”(NPM)。</p><p id="91bb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第一个app.get是我们应用程序的主路径，当我们在localhost:3000中运行服务器<code class="fe ml mm mn mo b">node index.js</code>时，它将显示info消息。</p><p id="9e75" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">app.listen告诉我们我们的应用程序在终端的哪个端口上运行。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/e341d7b69a9b40dad0e6b6c0195c30be.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*vATfOVzAnBhPc9KjdFu8IQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Localhost: 3000</figcaption></figure><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ne"><img src="../Images/95233858ea3bef6cc9666fc6fef34710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WY7S7APw_57U44bWo4hNSQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Terminal</figcaption></figure><p id="e1a9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的Express.js服务器正在运行；现在我们需要连接到我们之前创建的Postgres数据库。</p><p id="418c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> Postgres数据库连接</strong></p><p id="d964" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如前所述，我们安装了node-postgres来允许我们的postgres数据库连接到我们的Node.js/Express.js服务器。现在让我们建立联系。</p><ol class=""><li id="c6dc" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">创建queries.js文件</li><li id="f42b" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">输入下面的代码来设置我们到postgres数据库的连接。在我们的例子中，我们使用node-postgres内置的连接池。我们使用池是因为我们的应用程序会频繁地进行查询。此外，使用池架构“…确保“关闭的”连接不是真正关闭，而是返回到池中，而“打开”新连接会返回相同的“物理连接”，从而减少PostgreSQL端的实际分叉”(ScaleGrid)。</li></ol><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="5c9a" class="lm ln in mo b gy mx my l mz na">// Please note that if you changed the user, database, or password in the database creation section you will need to update the respective line items below.</span><span id="a812" class="lm ln in mo b gy nc my l mz na">const Pool = require("pg").Pool;</span><span id="2b10" class="lm ln in mo b gy nc my l mz na">const pool = new Pool({</span><span id="a17a" class="lm ln in mo b gy nc my l mz na">     user: "me",</span><span id="b754" class="lm ln in mo b gy nc my l mz na">     host: "localhost",</span><span id="9ff3" class="lm ln in mo b gy nc my l mz na">     database: "api",</span><span id="438d" class="lm ln in mo b gy nc my l mz na">     password: "password",</span><span id="c49f" class="lm ln in mo b gy nc my l mz na">     port: 5432,</span><span id="bfd8" class="lm ln in mo b gy nc my l mz na">});</span></pre><p id="c5aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们已经连接到数据库，我们将创建我们的CRUD操作和路由。</p><p id="a070" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> CRUD操作&amp;路线</strong></p><p id="0010" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个应用程序将只使用创建和读取功能，因此只需要一个端点/消息。在创建CRUD操作时，我们需要对index.js和queries.js文件进行修改。让我们从queries.js开始。</p><ul class=""><li id="f31a" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">请记住，我们的应用程序要求我们只显示最后十条消息，从最近的到最早的降序排列。我们现在可以通过创建一个名为getMessages的GET请求(在CRUD中读取)来满足这个需求。</li></ul><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="ec74" class="lm ln in mo b gy mx my l mz na">// queries.js</span><span id="3471" class="lm ln in mo b gy nc my l mz na">const getMessages = (request, response) =&gt; {</span><span id="eb25" class="lm ln in mo b gy nc my l mz na">   pool.query(</span><span id="ef72" class="lm ln in mo b gy nc my l mz na">      "SELECT * FROM messages ORDER BY id DESC LIMIT 10",</span><span id="9aae" class="lm ln in mo b gy nc my l mz na">      (error, results) =&gt; {</span><span id="c0b0" class="lm ln in mo b gy nc my l mz na">         if (error) {</span><span id="e015" class="lm ln in mo b gy nc my l mz na">            throw error;</span><span id="a397" class="lm ln in mo b gy nc my l mz na">         }</span><span id="1a7f" class="lm ln in mo b gy nc my l mz na">         response.status(200).json(results.rows);</span><span id="ccc1" class="lm ln in mo b gy nc my l mz na">      }</span><span id="e8a9" class="lm ln in mo b gy nc my l mz na">   );</span><span id="80ec" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="c52d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用池使我们能够输入将从Postgres数据库中提取的原始SQL。原始SQL是满足我们项目需求的关键。用简单的英语来说，SQL语句选择messages表中的所有内容，并按照从旧到新的顺序对行进行排序，并将选择限制为十条消息。</p><ul class=""><li id="8706" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">我们的用户也需要能够创建消息。这需要向我们的端点发出POST请求(在CRUD中创建)。现在让我们来实现这个功能。</li></ul><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="d5ef" class="lm ln in mo b gy mx my l mz na">const createMessage = (request, response) =&gt; {</span><span id="0130" class="lm ln in mo b gy nc my l mz na">   const { text, username } = request.body;</span><span id="5e90" class="lm ln in mo b gy nc my l mz na">   pool.query(</span><span id="1c52" class="lm ln in mo b gy nc my l mz na">   "INSERT INTO messages (text, username) VALUES ($1, $2) RETURNING <br/>   text, username, created_at",</span><span id="0f47" class="lm ln in mo b gy nc my l mz na">      [text, username],</span><span id="c6a2" class="lm ln in mo b gy nc my l mz na">      (error, results) =&gt; {</span><span id="9f36" class="lm ln in mo b gy nc my l mz na">         if (error) {</span><span id="7b08" class="lm ln in mo b gy nc my l mz na">            throw error;</span><span id="a602" class="lm ln in mo b gy nc my l mz na">         }</span><span id="aaa6" class="lm ln in mo b gy nc my l mz na">         response.status(201).send(results.rows);</span><span id="bbb9" class="lm ln in mo b gy nc my l mz na">         }</span><span id="02b2" class="lm ln in mo b gy nc my l mz na">   );</span><span id="38ee" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="671e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里，我们再次使用池来输入原始SQL，该SQL将用户的消息添加到Postgres数据库中。简单地说，SQL语句在messages表中放入一个条目，我们的应用程序将在其中提供文本和用户名的值。除了文本和用户名之外，我们还告诉查询返回created_at时间戳。</p><p id="0d17" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在queries.js中我们需要做的最后一步是让index.js可以访问这些方法。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="9cb8" class="lm ln in mo b gy mx my l mz na">module.exports = {</span><span id="ba2e" class="lm ln in mo b gy nc my l mz na">   getMessages,</span><span id="8119" class="lm ln in mo b gy nc my l mz na">   createMessage,</span><span id="614b" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="5fe1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，在index.js中，我们需要做的就是添加以下内容来利用这些方法。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="4b17" class="lm ln in mo b gy mx my l mz na">// Add to the top of the index.js file with the other requires<br/>const db = require('./queries')<br/></span><span id="6a9a" class="lm ln in mo b gy nc my l mz na">// Add to the bottom<br/>app.get("/messages", db.getMessages);</span><span id="6565" class="lm ln in mo b gy nc my l mz na">app.post("/messages", db.createMessage);</span></pre><p id="a5a2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，如果我们运行<code class="fe ml mm mn mo b">node index.js</code>，我们可以转到<a class="ae jz" href="http://localhost:3000/messages" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/messages</a>并查看我们的消息。您应该会看到类似下面的内容。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/f77ea460a911e9c058b4e4c8b9eabee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*rJHaTfpVteE9MAHG9tS7bw.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Example of current output</figcaption></figure><p id="ceab" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，如果我们正在实现一个RESTful API，这就是我们可以停止的地方。然而，我们的应用程序需要一个WebSocket API。我会推荐将这个分支推上GitHub，然后创建一个名为Socketio的分支。</p><p id="74b3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> Socket.io实现(本地)</strong></p><p id="beeb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如前所述，Socket.io是“……基于长轮询/WebSocket的第三方传输协议，用于<a class="ae jz" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank">node . js</a>”(Mozilla)。在本节中，我们将安装Socket.io和其他所需的依赖项，以将我们的API从RESTful API转换为WebSocket API。</p><ol class=""><li id="53eb" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">按照Socket.io约定，将index.js重命名为app.js</li><li id="e92d" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">在package.json中将主值从index.js重命名为app.js</li></ol><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="a0a2" class="lm ln in mo b gy mx my l mz na">"main": "app.js",</span></pre><p id="d233" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.用终端命令<code class="fe ml mm mn mo b">npm install socket.io</code>安装Socket.io</p><p id="da2b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">4.使用终端命令<code class="fe ml mm mn mo b">npm i cors</code>安装CORS。Mozilla将CORS或跨来源资源共享定义为“……一种基于HTTP头的机制，允许服务器指示除其自身以外的任何其他来源(域、方案或端口)，浏览器应允许从这些来源加载资源”(Mozilla)。如果没有CORS，我们的前端将无法向后端发送请求。</p><p id="e1a8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">5.使用Socket.io提供的文档，我们需要在app.js中添加/更新粗体内容，以允许Socket.io和CORS实现</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="4c59" class="lm ln in mo b gy mx my l mz na">// app.js</span><span id="c0d5" class="lm ln in mo b gy nc my l mz na">const express = require("express");</span><span id="3593" class="lm ln in mo b gy nc my l mz na">const bodyParser = require("body-parser");</span><span id="5036" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const cors = require("cors");</strong></span><span id="5f57" class="lm ln in mo b gy nc my l mz na">const app = express();</span><span id="ba37" class="lm ln in mo b gy nc my l mz na">const port = 3000;</span><span id="5bf4" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const socketPort = 8000;</strong></span><span id="9e01" class="lm ln in mo b gy nc my l mz na">const db = require("./queries");</span><span id="2ade" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const { emit } = require("process");</strong></span><span id="d0d8" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const server = require("http").createServer(app);</strong></span><span id="26cf" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const io = require("socket.io")(server, {</strong></span><span id="cd18" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   cors: {</strong></span><span id="444d" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      origin: "http://localhost:3001",</strong></span><span id="f5b2" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      methods: ["GET", "POST"],</strong></span><span id="7018" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   },</strong></span><span id="8cb8" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">});</strong></span><span id="9401" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">app.use(cors());</strong></span><span id="9842" class="lm ln in mo b gy nc my l mz na">// parses requests for fetch</span><span id="7979" class="lm ln in mo b gy nc my l mz na">app.use(bodyParser.json());</span><span id="db56" class="lm ln in mo b gy nc my l mz na">app.use(</span><span id="29cd" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   bodyParser.urlencoded({</strong></span><span id="d638" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      extended: true,</strong></span><span id="5b71" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   })</strong></span><span id="af0a" class="lm ln in mo b gy nc my l mz na">);</span><span id="f32a" class="lm ln in mo b gy nc my l mz na">app.listen(port, () =&gt; {</span><span id="4c08" class="lm ln in mo b gy nc my l mz na">   console.log(`App running on port ${port}.`);</span><span id="81f8" class="lm ln in mo b gy nc my l mz na">});</span><span id="1764" class="lm ln in mo b gy nc my l mz na">app.get("/messages", db.getMessages);</span><span id="1d73" class="lm ln in mo b gy nc my l mz na">app.post("/messages", db.createMessage);</span></pre><p id="57fc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">6.既然我们正在使用WebSocket API，我们需要在queries.js文件中添加新的GET和POST请求。请参阅RESTful API部分，了解这些SQL查询的具体功能。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="f4eb" class="lm ln in mo b gy mx my l mz na">// queries.js</span><span id="8d1b" class="lm ln in mo b gy nc my l mz na">/* SOCKET DB */</span><span id="6bad" class="lm ln in mo b gy nc my l mz na">const getSocketMessages = () =&gt; {</span><span id="badb" class="lm ln in mo b gy nc my l mz na">   return new Promise((resolve) =&gt; {</span><span id="73e3" class="lm ln in mo b gy nc my l mz na">      pool.query(</span><span id="f8c0" class="lm ln in mo b gy nc my l mz na">         "SELECT * FROM messages ORDER BY id DESC LIMIT 10",</span><span id="137b" class="lm ln in mo b gy nc my l mz na">         (error, results) =&gt; {</span><span id="3f0e" class="lm ln in mo b gy nc my l mz na">            if (error) {</span><span id="df61" class="lm ln in mo b gy nc my l mz na">               throw error;</span><span id="bcce" class="lm ln in mo b gy nc my l mz na">            }</span><span id="ee05" class="lm ln in mo b gy nc my l mz na">            resolve(results.rows);</span><span id="258c" class="lm ln in mo b gy nc my l mz na">          }</span><span id="bb1a" class="lm ln in mo b gy nc my l mz na">      );</span><span id="04cb" class="lm ln in mo b gy nc my l mz na">   });</span><span id="f170" class="lm ln in mo b gy nc my l mz na">};</span><span id="0b74" class="lm ln in mo b gy nc my l mz na">const createSocketMessage = (message) =&gt; {</span><span id="bc63" class="lm ln in mo b gy nc my l mz na">   return new Promise((resolve) =&gt; {</span><span id="877f" class="lm ln in mo b gy nc my l mz na">      pool.query(</span><span id="36b6" class="lm ln in mo b gy nc my l mz na">         "INSERT INTO messages (text, username) VALUES ($1, $2) <br/>         RETURNING text, username, created_at",</span><span id="2293" class="lm ln in mo b gy nc my l mz na">         [message.text, message.username],</span><span id="6901" class="lm ln in mo b gy nc my l mz na">         (error, results) =&gt; {</span><span id="236c" class="lm ln in mo b gy nc my l mz na">            if (error) {</span><span id="39f9" class="lm ln in mo b gy nc my l mz na">               throw error;</span><span id="1d90" class="lm ln in mo b gy nc my l mz na">            }</span><span id="fca2" class="lm ln in mo b gy nc my l mz na">            resolve(results.rows);</span><span id="0413" class="lm ln in mo b gy nc my l mz na">         }</span><span id="f734" class="lm ln in mo b gy nc my l mz na">      );</span><span id="e9b6" class="lm ln in mo b gy nc my l mz na">   });</span><span id="926f" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="6228" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">7.为了让app.js可以访问这些方法，我们需要将它们添加到我们的module.exports中</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="fc5e" class="lm ln in mo b gy mx my l mz na">// queries.js</span><span id="8133" class="lm ln in mo b gy nc my l mz na">module.exports = {</span><span id="0334" class="lm ln in mo b gy nc my l mz na">   getMessages,</span><span id="cbf1" class="lm ln in mo b gy nc my l mz na">   createMessage,</span><span id="166a" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   getSocketMessages,</strong></span><span id="529d" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   createSocketMessage,</strong></span><span id="ee9d" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="9070" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">8.最后，我们需要将Socket.io方法添加到app.js中</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="645a" class="lm ln in mo b gy mx my l mz na">// app.js<br/></span><span id="eba3" class="lm ln in mo b gy nc my l mz na">// sends out the 10 most recent messages from recent to old</span><span id="641b" class="lm ln in mo b gy nc my l mz na">const emitMostRecentMessges = () =&gt; {</span><span id="4689" class="lm ln in mo b gy nc my l mz na">   db.getSocketMessages()</span><span id="8c78" class="lm ln in mo b gy nc my l mz na">      .then((result) =&gt; io.emit("chat message", result))</span><span id="b983" class="lm ln in mo b gy nc my l mz na">      .catch(console.log);</span><span id="0df8" class="lm ln in mo b gy nc my l mz na">};</span><span id="d992" class="lm ln in mo b gy nc my l mz na">// connects, creates message, and emits top 10 messages</span><span id="5381" class="lm ln in mo b gy nc my l mz na">io.on("connection", (socket) =&gt; {</span><span id="acb7" class="lm ln in mo b gy nc my l mz na">   console.log("a user connected");</span><span id="6ed0" class="lm ln in mo b gy nc my l mz na">   socket.on("chat message", (msg) =&gt; {</span><span id="794a" class="lm ln in mo b gy nc my l mz na">      db.createSocketMessage(JSON.parse(msg))</span><span id="da56" class="lm ln in mo b gy nc my l mz na">         .then((_) =&gt; {</span><span id="0f19" class="lm ln in mo b gy nc my l mz na">            emitMostRecentMessges();</span><span id="4e1d" class="lm ln in mo b gy nc my l mz na">         })</span><span id="3fb4" class="lm ln in mo b gy nc my l mz na">         .catch((err) =&gt; io.emit(err));<br/>});</span><span id="50cf" class="lm ln in mo b gy nc my l mz na"><br/>// close event when user disconnects from app</span><span id="4dad" class="lm ln in mo b gy nc my l mz na">   socket.on("disconnect", () =&gt; {</span><span id="aae2" class="lm ln in mo b gy nc my l mz na">      console.log("user disconnected");<br/>   });</span><span id="e4da" class="lm ln in mo b gy nc my l mz na">});</span><span id="f831" class="lm ln in mo b gy nc my l mz na"><br/>// Displays in terminal which port the socketPort is running on</span><span id="c68e" class="lm ln in mo b gy nc my l mz na">server.listen(socketPort, () =&gt; {</span><span id="627c" class="lm ln in mo b gy nc my l mz na">   console.log(`listening on *:${socketPort}`);</span><span id="efa8" class="lm ln in mo b gy nc my l mz na">});</span></pre><p id="f876" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">9.为了测试我们的应用程序，我们可以创建一个index.html文件。复制并粘贴下面的源代码作为快速示例，或者随意创建自己的代码。要运行，需要有两个终端；一个用于服务器，另一个用于打开index.html文件。完成此操作的终端命令是<code class="fe ml mm mn mo b">node app.js</code>和<code class="fe ml mm mn mo b">open index.html</code></p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="a86f" class="lm ln in mo b gy mx my l mz na">&lt;!doctype html&gt;</span><span id="ab4b" class="lm ln in mo b gy nc my l mz na">&lt;html&gt;</span><span id="18dd" class="lm ln in mo b gy nc my l mz na">   &lt;head&gt;</span><span id="401a" class="lm ln in mo b gy nc my l mz na">      &lt;title&gt;Socket.IO chat&lt;/title&gt;</span><span id="87c2" class="lm ln in mo b gy nc my l mz na">      &lt;style&gt;</span><span id="5b60" class="lm ln in mo b gy nc my l mz na">         * { margin: 0; padding: 0; box-sizing: border-box; }</span><span id="7f5f" class="lm ln in mo b gy nc my l mz na">         body { font: 13px Helvetica, Arial; }</span><span id="36f6" class="lm ln in mo b gy nc my l mz na">         form { background: #000; padding: 3px; position: fixed;   <br/>         bottom: 0; width: 100%; }</span><span id="4773" class="lm ln in mo b gy nc my l mz na">         form input { border: 0; padding: 10px; width: 90%; <br/>         margin-right: 0.5%; }</span><span id="8cad" class="lm ln in mo b gy nc my l mz na">         form button { width: 9%; background: rgb(130, 224, 255);<br/>         border: none; padding: 10px; }</span><span id="c8f2" class="lm ln in mo b gy nc my l mz na">         #messages { list-style-type: none; margin: 0; padding: 0; }</span><span id="9e83" class="lm ln in mo b gy nc my l mz na">         #messages li { padding: 5px 10px; }</span><span id="929f" class="lm ln in mo b gy nc my l mz na">         #messages li:nth-child(odd) { background: #eee; }</span><span id="5f70" class="lm ln in mo b gy nc my l mz na">      &lt;/style&gt;</span><span id="41a8" class="lm ln in mo b gy nc my l mz na">   &lt;/head&gt;</span><span id="1f86" class="lm ln in mo b gy nc my l mz na">   &lt;body&gt;</span><span id="3340" class="lm ln in mo b gy nc my l mz na">      &lt;ul id="messages"&gt;&lt;/ul&gt;</span><span id="321e" class="lm ln in mo b gy nc my l mz na">      &lt;form action=""&gt;</span><span id="7ee3" class="lm ln in mo b gy nc my l mz na">         &lt;input id="username" autocomplete="off" <br/>          placeholder="username"/&gt;</span><span id="ba25" class="lm ln in mo b gy nc my l mz na">         &lt;input id="m" autocomplete="off" placeholder="equation"/&gt;</span><span id="40f7" class="lm ln in mo b gy nc my l mz na">         &lt;button&gt;Send&lt;/button&gt;<br/>      &lt;/form&gt;</span><span id="4d4a" class="lm ln in mo b gy nc my l mz na">      &lt;script src="http://localhost:8000/socket.io/socket.io.js"&gt;.<br/>      &lt;/script&gt;</span><span id="3409" class="lm ln in mo b gy nc my l mz na">      &lt;script&gt;</span><span id="470a" class="lm ln in mo b gy nc my l mz na">         const socket = io("http://localhost:8000");</span><span id="14bf" class="lm ln in mo b gy nc my l mz na">         const form = document.querySelector('form');</span><span id="84cd" class="lm ln in mo b gy nc my l mz na">         const messages = document.querySelector('#messages');</span><span id="5fe2" class="lm ln in mo b gy nc my l mz na">   function createMessage(msg) {</span><span id="1e42" class="lm ln in mo b gy nc my l mz na">      const li = document.createElement('li');</span><span id="ff11" class="lm ln in mo b gy nc my l mz na">     li.textContent =`${msg.text},${msg.username},${msg.created_at}`</span><span id="ee15" class="lm ln in mo b gy nc my l mz na">      messages.append(li);<br/>   }</span><span id="4e54" class="lm ln in mo b gy nc my l mz na">   function createMessages(msgs) {</span><span id="aebb" class="lm ln in mo b gy nc my l mz na">      msgs.forEach(createMessage);<br/>   }</span><span id="51e1" class="lm ln in mo b gy nc my l mz na"><br/>   fetch("http://localhost:3000/messages")</span><span id="e2c6" class="lm ln in mo b gy nc my l mz na">   .then(res =&gt; res.json())</span><span id="a32a" class="lm ln in mo b gy nc my l mz na">   .then(createMessages);</span><span id="b581" class="lm ln in mo b gy nc my l mz na">   <br/>   form.addEventListener("submit", (e) =&gt; {<br/>      e.preventDefault();<br/>      socket.emit('chat message', JSON.stringify({<br/>      text: document.querySelector('#m').value,<br/>      username: document.querySelector('#username').value<br/>     }));</span><span id="6af4" class="lm ln in mo b gy nc my l mz na">      e.target.reset();<br/>   });</span><span id="7783" class="lm ln in mo b gy nc my l mz na">   socket.on('chat message', function (msgs) {<br/>      console.log(msgs)<br/>      messages.innerHTML = "";<br/>      createMessages(msgs);<br/>   });</span><span id="e59c" class="lm ln in mo b gy nc my l mz na">         &lt;/script&gt;</span><span id="2215" class="lm ln in mo b gy nc my l mz na">   &lt;/body&gt;</span><span id="d3a2" class="lm ln in mo b gy nc my l mz na">&lt;/html&gt;</span></pre><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/79932d32e3d019e900aa4219088e7945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3IBMLBco3g5m7DKQDdCoVQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Index.html file after opening</figcaption></figure><p id="595a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的WebSocket API现在已经完成，我们的Read和Create操作正在按预期工作。现在的最后一步是修改我们的API，以便在Heroku上部署。</p><p id="4249" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">准备在Heroku上部署后端服务器</strong></p><p id="da4e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此时，我建议将您的socketio分支推到GitHub，并创建一个名为deployment的新分支。我们的部署分支将用于将我们的后端部署到Heroku。</p><ol class=""><li id="dca0" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mk le lf lg bi translated">创建一个空白。部署中引用的app.js和queries.js文件的env文件</li><li id="faa4" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">Heroku要求我们只有一个端口变量。查看粗体区域的更改</li><li id="6fe4" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">CORS源将需要更新到netlify网址，我们的反应前端将被托管</li><li id="79e2" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mk le lf lg bi translated">需要删除冗余代码<code class="fe ml mm mn mo b">app.listen(port, () =&gt; {console.log(`App running on port ${port}.`);});</code></li></ol><p id="cc8b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最终的app.js文件应该类似于下面的代码:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="a664" class="lm ln in mo b gy mx my l mz na">// app.js</span><span id="5957" class="lm ln in mo b gy nc my l mz na">const express = require("express");</span><span id="1b00" class="lm ln in mo b gy nc my l mz na">const bodyParser = require("body-parser");</span><span id="4bf4" class="lm ln in mo b gy nc my l mz na">const cors = require("cors");</span><span id="9e88" class="lm ln in mo b gy nc my l mz na">const app = express();</span><span id="bfa8" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const PORT = process.env.PORT || 8000;</strong></span><span id="6c09" class="lm ln in mo b gy nc my l mz na">const db = require("./queries");</span><span id="a36f" class="lm ln in mo b gy nc my l mz na">const { emit } = require("process");</span><span id="1715" class="lm ln in mo b gy nc my l mz na">const server = require("http").createServer(app);</span><span id="da2a" class="lm ln in mo b gy nc my l mz na">const io = require("socket.io")(server, {</span><span id="f2b4" class="lm ln in mo b gy nc my l mz na">   cors: {</span><span id="634c" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      origin: "{will need to input netlify url here}",</strong></span><span id="a192" class="lm ln in mo b gy nc my l mz na">      methods: ["GET", "POST"],</span><span id="ca4c" class="lm ln in mo b gy nc my l mz na">   },</span><span id="ffed" class="lm ln in mo b gy nc my l mz na">});</span><span id="4aed" class="lm ln in mo b gy nc my l mz na">app.use(cors());<br/></span><span id="e407" class="lm ln in mo b gy nc my l mz na">// parses requests for fetch</span><span id="5e20" class="lm ln in mo b gy nc my l mz na">app.use(bodyParser.json());</span><span id="449a" class="lm ln in mo b gy nc my l mz na">app.use(</span><span id="87d1" class="lm ln in mo b gy nc my l mz na">   bodyParser.urlencoded({</span><span id="9ae4" class="lm ln in mo b gy nc my l mz na">      extended: true,</span><span id="de05" class="lm ln in mo b gy nc my l mz na">   })</span><span id="5195" class="lm ln in mo b gy nc my l mz na">);</span><span id="e6f1" class="lm ln in mo b gy nc my l mz na">app.get("/messages", db.getMessages);<br/>app.post("/messages", db.createMessage);</span><span id="0b43" class="lm ln in mo b gy nc my l mz na">// sends out the 10 most recent messages from recent to oldest</span><span id="c637" class="lm ln in mo b gy nc my l mz na">const emitMostRecentMessges = () =&gt; {</span><span id="873a" class="lm ln in mo b gy nc my l mz na">   db.getSocketMessages()</span><span id="6d1d" class="lm ln in mo b gy nc my l mz na">      .then((result) =&gt; io.emit("chat message", result))</span><span id="2ea8" class="lm ln in mo b gy nc my l mz na">      .catch(console.log);</span><span id="c9ce" class="lm ln in mo b gy nc my l mz na">};<br/></span><span id="2f79" class="lm ln in mo b gy nc my l mz na">// connects, creates message, and emits top 10 messages</span><span id="fad1" class="lm ln in mo b gy nc my l mz na">io.on("connection", (socket) =&gt; {</span><span id="1ad4" class="lm ln in mo b gy nc my l mz na">   console.log("a user connected");</span><span id="1066" class="lm ln in mo b gy nc my l mz na">   socket.on("chat message", (msg) =&gt; {</span><span id="87b8" class="lm ln in mo b gy nc my l mz na">      db.createSocketMessage(JSON.parse(msg))</span><span id="2727" class="lm ln in mo b gy nc my l mz na">      .then((_) =&gt; {</span><span id="f6c8" class="lm ln in mo b gy nc my l mz na">         emitMostRecentMessges();</span><span id="53b4" class="lm ln in mo b gy nc my l mz na">      })</span><span id="8e8d" class="lm ln in mo b gy nc my l mz na">         .catch((err) =&gt; io.emit(err));</span><span id="bf4a" class="lm ln in mo b gy nc my l mz na">   });</span><span id="0c95" class="lm ln in mo b gy nc my l mz na">// close event when user disconnects from app</span><span id="9153" class="lm ln in mo b gy nc my l mz na">   socket.on("disconnect", () =&gt; {</span><span id="cf0f" class="lm ln in mo b gy nc my l mz na">      console.log("user disconnected");</span><span id="bada" class="lm ln in mo b gy nc my l mz na">   });</span><span id="b175" class="lm ln in mo b gy nc my l mz na">});</span><span id="ddbe" class="lm ln in mo b gy nc my l mz na">server.listen(<strong class="mo io">PORT</strong>, () =&gt; {</span><span id="aaaf" class="lm ln in mo b gy nc my l mz na">   console.log(`listening on *:${<strong class="mo io">PORT</strong>}`);</span><span id="b33f" class="lm ln in mo b gy nc my l mz na">});</span></pre><p id="1359" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.更新queries.js文件中的连接池以使用。env的DATABASE_URL由Heroku提供。</p><p id="b017" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最终的queries.js文件应该类似于下面的代码:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="30e1" class="lm ln in mo b gy mx my l mz na">// queries.js</span><span id="b028" class="lm ln in mo b gy nc my l mz na">const Pool = require("pg").Pool;</span><span id="9de9" class="lm ln in mo b gy nc my l mz na">const pool = new Pool({</span><span id="0dd8" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   connectionString: process.env.DATABASE_URL,</strong></span><span id="d4d0" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   ssl: {</strong></span><span id="0925" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      rejectUnauthorized: false,</strong></span><span id="a289" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   },</strong></span><span id="8c4d" class="lm ln in mo b gy nc my l mz na">});</span><span id="26cc" class="lm ln in mo b gy nc my l mz na">/* Local DB */</span><span id="9f44" class="lm ln in mo b gy nc my l mz na">const getMessages = (request, response) =&gt; {</span><span id="3d60" class="lm ln in mo b gy nc my l mz na">   pool.query(</span><span id="26e8" class="lm ln in mo b gy nc my l mz na">      "SELECT * FROM messages ORDER BY id DESC LIMIT 10",</span><span id="9a9f" class="lm ln in mo b gy nc my l mz na">      (error, results) =&gt; {</span><span id="ed7a" class="lm ln in mo b gy nc my l mz na">         if (error) {</span><span id="d2e4" class="lm ln in mo b gy nc my l mz na">            throw error;</span><span id="1cb1" class="lm ln in mo b gy nc my l mz na">         }</span><span id="ed91" class="lm ln in mo b gy nc my l mz na">         response.status(200).json(results.rows);</span><span id="fc84" class="lm ln in mo b gy nc my l mz na">         }</span><span id="e3b4" class="lm ln in mo b gy nc my l mz na">      );</span><span id="0a35" class="lm ln in mo b gy nc my l mz na">   };</span><span id="21a6" class="lm ln in mo b gy nc my l mz na">const createMessage = (request, response) =&gt; {</span><span id="db4b" class="lm ln in mo b gy nc my l mz na">   const { text, username } = request.body;</span><span id="7087" class="lm ln in mo b gy nc my l mz na">   pool.query(</span><span id="c97b" class="lm ln in mo b gy nc my l mz na">      "INSERT INTO messages (text, username) VALUES ($1, $2)<br/>      RETURNING text, username, created_at",</span><span id="3391" class="lm ln in mo b gy nc my l mz na">      [text, username],</span><span id="d2c0" class="lm ln in mo b gy nc my l mz na">      (error, results) =&gt; {</span><span id="ecfe" class="lm ln in mo b gy nc my l mz na">         if (error) {</span><span id="534e" class="lm ln in mo b gy nc my l mz na">            throw error;</span><span id="c221" class="lm ln in mo b gy nc my l mz na">         }</span><span id="3666" class="lm ln in mo b gy nc my l mz na">         response.status(201).send(results.rows);</span><span id="71f2" class="lm ln in mo b gy nc my l mz na">      }</span><span id="b98f" class="lm ln in mo b gy nc my l mz na">   );</span><span id="48d7" class="lm ln in mo b gy nc my l mz na">};</span><span id="d7ca" class="lm ln in mo b gy nc my l mz na">/* SOCKET DB */</span><span id="34b4" class="lm ln in mo b gy nc my l mz na">const getSocketMessages = () =&gt; {</span><span id="d694" class="lm ln in mo b gy nc my l mz na">   return new Promise((resolve) =&gt; {</span><span id="c8ee" class="lm ln in mo b gy nc my l mz na">      pool.query(</span><span id="a41e" class="lm ln in mo b gy nc my l mz na">         "SELECT * FROM messages ORDER BY id DESC LIMIT 10",</span><span id="3240" class="lm ln in mo b gy nc my l mz na">         (error, results) =&gt; {</span><span id="aacb" class="lm ln in mo b gy nc my l mz na">            if (error) {</span><span id="8437" class="lm ln in mo b gy nc my l mz na">               throw error;</span><span id="2121" class="lm ln in mo b gy nc my l mz na">            }</span><span id="b510" class="lm ln in mo b gy nc my l mz na">            resolve(results.rows);</span><span id="e529" class="lm ln in mo b gy nc my l mz na">            }</span><span id="0f1c" class="lm ln in mo b gy nc my l mz na">         );</span><span id="8ecb" class="lm ln in mo b gy nc my l mz na">     });</span><span id="ce34" class="lm ln in mo b gy nc my l mz na">};</span><span id="da84" class="lm ln in mo b gy nc my l mz na">const createSocketMessage = (message) =&gt; {</span><span id="bf14" class="lm ln in mo b gy nc my l mz na">   return new Promise((resolve) =&gt; {</span><span id="bfda" class="lm ln in mo b gy nc my l mz na">      pool.query(</span><span id="b245" class="lm ln in mo b gy nc my l mz na">         "INSERT INTO messages (text, username) VALUES ($1, $2)  <br/>         RETURNING text, username, created_at",</span><span id="915d" class="lm ln in mo b gy nc my l mz na">         [message.text, message.username],</span><span id="6246" class="lm ln in mo b gy nc my l mz na">         (error, results) =&gt; {</span><span id="b8ec" class="lm ln in mo b gy nc my l mz na">            if (error) {</span><span id="0c75" class="lm ln in mo b gy nc my l mz na">               throw error;</span><span id="650a" class="lm ln in mo b gy nc my l mz na">            }</span><span id="0d63" class="lm ln in mo b gy nc my l mz na">            resolve(results.rows);</span><span id="8180" class="lm ln in mo b gy nc my l mz na">          }</span><span id="f877" class="lm ln in mo b gy nc my l mz na">      );</span><span id="f521" class="lm ln in mo b gy nc my l mz na">   });</span><span id="8e99" class="lm ln in mo b gy nc my l mz na">};</span><span id="2351" class="lm ln in mo b gy nc my l mz na">module.exports = {</span><span id="221f" class="lm ln in mo b gy nc my l mz na">   getMessages,</span><span id="4ee7" class="lm ln in mo b gy nc my l mz na">   createMessage,</span><span id="ffa2" class="lm ln in mo b gy nc my l mz na">   getSocketMessages,</span><span id="825f" class="lm ln in mo b gy nc my l mz na">   createSocketMessage,</span><span id="07e3" class="lm ln in mo b gy nc my l mz na">};</span></pre><p id="200b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">4.将引擎和启动脚本添加到package.json文件中(参见粗体部分)。</p><p id="0349" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最终的package.json文件应该类似于下面的代码:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="e39f" class="lm ln in mo b gy mx my l mz na">{</span><span id="7885" class="lm ln in mo b gy nc my l mz na">"name": "node-api-postgres",</span><span id="4edf" class="lm ln in mo b gy nc my l mz na">"version": "1.0.0",</span><span id="60c0" class="lm ln in mo b gy nc my l mz na">"description": "",</span><span id="484c" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">"engines": {</strong></span><span id="ea5e" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   "node": "12.18.4"</strong></span><span id="5501" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">},</strong></span><span id="b014" class="lm ln in mo b gy nc my l mz na">"main": "app.js",</span><span id="9235" class="lm ln in mo b gy nc my l mz na">"scripts": {</span><span id="530e" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   "start": "node app.js",</strong></span><span id="270b" class="lm ln in mo b gy nc my l mz na">   "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span id="2287" class="lm ln in mo b gy nc my l mz na">},</span><span id="f971" class="lm ln in mo b gy nc my l mz na">"repository": {</span><span id="c624" class="lm ln in mo b gy nc my l mz na">   "type": "git",</span><span id="821c" class="lm ln in mo b gy nc my l mz na">   "url": "git+https://github.com/matthewsedlacek/node-api<br/>   -postgres.git"</span><span id="fe11" class="lm ln in mo b gy nc my l mz na">},</span><span id="3e9b" class="lm ln in mo b gy nc my l mz na">"keywords": [],</span><span id="8725" class="lm ln in mo b gy nc my l mz na">"author": "",</span><span id="a610" class="lm ln in mo b gy nc my l mz na">"license": "ISC",</span><span id="fd56" class="lm ln in mo b gy nc my l mz na">"bugs": {</span><span id="3dee" class="lm ln in mo b gy nc my l mz na">"url": "https://github.com/matthewsedlacek/node-api-postgres/issues"</span><span id="9e32" class="lm ln in mo b gy nc my l mz na">},</span><span id="9f83" class="lm ln in mo b gy nc my l mz na">"homepage": "https://github.com/matthewsedlacek/node-api postgres#readme",</span><span id="2743" class="lm ln in mo b gy nc my l mz na">"dependencies": {</span><span id="6413" class="lm ln in mo b gy nc my l mz na">   "cors": "^2.8.5",</span><span id="ecfa" class="lm ln in mo b gy nc my l mz na">   "express": "^4.17.1",</span><span id="9a08" class="lm ln in mo b gy nc my l mz na">   "pg": "^8.5.1",</span><span id="8cc2" class="lm ln in mo b gy nc my l mz na">   "socket.io": "^3.0.4"</span><span id="d200" class="lm ln in mo b gy nc my l mz na">}</span><span id="5584" class="lm ln in mo b gy nc my l mz na">}</span></pre><p id="2bc7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">5.用下面的代码创建一个Procfile。如果您不熟悉Procfile，这是一种声明由Heroku上我们的应用程序的dynos运行的命令的方法。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="c507" class="lm ln in mo b gy mx my l mz na">web: node app.js</span></pre><p id="f6cf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在are文件已经准备好部署在Heroku上了。</p><p id="ef23" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">部署到Heroku </strong></p><p id="d6dd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些说明摘自我之前关于<a class="ae jz" href="https://medium.com/swlh/launching-your-first-website-rails-react-42a6af1ab481" rel="noopener">部署</a>的博客。</p><p id="798d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">开始之前，您需要下载并安装<a class="ae jz" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku CLI </a>。当你创建了一个帐号并登录后，你就可以开始在Heroku上托管你的后台了。在您的终端中，键入以下命令。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="fd3b" class="lm ln in mo b gy mx my l mz na">heroku create</span></pre><p id="a39c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个命令将在Heroku上创建一个新的应用程序。如果你想命名你的后端，把它包括在上面的行中；否则，Heroku会为你生成一个名字。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="96d6" class="lm ln in mo b gy mx my l mz na">git push heroku main</span></pre><p id="48da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">git push命令将把您的存储库推送到您在前面的终端命令中创建的Heroku应用程序。您不需要在上一步中指定应用程序的名称，因为“heroku create”构建了一个名为“heroku”的git remote，它指向您刚刚创建的应用程序。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="2070" class="lm ln in mo b gy mx my l mz na">heroku addons:create heroku-postgresql:hobby-dev</span></pre><p id="6c96" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上面的命令将Postgres添加到我们的Heroku应用程序中。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="d8bb" class="lm ln in mo b gy mx my l mz na">heroku pg:reset</span><span id="0aa6" class="lm ln in mo b gy nc my l mz na">heroku pg:push name-of-local-database DATABASE_URL --app name-of-Heroku-app</span></pre><p id="4139" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，我们需要重置我们的默认Postgres并提升我们的本地数据库。在创建数据库部分，我们将本地数据库命名为api。因此，本地数据库的名称是api。DATABASE_URL应该和app一样保持不变。通过在终端中向上滚动，查看由<code class="fe ml mm mn mo b">heroku create</code>终端命令生成的名称，可以找到name-of-Heroku-app。</p><p id="8290" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，您已经在Heroku上部署了后端。你可以通过输入<code class="fe ml mm mn mo b">heroku open</code>查看你的应用程序，然后在网址上添加一个/信息。</p><p id="e823" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">*请注意，为了避免您的Dyno睡着，您需要进入您的Heroku帐户，将Dyno从免费升级为爱好。这将使您的WebSocket API保持清醒，并防止我们的WebSocket聊天应用程序出现不良行为。*</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/afbd4887e15ae6456e91379b77f37604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cN5rwTzDA8_PP26baFzDrg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Change Dyno Type in the Resources Tab in Heroku</figcaption></figure><h2 id="644c" class="lm ln in bd lo lp lq dn lr ls lt dp lu kl lv lw lx kp ly lz ma kt mb mc md me bi translated">前端</h2><p id="63d7" class="pw-post-body-paragraph ka kb in kc b kd mf kf kg kh mg kj kk kl mh kn ko kp mi kr ks kt mj kv kw kx ig bi translated">这一节，将不会关注如何构建一个前端，但更多的是如何将Socket.io融入我们的React前端。我们将要编写的方法将分为两个独立的部分；一个功能组件和一个类组件。</p><p id="f3b1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要开始，我们需要安装socket.io客户端。要安装，请在终端中键入以下命令:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="1239" class="lm ln in mo b gy mx my l mz na">npm i socket.io-client</span></pre><p id="4bba" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我们的功能组件中，我们首先需要导入Socket.io客户端。然后，我们需要为我们的Socket端点、Fetch端点和WebSocket创建变量(见粗体)。在这个功能组件中，我们使用react钩子来设置初始HTTP握手(参见第一个加粗的useEffect)。然后我们再次使用useEffect来看看客户端和服务器是否可以继续通过WebSockets。如果是这样的话，我们的消息列表将在每次用户提交消息时更新，并且我们的WebSocket将以它期望的方式运行。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="8337" class="lm ln in mo b gy mx my l mz na">import React from "react";</span><span id="69f0" class="lm ln in mo b gy nc my l mz na">import { useEffect, useState } from "react";</span><span id="b5ee" class="lm ln in mo b gy nc my l mz na">import MessagesArea from "./MessagesArea";</span><span id="f451" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">import socketIOClient from "socket.io-client";</strong></span><span id="a198" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const socketEndpoint = "https://serene-crag-73795.herokuapp.com";</strong></span><span id="27e5" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const fetchEndpoint = `${socketEndpoint}/messages`;</strong></span><span id="04c4" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const socket = socketIOClient(socketEndpoint);</strong></span><span id="07e5" class="lm ln in mo b gy nc my l mz na">function ConversationsList(props) {</span><span id="a0dc" class="lm ln in mo b gy nc my l mz na">   const [messages, setMessages] = useState([]);</span><span id="c0ed" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   useEffect(() =&gt; {<br/>      fetch(fetchEndpoint)<br/>      .then((res) =&gt; res.json())<br/>      .then(setMessages)<br/>      .catch(console.log);<br/>   }, []);</strong></span><span id="56e0" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   useEffect(() =&gt; {<br/>      if (socket) {<br/>         socket.on("chat message", (msgs) =&gt; {<br/>            setMessages(msgs);<br/>         });<br/>      }<br/>   }, []);</strong><br/></span><span id="79dc" class="lm ln in mo b gy nc my l mz na">return (<br/>   &lt;React.Fragment&gt;<br/>      {messages.length &gt; 0 ? (<br/>         &lt;MessagesArea<br/>            <strong class="mo io">messages={messages}</strong><br/>            username={props.username}<br/>            userId={props.uid}<br/>         /&gt;<br/>      ) : null}<br/>   &lt;/React.Fragment&gt;</span><span id="83c3" class="lm ln in mo b gy nc my l mz na"> );</span><span id="d8f6" class="lm ln in mo b gy nc my l mz na">}</span><span id="ff94" class="lm ln in mo b gy nc my l mz na">export default ConversationsList;</span></pre><p id="5351" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">类组件将处理向客户端发送新消息。与功能组件类似，我们需要导入Socket.io并为我们的Socket端点和WebSocket创建变量(见粗体)。注意，我们没有在这个组件中使用fetch，因为我们只通过WebSocket发送新消息。为了发送新消息，我们使用了一个emit事件(见粗体)。另外值得一提的是，我们创建的发射事件<em class="ni"> socket.on </em>和<em class="ni"> socket.emit </em>在我们后端的app.js文件中有对应的监听器。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="3d91" class="lm ln in mo b gy mx my l mz na">import React, { Component } from "react";</span><span id="59b1" class="lm ln in mo b gy nc my l mz na">import CalculatorDisplay from "../components/calculator/CalculatorDisplay";</span><span id="6757" class="lm ln in mo b gy nc my l mz na">import Keypad from "../components/calculator/Keypad";</span><span id="2e90" class="lm ln in mo b gy nc my l mz na">import Card from "react-bootstrap/Card";</span><span id="e7f7" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">import socketIOClient from "socket.io-client";</strong></span><span id="8e36" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const socketEndpoint = "https://serene-crag-73795.herokuapp.com";</strong></span><span id="91dd" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">const socket = socketIOClient(socketEndpoint);</strong></span><span id="b7aa" class="lm ln in mo b gy nc my l mz na">class Calculator extends Component {</span><span id="17e8" class="lm ln in mo b gy nc my l mz na">   state = {</span><span id="fbab" class="lm ln in mo b gy nc my l mz na">   result: "",</span><span id="dca4" class="lm ln in mo b gy nc my l mz na">   errorMessage: 0,</span><span id="7744" class="lm ln in mo b gy nc my l mz na">   resultPost: "",</span><span id="a730" class="lm ln in mo b gy nc my l mz na">   };<br/></span><span id="400b" class="lm ln in mo b gy nc my l mz na">   onClick = (button) =&gt; {</span><span id="c8d3" class="lm ln in mo b gy nc my l mz na">      if (button === "=") {</span><span id="fa03" class="lm ln in mo b gy nc my l mz na">         this.calculate();</span><span id="0d7f" class="lm ln in mo b gy nc my l mz na">      } else if (button === "C") {</span><span id="cfa7" class="lm ln in mo b gy nc my l mz na">         this.reset();</span><span id="a8ed" class="lm ln in mo b gy nc my l mz na">      } else if (button === "←") {</span><span id="5342" class="lm ln in mo b gy nc my l mz na">         this.backspace();</span><span id="c86c" class="lm ln in mo b gy nc my l mz na">      } else {</span><span id="b7d7" class="lm ln in mo b gy nc my l mz na">         this.setState({</span><span id="8823" class="lm ln in mo b gy nc my l mz na">            result: this.state.result + button,</span><span id="c2ba" class="lm ln in mo b gy nc my l mz na">         });</span><span id="49eb" class="lm ln in mo b gy nc my l mz na">      }</span><span id="0ba9" class="lm ln in mo b gy nc my l mz na">    };</span><span id="e7bf" class="lm ln in mo b gy nc my l mz na">   calculate = () =&gt; {</span><span id="1e0b" class="lm ln in mo b gy nc my l mz na">      try {</span><span id="9578" class="lm ln in mo b gy nc my l mz na">         this.handleSubmit();</span><span id="e7ed" class="lm ln in mo b gy nc my l mz na">      } catch (e) {</span><span id="6081" class="lm ln in mo b gy nc my l mz na">        this.setState({</span><span id="8c04" class="lm ln in mo b gy nc my l mz na">          result: "error",</span><span id="284f" class="lm ln in mo b gy nc my l mz na">         });</span><span id="b2a9" class="lm ln in mo b gy nc my l mz na">      }</span><span id="8d34" class="lm ln in mo b gy nc my l mz na">    };</span><span id="2531" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">   handleSubmit = (e) =&gt; {<br/>      socket.emit(<br/>         "chat message",<br/>         JSON.stringify({<br/>            text: this.state.result + " = " +<br/>            (eval(this.state.result) || 0) + "",<br/>            username: this.props.username,<br/>         })<br/>      );<br/>      this.setState({ result: "" });<br/>   };</strong></span><span id="b4a3" class="lm ln in mo b gy nc my l mz na">   reset = () =&gt; {<br/>      this.setState({<br/>         result: "",<br/>         resultPost: "",<br/>      });<br/>   };</span><span id="9b9f" class="lm ln in mo b gy nc my l mz na">   backspace = () =&gt; {<br/>      this.setState({<br/>         result: this.state.result.slice(0, -1),<br/>      });<br/>   };</span><span id="15c7" class="lm ln in mo b gy nc my l mz na">   render() {<br/>      return ["Primary"].map((variant, idx) =&gt; (<br/>      &lt;Card className="calculatorContainer" <br/>      bg={variant.toLowerCase()}&gt;<br/>         &lt;Card.Body&gt;<br/>             &lt;Card.Text&gt;<br/>                &lt;CalculatorDisplay result={this.state.result} /&gt;<br/>             &lt;/Card.Text&gt;<br/>             &lt;Card.Text&gt;<br/>                 &lt;Keypad<br/>                    onClick={this.onClick}<br/>                    resultPost={this.state.resultPost}<br/>                    conversation_id={this.props.conversation_id}<br/>                    username={this.props.username}<br/>                 /&gt;<br/>            &lt;/Card.Text&gt;<br/>         &lt;/Card.Body&gt;<br/>      &lt;/Card&gt;<br/>   ));<br/>  }<br/>}</span><span id="d290" class="lm ln in mo b gy nc my l mz na">export default Calculator;</span></pre><p id="2ca7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们的前端使用WebSocket协议与我们的后端通信。</p><p id="e36f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">在Netlify上部署前端</strong></p><p id="abc5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些说明摘自我之前关于<a class="ae jz" href="https://medium.com/swlh/launching-your-first-website-rails-react-42a6af1ab481" rel="noopener">部署</a>的博客。</p><p id="2a6f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用<a class="ae jz" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>创建帐户后，选择“从Git创建新站点”选项。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nj"><img src="../Images/85906de8af5cd842b79f7617f1f36db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mGpCs0Aumkj7kp-_.png"/></div></div></figure><p id="0be4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来选择您的Git提供者。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/95fd670f5f4dc391bd77d07a90433800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zhL9B-IMtSnjcWSQ.png"/></div></div></figure><p id="8611" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，Git提供程序会要求您授权Netlify。这样做之后，您将看到一个可供选择的存储库列表。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/549e7110f3b2af22c4eec0a3a6bd82a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v6hZoaUAsoZyOh1G.png"/></div></div></figure><p id="05ff" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">选择前端存储库后，将会填充以下选项。单击“部署站点”按钮。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/31df3b70a85c263e6af0a217252b5d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IkrqF4nHtRLrORoB.png"/></div></div></figure><p id="a642" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">单击“部署站点”按钮后，您将被重定向到您的新站点仪表板，如下所示。需要注意的主要区域是现在称为“建筑”的生产部署区域这里你会看到任何错误，或者如果没有任何错误，你会看到你的网站已经发布。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/f41faca7e823417c09cc5b55e7e80b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MMgB5tZf-owraaZc.png"/></div></div></figure><p id="a85a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果遇到错误，日志会提供错误的详细信息以及如何修复错误。还有一个与可以提供帮助的个人进行实时聊天的功能。修复错误后，您可以转到“部署”选项卡，然后单击“触发部署”重试。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nj"><img src="../Images/638da645fac3982b42adfaf462adfbd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HGqcwVecslIxXn0b.png"/></div></div></figure><p id="b448" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">修复所有错误后，您将会看到一条类似于下面的发布消息。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi no"><img src="../Images/7799e0a9c96d47d7e1b096474b3d6731.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lMCQft6tzNMpAMhz.png"/></div></div></figure><p id="4158" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们的前端已经部署好了，但是我们需要在后端更新app.js文件中的CORS来完成我们的应用程序。然后我们需要把这些改变推进到heroku <code class="fe ml mm mn mo b">git push heroku main</code>。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="475f" class="lm ln in mo b gy mx my l mz na">const io = require("socket.io")(server, {</span><span id="558b" class="lm ln in mo b gy nc my l mz na">   cors: {</span><span id="1780" class="lm ln in mo b gy nc my l mz na"><strong class="mo io">      origin: "https://calculator-chat.netlify.app",</strong></span><span id="c308" class="lm ln in mo b gy nc my l mz na">      methods: ["GET", "POST"],</span><span id="4e90" class="lm ln in mo b gy nc my l mz na">   },</span><span id="9ed0" class="lm ln in mo b gy nc my l mz na">});</span></pre><p id="b29c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">感谢您花时间学习如何使用WebSockets创建聊天应用程序。我希望这个博客将是一个很好的参考，当你需要为将来的项目创建一个WebSocket聊天功能时，可以参考这个博客。</p><h2 id="b9a6" class="lm ln in bd lo lp lq dn lr ls lt dp lu kl lv lw lx kp ly lz ma kt mb mc md me bi translated">资源:</h2><p id="cac6" class="pw-post-body-paragraph ka kb in kc b kd mf kf kg kh mg kj kk kl mh kn ko kp mi kr ks kt mj kv kw kx ig bi translated">拉西亚，塔尼亚。<em class="ni"> Node.js，Express.js，和PostgreSQL: CRUD REST API示例</em>，2018年10月31日，blog . log rocket . com/nodejs-express js-PostgreSQL-CRUD-REST-API-Example/。</p><p id="452a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">“node . js”。<em class="ni">维基百科</em>，维基媒体基金会，2020年12月27日，en.wikipedia.org/wiki/Node.js.</p><p id="98cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">" Rails介绍Rest . "<em class="ni"> Learn </em>，Learn . co/tracks/web-development-immersive-2–0-module-two/rails/intro-to-rest/intro-to-rest。</p><p id="2e92" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">" WebSocket vs REST:了解8个重要的区别."<em class="ni">EDUCBA</em>2020年4月23日<a class="ae jz" href="http://www.educba.com/websocket-vs-rest/." rel="noopener ugc nofollow" target="_blank">www.educba.com/websocket-vs-rest/.</a></p><p id="d684" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">编辑。"什么是API:定义、类型、规范、文档."<em class="ni"> AltexSoft </em>，AltexSoft，2020年2月11日，<a class="ae jz" href="http://www.altexsoft.com/blog/engineering/what-is-api-definition-types-specifications-documentation/." rel="noopener ugc nofollow" target="_blank">www . altex soft . com/blog/engineering/what-is-API-definition-types-specifications-documentation/。</a></p><p id="bb21" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">“面向开发者的网络技术。”Web API | MDN，Mozilla，developer.mozilla.org/en-US/docs/Web/API/WebSockets_API.</p><p id="3c47" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">" Node.js Web应用程序框架。"<em class="ni">快递</em>，expressjs.com/.</p><p id="3fb6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">PostgreSQL全球开发组。<em class="ni"> PostgreSQL </em>，2020年12月27日，【www.postgresql.org/. T21】</p><p id="7222" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">达米恩。“引言。”<em class="ni">插座。2020年11月27日，socket.io/docs/v3.</em></p><p id="4ec5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">斯里什蒂卡。"你想知道的关于WebSockets的一切，真的！"黑客正午，2020年11月30日，Hacker Noon . com/everything-you-everything-everything-everything-you-everything-want-to-know-about-web sockets-literal-a05f 36432999。</p><p id="31e9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">"正文解析器。"<em class="ni"> Npm </em>，<a class="ae jz" href="http://www.npmjs.com/package/body-parser." rel="noopener ugc nofollow" target="_blank">www.npmjs.com/package/body-parser.</a></p><p id="1c80" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">“合用。”<em class="ni">节点</em>，node-postgres.com/features/pooling.</p><p id="77e7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">雷·乔杜里，阿帕拉吉塔。" PostgreSQL连接池:第1部分—优缺点."<em class="ni"> ScaleGrid博客—完全托管的云数据库提示</em>，ScaleGrid，2020年10月19日，scale grid . io/Blog/PostgreSQL-connection-pooling-part-1-利弊/</p><p id="deac" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">“面向开发者的网络技术。”developer.mozilla.org/en-US/docs/Web/HTTP/CORS.<em class="ni"/></p></div></div>    
</body>
</html>