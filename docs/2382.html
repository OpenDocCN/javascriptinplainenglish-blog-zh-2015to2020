<html>
<head>
<title>How to build a URL Shortener like bitly or shorturl using Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Node.js构建一个类似bitly或shorturl的网址缩写器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/url-shortner-with-limit-onclick-count-256ff46bf9fa?source=collection_archive---------0-----------------------#2020-06-19">https://javascript.plainenglish.io/url-shortner-with-limit-onclick-count-256ff46bf9fa?source=collection_archive---------0-----------------------#2020-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2542" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">具有有限OnClick计数的URL缩写</h2></div><p id="8bc5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可能听过很多次，人们要求建立一个更短的URL作为面试问题，这并不复杂，但让它开始建立一个是复杂的。</p><p id="2f1a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以不要浪费时间，让我们开始吧。</p><h2 id="22c3" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">什么是网址缩写</h2><p id="9acc" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">URL shortener是一个简单的工具，它可以将一个长URL转换成你想要的任何URL。</p><h2 id="8fb4" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">为什么我们需要它</h2><p id="fb3a" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">有时，链接到一个位置或社交平台的链接变得如此之大，以至于很难管理它们。一个更短的URL将有助于管理、跟踪和编辑点击数据，以及他们促进分享的一个重要点。</p><h2 id="8acb" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">我们将使用的npm包</h2><p id="73b0" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated"><a class="ae lz" href="https://www.npmjs.com/package/config" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">配置</strong> </a> <strong class="kh ir"> : </strong>可以定义一组默认参数，并针对不同的部署环境(开发、QA、试运行、生产等)进行扩展。).对于生产，我们必须为开发devlopment.js类似地定义production.js。</p><p id="a724" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ma">这将用于存储与DB和其他相关的配置。</em></p><p id="6b78" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lz" href="https://www.npmjs.com/package/valid-url" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">【valid-URL】</strong></a>:该模块收集了常用的URI验证例程，使输入验证、维护更容易，可读性更强。如果测试通过，所有函数都返回一个未赋值的值，如果测试失败，则返回一个未定义的值。</p><p id="4327" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ma">这将用于验证用户给出的URL，以便缩短。</em></p><p id="40f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lz" href="https://www.npmjs.com/package/shortid" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">short id</strong></a>:short id创建非常短的非顺序URL友好的惟一id。</p><p id="3365" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ma">这将用于为每个缩短的URL生成唯一的id。</em></p><p id="3bda" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lz" href="https://www.npmjs.com/package/express" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">Express</strong></a>:Express的理念是为HTTP服务器提供小型、健壮的工具，使之成为单页面应用程序、网站、混合或公共HTTP APIs的优秀解决方案。</p><p id="f810" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ma">这将用于创建服务器和路由不同的HTTP路径。</em></p><p id="6ffe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lz" href="https://www.npmjs.com/package/mongoose" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">mongose</strong></a>:mongose是一个MongoDB对象建模工具，设计用于在异步环境下工作。猫鼬支持承诺和回调。因为他们使用promise，我们将使用JS的异步和等待特性。</p><p id="8a06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ma">这将用于连接MongoDB，保存、更新和查询数据库。</em></p><p id="b9d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，让我们设置MongoDB来设置我们的数据库。</p><h2 id="f923" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">设置MongoDB Atlas</h2><p id="4045" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我想使用MongoDB的云设置而不是本地设置，你可以选择更适合你的。</p><p id="5580" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置云MongoDB Atlas帐户的步骤:</p><ul class=""><li id="a5db" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">参观现场<a class="ae lz" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/cloud/atlas</a></li><li id="bd89" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">创建一个帐户，云设置是免费的</li><li id="4e48" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">创建一个集群</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/e5f256597ad741d52e0fbb68ce6bba95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NFoNRJns1XpJ0Wr88M4PuA.png"/></div></div></figure><ul class=""><li id="bcb3" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">转到连接，创建一个用户</li><li id="5a0a" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">去连接你的应用程序，你会看到一个网址(只要记住网址的位置)。密码将被您的帐户密码替换。</li></ul><h2 id="682b" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">设置项目</h2><p id="b82f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">为您的项目<code class="fe nb nc nd ne b">urlshortener</code>创建一个单独的目录，在您喜欢的IDE中打开该目录。我在这里使用Visual Studio代码。</p><p id="7c51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">进入文件夹并键入<code class="fe nb nc nd ne b">npm init</code>，给出设置项目的必要细节。</p><p id="60eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要下载我们前面讨论过的必要的节点包，键入下面的命令来下载它们</p><pre class="mq mr ms mt gt nf ne ng nh aw ni bi"><span id="f45b" class="lb lc iq ne b gy nj nk l nl nm">npm i express config mongoose shortid valid-url</span></pre><p id="307d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的命令将使用依赖项更新<code class="fe nb nc nd ne b">package.json</code>,并将需要的包下载到<code class="fe nb nc nd ne b">node_modules</code>文件夹中。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nn"><img src="../Images/7e416dedc2660d06c065675d23335900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0opWDa951PoY-fCAKvAzxA.jpeg"/></div></div></figure><h2 id="0a30" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">编码部分</h2><p id="4e58" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">打开代码编辑器。创建一个文件夹来存储配置，给文件夹命名为<code class="fe nb nc nd ne b">config</code>。在文件夹<strong class="kh ir"> default.js </strong>中创建一个文件，并给出您的MongoDB connect URL(我们之前设置了它，我告诉过您要记住它😂)和baseURL。</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><ul class=""><li id="57b5" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">用您为该用户设置的密码替换该密码。</li><li id="e8c1" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">allowedClick是一种限制，即同一个URL可以使用多少次。稍后可用于定价目的。你可以根据你的需要来改变它。</li></ul><h2 id="2bbe" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">MongoDB设置的配置文件</h2><p id="55c9" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们将导入必要的包并与MongoDB连接</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="b588" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">定义存储URL详细信息的模式</h2><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><ul class=""><li id="e6f7" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">猫鼬。模式将定义它将存储的文档细节。当我们编码的时候，每个细节做什么就很清楚了。</li></ul><p id="4eeb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> urlCode </strong>:这将存储与每个URL相关的唯一id。</p><p id="f4c1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> longURL </strong>:这是我们需要缩短的URL。</p><p id="c8a3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> shortUrl </strong>:这是实际的短Url</p><p id="b8f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> clickCount </strong>:存储用户使用短网址的次数。</p><h2 id="7622" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">定义缩短URL的路线</h2><p id="2bb0" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">创建一个名为<code class="fe nb nc nd ne b">routes</code>的文件夹，在其中创建一个文件<code class="fe nb nc nd ne b">shorturl.js</code>，该文件包含缩短URL的代码。</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="7d96" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">让我们来理解代码</h2><p id="eb6e" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">首先，我们导入了随后需要的必要的包。使用<em class="ma"> express </em>包创建一个路由，使用那个路由创建一个HTTP POST处理程序。</p><p id="b4ba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来将它标记为async，因为它确保函数返回一个承诺，并在其中包装非承诺。使用async允许我们使用<code class="fe nb nc nd ne b">await</code>，它让JavaScript等待，直到承诺完成并返回结果。</p><p id="5269" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从请求体中取出为了缩短而提交的URL，还取出在<code class="fe nb nc nd ne b">default.js</code>中提到的基本URL。接下来，我们使用<em class="ma"> valid-url </em>包的<em class="ma"> isUri </em>方法检查提交的URL是否是有效的URL。</p><p id="b0dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查成功后，我们将查询MongoDB，检查发送用于缩短的URL是否已经缩短。如果shorten只返回结果，否则short URL。</p><blockquote class="nq nr ns"><p id="6457" class="kf kg ma kh b ki kj jr kk kl km ju kn nt kp kq kr nu kt ku kv nv kx ky kz la ij bi translated">mongoose方法返回一个<strong class="kh ir">承诺</strong>，所以我们在它之前添加了<strong class="kh ir">wait</strong>到<strong class="kh ir">等待，直到我们得到响应</strong>。</p></blockquote><p id="01a4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了缩短URL，我们将使用<em class="ma"> shortid </em>包的<code class="fe nb nc nd ne b">generate</code>方法生成一个唯一的id。接下来，将惟一id附加到baseURL，以生成一个短URL形式的URL。此外，由于短URL是第一次生成，我们将把<em class="ma">点击计数</em>标记为零。保存文档并将结果作为JSON返回。</p><p id="3a15" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">示例响应(发送需要缩短的亚马逊产品链接)。</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="2c95" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">定义用于重定向短URL顶部目标的路由</h2><p id="d660" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">在<code class="fe nb nc nd ne b">routes</code>文件夹中新建一个名为<code class="fe nb nc nd ne b">getshortenurl.js</code>的文件。</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="665c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">让我们来理解代码</h2><p id="bda3" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">首先，我们导入了随后需要的必要的包。使用<em class="ma"> express </em>包创建一个路由，使用那个路由创建一个HTTP GET处理程序。该网址将得到<em class="ma"> shortUrl </em>作为参数。这个参数是我们附加到baseUrl的唯一代码。</p><p id="0a84" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将<em class="ma"> shortUrl </em>提取到一个单独的变量中。由于代码是唯一的，所以我们可以搜索数据库，如果我们有任何文件与唯一的代码。返回结果存储在一个变量中。</p><p id="8887" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果返回的结果是一个文档，这意味着我们已经缩短了URL。检查返回文档的点击次数，如果点击次数超过了我们在<strong class="kh ir"> default.js </strong>中设置的限制，如果是则返回一个错误，否则增加文档的点击次数并在DB中更新。同样，使用<em class="ma"> res </em>对象的<em class="ma"> redirect </em>方法重定向到长URL。</p><h2 id="3ffc" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">让我们结合一切</h2><p id="5097" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们需要有一个主文件，将所有这些结合在一起，记住我们还没有创建服务器。</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="no np l"/></div></figure><blockquote class="nq nr ns"><p id="c577" class="kf kg ma kh b ki kj jr kk kl km ju kn nt kp kq kr nu kt ku kv nv kx ky kz la ij bi translated">我们在default.js中配置的baseURL的值为<a class="ae lz" href="http://localhopst:8000/v1," rel="noopener ugc nofollow" target="_blank"> http://localhopst:8000/v1，</a>，因为我们的应用程序运行在localhost中，服务器监听POST 8000。getShortenUrlRoute的URL是附加到baseUrl的/v1/ so..</p></blockquote><h2 id="2c1c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">让我们来理解代码</h2><p id="327d" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">使用导入我们在上一步中创建的路由导入必要的包，导入MongoDB连接的配置。</p><p id="8260" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">连接到数据库，创建服务器并连接到一个端口(这里是8000)。</p><p id="edce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将解析JSON格式的传入请求体。</p><p id="33f7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，将路由器连接到适当的URL。现在让我们希望事情会解决。使用<code class="fe nb nc nd ne b">node index.js</code>启动应用程序并播放。</p><p id="e0e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个短URL后，将该短URL粘贴到您的浏览器中，它应该会重定向到主URL。</p><p id="df64" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望这篇博客能帮助你理解如何缩短URL的基础知识。代码可以参考GitHub 上这里的<a class="ae lz" href="https://github.com/codesprintpro/urlshortner" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="dc75" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参考:<a class="ae lz" href="https://youtu.be/Z57566JBaZQ" rel="noopener ugc nofollow" target="_blank">https://youtu.be/Z57566JBaZQ</a></p></div></div>    
</body>
</html>