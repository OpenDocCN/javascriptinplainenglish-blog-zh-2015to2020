<html>
<head>
<title>Node.js Tips — CORS, Excel Files, and CSVs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示— CORS、Excel文件和CSV</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-tips-cors-excel-files-and-csvs-7bc900a61c12?source=collection_archive---------5-----------------------#2020-07-24">https://javascript.plainenglish.io/node-js-tips-cors-excel-files-and-csvs-7bc900a61c12?source=collection_archive---------5-----------------------#2020-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a98ffc74ba38715f0636f43f833c2cf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DxLKAOnwQ2CsLw53"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@viktortalashuk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Viktor Talashuk</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="71c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="ecdf" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Node.js读取Excel文件</h1><p id="4366" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有几个软件包可以让我们在一个节点应用程序中读取Excel文件。</p><p id="f560" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用的一个包是<code class="fe me mf mg mh b">node-xlsx</code>包。</p><p id="8782" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了使用它，我们写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="eb8f" class="mq lc iq mh b gy mr ms l mt mu">const xlsx = require('node-xlsx');<br/>const path = require('path');<br/>const obj = xlsx.parse(path.join(__dirname, '/myFile.xlsx'));</span></pre><p id="183e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以传入一个路径来解析来自这个路径的Excel文件。</p><p id="b4e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4ab0" class="mq lc iq mh b gy mr ms l mt mu">const xlsx = require('node-xlsx');<br/>const path = require('path');<br/>const obj = xlsx.parse(fs.readFileSync(path.join(__dirname, '/myFile.xlsx'));</span></pre><p id="273c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解析一个缓冲区，这个缓冲区由<code class="fe me mf mg mh b">readFileSync</code>返回。</p><p id="e820" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ExcelJS是另一个我们可以用来解析工作簿的包。</p><p id="aa20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a7e4" class="mq lc iq mh b gy mr ms l mt mu">const ExcelJS = require('exceljs');<br/>const path = require('path');<br/>const workbook = new Excel.Workbook();<br/>const filename = path.join(__dirname, '/myFile.xlsx');<br/>workbook.xlsx.readFile(filename);<br/>  .then(() =&gt; {<br/>    // use workbook<br/>  });</span></pre><p id="f340" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从工作簿中读取。</p><p id="a9a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a2c9" class="mq lc iq mh b gy mr ms l mt mu">const workbook = new Excel.Workbook();<br/>stream.pipe(workbook.xlsx.createInputStream());</span></pre><p id="87ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从流中读取。</p><h1 id="e0c5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express中将变量传递给JavaScript</h1><p id="d152" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过向<code class="fe me mf mg mh b">res.render</code>传递第二个参数来传递变量来表达模板。</p><p id="410a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="54cb" class="mq lc iq mh b gy mr ms l mt mu">app.get('/foo.js', (req, res) =&gt; {<br/>  res.set('Content-Type', 'application/javascript');<br/>  res.render('foo', { foo: { bar: 'baz' } });<br/>});</span></pre><p id="311c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">foo</code>模板中，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8c3e" class="mq lc iq mh b gy mr ms l mt mu">&lt;script&gt;<br/>  const foo = &lt;%- JSON.stringify(foo) %&gt;;<br/>&lt;/script&gt;</span></pre><p id="4631" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用EJS模板，所以我们用<code class="fe me mf mg mh b">&lt;%- %&gt;</code>插入变量。</p><p id="ef17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们必须调用<code class="fe me mf mg mh b">JSON.stringify</code>将它转换成一个字符串，这样我们就可以对它进行插值。</p><h1 id="0bba" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">写入Node.js中的CSV</h1><p id="9fdc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">csv-stringify</code>包从嵌套数组中创建一个CSV字符串。</p><p id="d589" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以使用<code class="fe me mf mg mh b">fs.writeFile</code>将CSV字符串写入文件。</p><p id="b358" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b1a9" class="mq lc iq mh b gy mr ms l mt mu">import stringify from 'csv-stringify';<br/>import fs from 'fs';</span><span id="68d8" class="mq lc iq mh b gy mv ms l mt mu">let data = [];<br/>let columns = {<br/>  id: 'id',<br/>  name: 'name'<br/>};</span><span id="8145" class="mq lc iq mh b gy mv ms l mt mu">for (let i = 0; i &lt; 100; i++) {<br/>  data.push([i, `name ${i}`]);<br/>}</span><span id="42a7" class="mq lc iq mh b gy mv ms l mt mu">stringify(data, { header: true, columns }, (err, output) =&gt; {<br/>  if (err) throw err;<br/>  fs.writeFile('file.csv', output, (err) =&gt; {<br/>    if (err) throw err;<br/>    console.log('csv saved.');<br/>  });<br/>});</span></pre><p id="d039" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们为列创建了一个带有<code class="fe me mf mg mh b">columns</code>数组的嵌套数组。</p><p id="7758" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">columns</code>中的键是字段名。<code class="fe me mf mg mh b">columns</code>中的值是标题名称。</p><p id="7137" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们将数据填充到<code class="fe me mf mg mh b">data</code>数组中。</p><p id="4404" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们调用<code class="fe me mf mg mh b">stringify</code>将标题和数据转换成一个CSV字符串。</p><p id="307f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个参数是数据。</p><p id="8c57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么2nd就是一个有一些选项的对象。</p><p id="c2db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">header</code>设置为<code class="fe me mf mg mh b">true</code>意味着我们显示一些表头。</p><p id="7fdb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">columns</code>用于设置列字段。</p><p id="0842" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些列由每行中每个项目的位置填充。</p><p id="01c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于<code class="fe me mf mg mh b">data</code>中的每一行，第一个条目是<code class="fe me mf mg mh b">id</code>，第二个是<code class="fe me mf mg mh b">name</code>。</p><p id="08da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当CSV转换完成时调用回调。</p><p id="06ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">output</code>有CSV字符串。</p><p id="54ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以<code class="fe me mf mg mh b">fs.writeFile</code>把字符串写到一个文件中。</p><h1 id="aac8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Reload Express.js路由更改，无需手动重启服务器</h1><p id="3937" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当我们使用Nodemon修改代码时，我们可以让Express应用程序自动重启。</p><p id="620f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦安装完毕，我们可以用<code class="fe me mf mg mh b">nodemon</code>而不是<code class="fe me mf mg mh b">node</code>运行我们的应用程序。</p><p id="eb68" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要安装它，我们运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="67f9" class="mq lc iq mh b gy mr ms l mt mu">npm install -g nodemon</span></pre><p id="5989" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2541" class="mq lc iq mh b gy mr ms l mt mu">nodemon app.js</span></pre><p id="ae82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">去使用它。</p><h1 id="813d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">修复快速应用程序的“预检响应中的访问控制允许标题不允许请求标题字段授权”错误</h1><p id="a58e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加<code class="fe me mf mg mh b">cors</code>中间件来允许跨来源的请求。</p><p id="df72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么这个错误应该会消失。</p><p id="ca15" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a843" class="mq lc iq mh b gy mr ms l mt mu">const express = require('express');<br/>const cors = require('cors');<br/>const app = express();<br/>app.use(cors());<br/>app.options('*', cors());</span></pre><p id="1106" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">cors</code>中间件来添加<code class="fe me mf mg mh b">Access-Control-Allow-Origin</code>和<code class="fe me mf mg mh b">Access-Control-Allow-Methods</code>头。</p><p id="8220" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们用<code class="fe me mf mg mh b">cors</code>中间件添加了所需的选项路由。</p><p id="32c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们允许所有路由接受带有<code class="fe me mf mg mh b">'*'</code>的选项请求。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/ab63f0f35a8fa53a810685fc334696d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QjVq0mHvwnRkE5w3"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@bonniekdesign?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Bonnie Kittle</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="b822" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="ed1c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有几个读取Excel文件的包。</p><p id="bbb9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用Express把变量传递给模板。</p><p id="9337" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以使用库轻松地将CSV写入文件。</p><p id="212d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了让我们的Express应用程序监听跨来源的请求，我们需要<code class="fe me mf mg mh b">cors</code>中间件。</p></div></div>    
</body>
</html>