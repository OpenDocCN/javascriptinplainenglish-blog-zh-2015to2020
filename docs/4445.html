<html>
<head>
<title>Make Testing Expo Apps Easy With Deep Links</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过深层链接轻松测试世博会应用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/making-testing-expo-apps-easy-with-deep-links-1c3af12dcd74?source=collection_archive---------2-----------------------#2020-12-12">https://javascript.plainenglish.io/making-testing-expo-apps-easy-with-deep-links-1c3af12dcd74?source=collection_archive---------2-----------------------#2020-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f86eebe1396a9d28ff2438e92acc2d7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TOmrUD6dF2XgI5Z2"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@cloud_symmetry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Aaron Lau</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a74a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://medium.com/swlh/building-my-first-app-jiffycv-53192b24b386" rel="noopener">我花了七个月的时间用Expo构建了一个React原生应用，我真的很享受选择Expo带给我的灵活性。</a></p><p id="c2e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">构建服务尤其为我节省了大量时间，让我可以花更多时间处理单调的应用商店提交，每次我这样做时，事情似乎越来越复杂。</p><p id="9eb1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然深层链接不是Expo独有的，但当你的应用程序在Expo客户端运行或作为独立应用程序运行时，你会面临一些额外的复杂性，两者都有不同的深度链接结构。</p><h1 id="c997" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是深度链接？</h1><p id="12e3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">深层链接(也称为自定义URL方案)是一种统一资源标识符(URI)，当在支持它们的设备上打开时，会打开相应的应用程序来侦听该特定的“方案”。然后，该应用程序可以使用URI将用户直接带到应用程序中的屏幕，或者设置应用程序状态，以便配置所需的行为。</p><p id="69b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，当在安装了脸书应用程序并支持深层链接的设备上访问深度链接<code class="fe me mf mg mh b">fb://profile/6661337</code>时，将为用户打开脸书应用程序，并使用提供的ID将他们带到个人资料页面。</p><h1 id="f6be" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为什么要使用深层链接进行测试？</h1><p id="8f6a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">除了能让用户在他们的设备上点击另一个应用程序的链接时启动你的应用程序，深度链接还有很多好处。</p><p id="c70d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们允许更简化的UX，因为启动您的应用程序通常比等待链接加载到网页上更快，尤其是在用户需要进行身份验证并且他们已经登录到您的应用程序的情况下。</p><p id="3470" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们允许更快地进入特定的应用状态，例如将产品添加到购物篮或访问特定的帖子，而不需要用户自己执行进入该状态所需的操作，这可能意味着更高的参与度和转化率。</p><p id="47b7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">后一个方面是对测试最有用的方面，因为能够将应用程序设置为满足测试用例先决条件的状态可以节省时间并产生更一致的结果。</p><p id="d80e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">深层链接还允许定义路径和查询字符串参数，因此可以基于以这种方式传递给应用程序的值动态创建状态。</p><h1 id="3024" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">处理世博会中的深层链接</h1><p id="fe7a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了给你的Expo应用建立深层链接，你首先需要决定一个方案名称。</p><p id="bfc3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这可以是你的应用程序名称或另一个字符串，如果你需要分解字符串，可以包含<code class="fe me mf mg mh b">.</code>、<code class="fe me mf mg mh b">+</code>或<code class="fe me mf mg mh b">-</code>，尽管我会避免这些以确保最大的兼容性。</p><p id="05ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你决定了一个方案，你就把它添加到你的<code class="fe me mf mg mh b">expo.scheme</code>属性下的<code class="fe me mf mg mh b">app.json</code>文件中。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">The scheme determines the protocol part of the Deep Link URI, for instance exampleapp://</figcaption></figure><p id="4048" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将向应用程序的独立版本添加适当的条目，以便它与使用该方案的URIs相关联。</p><p id="9650" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在你的应用程序代码中，你可以使用<code class="fe me mf mg mh b">expo-linking</code>库来调用<code class="fe me mf mg mh b">getInitialURL()</code>函数，当应用程序通过深度链接启动时，它将返回深度链接URI的一个承诺。</p><p id="13df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当应用程序在前台运行时，为了检测深层链接，你可以使用<code class="fe me mf mg mh b">addEventListener('url', callback)</code>为URIs设置一个监听器。</p><p id="5e88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">前台事件侦听器对于处理身份验证流非常有用，在这种情况下，您会将用户发送到网站进行登录，并通过深度链接将他们重定向到应用程序。它对于测试也很有用，因为您不需要关闭并重新启动应用程序来更改应用程序的状态。</p><p id="8db6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你有了深度链接URI，你可以使用<code class="fe me mf mg mh b">parse()</code>从中提取不同的组件，这也将解释世博会客户端和独立URIs之间的差异。</p><p id="af65" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我发现使用<code class="fe me mf mg mh b">getInitialURL()</code>的最好地方是Expo <code class="fe me mf mg mh b">AppLoading</code>组件的<code class="fe me mf mg mh b">startAsync</code>函数内部。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">The AppLoading component allows for async operations to be completed within the main entry point, this is useful as this entry point cannot be an async function</figcaption></figure><p id="6ffe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这允许解析深度链接，并允许您在应用程序仍在加载时设置应用程序的状态，例如，如果您想要使用深层链接将应用程序置于特定状态以进行测试或演示其功能，这将非常有用。</p><h2 id="0e9d" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">独立应用程序和世博客户端应用程序在URI的差异</h2><p id="608b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在开发过程中，您可能会使用Expo客户端应用程序运行您的应用程序。Expo客户端让你在开发的时候测试你的应用变得非常容易，但是它会让你很难使用深层链接。</p><p id="31c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Expo客户端不会使用您在<code class="fe me mf mg mh b">app.json</code>中定义的深度链接方案，因为它有自己的模式<code class="fe me mf mg mh b">exp://</code>，并要求您的路径以Expo服务器的主机名为前缀，以便从和<code class="fe me mf mg mh b">--/ </code>中获取应用程序文件。</p><p id="e60e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于在本地Expo服务器上运行的应用程序，您可以在二维码上方的Expo开发者工具页面或运行该流程的终端中找到要使用的主机名，同样在二维码上方。</p><p id="adce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于在本地运行的应用程序，生成的URI看起来像<code class="fe me mf mg mh b">exp://[HOSTNAME AND PORT]/--/testing/reset-db</code>,对于发布到Expo的应用程序，看起来像<code class="fe me mf mg mh b">exp://exp.host/@[USERNAME]/[APP SLUG]/--/testing/reset-db</code>。</p><p id="9bca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">独立应用程序将使用在<code class="fe me mf mg mh b">app.json</code>中定义的方案，既不需要主机名也不需要<code class="fe me mf mg mh b">--/</code>前缀，因此上面的示例是针对独立应用程序的<code class="fe me mf mg mh b">[APP SCHEME]://testing/reset-db</code>。</p><p id="3493" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在我的基于Appium的自动化测试中处理这个问题，我传入了一个环境变量，在针对Expo客户端和独立应用程序运行测试套件时，我可以用它来创建适当的深度链接。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">In getDeepLinkUri optional behaviours can be passed in to create Deep Links that set the app state into a specific configuration</figcaption></figure><h1 id="f069" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">触发深层链接进行测试</h1><p id="7f32" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有很多方法可以触发深层链接，有些更适合在设备上手动测试，有些更适合自动化测试。</p><h2 id="8423" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">使用网络浏览器</h2><p id="1242" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">深度链接旨在弥合应用程序和外部服务之间的差距，所以你会认为从网络浏览器内部启动深度链接是很自然的事情。</p><p id="8f43" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Android Chrome不允许在地址栏中直接输入自定义方案，这样做只是执行谷歌搜索。相反，您需要创建一个带有锚标记(<code class="fe me mf mg mh b">&lt;a&gt;</code>)的网页，并将深度链接作为<code class="fe me mf mg mh b">href</code>属性。</p><p id="470b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在iOS上，你可以在Safari的地址栏中输入深度链接URI，它会询问你是否要打开该应用程序。与Android类似，这在iOS版Chrome上也不起作用。</p><h2 id="224e" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">二维码</h2><p id="4265" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这是我在使用实际设备时触发深层链接的首选方法，尤其是在设备没有插入计算机进行调试的情况下。</p><p id="3134" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个过程是使用像<a class="ae kc" href="https://www.qr-code-generator.com/" rel="noopener ugc nofollow" target="_blank"> QR码生成器</a>这样的工具为深度链接URI生成一个QR码，然后使用设备上的相机应用程序扫描它。</p><p id="b010" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在iOS上，你可以使用内置的相机应用程序，当扫描二维码时，它会问你是否要打开应用程序，在Android上，如果你的相机应用程序不支持二维码，你可能需要下载二维码扫描应用程序。</p><p id="a8a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我喜欢这种方法，因为二维码易于创建、共享和扫描，而且你不用在复杂的URIs中输入，你不太可能犯错误，这加快了测试过程。</p><h2 id="1ff3" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">Android调试桥(ADB)</h2><p id="6e97" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果你在本地Android模拟器上运行你的应用，或者你的Android设备已经接入，并且开发者模式已经激活，你可以使用<code class="fe me mf mg mh b">adb</code>为你触发深度链接。</p><p id="d492" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你需要将<code class="fe me mf mg mh b">adb</code>安装到你的电脑上，并在你的路径中设置好，这样做是在模拟器上触发深度链接最简单的方法。</p><p id="4822" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了触发深度链接，你需要在终端上运行<code class="fe me mf mg mh b">adb shell am start -d [DEEP LINK URI]</code>，设备会立即打开你的应用程序(不像iOS会问你是否要打开应用程序)。</p><h2 id="993c" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">xcrun命令</h2><p id="a0b4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">对于iOS来说，相当于<code class="fe me mf mg mh b">adb</code>的是<code class="fe me mf mg mh b">xcrun</code>，以类似的方式，你可以用它来触发深层链接。</p><p id="5663" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">xcrun</code>是在您安装Xcode命令行工具时安装的，并且仅在Mac上可用。像<code class="fe me mf mg mh b">adb</code>一样，这种方法只对本地模拟器和插入式设备有用。</p><p id="9505" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了触发深度链接，你需要在你的终端上运行<code class="fe me mf mg mh b">xcrun simctl openurl booted [DEEP LINK URI]</code>，设备会询问你是否要打开你的应用程序。</p><h2 id="277d" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">Appium</h2><p id="0ed3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Appium是我选择的自动化框架，它有一个快捷方式，可以很容易地在Android上启动深层链接。</p><p id="c126" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不幸的是，iOS就不一样了。令人欣慰的是，一位<a class="ae kc" href="https://appiumpro.com/editions/84-reliably-opening-deep-links-across-platforms-and-devices" rel="noopener ugc nofollow" target="_blank"> ppium Pro发表了一篇关于深度链接和Appium </a>的文章，这对理解你的选择非常有用。</p><p id="a675" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用Appium在Android上启动深度链接，您可以使用<code class="fe me mf mg mh b">client.execute</code>命令<code class="fe me mf mg mh b">mobile:deeplink</code>，并提供一个带有URI和包的选项对象:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">mobile:deepLink only works on Android</figcaption></figure><p id="f572" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用Appium在iOS上启动深度链接，您需要使用Safari在地址栏中输入深度链接，并接受提示以启动应用程序(您可以在Appium上设置自动接受提示的功能以加快速度)。</p><p id="b49e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果不是因为iOS倾向于在版本之间重命名元素，这将是非常容易的，因此针对最新的iOS版本运行自动化可能需要一些努力来更新这个过程。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">I find it easier to wrap the behaviours needed for each iOS version in a function</figcaption></figure><h2 id="45aa" class="mo lc iq bd ld mp mq dn lh mr ms dp ll ko mt mu lp ks mv mw lt kw mx my lx mz bi translated">世博会客户历史</h2><p id="93aa" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果您正在使用Expo客户端测试您的应用程序，并且您之前已经使用深度链接启动了该应用程序，它会将URI存储在其“最近打开”列表中。</p><p id="e450" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按下这些列表项中的一项将启动与之前相同的URI应用程序，但是值得注意的是，当测试运行在本地网络上的Expo服务器或通过“隧道”选项时，您可能会发现主机名已改变，这些链接将不起作用。</p><p id="0444" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你正在测试一个使用前台深度链接监听方法的应用程序，这可能是一个改变应用程序状态的非常简单的方法，因为你可以调出Expo客户端菜单，返回Expo客户端主屏幕，从列表中选择一个链接，然后返回应用程序，根据需要设置状态。</p><h1 id="8d5d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="6eff" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">深度链接是一个非常有用的测试工具，因为它们允许你轻松地配置应用程序并启动到一个设置的应用程序状态，或者如果使用前台方法，甚至更新应用程序状态而无需重新启动应用程序。</p><p id="8f9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了在Expo客户端和独立应用程序上使用深度链接的不同，Expo使得实现和使用深度链接变得非常容易，这使得让你的应用程序可测试变得非常简单。</p></div></div>    
</body>
</html>