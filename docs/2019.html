<html>
<head>
<title>Controlling the subscriptions of effects in NGRX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">控制NGRX中效果的订阅</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/controlling-the-subscriptions-of-effects-in-ngrx-956822e1d0b1?source=collection_archive---------3-----------------------#2020-05-13">https://javascript.plainenglish.io/controlling-the-subscriptions-of-effects-in-ngrx-956822e1d0b1?source=collection_archive---------3-----------------------#2020-05-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/21477c881b0ce47506d56c9e1111eed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3mAHO-JLpBHb8UCjZT1Sg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jfobranco?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Joao Branco</a> on <a class="ae kc" href="https://unsplash.com/s/photos/stream?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9e1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">效果用于<a class="ae kc" href="https://ngrx.io/" rel="noopener ugc nofollow" target="_blank"> NGRX </a>中的副作用。它们监听动作，将这个动作转换成副作用，如网络请求、网络套接字请求、浏览器API事件等。并且可能会也可能不会从中分派新的动作。</p><p id="867e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，一个效果类是单例的，尽管它是在根或特性级别创建的。它永远不会被销毁，所以它包含的所有动作监听器将永远监听存储动作。有些情况下，我们希望取消所有侦听器对操作的订阅，过一段时间后再重新订阅它们。</p><h1 id="e67c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">真实世界场景</h1><p id="a1dd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">假设我们有一个购物应用程序。有一个购物车页面，用户可以看到他的购物车物品。他可以使用登录弹出窗口授权，成功授权后，我们必须加载购物车物品，而无需刷新页面。</p><p id="5552" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们有<code class="fe me mf mg mh b">LOGIN_USER_SUCCESS</code>动作，通知用户已经被授权</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="64cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有，我们有<code class="fe me mf mg mh b">LOAD_CART</code>动作，授权后会调度</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="5fe8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以及将这两者结合起来的<code class="fe me mf mg mh b">CartEffect</code>类本身</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="2c25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(为了简单起见，我们只调度一个动作，而不从后端API获取数据)</p><p id="d58e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们想象一下，一个用户导航到购物车页面(我们的效果已初始化)，然后导航到其他页面并在那里获得授权。因为这个效果已经被初始化了，它仍然会监听<code class="fe me mf mg mh b">LOGIN_USER_SUCCESS</code>的动作，会调度<code class="fe me mf mg mh b">LOAD_CART</code>的动作，即使这不是我们的本意。这是一个非常简单和明显的错误。怎么才能修好？</p><p id="ede5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须做到以下几点</p><ul class=""><li id="9630" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la mt mu mv mw bi translated">仅当用户在购物车页面上时，才监听<code class="fe me mf mg mh b">LOGIN_USER_SUCCESS</code>动作</li><li id="28cf" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated">每当用户离开页面时，取消侦听器的订阅</li></ul><h1 id="b50f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">实现ngrxOnRunEffects</h1><p id="dbc9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以实现一个<code class="fe me mf mg mh b">effect</code>类的<code class="fe me mf mg mh b">ngrxOnRunEffects</code>方法。该方法负责根据条件订阅和取消订阅所有效果解析器。</p><p id="ab12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们需要两个额外的动作</p><ul class=""><li id="00ad" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la mt mu mv mw bi translated">购物车_页面_初始化</li><li id="596f" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated">购物车_页面_已销毁</li></ul><p id="64ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每当<code class="fe me mf mg mh b">CART_PAGE_INITIALIZED</code>动作将被调度时，我们必须订阅我们的效果解析器，并且每当<code class="fe me mf mg mh b">CART_PAGE_DESTROYED</code>将被调度时，我们必须取消订阅我们的效果解析器。</p><p id="77f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们添加这些操作:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="e993" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在将它们分派到<code class="fe me mf mg mh b">cart-page.component</code>里面，恰如其分:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="ee37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们剩下的就是，实现<code class="fe me mf mg mh b">ngrxOnRunEffects</code>方法:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="d676" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无论何时<code class="fe me mf mg mh b">CART_PAGE_INITIALIZED</code>将被调度(使用<code class="fe me mf mg mh b">exhaustMap</code>操作符),我们都订阅我们的效果解析器，并且无论何时<code class="fe me mf mg mh b">CART_PAGE_DESTROYED</code>将被调度(使用<code class="fe me mf mg mh b">takeUntil</code>操作符),我们都取消订阅它们</p></div></div>    
</body>
</html>