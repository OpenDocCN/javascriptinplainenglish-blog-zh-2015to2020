<html>
<head>
<title>Upload files to Azure blob storage using GraphQL and Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GraphQL和Node.js将文件上传到Azure blob存储</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/upload-files-to-azure-blob-storage-using-graphql-and-nodejs-ffbea65156a7?source=collection_archive---------7-----------------------#2020-09-27">https://javascript.plainenglish.io/upload-files-to-azure-blob-storage-using-graphql-and-nodejs-ffbea65156a7?source=collection_archive---------7-----------------------#2020-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c8cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">文件上传是大多数网站的重要组成部分，由于GraphQL越来越受欢迎，GraphQL社区开始询问我们如何使用GraphQL上传文件。</p><p id="2b4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后袁晓超·塞里奇为GraphQL多部分请求创建了一个<a class="ae kl" href="https://github.com/jaydenseric/graphql-multipart-request-spec" rel="noopener ugc nofollow" target="_blank">规范，并为GraphQL创建了一个</a><a class="ae kl" href="https://github.com/jaydenseric/graphql-upload" rel="noopener ugc nofollow" target="_blank">上传包</a>来支持多部分请求。之后，Apollo在Apollo Server 2.0中加入了这个特性。所以现在我们可以使用GraphQL轻松上传文件。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/27498bf90535039ebd256839726e869f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LdEtUhScg5B2pGi9I5HyqA.jpeg"/></div></div></figure><h1 id="8c0e" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">服务器配置</h1><p id="29cd" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我们使用apollo-server来创建GraphQL服务器。Apollo-Server有一个很棒的<a class="ae kl" href="https://www.apollographql.com/docs/apollo-server/getting-started/" rel="noopener ugc nofollow" target="_blank">文档</a>可以开始使用。因此，让我们创建根目录并安装所需的包。apollo-server集成了流行的Node.js库，如express、koa等。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="449b" class="mg kz iq mc b gy mh mi l mj mk">mkdir graphql-azure<br/>cd graphql-azure<br/>npm init -y<br/>npm install apollo-server graphql azure-storage</span></pre><p id="31af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在安装了所需的包之后，我们可以创建模式和解析器。</p><h2 id="7d1d" class="mg kz iq bd la ml mm dn le mn mo dp li jy mp mq lm kc mr ms lq kg mt mu lu mv bi translated">创建模式</h2><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="12a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的模式将是这样的。我们将拥有包含文件名、mimetype和编码字段的文件类型。singleUpload 变异将用于上传我们的文件到azure。这种变异使用<strong class="jp ir">上传</strong>标量类型作为参数的类型。从Apollo Server 2.0开始，上传类型是内置的。文件的返回类型用于确保文件正确上传到GraphQL服务器。当然，它可以根据您的需要进行更改，如返回一个布尔值或字符串。创建模式后，我们需要为singleUpload变异创建一个解析器，以便将文件存储到Azure blob存储中。</p><h2 id="1702" class="mg kz iq bd la ml mm dn le mn mo dp li jy mp mq lm kc mr ms lq kg mt mu lu mv bi translated">创建解析程序</h2><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="e70f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用<code class="fe my mz na mc b">createBlockBlobFromStream</code>方法上传文件。此方法将文件流式传输到Azure blob存储。<code class="fe my mz na mc b">createBlockBlobFromStream</code>以<strong class="jp ir">容器名</strong>、<strong class="jp ir">文件名</strong>(文件名用作blob存储中的文件名，因此可以相应更改)、<strong class="jp ir"> filestream </strong>、<strong class="jp ir"> streamsize </strong>作为参数，并提供一个回调函数，该函数以error和response作为参数。streamsize将出现在请求的头中。所以请求对象是在GraphQL的上下文对象中传递的。还有其他上传文件到azure的方法，比如<code class="fe my mz na mc b">createBlockBlobFromLocalFile</code>，但是它要求文件临时存储在文件系统中。</p><h2 id="d301" class="mg kz iq bd la ml mm dn le mn mo dp li jy mp mq lm kc mr ms lq kg mt mu lu mv bi translated">创建服务器和Azure</h2><p id="26e4" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在index.js文件中，我们首先需要导入包并创建apollo-server实例。然后我们需要使用azure连接字符串来配置azure。要创建azure存储帐户和容器，请访问官方文档。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="ef83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们测试一下我们的应用程序。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nb"><img src="../Images/ab4b754ac9f116ac06ad3279e231bbb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5aUVAliK8Vgty3hoZluqA.png"/></div></div></figure><p id="5066" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您可以看到我们的文件已经成功上传，并且返回了带有文件名、mimetype和编码的响应。此外，我们可以在我们的文档中看到列出了我们的singleUpload突变。现在，让我们检查azure门户网站，如果我们的图像已经成功上传。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nb"><img src="../Images/326b23bc2d02a956176bfa820768a392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RkvyB1oC7T6rJhcxJHS7QQ.png"/></div></div></figure><p id="21b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">文件已成功上传到azure。</p><p id="6ec3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望这对你有帮助。如果你有任何疑问或建议，请在评论区告诉我。</p><p id="606d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝您愉快:)</p></div></div>    
</body>
</html>