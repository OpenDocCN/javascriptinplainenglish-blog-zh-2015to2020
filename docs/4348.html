<html>
<head>
<title>I built my personal website using Gatsby, Strapi, Heroku, Netlify and Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我用Gatsby，Strapi，Heroku，Netlify和Github Actions建立了我的个人网站</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/i-built-my-personal-website-using-gatsby-strapi-heroku-netlify-and-github-actions-879ca9098dab?source=collection_archive---------1-----------------------#2020-12-05">https://javascript.plainenglish.io/i-built-my-personal-website-using-gatsby-strapi-heroku-netlify-and-github-actions-879ca9098dab?source=collection_archive---------1-----------------------#2020-12-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/340b2f5a43e7baad5f2292f6cabc70ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uUv3yOK8z9TbG8Dz_gHwXw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@seanlimm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Sean Lim</a> on <a class="ae jz" href="https://unsplash.com/s/photos/programming?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1fe7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我想建立我的网站，并有一些类似CI/CD管道的地方，以推动从本地开发到生产的变化很容易。我想有一个前端和后端分别部署，相互通信。</p><p id="2c0d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在Netlify上建立了Gatsby前端站点，而内容由部署在Heroku上的Strapi管理。我还向Strapi添加了定制的webhooks，以通过Github Actions工作流触发站点的构建。在Github上构建站点节省了我在Netlify上宝贵的构建时间(你每个月只能获得有限的构建时间)。</p><p id="80b0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过写这篇文章，我希望读者也能建立自己的环境，舒适地创建和管理个人网站。</p><p id="7c26" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这不是盖茨比或斯特拉皮的教程。这里有一个很棒的教程<a class="ae jz" href="https://www.youtube.com/watch?v=asB-dUwpH4Y&amp;t=12086s" rel="noopener ugc nofollow" target="_blank"/>，它比我做得更好。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="5555" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">如何在本地安装和运行Strapi</h2><p id="f340" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">为了在本地运行Strapi，Node.js的最低版本是12.x，建议使用14.x。您还需要Npm版本6.x。</p><p id="a7b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你想跳过这一部分，可以在这里找到很多关于如何安装Strapi <a class="ae jz" href="https://strapi.io/documentation/v3.x/installation/cli.html" rel="noopener ugc nofollow" target="_blank">的文档。</a></p><p id="8d31" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Npm安装一个Strapi项目。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8bda" class="lf lg in mi b gy mm mn l mo mp">npx install create-strapi-app project-name --quickstart</span></pre><p id="64ae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Strapi目前支持SQLite、PostgreSQL、MySQL、MariaDB和MongoDB作为数据库。该选项告诉Strapi使用SQLite，坦白地说，这正是我使用Strapi进行本地开发所需要的。</p><p id="d189" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">跑Strapi run</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="eedd" class="lf lg in mi b gy mm mn l mo mp">npm run develop</span></pre><p id="2f37" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你会看到类似这样的东西</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/a116f1f4976ff9abb9972a8e8b23eb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*evikNGr7vHB741WdwETIUA.png"/></div></figure><p id="06bd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">转到<code class="fe mq mr ms mi b">http://localhost:1337/admin</code>并创建一个帐户。您将被重定向到管理页面。您现在有了一个工作的本地Strapi实例。</p><p id="5be5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦你进入管理页面，你就可以创建和管理网站内容，无论是博客文章，关于我的信息，还是工作经验，任何你真正想要的东西。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="dc2a" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">盖茨比场景</h2><p id="79cd" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">Gatsby文档非常简洁地解释了如何安装和使用Gatsby。</p><p id="f4e7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">与Strapi类似，确保系统上安装了Node.js、NPM和Git。</p><p id="731b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装Gatsby CLI工具</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="0520" class="lf lg in mi b gy mm mn l mo mp">npm install -g gatsby-cli</span></pre><p id="4506" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要创建一个新的gatsby项目，您可以利用Gatsby“starters”(带有一些默认配置的部分构建的站点)。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="0ea7" class="lf lg in mi b gy mm mn l mo mp">gatsby new gatsby-project-name https://github.com/gatsbyjs/gatsby-starter-hello-world</span></pre><p id="96d5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Github URL指向一个包含Gatsby项目启动代码的存储库。要在本地运行Gatsby，请键入</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="a24e" class="lf lg in mi b gy mm mn l mo mp">gtasby develop</span></pre><p id="de8c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认情况下，您的本地Gatsby实例将在<code class="fe mq mr ms mi b">http://localhost:8000</code>上运行。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="8e74" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">Gatsby从Strapi检索内容</h2><p id="db83" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">为了让Gatsby从Strapi获取内容，安装下面的Gatsby插件——Gatsby有一个丰富的插件系统。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8fd0" class="lf lg in mi b gy mm mn l mo mp">npm install gatsby-source-strapi</span></pre><p id="1710" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">插件在<code class="fe mq mr ms mi b">gatsby-config.js</code>文件中定义和配置。目前，本地Strapi实例的URL已经足够了。还指定了要检索的内容类型。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b823" class="lf lg in mi b gy mm mn l mo mp">plugins : [<br/>    {<br/>        resolve: `gatsby-source-strapi`,<br/>        options: {<br/>            apiURL: `http://localhost:1337`,<br/>            queryLimit: 1000, // default to a 100<br/>            contentTypes: [`article`, `experience`],<br/>            singleTypes: [`about`],<br/>        }<br/>    }<br/>]</span></pre><p id="bc8d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">正如我之前提到的，我不会涉及如何使用graphql查询Strapi文档，因为它已经广泛涉及<a class="ae jz" href="https://www.youtube.com/watch?v=asB-dUwpH4Y&amp;t=12099s" rel="noopener ugc nofollow" target="_blank">这里</a>，或者任何其他关于Gatsby的深入教程。</p><p id="0ec6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您的Gatsby现在可以从Strapi查询内容并在前端使用它。停止运行您当前的本地Gatsby项目。确保Strapi实例仍在运行，并执行以下命令</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="6873" class="lf lg in mi b gy mm mn l mo mp">gatsby build</span></pre><p id="0a69" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一个名为<code class="fe mq mr ms mi b">public</code>的文件夹将出现在您的项目的根目录中。这是您的静态站点，它被编译到一个文件夹中，所有内容都来自Strapi。</p><p id="b856" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，您可以将该文件夹拖放到Netlify中进行部署。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="2dc0" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">在网络上部署公用文件夹</h2><p id="e1f2" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">在Netlify上创建一个帐户。这是一个直截了当的过程。</p><p id="1956" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦你有了一个团队的帐户，你就可以创建和部署一个新的站点，只需将你的<code class="fe mq mr ms mi b">public</code> gatsby文件夹拖放到<strong class="kc io"> Sites </strong>下的拖放区。</p><p id="e27d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你的网站将需要一点时间来建立。完成后，您可以通过Netlify生成的长URL打开您的实时网站。你手上有一个工作地点！</p><p id="4376" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每次更新后，我都在重复这个过程。拖放功能是惊人的，但我想要一个更好的体验，一个更适合开发人员的体验，在我将代码推送到Github库后，我的站点会更新。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="1d20" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">将Strapi部署到Heroku</h2><p id="ab5d" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">Netlify提供了从Git构建站点的选项。但是为了做到这一点，我必须有一个部署好的Strapi API版本，以便查询每个Gatsby构建的内容。<code class="fe mq mr ms mi b">http://localhost:1337</code>对远程Github存储库上的代码没有任何意义。</p><p id="f7da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Strapi官网有<a class="ae jz" href="https://strapi.io/documentation/v3.x/getting-started/deployment.html" rel="noopener ugc nofollow" target="_blank">文档</a>介绍如何将Strapi部署到Heroku、AWS、Azure、DigitialOcean、Google App Engine等各种平台。我选择了Heroku，因为我发现它最容易使用。</p><p id="284d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Heroku部署指令相当广泛，你可以完全跳过这一部分。然而，我确实发现了一些细微的差别，我想详细说明一下。</p><p id="96c8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你必须安装git和一个免费的Heroku帐户。此外，请确保安装Heroku CLI。</p><p id="445b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以从命令行登录Heroku</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9f94" class="lf lg in mi b gy mm mn l mo mp">heroku login</span></pre><p id="c9df" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将把你重定向到Heroku网站，在那里你将被验证使用你的帐户。完成后，返回命令行。</p><p id="03fe" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更新您的<code class="fe mq mr ms mi b">.gitignore</code>文件以包含<code class="fe mq mr ms mi b">package-lock.json</code>。包含它可能会在Heroku上产生一些问题。我懒得去了解原因。我信任Heroku！</p><p id="c0c1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您必须将您的Strapi项目初始化为git项目，该项目将由Heroku管理。确保您位于项目文件夹中。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="e175" class="lf lg in mi b gy mm mn l mo mp">cd project-folder<br/>git init<br/>git add .<br/>git commit -m "First Commit"</span></pre><p id="91b9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你可以创建一个Heroku应用程序</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="ae0b" class="lf lg in mi b gy mm mn l mo mp">heroku create</span></pre><p id="dd0d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个命令通常只在初始化的git存储库上使用。它在Heroku应用程序上创建了一个远程git存储库，您可以将本地存储库中的更改推送到这个存储库中。</p><p id="2647" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你在Heroku上有了一个免费的应用程序(我相信一个用户总共可以得到三个免费的应用程序),并且配置了你的本地存储库。要让Strapi在Heroku上工作，您需要使用PostgreSQL或MongoDB。就这么定了。</p><p id="4e22" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装Postgres附加组件(Heroku上的附加组件似乎相当于盖茨比的插件)。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="dd53" class="lf lg in mi b gy mm mn l mo mp">heroku addons:create heroku-postgresql:hobby-dev</span></pre><p id="4b55" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该插件将数据库凭证暴露在一个环境变量中，您可以通过Heroku config访问该变量</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="83d5" class="lf lg in mi b gy mm mn l mo mp">heroku config</span></pre><p id="63e8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将打印一个URL，显示为“postgres://USERNAME:PASSWORD @ HOST:PORT:DATABASE _ NAME”。</p><p id="ff2f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为Strapi需要数据库凭证来连接数据库，所以您需要从上面的URL中解构变量。</p><p id="c40d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">用npm安装<code class="fe mq mr ms mi b">pg-connection-string</code>模块；</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="f8ac" class="lf lg in mi b gy mm mn l mo mp">npm install pg-connection-string --save</span></pre><p id="f286" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你看一下文件<code class="fe mq mr ms mi b">./config/database.js</code>，你会看到它现在是</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4dde" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mq mr ms mi b">env</code>让你访问环境变量。为了在Heroku上本地和生产中使用Strapi，我们需要配置<code class="fe mq mr ms mi b">database.js</code>，以便基于<code class="fe mq mr ms mi b">process.env.NODE_ENV</code>使用不同的数据库。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="6ae5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果节点环境是生产环境，我们使用来自<code class="fe mq mr ms mi b">pg-connection-string</code>模块的解析函数，Heroku就是这种情况。这个解析函数然后解构Postgres数据库URL，并在Heroku config对象上设置不同的环境变量。</p><p id="eb68" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">生产数据库连接使用config对象来访问连接到Postgress数据库所需的不同变量。</p><p id="d055" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当Strapi在本地运行时，<code class="fe mq mr ms mi b">NODE_ENV</code>等于“开发”，数据库连接由<code class="fe mq mr ms mi b">devConnections</code>函数决定。</p><p id="633f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">这部分对我设置Strapi至关重要。</strong></p><p id="b34f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我终于能够在两个Strapi实例分别工作的情况下，将开发模式的变更推进到生产模式。值得注意的是，您在本地创建的内容数据不会迁移到Heroku，因为您使用的是两个完全不同的数据库。</p><p id="b137" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们还需要做些什么</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="14e0" class="lf lg in mi b gy mm mn l mo mp">heroku config:set NODE_ENV=production</span></pre><p id="dec6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，我们需要安装pg模块。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="939b" class="lf lg in mi b gy mm mn l mo mp">npm install pg</span></pre><p id="4502" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将所有这些更改添加到git，并推送到Heroku远程git来更新应用程序。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="2568" class="lf lg in mi b gy mm mn l mo mp">git add .<br/>git commit -m "configured pg database for Heroku"<br/>git push heroku master</span></pre><p id="1333" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以从命令行打开您的应用程序</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="41d8" class="lf lg in mi b gy mm mn l mo mp">heroku open</span></pre><p id="8334" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您将再次需要为生产Strapi创建一个新的管理员用户，然后您可以管理Heroku上部署的Strapi上的内容。</p><p id="9d9d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要建立新的内容类型或者更新一些配置，在开发中添加变更，然后推送到Heroku app。这是因为出于安全原因，Strapi在生产模式下禁用了内容类型生成器。</p><p id="ff6e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">斯特拉皮部署在赫罗库。盖茨比可以从这里开始建设。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="d9fa" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">从Git在Netlify上构建站点并使用Heroku Strapi API</h2><p id="0963" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">将您的Gatsby项目链接到Github上的远程git存储库。如果你去你的Netlify账户主页，会有一个绿色按钮，上面写着<strong class="kc io">‘来自Git的新网站’。</strong>一旦按下，你将被提示从Github、Gitlab或Bitbucket中选择一个库。我用了Github。</p><p id="b1ba" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦您为Netlify设置了Github应用程序并成功连接了Github存储库，Netlify将为您创建这个新站点，并自动构建和部署它。</p><p id="06de" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为我们想在Heroku上使用Strapi，所以我们必须更新我们的<code class="fe mq mr ms mi b">gatsby-config.js</code>文件。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="a12f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如您所见，根据节点环境，Gatsby将与相应的Strapi实例进行通信。</p><p id="7d60" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，每当您在本地更新Gatsby项目并将更改推送到您的远程Github存储库时，您的站点在Netlify上的构建和部署都会自动触发。</p><p id="6235" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这太棒了。但是当你在Heroku Strapi上输入新内容时会发生什么呢？你在Netlify上的站点无法了解它。它不会用新内容更新。您必须手动将本地Gatsby中的内容推送到Github存储库中，以触发站点的重建。</p><p id="c73c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这可能会很烦人，这也是我决定用Strapi实现webhooks的原因。</p><h2 id="761f" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">Webhooks，带Strapi，触发Netlify上的Gatsby站点构建</h2><p id="54d9" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">在您的Netlify网站上，进入<strong class="kc io">网站设置</strong>。在左侧的选项中选择<strong class="kc io">构建&amp;部署</strong>。在页面上继续向下滚动，直到你看到<strong class="kc io">构建钩子</strong>并点击<strong class="kc io">添加构建钩子。</strong>给钩子起个名字，并保留默认的Github分支，它将从这个分支开始构建。</p><p id="82c4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建后，您将看到一个HTTPS地址。每次Strapi上的内容更新时，Strapi上的webhook都应该向build hook发送一个HTTPS请求。这将自动触发网站重建并更新新内容。</p><p id="f0f9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要在Heroku Strapi上添加webhook，请进入管理面板并在左侧菜单中选择<strong class="kc io">设置</strong>。在全局设置下选择<strong class="kc io"> Webhooks </strong>。点击<strong class="kc io">添加新的网页挂钩</strong>。给webhook起一个名字，并添加您刚刚在Netlify上创建的构建钩子的地址。</p><p id="2b73" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在<strong class="kc io">事件</strong>下，勾选<strong class="kc io">条目</strong>框。这告诉Strapi在每次创建、编辑或删除内容时向构建挂钩发送一个请求。</p><p id="01e6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">很好。我以为我的工作已经完成了，直到我意识到Netlify的构建时间有限。我想节省这些时间，在偶然发现这个伟大的<a class="ae jz" href="https://www.youtube.com/watch?v=W37I5U6J2hI&amp;t=870s" rel="noopener ugc nofollow" target="_blank">教程</a>后，我意识到我可以做到。</p><h2 id="d44c" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">通过使用动作在Github上构建来节省Netlify上的构建时间</h2><p id="4f0e" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">您可以使用Github actions在Github上构建您的站点，并简单地将构建的站点部署到Netlify。你将在Netlify上花费零构建分钟。如果我没弄错的话，Github Actions build是无限的！</p><p id="91ed" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为此，您需要创建一个如下所示的<code class="fe mq mr ms mi b">.github/workflows/main.yml</code>文件:</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="2e21" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每次您将代码推送到Github上的Gatsby存储库时，都会执行这个工作流。</p><p id="7a78" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于Github动作如何工作，我不会讲太多细节。</p><p id="f361" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是在每一次代码推送时，节点环境都会被设置。该站点将在该环境中构建，并部署到Netlify站点。您将需要获得您的Netlify站点id，以及用于授权的Netlify身份验证令牌。</p><p id="e76d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Netlify站点id在<strong class="kc io">站点信息</strong>框中的<strong class="kc io">站点设置</strong>下找到，作为<strong class="kc io"> API ID。</strong>复制这个值，并以名称<strong class="kc io"> NETLIFY_SITE_ID作为秘密保存在Github存储库中。</strong></p><p id="a590" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要访问Netlify身份验证令牌，请在Netlify页面的右上角单击您的个人资料头像，然后转到用户设置。在左侧菜单中选择<strong class="kc io">应用</strong>并点击<strong class="kc io">个人访问令牌</strong>下的<strong class="kc io">新访问令牌</strong>。描述您拍摄的照片并复制其价值。将其作为秘密保存在GitHub存储库中。</p><p id="e0e3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，在<strong class="kc io">构建&amp;部署</strong>下，点击<strong class="kc io">构建设置</strong>下的<strong class="kc io">编辑设置</strong>，选择<strong class="kc io">停止构建</strong>选项。这将确保当您的Github Gatsby存储库将构建的代码部署到Netlify时，Netlify也不会构建它。</p><p id="65d1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们马上就要到了。当你在Heroku Strapi上的内容更新时会发生什么？</p><p id="7a52" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">它将向Netlify构建挂钩发送一个HTTPS请求，通知它重建站点。但是Netlify不能再这样做了，因为我们停止了该网站上的所有构建。</p><h2 id="d4d1" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">定制Webhooks以触发存储库调度</h2><p id="c4bc" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">您可以在Strapi上为您的内容编写生命周期方法。如果您检查本地Strapi的文件夹结构，您会发现一个包含内容模型的<strong class="kc io"> api </strong>文件夹。例如，我有一个<strong class="kc io">工作</strong>内容类型，因此在api文件夹中有一个文件夹。</p><p id="aac8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我的工作文件夹中，我有文件夹<strong class="kc io">配置、控制器、模型、</strong>和<strong class="kc io">服务。</strong>在<strong class="kc io">模型中，</strong>我打开了<strong class="kc io"> work.js </strong>文件，看起来是这样的</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="0027" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您想在任何内容更新时发送一个<a class="ae jz" href="https://docs.github.com/en/free-pro-team@latest/rest/reference/repos#create-a-repository-dispatch-event" rel="noopener ugc nofollow" target="_blank">存储库分派</a>，您可以在Strapi模型<a class="ae jz" href="https://strapi.io/documentation/v3.x/concepts/models.html#lifecycle-hooks" rel="noopener ugc nofollow" target="_blank">生命周期挂钩</a>中这样做。例如，每次更新内容实例后，都会创建<code class="fe mq mr ms mi b">afterCreate</code>挂钩。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="ab76" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">存储库调度是一个事件，您可以通过向特定的Github存储库api URL发送Axios请求来触发该事件。您需要创建一个Github令牌，并随请求一起发送。您还可以随请求发送一个有效负载，为您的存储库分派指定事件类型的名称。</p><p id="9d49" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以在Github Actions工作流中包含存储库调度，这样Gatsby站点就可以建立在任何事件类型为“created”的存储库调度之上。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="9dc5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，每次Strapi上的内容更新时，都会触发相应的生命周期挂钩。这又会向您的Gatsby存储库发送一个存储库分派事件，从而启动您的站点的构建。一旦建立了站点，它将被部署到Netlify，您就拥有了更新的站点。</p><p id="57de" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">生命周期挂钩需要在本地添加，然后推送到Strapi的Heroku实例。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="b2b8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我希望你喜欢读这篇文章！请让我知道，如果我错过了什么或没有解释清楚一个步骤！。</p></div></div>    
</body>
</html>