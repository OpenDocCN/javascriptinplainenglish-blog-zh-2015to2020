<html>
<head>
<title>Node and Passport JS — Google OAuth20 Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">节点和Passport JS — Google OAuth20认证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-and-passport-js-google-oauth20-authentication-8bcd6b3d67ca?source=collection_archive---------0-----------------------#2020-09-20">https://javascript.plainenglish.io/node-and-passport-js-google-oauth20-authentication-8bcd6b3d67ca?source=collection_archive---------0-----------------------#2020-09-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/53fdc9075ec227d27bf62cc7483b190f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IBDhVngEOucQ3qkqrKTtJw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Cover Image</figcaption></figure><p id="c33f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">作为一名用户，我们经常会使用谷歌账户登录网络应用。这个过程会很简单。但现实中，很多工作都是在那一次点击的背后完成的。这篇博客将向你解释如何用Node和Express JS实现Google认证。为了实现这一点，我们将使用一个名为Passport JS的第三方库。Passport JS是Node和Express JS的认证中间件。Passport JS可以与任何Express JS应用程序一起使用。Passport JS提供500 +策略。</p><div class="kx ky gp gr kz la"><a href="http://www.passportjs.org/" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd io gy z fp lf fr fs lg fu fw im bi translated">Passport.js</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">Passport是Node.js的认证中间件。极其灵活和模块化，Passport可以不引人注目地…</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">www.passportjs.org</p></div></div><div class="lj l"><div class="lk l ll lm ln lj lo jt la"/></div></div></a></div></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><h2 id="95fa" class="lw lx in bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">目录</h2><ol class=""><li id="d433" class="mp mq in kb b kc mr kg ms kk mt ko mu ks mv kw mw mx my mz bi translated"><a class="ae na" href="#c475" rel="noopener ugc nofollow">初始化Node.js项目</a></li><li id="c963" class="mp mq in kb b kc nb kg nc kk nd ko ne ks nf kw mw mx my mz bi translated"><a class="ae na" href="#e3c8" rel="noopener ugc nofollow">创建OAuth客户端ID </a></li><li id="4cc6" class="mp mq in kb b kc nb kg nc kk nd ko ne ks nf kw mw mx my mz bi translated"><a class="ae na" href="#9093" rel="noopener ugc nofollow">配置Google OAuth </a></li><li id="7620" class="mp mq in kb b kc nb kg nc kk nd ko ne ks nf kw mw mx my mz bi translated"><a class="ae na" href="#fb32" rel="noopener ugc nofollow">保护路由并添加注销视图</a></li></ol></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><h2 id="c475" class="lw lx in bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated"><strong class="ak"> 1。初始化node . js项目</strong></h2><p id="b666" class="pw-post-body-paragraph jz ka in kb b kc mr ke kf kg ms ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">首先，让我们创建一个Express应用程序。以下命令创建一个新文件夹并初始化Node.js。</p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="893d" class="lw lx in no b gy ns nt l nu nv">mkdir passport_sta<br/>cd passport_sta/<br/>npm init -y<br/>touch index.js</span></pre><p id="4c76" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">初始化后，安装所有需要的软件包。在这里，我正在安装下列软件包。</p><p id="caaf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">express——web服务器和API的轻量级框架。</p><p id="09a8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">cookie会话—存储会话。</p><p id="3253" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">passport——用于节点和Express JS的认证中间件</p><p id="4f5d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">passport google oauth20 — Passport身份验证策略，帮助您使用google帐户登录。</p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="cff3" class="lw lx in no b gy ns nt l nu nv">npm install express cookie-session passport passport-google-oauth20 --save</span></pre><p id="c645" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">上面的命令安装所有的包。安装后，将下面的代码复制到您的<code class="fe nw nx ny no b">index.js</code>文件中。</p><p id="481d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe nw nx ny no b">index.js</code></p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="49e8" class="lw lx in no b gy ns nt l nu nv">const express = require('express')<br/>const app = express()</span><span id="06b2" class="lw lx in no b gy nz nt l nu nv">app.get('/',(req,res)=&gt;{<br/>  res.send('Hello world')<br/>})</span><span id="094c" class="lw lx in no b gy nz nt l nu nv">app.listen(8000,()=&gt;{<br/>  console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="5293" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在使用<code class="fe nw nx ny no b">node index.js</code>启动服务器。然后导航到<a class="ae na" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000/ </a>。您应该会看到Hello world显示在浏览器中。</p><h2 id="e3c8" class="lw lx in bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">2.<strong class="ak">创建OAuth客户端ID </strong></h2><p id="85b8" class="pw-post-body-paragraph jz ka in kb b kc mr ke kf kg ms ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">在使用passport的谷歌认证策略之前，您应该已经在谷歌注册了您的应用程序或网络应用程序。为此，请遵循以下步骤。</p><p id="d28f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">a.登录谷歌云平台。</p><p id="388b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">b.创建新项目。</p><div class="kx ky gp gr kz la"><a href="https://console.developers.google.com/" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd io gy z fp lf fr fs lg fu fw im bi translated">谷歌云平台</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">Google云平台让您可以在同一基础设施上构建、部署和扩展应用程序、网站和服务…</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">console.developers.google.com</p></div></div><div class="lj l"><div class="oa l ll lm ln lj lo jt la"/></div></div></a></div><p id="5fca" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">c.在仪表板中，单击enable APIS and Services，然后在项目中搜索并启用Google plus API和contact API。</p><p id="809f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">d.在“凭据”页面上，单击创建凭据，然后单击OAuth客户端ID。</p><figure class="nj nk nl nm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ob"><img src="../Images/41de9483a8e4885332e17e1e6464a2da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5zmuQRbZq6zIGcpurdt8A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Create an OAuth Client ID</figcaption></figure><p id="a8ee" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">e.现在，将会显示一个ClientID表单。为您的OAuth ID命名，并添加重定向的URL。</p><figure class="nj nk nl nm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oc"><img src="../Images/21198673ff6364298a57b430ec52a8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7LlEVodfdGeIpcHqrhXdIQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Get OAuth Credentials</figcaption></figure><p id="e7ff" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">f.现在单击create按钮，它会向您显示客户端ID和客户端密码。记下客户端ID和密码。</p><h2 id="9093" class="lw lx in bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">3.<strong class="ak">配置Google OAuth </strong></h2><p id="2824" class="pw-post-body-paragraph jz ka in kb b kc mr ke kf kg ms ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">现在让我们开始将Google认证与我们的项目集成。为此，我创建了一个名为<code class="fe nw nx ny no b">passport.js</code>的新文件，它保存了我们从Google Cloud Dashboard创建的凭证。</p><p id="b3e4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe nw nx ny no b">passport.js</code></p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="e4ff" class="lw lx in no b gy ns nt l nu nv">const passport = require('passport');<br/>const GoogleStrategy = require('passport-google-oauth20').Strategy;</span><span id="9c30" class="lw lx in no b gy nz nt l nu nv">passport.serializeUser(function(user, done) {<br/>  done(null, user);<br/>});</span><span id="d096" class="lw lx in no b gy nz nt l nu nv">passport.deserializeUser(function(user, done) {<br/>  done(null, user);<br/>});</span><span id="1ba3" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">passport.use(new GoogleStrategy({<br/>    clientID: "4287*****************************ent.com",</strong></span><span id="9826" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">    clientSecret: "513z***********t1XU",</strong></span><span id="d050" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">    callbackURL: "http://localhost:8000/api/account/google"</strong></span><span id="f2c7" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">  },<br/>  function(accessToken, refreshToken, profile, done) {<br/>    return done(null, profile);<br/>  }<br/>));</strong></span></pre><p id="b245" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">将下面的代码复制并粘贴到你的<code class="fe nw nx ny no b">index.js</code>文件中。</p><p id="747e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">路由<code class="fe nw nx ny no b">/auth</code>将客户端重定向到Google登录页面。</p><p id="34b0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果Google认证成功，路由<code class="fe nw nx ny no b">/api/account/google</code>将作为一个回调URL被调用。</p><p id="856b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果在Google认证过程中出现任何错误，将调用路线<code class="fe nw nx ny no b">/ath/error</code>。</p><p id="4eae" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe nw nx ny no b">index.js</code></p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="d017" class="lw lx in no b gy ns nt l nu nv">const express = require('express')<br/>const app = express()<br/>const passport = require('passport');<br/><strong class="no io">require('./passport');<br/></strong>const cookieSession = require('cookie-session')</span><span id="41e3" class="lw lx in no b gy nz nt l nu nv">app.use(cookieSession({<br/>  name: 'google-auth-session',<br/>  keys: ['key1', 'key2']<br/>}))<br/>app.use(passport.initialize());<br/>app.use(passport.session());</span><span id="1178" class="lw lx in no b gy nz nt l nu nv">//Routes<br/><strong class="no io">app.get('/auth', passport.authenticate('google', { scope: ['profile', 'email'] }));</strong></span><span id="6ca3" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">app.get('/auth/error', (req, res) =&gt; res.send('Unknown Error'))</strong></span><span id="4352" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">app.get('/api/account/google', passport.authenticate('google', { failureRedirect: '/auth/error' }),<br/>  function(req, res) {<br/>    res.redirect('/');<br/>  }<br/>);</strong></span><span id="dd66" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">app.get('/', (req, res) =&gt; res.send(`Welcome ${req.user.displayName}!`))</strong></span><span id="36f5" class="lw lx in no b gy nz nt l nu nv">app.listen(8000,()=&gt;{<br/>  console.log('Serve is up and running at the port 8000')<br/>})</span></pre><p id="b318" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在导航到<a class="ae na" href="http://localhost:8000/auth" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/auth</a>。您将被重定向到谷歌的登录页面。登录您的Google帐户后，您将被重定向回我们的网页，您将看到您的Google用户名显示在我们的网页上。</p><h2 id="fb32" class="lw lx in bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">4.<strong class="ak">保护路由并添加注销视图</strong></h2><p id="2fbb" class="pw-post-body-paragraph jz ka in kb b kc mr ke kf kg ms ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">当您在未登录的情况下打开路线<code class="fe nw nx ny no b"><a class="ae na" href="http://localhost:8000/auth" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/</a></code>时，您会看到一个错误<code class="fe nw nx ny no b">displayName</code>未找到。为了消除这个错误，我创建了一个中间件来检查用户是否登录。我正在名为<code class="fe nw nx ny no b">Middleware</code>的新文件夹中创建中间件。</p><p id="c607" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe nw nx ny no b">Middleware/auth.js</code></p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="f893" class="lw lx in no b gy ns nt l nu nv">const isLoggedIn = (req, res, next) =&gt; {</span><span id="b770" class="lw lx in no b gy nz nt l nu nv">if (req.user) {<br/>  next();<br/>} else {<br/>    res.status(401).send('Not Logged In');<br/>  }<br/>}</span><span id="1664" class="lw lx in no b gy nz nt l nu nv">module.exports = isLoggedIn</span></pre><p id="409e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成后，将中间件传递给路由<code class="fe nw nx ny no b">/</code>。现在自动导航到URL <code class="fe nw nx ny no b"><a class="ae na" href="http://localhost:8000/auth" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/</a>.</code>，您将被重定向到<code class="fe nw nx ny no b">/auth</code>路线。</p><p id="bed8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在让我们创建一个注销函数。只要调用函数<code class="fe nw nx ny no b">req.logout()</code>你就可以从谷歌账户注销。</p><p id="f02f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe nw nx ny no b">index.js</code></p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="06f8" class="lw lx in no b gy ns nt l nu nv">const isLoggedIn = require('./Middleware/auth')</span><span id="1aa5" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">app.get('/', isLoggedIn,(req, res) =&gt; res.send(`Welcome ${req.user.displayName}!`))</strong></span><span id="335a" class="lw lx in no b gy nz nt l nu nv"><strong class="no io">app.get('/logout', (req, res) =&gt; {<br/>  req.session = null;<br/>  req.logout();<br/>  res.redirect('/');<br/>})</strong></span></pre><p id="4c12" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">只需导航到<a class="ae na" href="http://localhost:8000/logout" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/logout</a>。您将被注销。</p><p id="a0a8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在我的下一篇博客中，我将使用Passport JS实现脸书认证。保持联系。</p><p id="849a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如有任何疑问，请随时联系我。电子邮件:sjlouji10@gmail.com。领英:<a class="ae na" href="https://www.linkedin.com/in/sjlouji/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/sjlouji/</a></p><p id="e2a2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我的GitHub上的完整代码:</p><div class="kx ky gp gr kz la"><a href="https://github.com/sjlouji/Passport-Strategies---Medium/tree/master/passport_sta" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd io gy z fp lf fr fs lg fu fw im bi translated">sjlouji/Passport-策略-中等</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">在GitHub上创建一个帐户，为sjlouji/Passport-Strategies-Medium开发做出贡献。</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">github.com</p></div></div><div class="lj l"><div class="od l ll lm ln lj lo jt la"/></div></div></a></div><p id="da39" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">编码快乐！</p></div></div>    
</body>
</html>