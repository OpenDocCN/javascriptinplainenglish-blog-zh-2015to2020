<html>
<head>
<title>Better JavaScript — Event Queue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更好的JavaScript —事件队列</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/better-javascript-event-queue-3aa737e9c5a6?source=collection_archive---------3-----------------------#2020-11-03">https://javascript.plainenglish.io/better-javascript-event-queue-3aa737e9c5a6?source=collection_archive---------3-----------------------#2020-11-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/24703bba00d025a12f248940d06927ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qhem9-rewuJa2OU7"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@productschool?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Product School</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="39af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究改进JavaScript代码的方法。</p><h1 id="a27c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">不阻塞I/O上的事件队列</h1><p id="8564" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">JavaScript是单线程语言，所以如果同步代码是长时间运行的，那么用同步代码阻塞I/O是不好的。</p><p id="5155" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们阻塞了事件队列，一段代码就可能阻塞整个程序。</p><p id="5542" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们不应该有这样的代码:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2ab4" class="mn lc iq mj b gy mo mp l mq mr">const text = downloadSync("http://example.com/file.txt");<br/>console.log(text);</span></pre><p id="eef0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的节目中。</p><p id="8c17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等待文本被下载，然后返回。</p><p id="adb3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这可能需要很长时间。</p><p id="9c09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，JavaScript为我们提供了异步运行代码的方法。</p><p id="aaf1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9f95" class="mn lc iq mj b gy mo mp l mq mr">downloadAsync("http://example.com/file.txt", (text) =&gt; {<br/>  console.log(text);<br/>});</span></pre><p id="29b7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们运行异步JavaScript代码，那么代码将被挂起，直到获得结果。</p><p id="9fde" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们知道结果是在回调被调用时获得的。</p><p id="2ae2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当代码被挂起时，这段代码后面排队的东西就可以运行了。</p><p id="5ac7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们正确地构建代码，我们就不必担心由于并发执行代码而导致的某些对象或变量的改变。</p><h1 id="bee6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">对异步代码使用回调</h1><p id="f7bb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们有一些简单的异步代码，那么我们可以使用回调来运行我们的代码。</p><p id="c81b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们有:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5e7c" class="mn lc iq mj b gy mo mp l mq mr">downloadAsync("http://example.com/file.txt", (text) =&gt; {<br/>  console.log(text);<br/>});</span></pre><p id="f366" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它接受一个回调，当从服务器检索结果时调用这个回调。</p><p id="bc11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是创建异步代码最简单的方法。</p><p id="f886" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当<code class="fe ms mt mu mj b">downloadAsync</code>运行时，该功能被启动，但尚未执行操作。</p><p id="8f71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦操作被执行，回调被运行，我们得到<code class="fe ms mt mu mj b">text</code>。</p><p id="f3f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们必须按顺序运行多个异步操作，那么我们需要在第一个操作的回调中运行第二个操作。</p><p id="8520" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="de06" class="mn lc iq mj b gy mo mp l mq mr">downloadAsync("http://example.com/foo.txt", (text1) =&gt; {<br/>  console.log(text1);<br/>  downloadAsync("http://example.com/bar.txt", (text2) =&gt; {<br/>    console.log(text2);<br/>  });<br/>});</span></pre><p id="123b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将第二个<code class="fe ms mt mu mj b">downloadAsync</code>调用嵌套在第一个调用中。</p><p id="a0c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们需要按顺序运行更多的异步回调，那么我们会得到更多的嵌套。</p><p id="f41c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这肯定是一个问题，因为我们不想嵌套它们。</p><p id="afad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免这种情况，我们可以使用承诺。</p><h1 id="b685" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">对复杂的异步操作使用承诺</h1><p id="69a8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们有很多需要按顺序运行的异步代码，那么嵌套的异步回调就会太混乱。</p><p id="2d2c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不想在代码中有太多层次的嵌套，因为很难调试和跟踪。</p><p id="85b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，我们用承诺来避免所有的嵌套。</p><p id="719b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以通过写下以下内容来创建承诺链:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7537" class="mn lc iq mj b gy mo mp l mq mr">promise<br/>  .then((val) =&gt; {<br/>    return promise2;<br/>  })<br/>  .then((val) =&gt; {<br/>    return promise3;<br/>  })<br/>  .then((val) =&gt; {<br/>    return promise4;<br/>  })<br/>  .then((val) =&gt; {<br/>    return promise5;<br/>  })</span></pre><p id="a7cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用回调函数调用<code class="fe ms mt mu mj b">then</code>,回调函数返回一个承诺来调用另一个承诺。</p><p id="1205" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">val</code>具有承诺解决的价值。</p><p id="7bbb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">承诺也可以被拒绝。</p><p id="83f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了从被拒绝的承诺中捕捉错误，我们调用<code class="fe ms mt mu mj b">catch</code>方法:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="abf0" class="mn lc iq mj b gy mo mp l mq mr">promise<br/>  .catch((err) =&gt; {<br/>    console.log(err);<br/>  })</span></pre><p id="38a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这比嵌套回调好多了。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/b47822e63c02644a3a695413bfdaea32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FQemnkvJH6-qYcnR"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@levidjones?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Levi Jones</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2d61" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="5cf2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们不应该用长期运行的同步代码阻塞JavaScript代码的I/O。</p><p id="03a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们有任何可能长期运行的东西，我们应该使用异步回调或承诺。</p><p id="5382" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果是这样，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅解码获得更多类似内容，我们的YouTube频道</strong> </a> <strong class="kf ir">！</strong></p></div></div>    
</body>
</html>