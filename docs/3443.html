<html>
<head>
<title>How to display code coverage of a Vue project in Gitlab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Gitlab中显示Vue项目的代码覆盖率</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-display-code-coverage-of-a-vue-project-in-gitlab-9d1510a3e794?source=collection_archive---------1-----------------------#2020-09-29">https://javascript.plainenglish.io/how-to-display-code-coverage-of-a-vue-project-in-gitlab-9d1510a3e794?source=collection_archive---------1-----------------------#2020-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/d33eb15ce0789f1ab7cc33e37d2eeccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5Vu9Vuc6qSnZjZtc.png"/></div></div></figure><div class=""/><p id="85ee" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有人可能会认为这应该很简单，不需要写文章，至少我是这样认为的。但是当我试图为我的一些项目设置它时，它花费了我比我预期多得多的时间。</p><p id="7e74" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了让它发挥作用，你需要跨越一些障碍。每一个都可以在互联网上的某个地方找到，但是把它们都放在一起有点麻烦。所以我决定写一个快速操作指南，把所有的技巧都放在一个页面上。</p><h1 id="c503" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">第一个陷阱</h1><p id="51f6" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">因为您可能已经在运行单元测试，所以您的package.json中应该已经有一个类似如下的脚本:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="9aa7" class="mi kx jb me b gy mj mk l ml mm">"scripts": {<br/>	"serve": "vue-cli-service serve",<br/>	"build": "vue-cli-service build",<br/>	"test:unit": "vue-cli-service test:unit",<br/>	"lint:js": "vue-cli-service lint",<br/>	"lint:css": "stylelint \"src/**/*.scss\""<br/>}</span></pre><p id="50f7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个窍门来了… Jest，Vue.js项目中的默认runner，给控制台输出着色，使其更容易阅读(大多数runner都这样做)。不幸的是，颜色与Gitlab解析器不兼容。所以你必须通过添加<strong class="ka jc"> —无色</strong>参数来关闭它。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="61fc" class="mi kx jb me b gy mj mk l ml mm">"scripts": {<br/>	"serve": "vue-cli-service serve",<br/>	"build": "vue-cli-service build",<br/>	"test:unit": "vue-cli-service test:unit <strong class="me jc">--no-color</strong>",<br/>	"lint:js": "vue-cli-service lint",<br/>	"lint:css": "stylelint \"src/**/*.scss\""<br/>}</span></pre><h1 id="ab1d" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">jest配置</h1><p id="8c7e" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">下一步是让jest收集覆盖率并生成Gitlab能够解析的报告。为此，你必须编辑<strong class="ka jc"> jest.config.js </strong>文件。<br/>首先通过将<strong class="ka jc"> collectCoverage </strong>设置为<strong class="ka jc"> true </strong>来激活覆盖率收集，然后<strong class="ka jc"> </strong>将<strong class="ka jc"> text-summary </strong>类型添加到<strong class="ka jc"> coverageReporters </strong>列表中。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="ea6c" class="mi kx jb me b gy mj mk l ml mm">module.exports = {<br/>	collectCoverage: <strong class="me jc">true</strong>,<br/>	collectCoverageFrom: ['src/**/*.js', '!**/node_modules/**'],<br/>	coverageDirectory: './coverage',<br/>	coverageReporters: ['html', 'text', '<strong class="me jc">text-summary</strong>'],<br/>	testMatch: ['**/tests/*.spec.js']<br/>};</span></pre><p id="be59" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将在控制台输出中生成<em class="mn"> coverage summary </em>部分，Gitlab作业可以对其进行解析。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mo"><img src="../Images/5f102779a107a1839b2e10e6fd6ac173.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RuwG_Vb8I5voXCXJQUdyjA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">The coverage summary section in the (colored) console reported with the text-summary parameter</figcaption></figure><p id="8b3a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，上面的设置还会生成一个HTML报告，这个报告会更加详细，有助于您找到覆盖范围中的缺口。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/422953a8b2c97377aa4098dcc431bd44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zf-yRYHoFIJXUqbZF0fTNQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">The HTML report generated by jest</figcaption></figure><h1 id="b58b" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">词体</h1><p id="e05e" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">这里显而易见的步骤是让您的CI运行测试，以便在Gitlab控制台中生成覆盖率输出。这非常简单，因为它只需要用npm从package.json调用单元测试脚本。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="71f5" class="mi kx jb me b gy mj mk l ml mm">image: node<br/><br/>stages:<br/>  - test-unit<br/><br/>test-unit:<br/>  stage: test-unit<br/>  script: <strong class="me jc">npm run test:unit</strong><br/>  artifacts:<br/>    when: always<br/>    paths:<br/>      - coverage<br/>    expire_in: 30 days</span></pre><p id="3a9d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">[可选]您可以添加的一个好处是将包含HTML报告的coverage文件夹上传到Gitlab artefacts。这样，该工作的每个人都可以获得详细的报告。</p><p id="27d0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面的示例中，无论阶段的结果如何(成功或失败),都将始终上传HTML，并与作业一起存储30天。</p><h1 id="53a8" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">配置Gitlab</h1><p id="a572" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">最后一步是配置Gitlab解析器，用一个小的正则表达式从控制台中正确地选择我们的覆盖率。不幸的是，Gitlab默认不支持Jest，我在网上找不到一个在所有情况下都有效的Jest，所以我想出了自己的方法:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6cac" class="mi kx jb me b gy mj mk l ml mm"><strong class="me jc">Lines</strong>\s*:\s*(\d+.?\d*)%</span></pre><p id="2389" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你只需要在你项目的<em class="mn"> CI/CD设置</em>的<em class="mn">通用管道</em>区域添加上面的正则表达式。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d342580e3a8479009a345d6701b5a1e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uR-wEY2ggABNTc3Hnpg6Pw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Regular expression used for test coverage parsing</figcaption></figure><p id="2b7b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的例子中，我选择使用<strong class="ka jc">行</strong>覆盖，但是如果你更喜欢使用<strong class="ka jc">语句</strong>或者<strong class="ka jc">函数</strong>，你只需要替换正则表达式中的bold关键字。</p><h1 id="3946" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">包扎</h1><p id="b496" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">就这样…下次运行您的CI时，您应该会看到Jobs列表中的coverage列开始填充您的结果</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/1c193558c16e06a38b4021ba4e3131b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*98ZWHcJoJIijtzj8NG7yQQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Coverage under CI/CD &gt; Jobs</figcaption></figure><p id="cd6f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="mn"> Analytics &gt; Repository </em>下也有您的覆盖范围的图形化历史记录</p><p id="5784" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在唯一要做的就是提高覆盖率😉</p></div></div>    
</body>
</html>