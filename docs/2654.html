<html>
<head>
<title>How to Generate Server-Side PDF reports with Puppeteer, D3, and Handlebars</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用木偶师、D3和手柄生成服务器端PDF报告</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-generate-server-side-pdf-reports-with-puppeteer-d3-and-handlebars-97bc8ed38a53?source=collection_archive---------6-----------------------#2020-07-12">https://javascript.plainenglish.io/how-to-generate-server-side-pdf-reports-with-puppeteer-d3-and-handlebars-97bc8ed38a53?source=collection_archive---------6-----------------------#2020-07-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="c094" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正在寻找一种方法来创建一个设计繁重、数据驱动、风格优美的PDF报告—在服务器端使用与您已经在前端使用的工具类似的工具？停止你的谷歌搜索。你来对地方了。几个月前，在帮助一个客户解决这个问题时，我和你处境相同。为了完成这个壮举，我用木偶师、D3和把手开发了一个四步解决方案。在这篇文章中，我将一步一步地指导你创建服务器端的pdf报告。让我们开始吧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e21e39d67353b5edd8ad5fc11693ee03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XaujefLUYzEMEZMz.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Example of a D3 generated page using handlebars and puppeteer</figcaption></figure><h1 id="b399" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">在本帖中，我们将介绍</h1><ul class=""><li id="ec2f" class="lw lx in jm b jn ly jr lz jv ma jz mb kd mc kh md me mf mg bi translated">设置木偶师和把手</li><li id="a46b" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">创建一个生成器来制作PDF</li><li id="6b10" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">构建车把模板</li><li id="c1e4" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">添加最后的润色</li></ul><h1 id="ba1b" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建这些PDF报告的挑战:</h1><p id="37d7" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">因为我们使用模板框架来访问标准的web技术，并使用puppeteer来管理pdf，所以我们需要在开发过程中考虑这些事情:</p><ul class=""><li id="78b4" class="lw lx in jm b jn jo jr js jv mp jz mq kd mr kh md me mf mg bi translated">页面将需要手动约束。</li><li id="4a14" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">除了“屏幕”之外，我们将无法访问css媒体道具(无“分页符”或印刷媒体类型)</li><li id="e207" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">一旦PDF被编译和渲染，我们将无法使用开发工具来调试不规则性。</li><li id="2f12" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">木偶师本身增加了额外的构建时间和部署规模。</li><li id="335f" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">根据文件大小，生成报告可能需要一段时间。</li></ul><h1 id="508c" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">对于这个例子，让我们假设…</h1><p id="0853" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">我们已经有了项目的基础，并运行Node/Express，以及一些ORM和DB解决方案。我们已经准备好将我们的甜蜜数据输入到报告中。</p><h1 id="fb3d" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们实现这一目标所需的工具:</h1><h1 id="0088" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">1.把手</h1><p id="869a" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">来自Mustache家族的Html模板框架。这允许部分模板化(对组件的花哨说法)以及定制和内置的助手功能来扩展我们的逻辑。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="05f6" class="mx kz in mt b gy my mz l na nb">npm <strong class="mt io">install</strong> handlebars</span></pre><p id="9191" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nc">使用部分和内置模块的示例</em></p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="21a9" class="mx kz in mt b gy my mz l na nb">{{#each poleComparison as |page|}}<br/>&lt;div class="page"&gt;<br/>  {{#each page.pairs as |polePair|}}<br/>	{{&gt; comparison-header polePair=polePair }}<br/>	    &lt;div class="comparison-tables"&gt;<br/>		    {{&gt; comparison-body polePair=polePair }}<br/>	    &lt;/div&gt;<br/>  {{/each}}<br/>  {{&gt; footer @root }}<br/>&lt;/div&gt;<br/>{{/each}}</span></pre><h1 id="4580" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">操纵木偶的人</h1><p id="b7eb" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">一个节点库，它将为我们提供对chrome headless实例的访问，以便基于我们编译的手柄模板生成PDF。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="b7bf" class="mx kz in mt b gy my mz l na nb">npm <strong class="mt io">install</strong> puppeteer</span></pre><p id="5f54" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用例列表:</p><ul class=""><li id="8f77" class="lw lx in jm b jn jo jr js jv mp jz mq kd mr kh md me mf mg bi translated">生成页面的截图和pdf。</li><li id="728f" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">抓取SPA(单页应用程序)并生成预呈现内容(即“SSR”(服务器端呈现))。</li><li id="2cb4" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">创建一个最新的自动化测试环境。</li><li id="11b2" class="lw lx in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">测试Chrome扩展。</li></ul><h1 id="1ef3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">3.D3(数据驱动文档)</h1><p id="5ab5" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">D3.js是一个基于数据操作文档的JavaScript库。D3帮助您使用HTML、SVG和CSS将数据变得生动。D3对web标准的重视让您拥有现代浏览器的全部功能，而无需将自己束缚在一个专有的框架中，它结合了强大的可视化组件和一种<a class="ae nd" href="https://www.singlestoneconsulting.com/blog/data-infrastructure-architecture/" rel="noopener ugc nofollow" target="_blank">数据驱动的</a>DOM操作方法。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4456" class="mx kz in mt b gy my mz l na nb">&lt;script src="https://d3js.org/d3.v5.min.js"&gt;&lt;/script&gt;</span></pre><h1 id="8470" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第一步:设置木偶师和把手</h1><p id="10f7" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">首先，我们将为PDF创建一个目录，然后导入所需的模块。这将是一个JavaScript文件，我们将把它放在应用程序的服务器端结构中。为了方便起见，我们可以将此称为generatePDF.js。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9048" class="mx kz in mt b gy my mz l na nb">const puppeteer = require("puppeteer"); <br/>const hbs = require("handlebars");</span></pre><p id="453d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们需要让handlebars编译我们的模板。我们将创建一个编译函数来定位。hbs文件，并使用内置的handlebars编译方法来实现这一点。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="26e9" class="mx kz in mt b gy my mz l na nb">const puppeteer = require("puppeteer");<br/>const hbs = require("handlebars");<br/> <br/>const compile = async (templateName, data) =&gt; {<br/>	const filePath = path.join(__dirname, "templates", `${templateName}.hbs`);<br/>	if (!filePath) {<br/>		throw new Error(`Could not find ${templateName}.hbs in generatePDF`);<br/>	}<br/>	const html = await fs.readFile(filePath, "utf-8");<br/>	return hbs.compile(html)(data);<br/>};</span></pre><p id="8feb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个方法还允许我们将将要使用的数据注入到模板中。</p><p id="d227" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，我们需要设置generatePDF函数。它的工作将是打开一个傀儡无头铬实例转换成PDF格式的模板。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c681" class="mx kz in mt b gy my mz l na nb">let browser; <br/>const generatePDF = async (fileName, data) =&gt; {<br/>	try {<br/>		if (!browser) {<br/>			browser = await puppeteer.launch({<br/>				args: [<br/>				"--no-sandbox",<br/>				"--disable-setuid-sandbox",<br/>				"--disable-dev-shm-usage"<br/>				],<br/>				headless: true,<br/>			})<br/>		}<br/>	} catch (err) {<br/>		...</span></pre><p id="4fc6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经将一些配置选项传递给我们的木偶浏览器，这将使它变得无头和轻量级。我们也不希望同时打开多个浏览器，这会在生成多个报告时导致性能问题。</p><p id="e9a4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们将创建一个新的隐名浏览器上下文。我们将使用这个方法而不是通常的上下文方法，因为它不会与其他浏览器上下文共享cookies缓存。这对木偶师的其他功能很有帮助，但在这个过程中并不需要。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="adb2" class="mx kz in mt b gy my mz l na nb">],<br/>				headless: true,<br/>			})<br/>		}<br/>		const context = await browser.createIncognitoBrowserContext();<br/>		const page = await context.newPage();<br/>		const content = await compile(fileName, data);<br/> <br/>	} catch (err) {<br/>		...<br/>	}<br/>}</span></pre><p id="95ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们将设置我们的内容，并告诉木偶师在渲染PDF之前等待所有内容加载完毕。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="6f3d" class="mx kz in mt b gy my mz l na nb">const content = await compile(fileName, data);<br/> <br/>		await page.goto(`data: text/html, ${content}`, { <br/>			waitUntil: "networkidle0" <br/>		});<br/>		await page.setContent(content);<br/>		await page.emulateMedia("screen");<br/> <br/>	} catch (err) {<br/>		...<br/>	}<br/>}</span></pre><p id="75c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nc"> * page.goto采用URL字符串和配置选项。我们不会访问一个URL，相反，我们将利用我们编译的html </em></p><p id="7878" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nc"> * emulateMedia改变页面上使用的CSS媒体类型。我们希望我们的媒体类型反映用于屏幕的CSS。</em></p><p id="04bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将设置页面格式，以便木偶师知道如何渲染。请记住，puppeteer不知道我们想要在哪里分割我们的实际内容(这将在稍后通过我们的模板css来处理)。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="b2e2" class="mx kz in mt b gy my mz l na nb">await page.emulateMedia("screen");<br/> <br/>		const pdf = await page.pdf({<br/>			format: "A4",<br/>			printBackground: true,<br/>		});<br/> <br/>		await context.close();<br/>		return pdf;<br/> <br/>	} catch (err) {<br/>		...<br/>	}<br/>}</span></pre><h1 id="7bd3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第二步:设置我们的车把模板</h1><p id="c34a" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">我们将首先为我们的报告创建第一个把手模板文件。请注意，语法看起来和行为就像普通的HTML。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5e7b" class="mx kz in mt b gy my mz l na nb">our_report.hbs</span><span id="3043" class="mx kz in mt b gy ne mz l na nb">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>  &lt;meta charset="UTF-8"&gt;<br/>  &lt;title&gt;Our Cool PDF Report&lt;/title&gt;<br/>  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" /&gt;<br/>  &lt;script src="https://d3js.org/d3.v5.min.js"&gt;&lt;/script&gt;<br/>&lt;/head&gt;<br/>  &lt;body&gt;<br/>	  &lt;div&gt;<br/>	    &lt;p&gt;Hello World&lt;p&gt;<br/>	  &lt;/div&gt;<br/>  &lt;/body&gt;</span></pre><h1 id="1708" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">让我们的数据进入我们的模板</h1><p id="fe6d" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">我们可以使用一些手柄内置块来帮助我们与之前在编译函数中注入的数据进行交互。我们可以使用“with”块获得我们需要的数据的上下文，然后使用“each”块迭代它。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="0341" class="mx kz in mt b gy my mz l na nb">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>  &lt;meta charset="UTF-8"&gt;<br/>  &lt;title&gt;Our Cool PDF Report&lt;/title&gt;<br/>  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" /&gt;<br/>  &lt;script src="https://d3js.org/d3.v5.min.js"&gt;&lt;/script&gt;<br/>&lt;/head&gt;<br/>  &lt;body&gt;<br/>	  &lt;div&gt;<br/>		{{#with Data as |myData| }}<br/>		 {{#each myData.text as |text| }}<br/>		 &lt;p&gt;{{text}}&lt;p&gt;<br/>		 {{/each}}<br/>		{{/with }}<br/>	  &lt;/div&gt;<br/>  &lt;/body&gt;</span></pre><h1 id="75fa" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">现在我们可以添加一些过程来生成我们的PDF</h1><p id="bf30" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">现在，在我们的节点应用程序中，我们可以使用generatePDF函数来创建PDF。这将是你决定最终如何处理报告的时候了。您可以将它存储在您的数据库中，提供给客户端，或者将其存放在S3桶中。根据应用程序的需求，这里有很大的自由度。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="79d3" class="mx kz in mt b gy my mz l na nb">const generatePDF = require('./generatePDF.js');<br/> <br/>const generateReportWithData = reportData =&gt; {<br/> return generatePDF("our_report", reportData);<br/>  }</span></pre><p id="615e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您有不同类型的报告，我们可以借此机会添加一个switch语句和一些逻辑来决定生成哪个报告。</p><h1 id="8f7f" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第三步:建立一个车把模板</h1><p id="238d" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">现在我们可以设置模板样式了。我们将创建一个名为style.hbs的文件。我喜欢设置全局变量css变量，以保持我对许多样式的诚实。pt是可打印文档的推荐单位，我发现px并不总是适用于文本。我还发现em单位比像素更适合翻译字母间距。这使得在转换值时更容易匹配设计的字距/字母间距。</p><h1 id="646d" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">构建页面约束</h1><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ac0e" class="mx kz in mt b gy my mz l na nb"><strong class="mt io">style.hbs</strong></span><span id="42f5" class="mx kz in mt b gy ne mz l na nb">:root {<br/>	--font-s-small: 8pt;<br/>	--font-s-normal: 10pt;<br/>	--font-s-mid: 12pt;<br/>	--font-s-large: 14pt;<br/>	/* Kerning */<br/>	--ltr-spc-200: 0.2em;<br/>	--ltr-spc-100: 0.1em;<br/>	--ltr-spc-020: 0.02em;<br/>	--ltr-spc-025: 0.025em;<br/>}</span></pre><p id="4369" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你还记得，我们谈到过当我们想把文档分成页面时，木偶师是如何没有上下文的。它将生成PDF并适当地分解页面，而不管我们的内容位于何处。这意味着当溢出时，我们的内容会自动溢出到下一页，我们不希望这样，因为我们宁愿控制。我们将添加一些样式来让我们的HTML主体永远延续下去，并添加一个页面容器来匹配A4格式页面的约束。如果您使用不同的格式，您需要在页面容器的高度和宽度中插入相应的数字。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1a21" class="mx kz in mt b gy my mz l na nb">&lt;style&gt;<br/>html, body {<br/>	height: 100%;<br/>	margin: 0;<br/>	padding: 0;<br/>	}<br/>.page {<br/>	background: white;<br/>	display: block;<br/>	margin: 0 auto;<br/>	margin-bottom: 8.5em;<br/>	/* Size = A4 */<br/>	width: 21cm;<br/>	height: 29.7cm;<br/>	padding: 5em 30px 0 30px;<br/>	position: relative;</span></pre><h1 id="b9fd" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">在设置木偶师和手柄的文件中</h1><p id="e1a3" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">因为我们创建了一个style.hbs文件，所以我们想注册为一个分部文件，这样我们就可以把它插入到我们的模板中。这样，我们就不必把所有的样式都塞进我们的主模板文件，如果需要的话，还可以重用代码。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="88ac" class="mx kz in mt b gy my mz l na nb">hbs.registerPartial("style", fs.readFileSync(<br/>    path.join(__dirname, "/path/to/style.hbs"), "utf-8"),<br/>);</span></pre><p id="6b26" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">既然它已经注册为handlebars partial，我们可以简单地将它放入模板中。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="6376" class="mx kz in mt b gy my mz l na nb">{{&gt; styles }}<br/>&lt;/head&gt;<br/>  &lt;body&gt;<br/>	  &lt;div class="page"&gt;<br/>		{{#with Data as |myData| }}<br/>		 {{#each myData.text as |text| }}<br/>		 &lt;p&gt;{{text}}&lt;p&gt;<br/>		 {{/each}}<br/>		{{/with }}<br/>	  &lt;/div&gt;<br/>  &lt;/body&gt;</span></pre><h1 id="b3e3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第四步:加入一些d3</h1><p id="7b93" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">我们已经在模板头中引入了d3 CDN链接</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="425c" class="mx kz in mt b gy my mz l na nb">&lt;script src="https://d3js.org/d3.v5.min.js"&gt;&lt;/script&gt;</span></pre><p id="13bd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在是时候为我们的d3脚本创建一个片段了。我们将使用与创建style.hbs partial相同的方法来完成此操作。将d3_script.hbs文件注册为handlebars辅助对象。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="49f9" class="mx kz in mt b gy my mz l na nb">hbs.registerPartial("d3_script", fs.readFileSync(<br/>	path.join(__dirname, "/path/to/d3_script.hbs"), "utf-8"),<br/>);</span></pre><p id="56b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后我们可以根据需要把它放到我们的主模板中。还要注意模板中使用的canvas anchor div，它为我们的D3提供了一个基础。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="650a" class="mx kz in mt b gy my mz l na nb">my_template.hbs</span><span id="7b08" class="mx kz in mt b gy ne mz l na nb">{{/each}}<br/>	{{/with }}<br/>  &lt;/div&gt;<br/>  &lt;div class="canvas"&gt;&lt;/div&gt;<br/>&lt;/body&gt;<br/> <br/>&lt;script type="text/javascript"&gt;<br/>const svg = d3<br/>	.select('#canvas')<br/>	.append('svg')<br/>	.attr('viewBox', [-width / 2, -height / 2, width, height]);<br/>&lt;/script&gt;</span></pre></div></div>    
</body>
</html>