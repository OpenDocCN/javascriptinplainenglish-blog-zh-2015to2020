<html>
<head>
<title>Deploy a NestJS application in Heroku with GitLab CI/CD pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitLab CI/CD管道在Heroku中部署一个NestJS应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/deploy-a-nestjs-application-in-heroku-with-gitlab-ci-cd-pipelines-9773e6a8eb71?source=collection_archive---------1-----------------------#2020-11-14">https://javascript.plainenglish.io/deploy-a-nestjs-application-in-heroku-with-gitlab-ci-cd-pipelines-9773e6a8eb71?source=collection_archive---------1-----------------------#2020-11-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a9c6" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何使用GitLab CI/CD管道在Heroku中部署NestJS应用程序</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/151b280ea49163daa11082e406829da6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*gz01gxIuodn9EErMqYrsDg.png"/></div></figure><h1 id="0646" class="kk kl in bd km kn ko kp kq kr ks kt ku jt kv ju kw jw kx jx ky jz kz ka la lb bi translated">介绍</h1><p id="f25c" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">前几天我写了一个小教程解释如何创建一个NestJS应用程序<a class="ae ly" href="https://medium.com/swlh/create-an-api-rest-with-nestjs-1954723e8234" rel="noopener">用NestJS和PostgreSQL </a>创建一个API Rest，现在我将解释如何使用GitLab管道部署它。</p><h1 id="474c" class="kk kl in bd km kn ko kp kq kr ks kt ku jt kv ju kw jw kx jx ky jz kz ka la lb bi translated">先决条件</h1><p id="5975" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们需要在<a class="ae ly" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install" rel="noopener ugc nofollow" target="_blank"> Heroku </a>和<a class="ae ly" href="https://about.gitlab.com" rel="noopener ugc nofollow" target="_blank"> GitLab </a>创建一个账户。</p><p id="93f1" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">请确保您的操作系统上安装了<a class="ae ly" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a> ( &gt; = 10.13.0)。</p><h1 id="da4b" class="kk kl in bd km kn ko kp kq kr ks kt ku jt kv ju kw jw kx jx ky jz kz ka la lb bi translated">装置</h1><h2 id="8299" class="me kl in bd km mf mg dn kq mh mi dp ku ll mj mk kw lp ml mm ky lt mn mo la mp bi translated">NestJS</h2><p id="3038" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">一旦安装了NodeJS，我们就要安装<a class="ae ly" href="https://docs.nestjs.com/cli/overview" rel="noopener ugc nofollow" target="_blank"> NestJS CLI </a>，命令行界面帮助我们维护我们的应用程序。</p><p id="2bfc" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">安装完成后，我们将执行下一个命令来创建我们的项目。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="3fd6" class="me kl in mr b gy mv mw l mx my">$ nest new project-name</span></pre><p id="f18d" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">您可以在src目录中找到核心文件。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/e50a92a35890fb41364ddea798adfc12.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*J0haSvrd0Dlrb-D5o4ucJQ.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Core files</figcaption></figure><ul class=""><li id="3c1b" class="ne nf in le b lf lz li ma ll ng lp nh lt ni lx nj nk nl nm bi translated">app.controller.ts:路线简单的基础控制器。</li><li id="8041" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">app.service.ts:简单的服务。</li><li id="4fc3" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">app.module.ts:应用程序的根模块。</li><li id="2fc0" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">main.ts:使用核心函数<code class="fe ns nt nu mr b">NestFactory</code>创建嵌套应用实例的应用的入口文件。</li></ul><p id="880b" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">要启动应用程序，请键入以下命令。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="8e47" class="me kl in mr b gy mv mw l mx my">$ cd project-name</span><span id="629d" class="me kl in mr b gy nv mw l mx my">$ npm run start</span></pre><p id="1ba4" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在您可以打开浏览器并导航到<a class="ae ly" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>。</p><p id="0664" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">我们将创建一个服务来管理每个环境的配置，并读取环境变量<a class="ae ly" href="https://nodejs.org/dist/latest-v8.x/docs/api/process.html" rel="noopener ugc nofollow" target="_blank"><strong class="le io">process . env</strong></a><strong class="le io">，</strong>在我们的例子中，我们只需要端口。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="f45f" class="me kl in mr b gy mv mw l mx my">$ nest g service configuration/configuration</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/4739a7c532aa33898201b47c0e24305c.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*reJaJlSTAriBJuWvQ1FQ8g.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Configuration service.</figcaption></figure><p id="e3ad" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在，在AppModule类中创建一个服务实例，并添加一个名为port的新静态属性，在构造函数中初始化该属性。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/1534f8c1894a745db64d410acdc1d6cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*lCp_a_F-vxMOEXuq8Xf2PA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">AppModule.</figcaption></figure><p id="d2b3" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在main.ts文件中添加端口配置</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/75231bb6014c6c6feb28e3b7cc748b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*6CtJYBUbFPLOcvB8FAGXug.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">main.ts file</figcaption></figure><p id="b602" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">这些都是我们部署应用程序所需设置。</p><h2 id="10e2" class="me kl in bd km mf mg dn kq mh mi dp ku ll mj mk kw lp ml mm ky lt mn mo la mp bi translated">赫罗库</h2><p id="9e69" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">是时候安装Heroku了，可以找如何安装<a class="ae ly" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install" rel="noopener ugc nofollow" target="_blank">https://dev center . Heroku . com/articles/Heroku-CLI #下载安装</a>。</p><p id="9776" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">安装后，登录您的帐户。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="c302" class="me kl in mr b gy mv mw l mx my">$ heroku login</span><span id="7991" class="me kl in mr b gy nv mw l mx my">$ heroku create application-name</span></pre><p id="7a75" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在我们需要将名为<strong class="le io">NPM _配置_生产</strong>的环境变量配置为false，这是因为我们的管道需要在启动服务器之前生成我们项目的构建，而<strong class="le io">端口</strong>是应用程序用于部署的端口。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi nz"><img src="../Images/a6f4c39552f5525a4d094ea50175a3bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HaJsg8DjR2MtzESm8b73oA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Environment variable</figcaption></figure><h2 id="beda" class="me kl in bd km mf mg dn kq mh mi dp ku ll mj mk kw lp ml mm ky lt mn mo la mp bi translated">GitLab</h2><p id="c31b" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">是时候在<a class="ae ly" href="https://gitlab.com/" rel="noopener ugc nofollow" target="_blank"> GitLab </a>中创建一个账户了，一旦账户被创建，我们将创建一个新的存储库。</p><p id="92b1" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在进入NestJS项目，添加第一次提交，并将更改推入新的存储库中。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="73b7" class="me kl in mr b gy mv mw l mx my">$ cd projectname</span><span id="c46f" class="me kl in mr b gy nv mw l mx my">$ git add -A .</span><span id="ca11" class="me kl in mr b gy nv mw l mx my">$ git commit -m"First commit"</span><span id="9875" class="me kl in mr b gy nv mw l mx my">$ git remote add origin <a class="ae ly" href="mailto:git@gitlab.com" rel="noopener ugc nofollow" target="_blank">git@gitlab.com</a>:groupname/projectname-api.git</span><span id="8200" class="me kl in mr b gy nv mw l mx my">$ git push -u origin — all</span></pre><p id="bdd9" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在转到Settings / CI/CD / Variables，添加<strong class="le io"> APP </strong>和<strong class="le io"> HEROKU_API_KEY </strong>变量。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi oe"><img src="../Images/ded8162ff05d6dff7d840845f701f7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVY_12thOf1cgBQzbHXI7w.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Environment variables</figcaption></figure><p id="a85a" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">要获得Heroku的API密钥，请进入帐户设置和底部，您可以找到值和应用程序的名称。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi of"><img src="../Images/b4815f37198980c2c604257388f1505a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PS3Ikz6aRDYDFWEp6SGYTg.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Heroku API key.</figcaption></figure><p id="3718" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在，在项目中创建。gitlab-ci.yml文件，在这个文件中，我们将配置我们的管道。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="1ca1" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在我们的管道中，我们有4种规格。</p><ul class=""><li id="314e" class="ne nf in le b lf lz li ma ll ng lp nh lt ni lx nj nk nl nm bi translated"><strong class="le io">图片</strong>:指定NodeJS的版本。</li><li id="25a4" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><strong class="le io"> before_script </strong>:覆盖作业前执行的一组命令。</li><li id="cf59" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><strong class="le io">阶段</strong> : <strong class="le io"> </strong>定义一个作业阶段。</li><li id="55f3" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><strong class="le io">分期</strong> : <strong class="le io"> </strong>部署的是我们的环境。</li></ul><p id="cb6e" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">我们安装了<strong class="le io"> dpl </strong>依赖项，dpl是Travis CI开发和使用的用于持续部署的部署工具，但也可以与GitLab CI/CD一起使用，您可以在<a class="ae ly" href="https://docs.gitlab.com/ee/ci/examples/deployment/" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/ee/ci/examples/deployment/</a>中找到关于它的更多信息。</p><p id="1361" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在staging部分，我们指定任务“Deploy”的类型、我们使用的映像、定义作业阶段和我们用于部署的脚本。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="140f" class="me kl in mr b gy mv mw l mx my">dpl --provider=heroku --app=$HEROKU_APP_STAGING --api-key=$HEROKU_API_KEY</span></pre><p id="832a" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在脚本中，我们指定提供者，在我们的例子中是Heroku，我们的应用程序的名称，以及API密钥。</p><p id="9a7e" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">现在创建<strong class="le io"> Procfile </strong>并添加下一行:</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="2167" class="me kl in mr b gy mv mw l mx my">web: npm run start:prod</span></pre><p id="50bf" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">此命令在生产模式下启动项目。</p><p id="2103" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在package.json中，我们添加了新的脚本。</p><pre class="kd ke kf kg gt mq mr ms mt aw mu bi"><span id="3089" class="me kl in mr b gy mv mw l mx my">"postinstall": "npm run prestart:prod"</span><span id="981c" class="me kl in mr b gy nv mw l mx my">"prestart:prod": "rimraf dist &amp;&amp; npm run build"</span></pre><p id="91b4" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">在<strong class="le io"> install </strong>命令完成后，下一个命令是<strong class="le io"> prestart:prod </strong> its，因为我们需要在执行<strong class="le io"> start:prod </strong>之前创建我们项目的构建。</p><p id="8462" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">配置已经完成，现在我们提交所有的更改，创建一个名为<strong class="le io"> staging </strong>的新分支，并将其推送到GitLab。</p><p id="8729" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">GitLab将识别我们的管道，并开始在Heroku部署我们的应用程序。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi oi"><img src="../Images/6ba5736ab6814bff5f4910577f227649.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*njsYra4AgUl70OBB7Dg3iw.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Deploying app.</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi oj"><img src="../Images/12e15563fde98f7773dfb03255afc93e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nQLzZ-AIAPSd6YzCpNIPYg.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Log.</figcaption></figure><p id="90d9" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">部署过程完成后，我们可以通过单击“打开应用程序”按钮打开应用程序。</p><p id="8e1d" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">你可以在<a class="ae ly" href="https://gitlab.com/speakchron/speakchron-api" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/speakchron/speakchron-api</a>找到这个项目</p><h1 id="94b1" class="kk kl in bd km kn ko kp kq kr ks kt ku jt kv ju kw jw kx jx ky jz kz ka la lb bi translated">结论</h1><p id="b534" class="pw-post-body-paragraph lc ld in le b lf lg jo lh li lj jr lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">让我们来看看我们学到了什么。</p><ul class=""><li id="51b7" class="ne nf in le b lf lz li ma ll ng lp nh lt ni lx nj nk nl nm bi translated">如何用NestJS CLI创建一个简单的应用程序？</li><li id="9ad3" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">在我们的应用程序中配置环境变量。</li><li id="e859" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">配置我们要部署的项目的脚本。</li><li id="8c35" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">Heroku和GitLab上的环境配置。</li></ul><p id="5f19" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">首先感谢你的阅读，我希望这个小教程能帮助你。</p><p id="12bd" class="pw-post-body-paragraph lc ld in le b lf lz jo lh li ma jr lk ll mb ln lo lp mc lr ls lt md lv lw lx ig bi translated">最亲切的问候。</p></div></div>    
</body>
</html>