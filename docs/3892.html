<html>
<head>
<title>Uploading Files using Multer in Node.js Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js应用程序中使用Multer上传文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/uploading-file-using-multer-in-node-js-applications-bd4448dd41c4?source=collection_archive---------3-----------------------#2020-11-01">https://javascript.plainenglish.io/uploading-file-using-multer-in-node-js-applications-bd4448dd41c4?source=collection_archive---------3-----------------------#2020-11-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/ae7f7a7a788ca867abe4ace0acad898c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*5I98ze--fCdixv3KtMOa6A.png"/></div><figcaption class="jr js gj gh gi jt ju bd b be z dk">Uploading Images Using Multer</figcaption></figure><h1 id="6cdf" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">目录</h1><ul class=""><li id="8b09" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><a class="ae ll" href="#149d" rel="noopener ugc nofollow">简介</a></li><li id="336c" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated"><a class="ae ll" href="#6944" rel="noopener ugc nofollow">我们建造什么</a></li><li id="b876" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated"><a class="ae ll" href="#8659" rel="noopener ugc nofollow">上传图片</a></li><li id="b5fc" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated"><a class="ae ll" href="#9e1d" rel="noopener ugc nofollow">一个完整的例子</a></li><li id="1725" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated"><a class="ae ll" href="#363a" rel="noopener ugc nofollow">结论</a></li></ul><h1 id="149d" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</h1><p id="bfe4" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">今天，我们可以找到许多像照片共享应用程序或博客网站这样上传图像的应用程序和网站。这就是为什么，有很多很好的理由允许用户在服务器上存储文件。Http服务器使用POST请求处理文件上传。当谈到node.js时，情况就不同了。如果不使用库来处理上传，node.js本身是很难做到的。这就是原因，有许多可用的npm软件包。Multer是一个很好的上传npm包。主要配合express.js使用。</p><p id="00c0" class="pw-post-body-paragraph lr ls in kv b kw mg lt lu ky mh lv lw la mi ly lz lc mj mb mc le mk me mf lg ig bi translated">使用Express.JS构建web APIs很容易。我已经发布了一个关于express.js的教程。Multer是一个处理多部分/表单数据的npm包。它使express.js应用程序能够接受文件。在express.js服务器中配置非常容易。这个博客是最小化的，只教授使用<strong class="kv io"> multer </strong>上传文件，但是它试图给你一个线索，告诉你如何将一个图像链接到数据库中的一个记录，并在以后检索它。</p></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><h1 id="6944" class="jv jw in bd jx jy ms ka kb kc mt ke kf kg mu ki kj kk mv km kn ko mw kq kr ks bi translated">我们建造的东西</h1><p id="d28e" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">在本教程中，我将构建一个简单的博客web API。它让任何人都可以写有标题、内容和照片的博客。因此，我将使用快递。JS用于处理http请求，mongoose用于存储数据，Multer用于上传文件。</p><h2 id="99f0" class="mx jw in bd jx my mz dn kb na nb dp kf la nc nd kj lc ne nf kn le ng nh kr ni bi translated">设置</h2><ul class=""><li id="76a7" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">创建目录</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="981e" class="mx jw in no b gy ns nt l nu nv">mkdir file-upload<br/>cd file-upload</span></pre><ul class=""><li id="cd36" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">正在初始化package.json</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="6f4b" class="mx jw in no b gy ns nt l nu nv">npm init -y</span></pre><ul class=""><li id="e221" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">安装软件包</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="fba5" class="mx jw in no b gy ns nt l nu nv">npm i -S multer express mongoose body-parser uuid<br/>npm i -D nodemon</span></pre><ul class=""><li id="ad03" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">启动脚本:在package.json中，添加一个启动脚本，如下所示</li></ul><figure class="nj nk nl nm gt jo gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/4c65043d9fc7eb1cdd40f12313a9b40b.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/1*5QXKgGbLbHdopV7J0yLNmw.png"/></div><figcaption class="jr js gj gh gi jt ju bd b be z dk">Start Script</figcaption></figure><ul class=""><li id="de40" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">使用<strong class="kv io"> index.js </strong>文件(条目文件)内的路线创建express.js应用程序</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="27a0" class="mx jw in no b gy ns nt l nu nv"><strong class="no io"><em class="oa">// import packages<br/></em></strong>const express = require("express");<br/>const bodyParser = require("body-parser");<br/>const mongoose = require("mongoose");<br/>const path = require("path");</span><span id="3ef5" class="mx jw in no b gy ob nt l nu nv"><strong class="no io"><em class="oa">// create and configure express app<br/></em></strong>const app = express();<br/>app.use(bodyParser.json()); <strong class="no io"><em class="oa">//parsing json files</em></strong></span><span id="1fd0" class="mx jw in no b gy ob nt l nu nv"><strong class="no io"><em class="oa">// routes</em><br/></strong>app.get("/blogs",<br/>   (req, res) =&gt; res.json({ success: true, blogs: [] }));<br/>app.post("/blogs",<br/>   (req, res) =&gt; res.json({ success: true, blog: {} }));<br/>app.put("/blogs/{id}",<br/>   (req, res) =&gt; res.json({ success: true, blogs: [] }));<br/>app.delete("/blogs/{id}",<br/>   (req, res) =&gt; res.json({ success: true }));</span><span id="7b21" class="mx jw in no b gy ob nt l nu nv"><strong class="no io"><em class="oa">// this route is used for uploading<br/></em></strong>app.post("/blog/upload",<br/>   (req, res) =&gt; res.json({ success: true, blog: {} }));</span><span id="54f9" class="mx jw in no b gy ob nt l nu nv">const PORT = 3000;<br/>app.listen(PORT, (err) =&gt;<br/>   err<br/>   ? console.log(err)<br/>   : console.log(`The server is started on port: ${PORT}`)<br/>);</span></pre></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><h1 id="8659" class="jv jw in bd jx jy ms ka kb kc mt ke kf kg mu ki kj kk mv km kn ko mw kq kr ks bi translated">上传图像</h1><blockquote class="oc od oe"><p id="e08b" class="lr ls oa kv b kw mg lt lu ky mh lv lw of mi ly lz og mj mb mc oh mk me mf lg ig bi translated">Multer向<code class="fe oi oj ok no b">request</code>对象添加一个<code class="fe oi oj ok no b">body</code>对象和一个<code class="fe oi oj ok no b">file</code>或<code class="fe oi oj ok no b">files</code>对象。</p></blockquote><p id="1280" class="pw-post-body-paragraph lr ls in kv b kw mg lt lu ky mh lv lw la mi ly lz lc mj mb mc le mk me mf lg ig bi translated">如果multer被配置为上传单个文件，那么<strong class="kv io">文件</strong>属性被添加到请求字段，如果它被配置为上传多个<strong class="kv io">文件</strong>文件属性被附加到请求对象。</p><ul class=""><li id="fd46" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">需要NPM软件包</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="125b" class="mx jw in no b gy ns nt l nu nv">const multer = require("multer");<br/>const uuid4 = require("uuid").v4;</span></pre><ul class=""><li id="9fdb" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">配置存储</li></ul><p id="0092" class="pw-post-body-paragraph lr ls in kv b kw mg lt lu ky mh lv lw la mi ly lz lc mj mb mc le mk me mf lg ig bi translated"><strong class="kv io">磁盘存储</strong>是一种传递给multer的配置类型，用于配置multer在磁盘上永久存储文件。</p><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="df86" class="mx jw in no b gy ns nt l nu nv">const storage = multer.diskStorage({<br/>   destination: path.join(__dirname, "/public/uploads"),<br/>   filename: function (req, file, cb) {<br/>      const fullName =<br/>         "blog_" + uuid4().replace(/-/g, "") +<br/>         path.extname(file.originalname);<br/>         cb(null, fullName);<br/>   },<br/>});<br/>const upload = multer({ storage: storage });</span></pre><ul class=""><li id="b081" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">使用multer作为express.js中间件。</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="990c" class="mx jw in no b gy ns nt l nu nv">app.post("/blogs/upload", upload.single("photo"), (req, res) =&gt;<br/>   res.json({<br/>      success: true,<br/>      blog: {<br/>         photo: "/uploads/" + req.file.filename,<br/>     },<br/>   })<br/>);</span></pre><h2 id="bc34" class="mx jw in bd jx my mz dn kb na nb dp kf la nc nd kj lc ne nf kn le ng nh kr ni bi translated">需要考虑的事项</h2><ul class=""><li id="741c" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">我们需要允许express<strong class="kv io">提供公共文件</strong>，这样我们就可以提供上传的图片。</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="cdc4" class="mx jw in no b gy ns nt l nu nv">app.use(express.static(path.join(__dirname, "public")));</span></pre><ul class=""><li id="2806" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">Multer可以进一步配置为处理要上传的<strong class="kv io">最大</strong> <strong class="kv io">文件大小限制</strong>。<strong class="kv io">文件大小</strong>以字节计算。</li><li id="34f1" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated">文件可以在上传前通过<strong class="kv io">过滤器</strong>。可能有一种情况<strong class="kv io">只允许</strong>上传图片。或者过滤器可以用于其他用途。</li></ul><pre class="nj nk nl nm gt nn no np nq aw nr bi"><span id="d3a1" class="mx jw in no b gy ns nt l nu nv">const upload = multer({<br/>   storage: storage,<br/>   limits: { fileSize: 2000000 }, <br/>   fileFilter: function (req, file, cb) {<br/>      const fileTypes = /png|jpeg|jpg/;<br/>      const extName =<br/>         fileTypes.test(path.extname(file.originalname));<br/>      file.originalname.toLowerCase();<br/>      const mimeType = fileTypes.test(file.mimetype);<br/>      if (extName &amp;&amp; mimeType) {<br/>         cb(null, true);<br/>      } else {<br/>         cb("Error: only png, jpeg, and jpg are allowed!");<br/>      }<br/>    },<br/>});</span></pre><h2 id="0f6c" class="mx jw in bd jx my mz dn kb na nb dp kf la nc nd kj lc ne nf kn le ng nh kr ni bi translated">一个演示Multer的例子</h2><p id="20f0" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">这个例子演示了使用<strong class="kv io"> multer </strong>为<strong class="kv io"> express </strong>上传<strong class="kv io">文件。</strong></p><figure class="nj nk nl nm gt jo"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="fe91" class="mx jw in bd jx my mz dn kb na nb dp kf la nc nd kj lc ne nf kn le ng nh kr ni bi translated">要上传的邮递员</h2><p id="ab50" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">为了测试上传文件的API，我们将使用postman。</p><ul class=""><li id="c71b" class="kt ku in kv b kw mg ky mh la nw lc nx le ny lg lh li lj lk bi translated">首先粘贴URL“localhost:3000/blogs/upload/id _ 1234”</li><li id="75ff" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated">将方法更改为POST</li><li id="2711" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated">在Body选项卡中选择<strong class="kv io">表单-数据</strong>，并添加带有类型文件的关键照片。</li><li id="724e" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated">选择一个文件，然后发送请求。</li></ul><figure class="nj nk nl nm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="oo op di oq bf or"><div class="gh gi on"><img src="../Images/66e6b243c705fb3e91889d9b29a532e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWBCyG6wqk8-foa_MhUDTw.png"/></div></div><figcaption class="jr js gj gh gi jt ju bd b be z dk">Client Request Demonstrating</figcaption></figure><h1 id="9e1d" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">一个完整的例子</h1><p id="8bcd" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">下面的代码是<strong class="kv io">文件上传和附加到blog </strong>的完整示例，使用了另外四种不同的路径来检索、存储、更新和删除blog。它使用mongoose连接到mongodb来读写数据。</p><figure class="nj nk nl nm gt jo"><div class="bz fp l di"><div class="ol om l"/></div></figure></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><h1 id="363a" class="jv jw in bd jx jy ms ka kb kc mt ke kf kg mu ki kj kk mv km kn ko mw kq kr ks bi translated">结论</h1><p id="90c5" class="pw-post-body-paragraph lr ls in kv b kw kx lt lu ky kz lv lw la lx ly lz lc ma mb mc le md me mf lg ig bi translated">上传文件可以在社交网络应用程序、文件托管服务如<strong class="kv io"> OneDrive </strong>等中找到。在express.js应用程序中，可以很容易地配置multer来处理文件上传。</p><p id="f164" class="pw-post-body-paragraph lr ls in kv b kw mg lt lu ky mh lv lw la mi ly lz lc mj mb mc le mk me mf lg ig bi translated">您克隆这个<a class="ae ll" href="https://github.com/bewarusman/node-file-upload.git" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io">存储库</strong> </a>以获得完整的代码。如果您有任何问题、顾虑或建议，我将很高兴收到您的来信。</p></div></div>    
</body>
</html>