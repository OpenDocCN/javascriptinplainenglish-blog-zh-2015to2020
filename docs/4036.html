<html>
<head>
<title>React: Why Is My State Not Being Updated?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React:为什么我的状态没有被更新？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-why-is-my-state-not-being-updated-63a078db9c4e?source=collection_archive---------18-----------------------#2020-11-11">https://javascript.plainenglish.io/react-why-is-my-state-not-being-updated-63a078db9c4e?source=collection_archive---------18-----------------------#2020-11-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="afcc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个常见的堆栈溢出问题</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/654ef94e0aa20e634075c506d1933865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Kx7YuimnxGM5qS0d"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@nooryounis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">noor Younis</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8b02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我经常在StackOverflow中读到这个问题的一些变体，后面跟着下一个代码</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="08fa" class="lx ly iq lt b gy lz ma l mb mc">const doSomethingWithTheState = () =&gt; {<br/>  setState(newValue);<br/>  console.log(state); // this prints the old value<br/>};</span></pre><p id="5dc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而且我总是用同样的<a class="ae kv" href="https://reactjs.org/docs/react-component.html#setstate" rel="noopener ugc nofollow" target="_blank"> React文档页面</a>的摘录来回答:<em class="md"> setState()并不总是立即更新组件。它可以批处理或推迟更新，直到以后。这使得在调用setState()之后立即读取this.state成为一个潜在的陷阱。</em></p><h1 id="db3c" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">为什么React会这样处理？</h1><p id="1b71" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">由于更新状态将触发<a class="ae kv" href="https://reactjs.org/docs/reconciliation.html" rel="noopener ugc nofollow" target="_blank">协调</a>算法，并将导致重新渲染，React将决定何时是更新状态的最佳时刻，以便保持良好的性能。</p><p id="75d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们再次检查我们的示例代码:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="88fe" class="lx ly iq lt b gy lz ma l mb mc">const doSomethingWithTheState = () =&gt; {<br/>  setState(newValue);<br/>  <!-- -->console.log(state); // this prints the old value<br/>};</span></pre><p id="0f03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果立即更新状态，这将意味着在到达第一行时调用协调算法，这将触发重新呈现器，为了能够继续执行下一行，React将需要保持下一步执行什么的上下文，这将是昂贵的。这就是为什么React决定不这么做，而首先执行<em class="md"> console.log </em>的原因。</p><p id="3a0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，如果您连续更新状态中的一个以上的值(调用setState <em class="md"> n </em>次),这将意味着执行<em class="md"> n </em>次算法和<em class="md"> n </em>次重新呈现器，您很快就会发现这对性能不利。</p><h1 id="39c5" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">热到解决？</h1><p id="a99f" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">如果您需要使用更新的状态值，您有以下选项:</p><h2 id="18a0" class="lx ly iq bd mf na nb dn mj nc nd dp mn lf ne nf mp lj ng nh mr ln ni nj mt nk bi translated">如果你正在使用一个<a class="ae kv" href="https://reactjs.org/docs/components-and-props.html#function-and-class-components" rel="noopener ugc nofollow" target="_blank">类组件</a></h2><p id="1865" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">使用一个<a class="ae kv" href="https://reactjs.org/docs/react-component.html#setstate" rel="noopener ugc nofollow" target="_blank">回调</a>函数，它将在应用更新后被调用</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="fdc5" class="lx ly iq lt b gy lz ma l mb mc">doSomethingWithTheState = () =&gt; {<br/>  this.setState(newValue, state =&gt; {<br/>    console.log(state); // this prints the updated value<br/>  })<br/>};</span></pre><p id="fc97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新渲染后，所有状态变量将被更新为最近的值，并且将调用<a class="ae kv" href="https://reactjs.org/docs/react-component.html#componentdidupdate" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">componentDidUpdate</strong></a>函数，在该函数中，您可以访问新值和以前的值。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="28ef" class="lx ly iq lt b gy lz ma l mb mc">componentDidUpdate(prevProps, prevState) {<br/>  if (this.state !== prevState) {<br/>    <!-- -->console.log(this.state); // this prints the updated value<br/>  }<br/>}</span></pre><h2 id="70c5" class="lx ly iq bd mf na nb dn mj nc nd dp mn lf ne nf mp lj ng nh mr ln ni nj mt nk bi translated">如果您正在使用<a class="ae kv" href="https://reactjs.org/docs/components-and-props.html#function-and-class-components" rel="noopener ugc nofollow" target="_blank">功能组件</a></h2><p id="5cc9" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">使用<a class="ae kv" href="https://reactjs.org/docs/hooks-reference.html#useeffect" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> useEffect </strong> </a>钩子指定要在依赖项数组中监视的值，如下一段代码所示:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="1d80" class="lx ly iq lt b gy lz ma l mb mc">const [state, setState] = useState()</span><span id="0982" class="lx ly iq lt b gy nl ma l mb mc">useEffect(() =&gt; {<br/>  console.log(state); // this prints the updated value<br/>}, [state]); // this will be triggered only when state value is different</span></pre><h1 id="6b24" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">结论</h1><p id="a2ac" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">现在你知道你的状态不被更新的最常见原因了。</p><p id="72eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文中讨论的所有信息都在React文档中，我知道开始做事情总是比阅读更令人兴奋，但是我向您保证，如果您正确使用该工具，您将会省去许多麻烦。</p></div></div>    
</body>
</html>