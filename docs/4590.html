<html>
<head>
<title>I Built an API for Sending &amp; Receiving WhatsApp Messages</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我构建了一个API来发送和接收WhatsApp消息</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-apify-whatsapp-programmatic-interaction-with-whatsapp-from-node-using-playwright-227326796bf6?source=collection_archive---------8-----------------------#2020-12-22">https://javascript.plainenglish.io/how-to-apify-whatsapp-programmatic-interaction-with-whatsapp-from-node-using-playwright-227326796bf6?source=collection_archive---------8-----------------------#2020-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d293" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从服务和应用程序发送WhatsApp消息是我们的客户经常提出的要求。这也是我希望在研讨会和演示中使用的东西。它对人们有吸引力。然而，WhatsApp没有提供用于发送或接收消息的开放API。</p><p id="6a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">公司可以通过全球解决方案提供商利用一项业务服务，前提是合同到位。对于简单的用例来说太模糊了——如果你能进入的话。有一个B计划:一个非常简单的方法来为WhatsApp构建自己的API在WhatsApp Web UI之上使用一个简单的节点应用程序，并利用剧作家浏览器自动化库。注意，剧作家也可以用于Python、Go、C#和Java。</p><p id="7e2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我之前的文章<a class="ae kl" href="https://technology.amis.nl/2020/12/21/what-you-could-do-if-you-had-a-free-tireless-browser-operator-introducing-playwright/" rel="noopener ugc nofollow" target="_blank">中可以读到对剧作家的广泛介绍，如果你有一个免费的、不知疲倦的浏览器操作者，你会做什么？！介绍剧作家。</a>简而言之:剧作家是一个开源软件库，它在machina中给了我们一个<em class="km">deus—</em>我们浏览器中的一个机器人确实执行了幂运算。这为从自动化测试到战术集成和RPA(机器人过程自动化)以及从深度</p><p id="c856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">链接书签、屏幕抓取、web应用健康监控(smoketests)和定制的web应用。剧作家是一个相当新的(2020年)，开源的，基于JavaScript的，用于端到端测试的跨浏览器自动化库，由微软的一个团队创建——该团队曾在谷歌工作，并创建了流行的木偶工具。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/57289992f7f8a4061bcf8716cbad86c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c2gQichuxbLf70LC2VY13Q.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk">Putting an API on top of the WhatsApp Web UI using Node and Playwright</figcaption></figure><p id="40fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文描述了一个节点应用程序，它通过剧作家运行嵌入式浏览器。这个浏览器被导航到WhatsApp网络应用。然后，节点应用程序以编程方式在网页中定位要向其发送消息的联系人，并将要发送的消息键入文本框中。最后，它点击发送按钮来发布消息。</p><p id="0da8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">节点应用程序可以处理许多发送消息的请求。很容易用附加功能扩展该模块——用于检索消息、发送图像、向多个联系人发送消息、用于拼写检查和扩展首字母缩写词和缩写词、用于翻译和收听到来的消息以及当它们到达时发布事件。将模块包装在真正的REST API中也很容易，可以在集成和应用程序中使用。</p><h1 id="5620" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">创建与WhatsApp Web对话的节点应用程序</h1><p id="99a3" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">通过剧作家创建一个与WhatsApp Web协同工作的节点应用程序当然需要一个安装了剧作家的节点运行时环境。然后创建一个节点应用程序，导航到WhatsApp Web并保持浏览器长时间运行。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/b5f4af222cdf9654bf3af7bba0aa51e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*TssP-uY9yw91CVto.png"/></div></figure><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="d027" class="mm le iq mi b gy mn mo l mp mq">const { chromium } = require('playwright');<br/>const WHATSAPP_WEB_URL = "https://web.whatsapp.com/"</span><span id="6503" class="mm le iq mi b gy mr mo l mp mq">const sleep = (milliseconds) =&gt; {<br/>  return new Promise(resolve =&gt; setTimeout(resolve, milliseconds))<br/>}</span><span id="aca3" class="mm le iq mi b gy mr mo l mp mq">(async () =&gt; {</span><span id="855e" class="mm le iq mi b gy mr mo l mp mq">const browser = await chromium.launch({ headless: false })<br/>const context = await browser.newContext()<br/>const page = await context.newPage();</span><span id="a35e" class="mm le iq mi b gy mr mo l mp mq">await page.goto(WHATSAPP_WEB_URL);</span><span id="59ab" class="mm le iq mi b gy mr mo l mp mq">// inspect the user interface elements to manipulate for locating the contact, typing and sending tyhe message</span><span id="a8f6" class="mm le iq mi b gy mr mo l mp mq">// find the CSS selectors for the relevant element</span><span id="c4ba" class="mm le iq mi b gy mr mo l mp mq">await sleep(50000000) // 1000* 50 seconds<br/>await browser.close()<br/>})()</span></pre><p id="63a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当执行这个应用程序时，会打开一个匿名浏览器窗口，并显示一个QR码。你需要在手机上的WhatsApp应用中扫描这个二维码——每次重启节点应用的时候。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/cf1bd48c59e73386239db0d356b55eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*okEp1GOPP55d5IRe.png"/></div></figure><p id="9b9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想知道是否在cookies或本地存储中存储了QR码验证的确认，如果是，它可以由节点应用程序初始化，因此可以跳过这一手动步骤。</p><p id="1008" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证成功后，WhatsApp Web UI打开。现在是时候拿出浏览器开发工具(ctrl+shift+i)并检查相关元素来发现CSS选择器了。下图描述了我确定的选择器:</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/40b89015c5e6d9b60ff2da3006a9f846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*sgHeYoyNokWfstb3.png"/></div></figure><p id="49a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择器<code class="fe ms mt mu mi b">._1awRl</code>用于定位输入联系人姓名的搜索字段。我们使用<code class="fe ms mt mu mi b">span[title=”${whatsappContact}”]</code>来查找联系人的元素，单击该元素可以在右窗格中显示最近的消息列表。</p><p id="6472" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用<code class="fe ms mt mu mi b">text=Type a message</code>我们找到一个可以输入新信息的盒子。最后<code class="fe ms mt mu mi b">button._2Ujuu</code>用于识别点击发送按钮提交消息。有了这四个选择器，就没什么可编程的了:</p><ul class=""><li id="ed44" class="mv mw iq jp b jq jr ju jv jy mx kc my kg mz kk na nb nc nd bi translated">在搜索栏中输入联系人姓名</li><li id="1dae" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">点击联系人姓名</li><li id="7529" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">在文本框中输入消息</li><li id="dae6" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">点击按钮发送消息</li></ul><p id="e5c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">处理这一问题的代码如下所示:</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="6034" class="mm le iq mi b gy mn mo l mp mq">const { chromium } = require('playwright');<br/>const WHATSAPP_WEB_URL = "https://web.whatsapp.com/"</span><span id="64f6" class="mm le iq mi b gy mr mo l mp mq">// replace with your contact name and message<br/>const whatsappContact = "Mezelf, mij en ik"<br/>const message = "My message from the WhatsApp robot"</span><span id="4cb8" class="mm le iq mi b gy mr mo l mp mq">const sleep = (milliseconds) =&gt; {<br/>  return new Promise(resolve =&gt; setTimeout(resolve, milliseconds))<br/>}</span><span id="72d3" class="mm le iq mi b gy mr mo l mp mq">(async () =&gt; {</span><span id="a5f4" class="mm le iq mi b gy mr mo l mp mq">const browser = await chromium.launch({ headless: false })<br/>const context = await browser.newContext()<br/>const page = await context.newPage();</span><span id="8585" class="mm le iq mi b gy mr mo l mp mq">await page.goto(WHATSAPP_WEB_URL);</span><span id="32ab" class="mm le iq mi b gy mr mo l mp mq">// wait for element search box<br/>await page.waitForSelector('._1awRl')</span><span id="6339" class="mm le iq mi b gy mr mo l mp mq">// enter name of contact in search box<br/>await page.fill('._1awRl', whatsappContact);</span><span id="792b" class="mm le iq mi b gy mr mo l mp mq">// page filters list of contacts<br/>await page.waitForSelector(`span[title="${whatsappContact}"]`)<br/>// click on the contact - this refreshes the right pane with recent messages and a box for sending new messages<br/>await page.click(`span[title="${whatsappContact}"]`)</span><span id="8405" class="mm le iq mi b gy mr mo l mp mq">// wait for the field to send a message<br/>await page.waitForSelector('text=Type a message')<br/>// type the message to send<br/>await page.type('text=Type a message', message)</span><span id="0f2c" class="mm le iq mi b gy mr mo l mp mq">// click button to send message<br/>await page.click('button._2Ujuu')</span><span id="30b6" class="mm le iq mi b gy mr mo l mp mq">await browser.close()</span><span id="c7f9" class="mm le iq mi b gy mr mo l mp mq">})()</span></pre><h1 id="10bd" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">资源</h1><p id="d88c" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">本文在GitHub上的代码:<a class="ae kl" href="https://github.com/lucasjellema/playwright-scenarios/tree/main/whatsapp" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/lucasjellema/剧作家-场景/tree/main/whatsapp </a></p><p id="dc1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我之前的文章:对剧作家的广泛介绍<a class="ae kl" href="https://lucasjellema.medium.com/what-you-could-do-if-you-had-a-free-tireless-browser-operator-introducing-playwright-1ecd31ace3ad?source=your_stories_page-------------------------------------" rel="noopener">如果你有一个免费的、不知疲倦的浏览器运营商，你能做什么？！介绍剧作家</a></p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="bdbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">原载于2020年12月22日</em><a class="ae kl" href="https://technology.amis.nl/2020/12/22/how-to-apify-whatsapp-programmatic-interaction-with-whatsapp-from-node-using-playwright/" rel="noopener ugc nofollow" target="_blank"><em class="km">https://technology . amis . nl</em></a><em class="km">。</em></p></div></div>    
</body>
</html>