<html>
<head>
<title>React Native: Getting user device timezone and converting UTC time-stamps with offset</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React Native:获取用户设备时区并使用偏移量转换UTC时间戳</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-native-getting-user-device-timezone-and-converting-utc-time-stamps-with-offset-697902d7803?source=collection_archive---------2-----------------------#2020-07-13">https://javascript.plainenglish.io/react-native-getting-user-device-timezone-and-converting-utc-time-stamps-with-offset-697902d7803?source=collection_archive---------2-----------------------#2020-07-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/3264408af6cb8bee409c4ea3c6b769ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G6dOguCgKkj8AODB"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk">Photo by <a class="ae ja" href="https://unsplash.com/@elisamichelet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Elisa Michelet</a> on <a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="d840" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">与web相反，React Native不在浏览器中运行，因此在试图获取时区偏移量和考虑夏令时时时会变得很棘手。</p><p id="5bba" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最近，我的任务是将所有后端生成的时间戳从默认的UTC转换为用户的设备时区。这是我一路上遇到一些问题，以及如何解决我的票的过程。</p><h1 id="2c02" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">流程图</h1><p id="6eec" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">这是我想要的流程:</p><ol class=""><li id="7f4f" class="mb mc jd kc b kd ke kh ki kl md kp me kt mf kx mg mh mi mj bi translated">以小时为单位获取用户UTC时间偏移量。</li><li id="921e" class="mb mc jd kc b kd mk kh ml kl mm kp mn kt mo kx mg mh mi mj bi translated">将后端时间戳和偏移量发送到一个转换函数，该函数将转换后的+格式字符串返回到前端。</li></ol><p id="7f2d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je">步骤2中的函数将如下工作:</strong></p><h2 id="0cc8" class="mp kz jd bd la mq mr dn le ms mt dp li kl mu mv lm kp mw mx lq kt my mz lu na bi translated"><strong class="ak">T3】params:T5】</strong></h2><ul class=""><li id="a5c9" class="mb mc jd kc b kd lw kh lx kl nc kp nd kt ne kx nf mh mi mj bi translated"><em class="ng">字符串:日期字符串</em></li><li id="5876" class="mb mc jd kc b kd mk kh ml kl mm kp mn kt mo kx nf mh mi mj bi translated"><em class="ng"> Int: offset </em></li></ul><p id="5a7a" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je"> a) </strong>解析日期字符串‘datestring’。<br/> <strong class="kc je"> b) </strong>将数据转换成JS日期对象。<br/> <strong class="kc je"> c) </strong>使用JS `Date `内置函数` getHours()`方法获取date对象的当前小时数。<br/> <strong class="kc je"> d) </strong>使用JS `Date '内置函数' setHours()'在Date对象上设置新的小时，其中我们传入当前小时，并添加传入函数的偏移量。<br/> <strong class="kc je"> e) </strong>将字符串格式化到前端。<br/> <strong class="kc je"> f) </strong>返回最终转换后的时间戳。</p><h2 id="0132" class="mp kz jd bd la mq mr dn le ms mt dp li kl mu mv lm kp mw mx lq kt my mz lu na bi translated"><strong class="ak">让我们看看代码中会发生什么:</strong></h2><p id="7cb7" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">让我们想象一下如何使用我们的函数，它可能看起来像这样</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="74db" class="mp kz jd nm b gy nq nr l ns nt">const convertedTimeStamp = formatTimeByOffset(utcStringFromBE, offset)</span></pre><p id="bf04" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我根据上述步骤构建的函数如下所示:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="04f4" class="mp kz jd nm b gy nq nr l ns nt">export const formatTimeByOffset = (dateString, offset) =&gt; {<br/>  // Params:<br/>  // How the backend sends me a timestamp<br/>  // dateString: on the form yyyy-mm-dd hh:mm:ss<br/>  // offset: the amount of hours to add.</span><span id="51cb" class="mp kz jd nm b gy nu nr l ns nt">// If we pass anything falsy return empty string<br/>  if (!dateString) return ''<br/>  if (dateString.length === 0) return ''</span><span id="7ac2" class="mp kz jd nm b gy nu nr l ns nt">// Step a: Parse the backend date string</span><span id="abe9" class="mp kz jd nm b gy nu nr l ns nt">// Get Parameters needed to create a new date object<br/>  const year = dateString.slice(0, 4)<br/>  const month = dateString.slice(5, 7)<br/>  const day = dateString.slice(8, 10)<br/>  const hour = dateString.slice(11, 13)<br/>  const minute = dateString.slice(14, 16)<br/>  const second = dateString.slice(17, 19)</span><span id="01ab" class="mp kz jd nm b gy nu nr l ns nt">// Step: bMake a JS date object with the data<br/>  const dateObject = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`)</span><span id="dc10" class="mp kz jd nm b gy nu nr l ns nt">// Step c: Get the current hours from the object<br/>  const currentHours = dateObject.getHours()</span><span id="406a" class="mp kz jd nm b gy nu nr l ns nt">// Step d: Add the offset to the date object<br/>  dateObject.setHours(currentHours + offset)</span><span id="c368" class="mp kz jd nm b gy nu nr l ns nt">// Step e: stringify the date object, replace the T with a space and slice off the seconds.<br/>  const newDateString = dateObject<br/>    .toISOString()<br/>    .replace('T', ' ')<br/>    .slice(0, 16)</span><span id="e802" class="mp kz jd nm b gy nu nr l ns nt">// Step f: Return the new formatted date string with the added offset<br/>  return `${newDateString}`<br/>}</span></pre><p id="d26e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是GitHub上的代码。</p><p id="15e1" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过一些快速测试，随机时间偏移中的旁路表明该功能工作正常。调用它并打印结果会给出以下内容:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="6daf" class="mp kz jd nm b gy nq nr l ns nt">const convertedToLocalTime = formatTimeByOffset('2001-04-11 10:00:00', 7)</span><span id="4738" class="mp kz jd nm b gy nu nr l ns nt">console.log(convertedToLocalTime)<br/>// --&gt; "2001-04-11 17:00:00"</span></pre><p id="f274" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">厉害！现在我们只需要获得用户的UTC时间偏移，我们就完成了🚀理论上这可能很简单，但是需要额外的考虑。</p></div><div class="ab cl nv nw hr nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ig ih ii ij ik"><h1 id="a511" class="ky kz jd bd la lb oc ld le lf od lh li lj oe ll lm ln of lp lq lr og lt lu lv bi translated">JS日期</h1><p id="358e" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">我最初的想法是简单地使用JavaScript Date，更具体地说是getTimeZone方法。这里的文档:<a class="ae ja" href="https://www.w3schools.com/jsref/jsref_gettimezoneoffset.asp" rel="noopener ugc nofollow" target="_blank"> JS Date getTimeZone()方法</a></p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="57ab" class="mp kz jd nm b gy nq nr l ns nt">const now = new Date()<br/>const utcTimeOffset = now.getTimezoneOffset() / 60;</span></pre><p id="38f8" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ng">注意:除以60，因为该方法返回以分钟为单位的偏移量。</em></p><p id="296e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je">不幸的是，这并不总能给出正确的时间！</strong></p><p id="e690" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，将我的系统时区改为美国西海岸，给了我一个小时错误的转换时间戳！为什么？🤔</p><h1 id="85a3" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">夏令时</h1><p id="383a" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">如果我们在浏览器中运行，这可能会有效，因为现在的浏览器会返回DST调整的偏移量(如果我错了，请纠正我)。</p><p id="5ba8" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然而，由于我们不是在浏览器中运行，我们需要找出一种不同的方法来确定用户是否受到夏令时事件的影响。手动操作将会很棘手，因为并非所有国家都使用夏令时，而且当夏令时生效时，他们不会使用相同的日期和时间。那我们该怎么办？</p><p id="1b1b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们先搞清楚用户的时区，尽管我们不是在浏览器中运行，而是在移动设备上运行。一定有办法获取设备的时间并利用它为我们服务。</p><h1 id="cfc0" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">获取移动设备时区</h1><p id="af18" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">每当我想在react native中使用原生模块时，比如使用相机，我就会求助于Github 上的<a class="ae ja" href="https://github.com/react-native-community" rel="noopener ugc nofollow" target="_blank"> React native社区。</a></p><p id="f196" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对我们来说幸运的是，这个社区有一个本地模块，叫做<a class="ae ja" href="https://github.com/react-native-community/react-native-localize" rel="noopener ugc nofollow" target="_blank">react-native-community/react-native-localize</a>。</p><p id="b356" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我进去看了文档，发现了下面的方法:<a class="ae ja" href="https://github.com/react-native-community/react-native-localize#gettimezone" rel="noopener ugc nofollow" target="_blank"> getTimeZone() </a>。</p><h2 id="439c" class="mp kz jd bd la mq mr dn le ms mt dp li kl mu mv lm kp mw mx lq kt my mz lu na bi translated"><strong class="ak">是这样描述的:</strong></h2><p id="7ee1" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated"><em class="ng">返回用户首选时区(基于其设备设置，而非其位置)。</em></p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="797b" class="mp kz jd nm b gy nq nr l ns nt">console.log(RNLocalize.getTimeZone());<br/>// -&gt; "Europe/Paris"</span></pre><p id="7a6f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">好的，很好。我像往常一样将这个包安装到我的项目中:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="d90c" class="mp kz jd nm b gy nq nr l ns nt">yarn add react-native-localize</span><span id="acdc" class="mp kz jd nm b gy nu nr l ns nt">cd ios &amp;&amp; pod install</span><span id="1607" class="mp kz jd nm b gy nu nr l ns nt">cd ..</span><span id="2dda" class="mp kz jd nm b gy nu nr l ns nt">yarn run ios</span></pre><p id="1fcc" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我运行了上面的例子:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="8e2a" class="mp kz jd nm b gy nq nr l ns nt">console.log(RNLocalize.getTimeZone());<br/>// -&gt; "Asia/Shanghai"</span></pre><p id="23b7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">好极了。如果情况变得更糟，我可以做一个查找表，记录不同时区何时进入夏令时等。<strong class="kc je">但是经过一些google-fu之后，就没有这个必要了，所以让我们引入moment时区库。</strong></p><h1 id="9368" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">时刻时区</h1><p id="41ee" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated"><a class="ae ja" href="https://momentjs.com/timezone/" rel="noopener ugc nofollow" target="_blank">时刻时区文件</a></p><p id="3c8d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">moment timezone库可以获取上面生成的时区值，并返回UTC偏移量。整洁！</p><p id="1c23" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ng">安装:</em></p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="8e8b" class="mp kz jd nm b gy nq nr l ns nt">yarn add moment-timezone</span></pre><p id="4b63" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">结合获取上面的设备时区，我们可以这样使用它:</p><pre class="nh ni nj nk gt nl nm nn no aw np bi"><span id="eae0" class="mp kz jd nm b gy nq nr l ns nt">import React, {useState, useEffect} from 'react';<br/>import {View, Text} from 'react-native';</span><span id="0624" class="mp kz jd nm b gy nu nr l ns nt">import {formatTimeByOffset} from '../helpers/formatTimeByOffset';<br/>import * as RNLocalize from 'react-native-localize';<br/>import moment from 'moment-timezone';</span><span id="102d" class="mp kz jd nm b gy nu nr l ns nt">function Component() {<br/>  const [timeToDisplay, setTimeToDisplay] = useState('');</span><span id="0446" class="mp kz jd nm b gy nu nr l ns nt">const backEndTimeStamp = '2001-04-11 10:00:00';</span><span id="904f" class="mp kz jd nm b gy nu nr l ns nt">// get device timezone eg. -&gt; "Asia/Shanghai"<br/>  const deviceTimeZone = RNLocalize.getTimeZone();</span><span id="a5eb" class="mp kz jd nm b gy nu nr l ns nt">// Make moment of right now, using the device timezone<br/>  const today = moment().tz(deviceTimeZone);</span><span id="e1c0" class="mp kz jd nm b gy nu nr l ns nt">// Get the UTC offset in hours<br/>  const currentTimeZoneOffsetInHours = today.utcOffset() / 60;</span><span id="bf12" class="mp kz jd nm b gy nu nr l ns nt">useEffect(() =&gt; {<br/>    // Run the function as we coded above.<br/>    const convertedToLocalTime = formatTimeByOffset(<br/>      backEndTimeStamp,<br/>      currentTimeZoneOffsetInHours,<br/>    );</span><span id="cf90" class="mp kz jd nm b gy nu nr l ns nt">// Set the state or whatever<br/>    setTimeToDisplay(convertedToLocalTime);<br/>  }, []);</span><span id="933f" class="mp kz jd nm b gy nu nr l ns nt">return (<br/>    &lt;View<br/>      style={{<br/>        height: '100%',<br/>        width: '100%',<br/>        alignItems: 'center',<br/>        justifyContent: 'center',<br/>      }}&gt;<br/>      &lt;Text style={{fontSize: 22, marginBottom: 20}}&gt;Time-Example&lt;/Text&gt;<br/>      &lt;Text style={{fontSize: 14, marginBottom: 20}}&gt;<br/>        Time passed into the function: {backEndTimeStamp}<br/>      &lt;/Text&gt;<br/>      &lt;Text style={{fontSize: 14, marginBottom: 20}}&gt;<br/>        Converted To local timezone: {timeToDisplay}<br/>      &lt;/Text&gt;<br/>      &lt;Text&gt;Your timezone: {deviceTimeZone}&lt;/Text&gt;<br/>    &lt;/View&gt;<br/>  );<br/>}</span><span id="d955" class="mp kz jd nm b gy nu nr l ns nt">export default Component;</span></pre><p id="b831" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们看看实际运行中的代码！</p><figure class="nh ni nj nk gt ip gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/2221574457ee2b81601f1d55d2de1e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*CXnvw2wM58IZlKjBWz7Q-A.png"/></div></figure><p id="e19a" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae ja" href="https://github.com/ugglr/Mini-Tutorials-React-Native/blob/master/examples/src/screens/TimeZoneExample.js" rel="noopener ugc nofollow" target="_blank">这是Github上的代码</a></p><h1 id="e9cb" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">成功！</h1><p id="a5fb" class="pw-post-body-paragraph ka kb jd kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">我认为有很好的方法使它更紧凑，但是对于一个教程，我宁愿说得多一点也不要错过一些细节。</p><p id="26a8" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您觉得这有帮助，请告诉我！</p></div></div>    
</body>
</html>