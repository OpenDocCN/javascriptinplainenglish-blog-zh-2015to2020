<html>
<head>
<title>Creating a Dev.to clone with React, Node, TypeScript, GraphQL and Apollo (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React、Node、TypeScript、GraphQL和Apollo创建要克隆的开发工具(第2部分)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-refreshtoken-authentication-99fa89d567e9?source=collection_archive---------2-----------------------#2019-11-16">https://javascript.plainenglish.io/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-refreshtoken-authentication-99fa89d567e9?source=collection_archive---------2-----------------------#2019-11-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="06bd" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">添加RefreshToken和身份验证中间件</h2></div><p id="1a72" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你好，社区，今天我正在写这个系列文章的第2部分，在这个系列文章中，我试图用最少的功能克隆dev.to。这将是一个原型，其中用户可以注册/登录，创建帖子和其他功能。</p><blockquote class="ky kz la"><p id="ab73" class="kc kd lb ke b kf kg jo kh ki kj jr kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">我这样做只是为了学习。</p><p id="c87e" class="kc kd lb ke b kf kg jo kh ki kj jr kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">如果你没有参观过第一部，请先了解一下<a class="ae lf" href="https://medium.com/@vinodc45/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-graphql-orm-environment-part-1-cf83f65e795d" rel="noopener">Part-1</a>&amp;<a class="ae lf" href="https://medium.com/@vinodc45/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-graphql-orm-environment-part-3-5dd9fdfbb312" rel="noopener">Part-3</a></p></blockquote><h1 id="e6c8" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">技术堆栈:</h1><p id="6ff3" class="pw-post-body-paragraph kc kd in ke b kf ly jo kh ki lz jr kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated"><strong class="ke io"> NodeJs，ReactJs，Graphql，TypeOrm，TypeGraphql，Typescript，JWT，阿波罗服务器快递，Jest，阿波罗客户端，阿波罗链接&amp;更多..</strong></p><p id="92fe" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae lf" href="https://github.com/vinodchauhan7/dev.to-clone" rel="noopener ugc nofollow" target="_blank"> GitHub链接</a></p><p id="a897" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本系列的第二部分中，我能够为后端服务器的<strong class="ke io">刷新令牌</strong>、<strong class="ke io">认证中间件</strong>创建逻辑。此外，我还用<strong class="ke io"> Apollo-Client、React-Bootstrap、Styled-components、Graphql-CodeGen &amp; &amp;对React前端进行了更多的设置</strong>。</p><p id="ad11" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了方便起见，我在我的Git存储库中创建了两个分支，以便更清楚地理解事情:<br/> * <a class="ae lf" href="https://github.com/vinodchauhan7/dev.to-clone/tree/Part-4" rel="noopener ugc nofollow" target="_blank">第4部分添加对graphql API的认证和撤销刷新令牌逻辑</a> <br/> * <a class="ae lf" href="https://github.com/vinodchauhan7/dev.to-clone/tree/Part-5" rel="noopener ugc nofollow" target="_blank">第5部分前端&amp;后端设置</a></p><h1 id="4166" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">第4部分(GitHub分支)</h1><p id="9a91" class="pw-post-body-paragraph kc kd in ke b kf ly jo kh ki lz jr kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">在这个分支中，我们主要做了以下四件事:</p><p id="6e1b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">令牌版本</strong>:此“令牌版本”保存在每个用户处，默认值为0。这将有助于识别刷新令牌的身份验证，用户登录的次数和其他事情，如结束用户的所有会话。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="4865" class="mm lh in mi b gy mn mo l mp mq">//For authentication, I am changing createRefreshToken method.<br/>export const createRefreshToken = (user: User) =&gt; {<br/>  return sign(<br/>    { userId: user.id, tokenVersion: user.tokenVersion },<br/>    process.env.REFRESH_TOKEN_SECRET!,<br/>    {<br/>      expiresIn: "7d"<br/>    }<br/>  );</span></pre><p id="5b6a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">刷新令牌</strong>:众所周知，当我们点击“登录变更”查询时，<strong class="ke io">服务器</strong>会将“刷新令牌”作为cookies发回给我们。现在想象一下，如果一个用户登录到我们的<strong class="ke io"> dev.to </strong> clone并刷新页面，那么我们需要创建一个机制让它登录并提供他/她被认证的所有服务。为了使这成为可能，我在我们的服务器上制作了一个“POST”API，它接受cookies作为刷新令牌，然后验证它。如果刷新令牌在服务器端验证成功，那么我们再次发送最新的“刷新令牌”和“访问令牌”给用户，这样用户就不必一次又一次地登录。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b684" class="mm lh in mi b gy mn mo l mp mq">app.use(cookieParser());<br/><br/>  app.post("/refresh_token", async (req, res) =&gt; {<br/>    const token = req.cookies.devId;<br/>    if (!token) {<br/>      console.log("token is not valid " + token);<br/>      return res.send({ ok: false, accessToken: "" });<br/>    }<br/><br/>    let payload: any = null;<br/>    try {<br/>      payload = await verify(token, process.env.REFRESH_TOKEN_SECRET!);<br/>    } catch (err) {<br/>      console.log(err);<br/>      return res.send({ ok: false, accessToken: "" });<br/>    }<br/>    console.log("payload :: " + payload.userId);<br/>    //token is valid and we can send him access token now.abnf<br/>    const user = await User.findOne({ id: payload.userId });<br/><br/>    if (!user) {<br/>      console.log("User not found");<br/>      return res.send({ ok: false, accessToken: "" });<br/>    }<br/><br/>    if (user.tokenVersion !== payload.tokenVersion) {<br/>      return res.send({ ok: false, accessToken: "" });<br/>    }<br/><br/>    //Referesh Token<br/>    res.cookie("devId", createRefreshToken(user), {<br/>      httpOnly: true<br/>    });<br/><br/>    return res.send({ ok: true, accessToken: createAccessToken(user) });<br/>  });</span></pre><p id="f124" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">登录和刷新令牌:</p><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/20c4b447b3b75dc0a41573ae574a6e27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vtbw9U8208n3pG-t8JtqjA.png"/></div></div></figure><p id="1134" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">2)使用postman调用REST API，并在其中设置refreshToken为cookie。</p><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/206e373daac85fb4a02955bcc627725e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NK_w_gpZMmvYrIWx_u65Mw.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">Add Cookies</figcaption></figure><p id="3c52" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3)基于刷新令牌获取新的访问令牌。</p><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/ff2e3478f050cba09d1ac4302dbdc2f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6dgXlncosqaxM-2baLD0_g.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">AccessToken Verified</figcaption></figure><h1 id="422a" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">认证中间件:</h1><p id="5981" class="pw-post-body-paragraph kc kd in ke b kf ly jo kh ki lz jr kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">假设我们有一些graphql查询，我们希望这些查询只对经过身份验证的用户可用。为了完成这个任务，我使用了“type-graphql”的中间件。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="0bcb" class="mm lh in mi b gy mn mo l mp mq">@Query(() =&gt; String)<br/>  @UseMiddleware(isAuth) //Below is implementation<br/>  me(@Ctx() { payload }: MyContext) {<br/>    return `${payload!.userId}`;<br/>  }<br/><br/>//isAuth.ts<br/>export const isAuth: MiddlewareFn&lt;MyContext&gt; = ({ context }, next) =&gt; {<br/>  const authorization = context.req.headers["authorization"];<br/><br/>  if (!authorization) {<br/>    throw new Error("Not Authenticated");<br/>  }<br/><br/>  try {<br/>    const token = authorization.split(" ")[1];<br/>    const payload = verify(token, process.env.ACCESS_TOKEN_SECRET!);<br/>    context.payload = payload as any;<br/>  } catch (err) {<br/>    console.error(err);<br/>    throw new Error("Not Authenticated");<br/>  }<br/>  return next();<br/>};</span></pre><h1 id="e8df" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">正在撤销刷新令牌:</h1><p id="2bac" class="pw-post-body-paragraph kc kd in ke b kf ly jo kh ki lz jr kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">想象一下，您的“刷新令牌”没有过期&amp;您“忘记了密码”，然后您不希望任何人能够对受保护的graphql查询进行身份验证，或者简单地删除其所有登录会话，然后您可以更新特定用户的令牌版本，以便他需要用刷新令牌的令牌版本来验证自己。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b14f" class="mm lh in mi b gy mn mo l mp mq">@Mutation(() =&gt; Boolean)<br/>  async revokeRefreshToken(@Arg("userId", () =&gt; Int) userId: number) {<br/>    await getConnection()<br/>      .getRepository(User)<br/>      .increment({ id: userId }, "tokenVersion", 1);<br/><br/>    return true;<br/>  }</span></pre><h1 id="7712" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">第五部分分支</h1><p id="507e" class="pw-post-body-paragraph kc kd in ke b kf ly jo kh ki lz jr kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">在这个分支中，我们用命令<br/>“npx create-react-app devto-typescript”设置了react前端应用程序。安装后，添加以下模块:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="f448" class="mm lh in mi b gy mn mo l mp mq">yarn add apollo-boost @apollo/react-hooks graphql<br/>yarn add -D @types/graphql</span></pre><p id="a777" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">*更新您的app.tsx文件**</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="2c00" class="mm lh in mi b gy mn mo l mp mq">import React from "react";<br/>import ReactDOM from "react-dom";<br/>import ApolloClient from "apollo-boost";<br/>import { ApolloProvider } from "@apollo/react-hooks";<br/>import "bootstrap/dist/css/bootstrap.min.css";<br/>import App from "./App";<br/><br/>const client = new ApolloClient({<br/>  uri: "http://localhost:4000/graphql",<br/>  credentials: "include"<br/>});<br/><br/>ReactDOM.render(<br/>  &lt;ApolloProvider client={client}&gt;<br/>    &lt;App /&gt;<br/>  &lt;/ApolloProvider&gt;,<br/>  document.getElementById("root1")<br/>);</span></pre><h1 id="97b4" class="lg lh in bd li lj lk ll lm ln lo lp lq jt lr ju ls jw lt jx lu jz lv ka lw lx bi translated">添加graphql/CodeGen</h1><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8434" class="mm lh in mi b gy mn mo l mp mq">yarn add -D @graphql-codegen/cli<br/>//then<br/>npx graphql-codegen init</span></pre><p id="8f5a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">设置步骤:</p><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/7c42804b8cec62ae423fa93dee1bdb6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lj_hI-ggBUUhpoMv0x1Eg.png"/></div></div></figure><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/3000a516a4b0bf3b8fc784e8a0c004e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRBY3d_yYmuzEJzKDrREpg.png"/></div></div></figure><figure class="md me mf mg gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mr"><img src="../Images/c608f6f931bf0f3c07c911d0abb5465e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vrNAVfOugiXSg4D1B6px9A.png"/></div></div></figure><p id="eb48" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">创建您的第一个graphql查询</strong></p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="91b7" class="mm lh in mi b gy mn mo l mp mq">query Hello {<br/>  hello<br/>}</span></pre><p id="94e4" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">在app.tsx </strong>中使用HelloQuery()</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c37a" class="mm lh in mi b gy mn mo l mp mq">import React from "react";<br/>import { BrowserRouter as Router, Switch, Route } from "react-router-dom";<br/>import { HeaderComponent } from "./components/Header/header.component";<br/>import { GlobalStyle } from "./ui_components/GlobalStyle";<br/>import { ColStyle, RowStyle } from "./ui_components/RowColStyle";<br/>import { RegisterComponent } from "./components/User/Register.component";<br/>import { useHelloQuery } from "./generated/graphql";<br/>const App: React.FC = () =&gt; {<br/>  const { data, loading } = useHelloQuery();<br/><br/>  if (loading || !data) {<br/>    return &lt;div&gt;...&lt;/div&gt;;<br/>  }<br/><br/>  return (<br/>    &lt;&gt;<br/>      &lt;GlobalStyle&gt;&lt;/GlobalStyle&gt;<br/>      &lt;RowStyle&gt;<br/>        &lt;ColStyle md={12}&gt;<br/>          &lt;HeaderComponent /&gt;<br/>        &lt;/ColStyle&gt;<br/>      &lt;/RowStyle&gt;<br/>      &lt;RowStyle&gt;<br/>        &lt;ColStyle md={12}&gt;<br/>          &lt;Router&gt;<br/>            &lt;Switch&gt;<br/>              &lt;Route exact path="/" render={() =&gt; &lt;div&gt;{data.hello}&lt;/div&gt;} /&gt;<br/>              &lt;Route exact path="/register" component={RegisterComponent} /&gt;<br/>            &lt;/Switch&gt;<br/>          &lt;/Router&gt;<br/>        &lt;/ColStyle&gt;<br/>      &lt;/RowStyle&gt;<br/>    &lt;/&gt;<br/>  );<br/>};<br/><br/>export default App;</span></pre><p id="1be8" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望你会喜欢这篇文章，我会很快带着更多的代码回来:)。</p></div></div>    
</body>
</html>