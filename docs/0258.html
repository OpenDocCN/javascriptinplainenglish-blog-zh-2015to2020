<html>
<head>
<title>Build a Restful NodeJS API with SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SQL构建Restful NodeJS API</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-a-nodejs-expressjs-moviestore-webapi-with-postgresql-database-6fbf60fce2da?source=collection_archive---------2-----------------------#2019-09-07">https://javascript.plainenglish.io/create-a-nodejs-expressjs-moviestore-webapi-with-postgresql-database-6fbf60fce2da?source=collection_archive---------2-----------------------#2019-09-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="82fc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我将展示如何用SQL数据库开发一个完整的node.js web API。我们要做一个现实生活中的电影故事项目。</p><blockquote class="ki"><p id="73c4" class="kj kk in bd kl km kn ko kp kq kr kh dk translated">用SQL数据库构建一个通用的后端，它将支持所有的客户端应用程序。</p></blockquote><figure class="kt ku kv kw kx ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ks"><img src="../Images/e755700d8106b5978c92893d515a8264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iw4cceszTn8Kq0Pj.png"/></div></div></figure><p id="67c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Node.js是基于Chrome的V8 JavaScript引擎构建的JavaScript运行时</strong>。我们将使用Node创建一个服务器端应用程序。由于节点的非阻塞异步特性，节点用于创建高可伸缩性、数据密集型和实时应用程序。它速度超快，并且使用JavaScript。</p><p id="8a82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">记住！<strong class="jm io">节点不是编程语言</strong>。它是执行javascript代码的运行时环境。Node.js使用事件驱动的非阻塞I/O模型，这使得它变得轻量级和高效。它有一个包生态系统，<strong class="jm io"> npm </strong>，是世界上最大的开源库生态系统。</p><figure class="lg lh li lj gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lf"><img src="../Images/31c294381d97b360a1f0ccab24a6403e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DLIXPxOHgFIMWanI.png"/></div></div></figure><p id="4338" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Express是一个最小且灵活的Node.js web框架，为web和移动应用程序提供了一组强大的功能。Express是许多Web应用程序的“主干”,它们的后端在NodeJS中。转到https://expressjs.com/en/starter/installing.html<a class="ae lk" href="https://expressjs.com/en/starter/installing.html" rel="noopener ugc nofollow" target="_blank">的express.js文档</a></p><h1 id="a18b" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">创建Restful API </strong></h1><p id="0e96" class="pw-post-body-paragraph jk jl in jm b jn mj jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh ig bi translated">创建一个新目录，从终端进入目录路径，输入<code class="fe mo mp mq mr b">npm init</code>，它将初始化<code class="fe mo mp mq mr b">package.json</code>，它将存储项目中使用的所有依赖项。</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="9c67" class="mw lm in mr b gy mx my l mz na">const express = require(‘express’)<br/>const app = express()<br/>const port = 3000</span><span id="2863" class="mw lm in mr b gy nb my l mz na">app.get(‘/’, (req, res) =&gt; <br/>    res.send(‘Hello World!’)<br/>)</span><span id="0b1f" class="mw lm in mr b gy nb my l mz na">app.listen(port, () =&gt; console.log(`Example app listening on port ${port}!`))</span></pre><h2 id="b16f" class="mw lm in bd ln nc nd dn lr ne nf dp lv jv ng nh lz jz ni nj md kd nk nl mh nm bi translated"><strong class="ak">节点门</strong></h2><p id="a4b9" class="pw-post-body-paragraph jk jl in jm b jn mj jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh ig bi translated">Nodemon是一个实用程序，它将监视源代码中的任何更改，并自动重启服务器。非常适合开发。只需使用<code class="fe mo mp mq mr b">nodemon</code>而不是<code class="fe mo mp mq mr b">node</code>来运行您的代码，现在当您的代码更改时，您的进程将自动重启。要安装，获取<a class="ae lk" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> node.js </a>，然后从您的终端运行:</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="c26b" class="mw lm in mr b gy mx my l mz na">npm install -g nodemon</span></pre><p id="a003" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有关基本的快速JS路由，请阅读以下文章:</p><div class="nn no gp gr np nq"><a href="https://medium.com/@hidayatarg/basic-routing-in-express-js-30a374915cbb" rel="noopener follow" target="_blank"><div class="nr ab fo"><div class="ns ab nt cl cj nu"><h2 class="bd io gy z fp nv fr fs nw fu fw im bi translated">Express.js中的基本路由</h2><div class="nx l"><h3 class="bd b gy z fp nv fr fs nw fu fw dk translated">路由是指确定应用程序如何响应客户端对特定端点的请求，这是一个URI…</h3></div><div class="ny l"><p class="bd b dl z fp nv fr fs nw fu fw dk translated">medium.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ld nq"/></div></div></a></div><h1 id="dbf8" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建第一个应用程序</h1><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="922f" class="mw lm in mr b gy mx my l mz na"><em class="of">mkdir </em><a class="ae lk" href="https://github.com/hidayatarg/101-NodeJs-MovieStore" rel="noopener ugc nofollow" target="_blank">101-NodeJs-MovieStore</a><em class="of"> &amp;&amp; cd </em><a class="ae lk" href="https://github.com/hidayatarg/101-NodeJs-MovieStore" rel="noopener ugc nofollow" target="_blank">101-NodeJs-MovieStore</a></span></pre><p id="c564" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建一个新目录来保存这个项目，然后切换到那个目录。随着大多数节点项目的开始，打开您的终端，从初始化NPM开始，创建一个<em class="of"> package.json </em>文件。</p><p id="8b24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后将Express作为依赖项安装。</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="da89" class="mw lm in mr b gy mx my l mz na">npm init --yes<br/>npm install express --save</span></pre><h1 id="1dc7" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">服务器</h1><p id="d06f" class="pw-post-body-paragraph jk jl in jm b jn mj jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh ig bi translated">我们将从经典的“hello world”示例开始，解释它，然后从那里开始构建。首先，创建一个名为<em class="of"> index.js </em>的新文件，并添加以下代码。</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="2355" class="mw lm in mr b gy mx my l mz na">const express = require('express');<br/>const app = express();<br/>const port = 3000;</span><span id="523d" class="mw lm in mr b gy nb my l mz na">app.get('/', (req, res) =&gt; {<br/>  res.send('hello world');<br/>});</span><span id="f7ac" class="mw lm in mr b gy nb my l mz na">app.listen(port, () =&gt; {<br/>  console.log(`Express backend running on localhost: ${port}`);<br/>});</span></pre><p id="5d9d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个应用程序启动一个服务器并在端口3000上监听连接。该应用程序会回复“你好，世界！”对于请求，以根URL ( <code class="fe mo mp mq mr b">/</code>)或<strong class="jm io"> <em class="of">路由</em> </strong>。对于每一个其他路径，它将响应一个<strong class="jm io"> 404未找到</strong>。</p><p id="7a3b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">通过以下命令从终端本地运行</strong></p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="bc1b" class="mw lm in mr b gy mx my l mz na">node app.js</span></pre><p id="e2af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">或者</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="0535" class="mw lm in mr b gy mx my l mz na">nodemon server.js</span></pre><p id="f49a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mo mp mq mr b">node</code>和<code class="fe mo mp mq mr b">nodemo</code>的主要区别。如果您使用<code class="fe mo mp mq mr b">node</code>命令，每次保存后您手动运行该命令，或者如果您使用<code class="fe mo mp mq mr b">nodemon</code>命令，它会在保存项目的任何文件后自动检测更改。</p><p id="388a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后在浏览器中打开<em class="of"> localhost:3000 </em>，您应该会看到:</p><figure class="lg lh li lj gt ky gh gi paragraph-image"><div class="gh gi og"><img src="../Images/62d17d50d85f9e9bd86789970ee82ed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:120/0*ibS26tZb0xczkfKB"/></div></figure><figure class="lg lh li lj gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi oh"><img src="../Images/b8ad0e85f9bb0721159c708c26041ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SzqZGkSBOwzZIOI3.png"/></div></div></figure><p id="13eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">使用PG创建数据库和功能。</strong></p><p id="d92c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">pg是Node.js的非阻塞PostgreSQL客户端，纯JavaScript和可选的原生libpq绑定。</p><h2 id="a1d3" class="mw lm in bd ln nc nd dn lr ne nf dp lv jv ng nh lz jz ni nj md kd nk nl mh nm bi translated">安装pg</h2><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="c2c8" class="mw lm in mr b gy mx my l mz na">npm install pg --save</span></pre><p id="a7ff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为数据库创建pool.js</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="1e01" class="mw lm in mr b gy mx my l mz na">const Pool = require ('pg').Pool;<br/>const pool = new Pool({        <br/>      user     : 'postgres',        <br/>      host     : 'localhost',        <br/>      database : '101-NodeJs-MovieStore',        <br/>      password : '**',        <br/>      port     : 5432,    <br/>});<br/>module.exports = pool;</span></pre><p id="827f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过SQL客户端在数据库中创建电影表</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="c7e2" class="mw lm in mr b gy mx my l mz na">CREATE TABLE movies(   <br/> id serial PRIMARY KEY,   <br/> title VARCHAR,   <br/> cover VARCHAR,   <br/> created_on TIMESTAMP<br/>);</span></pre><p id="2553" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用movie.js文件创建一个新文件，并放入以下代码</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="68d8" class="mw lm in mr b gy mx my l mz na">const pool = require('./pool')<br/><br/>const getMovies = (request, response) =&gt; {<br/>        pool.query('SELECT * FROM movies ORDER BY "id" DESC', (error, results) =&gt; {<br/>            if (error) {<br/>                throw error<br/>            }<br/>            const res = {<br/>                success: true,<br/>                data: results.rows.sort(item =&gt;item.as)<br/>            }<br/>            response.status(200).json(res)<br/>        });<br/>}<br/><br/>const getMoviesById = (request, response) =&gt; {<br/>    const id = parseInt(request.params.id)<br/><br/>    pool.query('SELECT * FROM movies WHERE id = $1', [id], (error, results) =&gt; {<br/>        // if remove return use if else<br/>        if (error) {<br/>            return response.status(500).json({ errors: { global: "Something went wrong" } });<br/>        }<br/>       return response.status(200).json(results.rows[0])<br/>    });<br/>}<br/><br/>const createMovie = (request, response) =&gt; {<br/>    const { errors, isValid } = validate(request.body);<br/><br/>    if (isValid){<br/>        const { title, cover } = request.body<br/>        pool.query('INSERT INTO movies (title, cover) VALUES ($1, $2) RETURNING * ', [title, cover], (error, results) =&gt; {<br/>            if (error) {<br/>               return response.status(500).json({ errors: { global: "Something went wrong" } });<br/>            }<br/>          return  response.status(201).json(results.rows);<br/>        })<br/>    } else {<br/>        response.status(400).json({ errors });<br/>    }   <br/>}<br/><br/>const validate = (data) =&gt; {<br/>    let errors = {};<br/>    if (data.title === '') errors.title = "Can't be empty";<br/>    if (data.cover === '') errors.cover = "Can't be empty";<br/>    const isValid = Object.keys(errors).length === 0;<br/>    return { errors, isValid };<br/>};<br/><br/>const updateMovie = (request, response) =&gt; {<br/>    const id = parseInt(request.params.id)<br/>    const { title, cover } = request.body<br/><br/>    pool.query(<br/>        'UPDATE movies SET title = $1, cover = $2 WHERE id = $3',<br/>        [title, cover, id],<br/>        (error, results) =&gt; {<br/>            if (error) {<br/>                return response.status(500).json({ errors: { global: "Something went wrong" } });<br/>            }<br/>            return response.status(200).send(`User modified with ID: ${id}`)<br/>        }<br/>    )<br/>}<br/><br/>const deleteMovie = (request, response) =&gt; {<br/>    const id = parseInt(request.params.id)<br/><br/>    pool.query('DELETE FROM movies WHERE id = $1', [id], (error, results) =&gt; {<br/>        if (error) {<br/>            return response.status(500).json({ errors: { global: "Something went wrong" } });<br/>        }<br/>        return response.status(200).json('OK')<br/>    });<br/>}<br/><br/>module.exports = {<br/>    getMovies,<br/>    getMoviesById,<br/>    createMovie,<br/>    updateMovie,<br/>    deleteMovie,<br/>}</span></pre><p id="5dad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们需要更新index.js</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="771d" class="mw lm in mr b gy mx my l mz na">const express = require('express')<br/>const bodyParser = require('body-parser')<br/>const app = express()<br/>const config = require('./config');<br/>const cors = require('cors');<br/><br/>app.use(bodyParser.json())<br/>app.use(<br/>    bodyParser.urlencoded({<br/>        extended: true,<br/>    })<br/>)<br/>app.use(cors());<br/>app.get('/', (request, response) =&gt; {<br/>    response.json({ info: 'Node.js, Express, and Postgres API' })<br/>})<br/><br/>const db = require('./queries')<br/><br/>app.get('/api/movies', db.getMovies)<br/>app.get('/api/movies/:id', db.getMoviesById)<br/>app.post('/api/movies', db.createMovie)<br/>app.put('/api/movies/:id', db.updateMovie)<br/>app.delete('/api/movies/:id', db.deleteMovie)<br/><br/><br/><br/><br/>app.use((req, res) =&gt; {<br/>    res.status(404).json({<br/>        errors: {<br/>            global: "Still working on it. Please try again later when we implement it."<br/>        }<br/>    });<br/>});<br/><br/><br/>// port listening<br/>app.listen(config.port, () =&gt; {<br/>    console.log(`App running on port ${config.port}.`)<br/>})</span></pre><p id="87d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">和config.js</p><pre class="lg lh li lj gt ms mr mt mu aw mv bi"><span id="b3b0" class="mw lm in mr b gy mx my l mz na">module.exports = {<br/>    port: '8080',<br/>}</span></pre></div></div>    
</body>
</html>