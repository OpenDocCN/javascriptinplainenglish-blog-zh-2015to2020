<html>
<head>
<title>JavaScript Proxies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript代理</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-proxies-b41abcdd2bda?source=collection_archive---------3-----------------------#2020-05-03">https://javascript.plainenglish.io/javascript-proxies-b41abcdd2bda?source=collection_archive---------3-----------------------#2020-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9f5d77e8cd3285bdcbf9da3d833ac48b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MrmHIH3lN9LjMFcWS8GSVQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@timmossholder?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Tim Mossholder</a> on <a class="ae kc" href="https://unsplash.com/s/photos/private?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9c9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">代理是ES6的一个特性，能够监控给定对象的访问方式。例如，假设我们有一个对象<code class="fe lb lc ld le b">alice</code>包含一些关于爱丽丝的信息，比如她的生日、年龄、身高、体重和身体质量指数。</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="66a4" class="ln lo iq le b gy lp lq l lr ls">const alice = {<br/>  birthdate: '2000-04-06',<br/>  age: 20,<br/>  height: 170,<br/>  weight: 65,<br/>  bmi: 22.5,<br/>};</span></pre><p id="561f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过执行以下操作，可以简单地读取和设置属性:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="85d1" class="ln lo iq le b gy lp lq l lr ls">console.log(alice.height);<br/>console.log(alice.age);<br/>alice.weight = 64;</span></pre><p id="0fa3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该对象可能会被代码的其他部分使用，因此可能会出现一些问题。我们可能希望让对象的外部消费者改变Alice的体重，而不是她的生日。如果她是一个成年人，改变她的身高也没有多大意义。如果她的体重发生变化，我们应该重新计算身体质量指数。而且她的年龄大概应该在被要求的时候算出来。</p><p id="7d4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个想法是创建像<code class="fe lb lc ld le b">getAge</code>或<code class="fe lb lc ld le b">setWeight</code>这样的方法。这将部分工作，但不会阻止任何人简单地做<code class="fe lb lc ld le b">alice.weight = 64;</code>。JavaScript本身没有私有字段。</p><p id="37bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一种本地JavaScript解决方案是使用代理。代理仅仅是你的原始对象的包装器(称为<em class="lt">目标</em>)。</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="a0c6" class="ln lo iq le b gy lp lq l lr ls">const handler = {};<br/>const proxy = new Proxy(alice, handler);</span></pre><p id="785b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您通过调用<code class="fe lb lc ld le b">Proxy</code>构造函数来创建它，您将<em class="lt">目标</em>，在我们的例子中是<em class="lt"> </em> <code class="fe lb lc ld le b">alice</code>，以及一个<em class="lt">处理程序</em>作为参数传递给它。<em class="lt">处理程序</em>是一个对象，我们可以在其中定义如何访问每个属性。在这个例子中，我们的<em class="lt">处理程序</em>是空的，所以代理只是将每个访问请求转发给对象。</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="e7ca" class="ln lo iq le b gy lp lq l lr ls">console.log(proxy.age); // 20<br/>console.log(proxy.height); // 170</span></pre><p id="7494" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用<em class="lt">处理程序</em>来定义当<code class="fe lb lc ld le b">age</code>属性被读取时返回什么。</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="b1f8" class="ln lo iq le b gy lp lq l lr ls">const handler = {<br/>  get (target, key) {<br/>    if (key === 'age') {<br/>      return calculateAge(new Date(target.birthdate));<br/>    }<br/>    return target[key];<br/>  }<br/>};<br/>const proxy = new Proxy(alice, handler);</span></pre><p id="6f3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在测试，这里是<code class="fe lb lc ld le b">calculateAge</code>函数:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="309c" class="ln lo iq le b gy lp lq l lr ls">const calculateAge = (birthdate) =&gt; {<br/>  const today = new Date();<br/>  let age = today.getFullYear() - birthdate.getFullYear();<br/>  const m = today.getMonth() - birthdate.getMonth();<br/>  if (m &lt; 0 || (m === 0 &amp;&amp; today.getDate() &lt; birthdate.getDate())) {<br/>    age--;<br/>  }<br/>  return age;<br/>}</span></pre><p id="46eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的<em class="lt">处理程序</em>现在包含一个<code class="fe lb lc ld le b">get</code> <em class="lt">陷阱</em>。当试图读取代理的任何属性时，将使用<code class="fe lb lc ld le b">target</code> ( <code class="fe lb lc ld le b">alice</code>)和<code class="fe lb lc ld le b">key</code>调用这个<code class="fe lb lc ld le b">get</code>函数。当试图读取<code class="fe lb lc ld le b">age</code>时，我们从<code class="fe lb lc ld le b">birhdate</code>返回一个计算值，而不是简单地返回<code class="fe lb lc ld le b">alice.age</code>。对于任何其他属性，我们只返回<code class="fe lb lc ld le b">target[key]</code>。</p><p id="08fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以测试:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="c478" class="ln lo iq le b gy lp lq l lr ls">alice.age = 22;<br/>console.log(proxy.age); // 20<br/>console.log(proxy.height); // 170</span></pre><p id="99a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以定义一个<code class="fe lb lc ld le b">set</code>陷阱，定义是否以及如何设置属性。例如，我们希望防止设置出生日期属性，并且如果体重发生变化，我们希望重新计算身体质量指数:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="90f9" class="ln lo iq le b gy lp lq l lr ls">const handler = {<br/>  get (target, key) {<br/>    ...<br/>  },<br/>  set (target, key, value) {<br/>    if (key === 'birthdate') {<br/>      throw new Error('Birthdate is readonly');<br/>    } else if (key === 'weight') {<br/>      const { height } = target;<br/>      target.bmi = Math.round(<br/>        value / (height / 100 * height / 100) * 100<br/>      ) / 100;<br/>    }<br/>    return true;<br/>  }<br/>};</span></pre><p id="da3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您试图设置一个新的生日，您将会收到一个错误消息:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/bb925c8ed044adec4885c1fd4b849ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/1*F8c3i-QoEFYTEsXGLSAbiA.png"/></div></figure><p id="fa8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则每个属性都被设置为值(这就是<code class="fe lb lc ld le b">return true;</code>的意思)。设置重量后，我们现在重新计算身体质量指数。您可以测试:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="319e" class="ln lo iq le b gy lp lq l lr ls">console.log(proxy.bmi); // 22.5<br/>proxy.weight = 63;<br/>console.log(proxy.bmi); // 21.8</span></pre><p id="3784" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以对其他只读属性做类似的事情，比如<code class="fe lb lc ld le b">age</code>和<code class="fe lb lc ld le b">height</code>。我们还可以在它们的名字前面添加<code class="fe lb lc ld le b">_</code>，并编写我们的<code class="fe lb lc ld le b">set</code>陷阱，这样对于任何以<code class="fe lb lc ld le b">_</code>开头的名字的属性都会抛出一个错误。</p><p id="1686" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">顺便说一句，只有当你不访问<code class="fe lb lc ld le b">alice</code>对象而只访问<code class="fe lb lc ld le b">proxy</code>对象时，这一切才有价值。因此<code class="fe lb lc ld le b">alice</code>对象不应该被导出。</p><p id="e4c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">陷阱不止是<code class="fe lb lc ld le b">set</code>和<code class="fe lb lc ld le b">get</code>。例如，您可以在以下情况下定义行为:</p><ul class=""><li id="91fb" class="lv lw iq kf b kg kh kk kl ko lx ks ly kw lz la ma mb mc md bi translated">正在使用<code class="fe lb lc ld le b">deleteProperty</code>陷阱删除一个属性(<code class="fe lb lc ld le b">delete alice.height;</code>)。</li><li id="0a93" class="lv lw iq kf b kg me kk mf ko mg ks mh kw mi la ma mb mc md bi translated">正在检查带有<code class="fe lb lc ld le b">has</code>陷阱的对象(<code class="fe lb lc ld le b">console.log('age' in proxy);</code>)上是否存在属性。</li><li id="2bab" class="lv lw iq kf b kg me kk mf ko mg ks mh kw mi la ma mb mc md bi translated">用<code class="fe lb lc ld le b">defineProperty</code>陷阱在代理(<code class="fe lb lc ld le b">proxy.name = 'Alice';</code>)上定义了一个新的属性。</li></ul><p id="63ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可能的陷阱有一长串，我只是在这里列出了最常见的。你可以在这里找到完整的名单。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="4dec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">代理让您控制如何访问字段，是否以及如何读取、修改、添加或删除字段，并且通常让您监视可以对对象做的一切。它们确实有助于在JavaScript中实现某种封装。例如，它们可以用于验证(将验证写入代理的<code class="fe lb lc ld le b">set</code>陷阱中)，在设置值之前更改值(例如，将<code class="fe lb lc ld le b">string</code>转换为<code class="fe lb lc ld le b">Date</code>)，或者跟踪和记录对象的更改。</p><h2 id="9758" class="ln lo iq bd mq mr ms dn mt mu mv dp mw ko mx my mz ks na nb nc kw nd ne nf ng bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="97c3" class="pw-post-body-paragraph kd ke iq kf b kg nh ki kj kk ni km kn ko nj kq kr ks nk ku kv kw nl ky kz la ij bi translated">我们已经推出了三种新的出版物！请关注我们的新出版物:<a class="ae kc" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="kf ir">AI in Plain English</strong></a><a class="ae kc" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="kf ir">UX in Plain English</strong></a><a class="ae kc" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="kf ir">Python in Plain English</strong></a><strong class="kf ir"/>——谢谢，继续学习！</p><p id="f935" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也一直有兴趣帮助推广高质量的内容。如果您有一篇文章想要提交给我们的任何出版物，请发送电子邮件至<a class="ae kc" href="mailto:submissions@plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">submissions @ plain English . io</strong></a><strong class="kf ir"/>，并附上您的Medium用户名，我们会将您添加为作者。另外，请让我们知道您想加入哪个/哪些出版物。</p></div></div>    
</body>
</html>