<html>
<head>
<title>Excluding Routes from Calling Express Middleware with Express-Unless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">排除使用Express调用Express中间件的路由-除非</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/excluding-routes-from-calling-express-middleware-with-express-unless-3389ab4117ef?source=collection_archive---------3-----------------------#2020-04-04">https://javascript.plainenglish.io/excluding-routes-from-calling-express-middleware-with-express-unless-3389ab4117ef?source=collection_archive---------3-----------------------#2020-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bea26b5eda41d33844203c041a2a320c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ImK5l7qvKGkKR8UZ"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@zachmiles?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zach Miles</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="eade" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在满足条件时有条件地跳过中间件，我们可以使用<code class="fe lb lc ld le b">express-unless</code>包。</p><p id="5b3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我们将看看如何使用它。</p><h1 id="8c91" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">装置</h1><p id="9bdc" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以通过运行以下命令来安装它:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="ecc3" class="mq lg iq le b gy mr ms l mt mu">npm i express-unless --save</span></pre><h1 id="14e6" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">使用</h1><p id="a6ce" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">安装后，我们可以分配由<code class="fe lb lc ld le b">express-unless</code>公开的<code class="fe lb lc ld le b">unless</code>函数，并将其分配给我们的中间件函数的<code class="fe lb lc ld le b">unless</code>属性。</p><p id="a01f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="f056" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const unless = require('express-unless');<br/> <br/>const static = express.static(__dirname + '/public');<br/>static.unless = unless;</span><span id="f858" class="mq lg iq le b gy mv ms l mt mu">const app = express();<br/>app.use(static.unless({ method: 'OPTIONS' }));<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="7f03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们将<code class="fe lb lc ld le b">static</code>的<code class="fe lb lc ld le b">unless</code>属性设置为<code class="fe lb lc ld le b">express-unless</code>包的<code class="fe lb lc ld le b">unless</code>函数。</p><p id="ff64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们写道:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="423d" class="mq lg iq le b gy mr ms l mt mu">app.use(static.unless({ method: 'OPTIONS' }));</span></pre><p id="f6b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">排除<code class="fe lb lc ld le b">static</code>路线运行选项请求。</p><p id="1de1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们正在编写自己的中间件，我们可以如下分配中间件函数的<code class="fe lb lc ld le b">unless</code>属性:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="5974" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const unless = require('express-unless');<br/> <br/>const static = express.static(__dirname + '/public');</span><span id="ce49" class="mq lg iq le b gy mv ms l mt mu">const logHostname = (req, res, next) =&gt;{<br/>  console.log(req.hostname);<br/>  next();<br/>}<br/>logHostname.unless = unless;</span><span id="fa30" class="mq lg iq le b gy mv ms l mt mu">const app = express();<br/>app.use(logHostname.unless({ method: 'OPTIONS' }));<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="5740" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们定义了<code class="fe lb lc ld le b">logHostman</code>中间件来记录主机名。然后我们将函数的<code class="fe lb lc ld le b">unless</code>属性设置为<code class="fe lb lc ld le b">express-unless</code>包中公开的<code class="fe lb lc ld le b">unless</code>函数。</p><h1 id="995c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">选择</h1><p id="cccd" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">在我们传入<code class="fe lb lc ld le b">unless</code>的对象中，我们可以传入以下选项:</p><ul class=""><li id="9d94" class="mw mx iq kf b kg kh kk kl ko my ks mz kw na la nb nc nd ne bi translated"><code class="fe lb lc ld le b">method</code> —这可以是一个字符串或字符串数组。如果请求方法匹配，那么中间件不会运行。</li><li id="fdf7" class="mw mx iq kf b kg nf kk ng ko nh ks ni kw nj la nb nc nd ne bi translated"><code class="fe lb lc ld le b">path</code> —这可以是字符串、正则表达式或字符串或正则表达式的数组。它也可以是URL和方法键值对的对象数组。如果请求路径或者路径和方法匹配，那么中间件不会运行。</li><li id="689f" class="mw mx iq kf b kg nf kk ng ko nh ks ni kw nj la nb nc nd ne bi translated"><code class="fe lb lc ld le b">ext</code> —这是一个字符串或字符串数组。如果路径以这些扩展结束，那么中间件就不会运行。</li><li id="8ae6" class="mw mx iq kf b kg nf kk ng ko nh ks ni kw nj la nb nc nd ne bi translated"><code class="fe lb lc ld le b">custom</code> —接受<code class="fe lb lc ld le b">req</code>并返回布尔值的函数。如果函数为给定的请求返回<code class="fe lb lc ld le b">true</code>，那么中间件将不会运行。</li><li id="c2e7" class="mw mx iq kf b kg nf kk ng ko nh ks ni kw nj la nb nc nd ne bi translated"><code class="fe lb lc ld le b">useOriginalUrl</code> —这应该是一个布尔值。默认为<code class="fe lb lc ld le b">true</code>。如果是<code class="fe lb lc ld le b">false</code>，则<code class="fe lb lc ld le b">path</code>将与<code class="fe lb lc ld le b">req.url</code>而不是<code class="fe lb lc ld le b">req.originalUrl</code>匹配。</li></ul><h1 id="1578" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">高级示例</h1><p id="942b" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">当我们有<code class="fe lb lc ld le b">jpg</code>、<code class="fe lb lc ld le b">html</code>、<code class="fe lb lc ld le b">css</code>或<code class="fe lb lc ld le b">.js</code>扩展时，我们可以排除调用<code class="fe lb lc ld le b">express.static</code>中间件，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="7c78" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const unless = require('express-unless');<br/>const url = require('url');<br/>const static = express.static(__dirname + '/public');</span><span id="d890" class="mq lg iq le b gy mv ms l mt mu">static.unless = unless;</span><span id="07b4" class="mq lg iq le b gy mv ms l mt mu">const app = express();<br/>app.use(static.unless((req) =&gt; {<br/>  const ext = url.parse(req.originalUrl).pathname.substr(-4);<br/>  return !['.jpg', '.html', '.css', '.js'].includes(ext);<br/>}));<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="869a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们检查了<code class="fe lb lc ld le b">req.originalUrl</code>属性的扩展，以查看请求是否在数组中列出了扩展，如果有，则跳过<code class="fe lb lc ld le b">static</code>中间件。</p><p id="2291" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以将路径和请求方法混合在一起，如下所示:</p><pre class="mi mj mk ml gt mm le mn mo aw mp bi"><span id="7335" class="mq lg iq le b gy mr ms l mt mu">const express = require('express');<br/>const unless = require('express-unless');</span><span id="f444" class="mq lg iq le b gy mv ms l mt mu">const static = express.static(__dirname + '/public');<br/>const logHostname = (req, res, next) =&gt; {<br/>  console.log(req.hostname);<br/>  next();<br/>}<br/>logHostname.unless = unless;<br/>const app = express();<br/>app.use(logHostname.unless({<br/>  path: [<br/>    '/index.html',<br/>    { url: '/', methods: ['OPTIONS', 'PUT'] }<br/>  ]<br/>}));<br/>app.listen(3000, () =&gt; console.log('server started'));</span></pre><p id="2644" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们使用PUT或OPTION请求方法转到<code class="fe lb lc ld le b">index.html</code>或<code class="fe lb lc ld le b">/</code>时，我们停止<code class="fe lb lc ld le b">logHostname</code>中间件的运行。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/d4081282130b03cf9a48cdda6a88a4a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LxDSUXerD3jsEfIC"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@diegojimenez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Diego Jimenez</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="ec6a" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="0036" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以通过使用<code class="fe lb lc ld le b">express-unless</code>包来阻止中间件在某些路由或请求方法上运行。</p><p id="ea94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用它，我们只需设置从包中暴露的<code class="fe lb lc ld le b">unless</code>函数，并将其设置为我们的中间件函数的<code class="fe lb lc ld le b">unless</code>属性。</p><p id="e570" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过检查URL和/或请求方法，使用各种条件来排除路由。</p><p id="c45c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">【JavaScript用简单英语写的一句话:我们总是对帮助推广优质内容感兴趣。如果你有一篇文章想用简单的英语提交给JavaScript，请用你的Medium用户名给我们发一封电子邮件到<a class="ae kc" href="mailto:submissions@javascriptinplainenglish.com" rel="noopener ugc nofollow" target="_blank">submissions@javascriptinplainenglish.com</a>，我们会把你添加为作者。</p></div></div>    
</body>
</html>