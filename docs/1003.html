<html>
<head>
<title>Using JavaScript and The Broadcast Channel API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用JavaScript和广播频道API</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/using-javascript-and-the-broadcast-channel-api-a3134739781d?source=collection_archive---------3-----------------------#2020-01-13">https://javascript.plainenglish.io/using-javascript-and-the-broadcast-channel-api-a3134739781d?source=collection_archive---------3-----------------------#2020-01-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cca9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对于选项卡之间的浏览器上下文通信</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1c6849d7d08e269a2a4ab20c51c89455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w7-hMjbKRy3L6rV09MR7zw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@kadircelep?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Kadir Celep</a> on <a class="ae kv" href="https://unsplash.com/s/photos/broadcast-twoers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3b84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi ls translated"><span class="l lt lu lv bm lw lx ly lz ma di">在</span> a <a class="ae kv" href="https://medium.com/javascript-in-plain-english/javascript-and-window-postmessage-a60c8f6adea9" rel="noopener">上一篇文章</a>中，我们讨论了使用window.postMessage()的跨源通信。</p><p id="ff86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我想让我们再次探索postMessage()，但是它适用于相同的<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Glossary/Browsing_context" rel="noopener ugc nofollow" target="_blank">浏览上下文</a>或相同的来源中的通信。</p><p id="8778" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是使用<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" rel="noopener ugc nofollow" target="_blank">广播频道API </a>和<strong class="ky ir"> channel.postMessage() </strong>来执行的。</p><blockquote class="mb"><p id="5895" class="mc md iq bd me mf mg mh mi mj mk lr dk translated">它可用于检测同一站点原始环境或浏览上下文中其他选项卡中的用户操作。</p></blockquote><blockquote class="ml mm mn"><p id="5571" class="kw kx mo ky b kz mp jr lb lc mq ju le mr ms lh li mt mu ll lm mv mw lp lq lr ij bi translated">更具体地说，这允许窗口、标签、iframes、web workers和服务worker之间的通信。发布到给定通道的消息被传递到该通道的所有监听器。</p></blockquote><p id="6f73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将关注窗口/标签。</p><h2 id="2221" class="mx my iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">句法</h2><p id="2e17" class="pw-post-body-paragraph kw kx iq ky b kz nq jr lb lc nr ju le lf ns lh li lj nt ll lm ln nu lp lq lr ij bi translated">使用广播频道包括三个部分。</p><ul class=""><li id="631e" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated"><strong class="ky ir">创建</strong>广播频道对象。</li></ul><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="83f1" class="mx my iq of b gy oj ok l ol om">const bc = new window.BroadcastChannel('channel_name');</span></pre><ul class=""><li id="2775" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">使用<strong class="ky ir"> postMessage() </strong>发布要广播的消息。</li></ul><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="b53a" class="mx my iq of b gy oj ok l ol om">bc.postMessage('message_data');</span></pre><p id="6f87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mo">与我们的跨源postMessage一样，</em> <strong class="ky ir"> <em class="mo"> message_data是使用</em> <a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm" rel="noopener ugc nofollow" target="_blank"> <em class="mo">结构化克隆算法</em> </a> <em class="mo">序列化</em> </strong> <em class="mo">，因此正在广播的数据可能相当复杂。但是它不允许发送函数。</em></p><ul class=""><li id="07b8" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">使用<strong class="ky ir"> onmessage </strong>事件处理程序接收消息。</li></ul><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="139a" class="mx my iq of b gy oj ok l ol om">bc.onmessage =(message)=&gt; { do_something; }</span></pre><p id="93ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际消息在<strong class="ky ir">消息数据</strong>中。</p><blockquote class="mb"><p id="4409" class="mc md iq bd me mf mg mh mi mj mk lr dk translated">所有选择对消息进行操作的窗口必须订阅相同的频道。</p></blockquote><p id="7fbb" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf ms lh li lj mu ll lm ln mw lp lq lr ij bi translated"><strong class="ky ir"> <em class="mo">注意</em> </strong> <em class="mo">这一条消息不会广播给自己。因此，如果在启动该通道上的postMessage()的页面上有onmessage事件侦听器，则onmessage事件不会触发。但是，如果postMessage()是从另一个页面启动的，它将被触发。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/dd64ef41340ac687609146db038a39b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*luCZz1tSO86icl_DK2vMuA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">broadcast flow</figcaption></figure><h2 id="c84d" class="mx my iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">我们的场景</h2><blockquote class="ml mm mn"><p id="5072" class="kw kx mo ky b kz la jr lb lc ld ju le mr lg lh li mt lk ll lm mv lo lp lq lr ij bi translated">对于我们的演示，我们的场景将是用户打开了我们的应用程序的一个或多个实例，每个实例出现在不同的选项卡上。</p></blockquote><ol class=""><li id="ef72" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oo ob oc od bi translated">我们将创建一个网页(我们的应用程序),然后在浏览器中复制它(尽可能多次。)</li><li id="2637" class="nv nw iq ky b kz op lc oq lf or lj os ln ot lr oo ob oc od bi translated">当点击“开始操作”按钮时，一条消息将显示在当前页面(通过函数setMsg())上，以及具有该频道的<strong class="ky ir"> onmessage </strong>处理程序的每个页面(选项卡)上。</li></ol><p id="2f2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mo">注意:将使用一个随机数来生成两条消息中的一条。</em></p><p id="6c72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建以下页面。然后我们会<em class="mo">测试它</em>，然后<em class="mo">分解它</em>。</p><p id="2345" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">Index.html</strong></p><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="ad84" class="mx my iq of b gy oj ok l ol om">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;My Great Application&lt;/title&gt;<br/> &lt;meta charset="utf-8" /&gt;<br/>    &lt;script&gt;<br/>        // Set up broadcast channel<br/>        <strong class="of ir">const bc=new window.BroadcastChannel('sample_channel');</strong><br/>        <br/>        function doAction(){<br/>            // Action that will be done on current and other pages<br/>            // The message will be broadcast to all tabs<br/>            // it will also be displayed on the current<br/>            // page using a setMsg function since the<br/>            // source of the postMessage does not receieve<br/>            // the message.</span><span id="de44" class="mx my iq of b gy ou ok l ol om">// Random action: answer or call<br/>            let ran=Math.floor(Math.random() * 2);<br/>          <br/>            let msg={};</span><span id="552b" class="mx my iq of b gy ou ok l ol om">if (Number(ran)===0){<br/>                msg={action: 'answer',<br/>                phone: '555-1212'<br/>                }<br/>            }else{<br/>                msg={action: 'call',<br/>                phone: '444-2233'<br/>                }<br/>            }<br/>           <br/>            // broadcast message to others tabs<br/>            <strong class="of ir">bc.postMessage(msg);</strong><br/>            <br/>            // show message on this page since <br/>            // it will not be received from <br/>            // page that initiated postMessage<br/>            setMsg(msg);<br/>        }<br/>        <br/>        // Handler for accepting messages that are broadcast<br/>        <strong class="of ir">bc.onmessage=(message)=&gt;{<br/>        <br/>            let txt = document.querySelector('#txtmsg');<br/>            if (message.data.action==='answer'){<br/>               txt.value=`Answer ${message.data.phone}`;<br/>            }else{<br/>                txt.value=`Call ${message.data.phone}`;<br/>            }<br/>           <br/>        }</strong></span><span id="69fe" class="mx my iq of b gy ou ok l ol om">// function to handle messages for page that<br/>        // initiated postMessage<br/>        function setMsg(msg){<br/>            let txt = document.querySelector('#txtmsg');<br/>            if (msg.action==='answer'){<br/>               txt.value=`Answer ${msg.phone}`;<br/>            }else{<br/>                txt.value=`Call ${msg.phone}`;<br/>            }<br/>        }<br/>        <br/>        &lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;form&gt;<br/>        &lt;fieldset&gt;<br/>            &lt;input type='button' id='btnstart' value='Start Action' onclick='doAction();' /&gt;<br/>           Message: &lt;input type='text' id='txtmsg' /&gt; <br/>        &lt;/fieldset&gt;<br/>    &lt;/form&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><h2 id="56ae" class="mx my iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">测试它</h2><p id="982f" class="pw-post-body-paragraph kw kx iq ky b kz nq jr lb lc nr ju le lf ns lh li lj nt ll lm ln nu lp lq lr ij bi translated">用下列方法测试。</p><ol class=""><li id="66c2" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oo ob oc od bi translated">打开Index.html，点击“开始行动”。您应该会看到两条随机消息中的一条。关闭选项卡。</li><li id="07e8" class="nv nw iq ky b kz op lc oq lf or lj os ln ot lr oo ob oc od bi translated">打开Index.html，复制标签。单击任一页面上的“开始行动”。消息应该出现在两个页面上。您可以从任何一个选项卡上，根据需要多次单击“开始操作”,以验证消息是否已广播。完成后关闭选项卡。</li><li id="ccf6" class="nv nw iq ky b kz op lc oq lf or lj os ln ot lr oo ob oc od bi translated">打开Index.html，根据需要多次复制该选项卡。点击任意页面上的“开始行动”。该消息应该出现在所有页面上。根据需要重复。</li></ol><h2 id="a0f1" class="mx my iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">它是如何工作的</h2><ol class=""><li id="7c64" class="nv nw iq ky b kz nq lc nr lf ov lj ow ln ox lr oo ob oc od bi translated">广播频道bc建立在每个页面上(在我们的例子中是一个页面。该页面将被复制。)</li></ol><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="e381" class="mx my iq of b gy oj ok l ol om">// Set up broadcast channel<br/>const bc=new window.BroadcastChannel('sample_channel');</span></pre><p id="5d6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="mo">这需要在每一个要广播或接收消息的页面上</em> </strong> <em class="mo">。</em></p><p id="3bd9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.要接收消息的每个页面也应该有<strong class="ky ir"> bc </strong>。<strong class="ky ir">on message</strong>handler(<strong class="ky ir"><em class="mo">BC</em></strong><em class="mo">为广播频道的名称。你会看到onmessage处理程序。它的工作是将消息放入文本框。它接收“消息”参数中的广播消息。信息在<strong class="ky ir">消息中。</strong></em></p><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="9bf2" class="mx my iq of b gy oj ok l ol om">// Handler for accepting messages that are broadcast<br/>         bc.onmessage=(message)=&gt;{<br/>         <br/>             let txt = document.querySelector('#txtmsg');<br/>             if (message.data.action==='answer'){<br/>                txt.value=`Answer ${message.data.phone}`;<br/>             }else{<br/>                 txt.value=`Call ${message.data.phone}`;<br/>             }<br/>            <br/>        }</span></pre><p id="f460" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在我们的示例中，我们有一个<strong class="ky ir"> doAction() </strong>函数，由“Start Action”按钮调用，该按钮通过<strong class="ky ir"> postMessage() </strong>方法向浏览上下文中的所有其他页面进行广播——相同的来源。</p><p id="dea5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于这个页面的onmessage处理程序不会被调用(它是postMessage的来源)，我们还有一个函数setMsg()，它处理消息发起页面的消息。</p><p id="e3d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有其他页面将依赖于它们附加到广播频道的onmessage处理程序。</p><pre class="kg kh ki kj gt oe of og oh aw oi bi"><span id="8265" class="mx my iq of b gy oj ok l ol om">function doAction(){<br/>            // Action that will be done on current and other pages<br/>            // The message will be broadcast to all tabs<br/>            // it will also be displayed on the current<br/>            // page using a setMsg function since the<br/>            // source of the postMessage does not receieve<br/>            // the message.</span><span id="fb9a" class="mx my iq of b gy ou ok l ol om">// Random action: answer or call<br/>            let ran=Math.floor(Math.random() * 2);<br/>          <br/>            let msg={};</span><span id="e7fb" class="mx my iq of b gy ou ok l ol om">if (Number(ran)===0){<br/>                msg={action: 'answer',<br/>                phone: '555-1212'<br/>                }<br/>            }else{<br/>                msg={action: 'call',<br/>                phone: '444-2233'<br/>                }<br/>            }<br/>           <br/>            // broadcast message to others tabs<br/>           <strong class="of ir"> bc.postMessage(msg);</strong><br/>            <br/>            // show message on this page since <br/>            // it will not be received from <br/>            // page that initiated postMessage<br/>            <strong class="of ir">setMsg(msg)</strong>;// For the initiating page<br/>        }</span></pre><h2 id="d46b" class="mx my iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">测试说明:</h2><blockquote class="ml mm mn"><p id="190a" class="kw kx mo ky b kz la jr lb lc ld ju le mr lg lh li mt lk ll lm mv lo lp lq lr ij bi translated">要验证其他选项卡是否由onmessage处理程序而不是setMsg()设置消息，您可能需要注释掉setMsg()，打开多个选项卡并单击“开始操作”。</p><p id="378f" class="kw kx mo ky b kz la jr lb lc ld ju le mr lg lh li mt lk ll lm mv lo lp lq lr ij bi translated">初始页面没有消息，但所有其他页面都有！</p></blockquote><h1 id="7455" class="oy my iq bd mz oz pa pb nc pc pd pe nf jw pf jx ni jz pg ka nl kc ph kd no pi bi translated">结论</h1><p id="4549" class="pw-post-body-paragraph kw kx iq ky b kz nq jr lb lc nr ju le lf ns lh li lj nt ll lm ln nu lp lq lr ij bi translated">现在你知道了。如果希望浏览上下文中的每个页面共享信息，只要每个页面都有广播通道和处理程序，就可以使用postMessage()广播到每个页面。</p><p id="582c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">感谢您的阅读和快乐编码！</strong></p><p id="3b74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Medium上阅读所有你想要的文章，并通过成为Medium会员来帮助我继续写作，每月只需5美元。</p><div class="pj pk gp gr pl pm"><a href="https://bobtomlin-70659.medium.com/membership" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd ir gy z fp pr fr fs ps fu fw ip bi translated">通过我的推荐链接加入灵媒——重力井(罗伯·汤姆林)</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">bobtomlin-70659.medium.com</p></div></div><div class="pv l"><div class="pw l px py pz pv qa kp pm"/></div></div></a></div><p id="f5f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你也可以享受。</p><div class="pj pk gp gr pl pm"><a href="https://medium.com/javascript-in-plain-english/javascript-and-window-postmessage-a60c8f6adea9" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd ir gy z fp pr fr fs ps fu fw ip bi translated">使用JavaScript和window.postMessage()</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">安全跨域通信</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">medium.com</p></div></div><div class="pv l"><div class="qb l px py pz pv qa kp pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://medium.com/javascript-in-plain-english/using-javascript-and-the-broadcast-channel-api-a3134739781d" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd ir gy z fp pr fr fs ps fu fw ip bi translated">使用JavaScript和广播频道API</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">对于选项卡之间的浏览器上下文通信</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">medium.com</p></div></div><div class="pv l"><div class="qc l px py pz pv qa kp pm"/></div></div></a></div><div class="pj pk gp gr pl pm"><a href="https://medium.com/javascript-in-plain-english/closing-a-window-with-javascript-beeec56344bb" rel="noopener follow" target="_blank"><div class="pn ab fo"><div class="po ab pp cl cj pq"><h2 class="bd ir gy z fp pr fr fs ps fu fw ip bi translated">用JavaScript关闭窗口</h2><div class="pt l"><h3 class="bd b gy z fp pr fr fs ps fu fw dk translated">简而言之，什么可行，什么不可行</h3></div><div class="pu l"><p class="bd b dl z fp pr fr fs ps fu fw dk translated">medium.com</p></div></div><div class="pv l"><div class="qd l px py pz pv qa kp pm"/></div></div></a></div></div></div>    
</body>
</html>