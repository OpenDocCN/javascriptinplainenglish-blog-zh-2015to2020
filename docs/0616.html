<html>
<head>
<title>Creating a Dev.to clone with React, Node, TypeScript, GraphQL and Apollo (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React、Node、TypeScript、GraphQL和Apollo创建要克隆的开发工具(第3部分)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-graphql-orm-environment-part-3-5dd9fdfbb312?source=collection_archive---------3-----------------------#2019-11-16">https://javascript.plainenglish.io/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-graphql-orm-environment-part-3-5dd9fdfbb312?source=collection_archive---------3-----------------------#2019-11-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="d7ba" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">在数据库中设置关系</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/812aca8e193b5bda7b23dd2efa393f71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cv77fst2cXuLhUDmlq7WWg.png"/></div></div></figure><p id="9198" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你好，社区，今天我写了这个系列文章的3个部分，其中我试图用最少的功能克隆dev.to。这将是一个原型，其中用户可以注册/登录，创建帖子和其他功能。</p><blockquote class="lk ll lm"><p id="30fb" class="ko kp ln kq b kr ks jo kt ku kv jr kw lo ky kz la lp lc ld le lq lg lh li lj ig bi translated">我这样做只是为了学习。<br/>如果你没有参观过<a class="ae lr" href="https://medium.com/@vinodc45/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-graphql-orm-environment-part-1-cf83f65e795d" rel="noopener">Part-1</a>&amp;<a class="ae lr" href="https://medium.com/@vinodc45/dev-to-clone-using-reactjs-nodejs-via-typescript-apollo-using-refreshtoken-authentication-99fa89d567e9" rel="noopener">Part-2</a>，请先了解这些，以便更清楚地了解这一部。</p></blockquote><p id="e49e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">代码回购:<a class="ae lr" href="https://github.com/vinodchauhan7/dev.to-clone/tree/master" rel="noopener ugc nofollow" target="_blank"> GitHub链接</a></p><p id="994d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">你好。朋友们，在这篇文章中，我可以用令牌刷新功能完成许多事情，例如<strong class="kq io">登录/注册</strong>功能。也能够使用<strong class="kq io"> Apollo状态管理</strong>维护缓存，最后登录的用户可以发表文章，查看其他用户的文章和个人资料。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ls"><img src="../Images/dfb7596da2e6e0d1047488e7e078b82d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7K2Hx3yAj9Jw9cO9kFbsg.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk">Login and register</figcaption></figure><p id="730f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">注册</p><p id="c49f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当用户登录时，刷新令牌保存在用户浏览器cookies中。为了用户顺利使用应用程序，我们需要保持其认证，即使用户重新加载页面或如果其令牌过期。在令牌过期的情况下，我们已经使用Apollo-link-token-Refresh 模块处理了使用<strong class="kq io"> RefreshToken </strong>和<strong class="kq io">的功能。</strong></p><pre class="kd ke kf kg gt lx ly lz ma aw mb bi"><span id="826f" class="mc md in ly b gy me mf l mg mh">//Getting access Token and passing it in request headers<br/>const requestLink = new ApolloLink(<br/>  (operation, forward) =&gt;<br/>    new Observable(observer =&gt; {<br/>      let handle: any;<br/>      Promise.resolve(operation)<br/>        .then(operation =&gt; {<br/>          const accessToken = getAccessToken();<br/>          if (accessToken) {<br/>            operation.setContext({<br/>              headers: {<br/>                authorization: `bearer ${accessToken}`<br/>              }<br/>            });<br/>          } //accessToken is defined<br/>        }) //then operation ends here<br/>        .then(() =&gt; {<br/>          handle = forward(operation).subscribe({<br/>            next: observer.next.bind(observer),<br/>            error: observer.error.bind(observer),<br/>            complete: observer.complete.bind(observer)<br/>          }); //handle ends here<br/>        })<br/>        .catch(observer.error.bind(observer));<br/><br/>      return () =&gt; {<br/>        if (handle) handle.unsubscribe();<br/>      };<br/>    })<br/>);<br/><br/>const client = new ApolloClient({<br/>  link: ApolloLink.from([<br/>    new TokenRefreshLink({<br/>      accessTokenField: "accessToken",<br/>      isTokenValidOrUndefined: () =&gt; {<br/>        const token = getAccessToken();<br/><br/>        if (!token) {<br/>          return true;<br/>        }<br/><br/>        try {<br/>          const { exp } = jwtDecode(token);<br/>          if (Date.now() &gt;= exp * 1000) {<br/>            return false;<br/>          } else {<br/>            return true;<br/>          }<br/>        } catch (err) {<br/>          console.log(err);<br/>          return false;<br/>        }<br/>      },<br/>      fetchAccessToken: () =&gt; {<br/>        return fetch("http://localhost:4000/refresh_token", {<br/>          method: "POST",<br/>          credentials: "include"<br/>        });<br/>      },<br/>      handleFetch: accessToken =&gt; {<br/>        setAccessToken(accessToken);<br/>      },<br/>      handleError: err =&gt; {<br/>        console.warn("Your refresh token is invalid. Try to relogin");<br/>        console.error(err);<br/>      }<br/>    }),<br/>    onError(() =&gt; {}),<br/>    requestLink,<br/>    new HttpLink({<br/>      uri: "http://localhost:4000/graphql",<br/>      credentials: "include"<br/>    }) //new HttpLink ends here<br/>  ]),<br/>  cache<br/>});</span></pre><h1 id="b1d3" class="mi md in bd mj mk ml mm mn mo mp mq mr jt ms ju mt jw mu jx mv jz mw ka mx my bi translated">阿波罗缓存</h1><p id="ed87" class="pw-post-body-paragraph ko kp in kq b kr mz jo kt ku na jr kw kx nb kz la lb nc ld le lf nd lh li lj ig bi translated">当用户登录时，我们正在为<strong class="kq io"> MeQuery </strong>更新缓存，这样就可以在整个应用程序中使用它来知道谁当前登录，而不需要命中实际的graphql查询。</p><pre class="kd ke kf kg gt lx ly lz ma aw mb bi"><span id="3f5a" class="mc md in ly b gy me mf l mg mh">const LoginComponentUser = withFormik&lt;MyFormProps, FormValues&gt;({<br/>    mapPropsToValues: props =&gt; ({<br/>      email: props.initialEmail || "",<br/>      password: props.initialPassword || ""<br/>    }),<br/>    validationSchema: Yup.object().shape({<br/>      email: Yup.string()<br/>        .email("Email is not valid")<br/>        .required("Email is required"),<br/>      password: Yup.string().required("Password is required")<br/>    }),<br/>    async handleSubmit({ email, password }: FormValues) {<br/>      console.log(email, password);<br/><br/>      const response = await login({<br/>        variables: {<br/>          data: {<br/>            email,<br/>            password<br/>          }<br/>        },<br/>        update: (store, { data }) =&gt; {<br/>          //updating cache so that it will not hit again and again<br/>          if (!data) {<br/>            return null;<br/>          }<br/>          store.writeQuery&lt;MeQuery&gt;({<br/>            query: MeDocument,<br/>            data: {<br/>              __typename: "Query",<br/>              me: data.login.user<br/>            }<br/>          });<br/>        }<br/>      });<br/><br/>      console.log(response);<br/>      if (response &amp;&amp; response.data) {<br/>        setAccessToken(response.data.login.accessToken);<br/>      }<br/><br/>      console.log(getAccessToken());<br/>      window.location.replace("http://localhost:3000/");<br/>    }<br/>  })(LoginForm);</span></pre><h1 id="0032" class="mi md in bd mj mk ml mm mn mo mp mq mr jt ms ju mt jw mu jx mv jz mw ka mx my bi translated">样式组件</h1><p id="7a8c" class="pw-post-body-paragraph ko kp in kq b kr mz jo kt ku na jr kw kx nb kz la lb nc ld le lf nd lh li lj ig bi translated">我还为初学者添加了一些样式化组件的用法，展示如何在JS中使用css。</p><pre class="kd ke kf kg gt lx ly lz ma aw mb bi"><span id="608d" class="mc md in ly b gy me mf l mg mh">const WritePost = styled.a`<br/>    width: 118px;<br/>    display: block;<br/>    margin-top: 10px;<br/>    padding: 3px;<br/>    text-align: center;<br/>    font-weight: bold;<br/>    border-radius: 3px;<br/>    border: 2px solid #0a0a0a;<br/>    color: #0a0a0a;<br/>    background: #66e2d5;<br/>    font-size: 11px;<br/>    text-decoration: none !important;<br/>    font-stretch: condensed;<br/>    &amp;:hover {<br/>      color: #0b0b0b;<br/>      background: #66e2e5;<br/>    }<br/>  `;<br/><br/>  const ShowSvg = styled.div`<br/>    margin-top: 10px;<br/>  `;</span></pre><h1 id="b660" class="mi md in bd mj mk ml mm mn mo mp mq mr jt ms ju mt jw mu jx mv jz mw ka mx my bi translated">一对多关系</h1><p id="602e" class="pw-post-body-paragraph ko kp in kq b kr mz jo kt ku na jr kw kx nb kz la lb nc ld le lf nd lh li lj ig bi translated">我还展示了模式之间的关系，通过展示[user-post]关系来展示我们如何在应用程序中使用<strong class="kq io"> Graphql </strong>来实现这个<strong class="kq io"> TypeORM </strong>特性。</p><pre class="kd ke kf kg gt lx ly lz ma aw mb bi"><span id="8f9c" class="mc md in ly b gy me mf l mg mh">@Query(() =&gt; [Post])<br/>  @UseMiddleware(isAuth)<br/>  async getAllPostById(@Arg("userId") userId: number): Promise&lt;Post[]&gt; {<br/>    const post = await Post.find({<br/>      where: { user: { id: userId } },<br/>      relations: ["user"]<br/>    });<br/>    console.log(JSON.stringify(post, null, 2));<br/>    return post;<br/>  }</span></pre><h1 id="fca5" class="mi md in bd mj mk ml mm mn mo mp mq mr jt ms ju mt jw mu jx mv jz mw ka mx my bi translated">我没有使前端类似于开发。充分，因为这将需要时间来匹配所有的东西和所有的功能。</h1><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/ac0da7f5f3bfecc3cfe4e7217be5d101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PIlpORIybvF1wIjZij9pTA.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/2e848ba1832dc7d2dbae2ca2c68f42c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yP8f5nCI3Vg5FGdLsLlT7g.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/87140b3ea3e26174684fb4888b996c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K--nBCUBGfA3yMlFPFzeDA.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/c9cea76dccc5d613fbeb0045ef11cff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9XYtrQplhmQy7Omw_OwEBw.png"/></div></div></figure><p id="c666" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">本系列文章的目的是让初学者或中级react开发人员熟悉令牌刷新、apollo和typeorm特性。</p><p id="c8d4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我会带着新的功能和文章回来，直到那时再见伙计们..</p></div></div>    
</body>
</html>