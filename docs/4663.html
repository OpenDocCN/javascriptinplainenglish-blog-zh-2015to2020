<html>
<head>
<title>Creating a Push Notification System with Service Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用服务人员创建推送通知系统</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-a-push-notification-system-with-service-workers-e3e1813f2b5?source=collection_archive---------5-----------------------#2020-12-29">https://javascript.plainenglish.io/creating-a-push-notification-system-with-service-workers-e3e1813f2b5?source=collection_archive---------5-----------------------#2020-12-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="3e6d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我最近用NodeJS开了一个新的博客,在那里我很快面临一个难题:当一篇新文章发表时，如何通知用户。最重要的是，<strong class="jm io">我想在不依赖第三方服务的情况下完成这一切。我认为这是一个使用网络通知的好机会。</strong></p><p id="9f15" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">只有当用户打开网站时，原生浏览器通知才真正起作用。我希望当有新的事情发生时，无论网站是否开放，所有用户都能收到来自服务器的通知。</p><p id="3a60" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是如果用户关闭了页面，我们如何向他们返回通知呢？<strong class="jm io">要做到这一点，我们必须使用服务人员</strong>，并且我们需要存储我们用户的详细信息。在这篇文章中，我将介绍如何做这些事情，并最终创建您自己的推送通知系统。</p><h1 id="5987" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">服务人员快速入门</h1><p id="0e43" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">出于我们的目的，一个服务人员可以归结为一个文件，它可以<strong class="jm io">从服务器捕获推送事件，即使网站关闭了</strong>。这意味着我们可以在页面关闭但浏览器打开时运行Javascript。这有很多用途(例如，预加载资源，使网页加载更快)，但重要的是，我们可以将它用作发送通知的设备。</p><p id="404e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用户必须同意允许这整个过程发生，所以我们必须请求这种访问。对我们来说，这个请求过程看起来有点像这样:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/410112f1a50f209dd74ae9d9862ca269.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_hhZfONr0SE59_MIWJY76Q.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk">A flow of how we request access from the user.</figcaption></figure><h1 id="e43a" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">0.MongoDB</h1><p id="a4ae" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">由于本文使用mongoDB，请确保您已经通过此处 的 <a class="ae ki" href="https://docs.mongodb.com/manual/installation/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">说明安装了它，然后再继续。如果你有另一个存储系统，那么不用担心，只要确保你相应地调整型号和NPM软件包。</strong></a></p><h1 id="050e" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">1.请求乏味的密钥</h1><p id="88f9" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">Vapid密钥是我们用来验证只有我们使用的web服务器才能发送通知的<strong class="jm io">。有其他机制可以做到这一点，但是让我们把重点放在乏味的键上，因为它是最直接的。我们要做的第一件事是安装我们将在本教程中使用的主要JS包。为此，请在终端中运行以下命令:</strong></p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="7def" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的第二行应该输出一个私钥和一个公钥。<strong class="jm io">这些是你的乏味的键</strong>，我们将在接下来的几个步骤中使用它们。</p><h1 id="0834" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">2.客户端“点击”事件</h1><p id="7ce8" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">下一步是在客户端设置一段代码，它向服务器发送请求。在我们的服务器上，我们将创建一个/subscribe路由来处理所有订阅。现在，让我们看看客户端。<strong class="jm io">注意，我们需要在顶部插入我们乏味的公钥。</strong></p><p id="a13c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当用户点击“订阅”按钮时，我们只做三件事:</p><ol class=""><li id="b74f" class="me mf in jm b jn jo jr js jv mg jz mh kd mi kh mj mk ml mm bi translated">我们<strong class="jm io">登记</strong>为劳务人员。</li><li id="2675" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">我们使用<strong class="jm io">push manager</strong>Javascript API为用户创建一个新的订阅。使用此方法为每个用户生成一个唯一的订阅对象。</li><li id="8acd" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">我们<strong class="jm io">将订阅</strong>发送到我们的服务器。</li></ol><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="c771" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">应用程序URL需要转换成特定的形式，这就是第二个功能正在帮助我们做的。除此之外，当用户单击subscribe按钮时，我们将向服务器(to /subscribe)发送一个请求，在那里我们将处理该请求。</p><p id="5036" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在第4行，我们引用了一个<strong class="jm io"> worker.js </strong>文件。<strong class="jm io">这是我们的服务人员。</strong>我们也需要创建这个文件——我不会在这里列出，但是它可以在GitHub Repo中找到。大约有8行，它处理来自我们服务器的传入消息，并将它们作为web通知输出。</p><h1 id="8d5f" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">3.服务器端“商店订阅”</h1><p id="08dc" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">我在mongoDB中为订阅创建了一个模型。这可以通过GitHub Repo访问，并且相对简单。让我们看看/subscribe路线。我们在这里做一些事情:</p><ol class=""><li id="7315" class="me mf in jm b jn jo jr js jv mg jz mh kd mi kh mj mk ml mm bi translated">我们<strong class="jm io">设置</strong>vapp键。</li><li id="f7f9" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">我们对订阅对象进行<strong class="jm io">散列</strong>以用作我们的唯一密钥。</li><li id="690d" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">我们<strong class="jm io">检查</strong>数据库中是否已经存在该订阅哈希。</li><li id="6c62" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">如果数据库中不存在<strong class="jm io">订阅</strong>文档，则在数据库中创建该文档。</li><li id="ffb6" class="me mf in jm b jn mn jr mo jv mp jz mq kd mr kh mj mk ml mm bi translated">否则我们<strong class="jm io">会以适当的信息回应</strong>。</li></ol><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="d527" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">太好了，现在我们有了订阅路线。我们所有的订阅都存储在MongoDB数据库中，我们可以在需要的时候向它们发送通知。现在让我们试着发送一些东西。</p><h1 id="e551" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">4.发送通知</h1><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ms"><img src="../Images/693ccf88aea09cdf10fc5e0964ee0b06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xgH17fOTY5RZYnUHFsJ4Lg.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk">Remember, since we loaded the server worker, our server can now interact with the user’s browser, even when the page is closed.</figcaption></figure><p id="d09d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们已经收集了我们的订户，我们想向他们发送一些东西。我们所要做的就是遍历它们，并为每个人生成一个通知:</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mc md l"/></div></figure><h1 id="8787" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">5.添加安全性</h1><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mt"><img src="../Images/6f2c5c7597529e2edaf82631e89789e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D7gepG3MU-L3MK-rIypbvg.jpeg"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk">Presumably what you’re doing right now.</figcaption></figure><p id="6a12" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您正在运行这个程序，重要的是添加适合您的设置的正确的安全性。例如，您可能想要使用<em class="mu">快递费率限制</em>包来防止有人滥发订阅路由请求。</p><p id="2afb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">同样，当您发送通知时，您要确保服务器上有安全检查，至少要有用户名和密码。</p><p id="9b5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您以API的形式运行通知服务，那么您可能需要遵循<a class="ae ki" href="https://medium.com/apis-and-digital-transformation/best-practices-for-building-secure-apis-2b4eb8071d41" rel="noopener">保护API的指南</a>。我们不想发生的是有人恶意发送通知给我们所有的订户。</p><p id="24d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本教程集中于<em class="mu">如何</em>创建推送通知服务，但是设置您自己的用户认证系统将在其他教程中得到更好的说明。</p><h1 id="7d66" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">结论</h1><p id="4610" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">我希望这不仅能让你了解如何建立一个通知系统，还能让你了解服务人员的力量。</p><p id="c808" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://github.com/smpnjn/web-push-notifications" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">在这里获取GitHub Repo的完整代码。</strong> </a></p><p id="be70" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://twitter.com/smpnjn" rel="noopener ugc nofollow" target="_blank"> <em class="mu">关注更多</em> </a> <em class="mu">。</em></p></div></div>    
</body>
</html>