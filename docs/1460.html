<html>
<head>
<title>Cancel JavaScript async tasks with AbortController</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AbortController取消JavaScript异步任务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/canceling-javascript-async-tasks-with-abortcontroller-acda9f67f7e7?source=collection_archive---------2-----------------------#2020-03-18">https://javascript.plainenglish.io/canceling-javascript-async-tasks-with-abortcontroller-acda9f67f7e7?source=collection_archive---------2-----------------------#2020-03-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4c56" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何将AbortController用于Fetch或其他异步任务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d17d6f45443de88c2ab85e4770ada9e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3tPBM2J_98gwVBfiaPDnHw.jpeg"/></div></div></figure><p id="4e27" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们在JavaScript中使用Fetch或其他异步函数时，有时我们可能想要取消它们。JavaScript提供了中止异步任务的不同方式。在本文中，我们将了解如何应用AbortController对象来中止获取请求和其他异步任务。</p><h2 id="3008" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">语法:</h2><p id="ad15" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated"><strong class="kt ir"> new AbortController() </strong> <br/>返回一个新的控制器，其信号设置为一个新创建的AbortSignal对象。</p><p id="e279" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">控制器。信号</strong>T5返回与该对象关联的AbortSignal对象。</p><p id="6287" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">控制器。abort() </strong></p><h2 id="81b7" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">中止异步任务</h2><p id="52fa" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">AbortController是中止异步任务的标准对象，我们可以用它来停止异步任务。在下一个例子中，假设我们有一个需要很长时间处理的异步函数。在这种情况下，generateReport函数需要20秒才能完成，但是如果您愿意，您可以随时终止执行，调用AbortController.abort()方法。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="4d76" class="ln lo iq mm b gy mq mr l ms mt">let acontroller = new AbortController();<br/>let signal = acontroller.signal;</span><span id="7e9c" class="ln lo iq mm b gy mu mr l ms mt">function generateReport(signal) {<br/>  return new Promise((resolve, reject)=&gt; {<br/>   <br/>   const error = new DOMException(<br/>                  'aborted!',<br/>                  'AbortError');//[3]</span><span id="45f6" class="ln lo iq mm b gy mu mr l ms mt">if (signal.aborted){<br/>      return reject(error);//[2]<br/>   }</span><span id="e612" class="ln lo iq mm b gy mu mr l ms mt">const timeout = setTimeout(() =&gt; {<br/>      resolve('you report!'); <br/>    },20000);</span><span id="8d10" class="ln lo iq mm b gy mu mr l ms mt">signal.addEventListener('abort',() =&gt; {<br/>      clearTimeout(timeout);<br/>      reject(error);<br/>    });</span><span id="6765" class="ln lo iq mm b gy mu mr l ms mt">});<br/>}</span><span id="1ee7" class="ln lo iq mm b gy mu mr l ms mt">generateReport(signal).then((report)=&gt;{<br/>  console.log( report );<br/>}).catch( e =&gt; console.log(e));</span><span id="e6bb" class="ln lo iq mm b gy mu mr l ms mt">acontroller.abort();//[1]<br/>//aborted!</span></pre><p id="2117" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">解释:</p><p id="d7f4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当调用acontroller.abort() [1]时，generateReport()函数拒绝[2]承诺，并给出适当的错误[3]，而不做任何进一步的操作。</p><h2 id="7276" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">中止提取请求</h2><p id="33b0" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们可以使用AbortController中止Fetch请求，因为Fetch具有与AbortController的内置集成:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="3e5e" class="ln lo iq mm b gy mq mr l ms mt">const url = 'https://server/api/d1';</span><span id="aa26" class="ln lo iq mm b gy mu mr l ms mt">let aController = new AbortController();</span><span id="3ed6" class="ln lo iq mm b gy mu mr l ms mt">let signal = aController.signal;</span><span id="1001" class="ln lo iq mm b gy mu mr l ms mt">const response = <br/>    await fetch(url,{signal});</span><span id="4e9a" class="ln lo iq mm b gy mu mr l ms mt">const data = await response.json();</span><span id="90df" class="ln lo iq mm b gy mu mr l ms mt">aController.abort();</span></pre><p id="7834" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">AbortController也允许一次取消多个获取请求:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="7512" class="ln lo iq mm b gy mq mr l ms mt">const url1 = 'https://server/api/d1';<br/>const url2 = 'https://server/api/d2';</span><span id="15e7" class="ln lo iq mm b gy mu mr l ms mt">let urls = [url1 ,url2'];</span><span id="ad68" class="ln lo iq mm b gy mu mr l ms mt">let aController = new AbortController();</span><span id="f9a3" class="ln lo iq mm b gy mu mr l ms mt">let tasks = urls.map(url =&gt; fetch(url,{<br/>  signal: aController.signal<br/>}));</span><span id="f348" class="ln lo iq mm b gy mu mr l ms mt">let results = await Promise.all(tasks);</span><span id="02be" class="ln lo iq mm b gy mu mr l ms mt">//Abort all requests<br/>aController.abort();</span></pre><h2 id="beef" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">fetch与经典XMLHttpRequest的比较</h2><p id="aa63" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">取得</p><p id="53fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里我们使用AbortController.abort()方法中止一个获取请求:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="0caf" class="ln lo iq mm b gy mq mr l ms mt">const aController = new AbortController;</span><span id="3ae7" class="ln lo iq mm b gy mu mr l ms mt">fetch('https://server/api', {<br/>    signal: controller.signal<br/>}).then(response =&gt; {<br/>    if (response.ok) {<br/>        console.log(response.text());<br/>    }<br/>});</span></pre><p id="d18e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">XMLHttpRequest</p><p id="5de7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里，在XMLHttpRequest中，XMLHttpRequest abort()方法也可以用来取消请求:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="0395" class="ln lo iq mm b gy mq mr l ms mt">const url = 'https://server/api/d1';<br/>const xhr = new XMLHttpRequest;</span><span id="1db5" class="ln lo iq mm b gy mu mr l ms mt">xhr.addEventListener('load', () =&gt; {<br/>    if (xhr.status === 200) {<br/>        xhr.responseType = 'text';<br/>        console.log(xhr.response);<br/>    }<br/>});</span><span id="3d73" class="ln lo iq mm b gy mu mr l ms mt">xhr.open('GET',url);<br/>xhr.send();</span><span id="044a" class="ln lo iq mm b gy mu mr l ms mt">//Abort request<br/>xhr.abort();</span></pre><h2 id="2ad4" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">在不同的环境中使用AbortController</h2><p id="a6d2" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">JavaScript代码可以在三种主要环境中运行:</p><ul class=""><li id="7402" class="mv mw iq kt b ku kv kx ky la mx le my li mz lm na nb nc nd bi translated">现代浏览器:您可以毫无问题地使用AbortController，因为AbortController是由WHATWG创建来处理DOM的。</li><li id="4623" class="mv mw iq kt b ku ne kx nf la ng le nh li ni lm na nb nc nd bi translated">Node:如果想在Node中使用AbortController，可以使用WHATWG AbortController接口的实现。您可以使用不同的npm包来实现这一点，例如，<a class="ae nj" href="https://www.npmjs.com/package/node-fetch" rel="noopener ugc nofollow" target="_blank"> node-fetch </a>或npm <a class="ae nj" href="https://www.npmjs.com/package/abort-controller" rel="noopener ugc nofollow" target="_blank"> abort-controller </a>。</li><li id="788a" class="mv mw iq kt b ku ne kx nf la ng le nh li ni lm na nb nc nd bi translated">遗留浏览器:你需要使用polyfills，例如，使用<a class="ae nj" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> Babel </a>。</li></ul><h1 id="1c3a" class="nk lo iq bd lp nl nm nn ls no np nq lv jw nr jx ly jz ns ka mb kc nt kd me nu bi translated">结论</h1><p id="6240" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">尽管AbortController是DOM的一个特性，而不是语言本身的一个特性，但它确实为异步任务提供了一个标准化的、简单的取消解决方案。请记住，即使我们取消了获取请求，这也不会停止后端的请求处理。</p><p id="0ad5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望你喜欢这篇文章。感谢阅读。</p></div></div>    
</body>
</html>