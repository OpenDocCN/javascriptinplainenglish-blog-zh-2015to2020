<html>
<head>
<title>Creating a Discord Bot with discord.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用discord.js创建不和谐机器人</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-a-discord-bot-with-discord-js-2f9f7a1a9d80?source=collection_archive---------3-----------------------#2020-11-25">https://javascript.plainenglish.io/creating-a-discord-bot-with-discord-js-2f9f7a1a9d80?source=collection_archive---------3-----------------------#2020-11-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a74aaa815a94f30baa7cc7a58a8999a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rvh7SsihchvuR0Y77itWVw.jpeg"/></div></div></figure><p id="57bd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">先说一下<strong class="jx io">天文学。</strong> Astronomia是一个不和谐机器人，可以提供新闻，给出天体信息，建议随机电影，等等。你可以去<a class="ae kt" href="https://ayushman-git.github.io/astronomia-site/" rel="noopener ugc nofollow" target="_blank">这个站点</a>探索它所有的命令。</p><p id="5fcf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">astronomia项目可能是我参与的最激动人心的项目。这是因为两个原因——首先，我要建立一些包括天文学在内的东西，而天文学总是让我兴奋不已；另一个原因是我可以在一个项目中使用如此多的技术。我使用了几个API来获取数据，如果没有API，我就用<strong class="jx io">木偶师</strong>来废弃数据。我还用<strong class="jx io"> Firestore </strong>做了一些很酷的东西，最后用<strong class="jx io"> discord.js </strong> npm模块与discord互动。我将谈论所有这些技术，以及它们是如何帮助我建造astronomia的。</p><h1 id="5c65" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">什么是discord.js？</h1><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ls"><img src="../Images/ec2cd4562c71055d62165723483b9928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sC1_F3ZD4dVXWPrzPSovrg.png"/></div></div></figure><p id="7a89" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在潜入discord.js之前，我先简单解释一下<strong class="jx io"> Discord </strong>。Discord基本上是slack，但面向游戏玩家，尽管它可以被任何想和朋友在网上闲逛的人使用。用户可以在文本频道中相互聊天，或者加入语音频道与其他成员交谈。</p><p id="763e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">说完了，我们来说说<a class="ae kt" href="https://discord.js.org/#/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> discord.js </strong> </a>。Discord.js是一个与discord API交互的npm包。它基于事件驱动的架构，所以如果discord上的任何用户发送消息，该消息可以在discord.js API中被捕获。它不仅限于消息，我们可以捕捉几乎每一个活动，如-用户加入服务器，对消息的反应，文本频道的创建等等。如果机器人有适当的权限，也可以让它做服务器所有者能够做的任何事情(除了删除服务器)。</p><h1 id="c08e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">不和谐机器人是如何工作的？</h1><p id="ed5f" class="pw-post-body-paragraph jv jw in jx b jy lx ka kb kc ly ke kf kg lz ki kj kk ma km kn ko mb kq kr ks ig bi translated">让我们花一分钟来了解一个不和谐机器人是如何工作的。</p><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/972239a61c5e58fbbc2c758d32083e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xxIJOSJbuUcUtSxzCvtYCw.jpeg"/></div></div></figure><p id="8191" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，用户在discord客户机中输入一条消息，然后这条消息通过discord API被发送到我们的服务器，在那里我们的机器人被托管。然后，服务器根据用户发送的命令执行一些代码。</p><p id="851e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里，我们将以<strong class="jx io">为例。嗨</strong>指挥我们的机器人。每当用户键入<strong class="jx io">时。hi </strong> is discord，discord API发出一个事件，我们用它来捕捉—</p><figure class="lt lu lv lw gt jo"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="7b97" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第一个挑战是确定发送的信息是普通信息还是给<strong class="jx io">天文机器人</strong>的命令。所以我写了一个条件，忽略所有不以<strong class="jx io">开头的东西。，</strong>这是我挑的一个前缀。</p><p id="fa52" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在检测到它是针对机器人的命令后，我将消息分解为命令名和参数。<strong class="jx io">后的第一个字母“.”</strong>被认为是一个命令，其后的所有内容都被转换成一个数组，作为命令的参数。</p><p id="88ca" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在检测到它是针对机器人的命令后，我将消息分解为命令名和参数。<strong class="jx io">后的第一个字母“.”</strong>被认为是一个命令，其后的所有内容都被转换成一个数组，该数组将被用作命令的参数。</p><p id="b0c3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以当用户输入<strong class="jx io">时。嗨，</strong>在服务器端，机器人从我创建的数组中随机选择一个问候词，并通过discord API返回给用户。</p><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mf"><img src="../Images/e0c58b98c8f75fa5eafe1caefff3fde4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*G5QJIy4ADLZMPnajD8LFwg.gif"/></div></div></figure><p id="fd10" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果从整体概念来看，并没有那么复杂。我正在识别用户发送的命令，并执行一个特定的函数，将处理后的消息返回。但是当astronomia没有用户请求的数据时会发生什么呢？当我们必须获取数据并发送给用户时，事情就变得有点复杂了。</p><h1 id="711e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">获取数据</h1><p id="4ce7" class="pw-post-body-paragraph jv jw in jx b jy lx ka kb kc ly ke kf kg lz ki kj kk ma km kn ko mb kq kr ks ig bi translated">在上一节中，我们探索了一个简单的<strong class="jx io">。hi </strong> command，老实说这没什么意思。在本节中，我们将讨论另外两个命令— <strong class="jx io">。探索</strong>和<strong class="jx io"> .wallpaper. </strong>这些命令更容易理解。</p><p id="7730" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">。浏览</strong>命令带有一个参数。所以正确的语法应该是这样的— <strong class="jx io">。探索泰坦</strong>，它将返回这个作为响应。</p><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mg"><img src="../Images/721adbc1a9253f847b1129f35ec56cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*1uE5hlKQdN2WzF2MMQv6Ig.gif"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk">Here .e is a shorthand for .explore</figcaption></figure><p id="b022" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是怎么回事？实际上是一些事情。我们来分解一下。只要用户发送这个命令，机器人就会向太阳系open data API发出GET请求，这是一个包含太阳系天体数据的API。在识别出explore命令后，astronomia向API发送一个请求，API返回关于Titan卫星的JSON数据。这个JSON数据看起来像这样。</p><figure class="lt lu lv lw gt jo"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="6e8c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">它包含了很多很酷的东西，但是缺少了两样东西——一张泰坦的图片和一段简短的描述。为了添加这两个，我手动从互联网上收集了著名天体的图像和描述，包括所有八大行星、太阳和几个常见的卫星，并将它们存储在JSON文件中。</p><p id="f301" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以每当用户点击<strong class="jx io">。探索泰坦</strong>命令，机器人从API获取数据，从JSON文件本地获取数据，并返回包含各种数据的正确消息。</p><p id="5f1d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">到目前为止，我们只使用API来获取数据，但是当没有API或者使用API有一些限制时，我们应该做什么呢？我实现壁纸功能的时候就是这样。</p><p id="0531" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有一些很棒的天文学壁纸，但是它们对API调用的请求有限，并且有一些CORS限制。所以我安装了puppeteer，这是一个用chrome报废数据的npm包，并报废了所有与天文学相关的壁纸URL。</p><figure class="lt lu lv lw gt jo"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="57f6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个小脚本使得收集1200多个壁纸网址成为可能。我们来破解一下上面的代码，以便更好的理解。</p><p id="08ba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我正在导入<strong class="jx io"> fs </strong>模块，因为我将把获取的URL存储在一个文件中。第二个模块是<strong class="jx io">木偶师</strong>，我在一个异步函数中使用它。必须在异步函数中使用木偶特性，因为它需要一些时间来完成像打开chrome、打开tab等任务。</p><p id="7bf3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后我用循环遍历每一页。在第11行和第12行，我启动了chrome并创建了一个新标签。之后，我将访问提供的URL。</p><p id="a3ae" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从第20行到第26行，<strong class="jx io"> evaluate() </strong>函数返回该页面上壁纸的URL，并将其存储在<strong class="jx io"> const result </strong>中。然后，我对URL进行了一些调整，以引导到正确的路径。最后，我使用<strong class="jx io"> fs.writeFile() </strong>将这些Url存储在wallpaperUrl.js文件中。现在我可以用这些1200+的壁纸，发给用户了。</p><h1 id="2372" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">自动功能</h1><p id="f88a" class="pw-post-body-paragraph jv jw in jx b jy lx ka kb kc ly ke kf kg lz ki kj kk ma km kn ko mb kq kr ks ig bi translated">我解释到现在的每个命令都是在用户输入某个命令后执行一段代码。但是对于像新闻更新这样的事情，应该定期执行一个函数。让我们来探索这些自动功能。</p><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/2abcc27a206a024cbcba6fbd1e02e73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Aixf4bct7EmvUQPtpBEl0g.jpeg"/></div></div></figure><p id="5b0c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于<strong class="jx io"> setInterval() </strong>函数，我正在传递一个回调函数。这个回调函数每小时向<a class="ae kt" href="http://hubblesite.org/api/documentation" rel="noopener ugc nofollow" target="_blank"> hubble站点API </a>发出一个请求，在得到响应后，我会检查收到的JSON是否与firestore DB中存储的JSON相同。如果相同，那么函数将返回，不做任何其他事情。但是如果收到的JSON和firestore中的JSON有差异，它会处理这些数据并将其发送回Discord。最后，firestore中存储的JSON将被用axios获取的JSON替换。整个过程每60分钟重复一次，这就是用户获取最新新闻的方式。</p></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><h1 id="97df" class="ku kv in bd kw kx ms kz la lb mt ld le lf mu lh li lj mv ll lm ln mw lp lq lr bi translated">结论</h1><p id="fea1" class="pw-post-body-paragraph jv jw in jx b jy lx ka kb kc ly ke kf kg lz ki kj kk ma km kn ko mb kq kr ks ig bi translated">这只是一个开始，我计划扩大这个机器人，并添加许多新的命令和功能。如果你有一些想法，请与我分享。</p><p id="b422" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个想法是作为另一个为期一周的项目开始的。但是我不断回到它上面来添加新的功能或者改进现有的功能。这个项目帮助我探索未开发的领域，并帮助我面对现实世界的问题，如——当没有服务的API时，我们应该做什么，如何托管Node.js应用程序，等等。这个项目也有它的挑战，例如，我花了一整天的时间来弄清楚如何从Goodreads收集数据。</p><p id="0f66" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以访问这个<a class="ae kt" href="https://ayushman-git.github.io/astronomia-site/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">网站</strong> </a> <strong class="jx io"> </strong>来探索更多关于这个机器人的信息，或者你可以<a class="ae kt" href="https://github.com/ayushman-git/astronomia-bot" rel="noopener ugc nofollow" target="_blank">为这个项目贡献</a>。如果你喜欢天文学，你会喜欢这个机器人。我将用我最喜欢的一句名言来结束这篇文章。</p><blockquote class="mx my mz"><p id="23de" class="jv jw na jx b jy jz ka kb kc kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ks ig bi translated">”“宇宙就是现在、过去或将来的一切。我们对宇宙最微弱的沉思会激起我们——脊柱发麻，声音颤抖，一种微弱的感觉，仿佛是遥远的记忆，或者从高处坠落。我们知道我们正在接近最大的秘密。”—卡尔·萨根</p></blockquote><p id="7584" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="na">更多内容请看</em><a class="ae kt" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="na">plain English . io</em></a></p></div></div>    
</body>
</html>