<html>
<head>
<title>Let’s Build A Full Stack App With The Spotify Algorithm and API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用Spotify算法和API构建一个全栈应用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/accessing-the-spotifyalgorithm-full-stack-application-tutorial-part-1-792a2c0ff13?source=collection_archive---------3-----------------------#2020-11-20">https://javascript.plainenglish.io/accessing-the-spotifyalgorithm-full-stack-application-tutorial-part-1-792a2c0ff13?source=collection_archive---------3-----------------------#2020-11-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/dff3c4c880806c0e251ad9aa286aa00f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gpd49cqoiqZ8MtjWpz1Yaw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@heidifin?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Heidi Fin</a> on <a class="ae jz" href="https://unsplash.com/s/photos/spotify?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f8c4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，Spotify，如果你在看这个，请雇佣我。好了，现在我们已经解决了这个问题…</p><p id="2101" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">很多人不知道的是，Spotify有一个不为人知的功能，那就是深度。如此之深，以至于特征本身可以是它自己的应用。这一切都存在于Spotify公共web api的一个小端点中:</p><p id="ce2e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b"><a class="ae jz" href="https://api.spotify.com/v1/recommendations" rel="noopener ugc nofollow" target="_blank">https://api.spotify.com/v1/recommendations</a></code></p><p id="1aa1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">或许，如果你最近刚进入web开发领域，你会在实践中偶然发现Spotify的公共Web API。有了这个API，您可以使用premium帐户进行身份验证，检索用户喜欢的歌曲和播放列表的所有数据，甚至可以通过浏览器使用他们的Web Player SDK播放音乐。</p><p id="7204" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是这个推荐端点完全是另外一回事。这个端点允许你利用Spotify的算法向你推荐歌曲。如果你使用Spotify，你很可能至少听过一次你的个人精选播放列表。这些包括播放列表，如每周发现，释放雷达，或任何每日混音系列。通过一点小技巧，我们可以对推荐算法进行调整，并根据自己的喜好自动生成播放列表。</p><h1 id="9b04" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">它是这样工作的</h1><p id="fedb" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated">根据Spotify的web api:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="df7e" class="mn ld in lb b gy mo mp l mq mr">Recommendations are generated based on the available information for a given seed entity and matched against similar artists and tracks. If there is sufficient information about the provided seeds, a list of tracks will be returned together with pool size details.</span></pre><p id="1d8d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，我们只需要提供任意数量的“种子”歌曲、艺术家或流派，就可以得到一个推荐曲目列表。</p><p id="88c2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">假设我想获得一个基于种子流派“electronic”的推荐播放列表(或者在本例中只有一首歌曲)。然后，我使用Spotify进行身份验证，并向推荐端点发送如下get请求:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="f773" class="mn ld in lb b gy mo mp l mq mr">"https://api.spotify.com/v1/recommendations?limit=1&amp;market=US&amp;seed_genres=electronic"</span></pre><p id="4e73" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我会从他们的服务器收到这样的响应(为了便于查看，我删除了很多无用的数据):</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="10e6" class="mn ld in lb b gy mo mp l mq mr">{<br/>  "tracks": [<br/>    {<br/>      "artists": [<br/>          "id": "25fqWEebq6PoiGQIHIrdtv",<br/>          "name": "Baauer",<br/>          "type": "artist",<br/>          "uri": "spotify:artist:25fqWEebq6PoiGQIHIrdtv"<br/>        }<br/>      ],<br/>      "name": "Harlem Shake",<br/>      "track_number": 1,<br/>      "type": "track",<br/>      "uri": "spotify:track:01XFgRZfZI7oBagNf1Loml"<br/>    },<br/>  ],<br/>  "seeds": [<br/>    {<br/>      "initialPoolSize": 1000,<br/>      "afterFilteringSize": 1000,<br/>      "afterRelinkingSize": 972,<br/>      "id": "electronic",<br/>      "type": "GENRE",<br/>      "href": null<br/>    }<br/>  ]<br/>}</span></pre><p id="ae0b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这种情况下，我只使用流派种子<code class="fe ky kz la lb b">electronic</code>搜索了1首歌曲。我们必须能够用更多的领域来影响种子:</p><p id="930a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">限制:</strong>返回的歌曲数量(最少1首，最多100首)</p><p id="9d17" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">种子艺术家:</strong>逗号分隔的种子艺术家列表(需要使用他们的spotify ID)</p><p id="4833" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">种子_流派:</strong>可用流派种子集合中任何流派的逗号分隔列表<code class="fe ky kz la lb b"><a class="ae jz" href="https://api.spotify.com/v1/recommendations/available-genre-seeds" rel="noopener ugc nofollow" target="_blank">https://api.spotify.com/v1/recommendations/available-genre-seeds</a></code></p><p id="0f85" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> seed_tracks: </strong>种子轨道的SpotifyIDs的逗号分隔列表</p><p id="6dc7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我们有了真正有趣的东西:</p><p id="d264" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">max _ *:_ _ _ _ _ _</strong>的最大值</p><p id="8478" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">min _ *:_ _ _ _ _ _ _ _ _</strong>的最小值</p><p id="8b8d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">目标_*:目标值_____ </strong></p><p id="52ff" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些查询参数中的通配符指的是以下可调谐轨道属性列表:</p><p id="8c31" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">acoustic ness</strong>:0.0到1.0之间的一个关于音轨是否声学的置信度度量。</p><p id="456a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">可跳舞性:</strong>根据音乐元素的组合，如节奏、韵律稳定性、节拍强度和整体规律性，判断一首曲目是否适合跳舞。</p><p id="bb4f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> duration_ms </strong>:以毫秒为单位的音轨持续时间</p><p id="e0bb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">乐器性:</strong>预测音轨是否不包含人声。</p><p id="34f5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">键</strong>:轨道所在的键。0=C，1=C#，2=D等等</p><p id="6a0c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">活跃度</strong>:检测录像中是否有观众。</p><p id="b2f2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">响度</strong>:音轨的整体响度，单位为分贝。</p><p id="aa52" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">模式</strong>:音轨的模态(大调/小调)值。大调为1，小调为0。</p><p id="de54" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">人气</strong>:赛道的人气。该值将介于0和100之间，100是最受欢迎的。</p><p id="8f05" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">语速</strong>:检测音轨中是否存在口语单词。</p><p id="44ac" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">速度</strong>:一个音轨的整体估计速度，单位为每分钟节拍数(bpm)。</p><p id="4e36" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> time_signature </strong>:估计的音轨整体时间签名。</p><p id="711f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">价</strong>:描述曲目所传达的音乐积极性。价越高=越积极的氛围。</p><p id="d3d0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于这些具体值的更深入的细节可以在本页上阅读。</p><h1 id="9491" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">非常棒</h1><p id="04aa" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated">使用这个端点的能力真是太酷了。我们可以做一系列非常有趣的项目，但其中一个我一直想做的是一个播放列表生成器。这正是我们要做的，有一个反应前端和一个快速后端。让我们开始吧。</p><h1 id="1d79" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">我对这个系列的计划</h1><p id="ee53" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated">理想情况下，我想做的是一系列地检查整个堆栈任务，如下所示:</p><p id="5e58" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第1部分:设置后端<br/>第2部分:创建前端组件&amp;功能<br/>第3部分:为后端+前端逻辑创建测试<br/>第4部分:部署到生产服务器</p><h1 id="9e99" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">制作服务器</h1><p id="4edc" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated">我不会考虑后端服务器的所有后勤工作，主要是Spotify的认证部分。如果你有兴趣了解我是如何维护安全会话的，<a class="ae jz" href="https://medium.com/javascript-in-plain-english/secure-react-express-apps-jsonwebtoken-cookie-session-auth0-and-passport-tutorial-e58d6dce6c91" rel="noopener">请查看我最近写的另一篇文章，名为《如何创建安全反应&amp;快速应用:</a></p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="1da8" class="mn ld in lb b gy mo mp l mq mr">$ npm init (for creating a package.json, and checking my entry point to be server.js)</span><span id="2786" class="mn ld in lb b gy ms mp l mq mr">And now we create our backend files</span><span id="be0e" class="mn ld in lb b gy ms mp l mq mr">$ touch server.js<br/>$ touch .env</span><span id="3651" class="mn ld in lb b gy ms mp l mq mr">Now for our backend dependencies</span><span id="95cc" class="mn ld in lb b gy ms mp l mq mr">$ yarn add express cookie-session helmet hpp csurf dotenv axios jsonwebtoken</span></pre><p id="35d5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是我们的server.js的内容</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="27e6" class="mn ld in lb b gy mo mp l mq mr">// server.js<br/>const express = require('express');<br/>const session = require('cookie-session');<br/>const helmet = require('helmet');<br/>const hpp = require('hpp');<br/>const csurf = require('csurf');<br/>const dotenv = require('dotenv');<br/>const path = require('path');<br/><br/><br/>/* Import config */<br/>dotenv.config({path: path.resolve(__dirname, '.env')});<br/><br/>/* Create Express App */<br/>const app = express();<br/><br/>/* Set Security Configs */<br/>app.use(helmet());<br/>app.use(hpp());<br/><br/>/* Set Cookie Settings */<br/>app.use(<br/>    session({<br/>        name: 'session',<br/>        secret: process.env.COOKIE_SECRET,<br/>        expires: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours<br/>    })<br/>);<br/>app.use(csurf());<br/><br/><br/>app.listen(8080, () =&gt; {<br/>    console.log("I'm listening!");<br/>});<br/><br/>module.exports = app;</span></pre><p id="c56c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">目前你的。env文件只需要一个值，这是我们用来签署我们的会话cookie的秘密:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="4769" class="mn ld in lb b gy mo mp l mq mr"># .env<br/>COOKIE_SECRET=asecretyoushallputhere</span></pre><p id="7935" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">运行您的应用程序应该会显示以下输出:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="4402" class="mn ld in lb b gy mo mp l mq mr">$ yarn start<br/>yarn run v1.22.4<br/>$ node server.js<br/>I'm listening!</span></pre><h1 id="bbe2" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">向Spotify注册我们的应用程序</h1><ol class=""><li id="f10b" class="mt mu in kc b kd ma kh mb kl mv kp mw kt mx kx my mz na nb bi translated">去<a class="ae jz" href="https://developer.spotify.com/dashboard/login" rel="noopener ugc nofollow" target="_blank">https://developer.spotify.com/dashboard/login</a></li><li id="a918" class="mt mu in kc b kd nc kh nd kl ne kp nf kt ng kx my mz na nb bi translated">登录后，您可以使用Spotify创建一个应用程序，如下所示:</li></ol><figure class="mf mg mh mi gt jo gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/f708e870e2a8752d608f37ab164692e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*ufSzgzZjEBpqBaatRbtyAA.png"/></div></figure><p id="7510" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.点击create后，我们被重定向到应用程序“建议”的仪表板</p><figure class="mf mg mh mi gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ni"><img src="../Images/970f446d8f3a785db619bc006481a928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O8CKX40bEXjA27ia3HP-XQ.png"/></div></div></figure><p id="40eb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">4.让我们点击“编辑设置”并将<code class="fe ky kz la lb b"><a class="ae jz" href="http://localhost:3000/auth/callback" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/auth/callback</a></code>添加到重定向URIs字段。这将是Spotify在向Spotify认证后将浏览器发送回的链接。</p><p id="452b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">5.保存您的设置并查看仪表板，我们需要来自页面的两条信息，ClientID和ClientSecret。单击“显示客户端密码”查看并复制它。让我们把这些放进我们的。环境文件:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="30ae" class="mn ld in lb b gy mo mp l mq mr"># .env<br/>COOKIE_SECRET=yoursecretcookiekey<br/>SPOTIFY_CLIENT_ID=&lt;your client id here&gt;<br/>SPOTIFY_CLIENT_SECRET=&lt;your client secret here&gt;</span></pre><h2 id="375e" class="mn ld in bd le nj nk dn li nl nm dp lm kl nn no lq kp np nq lu kt nr ns ly nt bi translated">制作身份验证路由</h2><p id="2989" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated">Spotify实际上提供了几种不同的应用认证方式。其中之一是授权代码流。类似于我在另一篇文章中使用的Auth0流程，流程如下，这是Spotify提供的图形:</p><figure class="mf mg mh mi gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nu"><img src="../Images/ddd5451e1cb3957c8b3b73ce68132fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*orp8Qm3dHLNURhfv.png"/></div></div></figure><p id="09fb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了简化:</p><ol class=""><li id="df75" class="mt mu in kc b kd ke kh ki kl nv kp nw kt nx kx my mz na nb bi translated">让我们的应用程序请求授权，然后让用户通过spotify的授权流登录:</li></ol><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="3831" class="mn ld in lb b gy mo mp l mq mr">// routes/auth.js<br/>const express = require('express');<br/>const querystring = require('querystring');<br/>const axios = require('axios');<br/>const jwt = require('jsonwebtoken');<br/><br/><br/>const router = express.Router();<br/><br/>router.get('/login', (req, res) =&gt; {<br/>    res.redirect(`https://accounts.spotify.com/authorize?${querystring.stringify({<br/>        response_type: 'code',<br/>        client_id: process.env.SPOTIFY_CLIENT_ID,<br/>        redirect_uri: process.env.SPOTIFY_REDIRECT_URI,<br/>    })}`);<br/>});</span></pre><p id="92d1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">登录端点是我们将用户重定向到spotify授权页面的地方，传入client_id、redirect_uri和响应类型作为查询参数。</p><p id="b3d8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">2.在我们从身份验证中收到代码后，我们可以使用它来获得一个访问和刷新令牌。访问令牌是我们从Spotify Web API获取数据所需要的，比如搜索曲目和使用推荐端点</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="1894" class="mn ld in lb b gy mo mp l mq mr">router.get('/callback', async (req, res) =&gt; {<br/>    const {code} = req.query;<br/>    const clientId = process.env.SPOTIFY_CLIENT_ID;<br/>    const secret = process.env.SPOTIFY_CLIENT_SECRET;<br/>    const redirect_uri = process.env.SPOTIFY_REDIRECT_URI;<br/>    const grant_type = 'authorization_code';<br/><br/>    const basicHeader = Buffer.<em class="ny">from</em>(`${clientId}:${secret}`).toString('base64');<br/>    const {data} = await axios.post('https://accounts.spotify.com/api/token', querystring.stringify({<br/>        grant_type,<br/>        code,<br/>        redirect_uri,<br/>    }), {<br/>        headers: {<br/>            Authorization: `Basic ${basicHeader}`,<br/>            'Content-Type': 'application/x-www-form-urlencoded'<br/>        }<br/>    });<br/><br/>    const sessionJWTObject = {<br/>        token: data.access_token,<br/>    };<br/><br/>    req.session.jwt = jwt.sign(sessionJWTObject, process.env.JWT_SECRET_KEY)<br/>    return res.redirect('/');<br/>});</span></pre><p id="a8d5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个请求看起来有点复杂，但没什么太糟糕的。它只是获取我们从请求查询中获得的代码，并使用它向<a class="ae jz" href="https://acounts.spotify.com/api/token." rel="noopener ugc nofollow" target="_blank">https://acounts.spotify.com/api/token.</a>发送post请求。授权头是使用我们的clientId和secret的基本Auth，内容类型是Spotify文档的规范。</p><p id="73a5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们打印出从这里得到的数据，看起来会像这样:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="e232" class="mn ld in lb b gy mo mp l mq mr">{<br/>  access_token: 'longcode',<br/>  token_type: 'Bearer',<br/>  expires_in: 3600,<br/>  refresh_token: 'anotherlongcode',<br/>  scope: ''<br/>}</span></pre><p id="8562" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们从这个请求中获取访问令牌，并将其放入我们的会话cookie中。如果您想了解更多关于会话cookies的信息，请查看另一篇文章。</p><p id="c2e5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这就是Spotify认证的大部分内容！我们可以添加另外两个端点，让我们以后的生活更轻松:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="69c9" class="mn ld in lb b gy mo mp l mq mr">router.get('/current-session', (req, res) =&gt; {<br/>    jwt.verify(req.session.jwt, process.env.JWT_SECRET_KEY, (err, decodedToken) =&gt; {<br/>        if (err || !decodedToken) {<br/>            res.send(false);<br/>        } else {<br/>            res.send(decodedToken);<br/>        }<br/>    });<br/>})<br/><br/>router.get('/logout', (req, res) =&gt; {<br/>    req.session = null;<br/>    res.redirect(<br/>        `/`<br/>    );<br/>});<br/><br/>module.exports = router;</span></pre><ol class=""><li id="3344" class="mt mu in kc b kd ke kh ki kl nv kp nw kt nx kx my mz na nb bi translated"><code class="fe ky kz la lb b">/current-session</code>:这个端点正在验证我们的会话对象中的jwt-token，如果它有效，我们就在请求中将内容发送给客户机。如果不存在，我们返回false。一旦我们做了前端，这就更有意义了</li><li id="447a" class="mt mu in kc b kd nc kh nd kl ne kp nf kt ng kx my mz na nb bi translated"><code class="fe ky kz la lb b">/logout</code>:这是一个端点，用于简单地销毁我们的jwt令牌，我们将使用它来确定用户是否通过了Spotify的身份验证。</li></ol><h1 id="8f17" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">第二部分在这里！</h1><p id="bd0c" class="pw-post-body-paragraph ka kb in kc b kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx ig bi translated"><a class="ae jz" href="https://stregz.medium.com/part-2-lets-build-a-full-stack-app-with-the-spotify-algorithm-and-api-frontend-development-463c6c232219" rel="noopener">https://stregz . medium . com/part-2-lets-build-a-full-stack-app-with-the-Spotify-algorithm-and-API-fronted-development-463 C6 c 232219</a></p><p id="cec5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的Spotify播放列表推荐服务的后端部分已经非常完整了。我们现在需要做的是创建可以执行我们需要的所有功能的前端！我希望在本周晚些时候发布这个。如果你想查看我在本文中已经打出的代码，我正在这里创建这个项目:【https://github.com/jdstregz/spotify-recommendations<a class="ae jz" href="https://github.com/jdstregz/spotify-recommendations" rel="noopener ugc nofollow" target="_blank"/></p><p id="b9ef" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">谢谢大家！</p></div></div>    
</body>
</html>