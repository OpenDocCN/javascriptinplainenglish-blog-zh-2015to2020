<html>
<head>
<title>Upload and download encrypted files in your Node App with AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS S3在您的节点应用程序中上传和下载加密文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/uploading-encrypted-files-in-aws-s3-bucket-with-nodejs-app-c28b7fef1779?source=collection_archive---------3-----------------------#2019-12-28">https://javascript.plainenglish.io/uploading-encrypted-files-in-aws-s3-bucket-with-nodejs-app-c28b7fef1779?source=collection_archive---------3-----------------------#2019-12-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="411f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3 bucket利用NodeJS应用程序来上传、下载和删除文件。加密是文件上传中非常重要的一部分。使用KMS密钥的AWS信封加密可确保数据在静态时是安全的。这篇文章主要关注上传文件到S3桶加密的内容。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4a8d25cd47fc846ac08b48c9c4b20ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zJxdlddOTJ11CmDT.jpg"/></div></div></figure><h2 id="c4a7" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">在AWS S3上传和下载加密文件的步骤:</h2><ol class=""><li id="cc80" class="lq lr iq jp b jq ls ju lt jy lu kc lv kg lw kk lx ly lz ma bi translated">使用AWS控制台创建S3存储桶和文件夹。在存储桶内创建文件夹并提供访问策略。(不包括用户、用户组和用户池id的创建，因为这是另一个主题，将在另一篇文章中讨论)</li><li id="06e7" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">使用AWS控制台创建KMS键。KMS密钥非常重要，是加密文件内容所必需的。</li><li id="a32b" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">使用NodeJS中的KMS密钥上传和下载加密文件。</li></ol><h1 id="3f6a" class="mg ky iq bd kz mh mi mj lc mk ml mm lf mn mo mp li mq mr ms ll mt mu mv lo mw bi translated">AWS控制台</h1><ol class=""><li id="4042" class="lq lr iq jp b jq ls ju lt jy lu kc lv kg lw kk lx ly lz ma bi translated"><strong class="jp ir">使用AWS控制台创建S3存储桶和文件夹:</strong>在AWS控制台中创建登录。转到AWS服务，在AWS控制台中选择S3。</li></ol><p id="b142" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的S3时段并选择区域。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/3c72d5b8d2f75daa4b32940d1354c4e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6WFDfAvkV2Ao5aPjvVlWg.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi my"><img src="../Images/46e82710c3eb3e5af04a674b7d1f0c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_5LPHO0_75ggegzRuJHYDQ.png"/></div></div></figure><p id="9fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">阻止公共访问</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/f08758d6f48eed9757eec19b4ea210bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6CgkiX6nrFAxhae7TC-X5w.png"/></div></div></figure><p id="03eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建文件夹并选择加密类型，在本例中我们选择了AES-256。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mz"><img src="../Images/0ca36b6fe7ed551a9380eef654f3946e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*egOl8aN74Nnihz8q70pZVw.png"/></div></div></figure></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="4e41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。使用AWS控制台创建KMS密钥:</strong></p><p id="058d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在使用<a class="ae nh" href="https://console.aws.amazon.com/iam/." rel="noopener ugc nofollow" target="_blank"> AWS IM用户控制台</a>创建一个用户。选择“以编程方式访问”以生成访问键。一旦创建了用户并设置了用户池。使用<a class="ae nh" href="https://us-east-2.console.aws.amazon.com/kms/home?region=us-east-2#/kms/keys" rel="noopener ugc nofollow" target="_blank">AWS KMS控制台</a>生成KMS密钥。</p><ul class=""><li id="1baf" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">对于区域，选择适当的AWS区域。不要使用导航栏中的区域选择器(右上角)。</li><li id="db1c" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">选择生成CMK <strong class="jp ir">密钥(客户主密钥)</strong>。输入CMK的别名。别名不能以AWS 开头。以<strong class="jp ir">开头的别名AWS </strong>由Amazon Web Services保留，代表您帐户中AWS管理的cmk。</li><li id="646e" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">别名是可用于识别CMK的显示名称。建议设置是选择一个别名来指示您计划保护的数据类型或您计划与CMK一起使用的应用程序。选择描述，虽然它是可选的，但最好有特性。描述应该包含使用该密钥的加密类型和应用程序的信息。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi my"><img src="../Images/79dad2e4b8eff72222804b6d72e0f86c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*68Vq1cqG7Z0_zEr-b7SgsA.png"/></div></div></figure><ul class=""><li id="ac09" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">单击“下一步”,并键入标记键和可选的标记值。要向CMK添加多个标签，选择<strong class="jp ir">添加标签。</strong>标记始终是可选的。选择可以管理CMK的IAM用户和角色。</li><li id="6a45" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">默认情况下，AWS帐户(root用户)拥有完全权限。因此，其附加策略允许适当权限的任何IAM用户和角色也可以管理CMK。要防止您在上一步中选择的IAM用户和角色删除此CMK，请清除页面底部的复选框<strong class="jp ir">允许密钥管理员删除此密钥。</strong></li><li id="1176" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">现在下一步是选择IAM用户和角色，他们可以使用CMK通过AWS KMS API加密和解密数据。</li><li id="067c" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">默认情况下，AWS帐户(root用户)拥有完全权限。因此，其附加策略允许适当权限的任何IAM用户和角色也可以使用CMK。</li><li id="cc11" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">这是一个可选步骤，您可以使用页面底部的控件来指定可以使用此CMK加密和解密数据的其他AWS帐户。为此，选择<strong class="jp ir">添加一个外部账户</strong>，然后输入想要的AWS账户ID。根据需要重复添加多个外部帐户。</li><li id="ec60" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">外部帐户的管理员还必须通过为其用户创建IAM策略来允许访问CMK。有关更多信息，请参见<a class="ae nh" href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying.html#key-policy-modifying-external-accounts" rel="noopener ugc nofollow" target="_blank">允许外部AWS帐户访问CMK </a>。现在选择下一步，完成密钥创建步骤。</li></ul><p id="10c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的S3桶文件夹准备好了。我们还为信封加密创建了用户、用户池id和CMK密钥。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="777b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<strong class="jp ir">在节点</strong>中使用KMS密钥上传和下载加密文件</p><ul class=""><li id="15a6" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">安装AWS SDK依赖项和文件加密模块</li></ul><pre class="km kn ko kp gt nm nn no np aw nq bi"><span id="e49d" class="kx ky iq nn b gy nr ns l nt nu">#Install aws sdk and file encryptor module</span><span id="b7e3" class="kx ky iq nn b gy nv ns l nt nu">npm install aws-sdk</span><span id="e5f1" class="kx ky iq nn b gy nv ns l nt nu">npm install file-encryptor</span><span id="a4f6" class="kx ky iq nn b gy nv ns l nt nu">npm install file-system --save</span></pre><ul class=""><li id="94bd" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">AWS SDK和文件加密模块将可用于NodeJS</li></ul><pre class="km kn ko kp gt nm nn no np aw nq bi"><span id="677f" class="kx ky iq nn b gy nr ns l nt nu">//to encrypt files<br/>var encryptor = require('file-encryptor');</span><span id="1a4d" class="kx ky iq nn b gy nv ns l nt nu">//to read the file<br/>var fs <strong class="nn ir">=</strong> require('fs');</span><span id="e112" class="kx ky iq nn b gy nv ns l nt nu">//to upload, delete and download from s3 bucket<br/>var AWS <strong class="nn ir">=</strong> require(‘aws-sdk/dist/aws-sdk-react-native’);</span></pre><ul class=""><li id="f916" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">当依赖项准备就绪时，在节点应用程序的源文件夹中创建<code class="fe nw nx ny nn b">aws-sdk.config.json</code>。注意:不要在根目录中创建<code class="fe nw nx ny nn b">aws-sdk.config.json</code>,因为一旦运行docker命令，docker将不会包含根目录配置文件。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nz"><img src="../Images/078c636a65b75c53c7c1c9a4877c21d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-FtUNu0ilFf77iTbEy7fw.png"/></div></div></figure><ul class=""><li id="6979" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">在这个配置中，我们只保留区域细节。其他键从命令行或dot-env文件传递。</li><li id="05d4" class="lq lr iq jp b jq mb ju mc jy md kc me kg mf kk nl ly lz ma bi translated">现在在utils中创建一个<strong class="jp ir"> encryption.js </strong>文件，并使用下面的代码进行加密和解密。该文件将在上传和下载之前加密和解密S3桶内容。</li></ul><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><ul class=""><li id="ada8" class="lq lr iq jp b jq jr ju jv jy ni kc nj kg nk kk nl ly lz ma bi translated">创建一个文件<strong class="jp ir"> upload.js </strong>负责将文件上传到S3桶。该文件将使用上述<strong class="jp ir"> encryption.js </strong>文件对内容进行加密和解密。</li></ul><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="5d34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">内联2，我们正在加载AWS SDK并检查区域。第16行export.putObject调用<strong class="jp ir"> encryption.j </strong> s文件，加密数据，上传到S3桶。</p><p id="7ebd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来编写最后一个函数，将文件上传到S3桶<code class="fe nw nx ny nn b">uploadFilesins3BucketHandler</code>。这个函数使用一个节点<code class="fe nw nx ny nn b">fs module</code>来读取文件。请参见下面的代码块。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="c93d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将下载该文件。对于下载，首先我们需要使用相同的密码设置进行解密</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="b37f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">删除文件非常简单，只需传递存储桶和文件细节</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="01ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论:</strong>我们已经学会了使用S3控制台、创建KMS密钥或我们自己的CMK密钥来创建S3存储桶和文件夹。我们还看到了如何加密文件数据并将其上传到S3存储桶。下面是一些有用的参考资料和文档。</p><p id="7ceb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><p id="2d21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nh" href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#master_keys" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/kms/latest/developer guide/concepts . html # master _ keys</a></p><p id="ca54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nh" href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying.html#key-policy-modifying-external-accounts" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/kms/latest/developer guide/key-policy-modificing . html # key-policy-modificing-external-accounts</a></p><div class="oc od gp gr oe of"><a href="https://docs.aws.amazon.com/general/latest/gr/aws-security-credentials.html" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd ir gy z fp ok fr fs ol fu fw ip bi translated">AWS安全凭据</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">当您与AWS交互时，您指定您的AWS安全凭证来验证您是谁以及您是否拥有…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div></div></div>    
</body>
</html>