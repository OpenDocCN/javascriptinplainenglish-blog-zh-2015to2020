<html>
<head>
<title>Angular HTTP Client — Configuring Requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular HTTP客户端—配置请求</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/angular-http-client-configuring-requests-9bf902671c7f?source=collection_archive---------5-----------------------#2020-04-29">https://javascript.plainenglish.io/angular-http-client-configuring-requests-9bf902671c7f?source=collection_archive---------5-----------------------#2020-04-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/770d81b3092714eb3d838bb4f2bdf7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X6WWp0_UwWbj69zY"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@brucej6767?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Bruce Jastrow</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1629" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Angular是Google制作的一个流行的前端框架。像其他流行的前端框架一样，它使用基于组件的架构来构建应用程序。</p><p id="c402" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何配置Angular HTTP客户端来发出我们想要的请求。</p><h1 id="5d8a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">URL查询字符串</h1><p id="33ce" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">HttpParams</code>类将URL查询字符串添加到我们的<code class="fe me mf mg mh b">HtttpRequest</code>中。</p><p id="1286" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以编写以下代码来从Unsplash API获得响应:</p><p id="05fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.module.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f3d3" class="mq lc iq mh b gy mr ms l mt mu">import { BrowserModule } from "@angular/platform-browser";<br/>import { NgModule } from "@angular/core";<br/>import { HttpClientModule } from "@angular/common/http";<br/>import { AppComponent } from "./app.component";</span><span id="757b" class="mq lc iq mh b gy mv ms l mt mu">@NgModule({<br/>  declarations: [AppComponent],<br/>  imports: [BrowserModule, HttpClientModule],<br/>  providers: [],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule {}</span></pre><p id="2b72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.component.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0daa" class="mq lc iq mh b gy mr ms l mt mu">import { Component } from "<a class="ae kc" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>";<br/>import { HttpClient, HttpParams } from "<a class="ae kc" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http";</span><span id="75c8" class="mq lc iq mh b gy mv ms l mt mu"><a class="ae kc" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: "app-root",<br/>  templateUrl: "./app.component.html",<br/>  styleUrls: ["./app.component.css"]<br/>})<br/>export class AppComponent {<br/>  constructor(private http: HttpClient) {}</span><span id="a926" class="mq lc iq mh b gy mv ms l mt mu">  ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="daee" class="mq lc iq mh b gy mv ms l mt mu">  getPhotos() {<br/>    const options = {<br/>      params: new HttpParams()<br/>        .set("page", "1")<br/>        .set(<br/>          "client_id",<br/>          "your_unsplash_api_key"<br/>        )<br/>        .set("query", "photo")<br/>    };</span><span id="fff2" class="mq lc iq mh b gy mv ms l mt mu">    this.http<br/>      .get("https://api.unsplash.com/search/photos", options)<br/>      .subscribe(res =&gt; console.log(res));<br/>  }<br/>}</span></pre><p id="341e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们创建了一个新的<code class="fe me mf mg mh b">HttpParams</code>对象并调用实例上的<code class="fe me mf mg mh b">set</code>方法来添加一个新的查询字符串参数。</p><p id="9a76" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用传递了<code class="fe me mf mg mh b">options</code>对象的<code class="fe me mf mg mh b">get</code>方法发出GET请求，设置查询字符串。</p><h1 id="7d02" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用<code class="fe me mf mg mh b">fromString</code>创建HttpParams</h1><p id="a09d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们也可以从字符串中为<code class="fe me mf mg mh b">HttpParams</code>创建查询。</p><p id="4496" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们可以编写以下代码:</p><p id="1e8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.component.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="212d" class="mq lc iq mh b gy mr ms l mt mu">import { Component } from "@angular/core";<br/>import { HttpClient, HttpParams } from "@angular/common/http";</span><span id="24fb" class="mq lc iq mh b gy mv ms l mt mu">@Component({<br/>  selector: "app-root",<br/>  templateUrl: "./app.component.html",<br/>  styleUrls: ["./app.component.css"]<br/>})<br/>export class AppComponent {<br/>  constructor(private http: HttpClient) {}</span><span id="6f94" class="mq lc iq mh b gy mv ms l mt mu">  ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="da72" class="mq lc iq mh b gy mv ms l mt mu">  getPhotos() {<br/>    const options = {<br/>      params: new HttpParams({<br/>        fromString:<br/>          "page=1&amp;client_id=your_unsplash_api_key&amp;query=photo"<br/>      })<br/>    };</span><span id="dc3e" class="mq lc iq mh b gy mv ms l mt mu">    this.http<br/>      .get("https://api.unsplash.com/search/photos", options)<br/>      .subscribe(res =&gt; console.log(res));<br/>  }<br/>}</span></pre><p id="83d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们将整个查询字符串作为属性<code class="fe me mf mg mh b">fromString</code>的值传入。</p><h1 id="343d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">去抖请求</h1><p id="4541" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用Rxjs <code class="fe me mf mg mh b">debouceTime</code>操作符将请求延迟我们指定的时间。</p><p id="73e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="0374" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.component.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8dbe" class="mq lc iq mh b gy mr ms l mt mu">import { Component } from "@angular/core";<br/>import { HttpClient, HttpParams } from "@angular/common/http";<br/>import { debounceTime, distinctUntilChanged } from "rxjs/operators";</span><span id="4d95" class="mq lc iq mh b gy mv ms l mt mu">@Component({<br/>  selector: "app-root",<br/>  templateUrl: "./app.component.html",<br/>  styleUrls: ["./app.component.css"]<br/>})<br/>export class AppComponent {<br/>  constructor(private http: HttpClient) {}</span><span id="2cc5" class="mq lc iq mh b gy mv ms l mt mu">  ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="9fcc" class="mq lc iq mh b gy mv ms l mt mu">  getPhotos() {<br/>    const options = {<br/>      params: new HttpParams({<br/>        fromString:<br/>          "page=1&amp;client_id=your_unsplash_api_key&amp;query=photo"<br/>      })<br/>    };</span><span id="4128" class="mq lc iq mh b gy mv ms l mt mu">    this.http<br/>      .get("https://api.unsplash.com/search/photos", options)<br/>      .pipe(<br/>        debounceTime(500),<br/>        distinctUntilChanged()<br/>      )<br/>      .subscribe(res =&gt; console.log(res));<br/>  }<br/>}</span></pre><p id="d28a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们使用<code class="fe me mf mg mh b">pipe</code>方法应用<code class="fe me mf mg mh b">debounceTime</code>操作符将请求延迟500毫秒。</p><p id="8425" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们通过使用<code class="fe me mf mg mh b">distinctUntilChanged</code>操作符，从<code class="fe me mf mg mh b">get</code>可观察值中发出值。</p><h1 id="93b8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">监听进度事件</h1><p id="6b35" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过将<code class="fe me mf mg mh b">reportProgress</code>选项设置为<code class="fe me mf mg mh b">true</code>来监听请求的进度。</p><p id="347d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以监听如下进度事件:</p><p id="8139" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.component.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3da6" class="mq lc iq mh b gy mr ms l mt mu">import { Component } from "@angular/core";<br/>import { HttpClient, HttpParams, HttpRequest } from "@angular/common/http";<br/>import {<br/>  debounceTime,<br/>  distinctUntilChanged,<br/>  last,<br/>  tap,<br/>  map<br/>} from "rxjs/operators";</span><span id="d19f" class="mq lc iq mh b gy mv ms l mt mu">@Component({<br/>  selector: "app-root",<br/>  templateUrl: "./app.component.html",<br/>  styleUrls: ["./app.component.css"]<br/>})<br/>export class AppComponent {<br/>  constructor(private http: HttpClient) {}</span><span id="5a38" class="mq lc iq mh b gy mv ms l mt mu">  ngOnInit() {<br/>    this.getPhotos();<br/>  }</span><span id="3e86" class="mq lc iq mh b gy mv ms l mt mu">  getPhotos() {<br/>    const options = {<br/>      params: new HttpParams({<br/>        fromString:<br/>          "page=1&amp;client_id=your_unsplash_api_key&amp;query=photo"<br/>      }),<br/>      reportProgress: true<br/>    };</span><span id="2b02" class="mq lc iq mh b gy mv ms l mt mu">    const req = new HttpRequest(<br/>      "GET",<br/>      "https://api.unsplash.com/search/photos",<br/>      {},<br/>      options<br/>    );</span><span id="10db" class="mq lc iq mh b gy mv ms l mt mu">    this.http<br/>      .request(req)<br/>      .pipe(<br/>        map(event =&gt; console.log(event)),<br/>        tap(message =&gt; console.log(message)),<br/>        last()<br/>      )<br/>      .subscribe(res =&gt; console.log(res));<br/>  }<br/>}</span></pre><p id="5a5f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们调用了<code class="fe me mf mg mh b">request</code>方法来发出请求。</p><p id="4efa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该方法接受一个<code class="fe me mf mg mh b">HttpRequest</code>对象，该对象将HTTP请求方法作为第一个参数，第二个是URL，第三个是有效负载，第四个是选项。</p><p id="6b48" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe me mf mg mh b">reportProgress</code>添加到选项对象中。</p><p id="7edf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后为了获得进度，我们使用<code class="fe me mf mg mh b">tap</code>操作符来记录进度。</p><p id="6adc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们会得到这样的结果:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5a9a" class="mq lc iq mh b gy mr ms l mt mu">{type: 3, loaded: 65536, total: 72147}</span></pre><p id="7119" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中<code class="fe me mf mg mh b">loaded</code>是加载的字节数。<code class="fe me mf mg mh b">total</code>是加载的总字节数。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/ea1556e1c1468bf68280adfa5dafa9d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yArVN3AMCLaFk6nm"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@noah2199?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Noah Rosenfield</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="d91d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安全性:XSRF保护</h1><p id="5098" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">跨站点请求伪造(XSRF)是一种攻击，攻击者欺骗经过身份验证的用户在不知情的情况下在网站上运行操作。</p><p id="729d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">HttpClient</code>有内置的XSRF保护机制来防止这些攻击。</p><p id="b342" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它用XSRF令牌设置请求头中的<code class="fe me mf mg mh b">X-XSRF-TOKEN</code>。</p><p id="c922" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务器端应用程序可以验证XSRF令牌是否正确，这样攻击者就无法伪装成合法用户发出请求。</p><h1 id="984b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">配置自定义XSRF Cookie/标头名称</h1><p id="4ab5" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以更改XSRF cookie或头名称。通过将<code class="fe me mf mg mh b">HttpClientXsrfModule.withOptions()</code>添加到我们应用程序的<code class="fe me mf mg mh b">NgModule</code>的<code class="fe me mf mg mh b">imports</code>数组中。</p><p id="27b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="50b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">app.module.ts</code>:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c980" class="mq lc iq mh b gy mr ms l mt mu">import { BrowserModule } from "@angular/platform-browser";<br/>import { NgModule } from "@angular/core";<br/>import { HttpClientModule, HttpClientXsrfModule } from "@angular/common/http";<br/>import { AppComponent } from "./app.component";</span><span id="27cf" class="mq lc iq mh b gy mv ms l mt mu">@NgModule({<br/>  declarations: [AppComponent],<br/>  imports: [<br/>    BrowserModule,<br/>    HttpClientModule,<br/>    HttpClientXsrfModule.withOptions({<br/>      cookieName: "My-Xsrf-Cookie",<br/>      headerName: "My-Xsrf-Header"<br/>    })<br/>  ],<br/>  providers: [],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule {}</span></pre><p id="b713" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码中，我们将XSRF cookie的键改为<code class="fe me mf mg mh b">My-Xsrf-Cookie</code>，将XSRF头的键改为<code class="fe me mf mg mh b">My-Xsrf-Header</code>。</p><h1 id="26a9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="18cd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">HttpParams</code>对象来设置请求的查询字符串。</p><p id="33e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了消除请求的抖动，我们可以使用<code class="fe me mf mg mh b">debounceTime</code>操作符来延迟请求。</p><p id="5d63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用Angular的HTTP客户端，我们还可以通过将<code class="fe me mf mg mh b">reportProgress</code>选项设置为<code class="fe me mf mg mh b">true</code>来监听请求的进度。</p><p id="e43d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Angular的HTTP客户端内置了XSRF保护来保护请求。</p><h2 id="77d1" class="mq lc iq bd ld mx my dn lh mz na dp ll ko nb nc lp ks nd ne lt kw nf ng lx nh bi translated"><strong class="ak">用简单英语写的JavaScript笔记</strong></h2><p id="5fbe" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们已经推出了三种新的出版物！请关注我们的新出版物:<a class="ae kc" href="https://medium.com/ai-in-plain-english" rel="noopener"><strong class="kf ir">AI in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/ux-in-plain-english" rel="noopener"><strong class="kf ir">UX in Plain English</strong></a>，<a class="ae kc" href="https://medium.com/python-in-plain-english" rel="noopener"><strong class="kf ir">Python in Plain English</strong></a><strong class="kf ir"/>——谢谢，继续学习！</p><p id="9a89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也一直有兴趣帮助推广高质量的内容。如果您有一篇文章想要提交给我们的任何出版物，请发送电子邮件至<a class="ae kc" href="mailto:submissions@plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">submissions @ plain English . io</strong></a><strong class="kf ir"/>，并附上您的Medium用户名，我们会将您添加为作者。另外，请让我们知道您想加入哪个/哪些出版物。</p></div></div>    
</body>
</html>