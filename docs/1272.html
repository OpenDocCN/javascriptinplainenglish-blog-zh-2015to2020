<html>
<head>
<title>How the new ‘Top Level Await’ feature works in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript中新的“顶级等待”特性是如何工作的</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-top-level-await-in-a-nutshell-4e352b3fc8c8?source=collection_archive---------1-----------------------#2020-02-23">https://javascript.plainenglish.io/javascript-top-level-await-in-a-nutshell-4e352b3fc8c8?source=collection_archive---------1-----------------------#2020-02-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8ef3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">简短、有用的JavaScript课程——让它变得简单。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/12d06bfd605bebef9e6d708582a7427e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pct48neOTBFhjsQHYYoTLw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by John Petalcurin</figcaption></figure><p id="04b9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以前，为了使用await，代码需要位于标记为async的函数中。这意味着您不能在任何函数符号之外使用await。顶级await使模块能够像异步函数一样工作。</p><p id="a8de" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模块是异步的，有导入和导出，这些也在顶层表达。这实际上意味着，如果你想提供一个依赖于一些异步任务的模块来做一些事情，你真的没有什么好的选择。</p><p id="555c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">顶级await解决了这个问题，并使开发人员能够在异步函数之外使用await关键字。使用顶级await，<strong class="kx ir"> </strong> ECMAScript模块可以等待资源，导致导入它们的其他模块在开始评估它们的主体之前等待，或者如果模块加载失败，您也可以使用它作为加载依赖项的后备，或者使用它来加载下载的第一个资源。</p><p id="bd28" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意事项:</p><ul class=""><li id="3eaf" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">顶层等待<strong class="kx ir">只在模块</strong>的顶层工作。不支持经典脚本或非异步函数。</li><li id="9817" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">在撰写本文时(2020年2月23日)，ECMAScript阶段3。</li></ul><h1 id="e740" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">用例</h1><p id="6837" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">使用顶级await，下一个代码在模块中的工作方式与您预期的一样</p><h1 id="06af" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">1.如果模块加载失败，使用回退</h1><p id="d557" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">以下示例尝试从first.com加载JavaScript模块，如果失败，则返回:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="e6b4" class="nh mg iq nd b gy ni nj l nk nl">//module.mjs</span><span id="26c0" class="nh mg iq nd b gy nm nj l nk nl">let <a class="ae nn" href="https://first.com/libs.com/lib1'" rel="noopener ugc nofollow" target="_blank">module</a>;</span><span id="aa58" class="nh mg iq nd b gy nm nj l nk nl">try {<br/>  <a class="ae nn" href="https://first.com/libs.com/lib1'" rel="noopener ugc nofollow" target="_blank">module</a>= await import('<a class="ae nn" href="https://first.com/libs.com/lib1'" rel="noopener ugc nofollow" target="_blank">https://first.com/libs.com/module1'</a>);<br/>} catch {<br/>  <a class="ae nn" href="https://first.com/libs.com/lib1'" rel="noopener ugc nofollow" target="_blank">module</a>= await import('<a class="ae nn" href="https://second.com/libs/lib1'" rel="noopener ugc nofollow" target="_blank">https://second.com/libs/</a><a class="ae nn" href="https://first.com/libs.com/lib1'" rel="noopener ugc nofollow" target="_blank">module1</a><a class="ae nn" href="https://second.com/libs/lib1'" rel="noopener ugc nofollow" target="_blank">'</a>);<br/>}</span></pre><h1 id="ffce" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">2.使用加载最快的资源</h1><p id="e3c1" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">在这里，res变量通过先完成下载的变量进行初始化。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="22a5" class="nh mg iq nd b gy ni nj l nk nl">//module.mjs</span><span id="e7ca" class="nh mg iq nd b gy nm nj l nk nl">const resPromises = [    <br/>    donwloadFromResource1Site,<br/>    donwloadFromResource2Site<br/> ];</span><span id="9721" class="nh mg iq nd b gy nm nj l nk nl">const res = await Promise.any(resPromises);</span></pre><h1 id="501e" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">3.资源初始化</h1><p id="13ec" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">顶级await允许您在模块中等待承诺，就像它们被包装在异步函数中一样。例如，这对于执行应用程序初始化非常有用:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="d1b8" class="nh mg iq nd b gy ni nj l nk nl">//module.mjs</span><span id="3cb8" class="nh mg iq nd b gy nm nj l nk nl">import { dbConnector} from './dbUtils.js'</span><span id="674e" class="nh mg iq nd b gy nm nj l nk nl">//connect() return a promise.<br/>const connection = await dbConnector.connect();</span><span id="e0df" class="nh mg iq nd b gy nm nj l nk nl">export default function(){connection.list()}</span></pre><h1 id="5b3b" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">4.动态加载模块</h1><p id="0b4c" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">这允许模块使用运行时值来确定依赖性。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="c784" class="nh mg iq nd b gy ni nj l nk nl">//module.mjs</span><span id="ad94" class="nh mg iq nd b gy nm nj l nk nl">const params = new URLSearchParams(window.location.search);<br/>const lang = params.get('lang');<br/>const messages = await import(`./messages-${lang}.mjs`);</span></pre><h1 id="e1cf" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">5.在DevTools中使用await外部异步函数？</h1><p id="a02a" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">在使用async/await之前，试图在异步函数之外使用await会导致“语法错误:await仅在异步函数中有效”现在，您可以在异步函数中不使用它的情况下使用它。</p><p id="c02a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这已经在chrome 80和firefox 72.0.2 <strong class="kx ir"> DevTools </strong>中测试过了。然而，这个功能是非标准的，在nodejs中不起作用。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="5576" class="nh mg iq nd b gy ni nj l nk nl">const helloPromise = new Promise((resolve)=&gt;{<br/>  setTimeout(()=&gt; resolve('Hello world!'), 5000);<br/>})</span><span id="690e" class="nh mg iq nd b gy nm nj l nk nl">const result =  await helloPromise;console.log(result);</span><span id="448b" class="nh mg iq nd b gy nm nj l nk nl">//5 seconds later...:<br/>//Hello world!</span></pre><h1 id="b74f" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">履行</h1><ul class=""><li id="7ba3" class="lr ls iq kx b ky mx lb my le no li np lm nq lq lw lx ly lz bi translated">带旗帜的V8发动机:— —和谐——顶级——等待</li><li id="3f1d" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">web pack(5 . 0 . 0中的实验性支持)</li><li id="f3d8" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">Babel(<a class="ae nn" href="https://babeljs.io/docs/en/babel-plugin-syntax-top-level-await" rel="noopener ugc nofollow" target="_blank">Babel/plugin-syntax-top-level-await</a>)增加了解析器支持。</li></ul><h1 id="9fd4" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">参考</h1><ul class=""><li id="fae6" class="lr ls iq kx b ky mx lb my le no li np lm nq lq lw lx ly lz bi translated"><a class="ae nn" href="https://github.com/bmeck/top-level-await-talking/" rel="noopener ugc nofollow" target="_blank">https://github.com/bmeck/top-level-await-talking/</a></li><li id="f199" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><a class="ae nn" href="https://github.com/tc39/proposal-top-level-await#use-cases" rel="noopener ugc nofollow" target="_blank">https://github.com/tc39/proposal-top-level-await#use-cases</a></li></ul><p id="10e4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢你阅读我！！</p></div></div>    
</body>
</html>