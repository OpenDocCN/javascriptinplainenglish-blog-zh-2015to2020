<html>
<head>
<title>Restify — Error Handling with Restify-Errors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Restify-使用Restify-Errors进行错误处理</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/restify-error-handling-with-restify-errors-ce3770526802?source=collection_archive---------6-----------------------#2020-12-01">https://javascript.plainenglish.io/restify-error-handling-with-restify-errors-ce3770526802?source=collection_archive---------6-----------------------#2020-12-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/25641245f625560f701a4fb219c2ca7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vlY-o4cCEfA1WpLU"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@jackson_893?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Michael Geiger</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dccf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Restify是一个简单的节点后端框架。</p><p id="dd41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用Restify格式化错误消息。</p><h1 id="df47" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">格式错误</h1><p id="85ff" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用错误处理程序格式化错误。</p><p id="31d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a440" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var errors = require('restify-errors');</span><span id="7eae" class="mn lc iq mj b gy ms mp l mq mr">var server = restify.createServer();</span><span id="6bbf" class="mn lc iq mj b gy ms mp l mq mr">server.get('/hello/:foo', function(req, res, next) {<br/>  var err = new errors.InternalServerError('not found');<br/>  return next(err);<br/>});</span><span id="85e1" class="mn lc iq mj b gy ms mp l mq mr">server.on('InternalServer', function (req, res, err, cb) {<br/>  err.toString = function() {<br/>    return 'an internal server error occurred!';<br/>  };</span><span id="5e69" class="mn lc iq mj b gy ms mp l mq mr">  err.toJSON = function() {<br/>    return {<br/>      message: 'an internal server error occurred!',<br/>      code: 'error'<br/>    }<br/>  };</span><span id="dfed" class="mn lc iq mj b gy ms mp l mq mr">  return cb();<br/>});</span><span id="0d1d" class="mn lc iq mj b gy ms mp l mq mr">server.on('restifyError', function (req, res, err, cb) {<br/>  return cb();<br/>});</span><span id="4431" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="47ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有带<code class="fe mt mu mv mj b">toString</code>和<code class="fe mt mu mv mj b">toJSON</code>方法的<code class="fe mt mu mv mj b">InternalServer</code>处理程序来格式化字符串和JSON错误。</p><p id="09dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">restifyError</code>错误处理器有错误处理器。</p><p id="2d77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以为其他内容类型创建格式化程序。</p><p id="22a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c2ff" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var errors = require('restify-errors');</span><span id="7b38" class="mn lc iq mj b gy ms mp l mq mr">const server = restify.createServer({<br/>  formatters: {<br/>    ['text/html'](req, res, body) {<br/>      if (body instanceof Error) {        <br/>        return `&lt;html&gt;&lt;body&gt;${body.message}&lt;/body&gt;&lt;/html&gt;`;<br/>      }<br/>    }<br/>  }<br/>});</span><span id="83fa" class="mn lc iq mj b gy ms mp l mq mr">server.get('/', function(req, res, next) {<br/>  res.header('content-type', 'text/html');<br/>  return next(new errors.InternalServerError('error!'));<br/>});</span><span id="67a9" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="a517" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为<code class="fe mt mu mv mj b">text/html</code>内容类型创建一个内容格式化程序。</p><h1 id="1755" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">重新定义-错误</h1><p id="912d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe mt mu mv mj b">restify-errors</code>模块为许多常见的HTTP请求和REST相关错误公开了一套错误压缩程序。</p><p id="881f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以通过编写以下内容来创建错误:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fc5c" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var errors = require('restify-errors');</span><span id="178e" class="mn lc iq mj b gy ms mp l mq mr">const server = restify.createServer();</span><span id="9f54" class="mn lc iq mj b gy ms mp l mq mr">server.get('/', function(req, res, next) {<br/>  return next(new errors.ConflictError("conflict"));<br/>});</span><span id="334a" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="d9e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们转到<code class="fe mt mu mv mj b">http://localhost:8080</code>时，我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0db5" class="mn lc iq mj b gy mo mp l mq mr">{"code":"Conflict","message":"conflict"}</span></pre><p id="87db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以将Restify错误作为参数<code class="fe mt mu mv mj b">res.send</code>传入。</p><p id="fbd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6885" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var errors = require('restify-errors');</span><span id="f83f" class="mn lc iq mj b gy ms mp l mq mr">const server = restify.createServer();</span><span id="fd96" class="mn lc iq mj b gy ms mp l mq mr">server.get('/', function(req, res, next) {<br/>  res.send(new errors.GoneError('gone'));<br/>  return next();<br/>});</span><span id="33a4" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="22b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe mt mu mv mj b">GoneError</code>实例传递给<code class="fe mt mu mv mj b">res.send</code>方法。</p><p id="6ab0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们转到<code class="fe mt mu mv mj b">http://localhost:8080</code>时，我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="669a" class="mn lc iq mj b gy mo mp l mq mr">{"code":"Gone","message":"gone girl"}</span></pre><p id="ec2d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">JSON的自动序列化是通过调用<code class="fe mt mu mv mj b">Error</code>对象上的<code class="fe mt mu mv mj b">JSON.stringify</code>来完成的。</p><p id="30ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们都定义了<code class="fe mt mu mv mj b">toJSON</code>方法。</p><p id="d886" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果对象没有定义<code class="fe mt mu mv mj b">toJSON</code>方法，那么我们将得到一个空对象。</p><h2 id="e2ce" class="mn lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated">HttpError</h2><p id="36a4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe mt mu mv mj b">HttpError</code>是一个普通的HTTP错误，我们可以用<code class="fe mt mu mv mj b">statusCode</code>和<code class="fe mt mu mv mj b">body</code>属性返回。</p><p id="7cdd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">statusCode</code>将自动设置HTTP状态码，<code class="fe mt mu mv mj b">body</code>默认设置为消息。</p><p id="e072" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">400错误500之间的所有状态代码被自动转换成一个<code class="fe mt mu mv mj b">HttpError</code>，名称为PascalCase格式，空格被删除。</p><h2 id="4bfc" class="mn lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated">RestError</h2><p id="b96e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Restify为我们提供了带有<code class="fe mt mu mv mj b">code</code>和<code class="fe mt mu mv mj b">message</code>属性的内置错误/</p><p id="79bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我们有:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8e7f" class="mn lc iq mj b gy mo mp l mq mr">var restify = require('restify');<br/>var errors = require('restify-errors');</span><span id="7ab5" class="mn lc iq mj b gy ms mp l mq mr">const server = restify.createServer();</span><span id="d43c" class="mn lc iq mj b gy ms mp l mq mr">server.get('/', function(req, res, next) {<br/>  return next(new errors.InvalidArgumentError("error"));<br/>});</span><span id="35af" class="mn lc iq mj b gy ms mp l mq mr">server.listen(8080);</span></pre><p id="06da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe mt mu mv mj b">restify-errors</code>可以创建任何400或500系列错误。</p><h1 id="498f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="054a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe mt mu mv mj b">restify-errors</code>创建错误对象。</p><p id="ed04" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们在响应中使用JSON，它们会自动序列化成JSON。</p><p id="f5db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>