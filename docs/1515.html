<html>
<head>
<title>Create Interactive Data Visualisations with Django &amp; Chart.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Django &amp; Chart.js创建交互式数据可视化</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-interactive-data-visualisations-with-django-chart-js-8c4d0b98770e?source=collection_archive---------1-----------------------#2020-03-26">https://javascript.plainenglish.io/create-interactive-data-visualisations-with-django-chart-js-8c4d0b98770e?source=collection_archive---------1-----------------------#2020-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/c65de14a60168f69aba2e7f123f8ff79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*ZQdm44AK9PQ86NYBAgmtOQ.gif"/></div></figure><div class=""/><div class=""><h2 id="a74c" class="pw-subtitle-paragraph ju iw ix bd b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl dk translated">如何用交互式图形可视化你的数据+奖金:异步香草JS！</h2></div><p id="ab5c" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在这个故事中，我将向你展示如何在<a class="ae li" href="https://www.chartjs.org/" rel="noopener ugc nofollow" target="_blank"> chart.js库</a>提供的漂亮图表中可视化你的数据。这些图表比你以前用<code class="fe lj lk ll lm b">matplotlib</code>创建的任何图表都要漂亮得多，而且它们可以被你的用户操作！</p><p id="a429" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">另外，我想借此机会尝试一下异步javascript执行(AJAX)，这次使用普通JS <code class="fe lj lk ll lm b">XMLHttpRequest</code>。</p><p id="b02e" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">我们今天要讲的内容:</p><ul class=""><li id="18a8" class="ln lo ix ko b kp kq ks kt kv lp kz lq ld lr lh ls lt lu lv bi translated">用<code class="fe lj lk ll lm b">XMLHttpRequest</code>、Django的<code class="fe lj lk ll lm b">JsonResponse</code>和<code class="fe lj lk ll lm b">FormData</code>对象发送和捕捉异步响应。</li><li id="787b" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">为图表设置标签、值和颜色。</li><li id="a490" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">创建圆环图、条形图和折线图。</li><li id="f275" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">提供用户反馈。</li></ul><p id="6be8" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">让我们从HTML表单开始&gt;用JS处理到后端&gt;返回响应&gt;捕捉响应并显示结果和反馈。在这个项目中，我们将使用Twitter上的两个辱骂性语言数据集，这也是我在硕士论文中使用的。</p><h2 id="f904" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated"><strong class="ak">异步请求</strong></h2><figure class="mv mw mx my gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mu"><img src="../Images/2218ea148e6c9940b6a912e9aab3b7d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcYhCkmWjHwq0vrtBa93gQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">HTML form with radio buttons for selecting various datasets</figcaption></figure><p id="846d" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了向我们的后端发送一个异步Javascript请求，我们将创建一个普通的HTML表单，并阻止提交和重新加载网页的默认响应。然后我们将创建一个<code class="fe lj lk ll lm b">FormData</code>对象，并通过Javascript将其发送到Django后端。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="93f2" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">这个表单中没有submit按钮，所以我们必须添加一个<code class="fe lj lk ll lm b">addEventListener</code>，当一个指定的事件<code class="fe lj lk ll lm b">click</code>被传递到目标<code class="fe lj lk ll lm b">input</code>时，它会进行注册。然后，我们将在一个<code class="fe lj lk ll lm b">FormData</code>键值对象中收集表单字段，并通过<code class="fe lj lk ll lm b">XMLHttpRequest</code>将其发送到Django后端。所有这些都是用普通的Javascript完成的。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="40ed" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在某种程度上是伪代码:</p><ul class=""><li id="b417" class="ln lo ix ko b kp kq ks kt kv lp kz lq ld lr lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 2-3</code>我们在等待点击一个带有<code class="fe lj lk ll lm b">class="form-check-input dataset"</code>的HTML元素</li><li id="998d" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 4–5</code>我们获取HTML表单元素并创建一个键值对象。</li><li id="fd91" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 7-9</code>我们用表单方法<code class="fe lj lk ll lm b">POST</code>和动作或url打开一个新请求，并将我们的键值对象发送到Django后端。</li></ul><h2 id="89c3" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated">Django后端</h2><p id="cddc" class="pw-post-body-paragraph km kn ix ko b kp nj jy kr ks nk kb ku kv nl kx ky kz nm lb lc ld nn lf lg lh ij bi translated">我们将在这里准备和转换数据，并为返回一个充满数据的响应做好一切准备。我们还将通过一条消息提供一些用户反馈。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="534e" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">当我们用一个<code class="fe lj lk ll lm b">GET</code>方法访问这个路由时，我们只是显示包含HTML表单的模板<code class="fe lj lk ll lm b">demographics.html</code>，但是当我们用一个<code class="fe lj lk ll lm b">POST</code>访问这个视图时，我们将准备我们的数据并发送一个<code class="fe lj lk ll lm b">JsonResponse</code>。<code class="fe lj lk ll lm b">line 15-19</code>是我们为图表准备数据的地方。<code class="fe lj lk ll lm b">line 19-20</code>是我们使用Django的<code class="fe lj lk ll lm b">render_to_string</code>的地方，它使我们能够将带有变量的<code class="fe lj lk ll lm b">jinja2</code>模板加载到字符串中。第三个参数是<code class="fe lj lk ll lm b">context</code>字典，从中我们可以像<code class="fe lj lk ll lm b">{{ tags }}</code>一样使用模板中的键。例如，模板<code class="fe lj lk ll lm b">includes/message.html</code>看起来像这样:</p><pre class="mv mw mx my gt no lm np nq aw nr bi"><span id="cfce" class="mb mc ix lm b gy ns nt l nu nv">&lt;li&gt;<br/>     &lt;div class="alert alert-{{ tags }} msg fade show" role="alert"&gt;{{ message }}&lt;/div&gt;<br/>&lt;/li&gt;</span></pre><p id="dcbc" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">还需要注意的是，我们发送了一个包含所有数据的字典<code class="fe lj lk ll lm b">response</code>，我们将在Javascript中提取两个部分。我们将这个字典转换成一个<code class="fe lj lk ll lm b">JSON</code>对象，然后用Javascript中的<code class="fe lj lk ll lm b">JSON.parse</code>方法将其解包。</p><h2 id="ab33" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated">数据准备</h2><p id="e634" class="pw-post-body-paragraph km kn ix ko b kp nj jy kr ks nk kb ku kv nl kx ky kz nm lb lc ld nn lf lg lh ij bi translated">为了展示我们如何准备数据，我选择了三个函数<code class="fe lj lk ll lm b">hashtag_demographics</code>、<code class="fe lj lk ll lm b">creation_date_demographics</code>和<code class="fe lj lk ll lm b">text_demographics</code>。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="29ff" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">最有趣的要点和代码片段是:</p><ul class=""><li id="7830" class="ln lo ix ko b kp kq ks kt kv lp kz lq ld lr lh ls lt lu lv bi translated">Chart.js期望它的图表有三个列表:一个列表<code class="fe lj lk ll lm b">labels</code>、一个列表<code class="fe lj lk ll lm b">values</code>和一个列表<code class="fe lj lk ll lm b">colours</code>(十六进制代码)。我们使用带有<code class="fe lj lk ll lm b">*</code>的<code class="fe lj lk ll lm b">zip</code>函数来遍历元组列表<code class="fe lj lk ll lm b">[(label, value), (label value)]</code>。</li><li id="8850" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">对于配色方案，我们使用的是<code class="fe lj lk ll lm b">seaborn</code>套装，它带有几套漂亮的<a class="ae li" href="https://seaborn.pydata.org/tutorial/color_palettes.html" rel="noopener ugc nofollow" target="_blank">调色板</a>。</li><li id="f7ea" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">对于时间序列，我们需要将Python的<code class="fe lj lk ll lm b">datetime</code>对象转换成Javascript的<code class="fe lj lk ll lm b">Date</code>对象，我们在<code class="fe lj lk ll lm b">line 44</code>中完成了这项工作。</li><li id="dcc1" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 62-69</code>将tweet内容矢量化为tf-idf计数，这是除了计数矢量化之外的常见做法。</li></ul><h2 id="1c82" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated">JSON响应</h2><p id="1dc3" class="pw-post-body-paragraph km kn ix ko b kp nj jy kr ks nk kb ku kv nl kx ky kz nm lb lc ld nn lf lg lh ij bi translated">我们在<code class="fe lj lk ll lm b">demographics.py, line 33</code>中从Django后端发送的<code class="fe lj lk ll lm b">JsonResponse</code>应该是我们附加到<code class="fe lj lk ll lm b">send_request.js</code>中的另一个<code class="fe lj lk ll lm b">addEventListener</code>。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><ul class=""><li id="54b0" class="ln lo ix ko b kp kq ks kt kv lp kz lq ld lr lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 15</code>展示了我们如何捕捉响应对象并将它的JSON转换成一个对象，这使得来自Django对象的<code class="fe lj lk ll lm b">response</code>对象中的键和值是可访问的！</li><li id="f3fa" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 18-20</code>是我们如何将消息添加到HTML页面的<code class="fe lj lk ll lm b">messages-list</code>元素中。我正在使用一个自定义功能<code class="fe lj lk ll lm b">fade_alerts()</code>，它会在一段时间后淡出消息。</li><li id="1ee2" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated">我们如何将文本信息添加到网页中。</li><li id="a89d" class="ln lo ix ko b kp lw ks lx kv ly kz lz ld ma lh ls lt lu lv bi translated"><code class="fe lj lk ll lm b">line 29-36</code>展示了我们如何在<code class="fe lj lk ll lm b">returnCharts()</code>和<code class="fe lj lk ll lm b">showCharts()</code>函数中为我们的chart.js视觉效果提取<code class="fe lj lk ll lm b">values</code>、<code class="fe lj lk ll lm b">labels</code>和<code class="fe lj lk ll lm b">colours</code>，这将在下一节中解释。</li></ul><h2 id="8a8a" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated">Chart.js可视化</h2><p id="dfd1" class="pw-post-body-paragraph km kn ix ko b kp nj jy kr ks nk kb ku kv nl kx ky kz nm lb lc ld nn lf lg lh ij bi translated">为了简洁起见，我决定只包含时间序列折线图的脚本(和往常一样，完整的代码可以在底部找到)。<code class="fe lj lk ll lm b">get_time_config()</code>定义图表的配置，<code class="fe lj lk ll lm b">convertDates()</code>将日期列表转换为Javascript <code class="fe lj lk ll lm b">Date</code>对象，<code class="fe lj lk ll lm b">returnChart()</code>和<code class="fe lj lk ll lm b">showChart()</code>定义并显示图表。</p><figure class="mv mw mx my gt is"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="44e7" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><code class="fe lj lk ll lm b">line 67</code>很重要，因为它用<code class="fe lj lk ll lm b">id="time"</code>获取元素，并在<code class="fe lj lk ll lm b">line 70</code>中使用它将图表附加到该元素。该元素在<code class="fe lj lk ll lm b">demographics.py, line 20</code>的模板<code class="fe lj lk ll lm b">includes/demographics.html</code>中定义为<code class="fe lj lk ll lm b">&lt;canvas id="time"&gt;&lt;/canvas&gt;.</code></p><h2 id="a6e5" class="mb mc ix bd md me mf dn mg mh mi dp mj kv mk ml mm kz mn mo mp ld mq mr ms mt bi translated">结束了</h2><p id="634b" class="pw-post-body-paragraph km kn ix ko b kp nj jy kr ks nk kb ku kv nl kx ky kz nm lb lc ld nn lf lg lh ij bi translated">最后，我们将在<code class="fe lj lk ll lm b">request.js</code>中添加一点Javascript，当呈现模拟<code class="fe lj lk ll lm b">click</code>事件的视图时，它将被加载，这样人口统计数据将通过如上所示的相同路径被加载。</p><pre class="mv mw mx my gt no lm np nq aw nr bi"><span id="9eed" class="mb mc ix lm b gy ns nt l nu nv">var <strong class="lm iy"><em class="nw">hatEvalData </em></strong>= <strong class="lm iy"><em class="nw">document</em></strong>.getElementById("hateval_dataset");<br/><strong class="lm iy"><em class="nw">hatEvalData</em></strong>.click();</span></pre><p id="5fef" class="pw-post-body-paragraph km kn ix ko b kp kq jy kr ks kt kb ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">完整的代码和脚本可以在这里找到。此外，您可以在这里与这些图表的现场演示<a class="ae li" href="https://louisdebruijn.me/thesis/graphs" rel="noopener ugc nofollow" target="_blank">互动。</a></p><figure class="mv mw mx my gt is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/49a490813050860ae3f300cfe376cd20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*tQeZOeyaxa47vzB-EqbH7g.gif"/></div></figure></div></div>    
</body>
</html>