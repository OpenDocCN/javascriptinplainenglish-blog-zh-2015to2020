<html>
<head>
<title>Node.js Best Practices — Nginx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践— Nginx</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-best-practices-nginx-2f00b48b75e?source=collection_archive---------2-----------------------#2020-09-01">https://javascript.plainenglish.io/node-js-best-practices-nginx-2f00b48b75e?source=collection_archive---------2-----------------------#2020-09-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1654b366b6d0504065413374cd350809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hTPC0cx6reCoTeV3"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@rocinante_11?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mick Haupt</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6dd0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="1b80" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Nginx添加反向代理</h1><p id="cef6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们不应该将我们的Express应用程序直接暴露在互联网上。</p><p id="3377" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，我们应该使用反向代理将流量导向我们的应用程序。</p><p id="0e9c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，我们可以添加缓存，控制我们的流量，等等。</p><p id="dbd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过运行以下命令来安装它:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="25b9" class="mn lc iq mj b gy mo mp l mq mr">apt update<br/>apt install nginx</span></pre><p id="80ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过运行以下命令来启动它:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="acaa" class="mn lc iq mj b gy mo mp l mq mr">systemctl start nginx</span></pre><p id="0862" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们运行了Nginx，我们就可以进入<code class="fe ms mt mu mj b">/etc/nginx/nginx.conf</code>来改变Nginx配置以指向我们的应用。</p><p id="3329" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="af67" class="mn lc iq mj b gy mo mp l mq mr">server {<br/>  listen 80;<br/>  location / {<br/>     proxy_pass http://localhost:3000; <br/>  }<br/>}</span></pre><p id="fc1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe ms mt mu mj b">proxy_pass</code>指令将任何流量从端口80传递到我们的Express应用程序，该应用程序正在监听端口3000。</p><p id="ba21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们重新启动Nginx，通过运行以下命令使我们的配置生效:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8724" class="mn lc iq mj b gy mo mp l mq mr">systemctl restart nginx</span></pre><h1 id="cc72" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Nginx实现负载平衡</h1><p id="8c41" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要使用Nginx添加负载平衡，我们可以通过编写以下代码来编辑<code class="fe ms mt mu mj b">nginx.conf</code>:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c42f" class="mn lc iq mj b gy mo mp l mq mr">http {<br/>  upstream fooapp {<br/>    server localhost:3000;<br/>    server domain2;<br/>    server domain3;<br/>    ...<br/>  }<br/>  ...<br/>}</span></pre><p id="88b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加我们应用程序的实例。</p><p id="9233" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">upstream</code>部分创建了一个服务器组，它将在我们指定的服务器之间对流量进行负载平衡。</p><p id="dcae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe ms mt mu mj b">server</code>部分，我们添加:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="773e" class="mn lc iq mj b gy mo mp l mq mr">server {<br/>   listen 80;<br/>   location / {<br/>     proxy_pass http://fooapp;<br/>  }<br/>}</span></pre><p id="39d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe ms mt mu mj b">fooapp</code>服务器组。</p><p id="0bce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们用以下命令重新启动Nginx:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="facc" class="mn lc iq mj b gy mo mp l mq mr">systemctl restart nginx</span></pre><h1 id="7ca4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Nginx启用缓存</h1><p id="bd77" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了启用缓存，我们可以使用<code class="fe ms mt mu mj b">proxy_cache_path</code>指令。</p><p id="de11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe ms mt mu mj b">nginx.conf</code>中，我们写道:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d1a9" class="mn lc iq mj b gy mo mp l mq mr">http {<br/>  proxy_cache_path /data/nginx/cache levels=1:2   keys_zone=STATIC:10m<br/>  inactive=24h max_size=1g;<br/>  ...<br/>}</span></pre><p id="fdc3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们缓存24小时，最大缓存大小设置为1GB。</p><p id="6ae9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们补充:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="03bb" class="mn lc iq mj b gy mo mp l mq mr">server {<br/>   listen 80;<br/>   location / {<br/>     proxy_pass            http://fooapp;<br/>     proxy_set_header      Host $host;<br/>     proxy_buffering       on;<br/>     proxy_cache           STATIC;<br/>     proxy_cache_valid     200 1d;<br/>     proxy_cache_use_stale error timeout invalid_header updating<br/>            http_500 http_502 http_503 http_504;<br/>  }<br/>}</span></pre><p id="7b0e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">proxy_buffering</code>设置为<code class="fe ms mt mu mj b">on</code>以增加缓冲。</p><p id="9624" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">proxy_cache</code>被设置为<code class="fe ms mt mu mj b">STATIC</code>以启用缓存。</p><p id="115f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">proxy_cache_valid</code>将缓存设置为在1天后过期，状态代码为200。</p><p id="3e77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">proxy_cache_use_stale</code>确定在通信期间何时可以使用过时的缓存响应。</p><p id="005c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将它设置为在使用<code class="fe ms mt mu mj b">updating</code>关键字更新当前时出现超时错误、无效头错误时使用。</p><p id="8be0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果响应状态代码是500、502、503或504，我们也可以使用缓存。</p><h1 id="247e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Nginx启用Gzip压缩</h1><p id="b658" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过使用<code class="fe ms mt mu mj b">gzip</code>模块来启用Nginx的Gzip压缩。</p><p id="9af5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="bdeb" class="mn lc iq mj b gy mo mp l mq mr">server {<br/>   gzip on;<br/>   gzip_types      text/plain application/xml;<br/>   gzip_proxied    no-cache no-store private expired auth;<br/>   gzip_min_length 1000;<br/>  ...<br/>}</span></pre><p id="c327" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe ms mt mu mj b">nginx.conf</code>中，用<code class="fe ms mt mu mj b">gzip on</code>启用Gzip。</p><p id="2537" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">gzip_types</code>让我们将文件的MIME类型设置为zip。</p><p id="6294" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">gzip_proxied</code>让我们在代理请求上启用或禁用gzipping。</p><p id="b853" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe ms mt mu mj b">private</code>、<code class="fe ms mt mu mj b">expired</code>、<code class="fe ms mt mu mj b">no-cache</code>和<code class="fe ms mt mu mj b">no-store</code>、<code class="fe ms mt mu mj b">Cache-Control</code>头值启用它。</p><p id="4803" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">auth</code>表示如果请求头启用了授权字段，我们将启用压缩。</p><p id="3528" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">gzip_min_length</code>意味着我们设置将被压缩的响应的最小长度。</p><p id="9380" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">长度是<code class="fe ms mt mu mj b">Content-Length</code>响应头字段，以字节为单位。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/9e8d678d99ae7053b9c5135348656d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E5wqZE_jVBPuXKnk"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@zburival?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zbynek Burival</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="b881" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="c5a9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Nginx做很多事情来提高我们应用的性能。</p><h2 id="176d" class="mn lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated"><strong class="ak">简单英语的JavaScript</strong></h2><p id="18c1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">你知道我们有三份出版物和一个YouTube频道吗？在<a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">plain English . io</strong></a>找到所有内容的链接！</p></div></div>    
</body>
</html>