<html>
<head>
<title>Implementing Eureka and Zuul for Service Discovery and Dynamic Routing in JavaScript Microservices Running on Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js上运行的JavaScript微服务中实现服务发现和动态路由的Eureka和Zuul</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/implementing-eureka-and-zuul-for-service-discovery-and-dynamic-routing-in-javascript-microservices-45a7ac18837a?source=collection_archive---------1-----------------------#2019-12-05">https://javascript.plainenglish.io/implementing-eureka-and-zuul-for-service-discovery-and-dynamic-routing-in-javascript-microservices-45a7ac18837a?source=collection_archive---------1-----------------------#2019-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f3a55e114443e0f36d5e7e7c19fcb9b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w2zaqTS2kGUno0DH.png"/></div></div></figure><p id="bdc2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将您的JavaScript应用程序构建为一组微服务会给您带来很多好处。您的应用程序在构建时可以更加模块化、统一和可测试，当您将它们部署到生产环境时，它们可以更加健壮、可伸缩和可用。包含服务发现注册中心和动态路由功能将帮助您在生产中实现可伸缩性和可用性。</p><p id="0c35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将向您展示如何将服务发现和智能路由集成到使用微服务架构构建的Node.js应用程序中。您将看到如何通过运行在Java SE运行时环境中的两个网飞开源项目Eureka和Zuul来实现这一点。</p><p id="1095" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">网飞<a class="ae kw" href="https://github.com/Netflix/eureka/wiki" rel="noopener ugc nofollow" target="_blank">尤里卡</a>服务器提供服务发现。这使您的应用程序的服务能够找到其他服务，而无需知道它们托管在哪里或访问它们所需的完整URL，因此您不必为需要访问另一个服务的每个服务提供完整的URL。</p><p id="a34f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">网飞<a class="ae kw" href="https://github.com/Netflix/zuul/wiki" rel="noopener ugc nofollow" target="_blank"> Zuul </a>服务提供动态路由。在您的应用程序中使用Zuul使您的服务能够使用Eureka服务目录中的信息来访问其他服务。</p><p id="9b39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为Eureka和Zuul都是Java应用程序，它们可以用Java的<a class="ae kw" href="https://spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring框架</a>的一部分<a class="ae kw" href="https://spring.io/guides/gs/spring-boot/" rel="noopener ugc nofollow" target="_blank"> Spring Boot </a>来实现。使用Spring Boot，您可以将Java应用程序打包到Java归档文件中。jar)文件，该文件可以在<a class="ae kw" href="https://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html" rel="noopener ugc nofollow" target="_blank"> Java SE运行时环境</a>中运行。这使您能够轻松地将Node.js服务器与Eureka和Zuul一起部署在一个容器中。</p><p id="957c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Spring已经在<a class="ae kw" href="https://spring.io/projects/spring-cloud-netflix" rel="noopener ugc nofollow" target="_blank"> Spring云网飞</a>中为常见的使用场景构建了配置，包括使用Eureka的服务发现和使用Zuul的智能路由。的。jar文件是用Apache <a class="ae kw" href="https://maven.apache.org/" rel="noopener ugc nofollow" target="_blank"> Maven </a>使用项目对象模型(pom.xml)文件为<a class="ae kw" href="https://github.com/spring-guides/gs-service-registration-and-discovery/blob/master/complete/eureka-service/pom.xml" rel="noopener ugc nofollow" target="_blank">尤里卡</a>和<a class="ae kw" href="https://github.com/spring-guides/gs-routing-and-filtering/blob/master/complete/gateway/pom.xml" rel="noopener ugc nofollow" target="_blank"> Zuul </a>构建的，作为GitHub上<a class="ae kw" href="https://github.com/spring-guides" rel="noopener ugc nofollow" target="_blank"> Spring Guides </a>资源库的一部分。</p><h1 id="bdcf" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><p id="6916" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">为了完成这篇文章中的编程任务，你需要:</p><ul class=""><li id="24b4" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated"><a class="ae kw" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js和npm</a>(node . js安装也会安装NPM。)</li><li id="1bbd" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated"><a class="ae kw" href="https://www.java.com/en/download/" rel="noopener ugc nofollow" target="_blank"> Java SE运行时环境</a></li></ul><p id="ca17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要从这篇文章中最有效地学习，你应该具备以下条件:</p><ul class=""><li id="bfed" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">JavaScript和Node.js的工作知识</li><li id="3524" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">对HTTP协议的一些暴露</li></ul><p id="845a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">GitHub上有这篇文章的配套资源库<a class="ae kw" href="https://github.com/maciejtreder/introduction-to-microservices" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="a103" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建基本的JavaScript分布式系统</h1><p id="e5d1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果您已经完成了本系列的第一篇文章“用Node.js构建JavaScript微服务”中的项目，那么您可以继续使用您为那篇文章编写的代码:这篇文章的Node.js项目是在那个代码基础上构建的。如果你熟悉构建JavaScript微服务，或者想从头开始，可以从GitHub获取代码。</p><p id="764f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在要创建项目根目录的目录中执行以下命令行指令来克隆项目:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="84c3" class="mx ky iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/introduction-to-microservices.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/introduction-to-microservices.git</a><br/>cd introduction-to-microservices/heroes<br/>git checkout step2<br/>npm install<br/>cd ../threats<br/>npm install</span></pre><h1 id="393f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">向Eureka注册服务</h1><p id="5c6f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现有的应用程序是一个简单的系统，有两个服务和硬编码的URL。如果你想增加更多英雄服务的实例呢？威胁服务如何决定使用哪一个？你应该硬编码两个URL吗？</p><p id="3953" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有更好的方法。使用Eureka，您可以注册您的服务，这样其他服务就不必依赖硬编码的URL来找到它们，即使有多个服务实例运行在不同位置的不同服务器上。</p><p id="f6ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Zuul将提供到达注册表中列出的服务所需的智能路由，因此您不需要创建和维护复杂而脆弱的路由系统。</p><p id="103b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下图说明了您将要实现的体系结构:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/5f1fa666221c0d721dfa941a137d16fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BwRdLMgvusel78Vb.jpg"/></div></div></figure><p id="4b54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在完成的应用程序中将有两种通信流。首先，会有一个由绿线代表的连续运行序列。每当服务运行时，它向Eureka注册并发送心跳，通知Eureka它已启动并运行。Zuul将轮询Eureka的所有可用服务，并将它们映射到特定的路线。</p><p id="e97a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二种流程由蓝线表示，发生在系统收到请求时:</p><ol class=""><li id="fd40" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv nd mg mh mi bi translated">有人请求给一个威胁分配一个英雄！</li><li id="e9ce" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv nd mg mh mi bi translated">Zuul基于从Eureka获得的信息，向期望的服务、威胁服务，</li><li id="8fd1" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv nd mg mh mi bi translated">威胁服务向Zuul发送请求“告诉英雄服务将指定英雄的状态设置为‘忙碌’”。</li><li id="9a0f" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv nd mg mh mi bi translated">Zuul将该请求转发给英雄服务。</li></ol><p id="2cf0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下载以下Java归档文件，并将它们放在项目的根目录中:</p><p id="f35c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尤里卡服务公司(eureka-service)</p><p id="f14a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">zuul-0 . 0 . 1-snapshot . jar(39.6 MB)</p><p id="653c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在应用程序的根目录中执行下面的命令行指令来查看一下Eureka用户界面。Windows用户应该在Windows命令提示符(cmd.exe)窗口中执行指令，而不是在PowerShell窗口中。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="629e" class="mx ky iq mt b gy my mz l na nb">java -jar eureka-service-0.0.1-SNAPSHOT.jar</span></pre><p id="a98b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用您最喜欢的浏览器导航到位于<a class="ae kw" href="http://localhost:8761" rel="noopener ugc nofollow" target="_blank"> http://localhost:8761 </a>的Eureka应用程序。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/2bed272727f2c0df14bb90cfaa08e55e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xh2Cc3R0UmBPL4jJ.jpg"/></div></div></figure><p id="7852" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，Eureka服务运行在端口8761上。这可以通过使用<code class="fe ne nf ng mt b">--server.port</code>参数来改变；但是不要这样做，除非你有一个好的理由，比如端口冲突。</p><h1 id="afd2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用RESTful API在Eureka中注册一个服务实例</h1><p id="0a9d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">虽然可以使用Spring框架在Eureka中配置服务，但Eureka也有一个可以用于非Java应用程序的RESTful API。要注册一个新服务，您可以针对<a class="ae kw" href="http://localhost:8761/eureka/apps/my-service" rel="noopener ugc nofollow" target="_blank">http://localhost:8761/eureka/apps/my-service</a>端点执行POST请求。这可以通过curl命令来完成，如下所示。</p><p id="9771" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在应用程序的根目录中，创建一个<em class="nh">eureka-curl-payload . json</em>文件，并插入以下JSON数据:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="6276" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">显示为“my-service”的<code class="fe ne nf ng mt b">app</code>的值是用于服务名的句柄。所有包含的数据元素都是向Eureka注册服务所必需的。</p><p id="71fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在应用程序的根目录中执行以下curl命令行指令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e5a4" class="mx ky iq mt b gy my mz l na nb">curl -i --request POST --header "Content-Type: application/json" --data @eureka-curl-payload.json <a class="ae kw" href="http://localhost:8761/eureka/apps/my-service" rel="noopener ugc nofollow" target="_blank">http://localhost:8761/eureka/apps/my-service</a></span></pre><p id="7ead" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行此请求后，您应该会在终端输出中看到以下内容:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="dd69" class="mx ky iq mt b gy my mz l na nb">HTTP/1.1 204 <br/>Content-Type: application/xml<br/>Date: Mon, 22 Apr 2019 13:37:43 GMT</span></pre><p id="92cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，my-service应该列在当前向Eureka 表注册的<em class="nh">实例中，该表位于<a class="ae kw" href="http://localhost:8761," rel="noopener ugc nofollow" target="_blank"> http://localhost:8761，</a>，如下所示:</em></p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/2f95446bec5700368eec27ccd4211d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4zZJJbaTRwuhCtNY.jpg"/></div></div></figure><p id="25bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，如果在更改JSON文件的内容后没有快速刷新浏览器选项卡，您可能看不到列出的服务。默认情况下，如果客户端在60秒内没有发送心跳请求，Eureka应用程序会自动注销客户端。如果您遇到这种情况，请重新发送curl请求。</p><p id="0c88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让控制台窗口打开，让Eureka运行。你会再次需要这两样东西。</p><p id="2252" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是对Eureka正确注册服务实例所需信息的解释:</p><p id="5f99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">hostname</code>–服务的主机名</p><p id="ac14" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">app</code>–服务的名称(必须与URI的名称相同)</p><p id="05ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">vipAdress</code>–虚拟主机名</p><p id="96ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">instanceId</code>–服务实例的唯一id</p><p id="af0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">ipAddr</code>–运行实例的机器的IP地址(使用0.0.0.0来使用<code class="fe ne nf ng mt b">hostname</code>而不是IP地址。)</p><p id="cb7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">status</code>–服务的状态(启动、关闭、启动、停止服务、未知)</p><p id="c2c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">port</code>–一个JSON对象，包含有关运行服务实例的端口的信息</p><p id="02d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ne nf ng mt b">dataCenterInfo</code>–在Amazon Web Services环境中运行Eureka时需要的属性。在AWS上运行时，应该设置为“云”。</p><h1 id="bd43" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在Eureka中注册Node.js应用程序</h1><p id="6bdb" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在，您可以在案例研究项目中实现注册机制了。因为您将在heroes-service和threats-service服务中使用相同的机制，所以您可以创建一个单独的npm项目，这两个服务将使用该项目向Eureka注册它们自己。</p><p id="3ad6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh">/英雄</em>和<em class="nh">/威胁</em>目录的同一层级创建一个<em class="nh">/尤里卡助手</em>目录。</p><p id="f084" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到<em class="nh"> /eureka-helper </em>目录并创建一个<em class="nh"> eureka-helper.js文件。</em></p><p id="549d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh"> /eureka-helper </em>目录中，通过执行以下命令行指令初始化npm项目并安装必要的依赖项:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2fb7" class="mx ky iq mt b gy my mz l na nb">npm init -y<br/>npm install request <br/>npm install ip</span></pre><p id="685f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh">/尤里卡助手/尤里卡助手. js </em>文件中插入以下JavaScript代码:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="3bdc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh"> eureka- </em> h <em class="nh"> elper </em>项目公开了<code class="fe ne nf ng mt b">registerWithEureka</code>方法，该方法执行您在测试eureka时尝试的HTTP POST请求。当该方法得到肯定的响应时，它开始向Eureka发送一个心跳，以防止它注销服务，如上所述。这是通过<code class="fe ne nf ng mt b">setInterval</code>方法完成的:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="6a70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在你可以从每个服务中调用<code class="fe ne nf ng mt b">registerWithEureka</code>方法。</p><p id="6231" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">修改<em class="nh"> /threats/threats.js </em>文件，使最后三行代码如下所示:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d3c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">修改<em class="nh"> /heroes/heroes.js </em>文件，使最后三行如下所示。注意，<code class="fe ne nf ng mt b">registerWithEureka</code>的一个参数是不同的:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="ec0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh"> /heroes </em>目录中打开一个控制台窗口，执行下面的命令行指令来启动服务。Windows用户应该使用命令(cmd.exe)窗口，而不是PowerShell:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6d40" class="mx ky iq mt b gy my mz l na nb">node heroes.js 3838</span></pre><p id="02a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输出应该如下所示:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ec89" class="mx ky iq mt b gy my mz l na nb">Registering heroes-service with Eureka<br/>Heroes service listening on port 3838<br/>Registered with Eureka.</span></pre><p id="0ec9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让此控制台窗口保持打开状态。你最终会打开五个控制台窗口，所以你可能想现在就开始整理你的桌面，这样如果你有足够的空间，你就可以看到它们和你的浏览器标签。</p><p id="0239" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh"> /threats </em>目录中打开另一个控制台窗口，并使用以下命令行指令启动服务:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="9393" class="mx ky iq mt b gy my mz l na nb">node threats.js 3939</span></pre><p id="52e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输出应该如下所示:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="63ae" class="mx ky iq mt b gy my mz l na nb">Threats service listening on port 3939<br/>Registering threats-service with Eureka<br/>Registered with Eureka.</span></pre><p id="ddbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的浏览器中，查看Eureka (http://localhost:8761)的选项卡，并验证这两个服务是否都列在当前向Eureka 注册的<em class="nh">实例下，如下所示:</em></p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/07850d50050453dde9da4c86798df631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1Z508qzMZo5SAeiH.jpg"/></div></div></figure><p id="888b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您没有遵循编码，并且希望使用GitHub存储库中的代码赶上这一步，请在您想要创建项目目录的目录中执行以下命令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="424d" class="mx ky iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/introduction-to-microservices.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/introduction-to-microservices.git</a><br/>cd introduction-to-microservices/heroes<br/>git checkout step3<br/>npm install<br/>cd ../threats<br/>npm install<br/>cd ../eureka-helper<br/>npm install<br/>cd ..</span></pre><h1 id="7319" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用Zuul查找服务</h1><p id="82d7" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在这些服务已经在Eureka注册了，它们可以通过Zuul的动态路由功能进行定位。</p><p id="7d7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在应用程序的根目录中打开一个新的控制台窗口(这将是您打开的第四个命令窗口)。</p><p id="4c7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在新的控制台窗口中执行以下命令行指令来启动Zuul服务。这将是您打开的第五个控制台窗口:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f43f" class="mx ky iq mt b gy my mz l na nb">java -jar zuul-0.0.1-SNAPSHOT.jar</span></pre><p id="1a92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个命令将在HTTP端口8080上启动Zuul。默认情况下，Zuul将在http://localhost:8761查找Eureka服务。如果您已经更改了Eureka的端口，您可以使用内联参数覆盖Zuul的默认设置，如下所示，其中第一个端口号是Zuul的，第二个是Eureka的:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0abf" class="mx ky iq mt b gy my mz l na nb">java -jar zuul-0.0.1-SNAPSHOT.jar --server.port=9090 --eureka.client.serviceUrl.defaultZone=http://localhost:8761/eureka/</span></pre><p id="bf93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开一个新的浏览器选项卡，导航到<a class="ae kw" href="http://localhost:8080/routes" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/routes</a>(或者您分配给Zuul的端口，如果您已经更改了它)。您应该会看到在Zuul中注册的路线列表，如下所示:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6be4" class="mx ky iq mt b gy my mz l na nb">{"/hero-service/**":"heroes-service","/threats-service/**":"threats-service"}</span></pre><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/2c73c8f790ef45ab65bab58dd9c8620c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TouHIRCGqODfzcCA.jpg"/></div></div></figure><p id="a2f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保持Zuul服务运行。</p><h1 id="421a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用Zuul寻找英雄-服务</h1><p id="71e4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Zuul正在运行，但威胁-服务需要更改为使用Zuul找到英雄-服务；威胁-服务目前使用的是硬编码的URL，不太具有可伸缩性。更改服务以使用Zuul很容易。</p><p id="ff86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行威胁服务的控制台窗口中，停止该服务并保持窗口打开。</p><p id="bf70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh">威胁/威胁. js </em>文件中找到以下行:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="c18c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更改它，使它指向Zuul运行的端口，后跟heroes-service的名称，因为它是在<em class="nh">eureka-helper/eureka-helper . js</em>中注册的:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="9bd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存文件并<strong class="ka ir">重启</strong>威胁服务。</p><h1 id="f73c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">验证尤里卡和祖尔在工作</h1><p id="6897" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在，您的应用程序中已经有了服务目录和动态路由。您可以通过执行post命令来查看它的运行情况，该命令将一个特定的“英雄”分配给一个特定的“威胁”，这标志着该英雄正忙于从特定的危险中拯救世界。</p><p id="29c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以使用<a class="ae kw" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>，curl，PowerShell<a class="ae kw" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest" rel="noopener ugc nofollow" target="_blank">Invoke-WebRequest</a>，或者你的浏览器。如果您想使用curl，请打开一个控制台窗口并执行以下命令行指令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f67d" class="mx ky iq mt b gy my mz l na nb">curl -i --request POST --header "Content-Type: application/json" --data "{\"heroId\": 1, \"threatId\": 1}" localhost:8080/threats-service/assignment</span></pre><p id="6a2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，如果您更改了运行Zuul的端口号，您将需要更改端口号。</p><p id="4aa3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果服务运行正常，您应该会看到类似于curl的以下控制台输出的结果:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e375" class="mx ky iq mt b gy my mz l na nb">HTTP/1.1 202 <br/>X-Application-Context: application:8080<br/>X-Powered-By: Express<br/>ETag: W/"79-ER1WRPW1305+Eomgfjq/A/Cgkp8"<br/>Date: Fri, 05 Apr 2019 18:05:54 GMT<br/>Content-Type: application/json;charset=utf-8<br/>Transfer-Encoding: chunked</span><span id="eee8" class="mx ky iq mt b gy nl mz l na nb">{"id":1,"displayName":"Pisa tower is about to collapse.","necessaryPowers":["flying"],"img":"tower.jpg","assignedHero":1}</span></pre><p id="afc2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在英雄服务的控制台窗口中，您应该会看到类似于以下内容的输出:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="dd32" class="mx ky iq mt b gy my mz l na nb">Heroes service listening on port 3838<br/>Registered with Eureka.<br/>Successfully sent heartbeat to Eureka.<br/>Successfully sent heartbeat to Eureka.<br/>Set busy to true in hero: 1</span></pre><p id="ab9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恭喜你！您现在拥有了一个更具可扩展性和健壮性的微服务应用程序！</p><p id="66b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想使用GitHub存储库中的代码赶上这一步，请在您想要创建项目目录的目录中执行以下命令:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0855" class="mx ky iq mt b gy my mz l na nb">git clone <a class="ae kw" href="https://github.com/maciejtreder/introduction-to-microservices.git" rel="noopener ugc nofollow" target="_blank">https://github.com/maciejtreder/introduction-to-microservices.git</a><br/>cd introduction-to-microservices/heroes<br/>git checkout step4<br/>npm install<br/>cd ../threats<br/>npm install<br/>cd ../eureka-helper<br/>npm install<br/>cd ..</span></pre><h1 id="fb19" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="c21e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在这篇文章中，您了解了如何在Eureka中使用服务发现。您了解了如何将不同任务的责任委派给不同的应用程序，以及如何在服务之间进行通信。这两个应用程序通过公开的REST APIs相互通信。每个服务只处理自己负责的数据，并且可以在不涉及其他服务的情况下进行维护、扩展和部署。这两个应用程序都可以在同一个域localhost:8080下访问。要访问它们，你只需要将它们的指定句柄添加到URL中。</p><p id="fe8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步<a class="ae kw" href="https://medium.com/@maciejtreder/scaling-node-js-javascript-microservices-on-shared-mongodb-atlas-cloud-persistence-layers-620bf975ebfd" rel="noopener">扩展共享MongoDB Atlas云持久层上的Node.js JavaScript微服务</a>。</p><h1 id="ab58" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">额外资源</h1><p id="9bb9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm" rel="noopener ugc nofollow" target="_blank">建筑风格与基于网络的软件架构设计</a>，罗伊·托马斯·菲尔丁，2000——菲尔丁的博士论文描述了表征状态转移(第5章)和其他建筑风格。</p><p id="74f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://en.wikipedia.org/wiki/Microservices" rel="noopener ugc nofollow" target="_blank">微服务</a>——虽然有缺陷，但维基百科的文章是寻找更多关于微服务架构和实现的信息的良好起点。</p><p id="deeb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://nodejs.org/en/docs/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>参考文件</p><p id="ff0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/spring-cloud/spring-cloud-netflix" rel="noopener ugc nofollow" target="_blank">Spring Cloud NetFlix Spring Cloud网飞项目</a>“……通过自动配置和绑定到Spring环境和其他Spring编程模型习惯用法，为Spring Boot应用程序提供网飞操作系统集成。”</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="38c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh">我是Maciej Treder，通过</em> <a class="ae kw" href="mailto:contact@maciejtreder.com" rel="noopener ugc nofollow" target="_blank"> <em class="nh">联系我contact@maciejtreder.com</em></a><em class="nh"/><a class="ae kw" href="https://www.maciejtreder.com/" rel="noopener ugc nofollow" target="_blank"><em class="nh">https://www.maciejtreder.com</em></a><em class="nh">或@ maciejtreder on</em><a class="ae kw" href="http://github.com/maciejtreder" rel="noopener ugc nofollow" target="_blank">T25】git hub</a><em class="nh">、</em><a class="ae kw" href="https://twitter.com/maciejtreder" rel="noopener ugc nofollow" target="_blank">T31<em class="nh">和</em></a><a class="ae kw" href="https://www.linkedin.com/in/maciej-treder/" rel="noopener ugc nofollow" target="_blank">T37 LinkedIn</a></p><p id="8dae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh">本帖最初发布在</em> <a class="ae kw" href="https://www.twilio.com/blog/eureka-zuul-service-discovery-dynamic-routing-javascript-microservices-node-js" rel="noopener ugc nofollow" target="_blank"> <em class="nh"> Twilio博客</em> </a> <em class="nh">上。</em></p></div></div>    
</body>
</html>