<html>
<head>
<title>Build a Traffic Alert App with TensorFlow.js, Ably and HTML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用TensorFlow.js，Ably和HTML搭建一个交通预警App</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-a-traffic-alert-app-with-just-one-html-ably-tensorflow-741c40582672?source=collection_archive---------2-----------------------#2019-10-15">https://javascript.plainenglish.io/build-a-traffic-alert-app-with-just-one-html-ably-tensorflow-741c40582672?source=collection_archive---------2-----------------------#2019-10-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/e5c8786ab50deacfc9619e89885f652b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*97NI1gl1iL1gPBD0lAu-Zw.jpeg"/></div></div></figure><p id="938a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这篇博文中，我们将展示Ably和Tensorflow.js的强大功能。这是一个演示，在生产中你可能不会这样做，但你可以感受到Ably是多么强大，以及你如何通过几行代码使用深度学习模型。</p><h1 id="abbd" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">什么是干练？</h1><p id="bd5c" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">巧妙地提供API来轻松处理大量实时发布/订阅。在Ably中，您可以从Realtime、REST、MQTT或SSE库中进行选择，这些库在大多数流行的语言和框架中实现。关于Ably的更多信息，你可以访问他们的<a class="ae lw" href="https://www.ably.io/" rel="noopener ugc nofollow" target="_blank">网页</a>。</p><p id="d81c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你想跟随这个演示并建立你自己的，你必须注册一个免费的Ably账户，并在这里得到一个API密匙<a class="ae lw" href="https://www.ably.io/signup#signup-box" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="27a9" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">我们开始吧！</h1><p id="7601" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">首先，我们需要html中的所有基本组件。我们将从这个文件作为框架开始:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="7d69" class="mg ku in mc b gy mh mi l mj mk">&lt;html&gt;<br/>  &lt;body&gt;<br/>    &lt;h1&gt;TfL traffic notifier&lt;/h1&gt;<br/>    &lt;p&gt;&lt;/p&gt;<br/>&lt;div&gt;<br/>    Your update: &lt;input type="text" id="message-text" value=""&gt; &lt;button id="send-message"&gt;Submit an update&lt;/button&gt;<br/>    &lt;/div&gt;<br/>    &lt;textarea id="result" rows="10" style="width: 60%; margin-top: 10px; font-family: courier, courier new; background-color: #333; color: orange" disabled=""&gt;&lt;/textarea&gt;<br/>    &lt;/div&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="8866" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">很简单很基础。我们更感兴趣的是功能，而不是图形设计。我们有一个供用户输入的输入框和一个提交更新的按钮。下面的黑色文本区域是所有用户的消息。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/e93de6faa1e094a138bcd414fa5fb21b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpFWHmn5sm8TgcnHeS11qA.png"/></div></div></figure><h1 id="2318" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">巧妙地实时使用</h1><p id="f6b8" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们将使用Ably Realtime WebSocket连接为更新后的表单用户发布和订阅一个通道。(确保您有API密钥)将它放在<code class="fe mm mn mo mc b">&lt;/body&gt;</code>之后和<code class="fe mm mn mo mc b">&lt;/html&gt;</code>之前:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="54b8" class="mg ku in mc b gy mh mi l mj mk">&lt;!-- Include the latest Ably Library  --&gt;<br/>  &lt;script src="<a class="ae lw" href="https://cdn.ably.io/lib/ably.min-1.js" rel="noopener ugc nofollow" target="_blank">https://cdn.ably.io/lib/ably.min-1.js</a>"&gt;&lt;/script&gt;</span><span id="c6f4" class="mg ku in mc b gy mp mi l mj mk">&lt;!-- Instance the Ably library  --&gt;<br/>  &lt;script type="text/javascript"&gt;</span><span id="e87a" class="mg ku in mc b gy mp mi l mj mk">// Set up Ably's channel<br/>    var realtime = new Ably.Realtime(&lt;your API key&gt;; // put your API key here<br/>    var channel = realtime.channels.get("my_channel");</span><span id="e3a3" class="mg ku in mc b gy mp mi l mj mk">// Helper function for getting the timestamp<br/>    function get_current_time(){<br/>        return '[' + Date().toLocaleString() + ']\n';<br/>    }</span><span id="4e68" class="mg ku in mc b gy mp mi l mj mk">// Getting the update from users<br/>    channel.subscribe(function(msg) {<br/>        document.getElementById("result").innerHTML = (get_current_time() + "User update: " + msg.data + "\n\n") + document.getElementById("result").innerHTML;<br/>    });<br/>    document.getElementById("send-message").addEventListener("click", function(){<br/>        let input_text = document.getElementById("message-text").value;<br/>        if (input_text != ""){<br/>                        channel.publish("update", input_text);<br/>                        document.getElementById("message-text").value = ""<br/>}<br/>    })<br/>  &lt;/script&gt;</span></pre><p id="7e4d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里我们:</p><ol class=""><li id="e175" class="mq mr in jx b jy jz kc kd kg ms kk mt ko mu ks mv mw mx my bi translated">包括Ably库</li><li id="501d" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">巧妙地连接到(记得用您的API密钥替换)</li><li id="6194" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">订阅我的频道，如果有更新，将其添加到文本中</li><li id="6856" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">当用户输入更新并点击按钮时，它将发布到my_channel</li></ol><p id="629a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，试试我们的应用程序。在输入框中放一些东西，然后点击按钮。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ne"><img src="../Images/d5075f376416d505d2bf670c271fafed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O8fcVtPvA-Na1VjfW8fPlA.png"/></div></div></figure><p id="c0d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以看到更新出现，你也可以为多个用户做一个实验。在另一个窗口或选项卡中打开html文件，然后重复发布更新。您可以看到“其他用户”也将收到更新。</p><p id="ee2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我还想指出，像我们这样使用API密钥在生产代码中不是一个好的做法，因为它会将您的密钥暴露给公众。为了进一步了解如何正确地做到这一点，请参考<a class="ae lw" href="https://www.ably.io/documentation/core-features/authentication#token-authentication" rel="noopener ugc nofollow" target="_blank"> Ably的文档</a>。</p><h1 id="a7aa" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">TfL信息枢纽</h1><p id="8c4e" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">现在我们将添加TfL更新。Ably <a class="ae lw" href="https://www.ably.io/hub" rel="noopener ugc nofollow" target="_blank"> Hub </a>提供免费、开源的数据流供任何人使用(不同的许可限制可能适用于不同的数据源)。如果你有捐赠的来源，请联系Ably的团队。</p><p id="16bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用Ably Hub与使用Ably Realtime非常相似，您也可以参考本页中的<a class="ae lw" href="https://www.ably.io/hub/products/10#documentation" rel="noopener ugc nofollow" target="_blank">以获取特定于TfL数据的文档。添加新频道:</a></p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="bbd8" class="mg ku in mc b gy mh mi l mj mk">var tfl_channel = realtime.channels.get("[product:ably-tfl/tube]tube:disruptions");</span></pre><p id="203e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将在任何线路出现中断时通知我们。如果没有，我们将得到一个空列表。然后，我们可以检查我们的更新，看看它是否包含有关中断线路的信息:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="6efc" class="mg ku in mc b gy mh mi l mj mk">// Getting the update form TfL streamer<br/>    tfl_channel.subscribe(function(msg) {<br/>        if (msg.data.length == 0) {<br/>            document.getElementById("result").innerHTML = (get_current_time() + "TfL: Good service on all lines." + "\n\n") + document.getElementById("result").innerHTML;<br/>        }else{<br/>            msg.data.forEach(function(each_issue){<br/>                document.getElementById("result").innerHTML = (get_current_time() + each_issue.description + "\n\n") + document.getElementById("result").innerHTML;<br/>            })<br/>        }<br/>    });</span></pre><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nf"><img src="../Images/4c237f9b2ae0924f922cc5530902eddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JnCNfhBhI4SUTkO3RA1CQ.png"/></div></div></figure><h1 id="21be" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">有毒检测器— Tensorflow.js</h1><p id="2a27" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">到目前为止所有用户无论说什么都可以更新，这是不好的。我们能阻止人们向我们的频道发布有害更新吗？让我们尝试使用AI并检测有毒评论并阻止它们。这里我们将使用一个预先训练好的模型，这非常简单，只需添加Tensorflow.js和模型:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e8e5" class="mg ku in mc b gy mh mi l mj mk">&lt;!-- Include tf model --&gt;<br/>  &lt;script src="<a class="ae lw" href="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs" rel="noopener ugc nofollow" target="_blank">https://cdn.jsdelivr.net/npm/@tensorflow/tfjs</a>"&gt;&lt;/script&gt;<br/>  &lt;script src="<a class="ae lw" href="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity" rel="noopener ugc nofollow" target="_blank">https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity</a>"&gt;&lt;/script&gt;</span></pre><p id="f672" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">并更新发布功能:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="0b58" class="mg ku in mc b gy mh mi l mj mk">// When the user send an update, check if it is a toxic comment, publish if it is not.<br/>    document.getElementById("send-message").addEventListener("click", function(){<br/>        let input_text = document.getElementById("message-text").value;<br/>        let threshold = 0.9;<br/>        var all_prediction = false;<br/>        if (input_text != ""){<br/>            toxicity.load(threshold).then(function(model){<br/>                model.classify(input_text).then(function(predictions){<br/>                    predictions.forEach(function(each_prediction){<br/>                        let results = each_prediction.results<br/>                        if (results[0].match){<br/>                            all_prediction = true;<br/>                            return 0;<br/>                        }<br/>                    });<br/>                    if (all_prediction){<br/>                        alert("Please be nice.")<br/>                    }else{<br/>                        channel.publish("update", input_text);<br/>                        document.getElementById("message-text").value = ""<br/>                    }<br/>                });<br/>            });<br/>        }<br/>    })</span></pre><p id="0dfa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我们将阈值设置为0.9，因此如果我们的模型非常确信它包含任何形式的有毒文本，它将阻止发布，而是提醒用户要友好。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/9f0149a92c2013ee0c73ce7f6220b29d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yn1jkV6_tRlTa5Xm5kLOvw.png"/></div></div></figure><p id="4a48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">试一试，你会发现我们的信息速度大大降低。Ably是一个快速的API，因为它使用WebSocket，更新几乎是即时的。然而，通过人工智能模型进行预测需要一点时间，并且在性能方面并不理想。也许我们不应该在前端做所有的事情！</p><p id="591b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我希望你玩得开心！要查看完整的html文件，请参考GitHub上的<a class="ae lw" href="https://github.com/Cheukting/ably-tensorflow-demo/blob/master/ably%2Btensorflow_example.html" rel="noopener ugc nofollow" target="_blank">文件</a></p></div></div>    
</body>
</html>