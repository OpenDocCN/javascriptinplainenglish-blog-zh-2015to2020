<html>
<head>
<title>Next.js — Middlewares and Preview Mode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js —中间件和预览模式</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/next-js-middlewares-and-preview-mode-d19ea8bebc11?source=collection_archive---------11-----------------------#2020-12-30">https://javascript.plainenglish.io/next-js-middlewares-and-preview-mode-d19ea8bebc11?source=collection_archive---------11-----------------------#2020-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e4774ed5f78c9de9a6e7ed4a6ad78c18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-Oo3X6LBLEuIFW3l"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@lensinkmitchel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mitchel Lensink</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0f83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以轻松地创建服务器端呈现的React应用程序和静态站点。</p><p id="b37f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我们将看看route中间件和Next.js的预览模式。</p><h1 id="94c8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">连接/快速中间件支持</h1><p id="a8db" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用Connect兼容的中间件。</p><p id="d696" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以通过安装中间件并添加到我们的Next.js应用程序来添加中间件。</p><p id="f5a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要安装它，我们运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c1c0" class="mq lc iq mh b gy mr ms l mt mu">npm i cors</span></pre><p id="fc27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2c81" class="mq lc iq mh b gy mr ms l mt mu">yarn add cors</span></pre><p id="254a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过编写以下代码将其添加到我们的API路径中:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="019f" class="mq lc iq mh b gy mr ms l mt mu">import Cors from 'cors'</span><span id="a3fe" class="mq lc iq mh b gy mv ms l mt mu">const cors = Cors({<br/>  methods: ['GET', 'HEAD'],<br/>})</span><span id="568c" class="mq lc iq mh b gy mv ms l mt mu">function runMiddleware(req, res, fn) {<br/>  return new Promise((resolve, reject) =&gt; {<br/>    fn(req, res, (result) =&gt; {<br/>      if (result instanceof Error) {<br/>        return reject(result)<br/>      }<br/>      return resolve(result)<br/>    })<br/>  })<br/>}</span><span id="6078" class="mq lc iq mh b gy mv ms l mt mu">async function handler(req, res) {<br/>  await runMiddleware(req, res, cors)<br/>  res.json({ message: 'hello world' })<br/>}</span><span id="8860" class="mq lc iq mh b gy mv ms l mt mu">export default handler</span></pre><p id="0abf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们导入了<code class="fe me mf mg mh b">Cors</code>函数。</p><p id="20b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用它来创建<code class="fe me mf mg mh b">cors</code>中间件。</p><p id="5f1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以指定可用于路由的请求方法。</p><p id="c1c2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">runMiddleware</code>函数通过调用<code class="fe me mf mg mh b">fn</code>中间件函数来运行中间件，如果成功则解析到<code class="fe me mf mg mh b">result</code>。</p><p id="b506" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，承诺被拒绝。</p><p id="faca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">handler</code>是运行中间件并返回响应的路由处理器。</p><h1 id="2adb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">响应助手</h1><p id="9adc" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Next.js附带了各种响应助手。</p><p id="8d70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">res.status(code)</code>方法让我们设置响应的状态代码。</p><p id="3eda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">code</code>是一个HTTP状态码。</p><p id="dc3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">方法让我们发送一个JSON响应。</p><p id="048f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">json</code>是有效的JSON对象。</p><p id="4ffd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">res.send(body)</code>让我们发送一个HTTP响应，其中<code class="fe me mf mg mh b">body</code>是一个字符串、对象或缓冲区。</p><p id="adbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">res.redirect</code>使用可选的<code class="fe me mf mg mh b">status</code>和<code class="fe me mf mg mh b">path</code>让我们重定向到特定的路径或URL。</p><p id="e480" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">status</code>的默认值为307。</p><p id="79dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以这样称呼它们:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a559" class="mq lc iq mh b gy mr ms l mt mu">export default (req, res) =&gt; {<br/>  res.status(200).json({ name: 'hello' })<br/>}</span></pre><p id="f485" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们可以用链子拴在一起。</p><h1 id="75f8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">预览模式</h1><p id="659e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以预览静态生成的路由。</p><p id="7d49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Next.js有一个预览模式的特性来解决这个问题。</p><p id="4f31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将在请求时而不是构建时呈现页面，并获取草稿内容而不是已发布的内容。</p><p id="4b57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了使用它，我们调用<code class="fe me mf mg mh b">res.setPreviewData</code>方法进行预览。</p><p id="4d0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0866" class="mq lc iq mh b gy mr ms l mt mu">export default (req, res) =&gt; {<br/>  res.setPreviewData({})<br/>  res.end('Preview mode')<br/>}</span></pre><p id="070a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启用它。</p><h1 id="ddda" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安全地访问数据</h1><p id="5175" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过从预览路径写入并发送到我们的页面来访问数据。</p><p id="0ab7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们通过创建<code class="fe me mf mg mh b">pages/api/preview.js</code>文件来创建预览API路径:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="66d0" class="mq lc iq mh b gy mr ms l mt mu">export default async (req, res) =&gt; {<br/>  const response = await fetch(`https://yesno.wtf/api`)<br/>  const data = await response.json();<br/>  res.setPreviewData(data)<br/>  res.redirect('/post')<br/>}</span></pre><p id="76c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从API获取数据并调用<code class="fe me mf mg mh b">setPreviewData</code>，这样我们就可以从页面JavaScript文件中的<code class="fe me mf mg mh b">getStaticProps</code>函数获取数据。</p><p id="5fbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们重定向到我们的文件，这样我们就可以在我们的页面上看到数据。</p><p id="b0b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">pages/post.js</code>中，我们写道:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="921a" class="mq lc iq mh b gy mr ms l mt mu">function Post({ data }) {<br/>  return (<br/>    &lt;div&gt;{data &amp;&amp; data.answer}&lt;/div&gt;<br/>  )<br/>}</span><span id="cf19" class="mq lc iq mh b gy mv ms l mt mu">export async function getStaticProps(context) {<br/>  if (context.preview) {<br/>    return {<br/>      props: {<br/>        data: context.previewData<br/>      }<br/>    }<br/>  }<br/>  return { props: { data: { answer: 'not preview' } } }<br/>}</span><span id="7d02" class="mq lc iq mh b gy mv ms l mt mu">export default Post</span></pre><p id="53e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过检查<code class="fe me mf mg mh b">context.preview</code>属性来检查预览模式是否打开。</p><p id="736e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果是<code class="fe me mf mg mh b">true</code>，那么我们从<code class="fe me mf mg mh b">context.previewData</code>那里得到预览数据。</p><p id="18a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们在我们的<code class="fe me mf mg mh b">Post</code>组件中显示<code class="fe me mf mg mh b">data</code>。</p><h1 id="0cc9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="5297" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Next.js添加预览模式，这样我们就可以在它上线之前查看输出。</p><p id="527b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以在Next.js应用程序中使用Connect或Express中间件。</p><p id="3d60" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>