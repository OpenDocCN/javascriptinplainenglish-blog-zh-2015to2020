<html>
<head>
<title>Creating an Instant Messenger with React, Custom Hooks &amp; Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React、自定义钩子和Firebase创建即时消息</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-an-instant-messenger-with-react-custom-hooks-firebase-355bd544192?source=collection_archive---------2-----------------------#2019-12-29">https://javascript.plainenglish.io/creating-an-instant-messenger-with-react-custom-hooks-firebase-355bd544192?source=collection_archive---------2-----------------------#2019-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="de31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将向您展示如何使用React &amp; Firebases实时数据库创建自己的IM客户端，不需要后端编程。</p><p id="ddba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会详细介绍Firebase的设置，因为我已经有了一篇文章，<a class="ae kl" href="https://medium.com/javascript-in-plain-english/deploying-and-authenticating-a-react-app-with-googles-firebase-541f7fa7be6a" rel="noopener"> <em class="km">“使用Google的Firebase部署和验证React应用程序”</em> </a> <em class="km">。</em>我们在这里做事情的方式有一些小的不同，但是任何对Firebase完全陌生的人都可能想要阅读它以获得深入的解释。</p><p id="03ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你只对如何与Firebase的实时数据库对话感兴趣，那么一旦你完成了设置，就跳到<code class="fe kn ko kp kq b">Talking to Firebase</code>。</p><p id="0aa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">先决条件</strong></p><ul class=""><li id="1215" class="kr ks iq jp b jq jr ju jv jy kt kc ku kg kv kk kw kx ky kz bi translated">反应的中级知识</li></ul><p id="36e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">入门</strong></p><p id="1f0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">在控制台中创建一个Firebase项目</em></p><p id="8666" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里 &amp;创建你的项目<a class="ae kl" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank">按照步骤操作。</a></p><p id="3120" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">克隆回购</em></p><p id="a877" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">克隆<code class="fe kn ko kp kq b"><a class="ae kl" href="https://gitlab.com/sk3pt1cc/react-starter" rel="noopener ugc nofollow" target="_blank">react-starter</a></code>回购。</p><p id="2108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe kn ko kp kq b">npm run start</code>来启动它。</p><p id="6647" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">拜访<code class="fe kn ko kp kq b">localhost:3000</code>。</p><p id="e081" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">初始化Firebase </em></p><p id="d185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要在代码中设置Firebase。这个过程有几个步骤，但不需要太长时间。</p><ol class=""><li id="5137" class="kr ks iq jp b jq jr ju jv jy kt kc ku kg kv kk la kx ky kz bi translated"><strong class="jp ir">使用Firebase CLI进行初始化</strong></li></ol><p id="f4ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在终端中，运行<code class="fe kn ko kp kq b">npm i -g firebase-tools,</code>，然后运行<code class="fe kn ko kp kq b">firebase login</code>。这将打开一个浏览器窗口，您可以在其中登录您的google帐户。</p><p id="b545" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，在项目根，运行<code class="fe kn ko kp kq b">firebase init</code>。你会看到一组选项。首先，选择“数据库”。然后，选择<code class="fe kn ko kp kq b">Use an existing project.</code>找到您刚刚创建的项目。接下来，接受默认的数据库规则。然后设置你的公共目录为<code class="fe kn ko kp kq b">build/</code>，回答是重写所有URL为<code class="fe kn ko kp kq b">/index.html</code>，回答否重写<code class="fe kn ko kp kq b">index.html</code>。</p><p id="cbf1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行这个命令会为您生成几个文件。Firebase使用这些信息来确定要写入哪个数据库。它们是自动生成的，所以你不需要担心它们。当你在几分钟内运行<code class="fe kn ko kp kq b">firebase deploy</code>时，Firebase将创建你需要的一切。</p><p id="56f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。更新数据库规则</strong></p><p id="4487" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">找到<code class="fe kn ko kp kq b">database.rules.json</code>，将<code class="fe kn ko kp kq b">read</code>和<code class="fe kn ko kp kq b">write</code>改为<code class="fe kn ko kp kq b">true</code>。这是不安全的，不应该用于真正的东西。</p><p id="ad97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。用你的配置初始化fire base</strong></p><p id="6924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，用你自动生成的配置初始化Firebase。在Firebase控制台中导航到您的项目。在左侧工具栏中找到<code class="fe kn ko kp kq b">Project Overview</code>旁边的齿轮图标。点击那个，然后<code class="fe kn ko kp kq b">project settings</code>。向下滚动直到看到<code class="fe kn ko kp kq b">Firebase SDK snippet</code>，然后点击<code class="fe kn ko kp kq b">Config</code>。</p><p id="37a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果看到<code class="fe kn ko kp kq b">There are no apps in your project</code>，点击看起来像这样的小图标——&gt;<code class="fe kn ko kp kq b">&lt;/&gt;</code>。给它取任何名字，注册它。现在你应该在屏幕上看到你的配置对象，在“添加Firebase SDK”下面。</p><p id="9a16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe kn ko kp kq b">firebaseConfig</code> JSON对象复制到<code class="fe kn ko kp kq b">src/firebase.config.js</code>中。确保在该文件的底部也写有<code class="fe kn ko kp kq b">export default firebaseConfig;</code>。</p><p id="1726" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行，<code class="fe kn ko kp kq b">npm i firebase</code>(不同于<code class="fe kn ko kp kq b">firebase-tools</code>)，然后在<code class="fe kn ko kp kq b">src/index.js</code>中添加:</p><pre class="lb lc ld le gt lf kq lg lh aw li bi"><span id="dac3" class="lj lk iq kq b gy ll lm l ln lo">import * as firebase from 'firebase/app';<br/>import firebaseConfig from './firebase.config';</span><span id="058b" class="lj lk iq kq b gy lp lm l ln lo">firebase.initializeApp(firebaseConfig);</span></pre><p id="5678" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4。展开</strong></p><p id="21a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行<code class="fe kn ko kp kq b">firebase deploy</code>将您的所有更改上传到控制台。</p><p id="3bfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你已经准备好了。</p><p id="e5b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">组件</strong></p><p id="6ed7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将创建五个React组件。我将依次检查每一个。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="ddac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;Connect /&gt;</code>用于连接IM客户端。它呈现一个输入框&amp;作为登录按钮。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/300b4fbcc89b34a999336dd5908d819c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fPh04tqjUFV4MnFvrMocVQ.png"/></div></div></figure><p id="6cf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">connect</code>是从<code class="fe kn ko kp kq b">App.js</code>传下来的函数，我们后面会看到。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="51b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;CreateChat /&gt;</code>用于创建与某人的新聊天。它呈现了一个聊天名称输入框、一个选择接收者的选择菜单和一个创建接收者的按钮。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mf"><img src="../Images/e707c88c8e60d20084f36c18d35c5979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QmSLuNG43vDo9xubGbm30A.png"/></div></div></figure><p id="c76f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">createChat</code>是从<code class="fe kn ko kp kq b">App.js</code>传下来的函数。我们很快就会看到它会做什么。</p><p id="58c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">users</code>是所有注册了应用程序的用户的数组。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="c8ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;ChatWindow /&gt;</code>用于查看聊天内容和提交新消息。它呈现聊天中包含的所有消息。它们首先按创建日期排序。它还显示了一个用于输入新消息的文本区域和一个用于提交消息的按钮。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mg"><img src="../Images/1445bb6acb3c37eca891a566a0879424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7y-fZdEInlUI__rrcdW4cg.png"/></div></div></figure><p id="ae9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">messages</code>包含属于当前聊天的所有消息。</p><p id="2531" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">sendMessage</code>是一个向数据库发送消息的函数。我们很快就会看到这一点。</p><p id="ea6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">currentChat</code>是当前正在查看的聊天名称。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="6296" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;ActiveChats /&gt;</code>用于查看用户拥有的所有聊天记录。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mh"><img src="../Images/ee16a0517c13777843879415ffce53ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kkn4K08TYuc7NdCUZ_FMQ.png"/></div></div></figure><p id="d6b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">myActiveChats</code>包含用户拥有的聊天。</p><p id="67e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">setCurrentChat</code>更新我们当前正在查看的聊天内容。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="1c0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;App /&gt;</code>汇聚一切。它使用了两个自定义挂钩，<code class="fe kn ko kp kq b">useAuth</code> &amp; <code class="fe kn ko kp kq b">useChats</code>。这些都返回<code class="fe kn ko kp kq b">&lt;App /&gt;</code>及其子组件所需的各种方法/对象。我先给你看一下<code class="fe kn ko kp kq b">&lt;App /&gt;</code>，然后看一下定制挂钩。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mi"><img src="../Images/995ea51d630b81ab2071600bbe8788fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-02MjQu4JdWCVeXvZ2Jlw.png"/></div></div></figure><p id="f131" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果未定义<code class="fe kn ko kp kq b">userId</code>(即我们未登录)，则<code class="fe kn ko kp kq b">&lt;App /&gt;</code>呈现<code class="fe kn ko kp kq b">&lt;Connect /&gt;</code>。否则，显示当前用户，<code class="fe kn ko kp kq b">&lt;ActiveChats /&gt;</code>组件&amp;组件<code class="fe kn ko kp kq b">&lt;CreateChat /&gt;</code>组件。在将<code class="fe kn ko kp kq b">users</code>传递给<code class="fe kn ko kp kq b">&lt;CreateChat /&gt;</code>时，当前用户被过滤掉了，所以你无法与自己创建聊天。</p><p id="2a9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">&lt;ChatWindow /&gt;</code>仅在选择了当前聊天时显示。</p><p id="e253" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">与Firebase对话</strong></p><p id="ea9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定制钩子完成了大部分工作，但是它们不直接与Firebase对话。这发生在应用程序中最重要的文件<code class="fe kn ko kp kq b">src/database.js</code>中。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mj"><img src="../Images/a03b246809bafb88fe9e60d84a46d35d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EPGTVovW34Nqj_JRwR2bGQ.png"/></div></div></figure></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="4f70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">getFromDatabase</code>设置一种与Firebase对话的webhook。它使用来自<code class="fe kn ko kp kq b">firebase</code> npm包的<code class="fe kn ko kp kq b">database</code>方法来建立连接，然后每当数据改变时触发回调。它需要一个<code class="fe kn ko kp kq b">dbString</code>，代表数据库中您想要获取数据的具体位置。该字符串可以由许多部分组成，每个部分由正斜杠分隔。每个斜线代表一个新的嵌套级别。因此，如果您将<code class="fe kn ko kp kq b">[]</code>放在位置<code class="fe kn ko kp kq b">/chats/active/messages</code>，它将被写入数据库，如下所示:</p><pre class="lb lc ld le gt lf kq lg lh aw li bi"><span id="5562" class="lj lk iq kq b gy ll lm l ln lo">{<br/>  chats: {<br/>    active: {<br/>      messages: []<br/>    }<br/>  }<br/>}</span></pre><p id="0419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您要从<code class="fe kn ko kp kq b">/chats/active/messages</code>中检索数据，那么您将返回<code class="fe kn ko kp kq b">[]</code>。</p><p id="6b68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">getFromDatabase</code>还有一个<code class="fe kn ko kp kq b">callback</code>，当数据改变时执行。</p><p id="a364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在函数本身中:</p><ul class=""><li id="428f" class="kr ks iq jp b jq jr ju jv jy kt kc ku kg kv kk kw kx ky kz bi translated">在第4行，它得到一个数据应该被写入的引用</li><li id="357f" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated">在第5行，它告诉Firebase注意数据的更新，并提供一个回调，该回调传递了更改后的数据快照</li><li id="2850" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated">在第6行，它调用<code class="fe kn ko kp kq b">snapshot.val()</code>来获取数据，并检查它是否是<code class="fe kn ko kp kq b">null</code></li><li id="18c0" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated">在第7行，它用数据调用回调</li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="df61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">saveToDatabase</code>要简单得多。它只得到通过了<code class="fe kn ko kp kq b">dbString</code> &amp;的值来写。</p><p id="d5a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">定制挂钩</strong></p><p id="cd99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个拼图的最后一块是定制的钩子。我将依次检查每一个。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="8c8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">useAuth</code>负责登录用户&amp;获取所有用户。它返回的<code class="fe kn ko kp kq b">userId</code>是当前登录用户的名字，<code class="fe kn ko kp kq b">users</code>是系统中所有用户的列表&amp; <code class="fe kn ko kp kq b">connect</code>是一个用于登录的函数。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mp"><img src="../Images/ed19fc9f8690de12446d046ce1ef1ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CTxYvBhJDkWhKhPFbsm2MA.png"/></div></div></figure><p id="ae14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">connect</code>接收您想要登录的用户名。这被输入到<code class="fe kn ko kp kq b">&lt;Connect /&gt;</code>组件中。一旦我们有了用户名，我们就把它保存到数据库中。如果该用户已经存在，firebase不会覆盖该记录，因此您将以相同的用户身份登录。</p><p id="b081" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">getUsers</code>从数据库中检索用户，并将它们存储在state中。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="ea91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kn ko kp kq b">useChats</code>是应用程序的主要工具，负责创建和加载聊天信息&amp;。它返回六样东西:</p><ul class=""><li id="cd72" class="kr ks iq jp b jq jr ju jv jy kt kc ku kg kv kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">sendMessage</code> —将新消息保存到数据库的功能</li><li id="e63d" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">createChat</code> —创建新聊天的功能</li><li id="681f" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">currentChat</code> —对当前聊天的引用</li><li id="8b0d" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">myActiveChats</code> —当前用户的聊天列表</li><li id="bf17" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">currentChatMessages</code> —当前聊天中的所有消息</li><li id="0232" class="kr ks iq jp b jq mk ju ml jy mm kc mn kg mo kk kw kx ky kz bi translated"><code class="fe kn ko kp kq b">setCurrentChat</code> —用于设置当前聊天</li></ul><figure class="lb lc ld le gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mq"><img src="../Images/d646f8efaee9c0be7095e10b27c19e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tpPL-Sg0pDWs5GZW4KLfAw.png"/></div></div></figure><p id="f072" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第10行是一个<code class="fe kn ko kp kq b">useEffect</code>钩子，它获取属于用户的所有聊天信息&amp;属于当前聊天的所有消息。仅当<code class="fe kn ko kp kq b">currentChat</code>或<code class="fe kn ko kp kq b">userId</code>改变时运行。这里使用<code class="fe kn ko kp kq b">Object.keys</code>和<code class="fe kn ko kp kq b">Object.values</code>将数据转换成它需要的格式。</p><p id="43fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第20行是<code class="fe kn ko kp kq b">sendMessage</code>函数。它接收消息体和它所属的聊天，并将两者保存到数据库中。它使用<code class="fe kn ko kp kq b">uuid</code>，一个生成唯一id的<code class="fe kn ko kp kq b">npm</code>包。</p><p id="22c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第27行是<code class="fe kn ko kp kq b">createChat</code>。它接收一个<code class="fe kn ko kp kq b">recipient</code>和一个<code class="fe kn ko kp kq b">chatName</code>，并将这些保存到三个不同的地方:接收者的个人聊天记录，这样他就可以在自己的列表中看到；用户的个人聊天，因此他们可以在他们的列表中看到它；和全球聊天，这是消息存储的地方。它使用一个空对象，因为应用程序将消息存储为由唯一id作为关键字的值。然后，它将当前聊天设置为刚刚创建的聊天，这将触发<code class="fe kn ko kp kq b">useEffect</code>挂钩并重新加载所有内容。<code class="fe kn ko kp kq b">uuid</code>用于确保聊天有唯一的名称，否则数据库中可能会有冲突。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="8bca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。确保你所有的导入都是正确的，然后加载应用程序并试一试。你需要以一个用户的身份登录，然后以另一个用户的身份登录，这样你就可以和别人聊天了。但是，如果你在两个不同的浏览器中打开应用程序并尝试聊天，你应该会看到你所有的信息都在实时更新。</p><p id="60f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你被困在某件事情上，或者有任何一般性的问题，请随时在twitter上给我发消息，我很乐意帮助你。很有可能你会发现我错过的东西，而不是你错过的东西。</p><p id="583a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">接下来的步骤</strong></p><p id="20b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些想进一步发展这个想法的人，你可以做几件事:</p><p id="c3be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">添加谷歌认证</em></p><p id="ca55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户管理非常原始。如果你读过我的另一篇文章，<a class="ae kl" href="https://medium.com/javascript-in-plain-english/deploying-and-authenticating-a-react-app-with-googles-firebase-541f7fa7be6a" rel="noopener"> <em class="km">“使用google的Firebase部署和验证React应用程序”</em> </a> <em class="km"> </em>，那么你可以继续使用Google来识别你的用户。这也将使应用程序更加安全，因为用户不能以其他人的身份登录。</p><p id="b6be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署它</p><p id="ed22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你也可以将应用程序部署到网络上，这意味着你的朋友可以来使用它。先确保他们签了一份GDPR表格😉</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="baea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读。我也写其他东西。你可以在我的媒体简介中找到所有信息，或者关注我的twitter <a class="ae kl" href="https://twitter.com/lm_writing" rel="noopener ugc nofollow" target="_blank">这里</a>。</p></div></div>    
</body>
</html>