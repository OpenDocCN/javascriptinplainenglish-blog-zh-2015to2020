<html>
<head>
<title>Building a NextJS Monorepo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建NextJS Monorepo</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-a-nextjs-monorepo-ecd21ac04928?source=collection_archive---------2-----------------------#2020-11-23">https://javascript.plainenglish.io/building-a-nextjs-monorepo-ecd21ac04928?source=collection_archive---------2-----------------------#2020-11-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b15715a6d4afd211c67e43a86fb67a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*88VCuEAjk0lp99ZMa_2tYQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://www.pexels.com/@tiger-lily?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Tiger Lily</a> from <a class="ae kc" href="https://www.pexels.com/photo/warehouse-with-concrete-floors-4483610/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><p id="5615" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你开始为你的公司创建一个前端应用程序，然后一个又一个，最终你得到了十几个前端应用程序和大量的重复代码。工具代码、林挺、测试、助手库和领域特定代码。</p><p id="6e09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可能以前见过这种情况。不是有效的并且容易出错。解决方案是将所有代码和依赖项放在一个存储库中，换句话说就是创建一个monorepo。</p><p id="3ad9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不会试图解释什么是单一回购协议，或者为什么你需要一个。像往常一样，在我所有的帖子中，我只是帮助你为你的NextJS应用程序构建一个。你可能已经决定monorepo是你的解决方案。</p><h1 id="48ec" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">我需要从单向回购中得到什么？</h1><p id="78ab" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">任何前端monorepo都应该支持某些最低要求。我最关心的是:</p><ul class=""><li id="59f1" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">包含应用程序和库:通常在monorepo中，你使用术语包来标识特定的代码单元，它可以是一个应用程序或一个共享模块。在我们的monorepo中，他们将分别生活在<code class="fe mn mo mp mq b">/packages/app/*</code>和<code class="fe mn mo mp mq b">/packages/shared/*</code>下。</li><li id="b7f2" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">使用CLI命令引导新的应用程序或共享模块。</li><li id="620c" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">用一个命令运行monorepo中的所有测试。或者，我们希望只在应用程序或共享模块上运行测试。</li><li id="ce4e" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">故事书几乎是构建前端应用程序(或类似工具)的一个需求。我们还需要打开一本故事书，里面有monorepo上的所有故事。或者，我们希望只打开来自单个应用程序或共享模块的故事。</li><li id="c0a2" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">共享工具配置。ESLint，更漂亮，打字稿，不需要在每个包装中重复我们自己。</li><li id="60e4" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">每个应用程序都应该有自己的构建脚本。以及独立运行应用程序和作为组合运行应用程序的脚本。组合意味着，我们可以在单个域中拥有针对不同路径的应用程序，并同时运行它们(例如:<code class="fe mn mo mp mq b">/customer-dashboard/...</code>代表客户仪表板应用程序，<code class="fe mn mo mp mq b">/back-office/...</code>是内部员工使用的管理应用程序)</li></ul><p id="a5b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除此之外你还可以有其他要求。在这篇文章之后，你可以花更多的时间在他们身上。</p><h1 id="7fca" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Monorepo代码组织。</h1><p id="f7e1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们将把我们的monorepo建立在Yarn work spaces(【https://classic.yarnpkg.com/en/docs/workspaces/】)上，它们足够简单，我们不需要在monorepo内部发布单独的模块(这是其他解决方案如Lerna真正擅长的)</p><p id="8449" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mw">我不会在这篇文章中添加太多的代码细节，你可以从附带的资源库中获取代码，或者将其用作你自己monorepo的模板</em></p><p id="f47b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建monorepo的第一步实际上是创建repo文件夹和<code class="fe mn mo mp mq b">package.json</code>文件。在它的内部，我们需要添加一个<code class="fe mn mo mp mq b">workspaces</code>部分。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="23a4" class="nf lc iq mq b gy ng nh l ni nj">{<br/>  <strong class="mq ir">"name": "@outsrc/monorepo",<br/>  "private": true,<br/></strong>  <strong class="mq ir">...</strong><br/>  <strong class="mq ir">"workspaces": [<br/>    "packages/app/*",<br/>    "packages/shared/*"<br/>  ]</strong><br/>  ...<br/>}</span></pre><p id="999d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以及安装所有这些开发依赖项:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="9fbc" class="nf lc iq mq b gy ng nh l ni nj">$ yarn add -W -D <a class="ae kc" href="http://twitter.com/babel/core" rel="noopener ugc nofollow" target="_blank">@babel/core</a> <a class="ae kc" href="http://twitter.com/babel/preset-env" rel="noopener ugc nofollow" target="_blank">@babel/preset-env</a> <a class="ae kc" href="http://twitter.com/babel/preset-react" rel="noopener ugc nofollow" target="_blank">@babel/preset-react</a> <a class="ae kc" href="http://twitter.com/babel/preset-typescript" rel="noopener ugc nofollow" target="_blank">@babel/preset-typescript</a> <a class="ae kc" href="http://twitter.com/next/bundle-analyzer" rel="noopener ugc nofollow" target="_blank">@next/bundle-analyzer</a> <a class="ae kc" href="http://twitter.com/storybook/addon-actions" rel="noopener ugc nofollow" target="_blank">@storybook/addon-actions</a> <a class="ae kc" href="http://twitter.com/storybook/addon-docs" rel="noopener ugc nofollow" target="_blank">@storybook/addon-docs</a> <a class="ae kc" href="http://twitter.com/storybook/addon-essentials" rel="noopener ugc nofollow" target="_blank">@storybook/addon-essentials</a> <a class="ae kc" href="http://twitter.com/storybook/addon-links" rel="noopener ugc nofollow" target="_blank">@storybook/addon-links</a> <a class="ae kc" href="http://twitter.com/storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">@storybook/addon-storyshots</a> <a class="ae kc" href="http://twitter.com/storybook/react" rel="noopener ugc nofollow" target="_blank">@storybook/react</a> <a class="ae kc" href="http://twitter.com/testing" rel="noopener ugc nofollow" target="_blank">@testing</a>-library/jest-dom @testing-library/react <a class="ae kc" href="http://twitter.com/types/jest" rel="noopener ugc nofollow" target="_blank">@types/jest</a> <a class="ae kc" href="http://twitter.com/types/node" rel="noopener ugc nofollow" target="_blank">@types/node</a> <a class="ae kc" href="http://twitter.com/types/react" rel="noopener ugc nofollow" target="_blank">@types/react</a> <a class="ae kc" href="http://twitter.com/typescript" rel="noopener ugc nofollow" target="_blank">@typescript</a>-eslint/eslint-plugin <a class="ae kc" href="http://twitter.com/typescript" rel="noopener ugc nofollow" target="_blank">@typescript</a>-eslint/parser arg babel-jest babel-loader babel-plugin-module-resolver dev-kong eslint eslint-config-standard-with-typescript eslint-plugin-import eslint-plugin-jest eslint-plugin-jest-dom eslint-plugin-node eslint-plugin-prettier eslint-plugin-promise eslint-plugin-react eslint-plugin-react-hooks eslint-plugin-standard fs-extra globby identity-obj-proxy internal-ip jest jest-runtime next-transpile-modules plop pm2 prettier react-is react-test-renderer replace-in-files rimraf sass sass-loader ts-jest ts-node typescript</span></pre><p id="4e07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而这种常规的依赖关系:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="b57d" class="nf lc iq mq b gy ng nh l ni nj">$ yarn add -W next react react-dom</span></pre><p id="ff3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">工具代码…</p><p id="aba6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个<code class="fe mn mo mp mq b">.gitignore</code></p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="75a4" class="nf lc iq mq b gy ng nh l ni nj">node_modules<br/>.next<br/>out<br/>*.log<br/>coverage</span></pre><p id="8991" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ESLint帮助我们的代码看起来更好，还有其他原因。对于ESlint配置，我们需要两个文件:<code class="fe mn mo mp mq b">.eslintrc.yml</code>和<code class="fe mn mo mp mq b">.eslintignore</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="0d0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">漂亮是一个代码格式化工具。有助于避免围绕如何格式化代码进行讨论。还需要根目录上的几个配置文件:<code class="fe mn mo mp mq b">.prettierrc</code>和<code class="fe mn mo mp mq b">.prettierignore</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="56b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于Yarn工作空间(【https://github.com/yarnpkg/yarn/issues/7807】T21)上的一个突出问题，我们需要在我们的存储库上使用Yarn v1.18版。我们可以通过制定纱线政策来实现这一点。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="ae1d" class="nf lc iq mq b gy ng nh l ni nj">$ yarn policies set-version 1.18.0</span></pre><p id="d3ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还需要一个<code class="fe mn mo mp mq b">babel.config.js</code>文件。这只是包含了默认的NextJS babel设置。</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="6f49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mn mo mp mq b">jest.config.js</code>文件将包含我们的Jest测试配置。</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="d78c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后是我们的类型脚本配置文件。一个在根文件夹<code class="fe mn mo mp mq b">tsconfig.json</code>中，一个主文件用作分散在repo: <code class="fe mn mo mp mq b">config/next.tsconfig.json</code>中的所有其他<code class="fe mn mo mp mq b">tsconfig.json</code>文件的基础</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">root tsconfig.json</figcaption></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="a784" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意这里我们使用了一个<code class="fe mn mo mp mq b">paths</code>属性来表示所有的<code class="fe mn mo mp mq b">@outsrc/...</code>依赖项都来自于<code class="fe mn mo mp mq b">packages/shared/*</code>文件夹。这意味着应用程序不会共享内部代码。如果你需要共享代码，你需要把它放在一个共享模块上。</p><h2 id="fbf1" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">创建一个NextJS模板应用程序</h2><p id="789d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">一个NextJS模板应用程序将帮助我们以后引导新的应用程序。我们将在<code class="fe mn mo mp mq b">packages/app/template</code>创建它</p><p id="1857" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要这个应用程序的几个文件。我们将有一些简单的东西，尽管您可以稍后增加这个应用程序模板的复杂性，以包含您的应用程序所需的所有需求。</p><p id="3a7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个<code class="fe mn mo mp mq b">package.json</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="1159" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如你所看到的，这个<code class="fe mn mo mp mq b">package.json</code>已经包含了以下脚本:<strong class="kf ir">开发</strong>、<strong class="kf ir">构建</strong>、<strong class="kf ir">故事书</strong>、<strong class="kf ir">测试</strong>和<strong class="kf ir">启动。</strong></p><p id="21c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二个<code class="fe mn mo mp mq b">tsconfig.json</code>用于类型脚本配置:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="3052" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有几个NextJS文件:<code class="fe mn mo mp mq b">next.config.js</code>和<code class="fe mn mo mp mq b">next-end.d.ts</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2190" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，我们使用了<strong class="kf ir">端口</strong> <code class="fe mn mo mp mq b">3010</code>和<strong class="kf ir">基本路径</strong> <code class="fe mn mo mp mq b">/template</code>在这里，让我们在文件<code class="fe mn mo mp mq b">src/pages/index.tsx</code>上创建第一个NextJS页面</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="097e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试我们的第一个应用</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="111c" class="nf lc iq mq b gy ng nh l ni nj">$ yarn workspace @outsrc/template dev</span></pre><p id="8d2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在浏览器上我们可以查看<a class="ae kc" href="http://localhost:3010/template" rel="noopener ugc nofollow" target="_blank">http://localhost:3010/template</a></p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/db210532d311fa8351e78dc100e0967d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Im55tSUA8Gf2Cs5BeJpjVA.png"/></div></div></figure><p id="53bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们在模板应用程序上创建一个按钮组件:5个文件，<code class="fe mn mo mp mq b">index.ts</code> <code class="fe mn mo mp mq b">Button.tsx</code> <code class="fe mn mo mp mq b">Button.module.scss</code> <code class="fe mn mo mp mq b">Button.spec.tsx</code> <code class="fe mn mo mp mq b">Button.stories.mdx</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">(Check the source code of this file)</figcaption></figure><p id="ead7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更改<code class="fe mn mo mp mq b">src/page/index.tsx</code>文件以使用它:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="17e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将显示:</p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/f570926534803fa968b71a7f2b0358a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LLszBr_7GJfpfj696p9cvw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">With Button component</figcaption></figure><p id="405b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">故事书呢？要启用它，我们需要模板应用程序上的两个文件:<code class="fe mn mo mp mq b">.storybook/main.js</code>和<code class="fe mn mo mp mq b">.storybook/preview.js</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5e22" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这两个文件，从<code class="fe mn mo mp mq b">template</code>文件夹运行:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="aaeb" class="nf lc iq mq b gy ng nh l ni nj">$ yarn storybook</span></pre><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/f1670fc30bbef12e1390caf93e9505d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1KdijtYgiq6_pNJ2b221Og.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Template App Storybook</figcaption></figure><p id="2056" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于测试，我们可以运行<code class="fe mn mo mp mq b">yarn test</code>,但是在此之前，因为我们已经有了一本故事书，我们可以对所有故事进行快照测试。创建一个<code class="fe mn mo mp mq b">__tests__/storyshots</code>文件夹，并在其中创建一个<code class="fe mn mo mp mq b">__tests__/storyshots/storyshots.spec.ts</code>文件。</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="76fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以运行故事书和测试，包括来自模板应用程序文件夹的快照测试。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="5bac" class="nf lc iq mq b gy ng nh l ni nj">$ cd packages/app/template &amp;&amp; yarn test<br/>$ cd packages/app/template &amp;&amp; yarn storybook</span></pre><p id="3a36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这两个命令也可以从根文件夹中执行</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="fa12" class="nf lc iq mq b gy ng nh l ni nj">$ yarn workspace @outsrc/template test<br/>$ yarn workspace @outsrc/template storybook</span></pre><p id="9444" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">已经在<code class="fe mn mo mp mq b">package.json</code>脚本部分的其他命令包括:</p><ul class=""><li id="4995" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated"><strong class="kf ir">构建</strong>:为生产部署构建应用程序</li><li id="1e16" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated"><strong class="kf ir"> dev </strong>:在开发模式下运行应用。</li><li id="64d7" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated"><strong class="kf ir">开始</strong>:构建并运行应用程序，无需开发</li></ul><p id="2a33" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，为了支持打开全球故事书，我们需要在monorepo的根文件夹中创建两个文件:<code class="fe mn mo mp mq b">.storybook/main.js</code>和<code class="fe mn mo mp mq b">.storybook/preview.js</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5c0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mw">(这两个文件与模板应用程序文件夹中的文件几乎相同，但它们在故事路径上有微小的变化)</em></p><p id="acb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，修改根文件夹<code class="fe mn mo mp mq b">package.json</code>文件以包含几个脚本。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="4e1b" class="nf lc iq mq b gy ng nh l ni nj">{<br/> ...<br/> "scripts": {<br/>  ...<br/>    <strong class="mq ir">"storybook": "start-storybook -p 6006",<br/>    "test": "jest --coverage",</strong><br/>    ...<br/> },<br/> ...<br/>}</span></pre><p id="c3ef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以运行一个全局故事书或者在monorepo上运行所有测试。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="2e22" class="nf lc iq mq b gy ng nh l ni nj">$ yarn test<br/>$ yarn storybook</span></pre><h2 id="a79a" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">创建共享模块</h2><p id="0f2a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">共享模块要简单得多，它们包含将在monorepo中重用的代码，特别是在应用程序和其他共享模块上。</p><p id="b0e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们创建一个<code class="fe mn mo mp mq b">packages/shared/functions</code>文件夹和一个<code class="fe mn mo mp mq b">package.json</code>文件，如下所示:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="1eb6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有一个<code class="fe mn mo mp mq b">tsconfig.json</code>,因为我们也在共享模块上写类型脚本。</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="b145" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在monorepo上共享模块的一个好处是我们不需要先编译它们。所以这个共享模块只是纯TypeScript。让我们创建一个简单的函数，并进行测试。<code class="fe mn mo mp mq b">src/index.ts</code>和<code class="fe mn mo mp mq b">src/index.spec.ts</code>:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="912f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用一个命令运行测试:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="4c67" class="nf lc iq mq b gy ng nh l ni nj">$ yarn workspace @outsrc/functions test</span><span id="cdea" class="nf lc iq mq b gy nz nh l ni nj"># all Tests on the monorepo<br/>$ yarn test</span></pre><p id="d106" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是我们共享模块所需要的。</p><h2 id="7120" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">使用共享模块</h2><p id="7e79" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">一旦我们有了共享模块，从其他共享模块或应用程序中使用它们实际上是非常简单的。您可以通过以下方式导入它们:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="58b5" class="nf lc iq mq b gy ng nh l ni nj">import { capitalize } from '@outsrc/functions'</span></pre><p id="3bee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">NextJS应用程序不会自动从<code class="fe mn mo mp mq b">node_modules</code>依赖项中传输代码。这就是为什么我们添加了一个NextJS插件next-trans file-modules(<a class="ae kc" href="https://www.npmjs.com/package/next-transpile-modules" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/next-transpile-modules</a>)为了工作，我们需要手动指定我们想要传输的模块，这就是为什么我们在<code class="fe mn mo mp mq b">next.config.js</code>文件上添加了一小段代码，只要依赖关系列在<code class="fe mn mo mp mq b">package.json</code>文件的<strong class="kf ir">依赖关系</strong>部分，它就会自动为我们完成这项工作。</p><p id="91ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，如果我们想在模板应用程序上使用新的<code class="fe mn mo mp mq b">capitalize</code>函数，我们需要首先将<code class="fe mn mo mp mq b">@outsrc/functions</code>添加到模板应用程序的依赖列表中。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="c07e" class="nf lc iq mq b gy ng nh l ni nj">{<br/> ...<br/> "dependencies": {<br/>  ...<br/>    <strong class="mq ir">"@outsrc/functions": "0.0.0"</strong><br/>    ...<br/> },<br/> ...<br/>}</span></pre><p id="55de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并更改代码以使用它，例如:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="4ec5" class="nf lc iq mq b gy ng nh l ni nj">$ yarn workspace @outsr/template dev</span></pre><figure class="mx my mz na gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/6cf77a677714b4f9ceafabb7dc8a9728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*_sxvIpx9YwXOjBLmaTJKJQ.png"/></div></figure><p id="53e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，我们已经涵盖了前端monorepo的大部分需求。少了什么？</p><ul class=""><li id="01a4" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">从模板生成模块或应用程序(我们已经有几个模板)</li><li id="a28d" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">启动所有合成应用程序。</li></ul><h2 id="583a" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">从模板生成应用程序或模块</h2><p id="8c72" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们已经有几个模板。以运行应用和共享模块的形式分别:<code class="fe mn mo mp mq b"><strong class="kf ir">@outsrc/template</strong></code>和<code class="fe mn mo mp mq b"><strong class="kf ir">@outsrc/functions</strong></code>。我们可以用它们来引导新的应用程序或共享模块。</p><p id="ff40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个任务，我们将使用扑通(<a class="ae kc" href="https://plopjs.com/" rel="noopener ugc nofollow" target="_blank">https://plopjs.com/</a>)，因为我们将创建一些自定义的动作和助手文件，我们将把所有东西放在一个<code class="fe mn mo mp mq b">.plop</code>文件夹中。文件将:<code class="fe mn mo mp mq b">.plop/plopfile.ts</code>、<code class="fe mn mo mp mq b">.plop/actions.ts</code>、<code class="fe mn mo mp mq b">.plop/app-generator.ts</code>和<code class="fe mn mo mp mq b">.plop/lib-generator.ts</code>(哦对了，扑通支持打字稿)</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="c4f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们在<code class="fe mn mo mp mq b">.plop</code>文件夹中有了所有这些文件，我们就可以添加运行plopfile的生成脚本。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="34ab" class="nf lc iq mq b gy ng nh l ni nj">{<br/> ...<br/> "scripts": {<br/>  ...<br/>    <strong class="mq ir">"generate": "plop --plopfile .plop/plopfile.ts"</strong><br/>    ...<br/> },<br/> ...<br/>}</span></pre><p id="0327" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行它:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="2baa" class="nf lc iq mq b gy ng nh l ni nj">$ yarn generate<br/>yarn run v1.18.0<br/>$ plop --plopfile .plop/plopfile.ts<br/>? [PLOP] Please choose a generator. (Use arrow keys)<br/>❯ app - App Generator <br/>  lib - Shared Module Generator</span></pre><p id="85e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们避免在plopfile动作中使用handlebars模板。我们只是复制一个完整的模板文件夹，然后替换所有我们需要的属性，使它成为一个不同的应用程序，这包括:名称，路径，端口等。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="66b8" class="nf lc iq mq b gy ng nh l ni nj">$ yarn generate app new-app "New App" 3045 "/new-app"          <br/>yarn run v1.18.0<br/>$ plop --plopfile .plop/plopfile.ts app new-app 'New App' 3045 /new-app<br/>⠋ - packages/app/new-app/next-env.d.ts<br/>- packages/app/new-app/next.config.js<br/>- packages/app/new-app/package.json<br/>- packages/app/new-app/tsconfig.json<br/>- packages/app/new-app/.storybook/main.js<br/>- packages/app/new-app/.storybook/preview.js<br/>- packages/app/new-app/__tests__/storyshoots/storyshots.spec.ts<br/>- packages/app/new-app/src/pages/index.tsx<br/>- packages/app/new-app/__tests__/storyshoots/__snapshots__/storyshots.spec.ts.snap<br/>- packages/app/new-app/src/components/Button/Button.module.scss<br/>- packages/app/new-app/src/components/Button/Button.spec.tsx<br/>- packages/app/new-app/src/components/Button/Button.stories.mdx<br/>- packages/app/new-app/src/components/Button/Button.tsx<br/>- packages/app/new-app/src/components/Button/index.ts<br/>✔  copy-files success<br/>✨  Done in 2.42s.</span></pre><p id="f407" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行您的新应用程序:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="1204" class="nf lc iq mq b gy ng nh l ni nj">$ yarn workspace @outsrc/new-app dev</span></pre><figure class="mx my mz na gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/a65193f27bd1b770a099b23e5532acd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*LRZYqmemrWXRpAQWRPIfkQ.png"/></div></figure><p id="6215" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">瞧啊。新应用程序在几秒钟内启动。这种方法的一个简单的好处是，我们可以为应用程序维护一个或多个完整的模板，并在其中包含所有必要的代码，如UI工具包、安全性等。</p><p id="7fbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您现在从根文件夹运行故事书，您将会看到:</p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/ff77da78b456b5a2af72916b96f41692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FAuepJfXiN1hv6lLC8URNQ.png"/></div></div></figure><p id="34cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，请注意我们的新应用程序，即使使用不同的基路径(/new-app)托管在不同的端口上。这意味着我们不能在同一个端口上运行所有的应用程序。这对于微前端应用程序非常重要，在这些应用程序中，身份验证是在域级别处理的。为了完成这个任务，我们需要一个反向代理，将所有请求路由到运行我们的应用程序的不同端口。</p><p id="79df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用了另外两个依赖项。(<a class="ae kc" href="https://pm2.keymetrics.io/" rel="noopener ugc nofollow" target="_blank">https://PM2 . key metrics . io</a>)和Kong(<a class="ae kc" href="https://konghq.com/" rel="noopener ugc nofollow" target="_blank">https://konghq.com/</a>)但是由于我们不想通过PM2手动运行应用程序，然后使用Kong REST API将它们连接到localhost端口3000，所以我们设计了几个自动化脚本来启动和停止monorepo上的所有应用程序。剧本是:<code class="fe mn mo mp mq b">.scripts/start.ts</code>和<code class="fe mn mo mp mq b">.scripts/stop.ts</code></p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="c68c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根文件<code class="fe mn mo mp mq b">package.json</code>上也有一些新的脚本:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="a466" class="nf lc iq mq b gy ng nh l ni nj">{<br/> ...<br/> "scripts": {<br/>  ...<br/>    <strong class="mq ir">"start": "ts-node -P tsconfig.json .scripts/start.ts",<br/>    "stop": "ts-node -P tsconfig.json .scripts/stop.ts"</strong><br/>    ...<br/> },<br/> ...<br/>}</span></pre><p id="8266" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启动所有应用程序:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="d022" class="nf lc iq mq b gy ng nh l ni nj">$ yarn start<br/>yarn run v1.18.0<br/>$ ts-node -P tsconfig.json .scripts/start.ts<br/>[ssg] - <a class="ae kc" href="http://twitter.com/outsrc/new-app" rel="noopener ugc nofollow" target="_blank">@outsrc/new-app</a><br/>[ssg] - <a class="ae kc" href="http://twitter.com/outsrc/template" rel="noopener ugc nofollow" target="_blank">@outsrc/template</a><br/>[kon] - /template                 - template<br/>[kon] - /new-app                  - new-app<br/>✨  Done in 11.27s.</span></pre><div class="mx my mz na gt ab cb"><figure class="oc jr od oe of og oh paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/ea66bedf17287bf13482dc0550545a71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*S2FfTEuHVxNJyX6uWHonpA.png"/></div></figure><figure class="oc jr od oe of og oh paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/991614e70584b7d11afb0f3844616226.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*EQHTu0JdapliJ8LUKj8ZMg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk oi di oj ok">All applications running under the same port 3000 different paths</figcaption></figure></div><p id="36f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要停止所有操作:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="653a" class="nf lc iq mq b gy ng nh l ni nj">$ yarn stop<br/>yarn run v1.18.0<br/>$ ts-node -P tsconfig.json .scripts/stop.ts<br/>- new-app<br/>- template<br/>All stopped<br/>✨  Done in 3.30s.</span></pre><p id="28e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，<code class="fe mn mo mp mq b">yarn start</code>脚本将运行所有的应用程序，但他们不会热重装。通常不会同时在monorepo上运行所有应用程序。因此，要在单个(或多个)应用程序上启用热重装，我们需要使用dev参数(用逗号分隔)指定我们想要开发的应用程序。</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="b6cf" class="nf lc iq mq b gy ng nh l ni nj">yarn start --dev new-app<br/>yarn run v1.18.0<br/>$ ts-node -P tsconfig.json .scripts/start.ts --dev new-app<br/><strong class="mq ir">[dev]</strong> - <a class="ae kc" href="http://twitter.com/outsrc/new-app" rel="noopener ugc nofollow" target="_blank">@outsrc/new-app</a><br/>[ssg] - <a class="ae kc" href="http://twitter.com/outsrc/template" rel="noopener ugc nofollow" target="_blank">@outsrc/template</a><br/>[kon] - /template                 - template<br/>[kon] - /new-app                  - new-app<br/>✨  Done in 9.53s.</span></pre><p id="485c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意我们指定为开发模式的应用程序上的<code class="fe mn mo mp mq b"><strong class="kf ir">[dev]</strong></code>标记。</p><p id="990b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是原木呢？因为我们使用了PM2:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="a328" class="nf lc iq mq b gy ng nh l ni nj">$ pm2 list<br/>┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐<br/>│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │<br/>├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤<br/>│ 0  │ new-app            │ fork     │ 0    │ online    │ 0%       │ 69.2mb   │<br/>│ 1  │ template           │ fork     │ 0    │ online    │ 0%       │ 70.0mb   │<br/>└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘</span></pre><p id="814e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于日志，我们可以:</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="a231" class="nf lc iq mq b gy ng nh l ni nj">$ pm2 logs new-app<br/>[TAILING] Tailing last 15 lines for [new-app] process (change the value with --lines option)<br/>/Users/ernestofreyre/.pm2/logs/new-app-error.log last 15 lines:<br/>/Users/ernestofreyre/.pm2/logs/new-app-out.log last 15 lines:<br/>0|new-app  | λ  (Server)  server-side renders at runtime (uses getInitialProps or getServerSideProps)<br/>0|new-app  | ○  (Static)  automatically rendered as static HTML (uses no initial props)<br/>0|new-app  | ●  (SSG)     automatically generated as static HTML + JSON (uses getStaticProps)<br/>0|new-app  |    (ISR)     incremental static regeneration (uses revalidate in getStaticProps)<br/>0|new-app  | <br/>0|new-app  | info  - using build directory: /Users/ernestofreyre/Documents/nodeprojects/monorepo/packages/app/new-app/.next<br/>0|new-app  | info  - Copying "static build" directory<br/>0|new-app  | info  - No "exportPathMap" found in "next.config.js". Generating map from "./pages"<br/>0|new-app  | info  - Launching 15 workers<br/>0|new-app  | info  - Exporting (0/2)<br/>0|new-app  | Export successful<br/>0|new-app  | Listening on <a class="ae kc" href="http://codechap0.attlocal.net:3045" rel="noopener ugc nofollow" target="_blank">http://codechap0.attlocal.net:3045</a>, <a class="ae kc" href="http://127.0.0.1:3045" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:3045</a>, <a class="ae kc" href="http://192.168.1.94:3045" rel="noopener ugc nofollow" target="_blank">http://192.168.1.94:3045</a><br/>0|new-app  | $ next -p 3045<br/>0|new-app  | ready - started server on <a class="ae kc" href="http://localhost:3045" rel="noopener ugc nofollow" target="_blank">http://localhost:3045</a><br/>0|new-app  | event - compiled successfully</span></pre><h2 id="7bf8" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">结论</h2><p id="03a4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这几乎涵盖了我们在本文开始时设定的所有要求。</p><p id="6f52" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以，创建新的应用程序，在它们之间共享代码，独立运行它们或者作为一个组合(微前端？)，运行应用程序或共享模块中的所有测试或测试子集。打开全局故事书或仅打开应用程序或共享模块上的故事书。而且都有共享的TypeScript、ESLint和更漂亮的配置。</p><p id="20f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文未涉及的其他功能:</p><ul class=""><li id="f9b0" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">测试差异:仅对修改后的模块或其依赖项运行测试。这很重要，因为即使你想运行所有的测试，有时你只需要运行某些测试，因为保证其余的不会受到代码变化的影响。提高速度，特别是在CI/CD环境中。</li><li id="607c" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">构建在monorepo之外使用的共享模块:到目前为止，唯一正在构建的构件是NextJS应用程序。但是，如果我们还需要导出共享模块，您将需要在每个需要它的模块上构建一个步骤。</li><li id="8003" class="me mf iq kf b kg mr kk ms ko mt ks mu kw mv la mj mk ml mm bi translated">对模块和导入实施依赖图限制:如果您希望实施应用程序之间没有依赖关系，并且所有共享的代码都应该在一个共享的模块上，或者围绕依赖关系实施更复杂的规则。(我用dependency-cruiser(<a class="ae kc" href="https://github.com/sverweij/dependency-cruiser" rel="noopener ugc nofollow" target="_blank">https://github.com/sverweij/dependency-cruiser</a>)做了一些实验，但仍然试图解决monorepo上的打字稿路径解析的一些问题)</li></ul><p id="c8f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在邮报上走这么远的代价是…</p><p id="b453" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Monorepo模板。</p><div class="ol om gp gr on oo"><a href="https://github.com/outsrc/monorepo" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">外包/单一报告</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">这是NextJS应用程序的前端monorepo模板。</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">github.com</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc jw oo"/></div></div></a></div><p id="db6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文中显示的所有代码都在monorepo模板库中共享。</p><p id="e183" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，您可以使用额外的<code class="fe mn mo mp mq b">change-org</code>脚本获得这个monorepo的所有权</p><pre class="mx my mz na gt nb mq nc nd aw ne bi"><span id="4607" class="nf lc iq mq b gy ng nh l ni nj">$ yarn change-org --from @outsrc --to @yourcompany</span></pre><p id="bcc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">黑客快乐…</p><h2 id="9eb4" class="nf lc iq bd ld nm nn dn lh no np dp ll ko nq nr lp ks ns nt lt kw nu nv lx nw bi translated">进一步阅读</h2><div class="ol om gp gr on oo"><a href="https://bit.cloud/blog/painless-monorepo-dependency-management-with-bit-l4f9fzyw" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">使用Bit进行无痛monorepo依赖管理</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">简化monorepo中的依赖关系管理，以避免虚拟依赖关系和版本问题。了解…</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">比特云</p></div></div><div class="ox l"><div class="pd l oz pa pb ox pc jw oo"/></div></div></a></div><p id="262b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mw">更多内容请看</em><a class="ae kc" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="mw">plain English . io</em></strong></a><em class="mw">。报名参加我们的</em> <a class="ae kc" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="mw">免费周报</em> </strong> </a> <em class="mw">。关注我们关于</em><a class="ae kc" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="mw">Twitter</em></strong></a><a class="ae kc" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="mw">LinkedIn</em></strong></a><strong class="kf ir"><em class="mw"/></strong><a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="mw">YouTube</em></strong></a><strong class="kf ir"><em class="mw">，以及</em></strong><em class="mw"/><a class="ae kc" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="mw">不和</em> </strong> </a>  <em class="mw">对成长黑客感兴趣？检查</em> <a class="ae kc" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="mw">电路</em> </strong> </a> <strong class="kf ir"> <em class="mw">。</em> </strong></p></div></div>    
</body>
</html>